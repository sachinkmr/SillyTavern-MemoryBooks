{
  "version": 3,
  "sources": ["constants.js", "sceneManager.js", "summaryPromptManager.js", "utils.js", "chatcompile.js", "node_modules\\lex\\lexer.js", "node_modules\\string.fromcodepoint\\fromcodepoint.js", "node_modules\\unescape-js\\dist\\index.js", "node_modules\\utf8\\utf8.js", "node_modules\\dirty-json\\lexer.js", "node_modules\\dirty-json\\parser.js", "node_modules\\dirty-json\\dirty-json.js", "sidePromptsManager.js", "index.js", "stmemory.js", "addlore.js", "autocreate.js", "autosummary.js", "profileManager.js", "templates.js", "confirmationPopup.js", "sidePrompts.js", "sidePromptsPopup.js", "templatesSidePrompts.js", "arcanalysis.js", "templatesArcPrompts.js", "arcAnalysisPromptManager.js", "templatesSummaryPrompts.js", "locales.js"],
  "sourcesContent": [
    "/**\n * Constants for STMemoryBooks extension\n */\n\n// Memory generation settings\nexport const MEMORY_GENERATION = {\n    MAX_RETRIES: 2,\n    RETRY_DELAY_MS: 2000,\n    TOKEN_WARNING_THRESHOLD_DEFAULT: 50000,\n    DEFAULT_MEMORY_COUNT: 0,\n};\n\n// Scene management settings\nexport const SCENE_MANAGEMENT = {\n    MAX_SCAN_RANGE: 100,\n    MAX_AFFECTED_MESSAGES: 200,\n    BUTTON_UPDATE_DEBOUNCE_MS: 50,\n    VALIDATION_DELAY_MS: 500,\n};\n\n// Auto-summary settings\nexport const AUTO_SUMMARY = {\n    MIN_INTERVAL: 10,\n    DEFAULT_INTERVAL: 50,\n    MAX_INTERVAL: 250,\n};\n\n// Settings debounce\nexport const UI_SETTINGS = {\n    INPUT_DEBOUNCE_MS: 1000,\n    CHAT_OBSERVER_DEBOUNCE_MS: 50,\n};\n\n// File names\nexport const FILE_NAMES = {\n    PROMPTS_FILE: 'stmb-summary-prompts.json',\n    SIDE_PROMPTS_FILE: 'stmb-side-prompts.json',\n    ARC_PROMPTS_FILE: 'stmb-arc-prompts.json',\n};\n\n// Schema version\nexport const SCHEMA = {\n    CURRENT_VERSION: 1,\n};\n\n// Display name localization defaults and i18n keys for built-in presets\nexport const DISPLAY_NAME_DEFAULTS = {\n    summary: 'Summary - Detailed beat-by-beat summaries in narrative prose',\n    summarize: 'Summarize - Bullet-point format',\n    synopsis: 'Synopsis - Long and comprehensive (beats, interactions, details) with headings',\n    sumup: 'Sum Up - Concise story beats in narrative prose',\n    minimal: 'Minimal - Brief 1-2 sentence summary',\n    northgate: 'Northgate - Intended for creative writing. By Northgate on ST Discord',\n    aelemar: 'Aelemar - Focuses on plot points and character memories. By Aelemar on ST Discord',\n    comprehensive: 'Comprehensive - Synopsis plus improved keywords extraction',\n};\n\nexport const DISPLAY_NAME_I18N_KEYS = {\n    summary: 'STMemoryBooks_DisplayName_summary',\n    summarize: 'STMemoryBooks_DisplayName_summarize',\n    synopsis: 'STMemoryBooks_DisplayName_synopsis',\n    sumup: 'STMemoryBooks_DisplayName_sumup',\n    minimal: 'STMemoryBooks_DisplayName_minimal',\n    northgate: 'STMemoryBooks_DisplayName_northgate',\n    aelemar: 'STMemoryBooks_DisplayName_aelemar',\n    comprehensive: 'STMemoryBooks_DisplayName_comprehensive',\n};\n\n// First-pass additional constants for common defaults and thresholds\nexport const CHARS_PER_TOKEN = 4;\nexport const MAX_PREVIEW_CHARS = 100000;\nexport const MAX_SCAN_RANGE = SCENE_MANAGEMENT.MAX_SCAN_RANGE;\nexport const MAX_AFFECTED_MESSAGES = SCENE_MANAGEMENT.MAX_AFFECTED_MESSAGES;\n\n// First-pass boolean and string defaults to be targeted for consolidation\nexport const BOOLEAN_DEFAULTS = {\n    DEFAULT_USE_PROBABILITY: true,\n};\n\nexport const STRING_DEFAULTS = {\n    DEFAULT_OUTLET_NAME: '',\n};\n",
    "import { chat, chat_metadata } from '../../../../script.js';\nimport { saveMetadataDebounced, getContext } from '../../../extensions.js';\nimport { createSceneRequest, estimateTokenCount, compileScene } from './chatcompile.js';\nimport { SCENE_MANAGEMENT } from './constants.js';\nimport { t as __st_t_tag, translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-SceneManager';\n\n// Cache for current scene state\nlet currentSceneState = {\n    start: null,\n    end: null\n};\n\n/**\n * GROUP CHAT SUPPORT: Get current scene markers from appropriate metadata location\n * Handles both group chats (group.chat_metadata) and single character chats (chat_metadata)\n */\nexport function getSceneMarkers() {\n    // Use SillyTavern's proper context API for both group chats and single chats\n    const context = getContext();\n    const chatMetadata = context.chatMetadata;\n\n    if (!chatMetadata) {\n        return { sceneStart: null, sceneEnd: null };\n    }\n    if (!chatMetadata.STMemoryBooks) {\n        chatMetadata.STMemoryBooks = {};\n    }\n\n    // Always sync from currentSceneState to ensure immediate consistency\n    // This handles the case where metadata hasn't been persisted yet due to debouncing\n    chatMetadata.STMemoryBooks.sceneStart = currentSceneState.start ?? chatMetadata.STMemoryBooks.sceneStart ?? null;\n    chatMetadata.STMemoryBooks.sceneEnd = currentSceneState.end ?? chatMetadata.STMemoryBooks.sceneEnd ?? null;\n\n    return chatMetadata.STMemoryBooks;\n}\n\n/**\n * GROUP CHAT SUPPORT: Save metadata for current context (group or single character)\n * Handles both group metadata saving and regular chat metadata saving\n */\nexport function saveMetadataForCurrentContext() {\n    // Both group chats and single chats use chat_metadata as the authoritative source\n    // SillyTavern's group system automatically persists chat_metadata to group.past_metadata\n    saveMetadataDebounced();\n}\n\n// Helper to get highest memory processed\nexport function getHighestMemoryProcessed() {\n  const markers = getSceneMarkers();\n  const v = markers?.highestMemoryProcessed;\n  return Number.isFinite(v) ? v : null;\n}\n\n/**\n * Update button states only for affected messages (instead of all messages)\n * @param {number|null} oldStart - Previous start marker\n * @param {number|null} oldEnd - Previous end marker  \n * @param {number|null} newStart - New start marker\n * @param {number|null} newEnd - New end marker\n */\nfunction updateAffectedButtonStates(oldStart, oldEnd, newStart, newEnd) {\n    // Calculate the range of messages that could be affected\n    const affectedRange = calculateAffectedRange(oldStart, oldEnd, newStart, newEnd);\n\n    if (affectedRange.needsFullUpdate) {\n        // Fall back to full update for complex changes\n        updateAllButtonStates();\n        return;\n    }\n\n    if (affectedRange.min === null || affectedRange.max === null) {\n        // No messages affected\n        return;\n    }\n\n    // Only query and update the affected message range\n    const selector = `#chat .mes[mesid]`;\n    const allMessages = document.querySelectorAll(selector);\n\n    const affectedMessages = Array.from(allMessages).filter(messageElement => {\n        const messageId = parseInt(messageElement.getAttribute('mesid'));\n        const minCheck = affectedRange.min !== null ? messageId >= affectedRange.min : true;\n        const maxCheck = affectedRange.max !== null && affectedRange.max !== undefined ? messageId <= affectedRange.max : true;\n        return minCheck && maxCheck;\n    });\n\n    if (affectedMessages.length > 0) {\n        const markers = getSceneMarkers();\n        updateButtonStatesForElements(affectedMessages, markers);\n    }\n}\n\n/**\n * Calculate which message range is affected by scene marker changes\n * @param {number|null} oldStart - Previous start marker\n * @param {number|null} oldEnd - Previous end marker\n * @param {number|null} newStart - New start marker  \n * @param {number|null} newEnd - New end marker\n * @returns {Object} Range info with min, max, and needsFullUpdate flag\n */\nfunction calculateAffectedRange(oldStart, oldEnd, newStart, newEnd) {\n    const affectedIds = new Set();\n    \n    // Add old scene range\n    if (oldStart !== null && oldEnd !== null) {\n        for (let i = oldStart; i <= oldEnd; i++) {\n            affectedIds.add(i);\n        }\n    }\n    \n    // Add old markers\n    if (oldStart !== null) affectedIds.add(oldStart);\n    if (oldEnd !== null) affectedIds.add(oldEnd);\n    \n    // Add new scene range\n    if (newStart !== null && newEnd !== null) {\n        for (let i = newStart; i <= newEnd; i++) {\n            affectedIds.add(i);\n        }\n    }\n    \n    // Add new markers\n    if (newStart !== null) affectedIds.add(newStart);\n    if (newEnd !== null) affectedIds.add(newEnd);\n    \n    // Add messages that might need \"valid-start-point\" or \"valid-end-point\" classes\n    if (newStart !== null && newEnd === null) {\n        // Start set, no end - all messages after start could be valid end points\n        // Limit the range to avoid scanning thousands of messages\n        const maxScan = Math.min(newStart + SCENE_MANAGEMENT.MAX_SCAN_RANGE, chat.length - 1);\n        for (let i = newStart + 1; i <= maxScan; i++) {\n            affectedIds.add(i);\n        }\n    }\n    \n    if (newEnd !== null && newStart === null) {\n        // End set, no start - all messages before end could be valid start points\n        // Limit the range to avoid scanning thousands of messages  \n        const minScan = Math.max(newEnd - SCENE_MANAGEMENT.MAX_SCAN_RANGE, 0);\n        for (let i = minScan; i < newEnd; i++) {\n            affectedIds.add(i);\n        }\n    }\n    \n    // Add messages that had valid-point classes in the old state but won't in the new state\n    if (oldStart !== null && oldEnd === null && newStart !== null && newEnd !== null) {\n        // Transitioning from \"start only\" to \"complete scene\" - need to clear valid-end-point from messages after newEnd\n        const maxScan = Math.min(oldStart + SCENE_MANAGEMENT.MAX_SCAN_RANGE, chat.length - 1);\n        for (let i = newEnd + 1; i <= maxScan; i++) {\n            affectedIds.add(i);\n        }\n    }\n    \n    if (oldEnd !== null && oldStart === null && newStart !== null && newEnd !== null) {\n        // Transitioning from \"end only\" to \"complete scene\" - need to clear valid-start-point from messages before newStart\n        const minScan = Math.max(oldEnd - SCENE_MANAGEMENT.MAX_SCAN_RANGE, 0);\n        for (let i = minScan; i < newStart; i++) {\n            affectedIds.add(i);\n        }\n    }\n    \n    if (affectedIds.size === 0) {\n        return { min: null, max: null, needsFullUpdate: false };\n    }\n    \n    // If we're affecting more than MAX_AFFECTED_MESSAGES, fall back to full update\n    if (affectedIds.size > SCENE_MANAGEMENT.MAX_AFFECTED_MESSAGES) {\n        return { needsFullUpdate: true };\n    }\n    \n    const sortedIds = Array.from(affectedIds).sort((a, b) => a - b);\n    return {\n        min: sortedIds[0],\n        max: sortedIds[sortedIds.length - 1],\n        needsFullUpdate: false\n    };\n}\n\n/**\n * Set scene marker with validation\n * Returns a Promise that resolves immediately after state is committed to cache\n * (The debounced save to disk happens asynchronously in the background)\n */\nfunction setSceneMarker(messageId, type) {\n    const markers = getSceneMarkers();\n\n    // Store previous state for optimization\n    const oldStart = markers.sceneStart ?? null;\n    const oldEnd = markers.sceneEnd ?? null;\n\n    // Calculate new state atomically\n    const newState = calculateNewSceneState(markers, messageId, type);\n\n    // Update both metadata and cache simultaneously\n    markers.sceneStart = newState.start;\n    markers.sceneEnd = newState.end;\n    currentSceneState.start = newState.start;\n    currentSceneState.end = newState.end;\n\n    // Persist to metadata and update DOM to match committed state\n    saveMetadataForCurrentContext();\n    updateAffectedButtonStates(oldStart, oldEnd, newState.start, newState.end);\n    \n    // Return resolved Promise to signal that cache is updated and getSceneData() will work\n    return Promise.resolve();\n}\n\n/**\n * Atomically set both scene markers (start and end) and keep cache consistent.\n * This avoids stale currentSceneState overwriting freshly-set metadata.\n */\nexport function setSceneRange(startId, endId) {\n    const markers = getSceneMarkers();\n\n    // Store previous state for optimization\n    const oldStart = markers.sceneStart ?? null;\n    const oldEnd = markers.sceneEnd ?? null;\n\n    // Normalize to numbers\n    const s = Number(startId);\n    const e = Number(endId);\n\n    // Update both metadata and cache simultaneously\n    markers.sceneStart = s;\n    markers.sceneEnd = e;\n    currentSceneState.start = s;\n    currentSceneState.end = e;\n\n    // Persist and update only affected DOM\n    saveMetadataForCurrentContext();\n    updateAffectedButtonStates(oldStart, oldEnd, s, e);\n}\n\n/**\n * Clear scene markers\n */\nexport function clearScene() {\n\n    const markers = getSceneMarkers();\n\n    // Store previous state for optimization\n    const oldStart = markers.sceneStart ?? null;\n    const oldEnd = markers.sceneEnd ?? null;\n    \n    // Clear both metadata and cache simultaneously\n    markers.sceneStart = null;\n    markers.sceneEnd = null;\n    currentSceneState.start = null;\n    currentSceneState.end = null;\n    \n    // Persist and update DOM\n    saveMetadataForCurrentContext();\n    updateAllButtonStates();    \n}\n\n/**\n * Update visual states of all currently rendered message buttons (FULL UPDATE)\n * Use this for: chat loads, scene marker changes, initialization\n */\nexport function updateAllButtonStates() {\n    const markers = getSceneMarkers();\n    \n    // Find all rendered message elements\n    const messageElements = document.querySelectorAll('#chat .mes[mesid]');\n    \n    // Apply button states to all messages\n    updateButtonStatesForElements(messageElements, markers);    \n}\n\n/**\n * Update visual states of specific message buttons only (PARTIAL UPDATE)\n * Use this for: new messages added to current chat\n * @param {NodeList|Array} messageElements - Specific message elements to update\n */\nexport function updateNewMessageButtonStates(messageElements) {\n    if (!messageElements || messageElements.length === 0) return;\n    \n    const markers = getSceneMarkers();\n    \n    // Apply button states to only the specified messages\n    updateButtonStatesForElements(messageElements, markers);\n    \n}\n\n/**\n * Core logic for updating button states on a set of message elements\n * @private\n * @param {NodeList|Array} messageElements - Message elements to update\n * @param {Object} markers - Current scene markers\n */\nfunction updateButtonStatesForElements(messageElements, markers) {\n    const { sceneStart, sceneEnd } = markers;\n        \n    messageElements.forEach(messageElement => {\n        const messageId = parseInt(messageElement.getAttribute('mesid'));\n        const startBtn = messageElement.querySelector('.mes_stmb_start');\n        const endBtn = messageElement.querySelector('.mes_stmb_end');\n        \n        if (!startBtn || !endBtn) return;\n        \n        // Clear all special classes\n        startBtn.classList.remove('on', 'valid-start-point', 'in-scene');\n        endBtn.classList.remove('on', 'valid-end-point', 'in-scene');\n        \n        // Apply appropriate classes based on current state\n        if (sceneStart != null && sceneEnd != null) {\n            // Complete scene - highlight range and markers distinctly\n            if (messageId === sceneStart) {\n                // This is the start marker\n                startBtn.classList.add('on');\n            } else if (messageId === sceneEnd) {\n                // This is the end marker\n                endBtn.classList.add('on');\n            } else if (messageId > sceneStart && messageId < sceneEnd) {\n                // This is a message between start and end\n                startBtn.classList.add('in-scene');\n                endBtn.classList.add('in-scene');\n            }\n            // Messages outside the scene range (before start or after end) should have no special styling\n            // The classes were already cleared above, so no additional action needed\n\n        } else if (sceneStart != null) {\n            // Start set, show valid end points\n            if (messageId === sceneStart) {\n                startBtn.classList.add('on');\n            } else if (messageId > sceneStart) {\n                endBtn.classList.add('valid-end-point');\n            }\n\n        } else if (sceneEnd != null) {\n            // End set, show valid start points\n            if (messageId === sceneEnd) {\n                endBtn.classList.add('on');\n            } else if (messageId < sceneEnd) {\n                startBtn.classList.add('valid-start-point');\n            }\n        }\n    });\n}\n\n/**\n * Validate scene markers after message changes\n */\nexport function validateSceneMarkers() {\n    const markers = getSceneMarkers();\n\n    // Store previous state for optimization\n    const oldStart = markers.sceneStart ?? null;\n    const oldEnd = markers.sceneEnd ?? null;\n    \n    let hasChanges = false;\n    \n    // Check if markers are within chat bounds\n    const chatLength = chat.length;\n\n    // If no messages exist, clear markers and exit\n    if (chatLength === 0) {\n        if (markers.sceneStart !== null || markers.sceneEnd !== null) {\n            markers.sceneStart = null;\n            markers.sceneEnd = null;\n            hasChanges = true;\n        }\n    } else {\n        // Lower bound clamps\n        if (markers.sceneStart !== null && markers.sceneStart < 0) {\n            markers.sceneStart = null;\n            hasChanges = true;\n        }\n        \n        if (markers.sceneEnd !== null && markers.sceneEnd < 0) {\n            markers.sceneEnd = null;\n            hasChanges = true;\n        }\n\n        // Upper bounds\n        if (markers.sceneStart !== null && markers.sceneStart >= chatLength) {\n            markers.sceneStart = null;\n            hasChanges = true;\n        }\n        \n        if (markers.sceneEnd !== null && markers.sceneEnd >= chatLength) {\n            // For end marker, try to fall back to last message\n            markers.sceneEnd = chatLength - 1;\n            hasChanges = true;\n        }\n        \n        // Ensure start <= end (start = end is valid for single message)\n        if (markers.sceneStart !== null && markers.sceneEnd !== null && markers.sceneStart > markers.sceneEnd) {\n            markers.sceneStart = null;\n            markers.sceneEnd = null;\n            hasChanges = true;\n        }\n    }\n    \n    if (hasChanges) {\n        currentSceneState.start = markers.sceneStart;\n        currentSceneState.end = markers.sceneEnd;\n        saveMetadataForCurrentContext();\n        \n        // Use selective update instead of full update\n        updateAffectedButtonStates(oldStart, oldEnd, markers.sceneStart, markers.sceneEnd);\n    }\n}\n\n/**\n * Handle message deletion events\n */\nexport function handleMessageDeletion(deletedId, settings) {\n    const id = Number(deletedId);\n    if (!Number.isFinite(id)) return;\n\n    const markers = getSceneMarkers();\n    const oldStart = markers.sceneStart ?? null;\n    const oldEnd = markers.sceneEnd ?? null;\n\n    let newStart = markers.sceneStart;\n    let newEnd = markers.sceneEnd;\n    let toastrMessage = '';\n\n    // Deleting a message that is both start and end\n    if (newStart === id && newEnd === id) {\n        clearScene();\n\n        if (settings?.moduleSettings?.showNotifications) {\n            // Use existing key to avoid adding new i18n strings\n            toastr.warning(translate('Scene cleared due to start marker deletion', 'STMemoryBooks_Toast_SceneClearedStart'), 'STMemoryBooks');\n        }\n\n        // Always validate the markers after any deletion\n        validateSceneMarkers();\n        return;\n    }\n\n    if (newStart != null && newEnd != null) {\n        if (id < newStart) {\n            // Deletion before the scene: shift both down\n            newStart--;\n            newEnd--;\n            toastrMessage = translate('Scene markers adjusted due to message deletion.', 'STMemoryBooks_Toast_SceneMarkersAdjusted');\n        } else if (id === newStart) {\n            // Deleting the start marker; also shift end if it is after the deleted id\n            newStart = null;\n            if (newEnd != null && newEnd > id) newEnd--;\n            // Reuse existing key to avoid new locale entries\n            toastrMessage = translate('Scene end point cleared due to message deletion', 'STMemoryBooks_Toast_SceneEndPointCleared');\n        } else if (id > newStart && id < newEnd) {\n            // Deleting inside the scene: shift end down only\n            newEnd--;\n            toastrMessage = translate('Scene markers adjusted due to message deletion.', 'STMemoryBooks_Toast_SceneMarkersAdjusted');\n        } else if (id === newEnd) {\n            // Deleting the end marker\n            newEnd = null;\n            toastrMessage = translate('Scene end point cleared due to message deletion', 'STMemoryBooks_Toast_SceneEndPointCleared');\n        }\n        // id > newEnd: no change\n    } else if (newStart != null) {\n        if (id < newStart) {\n            newStart--;\n            toastrMessage = translate('Scene markers adjusted due to message deletion.', 'STMemoryBooks_Toast_SceneMarkersAdjusted');\n        } else if (id === newStart) {\n            newStart = null;\n            toastrMessage = translate('Scene end point cleared due to message deletion', 'STMemoryBooks_Toast_SceneEndPointCleared');\n        }\n        // id > newStart: no change\n    } else if (newEnd != null) {\n        if (id < newEnd) {\n            newEnd--;\n            toastrMessage = translate('Scene markers adjusted due to message deletion.', 'STMemoryBooks_Toast_SceneMarkersAdjusted');\n        } else if (id === newEnd) {\n            newEnd = null;\n            toastrMessage = translate('Scene end point cleared due to message deletion', 'STMemoryBooks_Toast_SceneEndPointCleared');\n        }\n        // id > newEnd: no change\n    } else {\n        // No markers set; still validate and exit\n        validateSceneMarkers();\n        return;\n    }\n\n    // Clamp and validate bounds\n    const chatLength = chat.length;\n    if (chatLength === 0) {\n        newStart = null;\n        newEnd = null;\n    } else {\n        if (newStart != null && (newStart < 0 || newStart >= chatLength)) newStart = null;\n        if (newEnd != null && (newEnd < 0 || newEnd >= chatLength)) newEnd = chatLength - 1;\n        if (newStart != null && newEnd != null && newStart > newEnd) {\n            newStart = null;\n            newEnd = null;\n        }\n    }\n\n    // Persist and update if changed\n    const hasChanges = (newStart !== markers.sceneStart) || (newEnd !== markers.sceneEnd);\n    if (hasChanges) {\n        markers.sceneStart = newStart;\n        markers.sceneEnd = newEnd;\n        currentSceneState.start = newStart;\n        currentSceneState.end = newEnd;\n        saveMetadataForCurrentContext();\n        updateAffectedButtonStates(oldStart, oldEnd, newStart, newEnd);\n\n        if (toastrMessage && settings?.moduleSettings?.showNotifications) {\n            toastr.warning(toastrMessage, 'STMemoryBooks');\n        }\n    }\n\n    // Always validate the markers after any deletion\n    validateSceneMarkers();\n}\n\n/**\n * Create message action buttons with consistent styling\n */\nexport function createSceneButtons(messageElement) {\n    const messageId = parseInt(messageElement.getAttribute('mesid'));\n    let extraButtonsContainer = messageElement.querySelector('.extraMesButtons');\n\n    // If the button container doesn't exist (e.g., on user messages), create and append it.\n    if (!extraButtonsContainer) {\n        extraButtonsContainer = document.createElement('div');\n        extraButtonsContainer.classList.add('extraMesButtons');\n        \n        // SillyTavern messages have a 'mes_block' that contains the text and buttons.\n        // Appending our container here ensures consistent placement.\n        const messageBlock = messageElement.querySelector('.mes_block');\n        if (messageBlock) {\n            messageBlock.appendChild(extraButtonsContainer);\n        } else {\n            // As a fallback, append to the main message element.\n            // The .extraMesButtons CSS should still position it reasonably well.\n            messageElement.appendChild(extraButtonsContainer);\n        }\n    }\n    \n    // Check if buttons already exist to prevent duplication\n    if (messageElement.querySelector('.mes_stmb_start')) return;\n    \n    // Create start button\n    const startButton = document.createElement('div');\n    startButton.title = translate('Mark Scene Start', 'STMemoryBooks_MarkSceneStart');\n    startButton.classList.add('mes_stmb_start', 'mes_button', 'fa-solid', 'fa-caret-right', 'interactable');\n    startButton.setAttribute('tabindex', '0');\n    startButton.setAttribute('data-i18n', '[title]STMemoryBooks_MarkSceneStart');\n\n    // Create end button\n    const endButton = document.createElement('div');\n    endButton.title = translate('Mark Scene End', 'STMemoryBooks_MarkSceneEnd');\n    endButton.classList.add('mes_stmb_end', 'mes_button', 'fa-solid', 'fa-caret-left', 'interactable');\n    endButton.setAttribute('tabindex', '0');\n    endButton.setAttribute('data-i18n', '[title]STMemoryBooks_MarkSceneEnd');\n    \n    // Add event listeners\n    startButton.addEventListener('click', (e) => {\n        e.stopPropagation();\n        setSceneMarker(messageId, 'start');\n    });\n\n    endButton.addEventListener('click', (e) => {\n        e.stopPropagation();\n        setSceneMarker(messageId, 'end');\n    });\n    \n    // Append buttons\n    extraButtonsContainer.appendChild(startButton);\n    extraButtonsContainer.appendChild(endButton);\n}\n\n/**\n * Get scene data with message excerpts\n */\nexport async function getSceneData() {\n    const markers = getSceneMarkers();\n    \n    if (markers.sceneStart === null || markers.sceneEnd === null) {\n        return null;\n    }\n    \n    const startMessage = chat[markers.sceneStart];\n    const endMessage = chat[markers.sceneEnd];\n    \n    if (!startMessage || !endMessage) {\n        return null;\n    }\n    \n    const getExcerpt = (message) => {\n        const content = message.mes || '';\n        return content.length > 100 ? content.substring(0, 100) + '...' : content;\n    };\n\n    // Build a temporary compiled scene for consistent token estimation\n    try {\n        const tempRequest = createSceneRequest(markers.sceneStart, markers.sceneEnd);\n        const tempCompiled = compileScene(tempRequest);\n        const estimatedTokens = await estimateTokenCount(tempCompiled);\n        \n        return {\n            sceneStart: markers.sceneStart,\n            sceneEnd: markers.sceneEnd,\n            startExcerpt: getExcerpt(startMessage),\n            endExcerpt: getExcerpt(endMessage),\n            startSpeaker: startMessage.name || 'Unknown',\n            endSpeaker: endMessage.name || 'Unknown',\n            messageCount: markers.sceneEnd - markers.sceneStart + 1,\n            estimatedTokens\n        };\n    } catch (e) {\n        console.warn('STMemoryBooks-SceneManager: getSceneData failed:', e);\n        try {\n            const msg = e?.message || '';\n            if (msg.includes('No visible messages')) {\n                toastr?.warning?.(translate('Selected range has no visible messages. Adjust start/end.', 'STMemoryBooks_NoVisibleMessages'), 'STMemoryBooks');\n            }\n        } catch {}\n        return null;\n    }\n}\n\n/**\n * Calculate new scene state based on marker type and message ID\n * @private\n */\nfunction calculateNewSceneState(markers, messageId, type) {\n    const numericId = parseInt(messageId);\n    let newStart = markers.sceneStart;\n    let newEnd = markers.sceneEnd;\n    \n    if (type === 'start') {\n        // If setting start, clear end if it would be invalid (start = end is valid)\n        if (markers.sceneEnd !== null && (markers.sceneEnd ?? null) < numericId) {\n            newEnd = null;\n        }\n\n        // Toggle start marker\n        newStart = markers.sceneStart === numericId ? null : numericId;\n    } else if (type === 'end') {\n        // If setting end, clear start if it would be invalid (start = end is valid)\n        if (markers.sceneStart !== null && (markers.sceneStart ?? null) > numericId) {\n            newStart = null;\n        }\n        \n        // Toggle end marker\n        newEnd = markers.sceneEnd === numericId ? null : numericId;\n    }\n    \n    return { start: newStart, end: newEnd };\n}\n\n/**\n * Update scene state cache\n */\nexport function updateSceneStateCache() {\n    const markers = getSceneMarkers();\n    currentSceneState.start = markers.sceneStart;\n    currentSceneState.end = markers.sceneEnd;\n}\n\n/**\n * Get current scene state from cache\n */\nexport function getCurrentSceneState() {\n    return { ...currentSceneState };\n}\n",
    "import { getRequestHeaders } from '../../../../script.js';\nimport { getBuiltInPresetPrompts, getDefaultPrompt } from './utils.js';\nimport { FILE_NAMES, SCHEMA, DISPLAY_NAME_DEFAULTS, DISPLAY_NAME_I18N_KEYS } from './constants.js';\nimport { translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-SummaryPromptManager';\nconst PROMPTS_FILE = FILE_NAMES.PROMPTS_FILE;\n\n/**\n * In-memory cache of loaded overrides\n * @type {Object|null}\n */\nlet cachedOverrides = null;\n\n/**\n * Flag to track if first-run initialization has been attempted\n * @type {boolean}\n */\nlet hasInitialized = false;\n\n/**\n * Promise to track ongoing initialization\n * @type {Promise|null}\n */\nlet initializationPromise = null;\n\n/**\n * Default display names for built-in presets (localized via i18n)\n */\nconst DEFAULT_DISPLAY_NAMES = Object.fromEntries(\n    Object.keys(DISPLAY_NAME_DEFAULTS).map(k => [\n        k,\n        translate(DISPLAY_NAME_DEFAULTS[k], DISPLAY_NAME_I18N_KEYS[k]),\n    ])\n);\n\n/**\n * Converts a string to title case\n * @param {string} str - String to convert\n * @returns {string} Title-cased string\n */\nfunction toTitleCase(str) {\n    return str.replace(/\\w\\S*/g, (txt) => {\n        return txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase();\n    });\n}\n\n/**\n * Generates a safe slug from a string\n * @param {string} str - String to slugify\n * @returns {string} Safe slug\n */\nfunction safeSlug(str) {\n    return str\n        .toLowerCase()\n        .replace(/[^a-z0-9]+/g, '-')\n        .replace(/^-+|-+$/g, '')\n        .substring(0, 50);\n}\n\n/**\n * Generates a display name from prompt content\n * @param {string} prompt - Prompt text\n * @returns {string} Generated display name\n */\nfunction generateDisplayNameFromContent(prompt) {\n    // Try to extract first line or sentence\n    const lines = prompt.split('\\n').filter(l => l.trim());\n    if (lines.length > 0) {\n        const firstLine = lines[0].trim();\n        // Remove common prefixes\n        const cleaned = firstLine\n            .replace(/^(You are|Analyze|Create|Generate|Write)\\s+/i, '')\n            .replace(/[:.]/g, '')\n            .trim();\n        return toTitleCase(cleaned.substring(0, 50));\n    }\n    return 'Custom Prompt';\n}\n\n/**\n * Generates a unique key for a preset\n * @param {string} baseName - Base name for the key\n * @param {Object} existingOverrides - Existing overrides to check against\n * @returns {string} Unique key\n */\nfunction generateUniqueKey(baseName, existingOverrides) {\n    const baseSlug = safeSlug(baseName);\n    let key = baseSlug;\n    let counter = 2;\n    \n    const builtIns = getBuiltInPresetPrompts();\n    while (key in existingOverrides || key in builtIns) {\n        key = `${baseSlug}-${counter}`;\n        counter++;\n    }\n    \n    return key;\n}\n\n/**\n * Loads overrides from the server\n * @returns {Promise<Object>} Overrides document\n */\nasync function loadOverrides(settings = null) {\n    if (cachedOverrides) {\n        return cachedOverrides;\n    }\n    let mustWrite = false;\n    let data = null;\n\n    try {\n        const response = await fetch(`/user/files/${PROMPTS_FILE}`, {\n            method: 'GET',\n            credentials: 'include',\n            headers: getRequestHeaders(),\n        });\n\n        if (!response.ok) {\n            // File does not exist. Always create with built-ins (and migrate legacy custom prompts)\n            mustWrite = true;\n        } else {\n            const text = await response.text();\n            data = JSON.parse(text);\n            if (!validatePromptsFile(data)) {\n                // Corrupt or invalid, overwrite with built-ins\n                mustWrite = true;\n            }\n        }\n    } catch (error) {\n        // On any error, create file\n        mustWrite = true;\n    }\n\n    if (mustWrite) {\n        const overrides = {};\n        const now = new Date().toISOString();\n        // Add all built-in presets (localized via i18n)\n        const builtIns = getBuiltInPresetPrompts();\n        for (const [key, prompt] of Object.entries(builtIns)) {\n            overrides[key] = {\n                displayName: DEFAULT_DISPLAY_NAMES[key] || toTitleCase(key),\n                prompt: prompt,\n                createdAt: now,\n            };\n        }\n        // Scan profiles for custom prompts (legacy migration, optional)\n        if (settings && settings.profiles && Array.isArray(settings.profiles)) {\n            for (const profile of settings.profiles) {\n                if (profile.prompt && profile.prompt.trim()) {\n                    const displayName = `Custom: ${profile.name || 'Unnamed Profile'}`;\n                    const key = generateUniqueKey(displayName, overrides);\n                    overrides[key] = {\n                        displayName: displayName,\n                        prompt: profile.prompt,\n                        createdAt: now,\n                    };\n                    console.log(`${MODULE_NAME}: Migrated custom prompt from profile \"${profile.name}\" as \"${key}\"`);\n                }\n            }\n        }\n        data = {\n            version: SCHEMA.CURRENT_VERSION,\n            overrides: overrides,\n        };\n        await saveOverrides(data);\n    }\n\n    cachedOverrides = data;\n    return cachedOverrides;\n}\n\n/**\n * Saves overrides to the server\n * @param {Object} doc - Document to save\n * @returns {Promise<void>}\n */\nasync function saveOverrides(doc) {\n    try {\n        const json = JSON.stringify(doc, null, 2);\n        const base64 = btoa(unescape(encodeURIComponent(json)));\n        \n        const response = await fetch('/api/files/upload', {\n            method: 'POST',\n            credentials: 'include',\n            headers: getRequestHeaders(),\n            body: JSON.stringify({\n                name: PROMPTS_FILE,\n                data: base64,\n            }),\n        });\n        \n        if (!response.ok) {\n            throw new Error(`Failed to save prompts: ${response.statusText}`);\n        }\n        \n        cachedOverrides = doc;\n        console.log(`${MODULE_NAME}: Prompts saved successfully`);\n    } catch (error) {\n        console.error(`${MODULE_NAME}: Error saving overrides:`, error);\n        throw error;\n    }\n}\n\n/**\n * Validates the structure of a prompts file\n * @param {Object} data - Data to validate\n * @returns {boolean} True if valid\n */\nfunction validatePromptsFile(data) {\n    if (!data || typeof data !== 'object') {\n        console.error(`${MODULE_NAME}: Invalid data type`);\n        return false;\n    }\n    \n    if (typeof data.version !== 'number') {\n        console.error(`${MODULE_NAME}: Invalid schema version type: ${data.version}`);\n        return false;\n    }\n    \n    if (data.version !== SCHEMA.CURRENT_VERSION) {\n        console.warn(`${MODULE_NAME}: Unexpected schema version: ${data.version} (expected ${SCHEMA.CURRENT_VERSION})`);\n    }\n    \n    if (!data.overrides || typeof data.overrides !== 'object') {\n        console.error(`${MODULE_NAME}: Missing or invalid overrides object`);\n        return false;\n    }\n    \n    // Validate each override entry\n    for (const [key, override] of Object.entries(data.overrides)) {\n        if (!override || typeof override !== 'object') {\n            console.error(`${MODULE_NAME}: Invalid override entry for key: ${key}`);\n            return false;\n        }\n        \n        if (typeof override.prompt !== 'string' || !override.prompt.trim()) {\n            console.error(`${MODULE_NAME}: Invalid or empty prompt for key: ${key}`);\n            return false;\n        }\n        \n        if (override.displayName !== undefined && typeof override.displayName !== 'string') {\n            console.error(`${MODULE_NAME}: Invalid displayName for key: ${key}`);\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n/**\n * Performs first-run initialization if needed\n * Uses promise-based locking to prevent race conditions\n * @param {Object} settings - Extension settings\n * @returns {Promise<boolean>} True if initialization was performed\n */\nexport async function firstRunInitIfMissing(settings) {\n    // Always call loadOverrides to guarantee file existence and built-ins\n    await loadOverrides(settings);\n    hasInitialized = true;\n    initializationPromise = null;\n    return true;\n}\n\n/**\n * Lists all available presets\n * @returns {Promise<Array>} Array of preset objects with key, displayName, createdAt\n */\nexport async function listPresets(settings = null) {\n    const data = await loadOverrides(settings);\n    const presets = [];\n    \n    // Add overrides first (user-defined and any built-ins that are overridden)\n    for (const [key, preset] of Object.entries(data.overrides)) {\n        presets.push({\n            key: key,\n            displayName: preset.displayName || toTitleCase(key),\n            createdAt: preset.createdAt || null,\n        });\n    }\n\n    // Include any built-in presets that are not overridden (virtual entries; i18n-backed at runtime)\n    const builtIns = getBuiltInPresetPrompts() || {};\n    for (const key of Object.keys(builtIns)) {\n        if (!(key in data.overrides)) {\n            presets.push({\n                key: key,\n                displayName: DEFAULT_DISPLAY_NAMES[key] || toTitleCase(key),\n                createdAt: null,\n            });\n        }\n    }\n    \n    // Sort by creation date (newest first)\n    presets.sort((a, b) => {\n        if (!a.createdAt) return 1;\n        if (!b.createdAt) return -1;\n        return new Date(b.createdAt) - new Date(a.createdAt);\n    });\n    \n    return presets;\n}\n\n/**\n * Gets the prompt text for a preset\n * @param {string} key - Preset key\n * @returns {Promise<string>} Prompt text\n */\nexport async function getPrompt(key, settings = null) {\n    const data = await loadOverrides(settings);\n\n    if (data.overrides[key]) {\n        const p = data.overrides[key].prompt;\n        if (typeof p === 'string' && p.trim()) {\n            return p;\n        }\n    }\n\n    // Fallback to built-in (localized)\n    const builtIns = getBuiltInPresetPrompts();\n    return builtIns[key] || getDefaultPrompt();\n}\n\n/**\n * Gets the display name for a preset\n * @param {string} key - Preset key\n * @returns {Promise<string>} Display name\n */\nexport async function getDisplayName(key, settings = null) {\n    const data = await loadOverrides(settings);\n    \n    if (data.overrides[key] && data.overrides[key].displayName) {\n        return data.overrides[key].displayName;\n    }\n    \n    // Fallback to default display names or title-cased key\n    return DEFAULT_DISPLAY_NAMES[key] || toTitleCase(key);\n}\n\n/**\n * Checks if a preset exists\n * @param {string} key - Preset key\n * @returns {Promise<boolean>} True if preset exists\n */\nexport async function isValid(key, settings = null) {\n    const data = await loadOverrides(settings);\n    {\n        const builtIns = getBuiltInPresetPrompts();\n        return !!(data.overrides[key] || builtIns[key]);\n    }\n}\n\n/**\n * Creates or updates a preset\n * @param {string} key - Preset key (if null, generates a new one)\n * @param {string} prompt - Prompt text\n * @param {string} displayName - Display name\n * @returns {Promise<string>} The key of the created/updated preset\n */\nexport async function upsertPreset(key, prompt, displayName) {\n    const data = await loadOverrides();\n    const now = new Date().toISOString();\n    \n    // Generate key if not provided\n    if (!key) {\n        key = generateUniqueKey(displayName || generateDisplayNameFromContent(prompt), data.overrides);\n    }\n    \n    // Update or create\n    if (data.overrides[key]) {\n        data.overrides[key].prompt = prompt;\n        data.overrides[key].displayName = displayName || data.overrides[key].displayName;\n        data.overrides[key].updatedAt = now;\n    } else {\n        data.overrides[key] = {\n            displayName: displayName || generateDisplayNameFromContent(prompt),\n            prompt: prompt,\n            createdAt: now,\n        };\n    }\n    \n    await saveOverrides(data);\n    return key;\n}\n\n/**\n * Duplicates a preset\n * @param {string} sourceKey - Key of preset to duplicate\n * @returns {Promise<string>} Key of the new preset\n */\nexport async function duplicatePreset(sourceKey) {\n    const data = await loadOverrides();\n    \n    const source = data.overrides[sourceKey];\n    if (!source) {\n        throw new Error(`Preset \"${sourceKey}\" not found`);\n    }\n    \n    const newDisplayName = `${source.displayName} (Copy)`;\n    const newKey = generateUniqueKey(newDisplayName, data.overrides);\n    const now = new Date().toISOString();\n    \n    data.overrides[newKey] = {\n        displayName: newDisplayName,\n        prompt: source.prompt,\n        createdAt: now,\n    };\n    \n    await saveOverrides(data);\n    return newKey;\n}\n\n/**\n * Removes a preset\n * @param {string} key - Preset key to remove\n * @returns {Promise<void>}\n */\nexport async function removePreset(key) {\n    const data = await loadOverrides();\n    \n    if (!data.overrides[key]) {\n        throw new Error(`Preset \"${key}\" not found`);\n    }\n    \n    delete data.overrides[key];\n    await saveOverrides(data);\n}\n\n/**\n * Exports the current prompts document\n * @returns {Promise<string>} JSON string of the document\n */\nexport async function exportToJSON() {\n    const data = await loadOverrides();\n    return JSON.stringify(data, null, 2);\n}\n\n/**\n * Imports a prompts document\n * @param {string} jsonString - JSON string to import\n * @returns {Promise<void>}\n */\nexport async function importFromJSON(jsonString) {\n    try {\n        const data = JSON.parse(jsonString);\n        \n        // Validate structure using the validation function\n        if (!validatePromptsFile(data)) {\n            throw new Error('Invalid prompts file structure - see console for details');\n        }\n        \n        await saveOverrides(data);\n    } catch (error) {\n        console.error(`${MODULE_NAME}: Error importing prompts:`, error);\n        throw error;\n    }\n}\n\n/**\n * Clears the cache (useful for testing or forcing a reload)\n */\nexport function clearCache() {\n    cachedOverrides = null;\n    hasInitialized = false;\n}\n\n/**\n * Recreate built-in prompts by removing their overrides so they fall back to current-locale i18n.\n * This is a destructive operation for built-in keys only and does not preserve customizations.\n * @param {'overwrite'} mode - Only 'overwrite' is supported (explicit destructive flow).\n * @returns {Promise<{ removed: number }>} Count of removed overrides.\n */\nexport async function recreateBuiltInPrompts(mode = 'overwrite') {\n    if (mode !== 'overwrite') {\n        console.warn(`${MODULE_NAME}: Unsupported mode for recreateBuiltInPrompts: ${mode}; defaulting to 'overwrite'`);\n    }\n\n    const data = await loadOverrides();\n    const builtIns = getBuiltInPresetPrompts();\n    const builtInKeys = Object.keys(builtIns || {});\n    let removed = 0;\n\n    if (data && data.overrides && typeof data.overrides === 'object') {\n        for (const key of builtInKeys) {\n            if (key in data.overrides) {\n                delete data.overrides[key];\n                removed++;\n            }\n        }\n    }\n\n    await saveOverrides(data);\n    cachedOverrides = data;\n    console.log(`${MODULE_NAME}: Recreated built-in prompts (removed ${removed} overrides)`);\n    return { removed };\n}\n",
    "import { chat_metadata, characters, name2, this_chid } from '../../../../script.js';\nimport { getContext, extension_settings } from '../../../extensions.js';\nimport { selected_group, groups } from '../../../group-chats.js';\nimport { METADATA_KEY, world_names } from '../../../world-info.js';\nimport { Popup, POPUP_TYPE, POPUP_RESULT } from '../../../popup.js';\nimport { getSceneMarkers, saveMetadataForCurrentContext } from './sceneManager.js';\nimport { getPrompt as getCustomPresetPrompt } from './summaryPromptManager.js';\nimport { DISPLAY_NAME_DEFAULTS, DISPLAY_NAME_I18N_KEYS } from './constants.js';\nimport { translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-Utils';\nconst $ = window.jQuery;\n\n// Prefer the first selector that exists in the DOM\nfunction pick$(...selectors) {\n    for (const s of selectors) {\n        const $el = $(s);\n        if ($el.length) return $el;\n    }\n    return $(); // empty jQuery\n}\n\n// Returns '#group_' if group UI controls are present, otherwise '#'\nfunction groupPrefix() {\n    return document.querySelector('#group_chat_completion_source') ? '#group_' : '#';\n}\n\nexport function readIntInput(inputEl, fallback) {\n  if (!inputEl) return fallback;\n  const parsed = parseInt(inputEl.value, 10);\n  return Number.isFinite(parsed) ? parsed : fallback;\n}\n\nexport function clampInt(n, min, max) {\n  return Math.min(Math.max(n, min), max);\n}\n\n// Centralized DOM selectors - single source of truth\nexport const SELECTORS = {\n    extensionsMenu: '#extensionsMenu .list-group',\n    menuItem: '#stmb-menu-item',\n    chatContainer: '#chat',\n    // API and model selectors for profile settings\n    mainApi: '#main_api',\n    completionSource: '#chat_completion_source',\n    modelOpenai: '#model_openai_select',\n    modelClaude: '#model_claude_select',\n    modelOpenrouter: '#model_openrouter_select',\n    modelAi21: '#model_ai21_select',\n    modelGoogle: '#model_google_select',\n    modelMistralai: '#model_mistralai_select',\n    modelCohere: '#model_cohere_select',\n    modelPerplexity: '#model_perplexity_select',\n    modelGroq: '#model_groq_select',\n    modelNanogpt: '#model_nanogpt_select',\n    modelDeepseek: '#model_deepseek_select',\n    modelElectronhub: '#model_electronhub_select',\n    modelVertexai: '#model_vertexai_select',\n    modelAimlapi: '#model_aimlapi_select',\n    modelXai: '#model_xai_select',\n    modelPollinations: '#model_pollinations_select',\n    modelMoonshot: '#model_moonshot_select',\n    modelFireworks: '#model_fireworks_select',\n    modelCometapi: '#model_cometapi_select',\n    modelAzureOpenai: '#model_azure_openai_select',\n    tempOpenai: '#temp_openai',\n    tempCounterOpenai: '#temp_counter_openai'\n};\n\n// Supported Chat Completion sources - BULLETPROOF\nconst SUPPORTED_COMPLETION_SOURCES = [\n    'openai', 'claude', 'openrouter', 'ai21', 'makersuite', 'vertexai',\n    'mistralai', 'custom', 'cohere', 'perplexity', 'groq', 'nanogpt',\n    'deepseek', 'electronhub', 'aimlapi', 'xai', 'pollinations',\n    'moonshot', 'fireworks', 'cometapi', 'azure_openai'\n];\n\n/**\n * Normalize completion source names.\n * Note: In ST base code, the provider is represented as 'makersuite'.\n * Keep 'makersuite' as the canonical key and avoid other aliases.\n */\nexport function normalizeCompletionSource(source) {\n    const s = String(source || '').trim().toLowerCase();\n    // Canonical provider key is 'makersuite' in ST base code.\n    // Accept legacy alias and normalize to 'makersuite' to match ST without changing ST code.\n    if (s === 'google') return 'makersuite';\n    return s === '' ? 'openai' : s;\n}\n\n/**\n * BULLETPROOF: Get current API and completion source information with comprehensive error handling\n */\nexport function getCurrentApiInfo() {\n    try {\n        let api = 'unknown';\n        let model = 'unknown';\n        let completionSource = 'unknown';\n\n        // Try SillyTavern's built-in functions first\n        if (typeof window.getGeneratingApi === 'function') {\n            api = window.getGeneratingApi();\n        } else {\n            api = $(SELECTORS.mainApi).val() || 'unknown';\n        }\n\n        if (typeof window.getGeneratingModel === 'function') {\n            model = window.getGeneratingModel();\n        }\n\n        completionSource = $(SELECTORS.completionSource).val() || api;\n\n        // Validate completion source\n        if (!SUPPORTED_COMPLETION_SOURCES.includes(completionSource)) {\n            console.warn(`${MODULE_NAME}: Unsupported completion source: ${completionSource}, falling back to openai`);\n            completionSource = 'openai';\n        }\n\n        return { api, model, completionSource };\n    } catch (e) {\n        console.warn(`${MODULE_NAME}: Error getting API info:`, e);\n        return {\n            api: $(SELECTORS.mainApi).val() || 'unknown',\n            model: 'unknown',\n            completionSource: $(SELECTORS.completionSource).val() || 'openai'\n        };\n    }\n}\n\n/**\n * BULLETPROOF: Get the appropriate model and temperature selectors for current completion source\n */\nexport function getApiSelectors() {\n    const prefix = groupPrefix();\n\n    // current completion source from active UI (group or normal)\n    const $source = pick$(`${prefix}chat_completion_source`, '#chat_completion_source');\n    const completionSource = ($source.val?.() || 'openai');\n\n    // Model selectors per provider/source (group-aware via prefix)\n    const modelSelectorMap = {\n        openai:        `${prefix}model_openai_select`,\n        claude:        `${prefix}model_claude_select`,\n        openrouter:    `${prefix}model_openrouter_select`,\n        ai21:          `${prefix}model_ai21_select`,\n        makersuite:    `${prefix}model_google_select`,\n        mistralai:     `${prefix}model_mistralai_select`,\n        custom:        `${prefix}model_custom_select`,\n        cohere:        `${prefix}model_cohere_select`,\n        perplexity:    `${prefix}model_perplexity_select`,\n        groq:          `${prefix}model_groq_select`,\n        nanogpt:       `${prefix}model_nanogpt_select`,\n        deepseek:      `${prefix}model_deepseek_select`,\n        electronhub:   `${prefix}model_electronhub_select`,\n        vertexai:      `${prefix}model_vertexai_select`,\n        aimlapi:       `${prefix}model_aimlapi_select`,\n        xai:           `${prefix}model_xai_select`,\n        pollinations:  `${prefix}model_pollinations_select`,\n        moonshot:      `${prefix}model_moonshot_select`,\n        fireworks:     `${prefix}model_fireworks_select`,\n        cometapi:      `${prefix}model_cometapi_select`,\n        azure_openai:  `${prefix}model_azure_openai_select`,\n    };\n\n    const model = modelSelectorMap[completionSource] || modelSelectorMap.openai;\n\n    // Temps share same ids per UI set\n    const temp = `${prefix}temp_openai`.replace('##', '#');\n    const tempCounter = `${prefix}temp_counter_openai`.replace('##', '#');\n\n    return { model, temp, tempCounter };\n}\n\n/**\n * GROUP CHAT SUPPORT: Get current context - detects group vs single character chats\n * @returns {Object} Context information including group/character detection\n */\nexport function getCurrentMemoryBooksContext() {\n    try {\n        let characterName = null;\n        let chatId = null;\n        let chatName = null;\n\n        // Check if we're in a group chat (following group-chats.js pattern)\n        const isGroupChat = !!selected_group;\n        const groupId = selected_group || null;\n        let groupName = null;\n\n        if (isGroupChat) {\n            // Group chat context (following group-chats.js pattern)\n            const group = groups?.find(x => x.id === groupId);\n            if (group) {\n                groupName = group.name;\n                chatId = group.chat_id;\n                chatName = chatId;\n                // For group chats, use the group name as the \"character\" identifier for compatibility\n                characterName = groupName;\n            }\n        } else {\n            // Single character chat context (following group-chats.js and script.js patterns)\n            \n            // Method 1: Use name2 variable (primary character name from script.js)\n            if (name2 && name2.trim()) {\n                characterName = String(name2).trim();\n            }\n            // Method 2: Try to get current character from characters array and this_chid\n            else if (this_chid !== undefined && characters && characters[this_chid]) {\n                characterName = characters[this_chid].name;\n            }\n            // Method 3: Try chat_metadata.character_name as fallback\n            else if (chat_metadata?.character_name) {\n                characterName = String(chat_metadata.character_name).trim();\n            }\n            \n            // Normalize unicode characters for consistency\n            if (characterName && characterName.normalize) {\n                characterName = characterName.normalize('NFC');\n            }\n\n            // Get chat information using SillyTavern's context system\n            try {\n                const context = getContext();\n                if (context?.chatId) {\n                    chatId = context.chatId;\n                    chatName = chatId;\n                } else if (typeof window.getCurrentChatId === 'function') {\n                    chatId = window.getCurrentChatId();\n                    chatName = chatId;\n                }\n            } catch (error) {\n                console.warn(`${MODULE_NAME}: Could not get context, trying fallback methods`);\n                if (typeof window.getCurrentChatId === 'function') {\n                    chatId = window.getCurrentChatId();\n                    chatName = chatId;\n                }\n            }\n        }\n\n        // Get bound lorebook information\n        let lorebookName = null;\n        if (chat_metadata && METADATA_KEY in chat_metadata) {\n            lorebookName = chat_metadata[METADATA_KEY];\n        }\n\n        // Get current model/temperature settings (following ModelTempLocks approach)\n        let modelSettings = null;\n        \n        try {\n            // Get API info using the same method as ModelTempLocks\n            const currentApiInfo = getCurrentApiInfo();\n            \n            // Get temperature using the same method as ModelTempLocks\n            const apiSelectors = getApiSelectors();\n            const rawTemp =\n                $(apiSelectors.temp).val() ??\n                $(apiSelectors.tempCounter).val();\n            const currentTemp = Number.isFinite(parseFloat(rawTemp))\n            ? parseFloat(rawTemp)\n            : 0.7;\n            \n            // Get model using the same method as ModelTempLocks\n            let currentModel = $(apiSelectors.model).val() || '';\n            \n            modelSettings = {\n                api: currentApiInfo.api,\n                model: currentModel,\n                temperature: currentTemp,\n                completionSource: currentApiInfo.completionSource,\n                source: 'current_ui'\n            };\n            \n        } catch (error) {\n            console.warn(`${MODULE_NAME}: Could not get current model/temperature settings:`, error);\n            modelSettings = null;\n        }\n\n        const result = {\n            characterName,\n            chatId,\n            chatName,\n            groupId,\n            isGroupChat,\n            lorebookName,\n            modelSettings\n        };\n\n        // Add group-specific properties when in group chat\n        if (isGroupChat) {\n            result.groupName = groupName;\n        }\n        return result;\n\n    } catch (error) {\n        console.warn(`${MODULE_NAME}: Error getting context:`, error);\n        return {\n            characterName: null,\n            chatId: null,\n            chatName: null,\n            groupId: null,\n            groupName: null,\n            isGroupChat: false\n        };\n    }\n}\n\n/**\n * Determines which lorebook to use based on settings and chat metadata.\n * If in manual mode and no lorebook is set, it will trigger a selection popup.\n *\n * Note: This function only shows the selection popup when NO manual lorebook is currently set.\n * If a manual lorebook already exists, it returns that lorebook without prompting.\n * For \"change\" operations that should always show a selection popup, use showLorebookSelectionPopup() instead.\n *\n * @returns {Promise<string|null>} The name of the effective lorebook, or null if none is available/selected.\n */\nexport async function getEffectiveLorebookName() {\n    const settings = extension_settings.STMemoryBooks;\n    \n    // If manual mode is OFF, use the default chat-bound lorebook\n    if (!settings.moduleSettings.manualModeEnabled) {\n        return chat_metadata?.[METADATA_KEY] || null;\n    }\n\n    // Manual mode is ON. Check if a manual lorebook has already been designated for this chat.\n    const stmbData = getSceneMarkers(); // This function already gets the right metadata object\n    if (stmbData.manualLorebook ?? null) {\n        // Ensure the designated lorebook still exists\n        if (world_names.includes(stmbData.manualLorebook)) {\n            return stmbData.manualLorebook;\n        } else {\n            toastr.error(`The designated manual lorebook \"${stmbData.manualLorebook}\" no longer exists. Please select a new one.`);\n            delete stmbData.manualLorebook; // Clear the invalid entry\n        }\n    }\n\n    // No manual lorebook is set. We need to ask the user.\n    const lorebookOptions = world_names.map(name => `<option value=\"${name}\">${name}</option>`).join('');\n    \n    if (lorebookOptions.length === 0) {\n        toastr.error('No lorebooks found to select from.', 'STMemoryBooks');\n        return null;\n    }\n\n    const popupContent = `\n        <h4>Select a Memory Book</h4>\n        <div class=\"world_entry_form_control\">\n            <p>Manual mode is enabled, but no lorebook has been designated for this chat's memories. Please select one.</p>\n            <select id=\"stmb-manual-lorebook-select\" class=\"text_pole\">\n                ${lorebookOptions}\n            </select>\n        </div>\n    `;\n\n    const popup = new Popup(popupContent, POPUP_TYPE.TEXT, '', { okButton: 'Select', cancelButton: 'Cancel' });\n    const result = await popup.show();\n\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\n        const selectedLorebook = popup.dlg.querySelector('#stmb-manual-lorebook-select').value;\n        \n        // Save the selection to the chat's metadata\n        stmbData.manualLorebook = selectedLorebook;\n        saveMetadataForCurrentContext(); // Use the existing function from sceneManager to save correctly for groups/single chats\n        \n        toastr.success(`\"${selectedLorebook}\" is now the Memory Book for this chat.`, 'STMemoryBooks');\n        return selectedLorebook;\n    }\n\n    // User cancelled the selection\n    return null;\n}\n\n/**\n * Always shows a lorebook selection popup, regardless of current manual lorebook state.\n * This function is intended for \"change\" operations where the user explicitly wants to select a different lorebook.\n *\n * @param {string} currentLorebook - The currently selected lorebook (optional, for display purposes)\n * @returns {Promise<string|null>} The name of the selected lorebook, or null if cancelled/no selection made.\n */\nexport async function showLorebookSelectionPopup(currentLorebook = null) {\n    // Check if lorebooks are available\n    if (world_names.length === 0) {\n        toastr.error('No lorebooks found to select from.', 'STMemoryBooks');\n        return null;\n    }\n\n    const lorebookOptions = world_names.map(name => {\n        const selected = name === currentLorebook ? ' selected' : '';\n        return `<option value=\"${name}\"${selected}>${name}</option>`;\n    }).join('');\n\n    const popupContent = `\n        <h4>Select a Memory Book</h4>\n        <div class=\"world_entry_form_control\">\n            <p>Choose which lorebook should be used for this chat's memories.</p>\n            ${currentLorebook ? `<p><strong>Current:</strong> ${currentLorebook}</p>` : ''}\n            <select id=\"stmb-manual-lorebook-select\" class=\"text_pole\">\n                ${lorebookOptions}\n            </select>\n        </div>\n    `;\n\n    const popup = new Popup(popupContent, POPUP_TYPE.TEXT, '', { okButton: 'Select', cancelButton: 'Cancel' });\n    const result = await popup.show();\n\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\n        const selectedLorebook = popup.dlg.querySelector('#stmb-manual-lorebook-select').value;\n\n        // Only save and show success if a different lorebook was actually selected\n        if (selectedLorebook !== currentLorebook) {\n            const stmbData = getSceneMarkers();\n            stmbData.manualLorebook = selectedLorebook;\n            saveMetadataForCurrentContext();\n\n            toastr.success(`Manual lorebook changed to: ${selectedLorebook}`, 'STMemoryBooks');\n            return selectedLorebook;\n        } else {\n            // Same lorebook selected, no need to save or show success\n            return selectedLorebook;\n        }\n    }\n\n    // User cancelled the selection\n    return null;\n}\n\n\n/**\n * Get current model and temperature settings with comprehensive validation\n */\nexport function getCurrentModelSettings(profile) {\n    try {\n        if (!profile) {\n            throw new Error('getCurrentModelSettings requires a profile');\n        }\n        const conn = profile.effectiveConnection || profile.connection;\n        if (!conn) {\n            throw new Error('Profile is missing connection');\n        }\n        const model = (conn.model || '').trim();\n        if (!model) {\n            throw new Error('Profile is missing required connection.model');\n        }\n        let temp = parseTemperature(conn.temperature);\n        if (temp === null) temp = 0.7;\n\n        return {\n            model,\n            temperature: temp,\n        };\n    } catch (error) {\n        console.warn(`${MODULE_NAME}: Error getting current model settings:`, error);\n        throw error;\n    }\n}\n\n/**\n * UI-based model/temperature reader (for dynamic ST settings or overrides)\n */\nexport function getUIModelSettings() {\n    try {\n        const selectors = getApiSelectors();\n        const currentModel = ($(selectors.model).val() || '').trim();\n        let currentTemp = 0.7;\n        const tempValue = $(selectors.temp).val() || $(selectors.tempCounter).val();\n        if (tempValue !== null && tempValue !== undefined && tempValue !== '') {\n            const parsedTemp = parseFloat(tempValue);\n            if (!isNaN(parsedTemp) && parsedTemp >= 0 && parsedTemp <= 2) {\n                currentTemp = parsedTemp;\n            }\n        }\n        return {\n            model: currentModel,\n            temperature: currentTemp,\n        };\n    } catch (error) {\n        console.warn(`${MODULE_NAME}: Error getting UI model settings:`, error);\n        return {\n            model: '',\n            temperature: 0.7\n        };\n    }\n}\n\n/**\n * Estimate tokens for a text string using the project tokenizer with a safe fallback.\n * Returns input (prompt) tokens, an estimated output token count, and the total.\n *\n * Callers should pass the exact string they intend to send to the model\n * (e.g., system + prompt + scene), to ensure accurate budgeting and warnings.\n *\n * @param {string} text\n * @param {{ estimatedOutput?: number }} [options]\n * @returns {Promise<{ input: number, output: number, total: number }>}\n */\nexport async function estimateTokens(text, options = {}) {\n    const { estimatedOutput = 300 } = options;\n    const content = String(text || '');\n    const inputTokens = Math.ceil(content.length / 4);\n    return {\n        input: inputTokens,\n        output: estimatedOutput,\n        total: inputTokens + estimatedOutput,\n    };\n}\n\n/**\n * Resolve a profile's effective connection into a normalized shape\n * { api, model, temperature, endpoint, apiKey }.\n * - Applies normalizeCompletionSource to api\n * - Clamps temperature to [0, 2] with default 0.7\n * - Passes through endpoint/apiKey if provided on the profile connection\n *\n * @param {Object} profile\n * @returns {{ api: string, model: string, temperature: number, endpoint?: string, apiKey?: string }}\n */\nexport function resolveEffectiveConnectionFromProfile(profile) {\n    const conn = (profile?.effectiveConnection || profile?.connection || {});\n    const api = normalizeCompletionSource(conn.api || 'openai');\n    const model = (conn.model || '').trim();\n    let temperature = 0.7;\n    if (typeof conn.temperature === 'number' && !Number.isNaN(conn.temperature)) {\n        temperature = Math.max(0, Math.min(2, conn.temperature));\n    }\n    const endpoint = conn.endpoint ? String(conn.endpoint) : undefined;\n    const apiKey = conn.apiKey ? String(conn.apiKey) : undefined;\n\n    return { api, model, temperature, endpoint, apiKey };\n}\n\n\n/**\n * Localized built-in preset prompts via i18n.\n * Keys are stable; values are localized strings from SillyTavern i18n.\n * JSON keys in responses must remain: \"title\", \"content\", \"keywords\".\n */\nexport function getBuiltInPresetPrompts() {\n    return {\n        summary: translate(\n`You are a talented summarist skilled at capturing scenes from stories comprehensively. Analyze the following roleplay scene and return a detailed memory as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short scene title (1-3 words)\",\n  \"content\": \"Detailed beat-by-beat summary in narrative prose...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, create a detailed beat-by-beat summary in narrative prose. First, note the dates/time. Then capture this scene accurately without losing ANY important information EXCEPT FOR [OOC] conversation/interaction. All [OOC] conversation/interaction is not useful for summaries.\nThis summary will go in a vectorized database, so include:\n- All important story beats/events that happened\n- Key interaction highlights and character developments\n- Notable details, memorable quotes, and revelations\n- Outcome and anything else important for future interactions between {{user}} and {{char}}\nCapture ALL nuance without repeating verbatim. Make it comprehensive yet digestible.\n\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords for vectorized database retrieval. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nReturn ONLY the JSON, no other text.`,\n            'STMemoryBooks_Prompt_summary'\n        ),\n        summarize: translate(\n`Analyze the following roleplay scene and return a structured summary as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short scene title (1-3 words)\",\n  \"content\": \"Detailed summary with markdown headers...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, create a detailed bullet-point summary using markdown with these headers (but skip and ignore all OOC conversation/interaction):\n- **Timeline**: Day/time this scene covers.\n- **Story Beats**: List all important plot events and story developments that occurred.\n- **Key Interactions**: Describe the important character interactions, dialogue highlights, and relationship developments.\n- **Notable Details**: Mention any important objects, settings, revelations, or details that might be relevant for future interactions.\n- **Outcome**: Summarize the result, resolution, or state of affairs at the end of the scene.\n\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords that would help a vectorized database find this conversation again if something is mentioned. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nEnsure you capture ALL important information - comprehensive detail is more important than brevity.\n\nReturn ONLY the JSON, no other text.`,\n            'STMemoryBooks_Prompt_summarize'\n        ),\n        synopsis: translate(\n`Analyze the following roleplay scene and return a comprehensive synopsis as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short scene title (1-3 words)\",\n  \"content\": \"Long detailed synopsis with markdown structure...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, create a long and detailed beat-by-beat summary using markdown structure. Capture the most recent scene accurately without losing ANY information. [OOC] conversation/interaction is not useful for summaries and should be ignored and excluded. Use this structure:\n# [Scene Title]\n**Timeline**: (day/time)\n## Story Beats\n- (List all important plot events and developments)\n## Key Interactions\n- (Detail all significant character interactions and dialogue)\n## Notable Details\n- (Include memorable quotes, revelations, objects, settings)\n## Outcome\n- (Describe results, resolutions, and final state)\n\nInclude EVERYTHING important for future interactions between {{user}} and {{char}}. Capture all nuance without regurgitating verbatim.\n\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords for vectorized database retrieval. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nReturn ONLY the JSON, no other text.`,\n            'STMemoryBooks_Prompt_synopsis'\n        ),\n        sumup: translate(\n`Analyze the following roleplay scene and return a beat summary as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short scene title (1-3 words)\",\n  \"content\": \"Comprehensive beat summary...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, write a comprehensive beat summary that captures this scene completely. Format it as:\n# Scene Summary - Day X - [Title]\nFirst note the dates/time covered by the scene. Then narrate ALL important story beats/events that happened, key interaction highlights, notable details, memorable quotes, character developments, and outcome. Ensure no important information is lost. [OOC] conversation/interaction is not useful for summaries and should be ignored and excluded. \n\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords that would help a vectorized database find this summary again if mentioned. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nReturn ONLY the JSON, no other text.`,\n            'STMemoryBooks_Prompt_sumup'\n        ),\n        minimal: translate(\n`Analyze the following roleplay scene and return a minimal memory entry as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short scene title (1-3 words)\",\n  \"content\": \"Brief 2-5 sentence summary...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, provide a very brief 2-5 sentence summary of what happened in this scene. [OOC] conversation/interaction is not useful for summaries and should be ignored and excluded.\n\nFor the keywords field, generate 15-30 specific, descriptive, highly relevant keywords for database retrieval - focus on the most important terms that would help find this scene later. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nReturn ONLY the JSON, no other text.`,\n            'STMemoryBooks_Prompt_minimal'\n        ),\n        northgate: translate(\n`You are a memory archivist for a long-form narrative. Your function is to analyze the provided scene and extract all pertinent information into a structured JSON object.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n\"title\": \"Concise Scene Title (3-5 words)\",\n\"content\": \"A detailed, literary summary of the scene written in a third-person, past-tense narrative style. Capture all key actions, emotional shifts, character development, and significant dialogue. Focus on \"showing\" what happened through concrete details. Ensure the summary is comprehensive enough to serve as a standalone record of the scene's events and their impact on the characters.\",\n\"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the \"content\" field, write with literary quality. Do not simply list events; synthesize them into a coherent narrative block.\n\nFor the \"keywords\" field, provide 15-30 specific and descriptive keywords that capture the scene's core elements. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nReturn ONLY the JSON object, with no additional text or explanations.`,\n            'STMemoryBooks_Prompt_northgate'\n        ),\n        aelemar: translate(\n`You are a meticulous archivist, skilled at accurately capturing all key plot points and memories from a story. Analyze the following story scene and extract a detailed summary as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Concise scene title (3-5 words)\",\n  \"content\": \"Detailed summary of key plot points and character memories, beat-by-beat in narrative prose...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, create a beat-by-beat summary in narrative prose. Capture all key plot points that advance the story and character memories that leave a lasting impression, ensuring nothing essential is omitted. This summary will go in a vectorized database, so include: \n\n- Story beats, events, actions and consequences, turning points, and outcomes\n- Key character interactions, character developments, significant dialogue, revelations, emotional impact, and relationships\n- Outcomes and anything else important for future interactions between the user and the world\nCapture ALL nuance without repeating verbatim. Do not simply list events; synthesize them into a coherent narrative block. This summary must be comprehensive enough to serve as a standalone record of the story so far, even if the original text is lost. Use at least 300 words. Avoid redundancy.\n\nFor the keywords field, provide 15-30 specific and descriptive keywords that capture the scene's core elements. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\n\nReturn ONLY the JSON, no other text.`,\n            'STMemoryBooks_Prompt_aelemar'\n        ),\n        comprehensive: translate(\n`Analyze the following roleplay scene in the context of previous summaries provided (if available) and return a comprehensive synopsis as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short, descriptive scene title (3-6 words)\",\n  \"content\": \"Long detailed synopsis with markdown structure...\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nFor the content field, create a beat-by-beat summary of the scene that *replaces reading the full scene* while preserving all plot-relevant nuance and reads like a clean, structured scene log  concise yet complete. This summary needs to be token-efficient: exercise judgment as to whether or not an interaction is flavor-only or truly affects the plot. Flavor scenes (interaction detail that does not advance plot) may be captured through key exchanges and should be skipped when recording story beats. \n\nWrite in **past tense**, **third-person**, and exclude all [OOC] or meta discussion.  \nUse concrete nouns (e.g., rice cooker > appliance).  \nOnly use adjectives/adverbs when they materially affect tone, emotion, or characterization.  \nFocus on **cause  intention  reaction  consequence** chains for clarity and compression.\n\n# [Scene Title]\n**Timeline**: (day/time)\n\n## Story Beats\n- Present all major actions, revelations, and emotional or magical shifts in order.\n- Capture clear causeeffect logic: what triggered what, and why it mattered.\n- Only include plot-affecting interactions and do not capture flavor-only beats.\n\n## Character Dynamics\n- Summarize how each characters **motives, emotions, and relationships** evolved.\n- Include subtext, tension, or silent implications.\n- Highlight key beats of conflict, vulnerability, trust, or power shifts.\n\n## Key Exchanges\n- Include only pivotal dialogue that defines tone, emotion, or change.\n- Attribute speakers by name; keep quotes short but exact.\n- BE SELECTIVE. Maximum of 8 quotes.\n\n## Outcome & Continuity\n- Detail resulting **decisions, emotional states, physical/magical effects, or narrative consequences**.\n- Include all elements that influence future continuity (knowledge, relationships, injuries, promises, etc.).\n- Note any unresolved threads or foreshadowed elements.\n\nWrite compactly but completely  every line should add new information or insight.  \nSynthesize redundant actions or dialogue into unified causeeffectemotion beats.\nFavor compression over coverage whenever the two conflict; omit anything that can be inferred from context or established characterization.\n\nFor the keywords field:\n\nGenerate **1530 standalone topical keywords** that function as retrieval tags, not micro-summaries. \nKeywords must be:\n- **Concrete and scene-specific** (locations, objects, proper nouns, unique actions, repeated motifs).\n- **One concept per keyword**  do NOT combine multiple ideas into one keyword.\n- **Useful for retrieval if the user later mentions that noun or action alone**, not only in a specific context.\n- Not {{char}}'s or {{user}}'s names.\n- **Not thematic, emotional, or abstract.** Stop-list: intimacy, vulnerability, trust, dominance, submission, power dynamics, boundaries, jealousy, aftercare, longing, consent, emotional connection.\n\nAvoid:\n- Overly specific compound keywords (David Tokyo marriage).\n- Narrative or plot-summary style keywords (art dealer date fail).\n- Keywords that contain multiple facts or descriptors.\n- Keywords that only make sense when the whole scene is remembered.\n\nPrefer:\n- Proper nouns (e.g., \"Chinatown\", \"Ritz-Carlton bar\").\n- Specific physical objects (\"CPAP machine\", \"chocolate chip cookies\").\n- Distinctive actions (\"cookie baking\", \"piano apology\").\n- Unique phrases or identifiers from the scene used by characters (\"pack for forever\", \"dick-measuring contest\").\n\nYour goal: **keywords should fire when the noun/action is mentioned alone**, not only when paired with a specific person or backstory.\n\nReturn ONLY the JSON  no additional text.`,\n            'STMemoryBooks_Prompt_comprehensive'\n        )\n    };\n}\n\n/**\n * Localized default prompt\n */\nexport function getDefaultPrompt() {\n    return translate(\n`Analyze the following chat scene and return a memory as JSON.\n\nYou must respond with ONLY valid JSON in this exact format:\n{\n  \"title\": \"Short scene title (1-3 words)\",\n  \"content\": \"Concise memory focusing on key plot points, character development, and important interactions\",\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\n}\n\nReturn ONLY the JSON, no other text.`,\n        'STMemoryBooks_Prompt_default'\n    );\n}\n\n/**\n * Default fallback prompt for JSON output\n */\n/* DEFAULT_PROMPT now provided via getDefaultPrompt() */\n\n/**\n * Get preset prompt based on preset name (async, supports custom/user presets)\n * @param {string} presetName - Name of the preset\n * @returns {Promise<string>} The prompt text\n */\nexport async function getPresetPrompt(presetName) {\n    return await getCustomPresetPrompt(presetName);\n}\n\n/**\n * Get effective prompt from profile\n * Always uses the preset key: built-in or user-defined prompts must be selected as presets.\n * @param {Object} profile - Profile object\n * @returns {Promise<string>} The effective prompt to use\n */\nexport async function getEffectivePrompt(profile) {\n    if (!profile) {\n        return getDefaultPrompt();\n    }\n    if (profile.preset) {\n        return await getCustomPresetPrompt(profile.preset);\n    } else {\n        return getDefaultPrompt();\n    }\n}\n\n/**\n * Validate profile structure\n * @param {Object} profile - Profile to validate\n * @returns {boolean} Whether the profile is valid\n */\nexport function validateProfile(profile) {\n    if (!profile || typeof profile !== 'object') {\n        console.warn(`${MODULE_NAME}: Profile validation failed - not an object`);\n        return false;\n    }\n    \n    if (!profile.name || typeof profile.name !== 'string') {\n        console.warn(`${MODULE_NAME}: Profile validation failed - invalid name`);\n        return false;\n    }\n    \n    // Connection is optional but if present should be an object\n    if (profile.connection && typeof profile.connection !== 'object') {\n        console.warn(`${MODULE_NAME}: Profile validation failed - invalid connection`);\n        return false;\n    }\n    \n    return true;\n}\n\n/**\n * Deep clone an object (simplified lodash.cloneDeep alternative)\n * @param {any} obj - Object to clone\n * @returns {any} Deep cloned object\n */\nexport function deepClone(obj) {\n    if (obj === null || typeof obj !== 'object') {\n        return obj;\n    }\n    \n    if (obj instanceof Date) {\n        return new Date(obj.getTime());\n    }\n    \n    if (Array.isArray(obj)) {\n        return obj.map(item => deepClone(item));\n    }\n    \n    const cloned = {};\n    for (const key in obj) {\n        if (obj.hasOwnProperty(key)) {\n            cloned[key] = deepClone(obj[key]);\n        }\n    }\n    \n    return cloned;\n}\n\n/**\n * Get all available preset names\n * @returns {string[]} Array of preset names\n */\nexport function getPresetNames() {\n    return ['summary', 'summarize', 'synopsis', 'sumup', 'minimal', 'northgate', 'aelemar', 'comprehensive'];\n}\n\n/**\n * Check if a preset name is valid\n * @param {string} presetName - Preset name to check\n * @returns {boolean} Whether the preset exists\n */\nexport function isValidPreset(presetName) {\n    const builtIns = new Set(['summary', 'summarize', 'synopsis', 'sumup', 'minimal', 'northgate', 'aelemar', 'comprehensive']);\n    return builtIns.has(presetName);\n}\n\n/**\n * Generate a safe profile name from user input\n * @param {string} input - User input\n * @param {string[]} existingNames - Array of existing profile names\n * @returns {string} Safe, unique profile name\n */\nexport function generateSafeProfileName(input, existingNames = []) {\n    if (!input || typeof input !== 'string') {\n        input = 'New Profile';\n    }\n    \n    // Clean the input\n    let safeName = input.trim().replace(/[<>:\"/\\\\|?*]/g, '');\n    if (!safeName) {\n        safeName = 'New Profile';\n    }\n    \n    // Ensure uniqueness\n    let finalName = safeName;\n    let counter = 1;\n    \n    while (existingNames.includes(finalName)) {\n        finalName = `${safeName} (${counter})`;\n        counter++;\n    }\n    \n    return finalName;\n}\n\n/**\n * Parse temperature value from string input\n * @param {string|number} input - Temperature input\n * @returns {number|null} Parsed temperature or null if invalid\n */\nexport function parseTemperature(input) {\n    if (typeof input === 'number') {\n        return isNaN(input) ? null : Math.max(0, Math.min(2, input));\n    }\n    \n    if (typeof input === 'string') {\n        const parsed = parseFloat(input);\n        return isNaN(parsed) ? null : Math.max(0, Math.min(2, parsed));\n    }\n    \n    return null;\n}\n\n/**\n * Format preset name for display\n * @param {string} presetName - Internal preset name\n * @returns {string} Display-friendly name\n */\nexport function formatPresetDisplayName(presetName) {\n    const def = DISPLAY_NAME_DEFAULTS[presetName];\n    const key = DISPLAY_NAME_I18N_KEYS[presetName];\n    return (def && key && translate(def, key)) || presetName;\n}\n\n/**\n * Creates a clean, validated profile object from raw data.\n * This centralizes profile creation logic from all parts of the extension.\n * @param {Object} data - Raw data for the profile.\n * @param {string} data.name - The desired profile name.\n * @param {string} [data.api='openai'] - The API provider.\n * @param {string} [data.model=''] - The model identifier.\n * @param {number|string} [data.temperature=0.7] - The temperature setting.\n * @param {string} [data.prompt=''] - The custom prompt.\n * @param {string} [data.preset=''] - The selected preset.\n * @param {string} [data.titleFormat=''] - The title format for lorebook entries.\n * @param {string} [data.constVectMode='link'] - The constant/vectorized mode.\n * @param {number} [data.position=0] - The lorebook entry position.\n * @param {string} [data.orderMode='auto'] - The ordering mode.\n * @param {number} [data.orderValue=100] - The manual order value.\n * @param {number} [data.reverseStart=9999] - Reverse ordering start (100-9999).\n * @param {boolean} [data.preventRecursion=true] - The prevent recursion flag.\n * @param {boolean} [data.delayUntilRecursion=true] - The delay until recursion flag.\n * @returns {Object} A structured and validated profile object.\n */\nexport function createProfileObject(data = {}) {\n    let temperature = parseTemperature(data.temperature);\n    if (temperature === null) {\n        temperature = 0.7;\n    }\n\n    const profile = {\n        name: (data.name || 'New Profile').trim(),\n        connection: {\n            api: data.api || 'openai',\n            temperature: temperature,\n        },\n        prompt: (data.prompt || '').trim(),\n        preset: data.preset || '',\n        constVectMode: data.constVectMode || 'link',\n        position: data.position !== undefined ? Number(data.position) : 0,\n        orderMode: data.orderMode || 'auto',\n        orderValue: data.orderValue !== undefined ? Number(data.orderValue) : 100,\n        reverseStart: (() => {\n            const rawInput = data.reverseStart;\n            if (rawInput === '' || rawInput === null || rawInput === undefined) return 9999;\n            const parsed = Number(rawInput);\n            const n = Number.isFinite(parsed) ? Math.trunc(parsed) : 9999;\n            return clampInt(n, 100, 9999);\n        })(),\n        preventRecursion: data.preventRecursion !== undefined ? data.preventRecursion : true,\n        delayUntilRecursion: data.delayUntilRecursion !== undefined ? data.delayUntilRecursion : true,\n    };\n\n    // Preserve builtin marker for the STMB-required \"Current SillyTavern Settings\" profile.\n    if (data.isBuiltinCurrentST) {\n        profile.isBuiltinCurrentST = true;\n    }\n\n    // Set titleFormat if explicitly provided, or if it's not a dynamic profile\n    if (data.titleFormat || !data.isDynamicProfile) {\n        profile.titleFormat = data.titleFormat || '[000] - {{title}}';\n    }\n\n    const model = (data.model || '').trim();\n    if (model) {\n        profile.connection.model = model;\n    }\n\n    // Add endpoint and apiKey for full-manual configuration\n    const endpoint = (data.endpoint || '').trim();\n    if (endpoint) {\n        profile.connection.endpoint = endpoint;\n    }\n\n    const apiKey = (data.apiKey || '').trim();\n    if (apiKey) {\n        profile.connection.apiKey = apiKey;\n    }\n\n    // A profile should have a preset OR a custom prompt. The custom prompt takes precedence.\n    if (profile.prompt && profile.preset) {\n        profile.preset = '';\n    }\n    \n    // If there's no custom prompt and no preset specified, default to the 'summary' preset.\n    if (!profile.prompt && !profile.preset) {\n        profile.preset = 'summary'; \n    }\n\n    // Carry outletName only when using Outlet position (7)\n    try {\n        if (Number(profile.position) === 7 && typeof data.outletName === 'string') {\n            const name = data.outletName.trim();\n            if (name) {\n                profile.outletName = name;\n            }\n        }\n    } catch {}\n\n    return profile;\n}\n",
    "import { chat, name1, name2 } from '../../../../script.js';\nimport { getContext } from '../../../extensions.js';\nimport { estimateTokens } from './utils.js';\nimport { t as __st_t_tag, translate } from '../../../i18n.js';\n\n/**\n * Compile chat messages between scene markers into structured format\n * @param {Object} sceneRequest - Scene compilation request\n * @param {number} sceneRequest.sceneStart - Start message ID\n * @param {number} sceneRequest.sceneEnd - End message ID  \n * @param {string} sceneRequest.chatId - Current chat ID\n * @param {string} sceneRequest.characterName - Character name\n * @returns {Object} Compiled scene data\n */\nexport function compileScene(sceneRequest) {\n    const { sceneStart, sceneEnd, chatId, characterName } = sceneRequest;\n    \n    // Validate input parameters\n    if (sceneStart == null || sceneEnd == null) {\n        throw new Error(translate('Scene markers are required', 'chatcompile.errors.sceneMarkersRequired'));\n    }\n\n    if (sceneStart > sceneEnd) {\n        throw new Error(translate('Start message cannot be greater than end message', 'chatcompile.errors.startGreaterThanEnd'));\n    }\n\n    if (sceneStart < 0 || sceneEnd >= chat.length) {\n        throw new Error(__st_t_tag`Message IDs out of bounds: ${sceneStart}-${sceneEnd} (0-${chat.length - 1})`);\n    }\n    \n    // Extract and format messages in range\n    const sceneMessages = [];\n    let hiddenMessageCount = 0;\n    let skippedMessageCount = 0;\n    \n    for (let i = sceneStart; i <= sceneEnd; i++) {\n        const message = chat[i];\n        \n        // Handle missing messages gracefully\n        if (!message) {\n            skippedMessageCount++;\n            continue;\n        }\n        \n        // Skip hidden messages - marked with is_system: true\n        if (message.is_system) {\n            hiddenMessageCount++;\n            continue;\n        }\n        \n        // Create clean message object following JSONL structure\n        const compiledMessage = {\n            id: i,\n            name: cleanSpeakerName(message.name),\n            mes: cleanMessageContent(message.mes, message.is_user),\n            send_date: message.send_date || new Date().toISOString()\n        };\n        \n        // Add optional user indicator if available\n        if (message.is_user !== undefined) {\n            compiledMessage.is_user = message.is_user;\n        }\n        \n        sceneMessages.push(compiledMessage);\n    }\n    \n    // Create metadata\n    const metadata = {\n        sceneStart,\n        sceneEnd,\n        chatId: chatId || 'unknown',\n        characterName: characterName || name2 || translate('Unknown', 'common.unknown'),\n        messageCount: sceneMessages.length,\n        totalRequestedRange: sceneEnd - sceneStart + 1,\n        hiddenMessagesSkipped: hiddenMessageCount,\n        messagesSkipped: skippedMessageCount,\n        compiledAt: new Date().toISOString(),\n        totalChatLength: chat.length,\n        userName: name1 || translate('User', 'chatcompile.defaults.user')\n    };\n    \n    const compiledScene = {\n        metadata,\n        messages: sceneMessages\n    };\n    \n    // Validate that we have at least some visible messages\n    if (sceneMessages.length === 0) {\n        throw new Error(__st_t_tag`No visible messages in range ${sceneStart}-${sceneEnd}`);\n    }\n    \n    return compiledScene;\n}\n\n/**\n * Create scene request object from current context\n * @param {number} sceneStart - Start message ID\n * @param {number} sceneEnd - End message ID\n * @returns {Object} Scene request object\n */\nexport function createSceneRequest(sceneStart, sceneEnd) {\n    const context = getContext();\n    \n    const sceneRequest = {\n        sceneStart,\n        sceneEnd,\n        chatId: context.chatId || 'unknown',\n        characterName: context.name2 || name2 || translate('Unknown', 'common.unknown')\n    };\n    \n    return sceneRequest;\n}\n\n/**\n * Estimate token count for compiled scene\n * @param {Object} compiledScene - Compiled scene data\n * @returns {number} Estimated token count\n */\nexport async function estimateTokenCount(compiledScene) {\n    // Use the same canonical estimator (char/4) over the readable scene text\n    // and do not include output tokens for UI stats.\n    const text = toReadableText(compiledScene);\n    const { input } = await estimateTokens(text, { estimatedOutput: 0 });\n    return input;\n}\n\n/**\n * Get scene statistics for display purposes\n * @param {Object} compiledScene - Compiled scene data\n * @returns {Object} Scene statistics\n */\nexport async function getSceneStats(compiledScene) {\n    const { metadata, messages } = compiledScene;\n    \n    // Count speakers\n    const speakers = new Set();\n    let totalMessageLength = 0;\n    let userMessages = 0;\n    let characterMessages = 0;\n    \n    messages.forEach(message => {\n        speakers.add(message.name);\n        totalMessageLength += (message.mes || '').length;\n        \n        if (message.is_user) {\n            userMessages++;\n        } else {\n            characterMessages++;\n        }\n    });\n    \n    return {\n        messageCount: messages.length,\n        speakerCount: speakers.size,\n        speakers: Array.from(speakers),\n        totalCharacters: totalMessageLength,\n        estimatedTokens: await estimateTokenCount(compiledScene),\n        userMessages,\n        characterMessages,\n        timeSpan: {\n            start: messages[0]?.send_date,\n            end: messages[messages.length - 1]?.send_date\n        }\n    };\n}\n\n/**\n * Validate compiled scene data\n * @param {Object} compiledScene - Compiled scene data\n * @returns {Object} Validation result\n */\nexport function validateCompiledScene(compiledScene) {\n    const errors = [];\n    const warnings = [];\n    \n    // Check basic structure\n    if (!compiledScene.metadata) {\n        errors.push(translate('Missing metadata', 'chatcompile.validation.errors.missingMetadata'));\n    }\n    \n    if (!compiledScene.messages || !Array.isArray(compiledScene.messages)) {\n        errors.push(translate('Invalid messages array', 'chatcompile.validation.errors.invalidMessagesArray'));\n    }\n    \n    if (compiledScene.messages && compiledScene.messages.length === 0) {\n        warnings.push(translate('No messages', 'chatcompile.validation.warnings.noMessages'));\n    }\n    \n    // Check message structure\n    if (compiledScene.messages) {\n        compiledScene.messages.forEach((message, index) => {\n            if (!message.id && message.id !== 0) {\n                warnings.push(__st_t_tag`Message at index ${index} missing id`);\n            }\n            \n            if (!message.name) {\n                warnings.push(__st_t_tag`Message at index ${index} missing name`);\n            }\n            \n            if (!message.mes && message.mes !== '') {\n                warnings.push(__st_t_tag`Message at index ${index} missing content`);\n            }\n        });\n    }\n    \n    // Check for large scenes\n    if (compiledScene.messages && compiledScene.messages.length > 100) {\n        warnings.push(translate('Very large scene', 'chatcompile.validation.warnings.veryLargeScene'));\n    }\n    \n    const isValid = errors.length === 0;\n    \n    return {\n        valid: isValid,\n        errors,\n        warnings\n    };\n}\n\n/**\n * Convert compiled scene to a readable text format for debugging\n * @param {Object} compiledScene - Compiled scene data\n * @returns {string} Human-readable scene text\n */\nexport function toReadableText(compiledScene) {\n    const { metadata, messages } = compiledScene;\n    \n    let output = [];\n    output.push(translate('=== SCENE METADATA ===', 'chatcompile.readable.headerMetadata'));\n    output.push(__st_t_tag`Range: ${metadata.sceneStart}-${metadata.sceneEnd}`);\n    output.push(__st_t_tag`Chat: ${metadata.chatId}`);\n    output.push(__st_t_tag`Character: ${metadata.characterName}`);\n    output.push(__st_t_tag`Compiled: ${metadata.messageCount}`);\n    output.push(__st_t_tag`Compiled at: ${metadata.compiledAt}`);\n    output.push('');\n    output.push(translate('=== SCENE MESSAGES ===', 'chatcompile.readable.headerMessages'));\n    messages.forEach(message => {\n        output.push(__st_t_tag`[${message.id}] ${message.name}: ${message.mes}`);\n    });\n    \n    return output.join('\\n');\n}\n\n/**\n * Clean speaker name for consistency\n * @private\n */\nfunction cleanSpeakerName(name) {\n    if (!name) return translate('Unknown', 'common.unknown');\n    return name.trim() || translate('Unknown', 'common.unknown');\n}\n\n/**\n * Clean message content\n * @private\n */\nfunction cleanMessageContent(content, isUser = false) {\n    if (!content) return '';\n    try {\n        // Normalize line endings for consistent behavior; do not run Regex engine here.\n        const normalized = String(content).replace(/\\r\\n/g, '\\n');\n        return normalized.trim();\n    } catch (e) {\n        return String(content).trim();\n    }\n}\n",
    "if (typeof module === \"object\" && typeof module.exports === \"object\") module.exports = Lexer;\n\nLexer.defunct = function (chr) {\n    throw new Error(\"Unexpected character at index \" + (this.index - 1) + \": \" + chr);\n};\n\nfunction Lexer(defunct) {\n    if (typeof defunct !== \"function\") defunct = Lexer.defunct;\n\n    var tokens = [];\n    var rules = [];\n    var remove = 0;\n    this.state = 0;\n    this.index = 0;\n    this.input = \"\";\n\n    this.addRule = function (pattern, action, start) {\n        var global = pattern.global;\n\n        if (!global) {\n            var flags = \"g\";\n            if (pattern.multiline) flags += \"m\";\n            if (pattern.ignoreCase) flags += \"i\";\n            pattern = new RegExp(pattern.source, flags);\n        }\n\n        if (Object.prototype.toString.call(start) !== \"[object Array]\") start = [0];\n\n        rules.push({\n            pattern: pattern,\n            global: global,\n            action: action,\n            start: start\n        });\n\n        return this;\n    };\n\n    this.setInput = function (input) {\n        remove = 0;\n        this.state = 0;\n        this.index = 0;\n        tokens.length = 0;\n        this.input = input;\n        return this;\n    };\n\n    this.lex = function () {\n        if (tokens.length) return tokens.shift();\n\n        this.reject = true;\n\n        while (this.index <= this.input.length) {\n            var matches = scan.call(this).splice(remove);\n            var index = this.index;\n\n            while (matches.length) {\n                if (this.reject) {\n                    var match = matches.shift();\n                    var result = match.result;\n                    var length = match.length;\n                    this.index += length;\n                    this.reject = false;\n                    remove++;\n\n                    var token = match.action.apply(this, result);\n                    if (this.reject) this.index = result.index;\n                    else if (typeof token !== \"undefined\") {\n                        switch (Object.prototype.toString.call(token)) {\n                        case \"[object Array]\":\n                            tokens = token.slice(1);\n                            token = token[0];\n                        default:\n                            if (length) remove = 0;\n                            return token;\n                        }\n                    }\n                } else break;\n            }\n\n            var input = this.input;\n\n            if (index < input.length) {\n                if (this.reject) {\n                    remove = 0;\n                    var token = defunct.call(this, input.charAt(this.index++));\n                    if (typeof token !== \"undefined\") {\n                        if (Object.prototype.toString.call(token) === \"[object Array]\") {\n                            tokens = token.slice(1);\n                            return token[0];\n                        } else return token;\n                    }\n                } else {\n                    if (this.index !== index) remove = 0;\n                    this.reject = true;\n                }\n            } else if (matches.length)\n                this.reject = true;\n            else break;\n        }\n    };\n\n    function scan() {\n        var matches = [];\n        var index = 0;\n\n        var state = this.state;\n        var lastIndex = this.index;\n        var input = this.input;\n\n        for (var i = 0, length = rules.length; i < length; i++) {\n            var rule = rules[i];\n            var start = rule.start;\n            var states = start.length;\n\n            if ((!states || start.indexOf(state) >= 0) ||\n                (state % 2 && states === 1 && !start[0])) {\n                var pattern = rule.pattern;\n                pattern.lastIndex = lastIndex;\n                var result = pattern.exec(input);\n\n                if (result && result.index === lastIndex) {\n                    var j = matches.push({\n                        result: result,\n                        action: rule.action,\n                        length: result[0].length\n                    });\n\n                    if (rule.global) index = j;\n\n                    while (--j > index) {\n                        var k = j - 1;\n\n                        if (matches[j].length > matches[k].length) {\n                            var temple = matches[j];\n                            matches[j] = matches[k];\n                            matches[k] = temple;\n                        }\n                    }\n                }\n            }\n        }\n\n        return matches;\n    }\n}\n",
    "/*! http://mths.be/fromcodepoint v0.2.1 by @mathias */\nif (!String.fromCodePoint) {\n\t(function() {\n\t\tvar defineProperty = (function() {\n\t\t\t// IE 8 only supports `Object.defineProperty` on DOM elements\n\t\t\ttry {\n\t\t\t\tvar object = {};\n\t\t\t\tvar $defineProperty = Object.defineProperty;\n\t\t\t\tvar result = $defineProperty(object, object, object) && $defineProperty;\n\t\t\t} catch(error) {}\n\t\t\treturn result;\n\t\t}());\n\t\tvar stringFromCharCode = String.fromCharCode;\n\t\tvar floor = Math.floor;\n\t\tvar fromCodePoint = function(_) {\n\t\t\tvar MAX_SIZE = 0x4000;\n\t\t\tvar codeUnits = [];\n\t\t\tvar highSurrogate;\n\t\t\tvar lowSurrogate;\n\t\t\tvar index = -1;\n\t\t\tvar length = arguments.length;\n\t\t\tif (!length) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\tvar result = '';\n\t\t\twhile (++index < length) {\n\t\t\t\tvar codePoint = Number(arguments[index]);\n\t\t\t\tif (\n\t\t\t\t\t!isFinite(codePoint) || // `NaN`, `+Infinity`, or `-Infinity`\n\t\t\t\t\tcodePoint < 0 || // not a valid Unicode code point\n\t\t\t\t\tcodePoint > 0x10FFFF || // not a valid Unicode code point\n\t\t\t\t\tfloor(codePoint) != codePoint // not an integer\n\t\t\t\t) {\n\t\t\t\t\tthrow RangeError('Invalid code point: ' + codePoint);\n\t\t\t\t}\n\t\t\t\tif (codePoint <= 0xFFFF) { // BMP code point\n\t\t\t\t\tcodeUnits.push(codePoint);\n\t\t\t\t} else { // Astral code point; split in surrogate halves\n\t\t\t\t\t// http://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae\n\t\t\t\t\tcodePoint -= 0x10000;\n\t\t\t\t\thighSurrogate = (codePoint >> 10) + 0xD800;\n\t\t\t\t\tlowSurrogate = (codePoint % 0x400) + 0xDC00;\n\t\t\t\t\tcodeUnits.push(highSurrogate, lowSurrogate);\n\t\t\t\t}\n\t\t\t\tif (index + 1 == length || codeUnits.length > MAX_SIZE) {\n\t\t\t\t\tresult += stringFromCharCode.apply(null, codeUnits);\n\t\t\t\t\tcodeUnits.length = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t\tif (defineProperty) {\n\t\t\tdefineProperty(String, 'fromCodePoint', {\n\t\t\t\t'value': fromCodePoint,\n\t\t\t\t'configurable': true,\n\t\t\t\t'writable': true\n\t\t\t});\n\t\t} else {\n\t\t\tString.fromCodePoint = fromCodePoint;\n\t\t}\n\t}());\n}\n",
    "\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nrequire(\"string.fromcodepoint\");\n\n/**\n * \\\\ - matches the backslash which indicates the beginning of an escape sequence\n * (\n *   u\\{([0-9A-Fa-f]+)\\} - first alternative; matches the variable-length hexadecimal escape sequence (\\u{ABCD0})\n * |\n *   u([0-9A-Fa-f]{4}) - second alternative; matches the 4-digit hexadecimal escape sequence (\\uABCD)\n * |\n *   x([0-9A-Fa-f]{2}) - third alternative; matches the 2-digit hexadecimal escape sequence (\\xA5)\n * |\n *   ([1-7][0-7]{0,2}|[0-7]{2,3}) - fourth alternative; matches the up-to-3-digit octal escape sequence (\\5 or \\512)\n * |\n *   (['\"tbrnfv0\\\\]) - fifth alternative; matches the special escape characters (\\t, \\n and so on)\n * |\n *   \\U([0-9A-Fa-f]+) - sixth alternative; matches the 8-digit hexadecimal escape sequence used by python (\\U0001F3B5)\n * )\n */\nvar jsEscapeRegex = /\\\\(u\\{([0-9A-Fa-f]+)\\}|u([0-9A-Fa-f]{4})|x([0-9A-Fa-f]{2})|([1-7][0-7]{0,2}|[0-7]{2,3})|(['\"tbrnfv0\\\\]))|\\\\U([0-9A-Fa-f]{8})/g;\nvar usualEscapeSequences = {\n  '0': '\\0',\n  'b': '\\b',\n  'f': '\\f',\n  'n': '\\n',\n  'r': '\\r',\n  't': '\\t',\n  'v': '\\v',\n  '\\'': '\\'',\n  '\"': '\"',\n  '\\\\': '\\\\'\n};\n\nvar fromHex = function fromHex(str) {\n  return String.fromCodePoint(parseInt(str, 16));\n};\n\nvar fromOct = function fromOct(str) {\n  return String.fromCodePoint(parseInt(str, 8));\n};\n\nvar _default = function _default(string) {\n  return string.replace(jsEscapeRegex, function (_, __, varHex, longHex, shortHex, octal, specialCharacter, python) {\n    if (varHex !== undefined) {\n      return fromHex(varHex);\n    } else if (longHex !== undefined) {\n      return fromHex(longHex);\n    } else if (shortHex !== undefined) {\n      return fromHex(shortHex);\n    } else if (octal !== undefined) {\n      return fromOct(octal);\n    } else if (python !== undefined) {\n      return fromHex(python);\n    } else {\n      return usualEscapeSequences[specialCharacter];\n    }\n  });\n};\n\nexports.default = _default;\nmodule.exports = exports.default;",
    "/*! https://mths.be/utf8js v3.0.0 by @mathias */\n;(function(root) {\n\n\tvar stringFromCharCode = String.fromCharCode;\n\n\t// Taken from https://mths.be/punycode\n\tfunction ucs2decode(string) {\n\t\tvar output = [];\n\t\tvar counter = 0;\n\t\tvar length = string.length;\n\t\tvar value;\n\t\tvar extra;\n\t\twhile (counter < length) {\n\t\t\tvalue = string.charCodeAt(counter++);\n\t\t\tif (value >= 0xD800 && value <= 0xDBFF && counter < length) {\n\t\t\t\t// high surrogate, and there is a next character\n\t\t\t\textra = string.charCodeAt(counter++);\n\t\t\t\tif ((extra & 0xFC00) == 0xDC00) { // low surrogate\n\t\t\t\t\toutput.push(((value & 0x3FF) << 10) + (extra & 0x3FF) + 0x10000);\n\t\t\t\t} else {\n\t\t\t\t\t// unmatched surrogate; only append this code unit, in case the next\n\t\t\t\t\t// code unit is the high surrogate of a surrogate pair\n\t\t\t\t\toutput.push(value);\n\t\t\t\t\tcounter--;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\toutput.push(value);\n\t\t\t}\n\t\t}\n\t\treturn output;\n\t}\n\n\t// Taken from https://mths.be/punycode\n\tfunction ucs2encode(array) {\n\t\tvar length = array.length;\n\t\tvar index = -1;\n\t\tvar value;\n\t\tvar output = '';\n\t\twhile (++index < length) {\n\t\t\tvalue = array[index];\n\t\t\tif (value > 0xFFFF) {\n\t\t\t\tvalue -= 0x10000;\n\t\t\t\toutput += stringFromCharCode(value >>> 10 & 0x3FF | 0xD800);\n\t\t\t\tvalue = 0xDC00 | value & 0x3FF;\n\t\t\t}\n\t\t\toutput += stringFromCharCode(value);\n\t\t}\n\t\treturn output;\n\t}\n\n\tfunction checkScalarValue(codePoint) {\n\t\tif (codePoint >= 0xD800 && codePoint <= 0xDFFF) {\n\t\t\tthrow Error(\n\t\t\t\t'Lone surrogate U+' + codePoint.toString(16).toUpperCase() +\n\t\t\t\t' is not a scalar value'\n\t\t\t);\n\t\t}\n\t}\n\t/*--------------------------------------------------------------------------*/\n\n\tfunction createByte(codePoint, shift) {\n\t\treturn stringFromCharCode(((codePoint >> shift) & 0x3F) | 0x80);\n\t}\n\n\tfunction encodeCodePoint(codePoint) {\n\t\tif ((codePoint & 0xFFFFFF80) == 0) { // 1-byte sequence\n\t\t\treturn stringFromCharCode(codePoint);\n\t\t}\n\t\tvar symbol = '';\n\t\tif ((codePoint & 0xFFFFF800) == 0) { // 2-byte sequence\n\t\t\tsymbol = stringFromCharCode(((codePoint >> 6) & 0x1F) | 0xC0);\n\t\t}\n\t\telse if ((codePoint & 0xFFFF0000) == 0) { // 3-byte sequence\n\t\t\tcheckScalarValue(codePoint);\n\t\t\tsymbol = stringFromCharCode(((codePoint >> 12) & 0x0F) | 0xE0);\n\t\t\tsymbol += createByte(codePoint, 6);\n\t\t}\n\t\telse if ((codePoint & 0xFFE00000) == 0) { // 4-byte sequence\n\t\t\tsymbol = stringFromCharCode(((codePoint >> 18) & 0x07) | 0xF0);\n\t\t\tsymbol += createByte(codePoint, 12);\n\t\t\tsymbol += createByte(codePoint, 6);\n\t\t}\n\t\tsymbol += stringFromCharCode((codePoint & 0x3F) | 0x80);\n\t\treturn symbol;\n\t}\n\n\tfunction utf8encode(string) {\n\t\tvar codePoints = ucs2decode(string);\n\t\tvar length = codePoints.length;\n\t\tvar index = -1;\n\t\tvar codePoint;\n\t\tvar byteString = '';\n\t\twhile (++index < length) {\n\t\t\tcodePoint = codePoints[index];\n\t\t\tbyteString += encodeCodePoint(codePoint);\n\t\t}\n\t\treturn byteString;\n\t}\n\n\t/*--------------------------------------------------------------------------*/\n\n\tfunction readContinuationByte() {\n\t\tif (byteIndex >= byteCount) {\n\t\t\tthrow Error('Invalid byte index');\n\t\t}\n\n\t\tvar continuationByte = byteArray[byteIndex] & 0xFF;\n\t\tbyteIndex++;\n\n\t\tif ((continuationByte & 0xC0) == 0x80) {\n\t\t\treturn continuationByte & 0x3F;\n\t\t}\n\n\t\t// If we end up here, its not a continuation byte\n\t\tthrow Error('Invalid continuation byte');\n\t}\n\n\tfunction decodeSymbol() {\n\t\tvar byte1;\n\t\tvar byte2;\n\t\tvar byte3;\n\t\tvar byte4;\n\t\tvar codePoint;\n\n\t\tif (byteIndex > byteCount) {\n\t\t\tthrow Error('Invalid byte index');\n\t\t}\n\n\t\tif (byteIndex == byteCount) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Read first byte\n\t\tbyte1 = byteArray[byteIndex] & 0xFF;\n\t\tbyteIndex++;\n\n\t\t// 1-byte sequence (no continuation bytes)\n\t\tif ((byte1 & 0x80) == 0) {\n\t\t\treturn byte1;\n\t\t}\n\n\t\t// 2-byte sequence\n\t\tif ((byte1 & 0xE0) == 0xC0) {\n\t\t\tbyte2 = readContinuationByte();\n\t\t\tcodePoint = ((byte1 & 0x1F) << 6) | byte2;\n\t\t\tif (codePoint >= 0x80) {\n\t\t\t\treturn codePoint;\n\t\t\t} else {\n\t\t\t\tthrow Error('Invalid continuation byte');\n\t\t\t}\n\t\t}\n\n\t\t// 3-byte sequence (may include unpaired surrogates)\n\t\tif ((byte1 & 0xF0) == 0xE0) {\n\t\t\tbyte2 = readContinuationByte();\n\t\t\tbyte3 = readContinuationByte();\n\t\t\tcodePoint = ((byte1 & 0x0F) << 12) | (byte2 << 6) | byte3;\n\t\t\tif (codePoint >= 0x0800) {\n\t\t\t\tcheckScalarValue(codePoint);\n\t\t\t\treturn codePoint;\n\t\t\t} else {\n\t\t\t\tthrow Error('Invalid continuation byte');\n\t\t\t}\n\t\t}\n\n\t\t// 4-byte sequence\n\t\tif ((byte1 & 0xF8) == 0xF0) {\n\t\t\tbyte2 = readContinuationByte();\n\t\t\tbyte3 = readContinuationByte();\n\t\t\tbyte4 = readContinuationByte();\n\t\t\tcodePoint = ((byte1 & 0x07) << 0x12) | (byte2 << 0x0C) |\n\t\t\t\t(byte3 << 0x06) | byte4;\n\t\t\tif (codePoint >= 0x010000 && codePoint <= 0x10FFFF) {\n\t\t\t\treturn codePoint;\n\t\t\t}\n\t\t}\n\n\t\tthrow Error('Invalid UTF-8 detected');\n\t}\n\n\tvar byteArray;\n\tvar byteCount;\n\tvar byteIndex;\n\tfunction utf8decode(byteString) {\n\t\tbyteArray = ucs2decode(byteString);\n\t\tbyteCount = byteArray.length;\n\t\tbyteIndex = 0;\n\t\tvar codePoints = [];\n\t\tvar tmp;\n\t\twhile ((tmp = decodeSymbol()) !== false) {\n\t\t\tcodePoints.push(tmp);\n\t\t}\n\t\treturn ucs2encode(codePoints);\n\t}\n\n\t/*--------------------------------------------------------------------------*/\n\n\troot.version = '3.0.0';\n\troot.encode = utf8encode;\n\troot.decode = utf8decode;\n\n}(typeof exports === 'undefined' ? this.utf8 = {} : exports));\n",
    "// < begin copyright > \n// Copyright Ryan Marcus 2018\n// \n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU Affero General Public License as\n// published by the Free Software Foundation, either version 3 of the\n// License, or (at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU Affero General Public License for more details.\n// \n// You should have received a copy of the GNU Affero General Public License\n// along with this program.  If not, see <https://www.gnu.org/licenses/>.\n// \n// < end copyright > \n \n\"use strict\";\n\nconst Lexer = require(\"lex\");\nconst unescapeJs = require(\"unescape-js\");\nconst utf8 = require(\"utf8\");\n\n// terminals\nconst LEX_KV = 0;\nconst LEX_KVLIST = 1;\nconst LEX_VLIST = 2;\nconst LEX_BOOLEAN = 3;\nconst LEX_COVALUE = 4;\nconst LEX_CVALUE = 5;\nconst LEX_FLOAT = 6;\nconst LEX_INT = 7;\nconst LEX_KEY = 8;\nconst LEX_LIST = 9;\nconst LEX_OBJ = 10;\nconst LEX_QUOTE = 11;\nconst LEX_RB = 12;\nconst LEX_RCB = 13;\nconst LEX_TOKEN = 14;\nconst LEX_VALUE = 15;\n\n// non-terminals\nconst LEX_COLON = -1;\nconst LEX_COMMA = -2;\nconst LEX_LCB = -3;\nconst LEX_LB = -4;\nconst LEX_DOT = -5;\n\n\nconst lexMap = {\n    \":\": {type: LEX_COLON},\n    \",\": {type: LEX_COMMA},\n    \"{\": {type: LEX_LCB},\n    \"}\": {type: LEX_RCB},\n    \"[\": {type: LEX_LB},\n    \"]\": {type: LEX_RB},\n    \".\": {type: LEX_DOT} // TODO: remove?\n};\n\nconst lexSpc = [\n    [/\\s*:\\s*/, LEX_COLON],\n    [/\\s*,\\s*/, LEX_COMMA],\n    [/\\s*{\\s*/, LEX_LCB],\n    [/\\s*}\\s*/, LEX_RCB],\n    [/\\s*\\[\\s*/, LEX_LB],\n    [/\\s*\\]\\s*/, LEX_RB],\n    [/\\s*\\.\\s*/, LEX_DOT] // TODO: remove?\n];\n\nfunction parseString(str) {\n    // unescape-js doesn't cover the \\/ case, but we will here.\n    str = str.replace(/\\\\\\//, '/');\n    return unescapeJs(str);\n}\n\n\nfunction getLexer(string) {\n    let lexer = new Lexer();\n\n    let col = 0;\n    let row = 0;\n    \n    lexer.addRule(/\"((?:\\\\.|[^\"])*?)($|\")/, (lexeme, txt) => {\n        col += lexeme.length;\n        return {type: LEX_QUOTE, value: parseString(txt), row, col, single: false};\n    });\n\n    lexer.addRule(/'((?:\\\\.|[^'])*?)($|'|(\",?[ \\t]*\\n))/, (lexeme, txt) => {\n        col += lexeme.length;\n        return {type: LEX_QUOTE, value: parseString(txt), row, col, single: true};\n    });\n\n    // floats with a dot\n    lexer.addRule(/[\\-0-9]*\\.[0-9]*([eE][\\+\\-]?)?[0-9]*(?:\\s*)/, lexeme => {\n        col += lexeme.length;\n        return {type: LEX_FLOAT, value: parseFloat(lexeme), row, col};\n    });\n\n    // floats without a dot but with e notation\n    lexer.addRule(/\\-?[0-9]+([eE][\\+\\-]?)[0-9]*(?:\\s*)/, lexeme => {\n        col += lexeme.length;\n        return {type: LEX_FLOAT, value: parseFloat(lexeme), row, col};\n    });\n    \n    lexer.addRule(/\\-?[0-9]+(?:\\s*)/, lexeme => {\n        col += lexeme.length;\n        return {type: LEX_INT, value: parseInt(lexeme), row, col};\n    });\n\n    lexSpc.forEach(item => {\n        lexer.addRule(item[0], lexeme => {\n            col += lexeme.length;\n            return {type: item[1], value: lexeme, row, col};\n        });\n    });\n\n    lexer.addRule(/\\s/, lexeme => {\n        // chomp whitespace...\n        if (lexeme == \"\\n\") {\n            col = 0;\n            row++;\n        } else {\n            col += lexeme.length;\n        }\n    });\n\n    \n    lexer.addRule(/\\S[ \\t]*/, lexeme => {\n        col += lexeme.length;\n        \n        let lt = LEX_TOKEN;\n        let val = lexeme;\n        \n        return {type: lt, value: val, row, col};\n    });\n    \n\n\n\n    lexer.setInput(string);\n\n    return lexer;\n}\n\n\n\nmodule.exports.lexString = lexString;\nfunction lexString(str, emit) {\n    let lex = getLexer(str);\n\n    let token = \"\";\n    while ((token = lex.lex())) {\n        emit(token);\n    }\n    \n}\n\nmodule.exports.getAllTokens = getAllTokens;\nfunction getAllTokens(str) {\n    let arr = [];\n    let emit = function (i) {\n        arr.push(i);\n    };\n\n    lexString(str, emit);\n\n    return arr;\n}\n\n\n\n",
    "// < begin copyright > \n// Copyright Ryan Marcus 2018\n// \n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU Affero General Public License as\n// published by the Free Software Foundation, either version 3 of the\n// License, or (at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU Affero General Public License for more details.\n// \n// You should have received a copy of the GNU Affero General Public License\n// along with this program.  If not, see <https://www.gnu.org/licenses/>.\n// \n// < end copyright > \n \n\"use strict\";\n\nlet lexer = require(\"./lexer\");\n\n// terminals\nconst LEX_KV = 0;\nconst LEX_KVLIST = 1;\nconst LEX_VLIST = 2;\nconst LEX_BOOLEAN = 3;\nconst LEX_COVALUE = 4;\nconst LEX_CVALUE = 5;\nconst LEX_FLOAT = 6;\nconst LEX_INT = 7;\nconst LEX_KEY = 8;\nconst LEX_LIST = 9;\nconst LEX_OBJ = 10;\nconst LEX_QUOTE = 11;\nconst LEX_RB = 12;\nconst LEX_RCB = 13;\nconst LEX_TOKEN = 14;\nconst LEX_VALUE = 15;\n\n// non-terminals\nconst LEX_COLON = -1;\nconst LEX_COMMA = -2;\nconst LEX_LCB = -3;\nconst LEX_LB = -4;\nconst LEX_DOT = -5;\n\nfunction extendArray(arr) {\n    if (arr.peek == null) {\n        Object.defineProperty(arr, 'peek', {\n            enumerable: false,\n            value: function() {\n                return this[this.length - 1];\n            }\n        });\n    }\n    if (arr.last == null) {\n        Object.defineProperty(arr, 'last', {\n            enumerable: false,\n            value: function(i) {\n                return this[this.length - (1 + i)];\n            }\n        });\n    }\n}\n\nfunction is(obj, prop) {\n    return (obj && obj.hasOwnProperty(\"type\") && obj.type == prop);\n}\n\nfunction log(str) {\n    //console.log(str);\n}\n\n\nmodule.exports.parse = parse;\nfunction parse(text, dupKeys) {\n    let stack = [];\n\n    let tokens = [];\n\n    extendArray(stack);\n    extendArray(tokens);\n\n    let emit = function(t) {\n        tokens.push(t);\n    };\n\n    lexer.lexString(text, emit);\n\n    // ensure that if we started with a LB or LCB, we end with a\n    // RB or RCB.\n    if (tokens[0].type == LEX_LB && tokens.last(0).type != LEX_RB) {\n        tokens.push({ type: LEX_RB, value: \"]\", row: -1, col: -1});\n    }\n\n    if (tokens[0].type == LEX_LCB && tokens.last(0).type != LEX_RCB) {\n        tokens.push({ type: LEX_RCB, value: \"}\", row: -1, col: -1});\n    }\n\n    for (let i = 0; i < tokens.length; i++) {\n        log(\"Shifting \" + tokens[i].type);\n        stack.push(tokens[i]);\n        log(stack);\n        log(\"Reducing...\");\n        while (reduce(stack)) {\n            log(stack);\n            log(\"Reducing...\");\n        }\n    }\n\n    // if everything parsed into a KV list, assume it was an object missing the starting\n    // \"{\" and ending \"}\"\n    if (stack.length == 1 && stack[0].type == LEX_KVLIST) {\n        log(\"Pre-compile error fix 1\");\n        stack = [{type: LEX_OBJ, value: stack[0].value}];\n    }\n\n    return compileOST(stack[0], dupKeys);\n\n}\n\nfunction reduce(stack) {\n    let next = stack.pop();\n\n    switch(next.type) {\n    case LEX_KEY:\n        if (next.value.trim() == \"true\") {\n            log(\"Rule 5\");\n            stack.push({'type': LEX_BOOLEAN, 'value': \"true\"});\n            return true;\n        }\n\n\n        if (next.value.trim() == \"false\") {\n            log(\"Rule 6\");\n            stack.push({'type': LEX_BOOLEAN, 'value': \"false\"});\n            return true;\n        }\n\n        if (next.value.trim() == \"null\") {\n            log(\"Rule 7\");\n            stack.push({'type': LEX_VALUE, 'value': null});\n            return true;\n        }\n        break;\n\n    case LEX_TOKEN:\n        if (is(stack.peek(), LEX_KEY)) {\n            log(\"Rule 11a\");\n            stack.peek().value += next.value;\n            return true;\n        }\n\n        log(\"Rule 11c\");\n        stack.push({type: LEX_KEY, value: next.value });\n        return true;\n\n\n    case LEX_INT:\n        if (is(next, LEX_INT) && is(stack.peek(), LEX_KEY)) {\n            log(\"Rule 11b\");\n            stack.peek().value += next.value;\n            return true;\n        }\n\n        log(\"Rule 11f\");\n        next.type = LEX_VALUE;\n        stack.push(next);\n        return true;\n\n\n    case LEX_QUOTE:\n        log(\"Rule 11d\");\n        next.type = LEX_VALUE;\n        next.value = next.value;\n        stack.push(next);\n        return true;\n\n\n    case LEX_BOOLEAN:\n        log(\"Rule 11e\");\n        next.type = LEX_VALUE;\n\n        if (next.value == \"true\") {\n            next.value = true;\n        } else {\n            next.value = false;\n        }\n\n        stack.push(next);\n        return true;\n\n\n    case LEX_FLOAT:\n        log(\"Rule 11g\");\n        next.type = LEX_VALUE;\n        stack.push(next);\n        return true;\n\n    case LEX_VALUE:\n        if (is(stack.peek(), LEX_COMMA)) {\n            log(\"Rule 12\");\n            next.type = LEX_CVALUE;\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COLON)) {\n            log(\"Rule 13\");\n            next.type = LEX_COVALUE;\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && is(stack.last(1), LEX_VALUE)) {\n            log(\"Error rule 1\");\n            let middleVal = stack.pop();\n            stack.peek().value += '\"' + middleVal.value + '\"';\n            stack.peek().value += next.value;\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && is(stack.last(1), LEX_VLIST)) {\n            log(\"Error rule 2\");\n            let middleVal = stack.pop();\n            let oldLastVal = stack.peek().value.pop();\n            oldLastVal +=  '\"' + middleVal.value + '\"';\n            oldLastVal += next.value;\n            \n            stack.peek().value.push(oldLastVal);\n            \n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && is(stack.last(1), LEX_KVLIST)) {\n            log(\"Error rule 3\");\n            let middleVal = stack.pop();\n            let oldLastVal = stack.peek().value.pop();\n            const qChar = next.single ? \"'\" : '\"';\n            \n            oldLastVal.value +=  qChar + middleVal.value + qChar;\n            oldLastVal.value += next.value;\n            \n            stack.peek().value.push(oldLastVal);\n            \n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY)) {\n            log(\"Error rule 4\");\n            let keyValue = stack.pop().value;\n            next.value = keyValue + next.value;\n            stack.push(next);\n            return true;\n        }\n\n        break;\n\n    case LEX_LIST:\n        if (is(next, LEX_LIST) && is(stack.peek(), LEX_COMMA)) {\n            log(\"Rule 12a\");\n            next.type = LEX_CVALUE;\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COLON)) {\n            log(\"Rule 13a\");\n            next.type = LEX_COVALUE;\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n        break;\n\n    case LEX_OBJ:\n        if (is(stack.peek(), LEX_COMMA)) {\n            log(\"Rule 12b\");\n            let toPush = {'type': LEX_CVALUE, 'value': next};\n            stack.pop();\n            stack.push(toPush);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COLON)) {\n            log(\"Rule 13b\");\n            let toPush = {'type': LEX_COVALUE, 'value': next};\n            stack.pop();\n            stack.push(toPush);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY)) {\n            log(\"Error rule 9\");\n            let key = stack.pop();\n            stack.push({'type': LEX_KV, 'key': key.value.trim(), 'value': next});\n            return true;\n        }\n        \n        break;\n\n    case LEX_CVALUE:\n        if (is(stack.peek(), LEX_VLIST)) {\n            log(\"Rule 14\");\n            stack.peek().value.push(next.value);\n            return true;\n        }\n\n\n        log(\"Rule 15\");\n        stack.push({'type': LEX_VLIST, 'value': [next.value]});\n        return true;\n\n    case LEX_VLIST:\n        if (is(stack.peek(), LEX_VALUE)) {\n            log(\"Rule 15a\");\n            next.value.unshift(stack.peek().value);\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_LIST)) {\n            log(\"Rule 15b\");\n            next.value.unshift(stack.peek().value);\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_OBJ)) {\n            log(\"Rule 15c\");\n            next.value.unshift(stack.peek());\n            stack.pop();\n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && (stack.last(1), LEX_COMMA)) {\n            log(\"Error rule 7\");\n            let l = stack.pop();\n            stack.push({type: LEX_VALUE, 'value': l.value});\n            log(\"Start subreduce... (\" + l.value + \")\");\n            while(reduce(stack));\n            log(\"End subreduce\");\n            stack.push(next);\n\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_VLIST)) {\n            log(\"Error rule 8\");\n            stack.peek().value.push(next.value[0]);\n            return true;\n        }\n        break;\n\n    case LEX_COVALUE:\n\n        if (is(stack.peek(), LEX_KEY) || is(stack.peek(), LEX_VALUE) || is(stack.peek(), LEX_VLIST)) {\n            log(\"Rule 16\");\n            let key = stack.pop();\n            stack.push({'type': LEX_KV, 'key': key.value, 'value': next.value});\n            return true;\n        }\n\n\n        throw new Error(\"Got a :value that can't be handled at line \" +\n                       next.row + \":\" + next.col);\n\n    case LEX_KV:\n        if (is(stack.last(0), LEX_COMMA) && is(stack.last(1), LEX_KVLIST)) {\n            log(\"Rule 17\");\n            stack.last(1).value.push(next);\n            stack.pop();\n            return true;\n        }\n\n        log(\"Rule 18\");\n        stack.push({'type': LEX_KVLIST, 'value': [next]});\n        return true;\n\n    case LEX_KVLIST:\n        if (is(stack.peek(), LEX_KVLIST)) {\n            log(\"Rule 17a\");\n            next.value.forEach(function (i) {\n                stack.peek().value.push(i);\n            });\n            return true;\n        }\n\n        break;\n\n    case LEX_RB:\n        if (is(stack.peek(), LEX_VLIST) && is(stack.last(1), LEX_LB)) {\n            log(\"Rule 19\");\n            let l = stack.pop();\n            stack.pop();\n            stack.push({'type': LEX_LIST, 'value': l.value});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_LIST) && is(stack.last(1), LEX_LB)) {\n            log(\"Rule 19b\");\n            let l = stack.pop();\n            stack.pop();\n            stack.push({'type': LEX_LIST, 'value': [l.value]});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_LB)) {\n            log(\"Rule 22\");\n            stack.pop();\n            stack.push({type: LEX_LIST, 'value': []});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_VALUE) && is(stack.last(1), LEX_LB)) {\n            log(\"Rule 23\");\n            let val = stack.pop().value;\n            stack.pop();\n            stack.push({type: LEX_LIST, 'value': [val]});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_OBJ) && is(stack.last(1), LEX_LB)) {\n            log(\"Rule 23b\");\n            let val = stack.pop();\n            stack.pop();\n            stack.push({type: LEX_LIST, 'value': [val]});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && is(stack.last(1), LEX_COMMA)) {\n            log(\"Error rule 5\");\n            let l = stack.pop();\n            stack.push({type: LEX_VALUE, 'value': l.value});\n            log(\"Start subreduce... (\" + l.value + \")\");\n            while(reduce(stack));\n            log(\"End subreduce\");\n            stack.push({type: LEX_RB});\n            return true;\n        }\n\n        \n        if (is(stack.peek(), LEX_COMMA) && (\n            is(stack.last(1), LEX_KEY)\n                || is(stack.last(1), LEX_OBJ)\n                || is(stack.last(1), LEX_VALUE))\n           ) {\n            log(\"Error rule 5a\");\n            stack.pop();\n            //let l = stack.pop();\n            //stack.push({type: LEX_VALUE, 'value': l.value});\n            stack.push({type: LEX_RB, 'value': ']'});\n            log(\"Start subreduce...\");\n            log(\"Content: \" + JSON.stringify(stack));\n            while(reduce(stack));\n            log(\"End subreduce\");\n\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && is(stack.last(1), LEX_LB)) {\n            log(\"Error rule 5b\");\n            let v = stack.pop();\n            stack.pop();\n            stack.push({type: LEX_LIST, value: [v.value]});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COMMA) && is(stack.last(1), LEX_VLIST)) {\n            log(\"Error rule 5c\");\n            stack.pop();\n            stack.push({type: LEX_RB});\n            log(\"Start subreduce...\");\n            log(\"Content: \" + JSON.stringify(stack));\n            while(reduce(stack));\n            log(\"End subreduce\");\n\n            return true;\n        }\n\n        break;\n\n    case LEX_RCB:\n        if (is(stack.peek(), LEX_KVLIST) && is(stack.last(1), LEX_LCB)) {\n            log(\"Rule 20\");\n            let l = stack.pop();\n            stack.pop();\n            stack.push({'type': LEX_OBJ, 'value': l.value});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_LCB)) {\n            log(\"Rule 21\");\n            stack.pop();\n            stack.push({type: LEX_OBJ, 'value': null});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY) && is(stack.last(1), LEX_COLON)) {\n            log(\"Error rule 4a\");\n            let l = stack.pop();\n            stack.push({type: LEX_VALUE, 'value': l.value});\n            log(\"Start subreduce... (\" + l.value + \")\");\n            while(reduce(stack));\n            log(\"End subreduce\");\n            stack.push({type: LEX_RCB});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COLON)) {\n            log(\"Error rule 4b\");\n            stack.push({type: LEX_VALUE, value: null});\n\n            log(\"Starting subreduce...\");\n            while (reduce(stack));\n            log(\"End subreduce.\");\n            \n            stack.push({type: LEX_RCB});\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COMMA)) {\n            log(\"Error rule 10a\");\n            stack.pop();\n            stack.push({type: LEX_RCB});\n            return true;\n        }\n        \n        throw new Error(\"Found } that I can't handle at line \" +\n                        next.row + \":\" + next.col);\n\n        \n    case LEX_COMMA:\n        if (is(stack.peek(), LEX_COMMA)) {\n            log(\"Comma error rule 1\");\n            // do nothing -- so don't push the extra comma onto the stack\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_KEY)) {\n            log(\"Comma error rule 2\");\n            const key = stack.pop();\n            stack.push({type: LEX_VALUE, value: key.value});\n            \n            log(\"Starting subreduce...\");\n            while (reduce(stack));\n            log (\"End subreduce.\");\n            \n            stack.push(next);\n            return true;\n        }\n\n        if (is(stack.peek(), LEX_COLON)) {\n            log(\"Comma error rule 3\");\n            stack.push({type: LEX_VALUE, value: null});\n            \n            log(\"Starting subreduce...\");\n            while (reduce(stack));\n            log (\"End subreduce.\");\n            \n            stack.push(next);\n            return true;\n        }\n\n    }\n\n\n    stack.push(next);\n    return false;\n}\n\n\n\nfunction compileOST(tree, dupKeys) {\n    let rawTypes = [\"boolean\", \"number\", \"string\"];\n\n    if (rawTypes.indexOf((typeof tree)) != -1)\n        return tree;\n\n    if (tree === null)\n        return null;\n\n    if (Array.isArray(tree)) {\n        let toR = [];\n        while (tree.length > 0)\n            toR.unshift(compileOST(tree.pop()));\n        return toR;\n    }\n    \n\n    if (is(tree, LEX_OBJ)) {\n        let toR = {};\n        if (tree.value === null)\n            return {};\n        tree.value.forEach(function (i) {\n            const key = i.key;\n            const val = compileOST(i.value);\n\n            if (dupKeys && key in toR) {\n                toR[key] = {\n                    \"value\": toR[key],\n                    \"next\": val\n                };\n            } else {\n                toR[key] = val;\n            }\n        });\n        return toR;\n    }\n\n    if (is(tree, LEX_LIST)) {\n        return compileOST(tree.value);\n    }\n\n    // it must be a value\n    return tree.value;\n}\n\n",
    "// < begin copyright > \n// Copyright Ryan Marcus 2018\n// \n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU Affero General Public License as\n// published by the Free Software Foundation, either version 3 of the\n// License, or (at your option) any later version.\n// \n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU Affero General Public License for more details.\n// \n// You should have received a copy of the GNU Affero General Public License\n// along with this program.  If not, see <https://www.gnu.org/licenses/>.\n// \n// < end copyright > \n \n\n\n\"use strict\";\n\nlet parser = require('./parser');\n\nmodule.exports.parse = parse;\nfunction parse(text, config) {\n    let fallback = true;\n    let duplicateKeys = false;\n\n    if (config) {\n        if ((\"fallback\" in config) && config[fallback] === false) {\n            fallback = false;\n        }\n\n        duplicateKeys = \"duplicateKeys\" in config && config[\"duplicateKeys\"] === true;\n    }\n\n    try {\n        return parser.parse(text, duplicateKeys);\n    } catch (e) {\n        // our parser threw an error! see if the JSON was valid...\n        /* istanbul ignore next */\n        if (fallback === false) {\n            throw e;\n        }\n        \n        try {\n            let json = JSON.parse(text);\n            // if we didn't throw, it was valid JSON!\n            /* istanbul ignore next */\n            console.warn(\"dirty-json got valid JSON that failed with the custom parser. We're returning the valid JSON, but please file a bug report here: https://github.com/RyanMarcus/dirty-json/issues  -- the JSON that caused the failure was: \" + text);\n\n            /* istanbul ignore next */\n            return json;\n        } catch (json_error) {\n            throw e;\n        }\n\n    }\n}\n",
    "import { getRequestHeaders } from '../../../../script.js';\nimport { FILE_NAMES, SCHEMA } from './constants.js';\nimport { t as __st_t_tag, translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-SidePromptsManager';\nconst SIDE_PROMPTS_FILE = FILE_NAMES.SIDE_PROMPTS_FILE;\n\n\n/**\n * In-memory cache of loaded side prompts\n * @type {Object|null}\n */\nlet cachedDoc = null;\n\n/**\n * Generate ISO timestamp\n */\nfunction nowIso() {\n    return new Date().toISOString();\n}\n\n/**\n * Safe slug from name\n */\nfunction safeSlug(str) {\n    return String(str || '')\n        .toLowerCase()\n        .replace(/[^a-z0-9]+/g, '-')\n        .replace(/^-+|-+$/g, '')\n        .substring(0, 50) || 'sideprompt';\n}\n\n/**\n * Validate V2 document structure (triggers-based)\n */\nfunction validateSidePromptsFileV2(data) {\n    if (!data || typeof data !== 'object') return false;\n    if (typeof data.version !== 'number') return false;\n    if (!data.prompts || typeof data.prompts !== 'object') return false;\n\n    for (const [key, p] of Object.entries(data.prompts)) {\n        if (!p || typeof p !== 'object') return false;\n        if (p.key !== key) return false;\n        if (typeof p.name !== 'string' || !p.name.trim()) return false;\n        if (typeof p.enabled !== 'boolean') return false;\n        if (typeof p.prompt !== 'string') return false;\n        if (!p.settings || typeof p.settings !== 'object') return false;\n\n        // triggers must exist in v2\n        if (!p.triggers || typeof p.triggers !== 'object') return false;\n\n        // onInterval validation (optional)\n        if (p.triggers.onInterval != null) {\n            const oi = p.triggers.onInterval;\n            if (typeof oi !== 'object') return false;\n            const vis = Number(oi.visibleMessages);\n            if (!Number.isFinite(vis) || vis < 1) return false;\n        }\n\n        // onAfterMemory validation (optional)\n        if (p.triggers.onAfterMemory != null) {\n            const oam = p.triggers.onAfterMemory;\n            if (typeof oam !== 'object') return false;\n            if (typeof oam.enabled !== 'boolean') return false;\n        }\n\n        // commands validation (optional)\n        if (p.triggers.commands != null) {\n            if (!Array.isArray(p.triggers.commands)) return false;\n            for (const c of p.triggers.commands) {\n                if (typeof c !== 'string' || !c.trim()) return false;\n            }\n        }\n    }\n\n    return true;\n}\n\n/**\n * Quick check if data looks like V1 (type-based) structure\n */\nfunction looksLikeV1(data) {\n    if (!data || typeof data !== 'object') return false;\n    if (!data.prompts || typeof data.prompts !== 'object') return false;\n\n    // If any prompt has \"type\" and no \"triggers\", treat as V1\n    return Object.values(data.prompts).some((p) => p && typeof p === 'object' && 'type' in p && !('triggers' in p));\n}\n\n/**\n * Migrate V1 (type-based) document to V2 (triggers-based)\n */\nfunction migrateV1toV2(v1) {\n    const createdAt = nowIso();\n    const v2 = {\n        version: Math.max(2, Number(v1.version || 1) + 1),\n        prompts: {},\n    };\n\n    for (const [key, p] of Object.entries(v1.prompts || {})) {\n        const next = {\n            key,\n            name: String(p.name || 'Side Prompt'),\n            enabled: !!p.enabled,\n            prompt: String(p.prompt != null ? p.prompt : 'this is a placeholder prompt'),\n            responseFormat: String(p.responseFormat || ''),\n            settings: { ...(p.settings || {}) },\n            createdAt: p.createdAt || createdAt,\n            updatedAt: createdAt,\n            triggers: {\n                onInterval: undefined,\n                onAfterMemory: undefined,\n                commands: ['sideprompt'],\n            },\n        };\n\n        // Map types to triggers\n        const type = String(p.type || '').toLowerCase();\n        if (type === 'tracker') {\n            const intervalVisibleMessages = Math.max(1, Number(p.settings?.intervalVisibleMessages ?? 50));\n            next.triggers.onInterval = { visibleMessages: intervalVisibleMessages };\n            // trackers don't need after-memory by default\n        } else if (type === 'plotpoints') {\n            const withMemories = !!(p.settings?.withMemories ?? true);\n            next.triggers.onAfterMemory = { enabled: !!withMemories };\n        } else if (type === 'scoreboard') {\n            const withMemories = !!(p.settings?.withMemories ?? false);\n            if (withMemories) {\n                next.triggers.onAfterMemory = { enabled: true };\n            }\n            // scoreboard is primarily manual; commands already filled\n        } else {\n            // Unknown type: leave only manual command trigger\n        }\n\n        v2.prompts[key] = next;\n    }\n\n    return v2;\n}\n\n/**\n * Default built-in templates\n */\nfunction getBuiltinTemplates() {\n    const createdAt = nowIso();\n    const prompts = {};\n    {\n        const key = safeSlug('Plotpoints');\n        prompts[key] = {\n            key,\n            name: translate('Plotpoints', 'STMemoryBooks_Plotpoints'),\n            enabled: false,\n            prompt: translate(\"Analyze the accompanying scene for plot threads, story arcs, and other narrative movements. The previous scenes are there to provide context. Generate a story thread report. If a report already exists in context, update it instead of recreating.\", 'STMemoryBooks_PlotpointsPrompt'),\n            responseFormat: translate(\"=== Plot Points ===\\n(as of [point in the story when this analysis was done])\\n\\n[Overarching Plot Arc]\\n(2-3 sentence summary of the superobjective or major plot)\\n\\n[Thread #1 Title]\\n- Summary: (1 sentence)\\n- Status: (active / on hold)\\n- At Stake: (how resolution will affect the ongoing story)\\n- Last Known: (location or time)\\n- Key Characters: ...\\n\\n\\n[Thread #2 Title]\\n- Summary: (1 sentence)\\n- Status: (active / on hold)\\n- At Stake: (how resolution will affect the ongoing story)\\n- Last Known: (location or time)\\n- Key Characters: ...\\n\\n...\\n\\n-- Plot Hooks --\\n- (new or potential plot hooks)\\n\\n-- Character Dynamics --\\n- current status of {{user}}'s/{{char}}'s relationships with NPCs\\n\\n===End Plot Points===\\n\", 'STMemoryBooks_PlotpointsResponseFormat'),\n            settings: {\n                overrideProfileEnabled: false,\n                lorebook: {\n                constVectMode: \"blue\",\n                position: 2,\n                orderMode: \"manual\",\n                orderValue: 25,\n                preventRecursion: true,\n                delayUntilRecursion: false\n                }\n            },\n            triggers: {\n                onAfterMemory: {\n                enabled: true\n                },\n                commands: [\n                \"sideprompt\"\n                ]\n            },\n            createdAt,\n            updatedAt: createdAt,\n        };\n    };    \n    {\n        const key = safeSlug('Status');\n        prompts[key] = {\n            key,\n            name: translate('Status', 'STMemoryBooks_Status'),\n            enabled: false,\n            prompt: translate(\"Analyze all context (previous scenes, memories, lore, history, interactions) to generate a detailed analysis of {{user}} and {{char}} (including abbreviated !lovefactor and !lustfactor commands). Note: If there is a pre-existing !status report, update it, do not regurgitate it.\", 'STMemoryBooks_StatusPrompt'),\n            responseFormat: translate(\"Follow this general format:\\n\\n## Witty Headline or Summary\\n\\n### AFFINITY (0-100, have some relationship with !lovefactor and !lustfactor)\\n- Score with evidence\\n- Recent changes \\n- Supporting quotes\\n- Anything else that might be illustrative of the current affinity\\n\\n### LOVEFACTOR and LUSTFACTOR\\n(!lovefactor and !lustfactor reports go here)\\n\\n### RELATIONSHIP STATUS (negative = enemies, 0 = strangers, 100 = life partners)\\n- Trust/boundaries/communication\\n- Key events\\n- Issues\\n- Any other pertinent points\\n\\n### GOALS\\n- Short/long-term objectives\\n- Progress/obstacles\\n- Growth areas\\n- Any other pertinent points\\n\\n### ANALYSIS\\n- Psychology/POV\\n- Development/triggers\\n- Story suggestions\\n- Any other pertinent points\\n\\n### WRAP-UP\\n- OOC Summary (1 paragraph)\", 'STMemoryBooks_StatusResponseFormat'),\n            settings: {\n                overrideProfileEnabled: false,\n                lorebook: {\n                constVectMode: \"link\",\n                position: 3,\n                orderMode: \"manual\",\n                orderValue: 25,\n                preventRecursion: true,\n                delayUntilRecursion: false\n                }\n            },\n            triggers: {\n                onAfterMemory: {\n                enabled: true\n                },\n                commands: [\n                \"sideprompt\"\n                ]\n            },\n            createdAt,\n            updatedAt: createdAt,\n        };\n    };    \n    {\n        const key = safeSlug('Cast');\n        prompts[key] = {\n            key,\n            name: translate('Cast of Characters', 'STMemoryBooks_CastOfCharacters'),\n            enabled: false,\n            prompt: translate(\"You are a skilled reporter with a clear eye for judging the importance of NPCs to the plot. \\nStep 1: Review the scene and either add or update plot-related NPCs to the NPC WHO'S WHO report. Please note that {{char}} and {{user}} are major characters and do NOT need to be included in this report.\\nStep 2: This list should be kept in order of importance to the plot, so it may need to be reordered.\\nStep 3: If your response would be more than 2000 tokens long, remove NPCs with the least impact to the plot.\", 'STMemoryBooks_CastOfCharactersPrompt'),\n            responseFormat: translate(\"===NPC WHO'S WHO===\\n(In order of importance to the plot)\\n\\nPerson 1: 1-2 sentence desription\\nPerson 2: 1-2 sentence desription\\n===END NPC WHO'S WHO===\", 'STMemoryBooks_CastOfCharactersResponseFormat'),\n            settings: {\n                overrideProfileEnabled: false,\n                lorebook: {\n                constVectMode: \"blue\",\n                position: 3,\n                orderMode: \"manual\",\n                orderValue: 15,\n                preventRecursion: true,\n                delayUntilRecursion: false\n                }\n            },\n            triggers: {\n                onAfterMemory: {\n                enabled: true\n                },\n                commands: [\n                \"sideprompt\"\n                ]\n            },\n            createdAt,\n            updatedAt: createdAt,\n        };\n    };    \n    {\n        const key = safeSlug('Assess');\n        prompts[key] = {\n            key,\n            name: translate('Assess', 'STMemoryBooks_Assess'),\n            enabled: false,\n            prompt: translate(\"Assess the interaction between {{char}} and {{user}} to date. List all the information {{char}} has learned about {{user}} through observation, questioning, or drawing conclusions from interaction (similar to a mental \\\"note to self\\\"). If there is already a list, update it. Try to keep it token-efficient and compact, focused on the important things.\", 'STMemoryBooks_AssessPrompt'),\n            responseFormat: translate(\"Use this format: \\n=== Things {{char}} has learned about {{user}} ===\\n(detailed list, in {{char}}'s POV/tone of voice)\\n===\", 'STMemoryBooks_AssessResponseFormat'),\n            settings: {\n                overrideProfileEnabled: false,\n                lorebook: {\n                constVectMode: \"blue\",\n                position: 2,\n                orderMode: \"manual\",\n                orderValue: 30,\n                preventRecursion: true,\n                delayUntilRecursion: false\n                }\n            },\n            triggers: {\n                onAfterMemory: {\n                enabled: true\n                },\n                commands: [\n                \"sideprompt\"\n                ]\n            },\n            createdAt,\n            updatedAt: createdAt,\n        };\n    }\n    return prompts;\n}\n\n/**\n * Create a new base document (V2)\n */\nfunction createBaseDoc() {\n    return {\n        version: Math.max(2, SCHEMA.CURRENT_VERSION ?? 2),\n        prompts: getBuiltinTemplates(),\n    };\n}\n\n/**\n * Save document to server\n */\nasync function saveDoc(doc) {\n    const json = JSON.stringify(doc, null, 2);\n    const base64 = btoa(unescape(encodeURIComponent(json)));\n\n    const res = await fetch('/api/files/upload', {\n        method: 'POST',\n        credentials: 'include',\n        headers: getRequestHeaders(),\n        body: JSON.stringify({\n            name: SIDE_PROMPTS_FILE,\n            data: base64,\n        }),\n    });\n\n    if (!res.ok) {\n        throw new Error(__st_t_tag`Failed to save side prompts: ${res.status} ${res.statusText}`);\n    }\n\n    cachedDoc = doc;\n    console.log(`${MODULE_NAME}: ${translate('Side prompts saved successfully', 'STMemoryBooks_SidePromptsSaved')}`);\n}\n\n/**\n * Load document from server, creating or migrating it if missing/invalid\n */\nexport async function loadSidePrompts() {\n    if (cachedDoc) return cachedDoc;\n\n    let data = null;\n\n    try {\n        const res = await fetch(`/user/files/${SIDE_PROMPTS_FILE}`, {\n            method: 'GET',\n            credentials: 'include',\n            headers: getRequestHeaders(),\n        });\n\n        if (!res.ok) {\n            // Missing -> create base\n            data = createBaseDoc();\n            await saveDoc(data);\n        } else {\n            const text = await res.text();\n            const parsed = JSON.parse(text);\n\n            // If looks like old V1 -> migrate to V2\n            if (looksLikeV1(parsed)) {\n                console.log(`${MODULE_NAME}: ${translate('Migrating side prompts file from V1(type) to V2(triggers)', 'STMemoryBooks_MigratingSidePrompts')}`);\n                data = migrateV1toV2(parsed);\n                await saveDoc(data);\n            } else {\n                // Validate as V2; if invalid generate base\n                if (!validateSidePromptsFileV2(parsed)) {\n                    console.warn(`${MODULE_NAME}: ${translate('Invalid side prompts file structure; recreating with built-ins', 'STMemoryBooks_InvalidSidePromptsFile')}`);\n                    data = createBaseDoc();\n                    await saveDoc(data);\n                } else {\n                    data = parsed;\n                    // If version < 2 but passes V2 validation, bump version\n                    if (Number(data.version || 1) < 2) {\n                        data.version = 2;\n                        await saveDoc(data);\n                    }\n                }\n            }\n        }\n    } catch (e) {\n        console.warn(`${MODULE_NAME}: ${translate('Error loading side prompts; creating base doc', 'STMemoryBooks_ErrorLoadingSidePrompts')}`, e);\n        data = createBaseDoc();\n        await saveDoc(data);\n    }\n\n    cachedDoc = data;\n    return cachedDoc;\n}\n\n/**\n * First-run init to ensure file exists\n */\nexport async function firstRunInitIfMissing() {\n    await loadSidePrompts();\n    return true;\n}\n\n/**\n * List all templates (sorted by updatedAt desc)\n */\nexport async function listTemplates() {\n    const data = await loadSidePrompts();\n    const list = Object.values(data.prompts);\n    list.sort((a, b) => {\n        const at = a.updatedAt || a.createdAt || '';\n        const bt = b.updatedAt || b.createdAt || '';\n        return bt.localeCompare(at);\n    });\n    return list;\n}\n\n/**\n * Get template by key\n */\nexport async function getTemplate(key) {\n    const data = await loadSidePrompts();\n    return data.prompts[key] || null;\n}\n\n/**\n * Find template by display name (case-insensitive), preferring exact match\n */\nexport async function findTemplateByName(name) {\n    const data = await loadSidePrompts();\n    const raw = String(name || '').trim();\n    if (!raw) return null;\n\n    const targetLower = raw.toLowerCase();\n    const targetSlug = safeSlug(raw);\n    const targetNorm = targetLower.replace(/[^a-z0-9]+/g, ' ').trim();\n\n    const templates = Object.values(data.prompts);\n\n    // 1) Exact matches: name, key, or slug\n    for (const p of templates) {\n        const nameLower = String(p.name || '').toLowerCase();\n        const keyLower = String(p.key || '').toLowerCase();\n        const nameSlug = safeSlug(p.name || '');\n        if (nameLower === targetLower || keyLower === targetLower || nameSlug === targetSlug) {\n            return p;\n        }\n    }\n\n    // 2) Starts-with matches: name, slug, or key\n    for (const p of templates) {\n        const nameLower = String(p.name || '').toLowerCase();\n        const keyLower = String(p.key || '').toLowerCase();\n        const nameSlug = safeSlug(p.name || '');\n        if (nameLower.startsWith(targetLower) || nameSlug.startsWith(targetSlug) || keyLower.startsWith(targetLower)) {\n            return p;\n        }\n    }\n\n    // 3) Contains matches with normalization tolerance\n    for (const p of templates) {\n        const nameLower = String(p.name || '').toLowerCase();\n        const nameSlug = safeSlug(p.name || '');\n        const nameNorm = nameLower.replace(/[^a-z0-9]+/g, ' ').trim();\n        if (\n            nameLower.includes(targetLower) ||\n            nameSlug.includes(targetSlug) ||\n            (targetNorm && nameNorm.includes(targetNorm))\n        ) {\n            return p;\n        }\n    }\n\n    return null;\n}\n\n/**\n * Create or update a template (v2)\n */\nexport async function upsertTemplate(input) {\n    const data = await loadSidePrompts();\n    const isNew = !input.key;\n    const ts = nowIso();\n\n    // Determine final display name with safe default\n    const requestedName = String(input.name ?? '').trim();\n    const cur = isNew ? null : data.prompts[input.key];\n    const finalName = requestedName || (isNew ? translate('Untitled Side Prompt', 'STMemoryBooks_UntitledSidePrompt') : (cur?.name || translate('Untitled Side Prompt', 'STMemoryBooks_UntitledSidePrompt')));\n\n    // Determine key (preserve existing on edit; generate unique on create)\n    let key;\n    if (input.key) {\n        key = input.key;\n    } else {\n        const base = safeSlug(finalName || translate('Untitled Side Prompt', 'STMemoryBooks_UntitledSidePrompt'));\n        let candidate = base;\n        let suffix = 2;\n        while (data.prompts[candidate]) {\n            candidate = safeSlug(`${finalName} ${suffix}`);\n            suffix++;\n        }\n        key = candidate;\n    }\n\n    const prev = data.prompts[key];\n    const next = {\n        key,\n        name: finalName,\n        enabled: typeof input.enabled === 'boolean' ? input.enabled : (prev?.enabled ?? false),\n        prompt: String(input.prompt != null ? input.prompt : (prev?.prompt || 'this is a placeholder prompt')),\n        responseFormat: String(input.responseFormat != null ? input.responseFormat : (prev?.responseFormat || '')),\n        settings: { ...(prev?.settings || {}), ...(input.settings || {}) },\n        triggers: input.triggers ? input.triggers : (prev?.triggers || { commands: ['sideprompt'] }),\n        createdAt: prev?.createdAt || ts,\n        updatedAt: ts,\n    };\n\n    // Normalize triggers for safety\n    if (next.triggers.onInterval) {\n        const vis = Math.max(1, Number(next.triggers.onInterval.visibleMessages ?? 50));\n        next.triggers.onInterval = { visibleMessages: vis };\n    }\n    if (next.triggers.onAfterMemory) {\n        next.triggers.onAfterMemory = { enabled: !!next.triggers.onAfterMemory.enabled };\n    }\n    if ('commands' in next.triggers) {\n        if (Array.isArray(next.triggers.commands)) {\n            next.triggers.commands = next.triggers.commands.filter(x => typeof x === 'string' && x.trim());\n            // If the user cleared it intentionally, keep it empty to mean no manual command\n        } else {\n            // Explicitly provided but not an array => treat as disabled\n            next.triggers.commands = [];\n        }\n    } else {\n        // commands not provided at all (legacy/programmatic): default to manual for back-compat\n        next.triggers.commands = ['sideprompt'];\n    }\n\n    data.prompts[key] = next;\n    await saveDoc(data);\n    return key;\n}\n\n/**\n * Duplicate a template\n */\nexport async function duplicateTemplate(sourceKey) {\n    const data = await loadSidePrompts();\n    const src = data.prompts[sourceKey];\n    if (!src) throw new Error(__st_t_tag`Template \"${sourceKey}\" not found`);\n\n    let base = __st_t_tag`${src.name} (Copy)`;\n    let key = safeSlug(base);\n    let suffix = 2;\n    while (data.prompts[key]) {\n        key = safeSlug(`${base} ${suffix}`);\n        suffix++;\n    }\n\n    const ts = nowIso();\n    data.prompts[key] = {\n        ...src,\n        key,\n        name: base,\n        createdAt: ts,\n        updatedAt: ts,\n    };\n    await saveDoc(data);\n    return key;\n}\n\n/**\n * Remove a template\n */\nexport async function removeTemplate(key) {\n    const data = await loadSidePrompts();\n    if (!data.prompts[key]) throw new Error(__st_t_tag`Template \"${key}\" not found`);\n    delete data.prompts[key];\n    await saveDoc(data);\n}\n\n/**\n * Export current doc JSON\n */\nexport async function exportToJSON() {\n    const data = await loadSidePrompts();\n    return JSON.stringify(data, null, 2);\n}\n\n/**\n * Import JSON (additively merges into existing prompts; does not overwrite)\n */\nexport async function importFromJSON(jsonString) {\n    const parsed = JSON.parse(jsonString);\n\n    // Accept either strict V2 or migrate V1 on import\n    let incoming = null;\n    if (validateSidePromptsFileV2(parsed)) {\n        incoming = parsed;\n    } else if (looksLikeV1(parsed)) {\n        incoming = migrateV1toV2(parsed);\n    } else {\n        throw new Error(translate('Invalid side prompts file structure', 'STMemoryBooks_InvalidSidePromptsJSON'));\n    }\n\n    // Load existing and merge additively\n    const existing = await loadSidePrompts();\n    const merged = {\n        version: Math.max(2, Number(existing.version ?? 2), Number(incoming.version ?? 2)),\n        prompts: { ...existing.prompts },\n    };\n\n    // Utility to ensure a unique key in merged.prompts without overwriting existing entries\n    const ensureUniqueKey = (desiredKey, name) => {\n        const baseName = String(name || '').trim() || desiredKey || 'sideprompt';\n        const base = safeSlug(baseName);\n        let candidate = desiredKey && !merged.prompts[desiredKey] ? desiredKey : base;\n        if (!candidate) candidate = 'sideprompt';\n        let suffix = 2;\n        while (merged.prompts[candidate]) {\n            candidate = safeSlug(`${baseName} ${suffix}`);\n            suffix++;\n        }\n        return candidate;\n    };\n\n    let added = 0;\n    let renamed = 0;\n\n    for (const [key, p] of Object.entries(incoming.prompts || {})) {\n        // If an entry with the same key already exists, do not overwrite; add with a new unique key\n        const finalKey = merged.prompts[key] ? ensureUniqueKey(null, p?.name || key) : key;\n        if (finalKey !== key) {\n            renamed++;\n        }\n\n        const ts = nowIso();\n        const next = {\n            key: finalKey,\n            name: String(p.name || 'Side Prompt'),\n            enabled: !!p.enabled,\n            prompt: String(p.prompt != null ? p.prompt : 'this is a placeholder prompt'),\n            responseFormat: String(p.responseFormat || ''),\n            settings: { ...(p.settings || {}) },\n            triggers: p.triggers ? { ...p.triggers } : { commands: ['sideprompt'] },\n            createdAt: p.createdAt || ts,\n            updatedAt: ts,\n        };\n\n        // Normalize triggers similar to upsert safety\n        if (next.triggers.onInterval) {\n            const vis = Math.max(1, Number(next.triggers.onInterval.visibleMessages ?? 50));\n            next.triggers.onInterval = { visibleMessages: vis };\n        }\n        if (next.triggers.onAfterMemory) {\n            next.triggers.onAfterMemory = { enabled: !!next.triggers.onAfterMemory.enabled };\n        }\n        if ('commands' in next.triggers) {\n            if (Array.isArray(next.triggers.commands)) {\n                next.triggers.commands = next.triggers.commands.filter(x => typeof x === 'string' && x.trim());\n            } else {\n                next.triggers.commands = [];\n            }\n        } else {\n            next.triggers.commands = ['sideprompt'];\n        }\n\n        merged.prompts[finalKey] = next;\n        added++;\n    }\n\n    await saveDoc(merged);\n    return { added, renamed };\n}\n\n/**\n * Recreate built-in Side Prompts by overwriting only the built-in keys with\n * the current-locale versions from getBuiltinTemplates().\n * Destructive for built-ins: resets their content, triggers, and settings to defaults.\n * User-created prompts (non built-in keys) are untouched.\n * @param {'overwrite'} mode - Only 'overwrite' is supported.\n * @returns {Promise<{ replaced: number }>} Count of built-in entries overwritten.\n */\nexport async function recreateBuiltInSidePrompts(mode = 'overwrite') {\n    if (mode !== 'overwrite') {\n        console.warn(`${MODULE_NAME}: Unsupported mode for recreateBuiltInSidePrompts: ${mode}; defaulting to 'overwrite'`);\n    }\n\n    const doc = await loadSidePrompts();\n    const builtins = getBuiltinTemplates();\n    const builtinKeys = Object.keys(builtins || {});\n    let replaced = 0;\n\n    if (!doc || !doc.prompts || typeof doc.prompts !== 'object') {\n        throw new Error(translate('Invalid side prompts document', 'STMemoryBooks_InvalidSidePromptsJSON'));\n    }\n\n    for (const key of builtinKeys) {\n        doc.prompts[key] = builtins[key];\n        replaced++;\n    }\n\n    await saveDoc(doc);\n    cachedDoc = doc;\n    console.log(`${MODULE_NAME}: Recreated built-in side prompts (overwrote ${replaced} entries)`);\n    return { replaced };\n}\n\n/**\n * Back-compat: List enabled templates by legacy type\n * - tracker => has onInterval trigger\n * - plotpoints => has onAfterMemory enabled\n * - scoreboard => has commands (manual), also onAfterMemory if originally withMemories\n */\nexport async function listEnabledByType(type) {\n    const t = String(type || '').toLowerCase();\n    const all = await listTemplates();\n\n    if (t === 'tracker') {\n        return all.filter(p => p.enabled && p.triggers?.onInterval && Number(p.triggers.onInterval.visibleMessages) >= 1);\n    }\n    if (t === 'plotpoints') {\n        return all.filter(p => p.enabled && p.triggers?.onAfterMemory?.enabled);\n    }\n    if (t === 'scoreboard') {\n        // enabled scoreboard historically was either manual or auto-with-memories\n        return all.filter(p => p.enabled && (Array.isArray(p.triggers?.commands) || p.triggers?.onAfterMemory?.enabled));\n    }\n    return [];\n}\n\n/**\n * New: List templates by trigger kind\n * - 'onInterval' => interval-enabled and template.enabled === true\n * - 'onAfterMemory' => after-memory enabled and template.enabled === true\n * - 'command:<name>' => has commands including <name> (enabled flag not required for manual run)\n */\nexport async function listByTrigger(kind) {\n    const all = await listTemplates();\n\n    if (kind === 'onInterval') {\n        return all.filter(p => p.enabled && p.triggers?.onInterval && Number(p.triggers.onInterval.visibleMessages) >= 1);\n    }\n    if (kind === 'onAfterMemory') {\n        return all.filter(p => p.enabled && p.triggers?.onAfterMemory?.enabled);\n    }\n    if (kind && kind.startsWith('command:')) {\n        const cmd = kind.slice('command:'.length).trim();\n        return all.filter(p => Array.isArray(p.triggers?.commands) && p.triggers.commands.some(c => c.toLowerCase() === cmd.toLowerCase()));\n    }\n    return [];\n}\n\n/**\n * Clear cache\n */\nexport function clearCache() {\n    cachedDoc = null;\n}\n",
    "import {\r\n  eventSource,\r\n  event_types,\r\n  chat,\r\n  chat_metadata,\r\n  saveSettingsDebounced,\r\n  characters,\r\n  this_chid,\r\n  settings as st_settings,\r\n} from \"../../../../script.js\";\r\nimport { Popup, POPUP_TYPE, POPUP_RESULT } from \"../../../popup.js\";\r\nimport {\r\n  extension_settings,\r\n} from \"../../../extensions.js\";\r\nimport { SlashCommandParser } from \"../../../slash-commands/SlashCommandParser.js\";\r\nimport { SlashCommand } from \"../../../slash-commands/SlashCommand.js\";\r\nimport { SlashCommandEnumValue } from \"../../../slash-commands/SlashCommandEnumValue.js\";\r\nimport {\r\n  ARGUMENT_TYPE,\r\n  SlashCommandArgument,\r\n} from \"../../../slash-commands/SlashCommandArgument.js\";\r\nimport { executeSlashCommands } from \"../../../slash-commands.js\";\r\nimport {\r\n  METADATA_KEY,\r\n  world_names,\r\n  loadWorldInfo,\r\n  saveWorldInfo,\r\n  reloadEditor,\r\n} from \"../../../world-info.js\";\r\nimport { lodash, Handlebars, DOMPurify } from \"../../../../lib.js\";\r\nimport { escapeHtml } from \"../../../utils.js\";\r\nimport {\r\n  compileScene,\r\n  createSceneRequest,\r\n  validateCompiledScene,\r\n  getSceneStats,\r\n} from \"./chatcompile.js\";\r\nimport { createMemory, parseAIJsonResponse } from \"./stmemory.js\";\r\nimport {\r\n  addMemoryToLorebook,\r\n  getDefaultTitleFormats,\r\n  identifyMemoryEntries,\r\n  getRangeFromMemoryEntry,\r\n} from \"./addlore.js\";\r\nimport { autoCreateLorebook } from \"./autocreate.js\";\r\nimport {\r\n  handleAutoSummaryMessageReceived,\r\n  handleAutoSummaryGroupFinished,\r\n  clearAutoSummaryState,\r\n} from \"./autosummary.js\";\r\nimport {\r\n  editProfile,\r\n  newProfile,\r\n  deleteProfile,\r\n  exportProfiles,\r\n  importProfiles,\r\n  validateAndFixProfiles,\r\n} from \"./profileManager.js\";\r\nimport {\r\n  getSceneMarkers,\r\n  setSceneRange,\r\n  clearScene,\r\n  updateAllButtonStates,\r\n  updateNewMessageButtonStates,\r\n  validateSceneMarkers,\r\n  handleMessageDeletion,\r\n  createSceneButtons,\r\n  getSceneData,\r\n  updateSceneStateCache,\r\n  getCurrentSceneState,\r\n  saveMetadataForCurrentContext,\r\n  getHighestMemoryProcessed\r\n} from \"./sceneManager.js\";\r\nimport { settingsTemplate } from \"./templates.js\";\r\nimport {\r\n  showConfirmationPopup,\r\n  fetchPreviousSummaries,\r\n  showMemoryPreviewPopup,\r\n} from \"./confirmationPopup.js\";\r\nimport {\r\n  getDefaultPrompt,\r\n  deepClone,\r\n  getUIModelSettings,\r\n  getCurrentApiInfo,\r\n  SELECTORS,\r\n  getCurrentMemoryBooksContext,\r\n  getEffectiveLorebookName,\r\n  showLorebookSelectionPopup,\r\n  readIntInput,\r\n  clampInt,\r\n} from \"./utils.js\";\r\nimport * as SummaryPromptManager from \"./summaryPromptManager.js\";\r\nimport {\r\n  MEMORY_GENERATION,\r\n  SCENE_MANAGEMENT,\r\n  UI_SETTINGS,\r\n} from \"./constants.js\";\r\nimport {\r\n  evaluateTrackers,\r\n  runAfterMemory,\r\n  runSidePrompt,\r\n} from \"./sidePrompts.js\";\r\nimport { showSidePromptsPopup } from \"./sidePromptsPopup.js\";\r\nimport { listTemplates } from \"./sidePromptsManager.js\";\r\nimport {\r\n  runArcAnalysisSequential,\r\n  commitArcs,\r\n  parseArcJsonResponse,\r\n} from \"./arcanalysis.js\";\r\nimport * as ArcPrompts from \"./arcAnalysisPromptManager.js\";\r\nimport { summaryPromptsTableTemplate } from \"./templatesSummaryPrompts.js\";\r\nimport {\r\n  t as __st_t_tag,\r\n  translate,\r\n  applyLocale,\r\n  addLocaleData,\r\n  getCurrentLocale,\r\n} from \"../../../i18n.js\";\r\nimport { localeData, loadLocaleJson } from \"./locales.js\";\r\nimport { getRegexScripts } from \"../../../extensions/regex/engine.js\";\r\nimport \"../../../../lib/select2.min.js\";\r\n\r\n/**\r\n * Async effective prompt that respects Summary Prompt Manager overrides\r\n */\r\nasync function getEffectivePromptAsync(profile) {\r\n  try {\r\n    if (profile?.prompt && String(profile.prompt).trim()) {\r\n      return profile.prompt;\r\n    }\r\n    if (profile?.preset) {\r\n      return await SummaryPromptManager.getPrompt(profile.preset);\r\n    }\r\n  } catch (e) {\r\n    console.warn(\r\n      translate(\r\n        \"STMemoryBooks: getEffectivePromptAsync fallback due to error:\",\r\n        \"index.warn.getEffectivePromptAsync\",\r\n      ),\r\n      e,\r\n    );\r\n  }\r\n  return getDefaultPrompt();\r\n}\r\n\r\nasync function handleHighestMemoryProcessedCommand() {\n  // Return string so it works well as a value in STscript/closures\n  return String(getHighestMemoryProcessed());\n}\n\nasync function handleSetHighestMemoryProcessedCommand(namedArgs, unnamedArgs) {\n  const raw = String(unnamedArgs || \"\").trim();\n\n  if (!raw) {\n    toastr.error(\n      translate(\n        \"Missing argument. Use: /stmb-set-highest <N|none>\",\n        \"STMemoryBooks_SetHighest_MissingArg\",\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n    return \"\";\n  }\n\n  const stmbData = getSceneMarkers() || {};\n  const lastIndex = chat.length - 1;\n\n  if (raw.toLowerCase() === \"none\") {\n    delete stmbData.highestMemoryProcessed;\n    delete stmbData.highestMemoryProcessedManuallySet;\n    saveMetadataForCurrentContext();\n    await refreshPopupContent();\n    toastr.success(\n      translate(\n        \"Last processed message cleared (no memories processed).\",\n        \"STMemoryBooks_SetHighest_Cleared\",\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n    return \"\";\n  }\n\n  const parsed = parseInt(raw, 10);\n  if (!Number.isFinite(parsed) || Number.isNaN(parsed)) {\n    toastr.error(\n      translate(\n        \"Invalid argument. Use: /stmb-set-highest <N|none>\",\n        \"STMemoryBooks_SetHighest_InvalidArg\",\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n    return \"\";\n  }\n\n  if (lastIndex < 0) {\n    toastr.error(\n      translate(\n        \"There are no messages in this chat yet.\",\n        \"STMemoryBooks_SetHighest_NoMessages\",\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n    return \"\";\n  }\n\n  if (parsed < 0) {\n    toastr.error(\n      translate(\n        \"Message IDs out of range. Valid range: 0-{{max}}\",\n        \"STMemoryBooks_SetHighest_OutOfRange\",\n        { max: lastIndex },\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n    return \"\";\n  }\n\n  const clamped = clampInt(parsed, 0, lastIndex);\n  if (clamped !== parsed) {\n    toastr.info(\n      translate(\n        \"Highest message is {{max}}, so last message processed has been set to {{max}}.\",\n        \"STMemoryBooks_SetHighest_Clamped\",\n        { max: lastIndex },\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n  }\n\n  stmbData.highestMemoryProcessed = clamped;\n  stmbData.highestMemoryProcessedManuallySet = true;\n  saveMetadataForCurrentContext();\n  await refreshPopupContent();\n\n  toastr.success(\n    translate(\n      \"Last processed message manually set to #{{value}}.\",\n      \"STMemoryBooks_SetHighest_SetTo\",\n      { value: clamped },\n    ),\n    translate(\"STMemoryBooks\", \"index.toast.title\"),\n  );\n\n  return \"\";\n}\n\n/**\n * Check if memory is currently being processed\n * @returns {boolean} True if memory creation is in progress\n */\nexport function isMemoryProcessing() {\n  return isProcessingMemory;\r\n}\r\n\r\nexport { currentProfile };\r\n\r\nconst MODULE_NAME = \"STMemoryBooks\";\r\n\r\nlet hasBeenInitialized = false;\r\n\r\n// Supported Chat Completion sources\r\nconst SUPPORTED_COMPLETION_SOURCES = [\r\n  \"openai\",\r\n  \"claude\",\r\n  \"openrouter\",\r\n  \"ai21\",\r\n  \"makersuite\",\r\n  \"vertexai\",\r\n  \"mistralai\",\r\n  \"custom\",\r\n  \"cohere\",\r\n  \"perplexity\",\r\n  \"groq\",\r\n  \"electronhub\",\r\n  \"nanogpt\",\r\n  \"deepseek\",\r\n  \"aimlapi\",\r\n  \"xai\",\r\n  \"pollinations\",\r\n  \"moonshot\",\r\n  \"fireworks\",\r\n  \"cometapi\",\r\n  \"azure_openai\",\r\n  \"zai\",\r\n  \"siliconflow\",\r\n];\r\n\r\nconst defaultSettings = {\n  moduleSettings: {\n    alwaysUseDefault: true,\n    showMemoryPreviews: false,\n    showNotifications: true,\n    unhideBeforeMemory: false,\n    refreshEditor: true,\n    maxTokens: 0,\n    tokenWarningThreshold: 50000,\n    defaultMemoryCount: 0,\n    autoClearSceneAfterMemory: false,\n    manualModeEnabled: false,\n    allowSceneOverlap: false,\n    autoHideMode: \"all\",\r\n    unhiddenEntriesCount: 2,\r\n    autoSummaryEnabled: false,\r\n    autoSummaryInterval: 50,\r\n    autoSummaryBuffer: 2,\r\n    autoCreateLorebook: false,\r\n    lorebookNameTemplate: \"LTM - {{char}} - {{chat}}\",\r\n    useRegex: false,\n    selectedRegexOutgoing: [],\n    selectedRegexIncoming: [],\n    // Arc creation ordering (applies to newly created arcs)\n    arcOrderMode: \"auto\",\n    arcOrderValue: 100,\n    arcReverseStart: 9999,\n  },\n  titleFormat: \"[000] - {{title}}\",\n  profiles: [], // Will be populated dynamically with current ST settings\n  defaultProfile: 0,\n  migrationVersion: 4,\n};\r\n\r\n// Current state variables\r\nlet currentPopupInstance = null;\r\nlet isProcessingMemory = false;\r\nlet isProcessingArc = false;\r\nlet currentProfile = null;\r\nlet isDryRun = false;\r\n/* Ephemeral failure state for AI errors */\r\nlet lastFailedAIError = null;\r\nlet lastFailureToast = null;\r\nlet lastFailedAIContext = null;\r\nlet lastFailedArcError = null;\r\nlet lastArcFailureToast = null;\r\nlet lastFailedArcContext = null;\r\n\r\n/* Settings cache for restoration */\r\nlet cachedSettings = null;\r\n\r\n// MutationObserver for chat message monitoring\r\nlet chatObserver = null;\r\nlet updateTimeout = null;\r\n\r\n/**\r\n * Process messages and return processed elements\r\n * @param {Node} node The DOM node to process.\r\n * @returns {Array} Array of message elements that had buttons added\r\n */\r\nfunction processNodeForMessages(node) {\r\n  const processedMessages = [];\r\n\r\n  // If the node itself is a message element\r\n  if (node.matches && node.matches(\"#chat .mes[mesid]\")) {\r\n    if (!node.querySelector(\".mes_stmb_start\")) {\r\n      createSceneButtons(node);\r\n      processedMessages.push(node);\r\n    }\r\n  }\r\n  // Find any message elements within the added node\r\n  else if (node.querySelectorAll) {\r\n    const newMessages = node.querySelectorAll(\"#chat .mes[mesid]\");\r\n    newMessages.forEach((mes) => {\r\n      if (!mes.querySelector(\".mes_stmb_start\")) {\r\n        createSceneButtons(mes);\r\n        processedMessages.push(mes);\r\n      }\r\n    });\r\n  }\r\n\r\n  return processedMessages;\r\n}\r\n\r\n/**\r\n * Chat observer with partial updates\r\n */\r\nfunction initializeChatObserver() {\r\n  // Clean up existing observer if any\r\n  if (chatObserver) {\r\n    chatObserver.disconnect();\r\n    chatObserver = null;\r\n  }\r\n\r\n  const chatContainer = document.getElementById(\"chat\");\r\n  if (!chatContainer) {\r\n    throw new Error(\r\n      translate(\r\n        \"STMemoryBooks: Chat container not found. SillyTavern DOM structure may have changed.\",\r\n        \"index.error.chatContainerNotFound\",\r\n      ),\r\n    );\r\n  }\r\n\r\n  // Ensure scene state is initialized before starting observer\r\n  const sceneState = getCurrentSceneState();\r\n  if (!sceneState || (sceneState.start === null && sceneState.end === null)) {\r\n    updateSceneStateCache();\r\n  }\r\n\r\n  chatObserver = new MutationObserver((mutations) => {\r\n    const newlyProcessedMessages = [];\r\n\r\n    for (const mutation of mutations) {\r\n      for (const node of mutation.addedNodes) {\r\n        if (node.nodeType === Node.ELEMENT_NODE) {\r\n          try {\r\n            // Collect all newly processed messages\r\n            const processed = processNodeForMessages(node);\r\n            newlyProcessedMessages.push(...processed);\r\n          } catch (error) {\r\n            console.error(\r\n              translate(\r\n                \"STMemoryBooks: Error processing new chat elements:\",\r\n                \"index.error.processingChatElements\",\r\n              ),\r\n              error,\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (newlyProcessedMessages.length > 0) {\r\n      // Debounce the state update to prevent excessive calls\r\n      clearTimeout(updateTimeout);\r\n      updateTimeout = setTimeout(() => {\r\n        try {\r\n          // Use partial update for new messages only\r\n          updateNewMessageButtonStates(newlyProcessedMessages);\r\n        } catch (error) {\r\n          console.error(\r\n            translate(\r\n              \"STMemoryBooks: Error updating button states:\",\r\n              \"index.error.updatingButtonStates\",\r\n            ),\r\n            error,\r\n          );\r\n        }\r\n      }, UI_SETTINGS.CHAT_OBSERVER_DEBOUNCE_MS);\r\n    }\r\n  });\r\n\r\n  // Start observing the chat container\r\n  chatObserver.observe(chatContainer, {\r\n    childList: true,\r\n    subtree: true,\r\n  });\r\n\r\n  console.log(\r\n    translate(\r\n      \"STMemoryBooks: Chat observer initialized\",\r\n      \"index.log.chatObserverInitialized\",\r\n    ),\r\n  );\r\n}\r\n\r\n/**\r\n * Clean up chat observer\r\n */\r\nfunction cleanupChatObserver() {\r\n  if (chatObserver) {\r\n    chatObserver.disconnect();\r\n    chatObserver = null;\r\n    console.log(\r\n      translate(\r\n        \"STMemoryBooks: Chat observer disconnected\",\r\n        \"index.log.chatObserverDisconnected\",\r\n      ),\r\n    );\r\n  }\r\n\r\n  if (updateTimeout) {\r\n    clearTimeout(updateTimeout);\r\n    updateTimeout = null;\r\n  }\r\n}\r\n\r\nfunction handleChatChanged() {\r\n  console.log(\r\n    translate(\r\n      \"STMemoryBooks: Chat changed - updating scene state\",\r\n      \"index.log.chatChanged\",\r\n    ),\r\n  );\r\n  updateSceneStateCache();\r\n  validateAndCleanupSceneMarkers();\r\n\r\n  setTimeout(() => {\r\n    try {\r\n      // Full update needed for chat changes\r\n      processExistingMessages();\r\n    } catch (error) {\r\n      console.error(\r\n        translate(\r\n          \"STMemoryBooks: Error processing messages after chat change:\",\r\n          \"index.error.processingMessagesAfterChange\",\r\n        ),\r\n        error,\r\n      );\r\n    }\r\n  }, UI_SETTINGS.CHAT_OBSERVER_DEBOUNCE_MS);\r\n}\r\n\r\n/**\r\n * Validate and clean up orphaned scene markers\r\n */\r\nfunction validateAndCleanupSceneMarkers() {\r\n  const stmbData = getSceneMarkers() || {};\r\n  const { sceneStart, sceneEnd } = stmbData;\r\n\r\n  // Check if we have orphaned scene markers (scene markers without active memory creation)\r\n  if (sceneStart !== null || sceneEnd !== null) {\r\n    console.log(\r\n      __st_t_tag`Found orphaned scene markers: start=${sceneStart}, end=${sceneEnd}`,\r\n    );\r\n\r\n    // Check if memory creation is actually in progress\r\n    if (\r\n      !isProcessingMemory &&\r\n      extension_settings[MODULE_NAME].moduleSettings.autoSummaryEnabled\r\n    ) {\r\n      clearScene();\r\n    }\r\n  }\r\n}\r\n\r\nasync function handleMessageReceived() {\r\n  try {\r\n    setTimeout(validateSceneMarkers, SCENE_MANAGEMENT.VALIDATION_DELAY_MS);\r\n    await handleAutoSummaryMessageReceived();\r\n    await evaluateTrackers();\r\n  } catch (error) {\r\n    console.error(\r\n      translate(\r\n        \"STMemoryBooks: Error in handleMessageReceived:\",\r\n        \"index.error.handleMessageReceived\",\r\n      ),\r\n      error,\r\n    );\r\n  }\r\n}\r\n\r\nasync function handleGroupWrapperFinished() {\r\n  try {\r\n    setTimeout(validateSceneMarkers, SCENE_MANAGEMENT.VALIDATION_DELAY_MS);\r\n    await handleAutoSummaryGroupFinished();\r\n    await evaluateTrackers();\r\n  } catch (error) {\r\n    console.error(\r\n      translate(\r\n        \"STMemoryBooks: Error in handleGroupWrapperFinished:\",\r\n        \"index.error.handleGroupWrapperFinished\",\r\n      ),\r\n      error,\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Slash command handlers\r\n */\r\nasync function handleCreateMemoryCommand(namedArgs, unnamedArgs) {\n  // Don't call getSceneData() here because it compiles the scene and will\n  // return null for fully-hidden selections (which prevents /unhideBeforeMemory\n  // from running inside initiateMemoryCreation).\n  const markers = getSceneMarkers() || {};\n  if (markers.sceneStart == null || markers.sceneEnd == null) {\n    console.error(\n      translate(\n        \"STMemoryBooks: No scene markers set for createMemory command\",\n        \"index.error.noSceneMarkersForCreate\",\n      ),\n    );\n    toastr.error(\n      translate(\n        \"No scene markers set. Use chevron buttons to mark start and end points first.\",\n        \"STMemoryBooks_NoSceneMarkersToastr\",\n      ),\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\n    );\n    return \"\";\n  }\n\n  initiateMemoryCreation();\n  return \"\";\n}\n\r\nasync function handleSceneMemoryCommand(namedArgs, unnamedArgs) {\r\n  const range = String(unnamedArgs || \"\").trim();\r\n\r\n  if (!range) {\r\n    toastr.error(\r\n      translate(\r\n        \"Missing range argument. Use: /scenememory X-Y (e.g., /scenememory 10-15)\",\r\n        \"STMemoryBooks_MissingRangeArgument\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  const match = range.match(/^(\\d+)\\s*[-]\\s*(\\d+)$/);\r\n\r\n  if (!match) {\r\n    toastr.error(\r\n      translate(\r\n        \"Invalid format. Use: /scenememory X-Y (e.g., /scenememory 10-15)\",\r\n        \"STMemoryBooks_InvalidFormat\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  const startId = Number(match[1]);\r\n  const endId = Number(match[2]);\r\n\r\n  if (!Number.isFinite(startId) || !Number.isFinite(endId)) {\r\n    toastr.error(\r\n      translate(\r\n        \"Invalid message IDs parsed. Use: /scenememory X-Y (e.g., /scenememory 10-15)\",\r\n        \"STMemoryBooks_InvalidMessageIDs\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  // Validate range logic (start = end is valid for single message)\r\n  if (startId > endId) {\r\n    toastr.error(\r\n      translate(\r\n        \"Start message cannot be greater than end message\",\r\n        \"STMemoryBooks_StartGreaterThanEnd\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  // IMPORTANT: Use the global chat array for validation to match compileScene()\r\n  const activeChat = chat;\r\n\r\n  // Validate message IDs exist in current chat\r\n  if (startId < 0 || endId >= activeChat.length) {\r\n    toastr.error(\r\n      __st_t_tag`Message IDs out of range. Valid range: 0-${activeChat.length - 1}`,\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  // check if messages actually exist\r\n  if (!activeChat[startId] || !activeChat[endId]) {\r\n    toastr.error(\r\n      translate(\r\n        \"One or more specified messages do not exist\",\r\n        \"STMemoryBooks_MessagesDoNotExist\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  // Atomically set both scene markers for /scenememory\r\n  setSceneRange(startId, endId);\r\n\r\n  const context = getCurrentMemoryBooksContext();\r\n  const contextMsg = context.isGroupChat\r\n    ? ` in group \"${context.groupName}\"`\r\n    : \"\";\r\n  toastr.info(\r\n    __st_t_tag`Scene set: messages ${startId}-${endId}${contextMsg}`,\r\n    translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n  );\r\n\r\n  initiateMemoryCreation();\r\n\r\n  return \"\";\r\n}\r\n\r\nasync function handleNextMemoryCommand(namedArgs, unnamedArgs) {\r\n  try {\r\n    // Prevent re-entrancy\r\n    if (isProcessingMemory) {\r\n      toastr.info(\r\n        translate(\r\n          \"Memory creation is already in progress\",\r\n          \"STMemoryBooks_MemoryAlreadyInProgress\",\r\n        ),\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n\r\n    // Validate lorebook exists (fast-fail UX);\r\n    // initiateMemoryCreation will validate again before running\r\n    const lorebookValidation = await validateLorebook();\r\n    if (!lorebookValidation.valid) {\r\n      toastr.error(\r\n        translate(\r\n          \"No lorebook available: \" + lorebookValidation.error,\r\n          \"STMemoryBooks_NoLorebookAvailable\",\r\n        ),\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n\r\n    // Compute next range since last memory\r\n    const stmbData = getSceneMarkers() || {};\r\n    const lastIndex = chat.length - 1;\r\n\r\n    if (lastIndex < 0) {\r\n      toastr.info(\r\n        translate(\r\n          \"There are no messages to summarize yet.\",\r\n          \"STMemoryBooks_NoMessagesToSummarize\",\r\n        ),\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n\r\n    const highestProcessed =\r\n      typeof stmbData.highestMemoryProcessed === \"number\"\r\n        ? stmbData.highestMemoryProcessed\r\n        : null;\r\n\r\n    const sceneStart = highestProcessed === null ? 0 : highestProcessed + 1;\r\n    const sceneEnd = lastIndex;\r\n\r\n    if (sceneStart > sceneEnd) {\r\n      toastr.info(\r\n        translate(\r\n          \"No new messages since the last memory.\",\r\n          \"STMemoryBooks_NoNewMessagesSinceLastMemory\",\r\n        ),\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n\r\n    // Set scene range and run the standard memory pipeline\r\n    setSceneRange(sceneStart, sceneEnd);\r\n    await initiateMemoryCreation();\r\n  } catch (error) {\r\n    console.error(\r\n      translate(\r\n        \"STMemoryBooks: /nextmemory failed:\",\r\n        \"index.error.nextMemoryFailed\",\r\n      ),\r\n      error,\r\n    );\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to run /nextmemory: \" + error.message,\r\n        \"STMemoryBooks_NextMemoryFailed\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n  }\r\n  return \"\";\r\n}\r\n\r\n/**\r\n * Slash: /sideprompt (with optional name/range)\r\n * If no args, open a picker for discoverability.\r\n */\r\nasync function handleSidePromptCommand(namedArgs, unnamedArgs) {\r\n  const raw = String(unnamedArgs || \"\").trim();\r\n  if (!raw) {\r\n    toastr.info(\r\n      translate(\r\n        'SidePrompt guide: Type a template name after the space to see suggestions. Usage: /sideprompt \"Name\" [X-Y]. Quote names with spaces.',\r\n        \"STMemoryBooks_SidePromptGuide\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  // If user typed partial name without range and it doesn't exactly match,\r\n  // try a quick best effort: if multiple results, show picker filtered; else run directly.\r\n  const parts =\r\n    raw.match(/^[\"']([^\"']+)[\"']\\s*(.*)$/) ||\r\n    raw.match(/^(.+?)(\\s+\\d+\\s*[-]\\s*\\d+)?$/);\r\n  const namePart = parts ? (parts[1] || raw).trim() : raw;\r\n\r\n  try {\r\n    // Load and filter\r\n    const templates = await listTemplates();\r\n    const candidates = templates.filter((t) =>\r\n      t.name.toLowerCase().includes(namePart.toLowerCase()),\r\n    );\r\n    if (candidates.length > 1) {\r\n      const top = candidates\r\n        .slice(0, 5)\r\n        .map((t) => t.name)\r\n        .join(\", \");\r\n      const more =\r\n        candidates.length > 5 ? `, +${candidates.length - 5} more` : \"\";\r\n      toastr.info(\r\n        __st_t_tag`Multiple matches: ${top}${more}. Refine the name or use quotes. Usage: /sideprompt \"Name\" [X-Y]`,\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n    // Fall back to direct run (runSidePrompt will resolve fuzzy or error toast)\r\n    return runSidePrompt(raw);\r\n  } catch {\r\n    // Fallback to direct run\r\n    return runSidePrompt(raw);\r\n  }\r\n}\r\n\r\n/**\r\n * Slash: /sideprompt-on and /sideprompt-off\r\n * Toggle the same underlying \"enabled\" flag as the UI checkbox (stmb-sp-edit-enabled).\r\n * Uses dynamic import to avoid modifying top-level imports.\r\n */\r\nasync function handleSidePromptToggle(namedArgs, unnamedArgs, enabled) {\r\n  const raw = String(unnamedArgs || \"\").trim();\r\n  if (!raw) {\r\n    toastr.error(\r\n      translate(\r\n        enabled\r\n          ? 'Missing name. Use: /sideprompt-on \"Name\" OR /sideprompt-on all'\r\n          : 'Missing name. Use: /sideprompt-off \"Name\" OR /sideprompt-off all',\r\n        \"STMemoryBooks_SidePromptToggle_MissingName\",\r\n      ),\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n    return \"\";\r\n  }\r\n\r\n  try {\r\n    const { findTemplateByName, upsertTemplate, listTemplates } =\r\n      await import(\"./sidePromptsManager.js\");\r\n\r\n    if (raw.toLowerCase() === \"all\") {\r\n      const templates = await listTemplates();\r\n      let changed = 0;\r\n      for (const p of templates) {\r\n        if (p.enabled !== enabled) {\r\n          await upsertTemplate({ key: p.key, enabled });\r\n          changed++;\r\n        }\r\n      }\r\n      try {\r\n        window.dispatchEvent(new CustomEvent(\"stmb-sideprompts-updated\"));\r\n      } catch (e) {\r\n        /* noop */\r\n      }\r\n      toastr.success(\r\n        __st_t_tag`${enabled ? \"Enabled\" : \"Disabled\"} ${changed} side prompt${changed === 1 ? \"\" : \"s\"}`,\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n\r\n    const tpl = await findTemplateByName(raw);\r\n    if (!tpl) {\r\n      toastr.error(\r\n        __st_t_tag`Side Prompt not found: ${raw}`,\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n    if (tpl.enabled === enabled) {\r\n      toastr.info(\r\n        __st_t_tag`\"${tpl.name}\" is already ${enabled ? \"enabled\" : \"disabled\"}`,\r\n        translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n      );\r\n      return \"\";\r\n    }\r\n    await upsertTemplate({ key: tpl.key, enabled });\r\n    try {\r\n      window.dispatchEvent(new CustomEvent(\"stmb-sideprompts-updated\"));\r\n    } catch (e) {\r\n      /* noop */\r\n    }\r\n    toastr.success(\r\n      __st_t_tag`${enabled ? \"Enabled\" : \"Disabled\"} \"${tpl.name}\"`,\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n  } catch (e) {\r\n    console.error(\"STMemoryBooks: sideprompt enable/disable failed:\", e);\r\n    toastr.error(\r\n      __st_t_tag`Failed to toggle side prompt: ${e.message}`,\r\n      translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n    );\r\n  }\r\n  return \"\";\r\n}\r\n\r\nasync function handleSidePromptOnCommand(namedArgs, unnamedArgs) {\r\n  return handleSidePromptToggle(namedArgs, unnamedArgs, true);\r\n}\r\n\r\nasync function handleSidePromptOffCommand(namedArgs, unnamedArgs) {\r\n  return handleSidePromptToggle(namedArgs, unnamedArgs, false);\r\n}\r\n\r\n/**\r\n * Side Prompt names cache for autocomplete\r\n */\r\nlet sidePromptNameCache = [];\r\nasync function refreshSidePromptCache() {\r\n  try {\r\n    const tpls = await listTemplates();\r\n    sidePromptNameCache = (tpls || [])\r\n      .filter((t) => {\r\n        const cmds = t?.triggers?.commands;\r\n        // Back-compat: if commands is missing, treat as manual-enabled for suggestions\r\n        if (!(\"commands\" in (t?.triggers || {}))) return true;\r\n        return (\r\n          Array.isArray(cmds) &&\r\n          cmds.some((c) => String(c).toLowerCase() === \"sideprompt\")\r\n        );\r\n      })\r\n      .map((t) => t.name);\r\n  } catch (e) {\r\n    console.warn(\r\n      translate(\r\n        \"STMemoryBooks: side prompt cache refresh failed\",\r\n        \"index.warn.sidePromptCacheRefreshFailed\",\r\n      ),\r\n      e,\r\n    );\r\n  }\r\n}\r\nwindow.addEventListener(\"stmb-sideprompts-updated\", refreshSidePromptCache);\r\n// Preload cache early so suggestions are available even before init() completes\r\ntry {\r\n  refreshSidePromptCache();\r\n} catch (e) {\r\n  /* noop */\r\n}\r\n\r\n// Synchronous enum provider for slash command suggestions (mirrors extension-enum pattern)\r\nconst sidePromptTemplateEnumProvider = () =>\r\n  sidePromptNameCache.map((n) => new SlashCommandEnumValue(n));\r\n\r\n/**\r\n * Helper: build triggers badges for prompt picker\r\n */\r\nfunction getSPTriggersSummary(tpl) {\r\n  const badges = [];\r\n  const trig = tpl?.triggers || {};\r\n  if (trig.onInterval && Number(trig.onInterval.visibleMessages) >= 1) {\r\n    badges.push(`Interval:${Number(trig.onInterval.visibleMessages)}`);\r\n  }\r\n  if (trig.onAfterMemory && !!trig.onAfterMemory.enabled) {\r\n    badges.push(\"AfterMemory\");\r\n  }\r\n  if (\r\n    trig.commands &&\r\n    Array.isArray(trig.commands) &&\r\n    trig.commands.some((c) => String(c).toLowerCase() === \"sideprompt\")\r\n  ) {\r\n    badges.push(\"Manual\");\r\n  }\r\n  return badges;\r\n}\r\n\r\n/**\r\n * Initialize and validate extension settings\r\n */\r\nfunction initializeSettings() {\r\n  extension_settings.STMemoryBooks =\r\n    extension_settings.STMemoryBooks || deepClone(defaultSettings);\r\n\r\n  // Migration logic for versions 3-4: Add dynamic profile and clean up titleFormat\r\n  const currentVersion = extension_settings.STMemoryBooks.migrationVersion ?? 1;\r\n  if (currentVersion < 4) {\r\n    // Check if dynamic profile already exists (in case of partial migration)\r\n    const hasBuiltinCurrentSTProfile =\r\n      extension_settings.STMemoryBooks.profiles?.some(\r\n        (p) =>\r\n          p?.isBuiltinCurrentST ||\r\n          p?.useDynamicSTSettings ||\r\n          (p?.connection?.api === \"current_st\" &&\r\n            p?.name === \"Current SillyTavern Settings\"),\r\n      );\r\n\r\n    if (!hasBuiltinCurrentSTProfile) {\r\n      // Add dynamic profile for existing installations\r\n      if (!extension_settings.STMemoryBooks.profiles) {\r\n        extension_settings.STMemoryBooks.profiles = [];\r\n      }\r\n\r\n      // Insert dynamic profile at the beginning of the array\r\n      const dynamicProfile = {\r\n        name: \"Current SillyTavern Settings\",\r\n        isBuiltinCurrentST: true,\r\n        connection: {\r\n          api: \"current_st\",\r\n        },\r\n        preset: \"summary\",\r\n        constVectMode: \"link\",\r\n        position: 0,\r\n        orderMode: \"auto\",\r\n        orderValue: 100,\r\n        preventRecursion: false,\r\n        delayUntilRecursion: true,\r\n      };\r\n\r\n      extension_settings.STMemoryBooks.profiles.unshift(dynamicProfile);\r\n\r\n      // Adjust default profile index since we inserted at the beginning\r\n      if (extension_settings.STMemoryBooks.defaultProfile !== undefined) {\r\n        extension_settings.STMemoryBooks.defaultProfile += 1;\r\n      }\r\n\r\n      console.log(\r\n        __st_t_tag`${MODULE_NAME}: Added dynamic profile for existing installation (migration to v3)`,\r\n      );\r\n    }\r\n\r\n    // Clean up any existing dynamic profiles that may have titleFormat\r\n    extension_settings.STMemoryBooks.profiles.forEach((profile) => {\r\n      if (profile.useDynamicSTSettings && profile.titleFormat) {\r\n        delete profile.titleFormat;\r\n        console.log(\r\n          __st_t_tag`${MODULE_NAME}: Removed static titleFormat from dynamic profile`,\r\n        );\r\n      }\r\n    });\r\n\r\n    // Update migration version\r\n    extension_settings.STMemoryBooks.migrationVersion = 4;\r\n    saveSettingsDebounced();\r\n  }\r\n\r\n  // If this is a fresh install (no profiles), create default profile that dynamically uses ST settings\r\n  if (\r\n    !extension_settings.STMemoryBooks.profiles ||\r\n    extension_settings.STMemoryBooks.profiles.length === 0\r\n  ) {\r\n    const dynamicProfile = {\r\n      name: \"Current SillyTavern Settings\",\r\n      isBuiltinCurrentST: true,\r\n      connection: {\r\n        api: \"current_st\",\r\n      },\r\n      preset: \"summary\",\r\n      constVectMode: \"link\",\r\n      position: 0,\r\n      orderMode: \"auto\",\r\n      orderValue: 100,\r\n      preventRecursion: false,\r\n      delayUntilRecursion: true,\r\n    };\r\n\r\n    extension_settings.STMemoryBooks.profiles = [dynamicProfile];\r\n    console.log(\r\n      __st_t_tag`${MODULE_NAME}: Created dynamic profile for fresh installation`,\r\n    );\r\n  }\r\n\r\n  const validationResult = validateSettings(extension_settings.STMemoryBooks);\r\n\r\n  // Also validate profiles structure\r\n  const profileValidation = validateAndFixProfiles(\r\n    extension_settings.STMemoryBooks,\r\n  );\r\n  if (profileValidation.fixes.length > 0) {\r\n    console.log(\r\n      __st_t_tag`${MODULE_NAME}: Applied profile fixes:`,\r\n      profileValidation.fixes,\r\n    );\r\n    saveSettingsDebounced();\r\n  }\r\n\r\n  return validationResult;\r\n}\r\n\r\n/**\r\n * Validate settings structure and fix any issues\r\n */\r\nfunction validateSettings(settings) {\n  if (!settings.profiles || settings.profiles.length === 0) {\r\n    // Avoid creating [undefined]; allow downstream validator to create a proper dynamic profile.\r\n    settings.profiles = [];\r\n    settings.defaultProfile = 0;\r\n  }\r\n\r\n  if (settings.defaultProfile >= settings.profiles.length) {\r\n    settings.defaultProfile = 0;\r\n  }\r\n\r\n  if (!settings.moduleSettings) {\n    settings.moduleSettings = deepClone(defaultSettings.moduleSettings);\n  }\n\n  // Validate maxTokens (0 = no override; use current ST settings)\n  if (settings.moduleSettings.maxTokens === undefined || settings.moduleSettings.maxTokens === null) {\n    settings.moduleSettings.maxTokens = 0;\n  } else {\n    const mt = Number.parseInt(settings.moduleSettings.maxTokens, 10);\n    settings.moduleSettings.maxTokens = Number.isFinite(mt) && mt > 0 ? mt : 0;\n  }\n\n  if (\n    !settings.moduleSettings.tokenWarningThreshold ||\n    settings.moduleSettings.tokenWarningThreshold < 1000\n  ) {\n    settings.moduleSettings.tokenWarningThreshold = 50000;\r\n  }\r\n\r\n  settings.moduleSettings.defaultMemoryCount = clampInt(settings.moduleSettings.defaultMemoryCount ?? 0, 0, 7);\r\n  if (\r\n    settings.moduleSettings.unhiddenEntriesCount === undefined ||\r\n    settings.moduleSettings.unhiddenEntriesCount === null\r\n  ) {\r\n    settings.moduleSettings.unhiddenEntriesCount = 2;\r\n  }\r\n\r\n  // Validate auto-summary settings\r\n  if (settings.moduleSettings.autoSummaryEnabled === undefined) {\r\n    settings.moduleSettings.autoSummaryEnabled = false;\r\n  }\r\n  if (\r\n    settings.moduleSettings.autoSummaryInterval === undefined ||\r\n    settings.moduleSettings.autoSummaryInterval < 10\r\n  ) {\r\n    settings.moduleSettings.autoSummaryInterval = 100;\r\n  }\r\n\r\n  settings.moduleSettings.autoSummaryBuffer = clampInt(settings.moduleSettings.autoSummaryBuffer ?? 0, 0, 50);\r\n\r\n  // Validate auto-create lorebook setting - always defaults to false\r\n  if (settings.moduleSettings.autoCreateLorebook === undefined) {\r\n    settings.moduleSettings.autoCreateLorebook = false;\r\n  }\r\n\r\n  // Validate unhide-before-memory setting (defaults to false)\r\n  if (settings.moduleSettings.unhideBeforeMemory === undefined) {\r\n    settings.moduleSettings.unhideBeforeMemory = false;\r\n  }\r\n\r\n  // Validate lorebook name template\n  if (!settings.moduleSettings.lorebookNameTemplate) {\n    settings.moduleSettings.lorebookNameTemplate = \"LTM - {{char}} - {{chat}}\";\n  }\n\n  // Validate arc ordering settings (for newly created arcs)\n  if (\n    settings.moduleSettings.arcOrderMode === undefined ||\n    settings.moduleSettings.arcOrderMode === null\n  ) {\n    settings.moduleSettings.arcOrderMode = \"auto\";\n  }\n  const aom = String(settings.moduleSettings.arcOrderMode || \"\").toLowerCase();\n  settings.moduleSettings.arcOrderMode =\n    aom === \"manual\" || aom === \"reverse\" ? aom : \"auto\";\n\n  if (\n    settings.moduleSettings.arcOrderValue === undefined ||\n    settings.moduleSettings.arcOrderValue === null\n  ) {\n    settings.moduleSettings.arcOrderValue = 100;\n  } else {\n    const ov = Number(settings.moduleSettings.arcOrderValue);\n    settings.moduleSettings.arcOrderValue = Number.isFinite(ov)\n      ? clampInt(Math.trunc(ov), 0, 9999)\n      : 100;\n  }\n\n  if (\n    settings.moduleSettings.arcReverseStart === undefined ||\n    settings.moduleSettings.arcReverseStart === null\n  ) {\n    settings.moduleSettings.arcReverseStart = 9999;\n  } else {\n    const rs = Number(settings.moduleSettings.arcReverseStart);\n    settings.moduleSettings.arcReverseStart = Number.isFinite(rs)\n      ? clampInt(Math.trunc(rs), 100, 9999)\n      : 9999;\n  }\n\n  // Ensure mutual exclusion: both cannot be true at the same time\n  if (\n    settings.moduleSettings.manualModeEnabled &&\n    settings.moduleSettings.autoCreateLorebook\n  ) {\r\n    // If both are somehow true, prioritize manual mode (since it was added first)\r\n    settings.moduleSettings.autoCreateLorebook = false;\r\n    console.warn(\r\n      translate(\r\n        \"STMemoryBooks: Both manualModeEnabled and autoCreateLorebook were true - setting autoCreateLorebook to false\",\r\n        \"index.warn.mutualExclusion\",\r\n      ),\r\n    );\r\n  }\r\n\r\n  // Migrate to version 2 if needed (JSON-based architecture)\r\n  if (!settings.migrationVersion || settings.migrationVersion < 2) {\r\n    console.log(\r\n      __st_t_tag`${MODULE_NAME}: Migrating to JSON-based architecture (v2)`,\r\n    );\r\n    settings.migrationVersion = 2;\r\n    // Update any old tool-based prompts to JSON prompts\r\n    settings.profiles.forEach((profile) => {\r\n      if (profile.prompt && profile.prompt.includes(\"createMemory\")) {\r\n        console.log(\r\n          __st_t_tag`${MODULE_NAME}: Updating profile \"${profile.name}\" to use JSON output`,\r\n        );\r\n        profile.prompt = getDefaultPrompt(); // Reset to new JSON-based default\r\n      }\r\n    });\r\n  }\r\n\r\n  return settings;\r\n}\r\n\r\n/**\r\n * Validate lorebook and return status with data\r\n */\r\nexport async function validateLorebook(skipAutoCreate = false) {\r\n  const settings = extension_settings.STMemoryBooks;\r\n  let lorebookName = await getEffectiveLorebookName();\r\n\r\n  // Only auto-create if not skipping\r\n  if (!skipAutoCreate) {\r\n    // Check if auto-create is enabled and we're not in manual mode\r\n    if (\r\n      !lorebookName &&\r\n      settings?.moduleSettings?.autoCreateLorebook &&\r\n      !settings?.moduleSettings?.manualModeEnabled\r\n    ) {\r\n      // Auto-create lorebook using template\r\n      const template =\r\n        settings.moduleSettings.lorebookNameTemplate ||\r\n        \"LTM - {{char}} - {{chat}}\";\r\n      const result = await autoCreateLorebook(template, \"chat\");\r\n\r\n      if (result.success) {\r\n        lorebookName = result.name;\r\n      } else {\r\n        return { valid: false, error: result.error };\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!lorebookName) {\r\n    return { valid: false, error: \"No lorebook available or selected.\" };\r\n  }\r\n\r\n  if (!world_names || !world_names.includes(lorebookName)) {\r\n    return {\r\n      valid: false,\r\n      error: `Selected lorebook \"${lorebookName}\" not found.`,\r\n    };\r\n  }\r\n\r\n  try {\r\n    const lorebookData = await loadWorldInfo(lorebookName);\r\n    return { valid: !!lorebookData, data: lorebookData, name: lorebookName };\r\n  } catch (error) {\r\n    return { valid: false, error: \"Failed to load the selected lorebook.\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Extract and validate settings from confirmation popup or defaults\r\n */\r\nasync function showAndGetMemorySettings(\r\n  sceneData,\r\n  lorebookValidation,\r\n  selectedProfileIndex = null,\r\n) {\r\n  const settings = initializeSettings();\r\n  const tokenThreshold = settings.moduleSettings.tokenWarningThreshold ?? 30000;\r\n  const shouldShowConfirmation = !settings.moduleSettings.alwaysUseDefault || sceneData.estimatedTokens > tokenThreshold;\r\n\r\n  let confirmationResult = null;\r\n\r\n  if (shouldShowConfirmation) {\r\n    // Use the passed profile index, or fall back to default\r\n    const profileIndex =\r\n      selectedProfileIndex !== null\r\n        ? selectedProfileIndex\r\n        : settings.defaultProfile;\r\n\r\n    // Show simplified confirmation popup with selected profile\r\n    confirmationResult = await showConfirmationPopup(\r\n      sceneData,\r\n      settings,\r\n      getUIModelSettings(),\r\n      getCurrentApiInfo(),\r\n      chat_metadata,\r\n      profileIndex,\r\n    );\r\n\r\n    if (!confirmationResult.confirmed) {\r\n      return null; // User cancelled\r\n    }\r\n  } else {\r\n    // Use default profile without confirmation\r\n    const selectedProfile = settings.profiles[settings.defaultProfile];\r\n    confirmationResult = {\r\n      confirmed: true,\r\n      profileSettings: {\r\n        ...selectedProfile,\r\n        effectivePrompt: await getEffectivePromptAsync(selectedProfile),\r\n      },\r\n      advancedOptions: {\r\n        memoryCount: clampInt(settings.moduleSettings.defaultMemoryCount ?? 0, 0, 7),\r\n        overrideSettings: false,\r\n      },\r\n    };\r\n  }\r\n\r\n  // Build effective connection settings\r\n  const { profileSettings, advancedOptions } = confirmationResult;\r\n\r\n  // Check if this profile should dynamically use ST settings\r\n  if (\r\n    profileSettings?.connection?.api === \"current_st\" ||\r\n    advancedOptions.overrideSettings\r\n  ) {\r\n    const currentApiInfo = getCurrentApiInfo();\r\n    const currentSettings = getUIModelSettings();\r\n\r\n    profileSettings.effectiveConnection = {\r\n      api: currentApiInfo.completionSource || \"openai\",\r\n      model: currentSettings.model || \"\",\r\n      temperature: currentSettings.temperature ?? 0.7,\r\n    };\r\n\r\n    if (profileSettings.useDynamicSTSettings) {\r\n      console.log(\r\n        \"STMemoryBooks: Using dynamic ST settings profile - current settings:\",\r\n        profileSettings.effectiveConnection,\r\n      );\r\n    } else {\r\n      console.log(\r\n        \"STMemoryBooks: Using current SillyTavern settings override for memory creation\",\r\n      );\r\n    }\r\n  } else {\r\n    profileSettings.effectiveConnection = { ...profileSettings.connection };\r\n    console.log(\r\n      \"STMemoryBooks: Using profile connection settings for memory creation\",\r\n    );\r\n  }\r\n\r\n  return {\r\n    profileSettings,\r\n    summaryCount: advancedOptions.memoryCount ?? 0,\r\n    tokenThreshold,\r\n    settings,\r\n  };\r\n}\r\n\r\n/**\r\n * Determine if an error is retryable\r\n */\r\nfunction isRetryableError(error) {\r\n  // Respect structured recoverability for AIResponseError\r\n  if (error && error.name === \"AIResponseError\") {\r\n    if (typeof error.recoverable === \"boolean\") {\r\n      return error.recoverable;\r\n    }\r\n    // If code hints at truncation, treat as retryable\r\n    if (error.code && String(error.code).toUpperCase().includes(\"TRUNCATION\")) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  // Don't retry these error types\r\n  const nonRetryableErrors = [\r\n    \"TokenWarningError\", // User needs to select smaller range\r\n    \"InvalidProfileError\", // Configuration issue\r\n  ];\r\n\r\n  if (nonRetryableErrors.includes(error?.name)) {\r\n    return false;\r\n  }\r\n\r\n  // Don't retry validation errors\r\n  if (\r\n    error?.message &&\r\n    (error.message.includes(\"Scene compilation failed\") ||\r\n      error.message.includes(\"Invalid memory result\") ||\r\n      error.message.includes(\"Invalid lorebook\"))\r\n  ) {\r\n    return false;\r\n  }\r\n\r\n  // Retry AI response errors and network-related issues by default\r\n  return true;\r\n}\r\n\r\n/**\r\n * Execute the core memory generation process - now with retry logic and BULLETPROOF settings restoration\r\n */\r\nasync function executeMemoryGeneration(\r\n  sceneData,\r\n  lorebookValidation,\r\n  effectiveSettings,\r\n  retryCount = 0,\r\n) {\r\n  const { profileSettings, summaryCount, tokenThreshold, settings } =\r\n    effectiveSettings;\r\n  currentProfile = profileSettings;\r\n  let compiledScene = null;\r\n  let memoryFetchResult = null;\r\n  let sceneStats = null;\r\n\r\n  // Optional global conversion of recursion flags on existing STMB entries\r\n  try {\r\n    if (\r\n      settings?.moduleSettings?.convertExistingRecursion &&\r\n      lorebookValidation?.valid &&\r\n      lorebookValidation.data?.entries\r\n    ) {\r\n      const entriesList = identifyMemoryEntries(lorebookValidation.data) || [];\r\n      const earliest = entriesList.length > 0 ? entriesList[0].entry : null;\r\n\r\n      const targetPrevent = !!profileSettings.preventRecursion;\r\n      const targetDelay = !!profileSettings.delayUntilRecursion;\r\n\r\n      let needsConversion = false;\r\n      if (!earliest) {\r\n        // No STMB entries, nothing to do\r\n        needsConversion = false;\r\n      } else {\r\n        const ePrev = !!earliest.preventRecursion;\r\n        const eDelay = !!earliest.delayUntilRecursion;\r\n        needsConversion = ePrev !== targetPrevent || eDelay !== targetDelay;\r\n      }\r\n\r\n      if (needsConversion) {\r\n        let examined = 0;\r\n        let updated = 0;\r\n        const allEntries = Object.values(lorebookValidation.data.entries || {});\r\n        for (const entry of allEntries) {\r\n          if (entry && entry.stmemorybooks === true) {\r\n            examined++;\r\n            const prevChanged = entry.preventRecursion !== targetPrevent;\r\n            const delayChanged = entry.delayUntilRecursion !== targetDelay;\r\n            if (prevChanged || delayChanged) {\r\n              entry.preventRecursion = targetPrevent;\r\n              entry.delayUntilRecursion = targetDelay;\r\n              updated++;\r\n            }\r\n          }\r\n        }\r\n\r\n        if (updated > 0) {\r\n          try {\r\n            await saveWorldInfo(\r\n              lorebookValidation.name,\r\n              lorebookValidation.data,\r\n              true,\r\n            );\r\n            if (settings.moduleSettings?.refreshEditor) {\r\n              try {\r\n                reloadEditor(lorebookValidation.name);\r\n              } catch (e) {\r\n                /* noop */\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.warn(\r\n              \"STMemoryBooks: Failed to save lorebook during recursion conversion:\",\r\n              e,\r\n            );\r\n          }\r\n          try {\r\n            toastr.info(\r\n              __st_t_tag`Updated recursion flags on ${updated} of ${examined} memory entr${updated === 1 ? \"y\" : \"ies\"}`,\r\n              \"STMemoryBooks\",\r\n            );\r\n          } catch (e) {\r\n            /* noop */\r\n          }\r\n        }\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn(\"STMemoryBooks: convertExistingRecursion check failed:\", e);\r\n  }\r\n\r\n  const maxRetries = MEMORY_GENERATION.MAX_RETRIES;\r\n\r\n  try {\r\n    // Create and compile scene first\r\n    const sceneRequest = createSceneRequest(\r\n      sceneData.sceneStart,\r\n      sceneData.sceneEnd,\r\n    );\r\n    compiledScene = compileScene(sceneRequest);\r\n\r\n    // Validate compiled scene\r\n    const validation = validateCompiledScene(compiledScene);\r\n    if (!validation.valid) {\r\n      throw new Error(\r\n        `Scene compilation failed: ${validation.errors.join(\", \")}`,\r\n      );\r\n    }\r\n\r\n    // Fetch previous memories if requested\r\n    let previousMemories = [];\r\n    memoryFetchResult = {\r\n      summaries: [],\r\n      actualCount: 0,\r\n      requestedCount: 0,\r\n    };\r\n    if (summaryCount > 0) {\r\n      // Fetch previous memories silently (no intermediate toast)\r\n      memoryFetchResult = await fetchPreviousSummaries(\r\n        summaryCount,\r\n        settings,\r\n        chat_metadata,\r\n      );\r\n      previousMemories = memoryFetchResult.summaries;\r\n\r\n      if (memoryFetchResult.actualCount > 0) {\r\n        if (memoryFetchResult.actualCount < memoryFetchResult.requestedCount) {\r\n          toastr.warning(\r\n            __st_t_tag`Only ${memoryFetchResult.actualCount} of ${memoryFetchResult.requestedCount} requested memories available`,\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n        console.log(\r\n          `STMemoryBooks: Including ${memoryFetchResult.actualCount} previous memories as context`,\r\n        );\r\n      } else {\r\n        toastr.warning(\r\n          translate(\r\n            \"No previous memories found in lorebook\",\r\n            \"STMemoryBooks_NoPreviousMemoriesFound\",\r\n          ),\r\n          \"STMemoryBooks\",\r\n        );\r\n      }\r\n    }\r\n\r\n    // Show working toast with actual memory count after fetching\r\n    let workingToastMessage;\r\n    if (retryCount > 0) {\r\n      workingToastMessage = `Retrying memory creation (attempt ${retryCount + 1}/${maxRetries + 1})...`;\r\n    } else {\r\n      workingToastMessage =\r\n        memoryFetchResult.actualCount > 0\r\n          ? `Creating memory with ${memoryFetchResult.actualCount} context memories...`\r\n          : \"Creating memory...\";\r\n    }\r\n    toastr.info(__st_t_tag`${workingToastMessage}`, \"STMemoryBooks\", {\r\n      timeOut: 0,\r\n    });\r\n\r\n    // Add context and get stats (no intermediate toast)\r\n    compiledScene.previousSummariesContext = previousMemories;\r\n    sceneStats = await getSceneStats(compiledScene);\r\n    const actualTokens = sceneStats?.estimatedTokens;\r\n\r\n    // Generate memory silently\r\n    const memoryResult = await createMemory(compiledScene, profileSettings, {\r\n      tokenWarningThreshold: tokenThreshold,\r\n    });\r\n\r\n    // Check if memory previews are enabled and handle accordingly\r\n    let finalMemoryResult = memoryResult;\r\n\r\n    if (settings.moduleSettings.showMemoryPreviews) {\r\n      // Clear working toast before showing preview popup\r\n      toastr.clear();\r\n\r\n      const previewResult = await showMemoryPreviewPopup(\r\n        memoryResult,\r\n        sceneData,\r\n        profileSettings,\r\n      );\r\n\r\n      if (previewResult.action === \"cancel\") {\r\n        // User cancelled, abort the process\r\n        return;\r\n      } else if (previewResult.action === \"retry\") {\r\n        // User wants to retry - limit user-initiated retries to prevent infinite loops\r\n        const maxUserRetries = 3; // Allow up to 3 user-initiated retries\r\n        const currentUserRetries =\r\n          retryCount >= maxRetries ? retryCount - maxRetries : 0;\r\n\r\n        if (currentUserRetries >= maxUserRetries) {\r\n          toastr.warning(\r\n            __st_t_tag`Maximum retry attempts (${maxUserRetries}) reached`,\r\n            \"STMemoryBooks\",\r\n          );\r\n          return { action: \"cancel\" };\r\n        }\r\n\r\n        toastr.info(\r\n          __st_t_tag`Retrying memory generation (${currentUserRetries + 1}/${maxUserRetries})...`,\r\n          \"STMemoryBooks\",\r\n        );\r\n        // Keep the retry count properly incremented to track total attempts\r\n        const nextRetryCount = Math.max(\r\n          retryCount + 1,\r\n          maxRetries + currentUserRetries + 1,\r\n        );\r\n        return await executeMemoryGeneration(\r\n          sceneData,\r\n          lorebookValidation,\r\n          effectiveSettings,\r\n          nextRetryCount,\r\n        );\r\n      }\r\n\r\n      // Handle preview result based on action\r\n      if (previewResult.action === \"accept\") {\r\n        // User accepted as-is, use original data\r\n        finalMemoryResult = memoryResult;\r\n      } else if (previewResult.action === \"edit\") {\r\n        // User edited the data, validate and use edited version\r\n        if (!previewResult.memoryData) {\r\n          console.error(\"STMemoryBooks: Edit action missing memoryData\");\r\n          toastr.error(\r\n            translate(\r\n              \"Unable to retrieve edited memory data\",\r\n              \"STMemoryBooks_UnableToRetrieveEditedMemoryData\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n          return;\r\n        }\r\n\r\n        // Validate that edited memory data has required fields\r\n        if (\r\n          !previewResult.memoryData.extractedTitle ||\r\n          !previewResult.memoryData.content\r\n        ) {\r\n          console.error(\r\n            \"STMemoryBooks: Edited memory data missing required fields\",\r\n          );\r\n          toastr.error(\r\n            translate(\r\n              \"Edited memory data is incomplete\",\r\n              \"STMemoryBooks_EditedMemoryDataIncomplete\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n          return;\r\n        }\r\n\r\n        finalMemoryResult = previewResult.memoryData;\r\n      } else {\r\n        // Unexpected action, use original data as fallback\r\n        console.warn(\r\n          `STMemoryBooks: Unexpected preview action: ${previewResult.action}`,\r\n        );\r\n        finalMemoryResult = memoryResult;\r\n      }\r\n    }\r\n\r\n    // Add to lorebook silently\r\n    const addResult = await addMemoryToLorebook(\r\n      finalMemoryResult,\r\n      lorebookValidation,\r\n    );\r\n\r\n    if (!addResult.success) {\r\n      throw new Error(addResult.error || \"Failed to add memory to lorebook\");\r\n    }\r\n\r\n    // Run side prompts that are enabled to run with memories\r\n    try {\r\n      const connDbg =\r\n        profileSettings?.effectiveConnection ||\r\n        profileSettings?.connection ||\r\n        {};\r\n      console.debug(\"STMemoryBooks: Passing profile to runAfterMemory\", {\r\n        api: connDbg.api,\r\n        model: connDbg.model,\r\n        temperature: connDbg.temperature,\r\n      });\r\n      await runAfterMemory(compiledScene, profileSettings);\r\n    } catch (e) {\r\n      console.warn(\"STMemoryBooks: runAfterMemory failed:\", e);\r\n    }\r\n\r\n    // Update auto-summary baseline so the next trigger starts after this scene\n    try {\n      const stmbData = getSceneMarkers() || {};\n      stmbData.highestMemoryProcessed = sceneData.sceneEnd;\n      delete stmbData.highestMemoryProcessedManuallySet;\n      saveMetadataForCurrentContext();\n    } catch (e) {\n      console.warn(\n        \"STMemoryBooks: Failed to update highestMemoryProcessed baseline:\",\n        e,\n      );\r\n    }\r\n\r\n    // Clear auto-summary state after successful memory creation\r\n    clearAutoSummaryState();\r\n\r\n    // Success notification\r\n    const contextMsg =\r\n      memoryFetchResult.actualCount > 0\r\n        ? ` (with ${memoryFetchResult.actualCount} context ${memoryFetchResult.actualCount === 1 ? \"memory\" : \"memories\"})`\r\n        : \"\";\r\n\r\n    // Clear working toast and show success\r\n    toastr.clear();\r\n    lastFailureToast = null;\r\n    lastFailedAIError = null;\r\n    lastFailedAIContext = null;\r\n    const retryMsg =\r\n      retryCount > 0 ? ` (succeeded on attempt ${retryCount + 1})` : \"\";\r\n    toastr.success(\r\n      __st_t_tag`Memory \"${addResult.entryTitle}\" created successfully${contextMsg}${retryMsg}!`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error creating memory:\", error);\r\n\r\n    // Determine if we should retry\r\n    const shouldRetry = retryCount < maxRetries && isRetryableError(error);\r\n\r\n    if (shouldRetry) {\r\n      // Show retry notification and attempt again\r\n      toastr.warning(\r\n        __st_t_tag`Memory creation failed (attempt ${retryCount + 1}). Retrying in ${Math.round(MEMORY_GENERATION.RETRY_DELAY_MS / 1000)} seconds...`,\r\n        \"STMemoryBooks\",\r\n        {\r\n          timeOut: 3000,\r\n        },\r\n      );\r\n\r\n      // Wait before retrying\r\n      await new Promise((resolve) =>\r\n        setTimeout(resolve, MEMORY_GENERATION.RETRY_DELAY_MS),\r\n      );\r\n\r\n      // Recursive retry\r\n      return await executeMemoryGeneration(\r\n        sceneData,\r\n        lorebookValidation,\r\n        effectiveSettings,\r\n        retryCount + 1,\r\n      );\r\n    }\r\n\r\n    // No more retries or non-retryable error - show final error\r\n    const retryMsg =\r\n      retryCount > 0 ? ` (failed after ${retryCount + 1} attempts)` : \"\";\r\n    const codeTag = error && error.code ? ` [${error.code}]` : \"\";\r\n\r\n    // Provide specific error messages for different types of failures\r\n    if (error.name === \"TokenWarningError\") {\r\n      toastr.error(\r\n        __st_t_tag`Scene is too large (${error.tokenCount} tokens). Try selecting a smaller range${retryMsg}.`,\r\n        \"STMemoryBooks\",\r\n        {\r\n          timeOut: 8000,\r\n        },\r\n      );\r\n    } else if (error.name === \"AIResponseError\") {\r\n      try {\r\n        toastr.clear(lastFailureToast);\r\n      } catch (e) {}\r\n      lastFailedAIError = error;\r\n      lastFailedAIContext = {\r\n        sceneData,\r\n        compiledScene,\r\n        profileSettings,\r\n        lorebookValidation,\r\n        memoryFetchResult,\r\n        sceneStats,\r\n        settings,\r\n        summaryCount,\r\n        tokenThreshold,\r\n        sceneRange:\r\n          compiledScene?.metadata?.sceneStart !== undefined\r\n            ? `${compiledScene.metadata.sceneStart}-${compiledScene.metadata.sceneEnd}`\r\n            : `${sceneData.sceneStart}-${sceneData.sceneEnd}`,\r\n      };\r\n      lastFailureToast = toastr.error(\r\n        __st_t_tag`AI failed to generate valid memory${codeTag}: ${error.message}${retryMsg}`,\r\n        \"STMemoryBooks\",\r\n        {\r\n          timeOut: 0,\r\n          extendedTimeOut: 0,\r\n          closeButton: true,\r\n          tapToDismiss: false,\r\n          onclick: () => {\r\n            try {\r\n              showFailedAIResponsePopup(lastFailedAIError);\r\n            } catch (e) {\r\n              console.error(e);\r\n            }\r\n          },\r\n        },\r\n      );\r\n    } else if (error.name === \"InvalidProfileError\") {\r\n      toastr.error(\r\n        __st_t_tag`Profile configuration error: ${error.message}${retryMsg}`,\r\n        \"STMemoryBooks\",\r\n        {\r\n          timeOut: 8000,\r\n        },\r\n      );\r\n    } else {\r\n      toastr.error(\r\n        __st_t_tag`Failed to create memory: ${error.message}${retryMsg}`,\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nasync function initiateMemoryCreation(selectedProfileIndex = null) {\r\n  // Early validation checks (no flag set yet) - GROUP CHAT COMPATIBLE\r\n  const context = getCurrentMemoryBooksContext();\r\n\r\n  // For single character chats, check character data\r\n  if (!context.isGroupChat) {\r\n    if (!characters || characters.length === 0 || !characters[this_chid]) {\r\n      toastr.error(\r\n        translate(\r\n          \"SillyTavern is still loading character data, please wait a few seconds and try again.\",\r\n          \"STMemoryBooks_LoadingCharacterData\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n  }\r\n  // For group chats, check that we have group data\r\n  else {\r\n    if (!context.groupId || !context.groupName) {\r\n      toastr.error(\r\n        translate(\r\n          \"Group chat data not available, please wait a few seconds and try again.\",\r\n          \"STMemoryBooks_GroupChatDataUnavailable\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n  }\r\n\r\n  // RACE CONDITION FIX: Check and set flag atomically\r\n  if (isProcessingMemory) {\r\n    return;\r\n  }\r\n\r\n  // Set processing flag IMMEDIATELY after validation to prevent race conditions\r\n  isProcessingMemory = true;\r\n\r\n  try {\r\n    const settings = initializeSettings();\r\n\r\n    // Optionally unhide hidden messages before any scene compilation/token estimation.\r\n    // getSceneData() compiles a scene for token estimation and can fail with \"No visible messages\"\r\n    // when the selected range is hidden.\r\n    if (settings?.moduleSettings?.unhideBeforeMemory) {\r\n      const markers = getSceneMarkers() || {};\r\n      if (markers.sceneStart !== null && markers.sceneEnd !== null) {\r\n        try {\r\n          await executeSlashCommands(`/unhide ${markers.sceneStart}-${markers.sceneEnd}`);\r\n        } catch (e) {\r\n          console.warn(\"STMemoryBooks: /unhide command failed or unavailable:\", e);\r\n        }\r\n      }\r\n    }\r\n\r\n    // All the validation and processing logic\r\n    const sceneData = await getSceneData();\r\n    if (!sceneData) {\r\n      console.error(\"STMemoryBooks: No scene selected for memory initiation\");\r\n      toastr.error(\r\n        translate(\"No scene selected\", \"STMemoryBooks_NoSceneSelected\"),\r\n        \"STMemoryBooks\",\r\n      );\r\n      isProcessingMemory = false;\r\n      return;\r\n    }\r\n\r\n    const lorebookValidation = await validateLorebook();\r\n    if (!lorebookValidation.valid) {\r\n      console.error(\r\n        \"STMemoryBooks: Lorebook validation failed:\",\r\n        lorebookValidation.error,\r\n      );\r\n      toastr.error(\r\n        translate(\r\n          lorebookValidation.error,\r\n          \"STMemoryBooks_LorebookValidationError\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      isProcessingMemory = false;\r\n      return;\r\n    }\r\n\r\n    const allMemories = identifyMemoryEntries(lorebookValidation.data);\r\n    const newStart = sceneData.sceneStart;\r\n    const newEnd = sceneData.sceneEnd;\r\n\r\n    if (!settings.moduleSettings.allowSceneOverlap) {\r\n      for (const mem of allMemories) {\r\n        const existingRange = getRangeFromMemoryEntry(mem.entry);\r\n\r\n        if (\r\n          existingRange &&\r\n          existingRange.start !== null &&\r\n          existingRange.end !== null\r\n        ) {\r\n          const s = Number(existingRange.start);\r\n          const e = Number(existingRange.end);\r\n          const ns = Number(newStart);\r\n          const ne = Number(newEnd);\r\n          // Detailed overlap diagnostics\r\n          console.debug(\r\n            `STMemoryBooks: OverlapCheck new=[${ns}-${ne}] existing=\"${mem.title}\" [${s}-${e}] cond1(ns<=e)=${ns <= e} cond2(ne>=s)=${ne >= s}`,\r\n          );\r\n          if (ns <= e && ne >= s) {\r\n            console.error(\r\n              `STMemoryBooks: Scene overlap detected with memory: ${mem.title} [${s}-${e}] vs new [${ns}-${ne}]`,\r\n            );\r\n            toastr.error(\r\n              __st_t_tag`Scene overlaps with existing memory: \"${mem.title}\" (messages ${s}-${e})`,\r\n              \"STMemoryBooks\",\r\n            );\r\n            isProcessingMemory = false;\r\n            return;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    const effectiveSettings = await showAndGetMemorySettings(\r\n      sceneData,\r\n      lorebookValidation,\r\n      selectedProfileIndex,\r\n    );\r\n    if (!effectiveSettings) {\r\n      isProcessingMemory = false;\r\n      return; // User cancelled\r\n    }\r\n\r\n    // Close settings popup if open\r\n    if (currentPopupInstance) {\r\n      currentPopupInstance.completeCancelled();\r\n      currentPopupInstance = null;\r\n    }\r\n\r\n    // Execute the main process with retry logic\r\n    await executeMemoryGeneration(\r\n      sceneData,\r\n      lorebookValidation,\r\n      effectiveSettings,\r\n    );\r\n  } catch (error) {\r\n    console.error(\r\n      \"STMemoryBooks: Critical error during memory initiation:\",\r\n      error,\r\n    );\r\n    toastr.error(\r\n      __st_t_tag`An unexpected error occurred: ${error.message}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  } finally {\r\n    // ALWAYS reset the flag, no matter how we exit\r\n    isProcessingMemory = false;\r\n  }\r\n}\r\n\r\n/**\r\n * Helper function to convert old boolean auto-hide settings to new dropdown format\r\n */\r\nfunction getAutoHideMode(moduleSettings) {\r\n  // Handle new format\r\n  if (moduleSettings.autoHideMode) {\r\n    return moduleSettings.autoHideMode;\r\n  }\r\n\r\n  // Convert from old boolean format for backward compatibility\r\n  if (moduleSettings.autoHideAllMessages) {\r\n    return \"all\";\r\n  } else if (moduleSettings.autoHideLastMemory) {\r\n    return \"last\";\r\n  } else {\r\n    return \"none\";\r\n  }\r\n}\r\n\r\n/**\r\n * Update lorebook status display in settings popup\r\n */\r\nfunction updateLorebookStatusDisplay() {\r\n  const settings = extension_settings.STMemoryBooks;\r\n  if (!settings) return;\r\n\r\n  const stmbData = getSceneMarkers() || {};\r\n  const isManualMode = settings.moduleSettings.manualModeEnabled;\r\n\r\n  // Update mode badge\r\n  const modeBadge = document.querySelector(\"#stmb-mode-badge\");\r\n  if (modeBadge) {\r\n    modeBadge.textContent = isManualMode\r\n      ? translate(\"Manual\", \"STMemoryBooks_Manual\")\r\n      : translate(\"Automatic (Chat-bound)\", \"STMemoryBooks_AutomaticChatBound\");\r\n  }\r\n\r\n  // Update active lorebook display\r\n  const activeLorebookSpan = document.querySelector(\"#stmb-active-lorebook\");\r\n  if (activeLorebookSpan) {\r\n    const currentLorebook = isManualMode\r\n      ? stmbData.manualLorebook\r\n      : chat_metadata?.[METADATA_KEY];\r\n\r\n    activeLorebookSpan.textContent =\r\n      currentLorebook ||\r\n      translate(\"None selected\", \"STMemoryBooks_NoneSelected\");\r\n    activeLorebookSpan.className = currentLorebook ? \"\" : \"opacity50p\";\r\n  }\r\n\r\n  // Manual lorebook buttons are now handled by populateInlineButtons()\r\n\r\n  // Show/hide manual controls and automatic info sections based on mode\r\n  const manualControls = document.querySelector(\"#stmb-manual-controls\");\r\n  if (manualControls) {\r\n    manualControls.style.display = isManualMode ? \"block\" : \"none\";\r\n  }\r\n\r\n  const automaticInfo = document.querySelector(\"#stmb-automatic-info\");\r\n  if (automaticInfo) {\r\n    automaticInfo.style.display = isManualMode ? \"none\" : \"block\";\r\n\r\n    // Update automatic mode info text\r\n    const infoText = automaticInfo.querySelector(\"small\");\r\n    if (infoText) {\r\n      const chatBoundLorebook = chat_metadata?.[METADATA_KEY] ?? null;\r\n      infoText.innerHTML = chatBoundLorebook\r\n        ? __st_t_tag`Using chat-bound lorebook \"<strong>${chatBoundLorebook}</strong>\"`\r\n        : translate(\r\n            \"No chat-bound lorebook. Memories will require lorebook selection.\",\r\n            \"STMemoryBooks_NoChatBoundLorebook\",\r\n          );\r\n    }\r\n  }\r\n\r\n  // Mutual exclusion: Enable/disable checkboxes based on each other's state\r\n  const autoCreateCheckbox = document.querySelector(\r\n    \"#stmb-auto-create-lorebook\",\r\n  );\r\n  const manualModeCheckbox = document.querySelector(\r\n    \"#stmb-manual-mode-enabled\",\r\n  );\r\n  const nameTemplateInput = document.querySelector(\r\n    \"#stmb-lorebook-name-template\",\r\n  );\r\n\r\n  if (autoCreateCheckbox && manualModeCheckbox) {\r\n    const autoCreateEnabled = settings.moduleSettings.autoCreateLorebook;\r\n\r\n    // Manual mode disables auto-create and vice versa\r\n    autoCreateCheckbox.disabled = isManualMode;\r\n    manualModeCheckbox.disabled = autoCreateEnabled;\r\n\r\n    // Name template is only enabled when auto-create is enabled\r\n    if (nameTemplateInput) {\r\n      nameTemplateInput.disabled = !autoCreateEnabled;\r\n    }\r\n  }\r\n\r\n  // Manual lorebook button visibility is now handled by populateInlineButtons()\r\n}\r\n\r\n/**\r\n * Populate inline button containers with dynamic buttons (profile and manual lorebook buttons)\r\n */\r\nfunction populateInlineButtons() {\r\n  if (!currentPopupInstance?.dlg) return;\r\n\r\n  const settings = initializeSettings();\r\n  const stmbData = getSceneMarkers() || {};\r\n\r\n  // Get all button containers\r\n  const manualLorebookContainer = currentPopupInstance.content.querySelector(\r\n    \"#stmb-manual-lorebook-buttons\",\r\n  );\r\n  const profileButtonsContainer = currentPopupInstance.content.querySelector(\r\n    \"#stmb-profile-buttons\",\r\n  );\r\n  const extraFunctionContainer = currentPopupInstance.content.querySelector(\r\n    \"#stmb-extra-function-buttons\",\r\n  );\r\n  const promptButtonsContainer = currentPopupInstance.content.querySelector(\r\n    \"#stmb-prompt-manager-buttons\",\r\n  );\r\n\r\n  // Populate manual lorebook buttons if container exists and manual mode is enabled\r\n  if (manualLorebookContainer && settings.moduleSettings.manualModeEnabled) {\r\n    const hasManualLorebook = stmbData.manualLorebook ?? null;\r\n\r\n    const manualLorebookButtons = [\r\n      {\r\n        text:\r\n          ` ${hasManualLorebook ? translate(\"Change\", \"STMemoryBooks_ChangeManualLorebook\") : translate(\"Select\", \"STMemoryBooks_SelectManualLorebook\")} ` +\r\n          translate(\"Manual Lorebook\", \"STMemoryBooks_ManualLorebook\"),\r\n        id: \"stmb-select-manual-lorebook\",\r\n        action: async () => {\r\n          try {\r\n            // Use the dedicated selection popup that always shows options\r\n            const selectedLorebook = await showLorebookSelectionPopup(\r\n              hasManualLorebook ? stmbData.manualLorebook : null,\r\n            );\r\n            if (selectedLorebook) {\r\n              // Refresh the popup content to reflect the new selection\r\n              refreshPopupContent();\r\n            }\r\n          } catch (error) {\r\n            console.error(\r\n              \"STMemoryBooks: Error selecting manual lorebook:\",\r\n              error,\r\n            );\r\n            toastr.error(\r\n              translate(\r\n                \"Failed to select manual lorebook\",\r\n                \"STMemoryBooks_FailedToSelectManualLorebook\",\r\n              ),\r\n              \"STMemoryBooks\",\r\n            );\r\n          }\r\n        },\r\n      },\r\n    ];\r\n\r\n    // Add clear button if manual lorebook is set\r\n    if (hasManualLorebook) {\r\n      manualLorebookButtons.push({\r\n        text:\r\n          \" \" +\r\n          translate(\r\n            \"Clear Manual Lorebook\",\r\n            \"STMemoryBooks_ClearManualLorebook\",\r\n          ),\r\n        id: \"stmb-clear-manual-lorebook\",\r\n        action: () => {\r\n          try {\r\n            const stmbData = getSceneMarkers() || {};\r\n            delete stmbData.manualLorebook;\r\n            saveMetadataForCurrentContext();\r\n\r\n            // Refresh the popup content\r\n            refreshPopupContent();\r\n            toastr.success(\r\n              translate(\r\n                \"Manual lorebook cleared\",\r\n                \"STMemoryBooks_ManualLorebookCleared\",\r\n              ),\r\n              \"STMemoryBooks\",\r\n            );\r\n          } catch (error) {\r\n            console.error(\r\n              \"STMemoryBooks: Error clearing manual lorebook:\",\r\n              error,\r\n            );\r\n            toastr.error(\r\n              translate(\r\n                \"Failed to clear manual lorebook\",\r\n                \"STMemoryBooks_FailedToClearManualLorebook\",\r\n              ),\r\n              \"STMemoryBooks\",\r\n            );\r\n          }\r\n        },\r\n      });\r\n    }\r\n\r\n    // Clear container and populate with buttons\r\n    manualLorebookContainer.innerHTML = \"\";\r\n    manualLorebookButtons.forEach((buttonConfig) => {\r\n      const button = document.createElement(\"div\");\r\n      button.className = \"menu_button interactable whitespacenowrap\";\r\n      button.id = buttonConfig.id;\r\n      button.textContent = buttonConfig.text;\r\n      button.addEventListener(\"click\", buttonConfig.action);\r\n      manualLorebookContainer.appendChild(button);\r\n    });\r\n  }\r\n\r\n  if (!profileButtonsContainer || !extraFunctionContainer) return;\r\n\r\n  // Create profile action buttons\r\n  const profileButtons = [\r\n    {\r\n      text: \" \" + translate(\"Set as Default\", \"STMemoryBooks_SetAsDefault\"),\r\n      id: \"stmb-set-default-profile\",\r\n      action: () => {\r\n        const profileSelect = currentPopupInstance?.dlg?.querySelector(\r\n          \"#stmb-profile-select\",\r\n        );\r\n        if (!profileSelect) return;\r\n\r\n        const selectedIndex = clampInt(readIntInput(profileSelect, settings.defaultProfile ?? 0), 0, settings.profiles.length - 1);\r\n        if (selectedIndex === settings.defaultProfile) {\r\n          return;\r\n        }\r\n\r\n        settings.defaultProfile = selectedIndex;\r\n        saveSettingsDebounced();\r\n        const displayName = settings.profiles[selectedIndex]?.isBuiltinCurrentST\r\n          ? translate(\r\n              \"Current SillyTavern Settings\",\r\n              \"STMemoryBooks_Profile_CurrentST\",\r\n            )\r\n          : settings.profiles[selectedIndex].name;\r\n        toastr.success(\r\n          __st_t_tag`\"${displayName}\" is now the default profile.`,\r\n          \"STMemoryBooks\",\r\n        );\r\n        refreshPopupContent();\r\n      },\r\n    },\r\n    {\r\n      text: \" \" + translate(\"Edit Profile\", \"STMemoryBooks_EditProfile\"),\r\n      id: \"stmb-edit-profile\",\r\n      action: async () => {\r\n        try {\r\n          const profileSelect = currentPopupInstance?.dlg?.querySelector(\r\n            \"#stmb-profile-select\",\r\n          );\r\n          if (!profileSelect) return;\r\n\r\n          const selectedIndex = clampInt(readIntInput(profileSelect, settings.defaultProfile ?? 0), 0, settings.profiles.length - 1);\r\n          const selectedProfile = settings.profiles[selectedIndex];\r\n\r\n          // Migrate legacy dynamic flag to provider-based current_st and allow editing of non-connection fields\r\n          if (selectedProfile.useDynamicSTSettings) {\r\n            selectedProfile.connection = selectedProfile.connection || {};\r\n            selectedProfile.connection.api = \"current_st\";\r\n            delete selectedProfile.useDynamicSTSettings;\r\n            saveSettingsDebounced();\r\n          }\r\n\r\n          await editProfile(settings, selectedIndex, refreshPopupContent);\r\n        } catch (error) {\r\n          console.error(`${MODULE_NAME}: Error in edit profile:`, error);\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to edit profile\",\r\n              \"STMemoryBooks_FailedToEditProfile\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n    {\r\n      text: \" \" + translate(\"New Profile\", \"STMemoryBooks_NewProfile\"),\r\n      id: \"stmb-new-profile\",\r\n      action: async () => {\r\n        try {\r\n          await newProfile(settings, refreshPopupContent);\r\n        } catch (error) {\r\n          console.error(`${MODULE_NAME}: Error in new profile:`, error);\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to create profile\",\r\n              \"STMemoryBooks_FailedToCreateProfile\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n    {\r\n      text: \" \" + translate(\"Delete Profile\", \"STMemoryBooks_DeleteProfile\"),\r\n      id: \"stmb-delete-profile\",\r\n      action: async () => {\r\n        try {\r\n          const profileSelect = currentPopupInstance?.dlg?.querySelector(\r\n            \"#stmb-profile-select\",\r\n          );\r\n          if (!profileSelect) return;\r\n\r\n          const selectedIndex = readIntInput(profileSelect, settings.defaultProfile ?? 0);\r\n          await deleteProfile(settings, selectedIndex, refreshPopupContent);\r\n        } catch (error) {\r\n          console.error(`${MODULE_NAME}: Error in delete profile:`, error);\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to delete profile\",\r\n              \"STMemoryBooks_FailedToDeleteProfile\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n  ];\r\n\r\n  // Create additional function buttons\r\n  const extraFunctionButtons = [\r\n    {\r\n      text:\r\n        \" \" + translate(\"Export Profiles\", \"STMemoryBooks_ExportProfiles\"),\r\n      id: \"stmb-export-profiles\",\r\n      action: () => {\r\n        try {\r\n          exportProfiles(settings);\r\n        } catch (error) {\r\n          console.error(`${MODULE_NAME}: Error in export profiles:`, error);\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to export profiles\",\r\n              \"STMemoryBooks_FailedToExportProfiles\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n    {\r\n      text:\r\n        \" \" + translate(\"Import Profiles\", \"STMemoryBooks_ImportProfiles\"),\r\n      id: \"stmb-import-profiles\",\r\n      action: () => {\r\n        const importFile =\r\n          currentPopupInstance?.dlg?.querySelector(\"#stmb-import-file\");\r\n        if (importFile) {\r\n          importFile.click();\r\n        }\r\n      },\r\n    },\r\n  ];\r\n\r\n  // Create additional function buttons\r\n  const promptManagerButtons = [\r\n    {\r\n      text:\r\n        \" \" +\r\n        translate(\r\n          \"Summary Prompt Manager\",\r\n          \"STMemoryBooks_SummaryPromptManager\",\r\n        ),\r\n      id: \"stmb-prompt-manager\",\r\n      action: async () => {\r\n        try {\r\n          await showPromptManagerPopup();\r\n        } catch (error) {\r\n          console.error(`${MODULE_NAME}: Error opening prompt manager:`, error);\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to open Summary Prompt Manager\",\r\n              \"STMemoryBooks_FailedToOpenSummaryPromptManager\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n    {\r\n      text:\r\n        \" \" +\r\n        translate(\"Arc Prompt Manager\", \"STMemoryBooks_ArcPromptManager\"),\r\n      id: \"stmb-arc-prompt-manager\",\r\n      action: async () => {\r\n        try {\r\n          await showArcPromptManagerPopup();\r\n        } catch (error) {\r\n          console.error(\r\n            `${MODULE_NAME}: Error opening Arc Prompt Manager:`,\r\n            error,\r\n          );\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to open Arc Prompt Manager\",\r\n              \"STMemoryBooks_FailedToOpenArcPromptManager\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n    {\r\n      text: \" \" + translate(\"Trackers & Side Prompts\", \"STMemoryBooks_SidePrompts\"),\r\n      id: \"stmb-side-prompts\",\r\n      action: async () => {\r\n        try {\r\n          await showSidePromptsPopup();\r\n        } catch (error) {\r\n          console.error(`${MODULE_NAME}: Error opening Trackers & Side Prompts Manager:`, error);\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to open Trackers & Side Prompts Manager\",\r\n              \"STMemoryBooks_FailedToOpenSidePrompts\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      },\r\n    },\r\n  ];\r\n\r\n  // Clear containers and populate with buttons\r\n  profileButtonsContainer.innerHTML = \"\";\r\n  extraFunctionContainer.innerHTML = \"\";\r\n  promptButtonsContainer.innerHTML = \"\";\r\n\r\n  // Add profile action buttons\r\n  profileButtons.forEach((buttonConfig) => {\r\n    const button = document.createElement(\"div\");\r\n    button.className = \"menu_button interactable whitespacenowrap\";\r\n    button.id = buttonConfig.id;\r\n    button.textContent = buttonConfig.text;\r\n    button.addEventListener(\"click\", buttonConfig.action);\r\n    profileButtonsContainer.appendChild(button);\r\n  });\r\n\r\n  // Add Extra Function Buttons buttons\r\n  extraFunctionButtons.forEach((buttonConfig) => {\r\n    const button = document.createElement(\"div\");\r\n    button.className = \"menu_button interactable whitespacenowrap\";\r\n    button.id = buttonConfig.id;\r\n    button.textContent = buttonConfig.text;\r\n    button.addEventListener(\"click\", buttonConfig.action);\r\n    extraFunctionContainer.appendChild(button);\r\n  });\r\n\r\n  // break out prompt manager buttons\r\n  promptManagerButtons.forEach((buttonConfig) => {\r\n    const button = document.createElement(\"div\");\r\n    button.className = \"menu_button interactable whitespacenowrap\";\r\n    button.id = buttonConfig.id;\r\n    button.textContent = buttonConfig.text;\r\n    button.addEventListener(\"click\", buttonConfig.action);\r\n    promptButtonsContainer.appendChild(button);\r\n  });\r\n}\r\n\r\n/**\r\n * Show the Summary Prompt Manager popup\r\n */\r\nasync function showPromptManagerPopup() {\r\n  try {\r\n    // Initialize the prompt manager on first use\r\n    const settings = extension_settings.STMemoryBooks;\r\n    await SummaryPromptManager.firstRunInitIfMissing(settings);\r\n\r\n    // Get list of presets\r\n    const presets = await SummaryPromptManager.listPresets();\r\n\r\n    // Build the popup content\r\n    let content =\r\n      '<h3 data-i18n=\"STMemoryBooks_PromptManager_Title\"> Summary Prompt Manager</h3>';\r\n    content += '<div class=\"world_entry_form_control\">';\r\n    content +=\r\n      '<p data-i18n=\"STMemoryBooks_PromptManager_Desc\">Manage your summary generation prompts. All presets are editable.</p>';\r\n    content += \"</div>\";\r\n\r\n    // Search/filter box\r\n    content += '<div class=\"world_entry_form_control\">';\r\n    content +=\r\n      '<input type=\"text\" id=\"stmb-prompt-search\" class=\"text_pole\" placeholder=\"Search presets...\" aria-label=\"Search presets\" data-i18n=\"[placeholder]STMemoryBooks_PromptManager_Search;[aria-label]STMemoryBooks_PromptManager_Search\" />';\r\n    content += \"</div>\";\r\n\r\n    // Preset list container (table content rendered via Handlebars after popup creation)\r\n    content +=\r\n      '<div id=\"stmb-preset-list\" class=\"padding10 marginBot10\" style=\"max-height: 400px; overflow-y: auto;\"></div>';\r\n\r\n    // Action buttons\r\n    content +=\r\n      '<div class=\"buttons_block justifyCenter gap10px whitespacenowrap\">';\r\n    content +=\r\n      '<button id=\"stmb-pm-new\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_PromptManager_New\"> New Preset</button>';\r\n    content +=\r\n      '<button id=\"stmb-pm-export\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_PromptManager_Export\"> Export JSON</button>';\r\n    content +=\r\n      '<button id=\"stmb-pm-import\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_PromptManager_Import\"> Import JSON</button>';\r\n    content +=\r\n      '<button id=\"stmb-pm-recreate-builtins\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_PromptManager_RecreateBuiltins\"> Recreate Built-in Prompts</button>';\r\n    content +=\r\n      '<button id=\"stmb-pm-apply\" class=\"menu_button whitespacenowrap\" disabled data-i18n=\"STMemoryBooks_PromptManager_ApplyToProfile\"> Apply to Selected Profile</button>';\r\n    content += \"</div>\";\r\n\r\n    // Hint re: prompting\r\n    content += `<small>${translate(' When creating a new prompt, copy one of the other built-in prompts and then amend it. Don\\'t change the \"respond with JSON\" instructions, Memory Books uses that to process the returned result from the AI.', \"STMemoryBooks_PromptManager_Hint\")}</small>`;\r\n\r\n    // Hidden file input for import\r\n    content +=\r\n      '<input type=\"file\" id=\"stmb-pm-import-file\" accept=\".json\" style=\"display: none;\" />';\r\n\r\n    const popup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n      wide: true,\r\n      large: true,\r\n      allowVerticalScrolling: true,\r\n      okButton: false,\r\n      cancelButton: translate(\"Close\", \"STMemoryBooks_Close\"),\r\n    });\r\n\r\n    // Attach handlers before showing the popup to ensure interactivity\r\n    setupPromptManagerEventHandlers(popup);\r\n\r\n    // Initial render of presets table using Handlebars\r\n    const listEl = popup.dlg?.querySelector(\"#stmb-preset-list\");\r\n    if (listEl) {\r\n      const items = (presets || []).map((p) => ({\r\n        key: String(p.key || \"\"),\r\n        displayName: String(p.displayName || \"\"),\r\n      }));\r\n      listEl.innerHTML = DOMPurify.sanitize(\r\n        summaryPromptsTableTemplate({ items }),\r\n      );\r\n    }\r\n\r\n    await popup.show();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error showing prompt manager:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to open Summary Prompt Manager\",\r\n        \"STMemoryBooks_FailedToOpenSummaryPromptManager\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Setup event handlers for the prompt manager popup\r\n */\r\n\r\nfunction setupPromptManagerEventHandlers(popup) {\r\n  const dlg = popup.dlg;\r\n  let selectedPresetKey = null;\r\n\r\n  // Row selection and inline actions\r\n  dlg.addEventListener(\"click\", async (e) => {\r\n    // Handle inline action icon buttons first\r\n    const actionBtn = e.target.closest(\".stmb-action\");\r\n    if (actionBtn) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      const row = actionBtn.closest(\"tr[data-preset-key]\");\r\n      const key = row?.dataset.presetKey;\r\n      if (!key) return;\r\n\r\n      // Keep row visually selected using ST theme colors\r\n      dlg.querySelectorAll(\"tr[data-preset-key]\").forEach((r) => {\r\n        r.classList.remove(\"ui-state-active\");\r\n        r.style.backgroundColor = \"\";\r\n        r.style.border = \"\";\r\n      });\r\n      if (row) {\r\n        row.style.backgroundColor = \"var(--cobalt30a)\";\r\n        row.style.border = \"\";\r\n        selectedPresetKey = key;\r\n      }\r\n      const applyBtn = dlg.querySelector(\"#stmb-pm-apply\");\r\n      if (applyBtn) applyBtn.disabled = false;\r\n\r\n      if (actionBtn.classList.contains(\"stmb-action-edit\")) {\r\n        await editPreset(popup, key);\r\n      } else if (actionBtn.classList.contains(\"stmb-action-duplicate\")) {\r\n        await duplicatePreset(popup, key);\r\n      } else if (actionBtn.classList.contains(\"stmb-action-delete\")) {\r\n        await deletePreset(popup, key);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Handle row selection\r\n    const row = e.target.closest(\"tr[data-preset-key]\");\r\n    if (row) {\r\n      dlg.querySelectorAll(\"tr[data-preset-key]\").forEach((r) => {\r\n        r.classList.remove(\"ui-state-active\");\r\n        r.style.backgroundColor = \"\";\r\n        r.style.border = \"\";\r\n      });\r\n\r\n      row.style.backgroundColor = \"var(--cobalt30a)\";\r\n      row.style.border = \"\";\r\n      selectedPresetKey = row.dataset.presetKey;\r\n\r\n      const applyBtn = dlg.querySelector(\"#stmb-pm-apply\");\r\n      if (applyBtn) applyBtn.disabled = false;\r\n    }\r\n  });\r\n\r\n  // Search functionality\r\n  const searchInput = dlg.querySelector(\"#stmb-prompt-search\");\r\n  if (searchInput) {\r\n    searchInput.addEventListener(\"input\", (e) => {\r\n      const searchTerm = e.target.value.toLowerCase();\r\n      dlg.querySelectorAll(\"tr[data-preset-key]\").forEach((row) => {\r\n        const displayName = row\r\n          .querySelector(\"td:first-child\")\r\n          .textContent.toLowerCase();\r\n        row.style.display = displayName.includes(searchTerm) ? \"\" : \"none\";\r\n      });\r\n    });\r\n  }\r\n\r\n  // Button handlers\r\n  dlg.querySelector(\"#stmb-pm-new\")?.addEventListener(\"click\", async () => {\r\n    await createNewPreset(popup);\r\n  });\r\n\r\n  dlg.querySelector(\"#stmb-pm-edit\")?.addEventListener(\"click\", async () => {\r\n    if (selectedPresetKey) {\r\n      await editPreset(popup, selectedPresetKey);\r\n    }\r\n  });\r\n\r\n  dlg\r\n    .querySelector(\"#stmb-pm-duplicate\")\r\n    ?.addEventListener(\"click\", async () => {\r\n      if (selectedPresetKey) {\r\n        await duplicatePreset(popup, selectedPresetKey);\r\n      }\r\n    });\r\n\r\n  dlg.querySelector(\"#stmb-pm-delete\")?.addEventListener(\"click\", async () => {\r\n    if (selectedPresetKey) {\r\n      await deletePreset(popup, selectedPresetKey);\r\n    }\r\n  });\r\n\r\n  dlg.querySelector(\"#stmb-pm-export\")?.addEventListener(\"click\", async () => {\r\n    await exportPrompts();\r\n  });\r\n\r\n  dlg.querySelector(\"#stmb-pm-import\")?.addEventListener(\"click\", () => {\r\n    dlg.querySelector(\"#stmb-pm-import-file\")?.click();\r\n  });\r\n\r\n  dlg\r\n    .querySelector(\"#stmb-pm-import-file\")\r\n    ?.addEventListener(\"change\", async (e) => {\r\n      await importPrompts(e, popup);\r\n    });\r\n\r\n  // Recreate built-in prompts (destructive; no preservation)\r\n  dlg\r\n    .querySelector(\"#stmb-pm-recreate-builtins\")\r\n    ?.addEventListener(\"click\", async () => {\r\n      try {\r\n        const content = `\r\n                <h3>${escapeHtml(translate(\"Recreate Built-in Prompts\", \"STMemoryBooks_RecreateBuiltinsTitle\"))}</h3>\r\n                <div class=\"info-block warning\">\r\n                    ${escapeHtml(\r\n                      translate(\r\n                        \"This will remove overrides for all builtin presets (summary, summarize, synopsis, sumup, minimal, northgate, aelemar, comprehensive). Any customizations to these built-ins will be lost. After this, built-ins will follow the current app locale.\",\r\n                        \"STMemoryBooks_RecreateBuiltinsWarning\",\r\n                      ),\r\n                    )}\r\n                </div>\r\n                <p class=\"opacity70p\">${escapeHtml(translate(\"This does not affect your other custom presets.\", \"STMemoryBooks_RecreateBuiltinsDoesNotAffectCustom\"))}</p>\r\n            `;\r\n        const confirmPopup = new Popup(content, POPUP_TYPE.CONFIRM, \"\", {\r\n          okButton: translate(\r\n            \"Overwrite\",\r\n            \"STMemoryBooks_RecreateBuiltinsOverwrite\",\r\n          ),\r\n          cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n        });\r\n        const res = await confirmPopup.show();\r\n        if (res === POPUP_RESULT.AFFIRMATIVE) {\r\n          const result =\r\n            await SummaryPromptManager.recreateBuiltInPrompts(\"overwrite\");\r\n          // Notify other UIs about preset changes\r\n          try {\r\n            window.dispatchEvent(new CustomEvent(\"stmb-presets-updated\"));\r\n          } catch (e) {\r\n            /* noop */\r\n          }\r\n          toastr.success(\r\n            __st_t_tag`Removed ${result?.removed || 0} built-in overrides`,\r\n            translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n          );\r\n          // Refresh the manager popup\r\n          popup.completeAffirmative();\r\n          await showPromptManagerPopup();\r\n        }\r\n      } catch (error) {\r\n        console.error(\r\n          \"STMemoryBooks: Error recreating built-in prompts:\",\r\n          error,\r\n        );\r\n        toastr.error(\r\n          translate(\r\n            \"Failed to recreate built-in prompts\",\r\n            \"STMemoryBooks_FailedToRecreateBuiltins\",\r\n          ),\r\n          translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n        );\r\n      }\r\n    });\r\n\r\n  // Apply selected preset to current profile\r\n  dlg.querySelector(\"#stmb-pm-apply\")?.addEventListener(\"click\", async () => {\r\n    if (!selectedPresetKey) {\r\n      toastr.error(\r\n        translate(\"Select a preset first\", \"STMemoryBooks_SelectPresetFirst\"),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n    const settings = extension_settings?.STMemoryBooks;\r\n    if (\r\n      !settings ||\r\n      !Array.isArray(settings.profiles) ||\r\n      settings.profiles.length === 0\r\n    ) {\r\n      toastr.error(\r\n        translate(\"No profiles available\", \"STMemoryBooks_NoProfilesAvailable\"),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Determine selected profile index from the main settings popup if available\r\n    let selectedIndex = settings.defaultProfile ?? 0;\r\n    if (currentPopupInstance?.dlg) {\r\n      const profileSelect = currentPopupInstance.dlg.querySelector(\r\n        \"#stmb-profile-select\",\r\n      );\r\n      if (profileSelect) {\r\n        selectedIndex = readIntInput(profileSelect, settings.defaultProfile ?? 0);\r\n      }\r\n    }\r\n\r\n    const prof = settings.profiles[selectedIndex];\r\n    if (!prof) {\r\n      toastr.error(\r\n        translate(\r\n          \"Selected profile not found\",\r\n          \"STMemoryBooks_SelectedProfileNotFound\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    // If the profile has a custom prompt, ask to clear it so the preset takes effect\r\n    if (prof.prompt && prof.prompt.trim()) {\r\n      const confirmPopup = new Popup(\r\n        `<h3 data-i18n=\"STMemoryBooks_ClearCustomPromptTitle\">Clear Custom Prompt?</h3><p data-i18n=\"STMemoryBooks_ClearCustomPromptDesc\">This profile has a custom prompt. Clear it so the selected preset is used?</p>`,\r\n        POPUP_TYPE.CONFIRM,\r\n        \"\",\r\n        {\r\n          okButton: translate(\"Clear and Apply\", \"STMemoryBooks_ClearAndApply\"),\r\n          cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n        },\r\n      );\r\n      const res = await confirmPopup.show();\r\n      if (res === POPUP_RESULT.AFFIRMATIVE) {\r\n        prof.prompt = \"\";\r\n      } else {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Apply preset and save\r\n    prof.preset = selectedPresetKey;\r\n    saveSettingsDebounced();\r\n    toastr.success(\r\n      translate(\r\n        \"Preset applied to profile\",\r\n        \"STMemoryBooks_PresetAppliedToProfile\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n\r\n    // Refresh main settings popup if open\r\n    if (currentPopupInstance?.dlg) {\r\n      try {\r\n        refreshPopupContent();\r\n      } catch (e) {\r\n        /* noop */\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Create a new preset\r\n */\r\nasync function createNewPreset(popup) {\r\n  const content = `\r\n        <h3 data-i18n=\"STMemoryBooks_CreateNewPresetTitle\">Create New Preset</h3>\r\n        <div class=\"world_entry_form_control\">\r\n            <label for=\"stmb-pm-new-display-name\">\r\n                <h4 data-i18n=\"STMemoryBooks_DisplayNameTitle\">Display Name:</h4>\r\n                <input type=\"text\" id=\"stmb-pm-new-display-name\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_MyCustomPreset\" placeholder=\"My Custom Preset\" />\r\n            </label>\r\n        </div>\r\n        <div class=\"world_entry_form_control\">\r\n            <label for=\"stmb-pm-new-prompt\">\r\n                <h4 data-i18n=\"STMemoryBooks_PromptTitle\">Prompt:</h4>\r\n                <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-pm-new-prompt\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\r\n                <textarea id=\"stmb-pm-new-prompt\" class=\"text_pole textarea_compact\" rows=\"10\" data-i18n=\"[placeholder]STMemoryBooks_EnterPromptPlaceholder\" placeholder=\"Enter your prompt here...\"></textarea>\r\n            </label>\r\n        </div>\r\n    `;\r\n\r\n  const editPopup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n    okButton: translate(\"Create\", \"STMemoryBooks_Create\"),\r\n    cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n  });\r\n\r\n  const result = await editPopup.show();\r\n\r\n  if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n    const displayName = editPopup.dlg\r\n      .querySelector(\"#stmb-pm-new-display-name\")\r\n      .value.trim();\r\n    const prompt = editPopup.dlg\r\n      .querySelector(\"#stmb-pm-new-prompt\")\r\n      .value.trim();\r\n\r\n    if (!prompt) {\r\n      toastr.error(\r\n        translate(\r\n          \"Prompt cannot be empty\",\r\n          \"STMemoryBooks_PromptCannotBeEmpty\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await SummaryPromptManager.upsertPreset(\r\n        null,\r\n        prompt,\r\n        displayName || null,\r\n      );\r\n      toastr.success(\r\n        translate(\r\n          \"Preset created successfully\",\r\n          \"STMemoryBooks_PresetCreatedSuccessfully\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      // Notify other UIs about preset changes\r\n      window.dispatchEvent(new CustomEvent(\"stmb-presets-updated\"));\r\n\r\n      // Refresh the manager popup\r\n      popup.completeAffirmative();\r\n      await showPromptManagerPopup();\r\n    } catch (error) {\r\n      console.error(\"STMemoryBooks: Error creating preset:\", error);\r\n      toastr.error(\r\n        translate(\r\n          \"Failed to create preset\",\r\n          \"STMemoryBooks_FailedToCreatePreset\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Edit an existing preset\r\n */\r\nasync function editPreset(popup, presetKey) {\r\n  try {\r\n    const displayName = await SummaryPromptManager.getDisplayName(presetKey);\r\n    const prompt = await SummaryPromptManager.getPrompt(presetKey);\r\n\r\n    const content = `\r\n            <h3 data-i18n=\"STMemoryBooks_EditPresetTitle\">Edit Preset</h3>\r\n            <div class=\"world_entry_form_control\">\r\n                <label for=\"stmb-pm-edit-display-name\">\r\n                    <h4 data-i18n=\"STMemoryBooks_DisplayNameTitle\">Display Name:</h4>\r\n                    <input type=\"text\" id=\"stmb-pm-edit-display-name\" class=\"text_pole\" value=\"${escapeHtml(displayName)}\" />\r\n                </label>\r\n            </div>\r\n            <div class=\"world_entry_form_control\">\r\n                <label for=\"stmb-pm-edit-prompt\">\r\n                    <h4 data-i18n=\"STMemoryBooks_PromptTitle\">Prompt:</h4>\r\n                    <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-pm-edit-prompt\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\r\n                    <textarea id=\"stmb-pm-edit-prompt\" class=\"text_pole textarea_compact\" rows=\"10\">${escapeHtml(prompt)}</textarea>\r\n                </label>\r\n            </div>\r\n        `;\r\n\r\n    const editPopup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n      okButton: translate(\"Save\", \"STMemoryBooks_Save\"),\r\n      cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n    });\r\n\r\n    const result = await editPopup.show();\r\n\r\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n      const newDisplayName = editPopup.dlg\r\n        .querySelector(\"#stmb-pm-edit-display-name\")\r\n        .value.trim();\r\n      const newPrompt = editPopup.dlg\r\n        .querySelector(\"#stmb-pm-edit-prompt\")\r\n        .value.trim();\r\n\r\n      if (!newPrompt) {\r\n        toastr.error(\r\n          translate(\r\n            \"Prompt cannot be empty\",\r\n            \"STMemoryBooks_PromptCannotBeEmpty\",\r\n          ),\r\n          \"STMemoryBooks\",\r\n        );\r\n        return;\r\n      }\r\n\r\n      await SummaryPromptManager.upsertPreset(\r\n        presetKey,\r\n        newPrompt,\r\n        newDisplayName || null,\r\n      );\r\n      toastr.success(\r\n        translate(\r\n          \"Preset updated successfully\",\r\n          \"STMemoryBooks_PresetUpdatedSuccessfully\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      // Notify other UIs about preset changes\r\n      window.dispatchEvent(new CustomEvent(\"stmb-presets-updated\"));\r\n\r\n      // Refresh the manager popup\r\n      popup.completeAffirmative();\r\n      await showPromptManagerPopup();\r\n    }\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error editing preset:\", error);\r\n    toastr.error(\r\n      translate(\"Failed to edit preset\", \"STMemoryBooks_FailedToEditPreset\"),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Duplicate a preset\r\n */\r\nasync function duplicatePreset(popup, presetKey) {\r\n  try {\r\n    const newKey = await SummaryPromptManager.duplicatePreset(presetKey);\r\n    toastr.success(\r\n      translate(\r\n        \"Preset duplicated successfully\",\r\n        \"STMemoryBooks_PresetDuplicatedSuccessfully\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    // Notify other UIs about preset changes\r\n    window.dispatchEvent(new CustomEvent(\"stmb-presets-updated\"));\r\n\r\n    // Refresh the manager popup\r\n    popup.completeAffirmative();\r\n    await showPromptManagerPopup();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error duplicating preset:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to duplicate preset\",\r\n        \"STMemoryBooks_FailedToDuplicatePreset\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a preset\r\n */\r\nasync function deletePreset(popup, presetKey) {\r\n  const displayName = await SummaryPromptManager.getDisplayName(presetKey);\r\n\r\n  const confirmPopup = new Popup(\r\n    `<h3 data-i18n=\"STMemoryBooks_DeletePresetTitle\">Delete Preset</h3><p>${escapeHtml(translate('Are you sure you want to delete \"{{name}}\"?', \"STMemoryBooks_DeletePresetConfirm\", { name: displayName }))}</p>`,\r\n    POPUP_TYPE.CONFIRM,\r\n    \"\",\r\n    {\r\n      okButton: translate(\"Delete\", \"STMemoryBooks_Delete\"),\r\n      cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n    },\r\n  );\r\n  try {\r\n    applyLocale(confirmPopup.dlg);\r\n  } catch (e) {\r\n    /* no-op */\r\n  }\r\n\r\n  const result = await confirmPopup.show();\r\n\r\n  if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n    try {\r\n      await SummaryPromptManager.removePreset(presetKey);\r\n      toastr.success(\r\n        translate(\r\n          \"Preset deleted successfully\",\r\n          \"STMemoryBooks_PresetDeletedSuccessfully\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      // Notify other UIs about preset changes\r\n      window.dispatchEvent(new CustomEvent(\"stmb-presets-updated\"));\r\n\r\n      // Refresh the manager popup\r\n      popup.completeAffirmative();\r\n      await showPromptManagerPopup();\r\n    } catch (error) {\r\n      console.error(\"STMemoryBooks: Error deleting preset:\", error);\r\n      toastr.error(\r\n        translate(\r\n          \"Failed to delete preset\",\r\n          \"STMemoryBooks_FailedToDeletePreset\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Export prompts to JSON\r\n */\r\nasync function exportPrompts() {\r\n  try {\r\n    const json = await SummaryPromptManager.exportToJSON();\r\n    const blob = new Blob([json], { type: \"application/json\" });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = \"stmb-summary-prompts.json\";\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n    toastr.success(\r\n      translate(\r\n        \"Prompts exported successfully\",\r\n        \"STMemoryBooks_PromptsExportedSuccessfully\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error exporting prompts:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to export prompts\",\r\n        \"STMemoryBooks_FailedToExportPrompts\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Import prompts from JSON\r\n */\r\nasync function importPrompts(event, popup) {\r\n  const file = event.target.files[0];\r\n  if (!file) return;\r\n\r\n  try {\r\n    const text = await file.text();\r\n    await SummaryPromptManager.importFromJSON(text);\r\n    toastr.success(\r\n      translate(\r\n        \"Prompts imported successfully\",\r\n        \"STMemoryBooks_PromptsImportedSuccessfully\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    // Notify other UIs about preset changes\r\n    window.dispatchEvent(new CustomEvent(\"stmb-presets-updated\"));\r\n\r\n    // Refresh the manager popup\r\n    popup.completeAffirmative();\r\n    await showPromptManagerPopup();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error importing prompts:\", error);\r\n    toastr.error(\r\n      __st_t_tag`Failed to import prompts: ${error.message}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Show Arc Prompt Manager popup\r\n */\r\nasync function showArcPromptManagerPopup() {\r\n  try {\r\n    // Initialize arc prompts store\r\n    const settings = extension_settings.STMemoryBooks;\r\n    await ArcPrompts.firstRunInitIfMissing(settings);\r\n\r\n    // Get list of arc presets\r\n    const presets = await ArcPrompts.listPresets();\r\n\r\n    // Build the popup content\r\n    let content =\r\n      '<h3 data-i18n=\"STMemoryBooks_ArcPromptManager_Title\"> Arc Prompt Manager</h3>';\r\n    content += '<div class=\"world_entry_form_control\">';\r\n    content +=\r\n      '<p data-i18n=\"STMemoryBooks_ArcPromptManager_Desc\">Manage your Arc Analysis prompts. All presets are editable.</p>';\r\n    content += \"</div>\";\r\n\r\n    // Search/filter box\r\n    content += '<div class=\"world_entry_form_control\">';\r\n    content +=\r\n      '<input type=\"text\" id=\"stmb-apm-search\" class=\"text_pole\" placeholder=\"Search arc presets...\" aria-label=\"Search arc presets\" data-i18n=\"[placeholder]STMemoryBooks_ArcPromptManager_Search;[aria-label]STMemoryBooks_ArcPromptManager_Search\" />';\r\n    content += \"</div>\";\r\n\r\n    // Preset list container\r\n    content +=\r\n      '<div id=\"stmb-apm-list\" class=\"padding10 marginBot10\" style=\"max-height: 400px; overflow-y: auto;\"></div>';\r\n\r\n    // Action buttons\r\n    content +=\r\n      '<div class=\"buttons_block justifyCenter gap10px whitespacenowrap\">';\r\n    content +=\r\n      '<button id=\"stmb-apm-new\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_ArcPromptManager_New\"> New Arc Preset</button>';\r\n    content +=\r\n      '<button id=\"stmb-apm-export\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_ArcPromptManager_Export\"> Export JSON</button>';\r\n    content +=\r\n      '<button id=\"stmb-apm-import\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_ArcPromptManager_Import\"> Import JSON</button>';\r\n    content +=\r\n      '<button id=\"stmb-apm-recreate-builtins\" class=\"menu_button whitespacenowrap\" data-i18n=\"STMemoryBooks_ArcPromptManager_RecreateBuiltins\"> Recreate Built-in Arc Prompts</button>';\r\n    content += \"</div>\";\r\n\r\n    // Hidden file input for import\r\n    content +=\r\n      '<input type=\"file\" id=\"stmb-apm-import-file\" accept=\".json\" style=\"display: none;\" />';\r\n\r\n    const popup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n      wide: true,\r\n      large: true,\r\n      allowVerticalScrolling: true,\r\n      okButton: false,\r\n      cancelButton: translate(\"Close\", \"STMemoryBooks_Close\"),\r\n    });\r\n\r\n    // Attach handlers before showing the popup\r\n    setupArcPromptManagerEventHandlers(popup);\r\n\r\n    // Initial render of presets table using existing template\r\n    const listEl = popup.dlg?.querySelector(\"#stmb-apm-list\");\r\n    if (listEl) {\r\n      const items = (presets || []).map((p) => ({\r\n        key: String(p.key || \"\"),\r\n        displayName: String(p.displayName || \"\"),\r\n      }));\r\n      listEl.innerHTML = DOMPurify.sanitize(\r\n        summaryPromptsTableTemplate({ items }),\r\n      );\r\n    }\r\n\r\n    await popup.show();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error showing Arc Prompt Manager:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to open Arc Prompt Manager\",\r\n        \"STMemoryBooks_FailedToOpenArcPromptManager\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Setup event handlers for the Arc prompt manager popup\r\n */\r\nfunction setupArcPromptManagerEventHandlers(popup) {\r\n  const dlg = popup.dlg;\r\n  let selectedPresetKey = null;\r\n\r\n  // Row actions and selection\r\n  dlg.addEventListener(\"click\", async (e) => {\r\n    const actionBtn = e.target.closest(\".stmb-action\");\r\n    if (actionBtn) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      const row = actionBtn.closest(\"tr[data-preset-key]\");\r\n      const key = row?.dataset.presetKey;\r\n      if (!key) return;\r\n\r\n      dlg.querySelectorAll(\"tr[data-preset-key]\").forEach((r) => {\r\n        r.classList.remove(\"ui-state-active\");\r\n        r.style.backgroundColor = \"\";\r\n        r.style.border = \"\";\r\n      });\r\n      if (row) {\r\n        row.style.backgroundColor = \"var(--cobalt30a)\";\r\n        row.style.border = \"\";\r\n        selectedPresetKey = key;\r\n      }\r\n\r\n      if (actionBtn.classList.contains(\"stmb-action-edit\")) {\r\n        await editArcPreset(popup, key);\r\n      } else if (actionBtn.classList.contains(\"stmb-action-duplicate\")) {\r\n        await duplicateArcPreset(popup, key);\r\n      } else if (actionBtn.classList.contains(\"stmb-action-delete\")) {\r\n        await deleteArcPreset(popup, key);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const row = e.target.closest(\"tr[data-preset-key]\");\r\n    if (row) {\r\n      dlg.querySelectorAll(\"tr[data-preset-key]\").forEach((r) => {\r\n        r.classList.remove(\"ui-state-active\");\r\n        r.style.backgroundColor = \"\";\r\n        r.style.border = \"\";\r\n      });\r\n      row.style.backgroundColor = \"var(--cobalt30a)\";\r\n      row.style.border = \"\";\r\n      selectedPresetKey = row.dataset.presetKey;\r\n    }\r\n  });\r\n\r\n  // Search box\r\n  dlg.querySelector(\"#stmb-apm-search\")?.addEventListener(\"input\", (e) => {\r\n    const term = e.target.value.toLowerCase();\r\n    dlg.querySelectorAll(\"tr[data-preset-key]\").forEach((row) => {\r\n      const displayName = row\r\n        .querySelector(\"td:first-child\")\r\n        .textContent.toLowerCase();\r\n      row.style.display = displayName.includes(term) ? \"\" : \"none\";\r\n    });\r\n  });\r\n\r\n  // Buttons\r\n  dlg.querySelector(\"#stmb-apm-new\")?.addEventListener(\"click\", async () => {\r\n    await createNewArcPreset(popup);\r\n  });\r\n  dlg.querySelector(\"#stmb-apm-export\")?.addEventListener(\"click\", async () => {\r\n    await exportArcPrompts();\r\n  });\r\n  dlg.querySelector(\"#stmb-apm-import\")?.addEventListener(\"click\", () => {\r\n    dlg.querySelector(\"#stmb-apm-import-file\")?.click();\r\n  });\r\n  dlg\r\n    .querySelector(\"#stmb-apm-import-file\")\r\n    ?.addEventListener(\"change\", async (e) => {\r\n      await importArcPrompts(e, popup);\r\n    });\r\n\r\n  // Recreate built-ins (remove overrides for built-in keys)\r\n  dlg\r\n    .querySelector(\"#stmb-apm-recreate-builtins\")\r\n    ?.addEventListener(\"click\", async () => {\r\n      try {\r\n        const content = `\r\n                <h3>${escapeHtml(translate(\"Recreate Built-in Prompts\", \"STMemoryBooks_RecreateBuiltinsTitle\"))}</h3>\r\n                <div class=\"info-block warning\">\r\n                    ${escapeHtml(\r\n                      translate(\r\n                        \"This will remove overrides for all builtin presets (multi-arc, single, tiny). Any customizations to these built-ins will be lost. After this, built-ins will follow the current app locale.\",\r\n                        \"STMemoryBooks_RecreateArcBuiltinsWarning\",\r\n                      ),\r\n                    )}\r\n                </div>\r\n                <p class=\"opacity70p\">${escapeHtml(translate(\"This does not affect your other custom presets.\", \"STMemoryBooks_RecreateBuiltinsDoesNotAffectCustom\"))}</p>\r\n            `;\r\n        const confirmPopup = new Popup(content, POPUP_TYPE.CONFIRM, \"\", {\r\n          okButton: translate(\r\n            \"Overwrite\",\r\n            \"STMemoryBooks_RecreateBuiltinsOverwrite\",\r\n          ),\r\n          cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n        });\r\n        const res = await confirmPopup.show();\r\n        if (res === POPUP_RESULT.AFFIRMATIVE) {\r\n          const result = await ArcPrompts.recreateBuiltInPrompts(\"overwrite\");\r\n          try {\r\n            window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n          } catch (e) {\r\n            /* noop */\r\n          }\r\n          toastr.success(\r\n            __st_t_tag`Removed ${result?.removed || 0} built-in overrides`,\r\n            translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n          );\r\n          // Refresh the manager popup\r\n          popup.completeAffirmative();\r\n          await showArcPromptManagerPopup();\r\n        }\r\n      } catch (error) {\r\n        console.error(\r\n          \"STMemoryBooks: Error recreating built-in arc prompts:\",\r\n          error,\r\n        );\r\n        toastr.error(\r\n          translate(\r\n            \"Failed to recreate built-in prompts\",\r\n            \"STMemoryBooks_FailedToRecreateBuiltins\",\r\n          ),\r\n          translate(\"STMemoryBooks\", \"index.toast.title\"),\r\n        );\r\n      }\r\n    });\r\n}\r\n\r\n/**\r\n * Arc preset CRUD helpers\r\n */\r\nasync function createNewArcPreset(popup) {\r\n  const content = `\r\n        <h3 data-i18n=\"STMemoryBooks_CreateNewPresetTitle\">Create New Preset</h3>\r\n        <div class=\"world_entry_form_control\">\r\n            <label for=\"stmb-apm-new-display-name\">\r\n                <h4 data-i18n=\"STMemoryBooks_DisplayNameTitle\">Display Name:</h4>\r\n                <input type=\"text\" id=\"stmb-apm-new-display-name\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_MyCustomPreset\" placeholder=\"My Custom Preset\" />\r\n            </label>\r\n        </div>\r\n        <div class=\"world_entry_form_control\">\r\n            <label for=\"stmb-apm-new-prompt\">\r\n                <h4 data-i18n=\"STMemoryBooks_PromptTitle\">Prompt:</h4>\r\n                <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-apm-new-prompt\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\r\n                <textarea id=\"stmb-apm-new-prompt\" class=\"text_pole textarea_compact\" rows=\"10\" data-i18n=\"[placeholder]STMemoryBooks_EnterPromptPlaceholder\" placeholder=\"Enter your prompt here...\"></textarea>\r\n            </label>\r\n        </div>\r\n    `;\r\n  const editPopup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n    okButton: translate(\"Create\", \"STMemoryBooks_Create\"),\r\n    cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n  });\r\n  const result = await editPopup.show();\r\n  if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n    const displayName = editPopup.dlg\r\n      .querySelector(\"#stmb-apm-new-display-name\")\r\n      .value.trim();\r\n    const prompt = editPopup.dlg\r\n      .querySelector(\"#stmb-apm-new-prompt\")\r\n      .value.trim();\r\n    if (!prompt) {\r\n      toastr.error(\r\n        translate(\r\n          \"Prompt cannot be empty\",\r\n          \"STMemoryBooks_PromptCannotBeEmpty\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n    try {\r\n      await ArcPrompts.upsertPreset(null, prompt, displayName || null);\r\n      toastr.success(\r\n        translate(\r\n          \"Preset created successfully\",\r\n          \"STMemoryBooks_PresetCreatedSuccessfully\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n      popup.completeAffirmative();\r\n      await showArcPromptManagerPopup();\r\n    } catch (error) {\r\n      console.error(\"STMemoryBooks: Error creating arc preset:\", error);\r\n      toastr.error(\r\n        translate(\r\n          \"Failed to create preset\",\r\n          \"STMemoryBooks_FailedToCreatePreset\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nasync function editArcPreset(popup, presetKey) {\r\n  try {\r\n    const displayName = await ArcPrompts.getDisplayName(presetKey);\r\n    const prompt = await ArcPrompts.getPrompt(presetKey);\r\n    const content = `\r\n            <h3 data-i18n=\"STMemoryBooks_EditPresetTitle\">Edit Preset</h3>\r\n            <div class=\"world_entry_form_control\">\r\n                <label for=\"stmb-apm-edit-display-name\">\r\n                    <h4 data-i18n=\"STMemoryBooks_DisplayNameTitle\">Display Name:</h4>\r\n                    <input type=\"text\" id=\"stmb-apm-edit-display-name\" class=\"text_pole\" value=\"${escapeHtml(displayName)}\" />\r\n                </label>\r\n            </div>\r\n            <div class=\"world_entry_form_control\">\r\n                <label for=\"stmb-apm-edit-prompt\">\r\n                    <h4 data-i18n=\"STMemoryBooks_PromptTitle\">Prompt:</h4>\r\n                    <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-apm-edit-prompt\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\r\n                    <textarea id=\"stmb-apm-edit-prompt\" class=\"text_pole textarea_compact\" rows=\"10\">${escapeHtml(prompt)}</textarea>\r\n                </label>\r\n            </div>\r\n        `;\r\n    const editPopup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n      okButton: translate(\"Save\", \"STMemoryBooks_Save\"),\r\n      cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n    });\r\n    const result = await editPopup.show();\r\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n      const newDisplayName = editPopup.dlg\r\n        .querySelector(\"#stmb-apm-edit-display-name\")\r\n        .value.trim();\r\n      const newPrompt = editPopup.dlg\r\n        .querySelector(\"#stmb-apm-edit-prompt\")\r\n        .value.trim();\r\n      if (!newPrompt) {\r\n        toastr.error(\r\n          translate(\r\n            \"Prompt cannot be empty\",\r\n            \"STMemoryBooks_PromptCannotBeEmpty\",\r\n          ),\r\n          \"STMemoryBooks\",\r\n        );\r\n        return;\r\n      }\r\n      await ArcPrompts.upsertPreset(\r\n        presetKey,\r\n        newPrompt,\r\n        newDisplayName || null,\r\n      );\r\n      toastr.success(\r\n        translate(\r\n          \"Preset updated successfully\",\r\n          \"STMemoryBooks_PresetUpdatedSuccessfully\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n      popup.completeAffirmative();\r\n      await showArcPromptManagerPopup();\r\n    }\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error editing arc preset:\", error);\r\n    toastr.error(\r\n      translate(\"Failed to edit preset\", \"STMemoryBooks_FailedToEditPreset\"),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\nasync function duplicateArcPreset(popup, presetKey) {\r\n  try {\r\n    const newKey = await ArcPrompts.duplicatePreset(presetKey);\r\n    toastr.success(\r\n      translate(\r\n        \"Preset duplicated successfully\",\r\n        \"STMemoryBooks_PresetDuplicatedSuccessfully\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n    popup.completeAffirmative();\r\n    await showArcPromptManagerPopup();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error duplicating arc preset:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to duplicate preset\",\r\n        \"STMemoryBooks_FailedToDuplicatePreset\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\nasync function deleteArcPreset(popup, presetKey) {\r\n  const displayName = await ArcPrompts.getDisplayName(presetKey);\r\n  const confirmPopup = new Popup(\r\n    `<h3 data-i18n=\"STMemoryBooks_DeletePresetTitle\">Delete Preset</h3><p>${escapeHtml(translate('Are you sure you want to delete \"{{name}}\"?', \"STMemoryBooks_DeletePresetConfirm\", { name: displayName }))}</p>`,\r\n    POPUP_TYPE.CONFIRM,\r\n    \"\",\r\n    {\r\n      okButton: translate(\"Delete\", \"STMemoryBooks_Delete\"),\r\n      cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n    },\r\n  );\r\n  try {\r\n    applyLocale(confirmPopup.dlg);\r\n  } catch (e) {\r\n    /* no-op */\r\n  }\r\n  const result = await confirmPopup.show();\r\n  if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n    try {\r\n      await ArcPrompts.removePreset(presetKey);\r\n      toastr.success(\r\n        translate(\r\n          \"Preset deleted successfully\",\r\n          \"STMemoryBooks_PresetDeletedSuccessfully\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n      popup.completeAffirmative();\r\n      await showArcPromptManagerPopup();\r\n    } catch (error) {\r\n      console.error(\"STMemoryBooks: Error deleting arc preset:\", error);\r\n      toastr.error(\r\n        translate(\r\n          \"Failed to delete preset\",\r\n          \"STMemoryBooks_FailedToDeletePreset\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nasync function exportArcPrompts() {\r\n  try {\r\n    const json = await ArcPrompts.exportToJSON();\r\n    const blob = new Blob([json], { type: \"application/json\" });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = \"stmb-arc-prompts.json\";\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n    toastr.success(\r\n      translate(\r\n        \"Prompts exported successfully\",\r\n        \"STMemoryBooks_PromptsExportedSuccessfully\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error exporting arc prompts:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"Failed to export prompts\",\r\n        \"STMemoryBooks_FailedToExportPrompts\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\nasync function importArcPrompts(event, popup) {\r\n  const file = event.target.files[0];\r\n  if (!file) return;\r\n  try {\r\n    const text = await file.text();\r\n    await ArcPrompts.importFromJSON(text);\r\n    toastr.success(\r\n      translate(\r\n        \"Prompts imported successfully\",\r\n        \"STMemoryBooks_PromptsImportedSuccessfully\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n    popup.completeAffirmative();\r\n    await showArcPromptManagerPopup();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error importing arc prompts:\", error);\r\n    toastr.error(\r\n      __st_t_tag`Failed to import prompts: ${error.message}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Show Arc Consolidation popup\r\n */\r\nasync function showArcConsolidationPopup() {\r\n  try {\r\n    // Do not auto-create a lorebook for this path; allow UI to render\r\n    const lorebookValidation = await validateLorebook(true);\r\n\r\n    // If no lorebook is assigned, show a toast but still render the popup\r\n    let lorebookName = lorebookValidation?.name || null;\r\n    let lorebookData = lorebookValidation?.data || { entries: {} };\r\n\r\n    if (!lorebookValidation?.valid || !lorebookName) {\r\n      toastr.info(\r\n        \"No memory lorebook currently assigned, no memories found.\",\r\n        \"SillyTavern Memory Books\",\r\n      );\r\n      // Keep rendering the popup with empty data so the UI can render\r\n      lorebookName = null;\r\n      lorebookData = { entries: {} };\r\n    }\r\n\r\n    // Use the possibly-empty lorebookData to build the UI\r\n    const allEntries = Object.values(lorebookData.entries || {});\r\n    const parseOrder = (t) => {\r\n      if (typeof t !== \"string\") return 0;\r\n      const m1 = t.match(/\\[(\\d+)\\]/);\r\n      if (m1) return parseInt(m1[1], 10);\r\n      const m2 = t.match(/^(\\d+)[\\s-]/);\r\n      if (m2) return parseInt(m2[1], 10);\r\n      return 0;\r\n    };\r\n    const candidates = allEntries\r\n      .filter(\r\n        (e) =>\r\n          e && e.stmemorybooks === true && e.stmbArc !== true && !e.disable,\r\n      )\r\n      .sort(\r\n        (a, b) => parseOrder(a.comment || \"\") - parseOrder(b.comment || \"\"),\r\n      );\r\n\r\n    // Presets for Arc Analysis\r\n    await ArcPrompts.firstRunInitIfMissing(extension_settings?.STMemoryBooks);\r\n    const presets = await ArcPrompts.listPresets();\r\n    const defaultPresetKey = \"arc_default\";\r\n\r\n    // Defaults from settings\n    const settings = initializeSettings();\n    const tokenThreshold = settings?.moduleSettings?.tokenWarningThreshold ?? 30000;\n    const arcOrderMode = String(settings?.moduleSettings?.arcOrderMode || \"auto\");\n    const arcOrderValue = Number.isFinite(Number(settings?.moduleSettings?.arcOrderValue))\n      ? Math.trunc(Number(settings.moduleSettings.arcOrderValue))\n      : 100;\n    const arcReverseStart = Number.isFinite(Number(settings?.moduleSettings?.arcReverseStart))\n      ? Math.trunc(Number(settings.moduleSettings.arcReverseStart))\n      : 9999;\n\r\n    // Build popup content\r\n    let content = \"\";\r\n    content += `<h3>${escapeHtml(translate(\" Consolidate Memories into Arcs\", \"STMemoryBooks_ConsolidateArcs_Title\"))}</h3>`;\r\n\r\n    // Preset selector\r\n    content += '<div class=\"world_entry_form_control\">';\r\n    content += `<label><strong>${escapeHtml(translate(\"Preset\", \"STMemoryBooks_ConsolidateArcs_Preset\"))}:</strong> `;\r\n    content += '<select id=\"stmb-arc-preset\" class=\"text_pole\">';\r\n    for (const p of presets) {\r\n      const key = String(p.key || \"\");\r\n      const name = String(p.displayName || key);\r\n      const sel = key === defaultPresetKey ? \" selected\" : \"\";\r\n      content += `<option value=\"${escapeHtml(key)}\"${sel}>${escapeHtml(name)}</option>`;\r\n    }\r\n    content += `</select></label> <button id=\"stmb-arc-rebuild-builtins\" class=\"menu_button whitespacenowrap\">${escapeHtml(translate(\"Rebuild from built-ins\", \"STMemoryBooks_Arc_RebuildBuiltins\"))}</button></div>`;\r\n\r\n    // Options row\r\n    content += '<div class=\"flex-container flexGap10\">';\r\n    content += `<label>${escapeHtml(translate(\"Maximum number of memories to process in each pass\", \"STMemoryBooks_Arc_MaxPerPass\"))} <input id=\"stmb-arc-maxpass\" type=\"number\" min=\"1\" max=\"50\" value=\"12\" class=\"text_pole\" style=\"width:80px\"/></label>`;\r\n    content += `<label>${escapeHtml(translate(\"Number of automatic arc attempts\", \"STMemoryBooks_Arc_MaxPasses\"))} <input id=\"stmb-arc-maxpasses\" type=\"number\" min=\"1\" max=\"50\" value=\"10\" class=\"text_pole\" style=\"width:100px\"/></label>`;\r\n    content += `<label>${escapeHtml(translate(\"Minimum number of memories in each arc\", \"STMemoryBooks_Arc_MinAssigned\"))} <input id=\"stmb-arc-minassigned\" type=\"number\" min=\"1\" max=\"12\" value=\"2\" class=\"text_pole\" style=\"width:110px\"/></label>`;\r\n    content += `<label>${escapeHtml(translate(\"Token Budget\", \"STMemoryBooks_Arc_TokenBudget\"))} <input id=\"stmb-arc-token\" type=\"number\" min=\"1000\" max=\"100000\" value=\"${tokenThreshold}\" class=\"text_pole\" style=\"width:120px\"/></label>`;\n    content += \"</div>\";\n\n    // Arc ordering (applies to newly created arcs)\n    content += '<div class=\"world_entry_form_control\">';\n    content += `<div><strong>${escapeHtml(translate(\"Arc entry order\", \"STMemoryBooks_Arc_Order_Label\"))}</strong></div>`;\n    content += `<small class=\"opacity70p\">${escapeHtml(translate(\"Controls the lorebook 'order' for newly created arcs only.\", \"STMemoryBooks_Arc_Order_Help\"))}</small>`;\n    content += '<div style=\"display:flex; flex-direction:column; gap:6px; margin-top:6px\">';\n    content += `<label class=\"checkbox_label\"><input type=\"radio\" name=\"stmb-arc-order-mode\" value=\"auto\"${\n      arcOrderMode === \"auto\" ? \" checked\" : \"\"\n    }> <span>${escapeHtml(translate(\"Auto (uses arc #)\", \"STMemoryBooks_Arc_AutoOrder\"))}</span></label>`;\n    content += `<label class=\"checkbox_label\"><input type=\"radio\" name=\"stmb-arc-order-mode\" value=\"reverse\"${\n      arcOrderMode === \"reverse\" ? \" checked\" : \"\"\n    }> <span>${escapeHtml(translate(\"Reverse (only use with Outlets)\", \"STMemoryBooks_ReverseOrder\"))}</span> <input type=\"number\" id=\"stmb-arc-reverse-start\" value=\"${escapeHtml(String(arcReverseStart))}\" class=\"text_pole ${\n      arcOrderMode === \"reverse\" ? \"\" : \"displayNone\"\n    } width100px\" min=\"100\" max=\"9999\" step=\"1\" style=\"margin-left: auto;\"></label>`;\n    content += `<label class=\"checkbox_label\"><input type=\"radio\" name=\"stmb-arc-order-mode\" value=\"manual\"${\n      arcOrderMode === \"manual\" ? \" checked\" : \"\"\n    }> <span>${escapeHtml(translate(\"Manual\", \"STMemoryBooks_ManualOrder\"))}</span> <input type=\"number\" id=\"stmb-arc-order-value\" value=\"${escapeHtml(String(arcOrderValue))}\" class=\"text_pole ${\n      arcOrderMode === \"manual\" ? \"\" : \"displayNone\"\n    } width100px\" min=\"0\" max=\"9999\" step=\"1\" style=\"margin-left: auto;\"></label>`;\n    content += \"</div>\";\n    content += \"</div>\";\n\n    // Disable originals toggle\n    content += '<div class=\"world_entry_form_control\" class=\"flex-container\"><div class=\"flex flexFlowRow alignItemsBaseline\">';\n    content += `<label class=\"checkbox_label\"><input id=\"stmb-arc-disable-originals\" type=\"checkbox\"/> ${escapeHtml(translate(\"Disable original memories after creating arcs\", \"STMemoryBooks_ConsolidateArcs_DisableOriginals\"))}</label>`;\n    content += \"</div></div>\";\n\r\n    // Entries checklist\r\n    content += `<div class=\"world_entry_form_control\"><div class=\"flex-container flexGap10 marginBot5\">`;\r\n    content += `<button id=\"stmb-arc-select-all\" class=\"menu_button\">${escapeHtml(translate(\"Select All\", \"STMemoryBooks_SelectAll\"))}</button>`;\r\n    content += `<button id=\"stmb-arc-deselect-all\" class=\"menu_button\">${escapeHtml(translate(\"Deselect All\", \"STMemoryBooks_DeselectAll\"))}</button>`;\r\n    content += `</div>`;\r\n    content += `<div id=\"stmb-arc-list\" style=\"max-height:300px; overflow-y:auto; border:1px solid var(--SmartHover2); padding:6px\">`;\r\n    for (const e of candidates) {\r\n      const title = e.comment || \"(untitled)\";\r\n      const uid = String(e.uid);\r\n      const ord = parseOrder(title);\r\n      content += `<label class=\"flex-container flexGap10\" style=\"align-items:center; margin:2px 0;\"><input type=\"checkbox\" class=\"stmb-arc-item\" value=\"${escapeHtml(uid)}\" checked /> <span class=\"opacity70p\">[${String(ord).padStart(3, \"0\")}]</span> <span>${escapeHtml(title)}</span></label>`;\r\n    }\r\n    content += `</div>`;\r\n    content += `<small class=\"opacity70p\">${escapeHtml(translate(\"Tip: uncheck memories that should not be included.\", \"STMemoryBooks_ConsolidateArcs_Tip\"))}</small>`;\r\n    content += \"</div>\";\r\n\r\n    const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, \"\", {\r\n      wide: true,\r\n      large: true,\r\n      allowVerticalScrolling: true,\r\n      okButton: translate(\"Run\", \"STMemoryBooks_Run\"),\r\n      cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n    });\r\n\r\n    // Attach handlers before show\r\n    const dlg = popup.dlg;\r\n    try {\r\n      applyLocale(dlg);\r\n    } catch (e) {\r\n      /* noop */\r\n    }\r\n    dlg\r\n      .querySelector(\"#stmb-arc-select-all\")\r\n      ?.addEventListener(\"click\", (e) => {\r\n        e.preventDefault();\r\n        dlg\r\n          .querySelectorAll(\".stmb-arc-item\")\r\n          .forEach((cb) => (cb.checked = true));\r\n      });\r\n    dlg\n      .querySelector(\"#stmb-arc-deselect-all\")\n      ?.addEventListener(\"click\", (e) => {\n        e.preventDefault();\n        dlg\n          .querySelectorAll(\".stmb-arc-item\")\n          .forEach((cb) => (cb.checked = false));\n      });\n\n    // Arc order mode visibility\n    const syncArcOrderVisibility = () => {\n      const mode =\n        dlg.querySelector('input[name=\"stmb-arc-order-mode\"]:checked')?.value ||\n        \"auto\";\n      dlg\n        .querySelector(\"#stmb-arc-reverse-start\")\n        ?.classList.toggle(\"displayNone\", mode !== \"reverse\");\n      dlg\n        .querySelector(\"#stmb-arc-order-value\")\n        ?.classList.toggle(\"displayNone\", mode !== \"manual\");\n    };\n    dlg\n      .querySelectorAll('input[name=\"stmb-arc-order-mode\"]')\n      .forEach((el) => el.addEventListener(\"change\", syncArcOrderVisibility));\n    syncArcOrderVisibility();\n\r\n    // Rebuild Arc prompts from built-ins with backup and refresh preset list\r\n    dlg\r\n      .querySelector(\"#stmb-arc-rebuild-builtins\")\r\n      ?.addEventListener(\"click\", async (e) => {\r\n        e.preventDefault();\r\n        try {\r\n          const confirmContent = `\r\n                    <h3>${escapeHtml(translate(\"Rebuild Arc Prompts from Built-ins\", \"STMemoryBooks_Arc_RebuildTitle\"))}</h3>\r\n                    <div class=\"info-block warning\">\r\n                        ${escapeHtml(translate(\"This will overwrite your saved Arc prompt presets with the built-ins. A timestamped backup will be created.\", \"STMemoryBooks_Arc_RebuildWarning\"))}\r\n                    </div>\r\n                    <p class=\"opacity70p\">${escapeHtml(translate(\"After rebuild, the preset list will refresh automatically.\", \"STMemoryBooks_Arc_RebuildNote\"))}</p>\r\n                `;\r\n          const confirmPopup = new Popup(\r\n            confirmContent,\r\n            POPUP_TYPE.CONFIRM,\r\n            \"\",\r\n            {\r\n              okButton: translate(\"Rebuild\", \"STMemoryBooks_Rebuild\"),\r\n              cancelButton: translate(\"Cancel\", \"STMemoryBooks_Cancel\"),\r\n            },\r\n          );\r\n          const cres = await confirmPopup.show();\r\n          if (cres !== POPUP_RESULT.AFFIRMATIVE) return;\r\n\r\n          const result = await ArcPrompts.rebuildFromBuiltIns({ backup: true });\r\n\r\n          // Reload presets and repopulate selector\r\n          const newPresets = await ArcPrompts.listPresets();\r\n          const selEl = dlg.querySelector(\"#stmb-arc-preset\");\r\n          if (selEl) {\r\n            const selectedBefore = selEl.value || defaultPresetKey;\r\n            selEl.innerHTML = \"\";\r\n            for (const p of newPresets) {\r\n              const key = String(p.key || \"\");\r\n              const name = String(p.displayName || key);\r\n              const opt = document.createElement(\"option\");\r\n              opt.value = key;\r\n              opt.textContent = name;\r\n              selEl.appendChild(opt);\r\n            }\r\n            if (\r\n              Array.from(selEl.options).some((o) => o.value === selectedBefore)\r\n            ) {\r\n              selEl.value = selectedBefore;\r\n            } else {\r\n              selEl.value = defaultPresetKey;\r\n            }\r\n          }\r\n\r\n          try {\r\n            window.dispatchEvent(new CustomEvent(\"stmb-arc-presets-updated\"));\r\n          } catch (e2) {\r\n            /* noop */\r\n          }\r\n\r\n          const backupMsg = result?.backupName\r\n            ? ` (backup: ${result.backupName}) `\r\n            : \"\";\r\n          toastr.success(\r\n            __st_t_tag`Rebuilt Arc prompts (${result?.count || 0} presets)${backupMsg}`,\r\n            \"STMemoryBooks\",\r\n          );\r\n        } catch (err) {\r\n          console.error(\"STMemoryBooks: Arc prompts rebuild failed:\", err);\r\n          toastr.error(\r\n            __st_t_tag`Failed to rebuild Arc prompts: ${err.message}`,\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      });\r\n\r\n    const res = await popup.show();\r\n    if (res !== POPUP_RESULT.AFFIRMATIVE) return;\r\n\r\n    // Gather selections\r\n    const selected = Array.from(dlg.querySelectorAll(\".stmb-arc-item\"))\r\n      .filter((cb) => cb.checked)\r\n      .map((cb) => cb.value);\r\n    if (selected.length === 0) {\r\n      toastr.error(\r\n        translate(\r\n          \"Select at least one memory to consolidate.\",\r\n          \"STMemoryBooks_SelectAtLeastOne\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    // If there is no lorebook assigned, show a focused toast and stop before heavy work\r\n    if (!lorebookName) {\r\n      toastr.info(\r\n        \"Arc consolidation requires a memory lorebook. No lorebook assigned.\",\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    const presetKey = String(\r\n      dlg.querySelector(\"#stmb-arc-preset\")?.value || \"arc_default\",\r\n    );\r\n    const options = {\r\n      presetKey,\r\n      maxItemsPerPass: Math.max(\r\n        1,\r\n        readIntInput(dlg.querySelector(\"#stmb-arc-maxpass\"), 12),\r\n      ),\r\n      maxPasses: Math.max(\r\n        1,\r\n        readIntInput(dlg.querySelector(\"#stmb-arc-maxpasses\"), 10),\r\n      ),\r\n      minAssigned: Math.max(\r\n        1,\r\n        readIntInput(dlg.querySelector(\"#stmb-arc-minassigned\"), 2),\r\n      ),\r\n      tokenTarget: Math.max(\r\n        1000,\r\n        readIntInput(dlg.querySelector(\"#stmb-arc-token\"), tokenThreshold),\r\n      ),\r\n    };\r\n    const disableOriginals = !!dlg.querySelector(\"#stmb-arc-disable-originals\")\n      ?.checked;\n\n    // Persist arc order preferences (applies to newly created arcs)\n    const chosenArcOrderMode = String(\n      dlg.querySelector('input[name=\"stmb-arc-order-mode\"]:checked')?.value ||\n        \"auto\",\n    ).toLowerCase();\n    const chosenArcOrderValue = clampInt(\n      readIntInput(dlg.querySelector(\"#stmb-arc-order-value\"), arcOrderValue),\n      0,\n      9999,\n    );\n    const chosenArcReverseStart = clampInt(\n      readIntInput(dlg.querySelector(\"#stmb-arc-reverse-start\"), arcReverseStart),\n      100,\n      9999,\n    );\n    const normalizedArcOrderMode =\n      chosenArcOrderMode === \"manual\" || chosenArcOrderMode === \"reverse\"\n        ? chosenArcOrderMode\n        : \"auto\";\n    extension_settings.STMemoryBooks.moduleSettings.arcOrderMode =\n      normalizedArcOrderMode;\n    extension_settings.STMemoryBooks.moduleSettings.arcOrderValue =\n      chosenArcOrderValue;\n    extension_settings.STMemoryBooks.moduleSettings.arcReverseStart =\n      chosenArcReverseStart;\n    saveSettingsDebounced();\n\r\n    const entryMap = new Map(candidates.map((e) => [String(e.uid), e]));\r\n    const selectedEntries = selected\r\n      .map((id) => entryMap.get(String(id)))\r\n      .filter(Boolean);\r\n\r\n    toastr.info(\r\n      translate(\r\n        \"Consolidating memories into arcs...\",\r\n        \"STMemoryBooks_ConsolidatingArcs\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n      { timeOut: 0 },\r\n    );\r\n\r\n    // Run analysis (uses current UI model if no profile is passed)\r\n    let analysis;\r\n    try {\r\n      analysis = await runArcAnalysisSequential(selectedEntries, options, null);\r\n    } catch (e) {\r\n      try {\r\n        toastr.clear(lastArcFailureToast);\r\n      } catch (e2) {}\r\n      lastFailedArcError = e;\r\n      lastFailedArcContext = {\n        lorebookName,\n        lorebookData,\n        selectedEntries,\n        options,\n        disableOriginals,\n        arcOrderMode: normalizedArcOrderMode,\n        arcOrderValue: chosenArcOrderValue,\n        arcReverseStart: chosenArcReverseStart,\n      };\n\r\n      if (e?.name === \"ArcAIResponseError\") {\r\n        lastArcFailureToast = toastr.error(\r\n          __st_t_tag`Arc analysis failed (invalid JSON): ${e.message}`,\r\n          \"STMemoryBooks\",\r\n          {\r\n            timeOut: 0,\r\n            extendedTimeOut: 0,\r\n            closeButton: true,\r\n            tapToDismiss: false,\r\n            onclick: () => {\r\n              try {\r\n                showFailedArcResponsePopup(lastFailedArcError);\r\n              } catch (e3) {\r\n                console.error(e3);\r\n              }\r\n            },\r\n          },\r\n        );\r\n      } else {\r\n        toastr.error(__st_t_tag`Arc analysis failed: ${e.message}`, \"STMemoryBooks\");\r\n      }\r\n      return;\r\n    }\r\n    const { arcCandidates, leftovers } = analysis || {\r\n      arcCandidates: [],\r\n      leftovers: [],\r\n    };\r\n\r\n    if (!arcCandidates || arcCandidates.length === 0) {\r\n      // Even if parsing \"succeeded\", the model may have returned unusable structure\r\n      // (e.g. empty arcs, missing title/summary, or salvageable-but-messy output).\r\n      const syntheticError = {\r\n        name: \"ArcAIResponseError\",\r\n        code: \"ARC_NO_USABLE_ARCS\",\r\n        message: translate(\r\n          \"No usable arcs were produced from the model response.\",\r\n          \"STMemoryBooks_ArcAnalysis_NoUsableArcs\",\r\n        ),\r\n        rawText: analysis?.rawText || \"\",\r\n        retryRawText: analysis?.retryRawText || \"\",\r\n      };\r\n      lastFailedArcError = syntheticError;\r\n      lastFailedArcContext = {\n        lorebookName,\n        lorebookData,\n        selectedEntries,\n        options,\n        disableOriginals,\n        arcOrderMode: normalizedArcOrderMode,\n        arcOrderValue: chosenArcOrderValue,\n        arcReverseStart: chosenArcReverseStart,\n      };\n      try {\r\n        toastr.clear(lastArcFailureToast);\r\n      } catch (e2) {}\r\n      lastArcFailureToast = toastr.warning(\r\n        __st_t_tag`Arc analysis produced no usable arcs. Review the raw response to fix/extract an arc.`,\r\n        \"STMemoryBooks\",\r\n        {\r\n          timeOut: 0,\r\n          extendedTimeOut: 0,\r\n          closeButton: true,\r\n          tapToDismiss: false,\r\n          onclick: () => {\r\n            try {\r\n              showFailedArcResponsePopup(lastFailedArcError);\r\n            } catch (e3) {\r\n              console.error(e3);\r\n            }\r\n          },\r\n        },\r\n      );\r\n      try {\r\n        showFailedArcResponsePopup(lastFailedArcError);\r\n      } catch (e2) {\r\n        console.error(e2);\r\n      }\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const res2 = await commitArcs({\n         lorebookName,\n         lorebookData,\n         arcCandidates,\n         disableOriginals,\n         orderMode: normalizedArcOrderMode,\n         orderValue: chosenArcOrderValue,\n         reverseStart: chosenArcReverseStart,\n      });\n      const created = Array.isArray(res2?.results)\r\n        ? res2.results.length\r\n        : arcCandidates.length;\r\n      let msg = `Created ${created} arc${created === 1 ? \"\" : \"s\"}${leftovers?.length ? `, ${leftovers.length} leftover` : \"\"}.`;\r\n      if (created === 1 && (!leftovers || leftovers.length === 0)) {\r\n        msg += \" (all selected memories were consumed into a single arc)\";\r\n      }\r\n      toastr.success(__st_t_tag`${msg}`, \"STMemoryBooks\");\r\n      lastFailedArcError = null;\r\n      lastFailedArcContext = null;\r\n      try {\r\n        toastr.clear(lastArcFailureToast);\r\n      } catch (e) {}\r\n      lastArcFailureToast = null;\r\n    } catch (e) {\r\n      toastr.error(\r\n        __st_t_tag`Failed to commit arcs: ${e.message}`,\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: showArcConsolidationPopup failed:\", error);\r\n    toastr.error(\r\n      __st_t_tag`Failed to open consolidate popup: ${error.message}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Show main settings popup\r\n */\r\nasync function showSettingsPopup() {\r\n  const settings = initializeSettings();\r\n  await SummaryPromptManager.firstRunInitIfMissing(settings);\r\n  const sceneData = await getSceneData();\r\n\r\n  // Build Regex script options (Global, Scoped, Preset), include disabled too\r\n  const selectedRegexOutgoing = Array.isArray(\r\n    settings.moduleSettings.selectedRegexOutgoing,\r\n  )\r\n    ? settings.moduleSettings.selectedRegexOutgoing\r\n    : [];\r\n  const selectedRegexIncoming = Array.isArray(\r\n    settings.moduleSettings.selectedRegexIncoming,\r\n  )\r\n    ? settings.moduleSettings.selectedRegexIncoming\r\n    : [];\r\n  const regexOptions = [];\r\n  try {\r\n    const scripts = getRegexScripts({ allowedOnly: false }) || [];\r\n    scripts.forEach((script, index) => {\r\n      const key = `idx:${index}`;\r\n      const label = `${script?.scriptName || \"Untitled\"}${script?.disabled ? \" (disabled)\" : \"\"}`;\r\n      regexOptions.push({\r\n        key,\r\n        label,\r\n        selectedOutgoing: selectedRegexOutgoing.includes(key),\r\n        selectedIncoming: selectedRegexIncoming.includes(key),\r\n      });\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"STMemoryBooks: Failed to enumerate Regex scripts for UI\", e);\r\n  }\r\n  const selectedProfile = settings.profiles[settings.defaultProfile];\r\n  const sceneMarkers = getSceneMarkers();\r\n\r\n  // Get current lorebook information\r\n  const isManualMode = settings.moduleSettings.manualModeEnabled;\r\n  const chatBoundLorebook = chat_metadata?.[METADATA_KEY] ?? null;\r\n  const manualLorebook = sceneMarkers?.manualLorebook ?? null;\r\n\r\n  const templateData = {\n    hasScene: !!sceneData,\n    sceneData: sceneData,\n    highestMemoryProcessed: sceneMarkers?.highestMemoryProcessed,\n    hasHighestMemoryProcessed: Number.isFinite(sceneMarkers?.highestMemoryProcessed),\n    highestMemoryProcessedManuallySet:\n      !!sceneMarkers?.highestMemoryProcessedManuallySet,\n    alwaysUseDefault: settings.moduleSettings.alwaysUseDefault,\n    showMemoryPreviews: settings.moduleSettings.showMemoryPreviews,\n    showNotifications: settings.moduleSettings.showNotifications,\n    unhideBeforeMemory: settings.moduleSettings.unhideBeforeMemory || false,\n    refreshEditor: settings.moduleSettings.refreshEditor,\n    allowSceneOverlap: settings.moduleSettings.allowSceneOverlap,\n    manualModeEnabled: settings.moduleSettings.manualModeEnabled,\n    maxTokens:\n      (settings.moduleSettings.maxTokens ?? 0) > 0\n        ? settings.moduleSettings.maxTokens\n        : \"\",\n\n    // Lorebook status information\n    lorebookMode: isManualMode ? \"Manual\" : \"Automatic (Chat-bound)\",\n    currentLorebookName: isManualMode ? manualLorebook : chatBoundLorebook,\r\n    manualLorebookName: manualLorebook,\r\n    chatBoundLorebookName: chatBoundLorebook,\r\n    availableLorebooks: world_names ?? [],\r\n    autoHideMode: getAutoHideMode(settings.moduleSettings),\r\n    unhiddenEntriesCount: settings.moduleSettings.unhiddenEntriesCount ?? 2,\r\n    tokenWarningThreshold:\r\n      settings.moduleSettings.tokenWarningThreshold ?? 50000,\r\n    defaultMemoryCount: settings.moduleSettings.defaultMemoryCount ?? 0,\r\n    autoSummaryEnabled: settings.moduleSettings.autoSummaryEnabled ?? false,\r\n    autoSummaryInterval: settings.moduleSettings.autoSummaryInterval ?? 50,\r\n    autoSummaryBuffer: settings.moduleSettings.autoSummaryBuffer ?? 2,\r\n    autoCreateLorebook: settings.moduleSettings.autoCreateLorebook ?? false,\r\n    lorebookNameTemplate:\r\n      settings.moduleSettings.lorebookNameTemplate ||\r\n      \"LTM - {{char}} - {{chat}}\",\r\n    profiles: settings.profiles.map((profile, index) => ({\r\n      ...profile,\r\n      name:\r\n        profile?.isBuiltinCurrentST\r\n          ? translate(\r\n              \"Current SillyTavern Settings\",\r\n              \"STMemoryBooks_Profile_CurrentST\",\r\n            )\r\n          : profile.name,\r\n      isDefault: index === settings.defaultProfile,\r\n    })),\r\n    titleFormat: settings.titleFormat,\r\n    // Regex selection UI\r\n    useRegex: settings.moduleSettings.useRegex || false,\r\n    regexOptions,\r\n    selectedRegexOutgoing,\r\n    selectedRegexIncoming,\r\n    titleFormats: getDefaultTitleFormats().map((format) => ({\r\n      value: format,\r\n      isSelected: format === settings.titleFormat,\r\n    })),\r\n    showCustomInput: !getDefaultTitleFormats().includes(settings.titleFormat),\r\n    selectedProfile: {\r\n      ...selectedProfile,\r\n      connection:\r\n        selectedProfile.useDynamicSTSettings ||\r\n        selectedProfile?.connection?.api === \"current_st\"\r\n          ? (() => {\r\n              const currentApiInfo = getCurrentApiInfo();\r\n              const currentSettings = getUIModelSettings();\r\n              return {\r\n                api: currentApiInfo.completionSource || \"openai\",\r\n                model: currentSettings.model || \"Not Set\",\r\n                temperature: currentSettings.temperature ?? 0.7,\r\n              };\r\n            })()\r\n          : {\r\n              api: selectedProfile.connection?.api || \"openai\",\r\n              model: selectedProfile.connection?.model || \"Not Set\",\r\n              temperature:\r\n                selectedProfile.connection?.temperature !== undefined\r\n                  ? selectedProfile.connection.temperature\r\n                  : 0.7,\r\n            },\r\n      titleFormat: selectedProfile.titleFormat || settings.titleFormat,\r\n      effectivePrompt:\r\n        selectedProfile.prompt && selectedProfile.prompt.trim()\r\n          ? selectedProfile.prompt\r\n          : selectedProfile.preset\r\n            ? await SummaryPromptManager.getPrompt(selectedProfile.preset)\r\n            : getDefaultPrompt(),\r\n    },\r\n  };\r\n\r\n  const content = DOMPurify.sanitize(settingsTemplate(templateData));\r\n\r\n  // Build customButtons array dynamically based on current state\r\n  const customButtons = [];\r\n\r\n  (customButtons.push({\n    text:\n      \" \" + translate(\"Create Memory\", \"STMemoryBooks_CreateMemoryButton\"),\n    result: null,\n    classes: [\"menu_button\"],\n    action: async () => {\n      // Don't gate on `sceneData` captured when the popup opened:\n      // if the selected range is fully hidden, getSceneData() returns null and\n      // we'd block the click before initiateMemoryCreation() can run /unhide.\n      const markers = getSceneMarkers() || {};\n      if (markers.sceneStart == null || markers.sceneEnd == null) {\n        toastr.error(\n          translate(\n            \"No scene selected. Make sure both start and end points are set.\",\n            \"STMemoryBooks_NoSceneSelectedMakeSure\",\n          ),\n          \"STMemoryBooks\",\n        );\n        return;\n      }\n\r\n      // Capture the currently selected profile before proceeding\r\n      let selectedProfileIndex = settings.defaultProfile;\r\n      if (currentPopupInstance && currentPopupInstance.dlg) {\r\n        const profileSelect = currentPopupInstance.dlg.querySelector(\r\n          \"#stmb-profile-select\",\r\n        );\r\n        if (profileSelect) {\r\n          selectedProfileIndex =\r\n            parseInt(profileSelect.value) || settings.defaultProfile;\r\n          console.log(\r\n            `STMemoryBooks: Using profile index ${selectedProfileIndex} (${settings.profiles[selectedProfileIndex]?.name}) from main popup selection`,\r\n          );\r\n        }\r\n      }\r\n\r\n      await initiateMemoryCreation(selectedProfileIndex);\r\n    },\r\n  }),\r\n    customButtons.push({\r\n      text:\r\n        \" \" +\r\n        translate(\r\n          \"Consolidate Memories into Arcs\",\r\n          \"STMemoryBooks_ConsolidateArcsButton\",\r\n        ),\r\n      result: null,\r\n      classes: [\"menu_button\"],\r\n      action: async () => {\r\n        await showArcConsolidationPopup();\r\n      },\r\n    }),\r\n    customButtons.push({\r\n      text: \" \" + translate(\"Clear Scene\", \"STMemoryBooks_ClearSceneButton\"),\r\n      result: null,\r\n      classes: [\"menu_button\"],\r\n      action: () => {\r\n        clearScene();\r\n        refreshPopupContent();\r\n      },\r\n    }));\r\n\r\n  // Manual lorebook and profile buttons will be populated after popup creation\r\n\r\n  const popupOptions = {\r\n    wide: true,\r\n    large: true,\r\n    allowVerticalScrolling: true,\r\n    customButtons: customButtons,\r\n    cancelButton: translate(\"Close\", \"STMemoryBooks_Close\"),\r\n    okButton: false,\r\n    onClose: handleSettingsPopupClose,\r\n  };\r\n\r\n  try {\r\n    currentPopupInstance = new Popup(\r\n      content,\r\n      POPUP_TYPE.TEXT,\r\n      \"\",\r\n      popupOptions,\r\n    );\r\n    setupSettingsEventListeners();\r\n    populateInlineButtons();\r\n    await currentPopupInstance.show();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error showing settings popup:\", error);\r\n    currentPopupInstance = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Setup event listeners for settings popup using full event delegation\r\n */\r\nfunction setupSettingsEventListeners() {\r\n  if (!currentPopupInstance) return;\r\n\r\n  const popupElement = currentPopupInstance.dlg;\r\n\r\n  // Use full event delegation for all interactions\r\n  popupElement.addEventListener(\"click\", async (e) => {\r\n    const settings = initializeSettings();\r\n\r\n    // Regex selection button (visible only when \"Use regex\" is checked)\r\n    if (e.target && e.target.matches(\"#stmb-configure-regex\")) {\r\n      e.preventDefault();\r\n      try {\r\n        await showRegexSelectionPopup();\r\n      } catch (err) {\r\n        console.warn(\"STMemoryBooks: showRegexSelectionPopup failed\", err);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Note: Manual lorebook and profile management buttons are now handled via customButtons\r\n  });\r\n\r\n  // Handle change events using delegation\r\n  popupElement.addEventListener(\"change\", async (e) => {\r\n    const settings = initializeSettings();\r\n\r\n    // Use regex gate\r\n    if (e.target.matches(\"#stmb-use-regex\")) {\r\n      settings.moduleSettings.useRegex = e.target.checked;\r\n      saveSettingsDebounced();\r\n      const btn = popupElement.querySelector(\"#stmb-configure-regex\");\r\n      if (btn) btn.style.display = e.target.checked ? \"\" : \"none\";\r\n      return;\r\n    }\r\n\r\n    // Regex multi-selects\r\n    if (e.target.matches(\"#stmb-regex-outgoing\")) {\r\n      try {\r\n        const values = Array.from(e.target.selectedOptions || []).map(\r\n          (o) => o.value,\r\n        );\r\n        settings.moduleSettings.selectedRegexOutgoing = values;\r\n        saveSettingsDebounced();\r\n      } catch (err) {\r\n        console.warn(\r\n          \"STMemoryBooks: failed to save selectedRegexOutgoing\",\r\n          err,\r\n        );\r\n      }\r\n      return;\r\n    }\r\n    if (e.target.matches(\"#stmb-regex-incoming\")) {\r\n      try {\r\n        const values = Array.from(e.target.selectedOptions || []).map(\r\n          (o) => o.value,\r\n        );\r\n        settings.moduleSettings.selectedRegexIncoming = values;\r\n        saveSettingsDebounced();\r\n      } catch (err) {\r\n        console.warn(\r\n          \"STMemoryBooks: failed to save selectedRegexIncoming\",\r\n          err,\r\n        );\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-import-file\")) {\r\n      try {\r\n        importProfiles(e, settings, refreshPopupContent);\r\n      } catch (error) {\r\n        console.error(`${MODULE_NAME}: Error in import profiles:`, error);\r\n        toastr.error(\r\n          translate(\r\n            \"Failed to import profiles\",\r\n            \"STMemoryBooks_FailedToImportProfiles\",\r\n          ),\r\n          \"STMemoryBooks\",\r\n        );\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-allow-scene-overlap\")) {\r\n      settings.moduleSettings.allowSceneOverlap = e.target.checked;\r\n      saveSettingsDebounced();\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-unhide-before-memory\")) {\r\n      settings.moduleSettings.unhideBeforeMemory = e.target.checked;\r\n      saveSettingsDebounced();\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-manual-mode-enabled\")) {\r\n      const isEnabling = e.target.checked;\r\n\r\n      // Mutual exclusion: If enabling manual mode, disable auto-create\r\n      if (isEnabling) {\r\n        settings.moduleSettings.autoCreateLorebook = false;\r\n        const autoCreateCheckbox = document.querySelector(\r\n          \"#stmb-auto-create-lorebook\",\r\n        );\r\n        if (autoCreateCheckbox) {\r\n          autoCreateCheckbox.checked = false;\r\n        }\r\n      }\r\n\r\n      if (isEnabling) {\r\n        // Check if there's a chat-bound lorebook\r\n        const chatBoundLorebook = chat_metadata?.[METADATA_KEY];\r\n        const stmbData = getSceneMarkers() || {};\r\n\r\n        // If switching to manual mode and no manual lorebook is set\r\n        if (!stmbData.manualLorebook) {\r\n          // If there's a chat-bound lorebook, suggest using it or selecting a different one\r\n          if (chatBoundLorebook) {\r\n            const popupContent = `\r\n                            <h4 data-i18n=\"STMemoryBooks_ManualLorebookSetupTitle\">Manual Lorebook Setup</h4>\r\n                            <div class=\"world_entry_form_control\">\r\n                                <p data-i18n=\"STMemoryBooks_ManualLorebookSetupDesc1\" data-i18n-params='{\"name\": \"${chatBoundLorebook}\"}'>You have a chat-bound lorebook \"<strong>${chatBoundLorebook}</strong>\".</p>\r\n                                <p data-i18n=\"STMemoryBooks_ManualLorebookSetupDesc2\">Would you like to use it for manual mode or select a different one?</p>\r\n                            </div>\r\n                        `;\r\n\r\n            const popup = new Popup(popupContent, POPUP_TYPE.TEXT, \"\", {\r\n              okButton: translate(\r\n                \"Use Chat-bound\",\r\n                \"STMemoryBooks_UseChatBound\",\r\n              ),\r\n              cancelButton: translate(\r\n                \"Select Different\",\r\n                \"STMemoryBooks_SelectDifferent\",\r\n              ),\r\n            });\r\n            const result = await popup.show();\r\n\r\n            if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n              // Use the chat-bound lorebook as manual lorebook\r\n              stmbData.manualLorebook = chatBoundLorebook;\r\n              saveMetadataForCurrentContext();\r\n              toastr.success(\r\n                __st_t_tag`Manual lorebook set to \"${chatBoundLorebook}\"`,\r\n                \"STMemoryBooks\",\r\n              );\r\n            } else {\r\n              // Let user select a different lorebook\r\n              const selectedLorebook =\r\n                await showLorebookSelectionPopup(chatBoundLorebook);\r\n              if (!selectedLorebook) {\r\n                // User cancelled, revert the checkbox\r\n                e.target.checked = false;\r\n                return;\r\n              }\r\n              // showLorebookSelectionPopup already saved the selection and showed success message\r\n            }\r\n          } else {\r\n            // No chat-bound lorebook, prompt to select one\r\n            toastr.info(\r\n              translate(\r\n                \"Please select a lorebook for manual mode\",\r\n                \"STMemoryBooks_PleaseSelectLorebookForManualMode\",\r\n              ),\r\n              \"STMemoryBooks\",\r\n            );\r\n            const selectedLorebook = await showLorebookSelectionPopup();\r\n            if (!selectedLorebook) {\r\n              // User cancelled, revert the checkbox\r\n              e.target.checked = false;\r\n              return;\r\n            }\r\n            // showLorebookSelectionPopup already saved the selection and showed success message\r\n          }\r\n        }\r\n      }\r\n\r\n      settings.moduleSettings.manualModeEnabled = e.target.checked;\r\n      saveSettingsDebounced();\r\n      updateLorebookStatusDisplay();\r\n      populateInlineButtons();\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-auto-hide-mode\")) {\r\n      settings.moduleSettings.autoHideMode = e.target.value;\r\n      delete settings.moduleSettings.autoHideAllMessages;\r\n      delete settings.moduleSettings.autoHideLastMemory;\r\n      saveSettingsDebounced();\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-profile-select\")) {\r\n      const newIndex = clampInt(readIntInput(e.target), 0, profiles.length - 1);\r\n      if (newIndex >= 0 && newIndex < settings.profiles.length) {\r\n        const selectedProfile = settings.profiles[newIndex];\r\n        const summaryApi = popupElement.querySelector(\"#stmb-summary-api\");\r\n        const summaryModel = popupElement.querySelector(\"#stmb-summary-model\");\r\n        const summaryTemp = popupElement.querySelector(\"#stmb-summary-temp\");\r\n        const summaryTitle = popupElement.querySelector(\"#stmb-summary-title\");\r\n        const summaryPrompt = popupElement.querySelector(\r\n          \"#stmb-summary-prompt\",\r\n        );\r\n\r\n        if (\r\n          selectedProfile.useDynamicSTSettings ||\r\n          selectedProfile?.connection?.api === \"current_st\"\r\n        ) {\r\n          // For dynamic/current_st profiles, show current ST settings\r\n          const currentApiInfo = getCurrentApiInfo();\r\n          const currentSettings = getUIModelSettings();\r\n\r\n          if (summaryApi)\r\n            summaryApi.textContent =\r\n              currentApiInfo.completionSource || \"openai\";\r\n          if (summaryModel)\r\n            summaryModel.textContent =\r\n              currentSettings.model ||\r\n              translate(\"Not Set\", \"STMemoryBooks_NotSet\");\r\n          if (summaryTemp)\r\n            summaryTemp.textContent = Number(currentSettings.temperature ?? 0.7);\r\n        } else {\r\n          // For regular profiles, show stored settings\r\n          if (summaryApi)\r\n            summaryApi.textContent =\r\n              selectedProfile.connection?.api || \"openai\";\r\n          if (summaryModel)\r\n            summaryModel.textContent =\r\n              selectedProfile.connection?.model ||\r\n              translate(\"Not Set\", \"STMemoryBooks_NotSet\");\r\n          if (summaryTemp)\r\n            summaryTemp.textContent =\r\n              selectedProfile.connection?.temperature !== undefined\r\n                ? selectedProfile.connection.temperature\r\n                : \"0.7\";\r\n        }\r\n        // Title format is profile-specific\r\n        if (summaryTitle)\r\n          summaryTitle.textContent =\r\n            selectedProfile.titleFormat || settings.titleFormat;\r\n        if (summaryPrompt)\r\n          summaryPrompt.textContent =\r\n            await getEffectivePromptAsync(selectedProfile);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-title-format-select\")) {\r\n      const customInput = popupElement.querySelector(\r\n        \"#stmb-custom-title-format\",\r\n      );\r\n      const summaryTitle = popupElement.querySelector(\"#stmb-summary-title\");\r\n\r\n      if (e.target.value === \"custom\") {\r\n        customInput.classList.remove(\"displayNone\");\r\n        customInput.focus();\r\n      } else {\r\n        customInput.classList.add(\"displayNone\");\r\n        settings.titleFormat = e.target.value;\r\n        saveSettingsDebounced();\r\n\r\n        // Update the preview\r\n        if (summaryTitle) {\r\n          summaryTitle.textContent = e.target.value;\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-default-memory-count\")) {\r\n      const value = clampInt(readIntInput(e.target, settings.moduleSettings.defaultMemoryCount ?? 0), 0, 7);\r\n      settings.moduleSettings.defaultMemoryCount = value;\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-auto-summary-enabled\")) {\r\n      settings.moduleSettings.autoSummaryEnabled = e.target.checked;\r\n      saveSettingsDebounced();\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-auto-create-lorebook\")) {\r\n      const isEnabling = e.target.checked;\r\n\r\n      // Mutual exclusion: If enabling auto-create, disable manual mode\r\n      if (isEnabling) {\r\n        settings.moduleSettings.manualModeEnabled = false;\r\n        const manualModeCheckbox = document.querySelector(\r\n          \"#stmb-manual-mode-enabled\",\r\n        );\r\n        if (manualModeCheckbox) {\r\n          manualModeCheckbox.checked = false;\r\n        }\r\n      }\r\n\r\n      settings.moduleSettings.autoCreateLorebook = e.target.checked;\r\n      saveSettingsDebounced();\r\n      updateLorebookStatusDisplay();\r\n      populateInlineButtons();\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-auto-summary-interval\")) {\r\n      const value = parseInt(e.target.value);\r\n      if (!isNaN(value) && value >= 10 && value <= 200) {\r\n        settings.moduleSettings.autoSummaryInterval = value;\r\n        saveSettingsDebounced();\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (e.target.matches(\"#stmb-auto-summary-buffer\")) {\n      const value = readIntInput(e.target);\n      settings.moduleSettings.autoSummaryBuffer = clampInt(value ?? 0, 0, 50);\n      saveSettingsDebounced();\n      return;\n    }\n\n    if (e.target.matches(\"#stmb-max-tokens\")) {\n      const value = readIntInput(e.target, 0);\n      settings.moduleSettings.maxTokens = Number.isFinite(value) && value > 0 ? value : 0;\n      saveSettingsDebounced();\n      return;\n    }\n  });\n\r\n  // Handle input events using delegation with debouncing\r\n  popupElement.addEventListener(\r\n    \"input\",\r\n    lodash.debounce((e) => {\r\n      const settings = initializeSettings();\r\n\r\n      if (e.target.matches(\"#stmb-custom-title-format\")) {\r\n        const value = e.target.value.trim();\r\n        if (value && value.includes(\"000\")) {\r\n          settings.titleFormat = value;\r\n          saveSettingsDebounced();\r\n\r\n          // Update the preview\r\n          const summaryTitle = popupElement.querySelector(\r\n            \"#stmb-summary-title\",\r\n          );\r\n          if (summaryTitle) {\r\n            summaryTitle.textContent = value;\r\n          }\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (e.target.matches(\"#stmb-lorebook-name-template\")) {\r\n        const value = e.target.value.trim();\r\n        if (value) {\r\n          settings.moduleSettings.lorebookNameTemplate = value;\r\n          saveSettingsDebounced();\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (e.target.matches(\"#stmb-token-warning-threshold\")) {\r\n        const value = parseInt(e.target.value);\r\n        if (!isNaN(value) && value >= 1000 && value <= 100000) {\r\n          settings.moduleSettings.tokenWarningThreshold = value;\r\n          saveSettingsDebounced();\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (e.target.matches(\"#stmb-unhidden-entries-count\")) {\r\n        const value = parseInt(e.target.value);\r\n        if (!isNaN(value) && value >= 0 && value <= 50) {\r\n          settings.moduleSettings.unhiddenEntriesCount = value;\r\n          saveSettingsDebounced();\r\n        }\r\n        return;\r\n      }\r\n    }, 1000),\r\n  );\r\n}\r\n\r\n/**\r\n * Handle settings popup close\r\n */\r\nfunction handleSettingsPopupClose(popup) {\r\n  try {\r\n    const popupElement = popup.dlg;\r\n    const settings = initializeSettings();\r\n\r\n    // Save checkbox states\r\n    const alwaysUseDefault =\r\n      popupElement.querySelector(\"#stmb-always-use-default\")?.checked ??\r\n      settings.moduleSettings.alwaysUseDefault;\r\n    const showMemoryPreviews =\r\n      popupElement.querySelector(\"#stmb-show-memory-previews\")?.checked ??\r\n      settings.moduleSettings.showMemoryPreviews;\r\n    const showNotifications =\r\n      popupElement.querySelector(\"#stmb-show-notifications\")?.checked ??\r\n      settings.moduleSettings.showNotifications;\r\n    const unhideBeforeMemory =\r\n      popupElement.querySelector(\"#stmb-unhide-before-memory\")?.checked ??\r\n      settings.moduleSettings.unhideBeforeMemory;\r\n    const refreshEditor =\r\n      popupElement.querySelector(\"#stmb-refresh-editor\")?.checked ??\r\n      settings.moduleSettings.refreshEditor;\r\n    const allowSceneOverlap =\r\n      popupElement.querySelector(\"#stmb-allow-scene-overlap\")?.checked ??\r\n      settings.moduleSettings.allowSceneOverlap;\r\n    const autoHideMode =\r\n      popupElement.querySelector(\"#stmb-auto-hide-mode\")?.value ??\r\n      getAutoHideMode(settings.moduleSettings);\r\n\r\n    // Save token warning threshold\r\n    const tokenWarningThreshold = readIntInput(\r\n      popupElement.querySelector(\"#stmb-token-warning-threshold\"),\r\n      settings.moduleSettings.tokenWarningThreshold ?? 50000\r\n    );\r\n\r\n    // Save default memory count\r\n    const defaultMemoryCount = Number(popupElement.querySelector(\"#stmb-default-memory-count\").value);\r\n\r\n    // Save unhidden entries count\r\n    const unhiddenEntriesCount = readIntInput(\r\n      popupElement.querySelector(\"#stmb-unhidden-entries-count\"),\r\n      settings.moduleSettings.unhiddenEntriesCount ?? 0\r\n    );\r\n\r\n    const manualModeEnabled =\r\n      popupElement.querySelector(\"#stmb-manual-mode-enabled\")?.checked ??\r\n      settings.moduleSettings.manualModeEnabled;\r\n\r\n    // Save auto-summary settings\r\n    const autoSummaryEnabled =\r\n      popupElement.querySelector(\"#stmb-auto-summary-enabled\")?.checked ??\r\n      settings.moduleSettings.autoSummaryEnabled;\r\n    const autoSummaryInterval = readIntInput(\n      popupElement.querySelector(\"#stmb-auto-summary-interval\"),\n      settings.moduleSettings.autoSummaryInterval ?? 50\n    );\n\n    const autoSummaryBuffer = clampInt(readIntInput(popupElement.querySelector(\"#stmb-auto-summary-buffer\"),settings.moduleSettings.autoSummaryBuffer ?? 0),0,50);\n\n    // Save max tokens override (blank => 0)\n    const maxTokens = readIntInput(\n      popupElement.querySelector(\"#stmb-max-tokens\"),\n      0,\n    );\n    const maxTokensNormalized = Number.isFinite(maxTokens) && maxTokens > 0 ? maxTokens : 0;\n\n    // Save auto-create lorebook setting\n    const autoCreateLorebook =\n      popupElement.querySelector(\"#stmb-auto-create-lorebook\")?.checked ??\n      settings.moduleSettings.autoCreateLorebook;\n\r\n    const hasChanges =\r\n      alwaysUseDefault !== settings.moduleSettings.alwaysUseDefault ||\r\n      showMemoryPreviews !== settings.moduleSettings.showMemoryPreviews ||\r\n      showNotifications !== settings.moduleSettings.showNotifications ||\r\n      unhideBeforeMemory !== settings.moduleSettings.unhideBeforeMemory ||\r\n      refreshEditor !== settings.moduleSettings.refreshEditor ||\r\n      tokenWarningThreshold !== settings.moduleSettings.tokenWarningThreshold ||\r\n      defaultMemoryCount !== settings.moduleSettings.defaultMemoryCount ||\r\n      manualModeEnabled !== settings.moduleSettings.manualModeEnabled ||\r\n      allowSceneOverlap !== settings.moduleSettings.allowSceneOverlap ||\r\n      autoHideMode !== getAutoHideMode(settings.moduleSettings) ||\r\n      unhiddenEntriesCount !== settings.moduleSettings.unhiddenEntriesCount ||\r\n      autoSummaryEnabled !== settings.moduleSettings.autoSummaryEnabled ||\n      autoSummaryInterval !== settings.moduleSettings.autoSummaryInterval ||\n      autoSummaryBuffer !== settings.moduleSettings.autoSummaryBuffer ||\n      maxTokensNormalized !== (settings.moduleSettings.maxTokens ?? 0) ||\n      autoCreateLorebook !== settings.moduleSettings.autoCreateLorebook;\n\r\n    if (hasChanges) {\r\n      settings.moduleSettings.alwaysUseDefault = alwaysUseDefault;\r\n      settings.moduleSettings.showMemoryPreviews = showMemoryPreviews;\r\n      settings.moduleSettings.showNotifications = showNotifications;\r\n      settings.moduleSettings.unhideBeforeMemory = unhideBeforeMemory;\r\n      settings.moduleSettings.refreshEditor = refreshEditor;\r\n      settings.moduleSettings.tokenWarningThreshold = tokenWarningThreshold;\r\n      settings.moduleSettings.defaultMemoryCount = defaultMemoryCount;\r\n      settings.moduleSettings.manualModeEnabled = manualModeEnabled;\r\n      settings.moduleSettings.allowSceneOverlap = allowSceneOverlap;\r\n      settings.moduleSettings.autoHideMode = autoHideMode;\r\n      // Clear old boolean settings for clean migration\r\n      delete settings.moduleSettings.autoHideAllMessages;\r\n      delete settings.moduleSettings.autoHideLastMemory;\r\n      settings.moduleSettings.unhiddenEntriesCount = unhiddenEntriesCount;\n      settings.moduleSettings.autoSummaryEnabled = autoSummaryEnabled;\n      settings.moduleSettings.autoSummaryInterval = autoSummaryInterval;\n      settings.moduleSettings.autoSummaryBuffer = autoSummaryBuffer;\n      settings.moduleSettings.maxTokens = maxTokensNormalized;\n      settings.moduleSettings.autoCreateLorebook = autoCreateLorebook;\n      saveSettingsDebounced();\n    }\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Failed to save settings:\", error);\r\n    toastr.warning(\r\n      translate(\r\n        \"Failed to save settings. Please try again.\",\r\n        \"STMemoryBooks_FailedToSaveSettings\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n  }\r\n  currentPopupInstance = null;\r\n}\r\n\r\n/**\r\n * Refresh popup content while preserving popup properties\r\n */\r\nasync function refreshPopupContent() {\r\n  if (!currentPopupInstance || !currentPopupInstance.dlg.hasAttribute(\"open\")) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const settings = initializeSettings();\r\n    const sceneData = await getSceneData();\r\n    const selectedProfile = settings.profiles[settings.defaultProfile];\r\n    const sceneMarkers = getSceneMarkers();\r\n\r\n    // Get current lorebook information\r\n    const isManualMode = settings.moduleSettings.manualModeEnabled;\r\n    const chatBoundLorebook = chat_metadata?.[METADATA_KEY] || null;\r\n    const manualLorebook = sceneMarkers?.manualLorebook || null;\r\n\r\n    const templateData = {\n      hasScene: !!sceneData,\n      sceneData: sceneData,\n      highestMemoryProcessed: sceneMarkers?.highestMemoryProcessed,\n      hasHighestMemoryProcessed: Number.isFinite(\n        sceneMarkers?.highestMemoryProcessed,\n      ),\n      highestMemoryProcessedManuallySet:\n        !!sceneMarkers?.highestMemoryProcessedManuallySet,\n      alwaysUseDefault: settings.moduleSettings.alwaysUseDefault,\n      showMemoryPreviews: settings.moduleSettings.showMemoryPreviews,\n      showNotifications: settings.moduleSettings.showNotifications,\n      unhideBeforeMemory: settings.moduleSettings.unhideBeforeMemory || false,\n      refreshEditor: settings.moduleSettings.refreshEditor,\n      allowSceneOverlap: settings.moduleSettings.allowSceneOverlap,\n      manualModeEnabled: settings.moduleSettings.manualModeEnabled,\n      maxTokens:\n        (settings.moduleSettings.maxTokens ?? 0) > 0\n          ? settings.moduleSettings.maxTokens\n          : \"\",\n\n      // Lorebook status information\n      lorebookMode: isManualMode ? \"Manual\" : \"Automatic (Chat-bound)\",\n      currentLorebookName: isManualMode ? manualLorebook : chatBoundLorebook,\r\n      manualLorebookName: manualLorebook,\r\n      chatBoundLorebookName: chatBoundLorebook,\r\n      availableLorebooks: world_names ?? [],\r\n      autoHideMode: getAutoHideMode(settings.moduleSettings),\r\n      unhiddenEntriesCount: settings.moduleSettings.unhiddenEntriesCount ?? 0,\r\n      tokenWarningThreshold:\r\n        settings.moduleSettings.tokenWarningThreshold ?? 50000,\r\n      defaultMemoryCount: settings.moduleSettings.defaultMemoryCount ?? 0,\r\n      autoSummaryEnabled: settings.moduleSettings.autoSummaryEnabled ?? false,\r\n      autoSummaryInterval: settings.moduleSettings.autoSummaryInterval ?? 50,\r\n      autoSummaryBuffer: settings.moduleSettings.autoSummaryBuffer ?? 0,\r\n      autoCreateLorebook: settings.moduleSettings.autoCreateLorebook ?? false,\r\n      lorebookNameTemplate:\r\n        settings.moduleSettings.lorebookNameTemplate ||\r\n        \"LTM - {{char}} - {{chat}}\",\r\n      profiles: settings.profiles.map((profile, index) => ({\r\n        ...profile,\r\n        name:\r\n          profile?.isBuiltinCurrentST\r\n            ? translate(\r\n                \"Current SillyTavern Settings\",\r\n                \"STMemoryBooks_Profile_CurrentST\",\r\n              )\r\n            : profile.name,\r\n        isDefault: index === settings.defaultProfile,\r\n      })),\r\n      titleFormat: settings.titleFormat,\r\n      titleFormats: getDefaultTitleFormats().map((format) => ({\r\n        value: format,\r\n        isSelected: format === settings.titleFormat,\r\n      })),\r\n      showCustomInput: !getDefaultTitleFormats().includes(settings.titleFormat),\r\n      selectedProfile: {\r\n        ...selectedProfile,\r\n        connection:\r\n          selectedProfile.useDynamicSTSettings ||\r\n          selectedProfile?.connection?.api === \"current_st\"\r\n            ? (() => {\r\n                const currentApiInfo = getCurrentApiInfo();\r\n                const currentSettings = getUIModelSettings();\r\n                return {\r\n                  api: currentApiInfo.completionSource || \"openai\",\r\n                  model: currentSettings.model || \"Not Set\",\r\n                  temperature: currentSettings.temperature ?? 0.7,\r\n                };\r\n              })()\r\n            : {\r\n                api: selectedProfile.connection?.api || \"openai\",\r\n                model: selectedProfile.connection?.model || \"gpt-4.1\",\r\n                temperature: selectedProfile.connection?.temperature ?? 0.7,\r\n              },\r\n        titleFormat: selectedProfile.titleFormat || settings.titleFormat,\r\n        effectivePrompt:\r\n          selectedProfile.prompt && selectedProfile.prompt.trim()\r\n            ? selectedProfile.prompt\r\n            : selectedProfile.preset\r\n              ? await SummaryPromptManager.getPrompt(selectedProfile.preset)\r\n              : getDefaultPrompt(),\r\n      },\r\n    };\r\n\r\n    const newHtml = DOMPurify.sanitize(settingsTemplate(templateData));\r\n\r\n    // Update the popup content directly\r\n    currentPopupInstance.content.innerHTML = newHtml;\r\n\r\n    // After updating content, refresh the profile dropdown selection\r\n    const profileSelect = currentPopupInstance.content.querySelector(\r\n      \"#stmb-profile-select\",\r\n    );\r\n    if (profileSelect) {\r\n      profileSelect.value = settings.defaultProfile;\r\n      // Trigger change event to update profile summary\r\n      profileSelect.dispatchEvent(new Event(\"change\"));\r\n    }\r\n\r\n    const requiredClasses = [\r\n      \"wide_dialogue_popup\",\r\n      \"large_dialogue_popup\",\r\n      \"vertical_scrolling_dialogue_popup\",\r\n    ];\r\n    currentPopupInstance.dlg.classList.add(...requiredClasses);\r\n    currentPopupInstance.content.style.overflowY = \"auto\";\r\n\r\n    // Repopulate profile buttons after content refresh\r\n    populateInlineButtons();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Error refreshing popup content:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Process existing messages and use full update (for chat loads)\r\n */\r\nfunction processExistingMessages() {\r\n  const messageElements = document.querySelectorAll(\"#chat .mes[mesid]\");\r\n\r\n  if (messageElements.length > 0) {\r\n    let buttonsAdded = 0;\r\n    messageElements.forEach((messageElement) => {\r\n      // Check if buttons are already there to prevent duplication\r\n      if (!messageElement.querySelector(\".mes_stmb_start\")) {\r\n        createSceneButtons(messageElement);\r\n        buttonsAdded++;\r\n      }\r\n    });\r\n\r\n    // Full update needed for chat loads\r\n    updateAllButtonStates();\r\n  }\r\n}\r\n\r\n/**\r\n * Register slash commands using proper SlashCommand classes\r\n */\r\nfunction registerSlashCommands() {\r\n  const createMemoryCmd = SlashCommand.fromProps({\r\n    name: \"creatememory\",\r\n    callback: handleCreateMemoryCommand,\r\n    helpString: translate(\r\n      \"Create memory from marked scene\",\r\n      \"STMemoryBooks_Slash_CreateMemory_Help\",\r\n    ),\r\n  });\r\n\r\n  const sceneMemoryCmd = SlashCommand.fromProps({\r\n    name: \"scenememory\",\r\n    callback: handleSceneMemoryCommand,\r\n    helpString: translate(\r\n      \"Set scene range and create memory (e.g., /scenememory 10-15)\",\r\n      \"STMemoryBooks_Slash_SceneMemory_Help\",\r\n    ),\r\n    unnamedArgumentList: [\r\n      SlashCommandArgument.fromProps({\r\n        description: translate(\r\n          \"Message range (X-Y format)\",\r\n          \"STMemoryBooks_Slash_SceneMemory_ArgRangeDesc\",\r\n        ),\r\n        typeList: [ARGUMENT_TYPE.STRING],\r\n        isRequired: true,\r\n      }),\r\n    ],\r\n  });\r\n\r\n  const nextMemoryCmd = SlashCommand.fromProps({\r\n    name: \"nextmemory\",\r\n    callback: handleNextMemoryCommand,\r\n    helpString: translate(\r\n      \"Create memory from end of last memory to current message\",\r\n      \"STMemoryBooks_Slash_NextMemory_Help\",\r\n    ),\r\n  });\r\n\r\n  const sidePromptCmd = SlashCommand.fromProps({\r\n    name: \"sideprompt\",\r\n    callback: handleSidePromptCommand,\r\n    helpString: translate(\r\n      'Run side prompt. Usage: /sideprompt \"Name\" [X-Y]',\r\n      \"STMemoryBooks_Slash_SidePrompt_Help\",\r\n    ),\r\n    unnamedArgumentList: [\r\n      SlashCommandArgument.fromProps({\r\n        description: translate(\r\n          \"Template name (quote if contains spaces), optionally followed by X-Y range\",\r\n          \"STMemoryBooks_Slash_SidePrompt_ArgDesc\",\r\n        ),\r\n        typeList: [ARGUMENT_TYPE.STRING],\r\n        isRequired: true,\r\n        enumProvider: sidePromptTemplateEnumProvider,\r\n      }),\r\n    ],\r\n  });\r\n\r\n  // Register enable/disable sideprompt commands\r\n  const sidePromptOnCmd = SlashCommand.fromProps({\r\n    name: \"sideprompt-on\",\r\n    callback: handleSidePromptOnCommand,\r\n    helpString: translate(\r\n      'Enable a Side Prompt by name or all. Usage: /sideprompt-on \"Name\" | all',\r\n      \"STMemoryBooks_Slash_SidePromptOn_Help\",\r\n    ),\r\n    unnamedArgumentList: [\r\n      SlashCommandArgument.fromProps({\r\n        description: translate(\r\n          'Template name (quote if contains spaces) or \"all\"',\r\n          \"STMemoryBooks_Slash_SidePromptOn_ArgDesc\",\r\n        ),\r\n        typeList: [ARGUMENT_TYPE.STRING],\r\n        isRequired: true,\r\n        enumProvider: () => [\r\n          new SlashCommandEnumValue(\"all\"),\r\n          ...sidePromptTemplateEnumProvider(),\r\n        ],\r\n      }),\r\n    ],\r\n  });\r\n\r\n  const sidePromptOffCmd = SlashCommand.fromProps({\r\n    name: \"sideprompt-off\",\r\n    callback: handleSidePromptOffCommand,\r\n    helpString: translate(\r\n      'Disable a Side Prompt by name or all. Usage: /sideprompt-off \"Name\" | all',\r\n      \"STMemoryBooks_Slash_SidePromptOff_Help\",\r\n    ),\r\n    unnamedArgumentList: [\r\n      SlashCommandArgument.fromProps({\r\n        description: translate(\r\n          'Template name (quote if contains spaces) or \"all\"',\r\n          \"STMemoryBooks_Slash_SidePromptOff_ArgDesc\",\r\n        ),\r\n        typeList: [ARGUMENT_TYPE.STRING],\r\n        isRequired: true,\r\n        enumProvider: () => [\r\n          new SlashCommandEnumValue(\"all\"),\r\n          ...sidePromptTemplateEnumProvider(),\r\n        ],\r\n      }),\r\n    ],\r\n  });\r\n\r\n  const highestMemCmd = SlashCommand.fromProps({\n    name: \"stmb-highest\",\n    callback: handleHighestMemoryProcessedCommand,\n    helpString: translate(\n      \"Return the highest message index for processed memories in this chat. Usage: /stmb-highest\",\n      \"STMemoryBooks_Slash_Highest_Help\",\n    ),\n    returns: \"Highest memory processed message index as a string.\",\n  });\n\n  const setHighestMemCmd = SlashCommand.fromProps({\n    name: \"stmb-set-highest\",\n    callback: handleSetHighestMemoryProcessedCommand,\n    helpString: translate(\n      \"Manually set the highest processed message index for this chat. Usage: /stmb-set-highest <N|none>\",\n      \"STMemoryBooks_Slash_SetHighest_Help\",\n    ),\n    unnamedArgumentList: [\n      SlashCommandArgument.fromProps({\n        description: translate(\n          'Message index (0-based) or \"none\" to reset',\n          \"STMemoryBooks_Slash_SetHighest_ArgDesc\",\n        ),\n        typeList: [ARGUMENT_TYPE.STRING],\n        isRequired: true,\n      }),\n    ],\n  });\n\n  SlashCommandParser.addCommandObject(createMemoryCmd);\n  SlashCommandParser.addCommandObject(sceneMemoryCmd);\n  SlashCommandParser.addCommandObject(nextMemoryCmd);\n  SlashCommandParser.addCommandObject(sidePromptCmd);\n  SlashCommandParser.addCommandObject(sidePromptOnCmd);\n  SlashCommandParser.addCommandObject(sidePromptOffCmd);\n  SlashCommandParser.addCommandObject(highestMemCmd);\n  SlashCommandParser.addCommandObject(setHighestMemCmd);\n}\n\r\n/**\r\n * Create main menu UI\r\n */\r\nfunction createUI() {\r\n  const menuItem = $(\r\n    `\r\n        <div id=\"stmb-menu-item-container\" class=\"extension_container interactable\" tabindex=\"0\">\r\n            <div id=\"stmb-menu-item\" class=\"list-group-item flex-container flexGap5 interactable\" tabindex=\"0\">\r\n                <div class=\"fa-fw fa-solid fa-book extensionsMenuExtensionButton\"></div>\r\n                <span data-i18n=\"STMemoryBooks_MenuItem\">Memory Books</span>\r\n            </div>\r\n        </div>\r\n        `,\r\n  );\r\n\r\n  const extensionsMenu = $(\"#extensionsMenu\");\r\n  if (extensionsMenu.length > 0) {\r\n    extensionsMenu.append(menuItem);\r\n    applyLocale(menuItem[0]);\r\n  } else {\r\n    console.warn(\r\n      \"STMemoryBooks: Extensions menu not found - retrying initialization\",\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Setup event listeners\r\n */\r\nfunction setupEventListeners() {\r\n  $(document).on(\"click\", SELECTORS.menuItem, showSettingsPopup);\r\n\r\n  eventSource.on(event_types.CHAT_CHANGED, handleChatChanged);\r\n  eventSource.on(event_types.MESSAGE_DELETED, (deletedId) => {\r\n    const settings = initializeSettings();\r\n    handleMessageDeletion(deletedId, settings);\r\n  });\r\n  eventSource.on(event_types.MESSAGE_RECEIVED, handleMessageReceived);\r\n  eventSource.on(\r\n    event_types.GROUP_WRAPPER_FINISHED,\r\n    handleGroupWrapperFinished,\r\n  );\r\n\r\n  // Track dry-run state for generation events\r\n  eventSource.on(event_types.GENERATION_STARTED, (type, options, dryRun) => {\r\n    isDryRun = dryRun || false;\r\n    // Clear any prior persistent failure toast and error when a new generation starts\r\n    try {\r\n      if (lastFailureToast) {\r\n        toastr.clear(lastFailureToast);\r\n      }\r\n    } catch (e) {\r\n      /* noop */\r\n    }\r\n    lastFailureToast = null;\r\n    lastFailedAIError = null;\r\n    lastFailedAIContext = null;\r\n  });\r\n\r\n  // Model settings change handlers\r\n  const modelSelectors = Object.values(SELECTORS)\r\n    .filter(\r\n      (selector) => selector.includes(\"model_\") || selector.includes(\"temp_\"),\r\n    )\r\n    .join(\", \");\r\n\r\n  eventSource.on(event_types.GENERATE_AFTER_DATA, (generate_data) => {\r\n    if (isDryRun) {\r\n      return; // Skip all processing during dry-run\r\n    }\r\n    if (isProcessingMemory && currentProfile) {\r\n      const conn =\r\n        currentProfile.effectiveConnection || currentProfile.connection || {};\r\n      const apiToSource = {\r\n        openai: \"openai\",\r\n        claude: \"claude\",\r\n        openrouter: \"openrouter\",\r\n        ai21: \"ai21\",\r\n        makersuite: \"makersuite\",\r\n        google: \"makersuite\",\r\n        vertexai: \"vertexai\",\r\n        mistralai: \"mistralai\",\r\n        custom: \"custom\",\r\n        cohere: \"cohere\",\r\n        perplexity: \"perplexity\",\r\n        groq: \"groq\",\r\n        nanogpt: \"nanogpt\",\r\n        deepseek: \"deepseek\",\r\n        electronhub: \"electronhub\",\r\n        aimlapi: \"aimlapi\",\r\n        xai: \"xai\",\r\n        pollinations: \"pollinations\",\r\n        moonshot: \"moonshot\",\r\n        fireworks: \"fireworks\",\r\n        cometapi: \"cometapi\",\r\n        azure_openai: \"azure_openai\",\r\n        zai: \"zai\",\r\n        siliconflow: \"siliconflow\",\r\n      };\r\n      const src = apiToSource[conn.api] || \"openai\";\r\n\r\n      // Force source/model/temp\r\n      generate_data.chat_completion_source = src;\r\n\r\n      // Disable thinking mode for memory generation\r\n      generate_data.include_reasoning = false;\r\n\r\n      if (conn.model) {\r\n        generate_data.model = conn.model;\r\n      }\r\n      if (typeof conn.temperature === \"number\") {\r\n        generate_data.temperature = conn.temperature;\r\n      }\r\n    }\r\n  });\r\n\r\n  window.addEventListener(\"beforeunload\", cleanupChatObserver);\r\n}\r\n\r\n/**\r\n * Show a popup with details for a failed AI response, including raw response and provider body if available.\r\n */\r\nasync function applyManualFixedJson(correctedRaw) {\r\n  if (isProcessingMemory) {\r\n    toastr.warning(\r\n      translate(\r\n        \"Memory generation is already in progress.\",\r\n        \"STMemoryBooks_ManualFix_InProgress\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Set processing flag IMMEDIATELY after validation to prevent race conditions.\r\n    // NOTE: placing the assignment *inside* the try ensures the matching `finally` clears the flag\r\n    // even if an error/exception occurs before the try body completes. The trade-off is a very\r\n    // small window between the initial guard and this assignment where a race could occur.\r\n    isProcessingMemory = true;\r\n    const context = lastFailedAIContext; \r\n    if (\r\n      !context?.compiledScene ||\r\n      !context?.profileSettings ||\r\n      !context?.lorebookValidation?.valid\r\n    ) {\r\n      toastr.error(\r\n        translate(\r\n          \"Missing failure context; cannot apply corrected JSON.\",\r\n          \"STMemoryBooks_ManualFix_NoContext\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n    if (\r\n      !context?.sceneData ||\r\n      context.sceneData.sceneEnd === undefined ||\r\n      context.sceneData.sceneStart === undefined\r\n    ) {\r\n      toastr.error(\r\n        translate(\r\n          \"Missing scene range; cannot apply corrected JSON.\",\r\n          \"STMemoryBooks_ManualFix_NoSceneRange\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n  const trimmedRaw = String(correctedRaw || \"\").trim();\r\n  if (!trimmedRaw) {\r\n    toastr.error(\r\n      translate(\r\n        \"Corrected JSON is empty.\",\r\n        \"STMemoryBooks_ManualFix_EmptyJson\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n\r\n  let jsonResult;\r\n  try {\r\n    jsonResult = parseAIJsonResponse(trimmedRaw);\r\n  } catch (error) {\r\n    const msg = error?.message || \"Failed to parse corrected JSON.\";\r\n    const code = error?.code ? ` [${error.code}]` : \"\";\r\n    toastr.error(\r\n      __st_t_tag`Corrected JSON is still invalid${code}: ${msg}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n\r\n  if (!jsonResult.content && !jsonResult.summary && !jsonResult.memory_content) {\r\n    toastr.error(\r\n      translate(\r\n        \"Corrected JSON is missing content.\",\r\n        \"STMemoryBooks_ManualFix_MissingContent\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n  if (!jsonResult.title) {\r\n    toastr.error(\r\n      translate(\r\n        \"Corrected JSON is missing title.\",\r\n        \"STMemoryBooks_ManualFix_MissingTitle\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n  if (!Array.isArray(jsonResult.keywords)) {\r\n    toastr.error(\r\n      translate(\r\n        \"Corrected JSON is missing keywords array.\",\r\n        \"STMemoryBooks_ManualFix_MissingKeywords\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n\r\n  const compiledScene = context.compiledScene;\r\n  const profile = context.profileSettings;\r\n  const cleanContent = (\r\n    jsonResult.content ||\r\n    jsonResult.summary ||\r\n    jsonResult.memory_content ||\r\n    \"\"\r\n  ).trim();\r\n  const cleanTitle = (jsonResult.title || \"Memory\").trim();\r\n  const cleanKeywords = Array.isArray(jsonResult.keywords) ? jsonResult.keywords.filter((k) => k && typeof k === \"string\" && k.trim() !== \"\") : [];\r\n  const resolvedSceneStats = context.sceneStats || null;\r\n  const sceneRange =\r\n    context.sceneRange ||\r\n    `${compiledScene.metadata.sceneStart}-${compiledScene.metadata.sceneEnd}`;\r\n  const memoryResult = {\r\n    content: cleanContent,\r\n    extractedTitle: cleanTitle,\r\n    metadata: {\r\n      sceneRange,\r\n      messageCount: compiledScene.metadata?.messageCount,\r\n      characterName: compiledScene.metadata?.characterName,\r\n      userName: compiledScene.metadata?.userName,\r\n      chatId: compiledScene.metadata?.chatId,\r\n      createdAt: new Date().toISOString(),\r\n      profileUsed: profile.name,\r\n      presetUsed: profile.preset || \"custom\",\r\n      tokenUsage: resolvedSceneStats\r\n        ? { estimatedTokens: resolvedSceneStats.estimatedTokens }\r\n        : undefined,\r\n      generationMethod: \"manual-json-repair\",\r\n      version: \"2.0\",\r\n    },\r\n    suggestedKeys: cleanKeywords,\r\n    titleFormat:\r\n      profile.useDynamicSTSettings || profile?.connection?.api === \"current_st\"\r\n        ? extension_settings.STMemoryBooks?.titleFormat || \"[000] - {{title}}\"\r\n        : profile.titleFormat || \"[000] - {{title}}\",\r\n    lorebookSettings: {\r\n      constVectMode: profile.constVectMode,\r\n      position: profile.position,\r\n      orderMode: profile.orderMode,\r\n      orderValue: profile.orderValue,\r\n      preventRecursion: profile.preventRecursion,\r\n      delayUntilRecursion: profile.delayUntilRecursion,\r\n      outletName:\r\n        Number(profile.position) === 7 ? profile.outletName || \"\" : undefined,\r\n    },\r\n    lorebook: {\r\n      content: cleanContent,\r\n      comment: `Auto-generated memory from messages ${sceneRange}. Profile: ${profile.name}.`,\r\n      key: cleanKeywords || [],\r\n      keysecondary: [],\r\n      selective: true,\r\n      constant: false,\r\n      order: 100,\r\n      position: \"before_char\",\r\n      disable: false,\r\n      addMemo: true,\r\n      excludeRecursion: false,\r\n      delayUntilRecursion: true,\r\n      probability: 100,\r\n      useProbability: false,\r\n    },\r\n  };\r\n\r\n  const addResult = await addMemoryToLorebook(\r\n    memoryResult,\r\n    context.lorebookValidation,\r\n  );\r\n\r\n  if (!addResult.success) {\r\n    throw new Error(addResult.error || \"Failed to add memory to lorebook\");\r\n  }\r\n\r\n  try {\r\n    const connDbg = profile.effectiveConnection || profile.connection || {};\r\n    console.debug(\"STMemoryBooks: Passing profile to runAfterMemory\", {\r\n      api: connDbg.api,\r\n      model: connDbg.model,\r\n      temperature: connDbg.temperature,\r\n    });\r\n    await runAfterMemory(compiledScene, profile);\r\n  } catch (e) {\r\n    console.warn(\"STMemoryBooks: runAfterMemory failed:\", e);\r\n  }\r\n\r\n  try {\n    const stmbData = getSceneMarkers() || {};\n    stmbData.highestMemoryProcessed = context.sceneData.sceneEnd;\n    delete stmbData.highestMemoryProcessedManuallySet;\n    saveMetadataForCurrentContext();\n  } catch (e) {\n    console.warn(\n      \"STMemoryBooks: Failed to update highestMemoryProcessed baseline:\",\n      e,\n    );\r\n  }\r\n\r\n  clearAutoSummaryState();\r\n\r\n  const contextMsg =\r\n    context.memoryFetchResult?.actualCount > 0\r\n      ? ` (with ${context.memoryFetchResult.actualCount} context ${context.memoryFetchResult.actualCount === 1 ? \"memory\" : \"memories\"})`\r\n      : \"\";\r\n\r\n  toastr.clear();\r\n  lastFailureToast = null;\r\n  lastFailedAIError = null;\r\n  lastFailedAIContext = null;\r\n  toastr.success(\r\n    __st_t_tag`Memory \"${addResult.entryTitle}\" created successfully${contextMsg}!`,\r\n    \"STMemoryBooks\",\r\n  );\r\n  \r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Manual JSON repair failed:\", error);\r\n    toastr.error(\r\n      __st_t_tag`Failed to create memory from corrected JSON: ${error.message}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  } finally {\r\n    // ALWAYS reset the flag, no matter how we exit.\r\n    // This clears the `isProcessingMemory` flag set inside the try block above.\r\n    isProcessingMemory = false;\r\n  }\r\n}\r\n\r\nasync function applyManualFixedArcJson(correctedRaw) {\r\n  if (isProcessingArc) {\r\n    toastr.warning(\r\n      translate(\r\n        \"Arc consolidation is already in progress.\",\r\n        \"STMemoryBooks_ArcManualFix_InProgress\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n\r\n  try {\r\n    isProcessingArc = true;\r\n    const context = lastFailedArcContext;\r\n    if (\r\n      !context?.lorebookName ||\r\n      !context?.lorebookData ||\r\n      !Array.isArray(context?.selectedEntries) ||\r\n      !context?.options\r\n    ) {\r\n      toastr.error(\r\n        translate(\r\n          \"Missing failure context; cannot apply corrected Arc JSON.\",\r\n          \"STMemoryBooks_ArcManualFix_NoContext\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    const trimmedRaw = String(correctedRaw || \"\").trim();\r\n    if (!trimmedRaw) {\r\n      toastr.error(\r\n        translate(\r\n          \"Corrected JSON is empty.\",\r\n          \"STMemoryBooks_ArcManualFix_EmptyJson\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    let parsed;\r\n    try {\r\n      parsed = parseArcJsonResponse(trimmedRaw);\r\n    } catch (error) {\r\n      const msg = error?.message || \"Failed to parse corrected Arc JSON.\";\r\n      const code = error?.code ? ` [${error.code}]` : \"\";\r\n      toastr.error(\r\n        __st_t_tag`Corrected Arc JSON is still invalid${code}: ${msg}`,\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    const arcs = Array.isArray(parsed?.arcs) ? parsed.arcs : [];\r\n    if (arcs.length === 0) {\r\n      toastr.error(\r\n        translate(\r\n          \"Corrected JSON is missing arcs.\",\r\n          \"STMemoryBooks_ArcManualFix_MissingArcs\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    const hasAnyMemberIds = arcs.some(\r\n      (a) => Array.isArray(a?.member_ids) && a.member_ids.length > 0,\r\n    );\r\n    if (arcs.length > 1 && !hasAnyMemberIds) {\r\n      toastr.error(\r\n        translate(\r\n          \"Multiple arcs require member_ids to avoid ambiguous assignment. Add member_ids or reduce to one arc.\",\r\n          \"STMemoryBooks_ArcManualFix_MultiArcNeedsMemberIds\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    const selectedEntries = context.selectedEntries;\r\n    const selectedUids = selectedEntries\r\n      .map((e) => String(e?.uid))\r\n      .filter(Boolean);\r\n\r\n    const idResolver = new Map();\r\n    selectedUids.forEach((uid, idx) => {\r\n      idResolver.set(uid, uid);\r\n      const seq = String(idx + 1).padStart(3, \"0\");\r\n      idResolver.set(seq, uid);\r\n      idResolver.set(String(idx + 1), uid);\r\n    });\r\n    const resolveId = (raw) => idResolver.get(String(raw).trim());\r\n\r\n    const unassignedIds = new Set();\r\n    const unassigned = Array.isArray(parsed?.unassigned_memories)\r\n      ? parsed.unassigned_memories\r\n      : [];\r\n    unassigned.forEach((u) => {\r\n      const rid = resolveId(u?.id);\r\n      if (rid) unassignedIds.add(rid);\r\n    });\r\n    const assignedIds = selectedUids.filter((id) => !unassignedIds.has(id));\r\n\r\n    const arcCandidates = arcs.map((a) => {\r\n      const title = String(a?.title || \"\").trim();\r\n      const summary = String(a?.summary || \"\").trim();\r\n      let keywords = Array.isArray(a?.keywords) ? a.keywords : [];\r\n      keywords = keywords\r\n        .filter((k) => typeof k === \"string\" && k.trim())\r\n        .map((k) => k.trim());\r\n\r\n      let memberIds = null;\r\n      if (Array.isArray(a?.member_ids)) {\r\n        memberIds = a.member_ids\r\n          .map(resolveId)\r\n          .filter((id) => id !== undefined);\r\n      }\r\n      if (!memberIds || memberIds.length === 0) {\r\n        memberIds = assignedIds;\r\n      }\r\n      memberIds = Array.from(new Set(memberIds)).filter(Boolean);\r\n\r\n      return { title, summary, keywords, memberIds };\r\n    });\r\n\r\n    const arcOrderFallback = initializeSettings();\n    const fallbackMode = String(\n      arcOrderFallback?.moduleSettings?.arcOrderMode || \"auto\",\n    ).toLowerCase();\n    const fallbackOrderMode =\n      fallbackMode === \"manual\" || fallbackMode === \"reverse\"\n        ? fallbackMode\n        : \"auto\";\n    const fallbackOrderValue = clampInt(\n      Number.isFinite(Number(arcOrderFallback?.moduleSettings?.arcOrderValue))\n        ? Math.trunc(Number(arcOrderFallback.moduleSettings.arcOrderValue))\n        : 100,\n      0,\n      9999,\n    );\n    const fallbackReverseStart = clampInt(\n      Number.isFinite(Number(arcOrderFallback?.moduleSettings?.arcReverseStart))\n        ? Math.trunc(Number(arcOrderFallback.moduleSettings.arcReverseStart))\n        : 9999,\n      100,\n      9999,\n    );\n\n    const res = await commitArcs({\n      lorebookName: context.lorebookName,\n      lorebookData: context.lorebookData,\n      arcCandidates,\n      disableOriginals: !!context.disableOriginals,\n      orderMode: context.arcOrderMode || fallbackOrderMode,\n      orderValue:\n        context.arcOrderValue !== undefined && context.arcOrderValue !== null\n          ? clampInt(Number(context.arcOrderValue), 0, 9999)\n          : fallbackOrderValue,\n      reverseStart:\n        context.arcReverseStart !== undefined && context.arcReverseStart !== null\n          ? clampInt(Number(context.arcReverseStart), 100, 9999)\n          : fallbackReverseStart,\n    });\n\r\n    const created = Array.isArray(res?.results)\r\n      ? res.results.length\r\n      : arcCandidates.length;\r\n    toastr.success(\r\n      __st_t_tag`Created ${created} arc${created === 1 ? \"\" : \"s\"} from corrected JSON.`,\r\n      \"STMemoryBooks\",\r\n    );\r\n\r\n    lastFailedArcError = null;\r\n    lastFailedArcContext = null;\r\n    try {\r\n      toastr.clear(lastArcFailureToast);\r\n    } catch (e) {}\r\n    lastArcFailureToast = null;\r\n  } catch (e) {\r\n    console.error(\"STMemoryBooks: applyManualFixedArcJson failed:\", e);\r\n    toastr.error(\r\n      __st_t_tag`Failed to apply corrected Arc JSON: ${e.message}`,\r\n      \"STMemoryBooks\",\r\n    );\r\n  } finally {\r\n    isProcessingArc = false;\r\n  }\r\n}\r\n\r\nfunction showFailedArcResponsePopup(error) {\r\n  try {\r\n    const esc = (s) => escapeHtml(String(s ?? \"\"));\r\n    const message = esc(\r\n      error?.message ||\r\n        translate(\"Unknown error\", \"STMemoryBooks_UnknownError\"),\r\n    );\r\n    const code = esc(error?.code || \"\");\r\n    const rawPrimary = String(error?.retryRawText || error?.rawText || \"\").trim();\r\n    const rawOriginal = String(error?.rawText || \"\").trim();\r\n    const canManualFix =\r\n      !!lastFailedArcContext?.lorebookName && !!lastFailedArcContext?.lorebookData;\r\n\r\n    const splitKeywords = (s) =>\r\n      String(s || \"\")\r\n        .split(/[\\n,]+/g)\r\n        .map((x) => String(x || \"\").trim())\r\n        .map((x) => x.replace(/^[\"']|[\"']$/g, \"\"))\r\n        .map((x) => x.replace(/^\\d+\\.\\s*/, \"\"))\r\n        .map((x) => x.replace(/^[\\-\\*\\u2022]\\s*/, \"\"))\r\n        .map((x) => x.trim())\r\n        .filter(Boolean)\r\n        .slice(0, 30);\r\n\r\n    const extractArcFieldsFromText = (raw) => {\r\n      const text = String(raw || \"\");\r\n\r\n      // Best case: it's actually (repairable) arc JSON already.\r\n      try {\r\n        const parsed = parseArcJsonResponse(text);\r\n        const a0 = Array.isArray(parsed?.arcs) ? parsed.arcs[0] : null;\r\n        if (a0) {\r\n          return {\r\n            title: String(a0.title || \"\").trim(),\r\n            summary: String(a0.summary || \"\").trim(),\r\n            keywords: Array.isArray(a0.keywords) ? a0.keywords : [],\r\n          };\r\n        }\r\n      } catch {}\r\n\r\n      // Heuristics for messy responses\r\n      let title = \"\";\r\n      let summary = \"\";\r\n      let keywords = [];\r\n\r\n      const titleLine =\r\n        text.match(/(?:^|\\n)\\s*(?:title|arc\\s*title)\\s*[:\\-]\\s*(.+)\\s*$/im) ||\r\n        text.match(/(?:^|\\n)\\s*#{1,6}\\s*(.+)\\s*$/m);\r\n      if (titleLine) {\r\n        title = String(titleLine[1] || \"\")\r\n          .trim()\r\n          .replace(/^[\"']|[\"']$/g, \"\");\r\n      }\r\n\r\n      const summaryMatch = text.match(\r\n        /(?:^|\\n)\\s*(?:summary|arc\\s*summary|content)\\s*[:\\-]\\s*([\\s\\S]*?)(?=\\n\\s*(?:keywords?|tags?)\\s*[:\\-]|\\n\\s*$)/im,\r\n      );\r\n      if (summaryMatch) {\r\n        summary = String(summaryMatch[1] || \"\").trim();\r\n      } else if (title) {\r\n        // Fallback: first non-empty paragraph after the title line\r\n        const afterTitle = text.split(title).slice(1).join(title);\r\n        const paras = afterTitle\r\n          .split(/\\n\\s*\\n/g)\r\n          .map((p) => p.trim())\r\n          .filter(Boolean);\r\n        if (paras.length) summary = paras[0];\r\n      }\r\n\r\n      const keywordSection = text.match(\r\n        /(?:^|\\n)\\s*(?:keywords?|tags?)\\s*[:\\-]\\s*([\\s\\S]*)$/im,\r\n      );\r\n      if (keywordSection) {\r\n        keywords = splitKeywords(keywordSection[1]);\r\n      } else {\r\n        // Fallback: collect bullet-ish lines if any\r\n        const bulletish = text\r\n          .split(/\\r?\\n/)\r\n          .filter((l) => /^\\s*(?:[\\-\\*\\u2022]|\\d+\\.)\\s+/.test(l))\r\n          .slice(0, 60)\r\n          .join(\"\\n\");\r\n        if (bulletish) keywords = splitKeywords(bulletish);\r\n      }\r\n\r\n      return { title, summary, keywords };\r\n    };\r\n\r\n    const prefill = rawPrimary ? extractArcFieldsFromText(rawPrimary) : null;\r\n\r\n    let content = \"\";\r\n    content += `<h3>${esc(translate(\"Review Failed Arc Response\", \"STMemoryBooks_ReviewFailedArc_Title\"))}</h3>`;\r\n    content += `<div><strong>${esc(translate(\"Error\", \"STMemoryBooks_ReviewFailedArc_ErrorLabel\"))}:</strong> ${message}</div>`;\r\n    if (code) {\r\n      content += `<div><strong>${esc(translate(\"Code\", \"STMemoryBooks_ReviewFailedArc_CodeLabel\"))}:</strong> ${code}</div>`;\r\n    }\r\n\r\n    if (rawPrimary) {\r\n      content += `<div class=\"world_entry_form_control\">`;\r\n      content += `<h4>${esc(translate(\"Raw AI Response\", \"STMemoryBooks_ReviewFailedArc_RawLabel\"))}</h4>`;\r\n      content += `<textarea id=\"stmb-arc-corrected-raw\" class=\"text_pole\" style=\"width: 100%; min-height: 220px; max-height: 360px; white-space: pre; overflow:auto;\">${escapeHtml(rawPrimary)}</textarea>`;\r\n      content += `<div class=\"buttons_block gap10px\">`;\r\n      content += `<button id=\"stmb-arc-copy-raw\" class=\"menu_button\">${esc(translate(\"Copy Raw\", \"STMemoryBooks_ReviewFailedArc_CopyRaw\"))}</button>`;\r\n      content += `<button id=\"stmb-arc-extract-fields\" class=\"menu_button\">${esc(translate(\"Extract Title/Summary/Keywords\", \"STMemoryBooks_ReviewFailedArc_ExtractFields\"))}</button>`;\r\n      content += `<button id=\"stmb-arc-fill-json\" class=\"menu_button\">${esc(translate(\"Fill JSON from fields\", \"STMemoryBooks_ReviewFailedArc_FillJson\"))}</button>`;\r\n      content += `<button id=\"stmb-arc-apply-corrected-raw\" class=\"menu_button\" ${canManualFix ? \"\" : \"disabled\"}>${esc(translate(\"Create Arcs from corrected JSON\", \"STMemoryBooks_ReviewFailedArc_CreateArcs\"))}</button>`;\r\n      content += `</div>`;\r\n\r\n      content += `<div class=\"world_entry_form_control\">`;\r\n      content += `<h4>${esc(translate(\"Extractable Fields\", \"STMemoryBooks_ReviewFailedArc_FieldsTitle\"))}</h4>`;\r\n      content += `<div class=\"opacity70p\">${esc(translate(\"Use Extract to populate fields from the raw response, then Fill JSON to generate a valid Arc JSON object.\", \"STMemoryBooks_ReviewFailedArc_FieldsDesc\"))}</div>`;\r\n      content += `<div class=\"world_entry_form_control\"><label>${esc(translate(\"Title\", \"STMemoryBooks_Title\"))}</label><input id=\"stmb-arc-field-title\" class=\"text_pole\" style=\"width:100%\" value=\"${escapeHtml(String(prefill?.title || \"\"))}\"></div>`;\r\n      content += `<div class=\"world_entry_form_control\"><label>${esc(translate(\"Summary\", \"STMemoryBooks_Summary\"))}</label><textarea id=\"stmb-arc-field-summary\" class=\"text_pole\" style=\"width:100%; min-height: 110px; white-space: pre-wrap;\">${escapeHtml(String(prefill?.summary || \"\"))}</textarea></div>`;\r\n      content += `<div class=\"world_entry_form_control\"><label>${esc(translate(\"Keywords (one per line or comma-separated)\", \"STMemoryBooks_Keywords\"))}</label><textarea id=\"stmb-arc-field-keywords\" class=\"text_pole\" style=\"width:100%; min-height: 90px; white-space: pre-wrap;\">${escapeHtml(Array.isArray(prefill?.keywords) ? prefill.keywords.join(\"\\n\") : \"\")}</textarea></div>`;\r\n      content += `</div>`;\r\n\r\n      if (!canManualFix) {\r\n        content += `<div class=\"opacity70p\">${esc(translate(\"Unable to apply corrected JSON because the original consolidation context is missing.\", \"STMemoryBooks_ReviewFailedArc_NoContext\"))}</div>`;\r\n      }\r\n      if (rawOriginal && rawOriginal !== rawPrimary) {\r\n        content += `<details class=\"world_entry_form_control\"><summary class=\"opacity70p\">${esc(translate(\"Show original (pre-retry) response\", \"STMemoryBooks_ReviewFailedArc_ShowOriginal\"))}</summary>`;\r\n        content += `<textarea class=\"text_pole\" style=\"width: 100%; min-height: 160px; max-height: 260px; white-space: pre; overflow:auto;\">${escapeHtml(rawOriginal)}</textarea>`;\r\n        content += `</details>`;\r\n      }\r\n      content += `</div>`;\r\n    } else {\r\n      content += `<div class=\"world_entry_form_control opacity70p\">${esc(translate(\"No raw response was captured.\", \"STMemoryBooks_ReviewFailedArc_NoRaw\"))}</div>`;\r\n    }\r\n\r\n    const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, \"\", {\r\n      wide: true,\r\n      large: true,\r\n      allowVerticalScrolling: true,\r\n      okButton: false,\r\n      cancelButton: translate(\"Close\", \"STMemoryBooks_Close\"),\r\n    });\r\n\r\n    const dlg = popup.dlg;\r\n    dlg\r\n      .querySelector(\"#stmb-arc-copy-raw\")\r\n      ?.addEventListener(\"click\", async () => {\r\n        try {\r\n          await navigator.clipboard.writeText(rawPrimary || rawOriginal);\r\n          toastr.success(\r\n            translate(\"Copied raw response\", \"STMemoryBooks_CopiedRaw\"),\r\n            \"STMemoryBooks\",\r\n          );\r\n        } catch (e) {\r\n          toastr.error(\r\n            translate(\"Copy failed\", \"STMemoryBooks_CopyFailed\"),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      });\r\n    dlg\r\n      .querySelector(\"#stmb-arc-extract-fields\")\r\n      ?.addEventListener(\"click\", async () => {\r\n        try {\r\n          const rawNow =\r\n            dlg.querySelector(\"#stmb-arc-corrected-raw\")?.value ??\r\n            rawPrimary ??\r\n            rawOriginal;\r\n          const extracted = extractArcFieldsFromText(rawNow);\r\n          const titleEl = dlg.querySelector(\"#stmb-arc-field-title\");\r\n          const summaryEl = dlg.querySelector(\"#stmb-arc-field-summary\");\r\n          const kwEl = dlg.querySelector(\"#stmb-arc-field-keywords\");\r\n          if (titleEl) titleEl.value = extracted?.title || \"\";\r\n          if (summaryEl) summaryEl.value = extracted?.summary || \"\";\r\n          if (kwEl)\r\n            kwEl.value = Array.isArray(extracted?.keywords)\r\n              ? extracted.keywords.join(\"\\n\")\r\n              : \"\";\r\n          toastr.success(\r\n            translate(\r\n              \"Extracted fields from response\",\r\n              \"STMemoryBooks_ReviewFailedArc_ExtractedFieldsToast\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        } catch (e) {\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to extract fields\",\r\n              \"STMemoryBooks_ReviewFailedArc_ExtractFieldsFailed\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      });\r\n    dlg\r\n      .querySelector(\"#stmb-arc-fill-json\")\r\n      ?.addEventListener(\"click\", async () => {\r\n        try {\r\n          const title = String(\r\n            dlg.querySelector(\"#stmb-arc-field-title\")?.value || \"\",\r\n          ).trim();\r\n          const summary = String(\r\n            dlg.querySelector(\"#stmb-arc-field-summary\")?.value || \"\",\r\n          ).trim();\r\n          const kwRaw = dlg.querySelector(\"#stmb-arc-field-keywords\")?.value || \"\";\r\n          const keywords = splitKeywords(kwRaw);\r\n\r\n          if (!title || !summary) {\r\n            toastr.warning(\r\n              translate(\r\n                \"Title and Summary are required to build an arc.\",\r\n                \"STMemoryBooks_ReviewFailedArc_TitleSummaryRequired\",\r\n              ),\r\n              \"STMemoryBooks\",\r\n            );\r\n            return;\r\n          }\r\n\r\n          const obj = {\r\n            arcs: [{ title, summary, keywords }],\r\n            unassigned_memories: [],\r\n          };\r\n          const json = JSON.stringify(obj, null, 2);\r\n          const rawEl = dlg.querySelector(\"#stmb-arc-corrected-raw\");\r\n          if (rawEl) rawEl.value = json;\r\n          toastr.success(\r\n            translate(\r\n              \"Filled JSON from fields\",\r\n              \"STMemoryBooks_ReviewFailedArc_FilledJsonToast\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        } catch (e) {\r\n          toastr.error(\r\n            translate(\r\n              \"Failed to build JSON\",\r\n              \"STMemoryBooks_ReviewFailedArc_FillJsonFailed\",\r\n            ),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      });\r\n    dlg\r\n      .querySelector(\"#stmb-arc-apply-corrected-raw\")\r\n      ?.addEventListener(\"click\", async () => {\r\n        const corrected =\r\n          dlg.querySelector(\"#stmb-arc-corrected-raw\")?.value ??\r\n          rawPrimary ??\r\n          rawOriginal;\r\n        void applyManualFixedArcJson(corrected);\r\n      });\r\n\r\n    void popup.show();\r\n  } catch (e) {\r\n    console.error(\"STMemoryBooks: Failed to show failed Arc response popup:\", e);\r\n  }\r\n}\r\n\r\n/**\r\n * Show a popup with details for a failed AI response, including raw response and provider body if available.\r\n */\r\nfunction showFailedAIResponsePopup(error) {\r\n  try {\r\n    const esc = (s) => escapeHtml(String(s || \"\"));\r\n    const code = error?.code ? esc(error.code) : \"\";\r\n    const message = esc(error?.message || \"Unknown error\");\r\n    const raw = typeof error?.rawResponse === \"string\" ? error.rawResponse : \"\";\r\n    const providerBody =\r\n      typeof error?.providerBody === \"string\" ? error.providerBody : \"\";\r\n    const canManualFix =\r\n      !!raw &&\r\n      !!lastFailedAIContext?.compiledScene &&\r\n      !!lastFailedAIContext?.lorebookValidation?.valid;\r\n    let content = \"\";\r\n    content += `<h3>${esc(translate(\"Review Failed AI Response\", \"STMemoryBooks_ReviewFailedAI_Title\"))}</h3>`;\r\n    content += `<div class=\"world_entry_form_control\">`;\r\n    content += `<div><strong>${esc(translate(\"Error\", \"STMemoryBooks_ReviewFailedAI_ErrorLabel\"))}:</strong> ${message}</div>`;\r\n    if (code)\r\n      content += `<div><strong>${esc(translate(\"Code\", \"STMemoryBooks_ReviewFailedAI_CodeLabel\"))}:</strong> ${code}</div>`;\r\n    content += `</div>`;\r\n\r\n    if (raw) {\r\n      content += `<div class=\"world_entry_form_control\">`;\r\n      content += `<h4>${esc(translate(\"Raw AI Response\", \"STMemoryBooks_ReviewFailedAI_RawLabel\"))}</h4>`;\r\n      content += `<textarea id=\"stmb-corrected-raw\" class=\"text_pole\" style=\"width: 100%; min-height: 220px; max-height: 360px; white-space: pre; overflow:auto;\">${escapeHtml(raw)}</textarea>`;\r\n      content += `<div class=\"buttons_block gap10px\">`;\r\n      content += `<button id=\"stmb-copy-raw\" class=\"menu_button\">${esc(translate(\"Copy Raw\", \"STMemoryBooks_ReviewFailedAI_CopyRaw\"))}</button>`;\r\n      content += `<button id=\"stmb-apply-corrected-raw\" class=\"menu_button\" ${canManualFix ? \"\" : \"disabled\"}>${esc(translate(\"Create Memory from corrected JSON\", \"STMemoryBooks_ReviewFailedAI_CreateMemory\"))}</button>`;\r\n      content += `</div>`;\r\n      if (!canManualFix) {\r\n        content += `<div class=\"opacity70p\">${esc(translate(\"Unable to apply corrected JSON because the original generation context is missing.\", \"STMemoryBooks_ReviewFailedAI_NoContext\"))}</div>`;\r\n      }\r\n      content += `</div>`;\r\n    } else {\r\n      content += `<div class=\"world_entry_form_control opacity70p\">${esc(translate(\"No raw response was captured.\", \"STMemoryBooks_ReviewFailedAI_NoRaw\"))}</div>`;\r\n    }\r\n\r\n    if (providerBody) {\r\n      content += `<div class=\"world_entry_form_control\">`;\r\n      content += `<h4>${esc(translate(\"Provider Error Body\", \"STMemoryBooks_ReviewFailedAI_ProviderBody\"))}</h4>`;\r\n      content += `<pre class=\"text_pole\" style=\"white-space: pre-wrap; max-height: 200px; overflow:auto;\"><code>${escapeHtml(providerBody)}</code></pre>`;\r\n      content += `<div class=\"buttons_block gap10px\"><button id=\"stmb-copy-provider\" class=\"menu_button\">${esc(translate(\"Copy Provider Body\", \"STMemoryBooks_ReviewFailedAI_CopyProvider\"))}</button></div>`;\r\n      content += `</div>`;\r\n    }\r\n\r\n    const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, \"\", {\r\n      wide: true,\r\n      large: true,\r\n      allowVerticalScrolling: true,\r\n      okButton: false,\r\n      cancelButton: translate(\"Close\", \"STMemoryBooks_Close\"),\r\n    });\r\n\r\n    // Attach handlers before showing the popup so they are active immediately\r\n    const dlg = popup.dlg;\r\n    dlg.querySelector(\"#stmb-copy-raw\")?.addEventListener(\"click\", async () => {\r\n      try {\r\n        await navigator.clipboard.writeText(raw);\r\n        toastr.success(\r\n          translate(\"Copied raw response\", \"STMemoryBooks_CopiedRaw\"),\r\n          \"STMemoryBooks\",\r\n        );\r\n      } catch (e) {\r\n        toastr.error(\r\n          translate(\"Copy failed\", \"STMemoryBooks_CopyFailed\"),\r\n          \"STMemoryBooks\",\r\n        );\r\n      }\r\n    });\r\n    dlg\r\n      .querySelector(\"#stmb-apply-corrected-raw\")\r\n      ?.addEventListener(\"click\", async () => {\r\n        const correctedRaw =\r\n          dlg.querySelector(\"#stmb-corrected-raw\")?.value ?? raw;\r\n        void applyManualFixedJson(correctedRaw);\r\n      });\r\n    dlg\r\n      .querySelector(\"#stmb-copy-provider\")\r\n      ?.addEventListener(\"click\", async () => {\r\n        try {\r\n          await navigator.clipboard.writeText(providerBody);\r\n          toastr.success(\r\n            translate(\"Copied provider body\", \"STMemoryBooks_CopiedProvider\"),\r\n            \"STMemoryBooks\",\r\n          );\r\n        } catch (e) {\r\n          toastr.error(\r\n            translate(\"Copy failed\", \"STMemoryBooks_CopyFailed\"),\r\n            \"STMemoryBooks\",\r\n          );\r\n        }\r\n      });\r\n\r\n    // Now show the popup\r\n    void popup.show();\r\n  } catch (e) {\r\n    console.error(\"STMemoryBooks: Failed to show failed AI response popup:\", e);\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize the extension with BULLETPROOF settings management\r\n */\r\nasync function init() {\r\n  if (hasBeenInitialized) return;\r\n  hasBeenInitialized = true;\r\n  console.log(\"STMemoryBooks: Initializing\");\r\n  // Merge this extension's locale data into SillyTavern's current locale:\r\n  // - Do not reinitialize ST i18n (host owns init)\r\n  // - Load JSON for current locale if available, then ensure English fallback exists\r\n  try {\r\n    const current = getCurrentLocale?.() || \"en\";\r\n\r\n    // Try to fetch JSON bundle for current locale (works without JSON import assertions)\r\n    try {\r\n      const jsonData = await loadLocaleJson(current);\r\n      if (jsonData) {\r\n        addLocaleData(current, jsonData);\r\n      }\r\n    } catch (e) {\r\n      console.warn(\"STMemoryBooks: Failed to load JSON locale bundle:\", e);\r\n    }\r\n\r\n    // Merge statically-bundled locales (English fallback, and any inline bundles)\r\n    if (localeData && typeof localeData === \"object\") {\r\n      if (localeData[current]) {\r\n        addLocaleData(current, localeData[current]);\r\n      }\r\n      if (current !== \"en\" && localeData[\"en\"]) {\r\n        addLocaleData(\r\n          current,\r\n          Object.fromEntries(\r\n            Object.entries(localeData[\"en\"]).filter(([k]) => true),\r\n          ),\r\n        );\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn(\"STMemoryBooks: Failed to merge plugin locales:\", e);\r\n  }\r\n  // Wait for SillyTavern to be ready\r\n  let attempts = 0;\r\n  const maxAttempts = 20;\r\n\r\n  while (attempts < maxAttempts) {\r\n    if (\r\n      $(SELECTORS.extensionsMenu).length > 0 &&\r\n      eventSource &&\r\n      typeof Popup !== \"undefined\"\r\n    ) {\r\n      break;\r\n    }\r\n    await new Promise((resolve) => setTimeout(resolve, 500));\r\n    attempts++;\r\n  }\r\n\r\n  // Create UI now that extensions menu is available\r\n  createUI();\r\n\r\n  // Apply locale to any initial DOM injected by this module\r\n  try {\r\n    applyLocale();\r\n  } catch (e) {\r\n    /* no-op */\r\n  }\r\n\r\n  // Initialize settings with validation\r\n  const settings = initializeSettings();\r\n  const profileValidation = validateAndFixProfiles(settings);\r\n\r\n  if (!profileValidation.valid) {\r\n    console.warn(\r\n      \"STMemoryBooks: Profile validation issues found:\",\r\n      profileValidation.issues,\r\n    );\r\n    if (profileValidation.fixes.length > 0) {\r\n      saveSettingsDebounced();\r\n    }\r\n  }\r\n\r\n  // Initialize scene state\r\n  updateSceneStateCache();\r\n  validateAndCleanupSceneMarkers();\r\n\r\n  // Initialize chat observer\r\n  try {\r\n    initializeChatObserver();\r\n  } catch (error) {\r\n    console.error(\"STMemoryBooks: Failed to initialize chat observer:\", error);\r\n    toastr.error(\r\n      translate(\r\n        \"STMemoryBooks: Failed to initialize chat monitoring. Please refresh the page.\",\r\n        \"STMemoryBooks_FailedToInitializeChatMonitoring\",\r\n      ),\r\n      \"STMemoryBooks\",\r\n    );\r\n    return;\r\n  }\r\n\r\n  // Setup event listeners\r\n  setupEventListeners();\r\n\r\n  // Preload side prompt names cache for autocomplete\r\n  await refreshSidePromptCache();\r\n\r\n  // Register slash commands\r\n  registerSlashCommands();\r\n\r\n  // Process any messages that are already on the screen at initialization time\r\n  // This handles cases where a chat is already loaded when the extension initializes\r\n  try {\r\n    processExistingMessages();\r\n    console.log(\r\n      \"STMemoryBooks: Processed existing messages during initialization\",\r\n    );\r\n  } catch (error) {\r\n    console.error(\r\n      \"STMemoryBooks: Error processing existing messages during init:\",\r\n      error,\r\n    );\r\n  }\r\n\r\n  // Add CSS classes helper for Handlebars\r\n  Handlebars.registerHelper(\"eq\", function (a, b) {\r\n    return a === b;\r\n  });\r\n\r\n  console.log(\"STMemoryBooks: Extension loaded successfully\");\r\n}\r\n\r\n/**\r\n * Regex selection helpers and popup\r\n */\r\nfunction buildFlatRegexOptions() {\r\n  const list = [];\r\n  try {\r\n    const scripts = getRegexScripts({ allowedOnly: false }) || [];\r\n    scripts.forEach((script, index) => {\r\n      const key = `idx:${index}`;\r\n      const label = `${script?.scriptName || \"Untitled\"}${script?.disabled ? \" (disabled)\" : \"\"}`;\r\n      list.push({ key, label });\r\n    });\r\n  } catch (e) {\r\n    console.warn(\"STMemoryBooks: buildFlatRegexOptions failed\", e);\r\n  }\r\n  return list;\r\n}\r\n\r\nasync function showRegexSelectionPopup() {\r\n  const settings = initializeSettings();\r\n  const allOptions = buildFlatRegexOptions();\r\n  const selOut = Array.isArray(settings.moduleSettings.selectedRegexOutgoing)\r\n    ? settings.moduleSettings.selectedRegexOutgoing\r\n    : [];\r\n  const selIn = Array.isArray(settings.moduleSettings.selectedRegexIncoming)\r\n    ? settings.moduleSettings.selectedRegexIncoming\r\n    : [];\r\n\r\n  let content = \"\";\r\n  content +=\r\n    '<h3 data-i18n=\"STMemoryBooks_RegexSelection_Title\"> Regex selection</h3>';\r\n  content +=\r\n    '<div class=\"world_entry_form_control\"><small class=\"opacity70p\" data-i18n=\"STMemoryBooks_RegexSelection_Desc\">Selecting a regex here will run it REGARDLESS of whether it is enabled or disabled.</small></div>';\r\n\r\n  // Outgoing\r\n  content += '<div class=\"world_entry_form_control\">';\r\n  content +=\r\n    '<h4 data-i18n=\"STMemoryBooks_RegexSelection_Outgoing\">Run regex before sending to AI</h4>';\r\n  content += '<select id=\"stmb-regex-outgoing\" multiple style=\"width:100%\">';\r\n  for (const o of allOptions) {\r\n    const sel = selOut.includes(o.key) ? \" selected\" : \"\";\r\n    content += `<option value=\"${escapeHtml(o.key)}\"${sel}>${escapeHtml(o.label)}</option>`;\r\n  }\r\n  content += \"</select>\";\r\n  content += \"</div>\";\r\n\r\n  // Incoming\r\n  content += '<div class=\"world_entry_form_control\">';\r\n  content +=\r\n    '<h4 data-i18n=\"STMemoryBooks_RegexSelection_Incoming\">Run regex before adding to lorebook (before previews)</h4>';\r\n  content += '<select id=\"stmb-regex-incoming\" multiple style=\"width:100%\">';\r\n  for (const o of allOptions) {\r\n    const sel = selIn.includes(o.key) ? \" selected\" : \"\";\r\n    content += `<option value=\"${escapeHtml(o.key)}\"${sel}>${escapeHtml(o.label)}</option>`;\r\n  }\r\n  content += \"</select>\";\r\n  content += \"</div>\";\r\n\r\n  const popup = new Popup(content, POPUP_TYPE.TEXT, \"\", {\r\n    wide: true,\r\n    large: true,\r\n    allowVerticalScrolling: true,\r\n    okButton: translate(\"Save\", \"STMemoryBooks_Save\"),\r\n    cancelButton: translate(\"Close\", \"STMemoryBooks_Close\"),\r\n  });\r\n  // Apply i18n to the newly created popup content\r\n  try {\r\n    applyLocale(popup.dlg);\r\n  } catch (e) {\r\n    /* noop */\r\n  }\r\n\r\n  setTimeout(() => {\r\n    try {\r\n      if (window.jQuery && typeof window.jQuery.fn.select2 === \"function\") {\r\n        const $parent = window.jQuery(popup.dlg);\r\n        window.jQuery(\"#stmb-regex-outgoing\").select2({\r\n          width: \"100%\",\r\n          placeholder: translate(\r\n            \"Select outgoing regex\",\r\n            \"STMemoryBooks_RegexSelect_PlaceholderOutgoing\",\r\n          ),\r\n          closeOnSelect: false,\r\n          dropdownParent: $parent,\r\n        });\r\n        window.jQuery(\"#stmb-regex-incoming\").select2({\r\n          width: \"100%\",\r\n          placeholder: translate(\r\n            \"Select incoming regex\",\r\n            \"STMemoryBooks_RegexSelect_PlaceholderIncoming\",\r\n          ),\r\n          closeOnSelect: false,\r\n          dropdownParent: $parent,\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.warn(\r\n        \"STMemoryBooks: Select2 initialization failed (using native selects)\",\r\n        e,\r\n      );\r\n    }\r\n  }, 0);\r\n\r\n  const res = await popup.show();\r\n\r\n  if (res === POPUP_RESULT.AFFIRMATIVE) {\r\n    try {\r\n      const outVals = Array.from(\r\n        popup.dlg?.querySelector(\"#stmb-regex-outgoing\")?.selectedOptions || [],\r\n      ).map((o) => o.value);\r\n      const inVals = Array.from(\r\n        popup.dlg?.querySelector(\"#stmb-regex-incoming\")?.selectedOptions || [],\r\n      ).map((o) => o.value);\r\n      settings.moduleSettings.selectedRegexOutgoing = outVals;\r\n      settings.moduleSettings.selectedRegexIncoming = inVals;\r\n      saveSettingsDebounced();\r\n      toastr.success(\r\n        translate(\r\n          \"Regex selections saved\",\r\n          \"STMemoryBooks_RegexSelectionsSaved\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n    } catch (e) {\r\n      console.warn(\"STMemoryBooks: Failed to save regex selections\", e);\r\n      toastr.error(\r\n        translate(\r\n          \"Failed to save regex selections\",\r\n          \"STMemoryBooks_FailedToSaveRegexSelections\",\r\n        ),\r\n        \"STMemoryBooks\",\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n// Initialize when ready\r\n$(document).ready(() => {\r\n  if (eventSource && event_types.APP_READY) {\r\n    eventSource.on(event_types.APP_READY, init);\r\n  }\r\n  // Fallback initialization\r\n  setTimeout(init, 2000);\r\n});\r\n",
    "import { getEffectivePrompt, getCurrentApiInfo, normalizeCompletionSource, estimateTokens } from './utils.js';\r\nimport { characters, this_chid, substituteParams, getRequestHeaders } from '../../../../script.js';\r\nimport { oai_settings } from '../../../openai.js';\r\nimport { runRegexScript, getRegexScripts } from '../../../extensions/regex/engine.js';\r\nimport { groups } from '../../../group-chats.js';\r\nimport { extension_settings } from '../../../extensions.js';\r\nimport dirtyJson from 'dirty-json';\r\nconst $ = window.jQuery;\r\n\r\nconst MODULE_NAME = 'STMemoryBooks-Memory';\r\n\r\n// --- ST Regex selection-based execution (bypass engine gating) ---\r\n\r\n/**\r\n * Clone a script and force disabled=false so explicitly selected scripts always run.\r\n */\r\nfunction cloneScriptEnabled(script) {\r\n    try {\r\n        const clone = { ...script };\r\n        clone.disabled = false;\r\n        return clone;\r\n    } catch {\r\n        return script;\r\n    }\r\n}\r\n\r\n/**\r\n * Apply selected regex scripts (by flat index keys, e.g., \"idx:0\") in order.\r\n * Uses getRegexScripts({ allowedOnly: false }) as the single source of truth.\r\n * Bypasses engine gating; relies on explicit user selection.\r\n */\r\nfunction applySelectedRegex(inputText, selectedKeys) {\r\n    if (typeof inputText !== 'string') return '';\r\n    if (!Array.isArray(selectedKeys) || selectedKeys.length === 0) return inputText;\r\n\r\n    try {\r\n        const all = getRegexScripts({ allowedOnly: false }) || [];\r\n        const order = selectedKeys\r\n            .map(k => Number(String(k).replace(/^idx:/, '')))\r\n            .filter(i => Number.isInteger(i) && i >= 0 && i < all.length);\r\n\r\n        let out = inputText;\r\n        for (const i of order) {\r\n            const script = cloneScriptEnabled(all[i]);\r\n            try {\r\n                out = runRegexScript(script, out);\r\n            } catch (e) {\r\n                console.warn('applySelectedRegex: script failed', i, e);\r\n            }\r\n        }\r\n        return out;\r\n    } catch (e) {\r\n        console.warn('applySelectedRegex failed', e);\r\n        return inputText;\r\n    }\r\n}\r\n\r\n\r\n// --- Custom Error Types for Better UI Handling ---\r\nclass TokenWarningError extends Error {\r\n    constructor(message, tokenCount) {\r\n        super(message);\r\n        this.name = 'TokenWarningError';\r\n        this.tokenCount = tokenCount;\r\n    }\r\n}\r\n\r\nclass AIResponseError extends Error {\r\n    constructor(message) {\r\n        super(message);\r\n        this.name = 'AIResponseError';\r\n    }\r\n}\r\n\r\nclass InvalidProfileError extends Error {\r\n    constructor(message) {\r\n        super(message);\r\n        this.name = 'InvalidProfileError';\r\n    }\r\n}\r\n\r\nfunction getCurrentCompletionEndpoint() {\r\n    return '/api/backends/chat-completions/generate';\r\n}\r\n\r\n\r\n/**\r\n*Send a raw completion request to the backend, bypassing SillyTavern's chat context stack.*\r\n*Supports OpenAI, Claude, Gemini, and custom OpenAI-compatible endpoints.*\r\n**\r\n*@param {Object} opts*\r\n*@param {string} opts.model*\r\n*@param {string} opts.prompt*\r\n*@param {number} [opts.temperature]*\r\n*@param {string} [opts.api] - 'openai', 'claude', 'makersuite', 'custom', etc. (Note: ST uses 'makersuite' as the canonical provider key; avoid other aliases).*\r\n*@param {string} [opts.endpoint] - Custom endpoint URL for custom APIs*\r\n*@param {Object} [opts.extra] - Any extra params (max_tokens, etc)*\r\n*@returns {Promise<{text: string, full: object}>}*\r\n*/\r\nexport async function sendRawCompletionRequest({\n    model,\n    prompt,\n    temperature = 0.7,\n    api = 'openai',\n    endpoint = null,\n    apiKey = null,\n    extra = {},\n}) {\n    let url = getCurrentCompletionEndpoint();\n    let headers = getRequestHeaders();\n\n    // Compute desired max tokens:\n    // - STMB override wins if set (>0)\n    // - otherwise use the largest explicit value from request extra / ST UI max_response\n    //   (no minimum enforced)\n    const stmbOverrideRaw = extension_settings?.STMemoryBooks?.moduleSettings?.maxTokens;\n    const stmbOverride = Number.parseInt(stmbOverrideRaw, 10);\n    const desiredFromSources = (Number.isFinite(stmbOverride) && stmbOverride > 0)\n        ? stmbOverride\n        : Math.max(\n            Number(extra.max_tokens) || 0,\n            Number(extra.max_completion_tokens) || 0,\n            Number(extra.max_output_tokens) || 0,\n            Number(oai_settings.max_response) || 0\n        );\n\n    const desiredInt = Math.floor(desiredFromSources) || 0;\n\n    // Set tokens based on explicit inputs; handle special-case for gpt-5 (any model id containing gpt-5)\n    if (Number.isFinite(desiredInt) && desiredInt > 0) {\n        const modelId = (typeof model === 'string' ? model.toLowerCase() : '');\n        if (modelId.includes('gpt-5')) {\n            extra.max_completion_tokens = desiredInt;\n            // Ensure we don't send max_tokens for this provider\n            delete extra.max_tokens;\n        } else {\n            extra.max_tokens = desiredInt;\n        }\n    }\n\n    // Optional: mirror to providers that use a different field if present\n    if (extra.max_output_tokens != null) {\n        // Coerce and validate the incoming value to a finite number before flooring to avoid NaN propagation\n        const moRaw = Number.parseFloat(extra.max_output_tokens);\n        const mo = Number.isFinite(moRaw) ? Math.floor(moRaw) : 0;\n        if (Number.isFinite(desiredInt) && desiredInt > 0) {\n            extra.max_output_tokens = Math.min(mo, desiredInt);\n        } else {\n            extra.max_output_tokens = mo;\n        }\n    }\n\r\n    let body = {\r\n        messages: [\r\n            { role: 'user', content: prompt }\r\n        ],\r\n        model,\r\n        temperature,\r\n        chat_completion_source: api,\r\n        ...extra,\r\n    };\r\n\r\n    // Handle full-manual configuration with direct endpoint calls\n    // Note: apiKey is optional (common for local OpenAI-compatible endpoints).\n    if (api === 'full-manual') {\n        const endpointUrl = String(endpoint || '').trim();\n        if (!endpointUrl) {\n            throw new InvalidProfileError('Full Manual Configuration requires an API Endpoint URL.');\n        }\n\n        url = endpointUrl;\n        headers = {\n            'Content-Type': 'application/json',\n        };\n        const key = apiKey != null ? String(apiKey).trim() : '';\n        if (key) {\n            headers['Authorization'] = `Bearer ${key}`;\n        }\n        // For direct endpoint calls, use standard OpenAI-compatible format\n        body = {\n            model,\n            messages: [\n                { role: 'user', content: prompt }\n            ],\n            temperature,\n            ...extra,\n        };\n    } else if (api === 'custom' && model) {\n        body.custom_model_id = model;\n        body.custom_url = oai_settings.custom_url || '';\n    } else if (api === 'deepseek') {\n        body.custom_url = `https://api.deepseek.com/chat/completions`; // use primary Deepseek endpoint\n    }\n\r\n    const res = await fetch(url, {\r\n        method: 'POST',\r\n        headers: headers,\r\n        body: JSON.stringify(body),\r\n    });\r\n\r\n    if (!res.ok) {\r\n        let providerBody = '';\r\n        try {\r\n            providerBody = await res.text();\r\n        } catch (e) {\r\n            providerBody = '';\r\n        }\r\n        const err = new Error(`LLM request failed: ${res.status} ${res.statusText}`);\r\n        if (providerBody) {\r\n            err.providerBody = providerBody;\r\n        }\r\n        throw err;\r\n    }\r\n\r\n    const data = await res.json();\r\n\r\n    let text = '';\r\n\r\n    // Handle different response formats\r\n    if (data.choices?.[0]?.message?.content) {\r\n        text = data.choices[0].message.content;\r\n    } else if (data.completion) {\r\n        text = data.completion;\r\n    } else if (data.choices?.[0]?.text) {\r\n        text = data.choices[0].text;\r\n    } else if (data.content && Array.isArray(data.content)) {\r\n        // Handle Claude's new structured format directly in raw response\r\n        const textBlock = data.content.find(block =>\r\n            block && typeof block === 'object' && block.type === 'text' && block.text\r\n        );\r\n        text = textBlock?.text || '';\r\n    } else if (typeof data.content === 'string') {\r\n        text = data.content;\r\n    }\r\n\r\n    return { text, full: data };\r\n}\r\n\r\n/**\r\n * Unified request wrapper for side prompts and memory generation.\r\n * Accepts normalized connection fields and forwards to sendRawCompletionRequest.\r\n * @param {{ api: string, model: string, prompt: string, temperature?: number, endpoint?: string, apiKey?: string, extra?: object }} opts\r\n * @returns {Promise<{ text: string, full: object }>}\r\n */\r\nexport async function requestCompletion({\r\n    api,\r\n    model,\r\n    prompt,\r\n    temperature = 0.7,\r\n    endpoint = null,\r\n    apiKey = null,\r\n    extra = {},\r\n}) {\r\n    // Delegate all provider-specific shaping to sendRawCompletionRequest which already\r\n    // handles: full-manual, custom (custom_model_id  oai_settings.custom_url), and normal providers.\r\n    return await sendRawCompletionRequest({\r\n        model,\r\n        prompt,\r\n        temperature,\r\n        api,\r\n        endpoint,\r\n        apiKey,\r\n        extra,\r\n    });\r\n}\r\n\r\n/**\r\n * Polling configuration for waitForCharacterData\r\n * @typedef {Object} PollingConfig\r\n * @property {number} maxWaitMs - Maximum time to wait in milliseconds (default: 5000)\r\n * @property {number} initialIntervalMs - Initial check interval in milliseconds (default: 100)\r\n * @property {number} maxIntervalMs - Maximum check interval in milliseconds (default: 1000)\r\n * @property {number} backoffMultiplier - Multiplier for exponential backoff (default: 1.5)\r\n * @property {boolean} useExponentialBackoff - Whether to use exponential backoff (default: true)\r\n * @property {AbortSignal} signal - Optional AbortSignal for cancellation\r\n */\r\n\r\n/**\r\n * GROUP CHAT SUPPORT: Waits for character/group data to be available with enhanced polling\r\n * Features exponential backoff, cancellation support, and better error handling\r\n * @private\r\n * @param {PollingConfig|number} config - Polling configuration or legacy maxWaitMs parameter\r\n * @param {number} legacyCheckIntervalMs - Legacy parameter for backward compatibility\r\n * @returns {Promise<boolean>} True if character/group data is available, false if timeout/cancelled\r\n */\r\nasync function waitForCharacterData(config = {}, legacyCheckIntervalMs = null) {\r\n    // Handle legacy parameter format for backward compatibility\r\n    let pollingConfig;\r\n    if (typeof config === 'number') {\r\n        pollingConfig = {\r\n            maxWaitMs: config,\r\n            initialIntervalMs: legacyCheckIntervalMs || 250,\r\n            maxIntervalMs: 1000,\r\n            backoffMultiplier: 1.2,\r\n            useExponentialBackoff: false // Keep legacy behavior\r\n        };\r\n    } else {\r\n        pollingConfig = {\r\n            maxWaitMs: 5000,\r\n            initialIntervalMs: 100,\r\n            maxIntervalMs: 1000,\r\n            backoffMultiplier: 1.5,\r\n            useExponentialBackoff: true,\r\n            ...config\r\n        };\r\n    }\r\n\r\n    const { \r\n        maxWaitMs, \r\n        initialIntervalMs, \r\n        maxIntervalMs, \r\n        backoffMultiplier, \r\n        useExponentialBackoff,\r\n        signal \r\n    } = pollingConfig;\r\n\r\n    const startTime = Date.now();\r\n    let currentInterval = initialIntervalMs;\r\n    let attemptCount = 0;\r\n    \r\n    // Import context detection to check if we're in a group chat\r\n    const { getCurrentMemoryBooksContext } = await import('./utils.js');\r\n    const context = getCurrentMemoryBooksContext();\r\n        \r\n    while (Date.now() - startTime < maxWaitMs) {\r\n        // Check for cancellation\r\n        if (signal?.aborted) {\r\n            return false;\r\n        }\r\n\r\n        let currentInterval = initialIntervalMs;\r\n        \r\n        // Import context detection to check if we're in a group chat        \r\n        if (context.isGroupChat) {\r\n            // Group chat - check if group data is available\r\n            if (groups && context.groupId) {\r\n                const group = groups.find(g => g.id === context.groupId);\r\n                if (group) {\r\n                    return true;\r\n                }\r\n            }\r\n        } else {\r\n            // Single character chat - use original logic\r\n            if (characters && characters.length > this_chid && characters[this_chid]) {\r\n                return true;\r\n            }\r\n        }\r\n        \r\n        // Wait before checking again with potential backoff\r\n        await new Promise((resolve, reject) => {\r\n            const timeoutId = setTimeout(resolve, currentInterval);\r\n            \r\n            // Handle cancellation during sleep\r\n            if (signal) {\r\n                const onAbort = () => {\r\n                    clearTimeout(timeoutId);\r\n                    reject(new Error('Cancelled'));\r\n                };\r\n                signal.addEventListener('abort', onAbort, { once: true });\r\n            }\r\n        }).catch(() => {\r\n            // Cancellation during sleep\r\n            return false;\r\n        });\r\n\r\n        // Apply exponential backoff if enabled\r\n        if (useExponentialBackoff && currentInterval < maxIntervalMs) {\r\n            currentInterval = Math.min(currentInterval * backoffMultiplier, maxIntervalMs);\r\n        }\r\n    }\r\n    \r\n    return false;\r\n}\r\n\r\n/**\r\n * Extracts JSON text from Claude's new structured response format\r\n * @private\r\n * @param {Object} aiResponse - Raw AI response that might be structured format\r\n * @returns {string|null} Extracted text content or null if not structured format\r\n */\r\nfunction extractFromClaudeStructuredFormat(aiResponse) {\r\n    try {\r\n        // Check if response has the new Claude structured format\r\n        if (typeof aiResponse === 'object' && aiResponse !== null && Array.isArray(aiResponse.content)) {\r\n            // Look for text type block in content array\r\n            const textBlock = aiResponse.content.find(block =>\r\n                block && typeof block === 'object' && block.type === 'text' && block.text\r\n            );\r\n\r\n            if (textBlock && typeof textBlock.text === 'string') {\r\n                return textBlock.text;\r\n            }\r\n        }\r\n\r\n        return null;\r\n    } catch (error) {\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction likelyUnbalanced(raw) {\r\n    try {\r\n        let braces = 0, brackets = 0, inString = false, isEscaping = false;\r\n        for (let i = 0; i < raw.length; i++) {\r\n            const ch = raw[i];\r\n            if (inString) {\r\n                if (isEscaping) {\r\n                    isEscaping = false;\r\n                } else if (ch === '\\\\') {\r\n                    isEscaping = true;\r\n                } else if (ch === '\"') {\r\n                    inString = false;\r\n                }\r\n            } else {\r\n                if (ch === '\"') { inString = true; }\r\n                else if (ch === '{') braces++;\r\n                else if (ch === '}') braces--;\r\n                else if (ch === '[') brackets++;\r\n                else if (ch === ']') brackets--;\r\n            }\r\n            if (braces < 0 || brackets < 0) return true;\r\n        }\r\n        return inString || braces !== 0 || brackets !== 0;\r\n    } catch {\r\n        return false;\r\n    }\r\n}\r\n\r\nfunction endsNicely(text) {\r\n    const t = (text || '').trim();\r\n    if (!t) return true;\r\n    if (/[.!?][\"'\\)\\]]?$/.test(t)) return true;\r\n    if (t.length >= 80 && !/[.!?]$/.test(t)) return false;\r\n    return true;\r\n}\r\n\r\n// --- Minimal robust helpers for LLM JSON extraction/repair (local-only, low risk) ---\r\n\r\nfunction normalizeText(s) {\r\n    return String(s)\r\n        .replace(/\\r\\n/g, '\\n')\r\n        .replace(/^\\uFEFF/, '')\r\n        .replace(/[\\u0000-\\u001F\\u200B-\\u200D\\u2060]/g, '');\r\n}\r\n\r\nfunction extractFencedBlocks(s) {\r\n    // Matches ```lang\\n ... \\n``` (lang optional)\r\n    const re = /```([\\w-]*)\\s*([\\s\\S]*?)```/g;\r\n    const out = [];\r\n    let m;\r\n    while ((m = re.exec(s)) !== null) {\r\n        out.push((m[2] || '').trim());\r\n    }\r\n    return out;\r\n}\r\n\r\nfunction extractBalancedJson(s) {\r\n    // Find first '{' or '[' and return balanced substring (ignores braces inside strings)\r\n    const start = s.search(/[\\{\\[]/);\r\n    if (start === -1) return null;\r\n    const open = s[start];\r\n    const close = open === '{' ? '}' : ']';\r\n    let depth = 0, inStr = false, esc = false;\r\n    for (let i = start; i < s.length; i++) {\r\n        const ch = s[i];\r\n        if (inStr) {\r\n            if (esc) { esc = false; }\r\n            else if (ch === '\\\\') { esc = true; }\r\n            else if (ch === '\"') { inStr = false; }\r\n            continue;\r\n        }\r\n        if (ch === '\"') { inStr = true; continue; }\r\n        if (ch === open) depth++;\r\n        else if (ch === close) {\r\n            depth--;\r\n            if (depth === 0) {\r\n                return s.slice(start, i + 1).trim();\r\n            }\r\n        }\r\n    }\r\n    return null; // unbalanced\r\n}\r\n\r\nfunction hasAnyJsonDelimiter(s) {\r\n    return /[\\{\\[]/.test(s);\r\n}\r\n\r\nfunction uniqStrings(arr) {\r\n    const seen = new Set(); const out = [];\r\n    for (const x of arr) { if (!seen.has(x)) { seen.add(x); out.push(x); } }\r\n    return out;\r\n}\r\n\r\nfunction snippet(s, max = 500) {\r\n    const t = (s || '').trim();\r\n    return t.length <= max ? t : t.slice(0, max) + '';\r\n}\r\n\r\n// Structured error helper with classification and minimal logging\r\nfunction makeAIError(code, message, recoverable = true) {\r\n    const err = new AIResponseError(message);\r\n    err.code = code;\r\n    err.recoverable = recoverable; // recoverable = fixable locally without re-asking\r\n    try {\r\n        console.debug(`STMemoryBooks: AIResponseError code=${code} recoverable=${recoverable}: ${message}`);\r\n    } catch {}\r\n    return err;\r\n}\r\n\r\n/**\r\n * Parses AI response as JSON with robust error handling\r\n * @private\r\n * @param {string} aiResponse - Raw AI response text\r\n * @returns {Object} Parsed JSON object\r\n * @throws {AIResponseError} If JSON parsing fails\r\n */\r\nexport function parseAIJsonResponse(aiResponse) {\r\n    let cleanResponse = aiResponse;\r\n\r\n    // Apply user-selected incoming regex scripts (bypass engine gating)\r\n    try {\r\n        const useRegex = !!(extension_settings?.STMemoryBooks?.moduleSettings?.useRegex);\r\n        const selectedKeys = extension_settings?.STMemoryBooks?.moduleSettings?.selectedRegexIncoming;\r\n        if (useRegex && typeof cleanResponse === 'string' && Array.isArray(selectedKeys) && selectedKeys.length > 0) {\r\n            cleanResponse = applySelectedRegex(cleanResponse, selectedKeys);\r\n        }\r\n    } catch (e) {\r\n        console.warn('STMemoryBooks: incoming regex application failed', e);\r\n    }\r\n\r\n    // Check for new Claude structured format first\r\n    if (typeof cleanResponse === 'object' && cleanResponse !== null && Array.isArray(cleanResponse.content)) {\r\n        const extractedText = extractFromClaudeStructuredFormat(cleanResponse);\r\n        if (extractedText) {\r\n            cleanResponse = extractedText;\r\n        } else {\r\n            const err = makeAIError('EMPTY_OR_INVALID', 'AI response is empty or invalid', false);\r\n            try { err.rawResponse = JSON.stringify(cleanResponse); } catch {}\r\n            throw err;\r\n        }\r\n    }\r\n    // If the response is an object with a .content property (but not array), use that.\r\n    else if (typeof cleanResponse === 'object' && cleanResponse !== null && cleanResponse.content) {\r\n        cleanResponse = cleanResponse.content;\r\n    }\r\n\r\n    // Google AI Studio / Gemini envelope unwrap\r\n    if (typeof cleanResponse === 'object' && cleanResponse !== null) {\r\n        try {\r\n            const cand = cleanResponse?.candidates?.[0];\r\n            const parts = cand?.content?.parts;\r\n            if (Array.isArray(parts) && parts.length > 0) {\r\n                const joined = parts\r\n                    .map(p => (p && typeof p.text === 'string') ? p.text : '')\r\n                    .join('');\r\n                if (joined && joined.trim()) {\r\n                    cleanResponse = joined;\r\n                }\r\n            }\r\n        } catch (e) {\r\n            // Non-fatal: fall through to existing logic\r\n        }\r\n    }\r\n\r\n    if (!cleanResponse || typeof cleanResponse !== 'string') {\r\n        const err = makeAIError('EMPTY_OR_INVALID', 'AI response is empty or invalid', false);\r\n        try { err.rawResponse = typeof cleanResponse === 'string' ? cleanResponse : JSON.stringify(cleanResponse); } catch {}\r\n        throw err;\r\n    }\r\n\r\n    cleanResponse = cleanResponse.trim();\r\n\r\n    // Remove <think> tags and their content\r\n    cleanResponse = cleanResponse.replace(/<think>[\\s\\S]*?<\\/think>/gi, '');\r\n\r\n    // Normalize and prepare candidates\r\n    const normalized = normalizeText(cleanResponse);\r\n    const candidates = [];\r\n\r\n    // 1) Prefer fenced code blocks if present (handles ```json, ```jsonc, ```javascript, etc.)\r\n    const fenced = extractFencedBlocks(normalized);\r\n    if (fenced.length) candidates.push(...fenced);\r\n\r\n    // 2) Consider entire normalized text (in case it's pure JSON already)\r\n    candidates.push(normalized);\r\n\r\n    // 3) Balanced JSON substring from the whole string\r\n    const balanced = extractBalancedJson(normalized);\r\n    if (balanced) candidates.push(balanced);\r\n\r\n    const uniq = uniqStrings(candidates);\r\n\r\n    const validateParsed = (obj) => {\r\n        if (!obj || typeof obj !== 'object') {\r\n            return makeAIError('EMPTY_OR_INVALID', 'AI response is empty or invalid', false);\r\n        }\r\n        if (!obj.content && !obj.summary && !obj.memory_content) {\r\n            return makeAIError('MISSING_FIELDS_CONTENT', 'AI response missing content field', false);\r\n        }\r\n        if (!obj.title) {\r\n            return makeAIError('MISSING_FIELDS_TITLE', 'AI response missing title field', false);\r\n        }\r\n        if (!Array.isArray(obj.keywords)) {\r\n            return makeAIError('INVALID_KEYWORDS', 'AI response missing or invalid keywords array.', false);\r\n        }\r\n        return null;\r\n    };\r\n\r\n    // Attempt parse with light repair when needed\r\n    let lastFieldError = null;\r\n    for (const cand of uniq) {\r\n        // Direct parse\r\n        try {\r\n            const parsedDirect = JSON.parse(cand);\r\n            const fieldErr = validateParsed(parsedDirect);\r\n            if (fieldErr) {\r\n                lastFieldError = fieldErr;\r\n            } else {\r\n                return parsedDirect;\r\n            }\r\n        } catch {\r\n            // ignore and try repair parse below\r\n        }\r\n\r\n        // Repair parse (dirty-json)\r\n        try {\r\n            const parsedRepaired = dirtyJson.parse(cand);\r\n            const fieldErr = validateParsed(parsedRepaired);\r\n            if (fieldErr) {\r\n                lastFieldError = fieldErr;\r\n            } else {\r\n                return parsedRepaired;\r\n            }\r\n        } catch {\r\n            // continue trying other candidates\r\n        }\r\n    }\r\n\r\n    // Classify failure\r\n    if (!hasAnyJsonDelimiter(normalized)) {\r\n        const err = makeAIError('NO_JSON_BLOCK', 'AI response did not contain a JSON block. The model may have returned prose or declined the request.', true);\r\n        err.rawResponse = normalized;\r\n        throw err;\r\n    }\r\n    if (likelyUnbalanced(normalized)) {\r\n        const err = makeAIError('UNBALANCED', 'AI response appears truncated or invalid JSON (unbalanced structures). Try increasing Max Response Length.', false);\r\n        err.rawResponse = normalized;\r\n        throw err;\r\n    }\r\n\r\n    // Heuristic: ends mid-sentence suggests truncation\r\n    const textCandidate = normalized.trim();\r\n    if (textCandidate && textCandidate.length >= 80 && !endsNicely(textCandidate)) {\r\n        const err = makeAIError('INCOMPLETE_SENTENCE', 'AI response JSON appears incomplete (text ends mid-sentence). Try increasing Max Response Length.', false);\r\n        err.rawResponse = normalized;\r\n        throw err;\r\n    }\r\n\r\n    // If we parsed something but it was missing required fields, surface that error\r\n    if (lastFieldError) {\r\n        lastFieldError.rawResponse = normalized;\r\n        throw lastFieldError;\r\n    }\r\n\r\n    // Fallback\r\n    {\r\n        const err = makeAIError('MALFORMED', 'AI did not return valid JSON. This may indicate the model does not support structured output well or the response contained unsupported formatting.', false);\r\n        err.rawResponse = normalized;\r\n        throw err;\r\n    }\r\n}\r\n\r\n// Build a memory object from a corrected raw response using the existing parser\r\n export function generateMemoryFromRaw(correctedRaw, profile) {\r\n    const jsonResult = parseAIJsonResponse(correctedRaw);\r\n    return {\r\n        content: jsonResult.content || jsonResult.summary || jsonResult.memory_content || '',\r\n        title: jsonResult.title || 'Memory',\r\n        keywords: Array.isArray(jsonResult.keywords) ? jsonResult.keywords : [],\r\n        profile\r\n    };\r\n}\r\n\r\n// Submit corrected raw, return a memory-like object for insertion\r\n export async function submitCorrectedRaw(correctedRaw, profile) {\r\n    // Reuse parsing  memory construction logic\r\n    const memory = generateMemoryFromRaw(correctedRaw, profile);\r\n    // In a real app, you might submit to backend or trigger an insertion event.\r\n    // Here we return the memory object so the caller/UI can insert/use it accordingly.\r\n    return memory;\r\n}\r\n\r\n/**\r\n * Generates memory using AI with structured JSON output instead of tool calling.\r\n * @private\r\n * @param {string} promptString - The full prompt for the AI\r\n * @param {Object} profile - The user-selected profile containing connection settings\r\n * @returns {Promise<Object>} The structured memory result from JSON parsing\r\n * @throws {AIResponseError} If the AI generation fails or doesn't return valid JSON\r\n */\r\nasync function generateMemoryWithAI(promptString, profile) {\r\n    const characterDataReady = await waitForCharacterData();\r\n    if (!characterDataReady) {\r\n        throw new AIResponseError(\r\n            'Character data is not available. This may indicate that SillyTavern is still loading. Please wait a moment and try again.'\r\n        );\r\n    }\r\n\r\n    const conn = profile?.effectiveConnection || profile?.connection || {};\r\n\r\n    try {\r\n        // Prepare connection info\r\n        // Note: ST base uses 'makersuite' as the canonical provider key for this source.\r\n        const apiType = normalizeCompletionSource(conn.api || getCurrentApiInfo().api);\n        const extra = {};\n        const stmbMaxTokensRaw = extension_settings?.STMemoryBooks?.moduleSettings?.maxTokens;\n        const stmbMaxTokens = Number.parseInt(stmbMaxTokensRaw, 10);\n        if (Number.isFinite(stmbMaxTokens) && stmbMaxTokens > 0) {\n            extra.max_tokens = stmbMaxTokens;\n        } else if (oai_settings.openai_max_tokens) {\n            extra.max_tokens = oai_settings.openai_max_tokens;\n        }\n\r\n        const { text: aiResponseText, full: aiFull } = await sendRawCompletionRequest({\r\n            model: conn.model,\r\n            prompt: promptString,\r\n            temperature: conn.temperature,\r\n            api: apiType,\r\n            endpoint: conn.endpoint,\r\n            apiKey: conn.apiKey,\r\n            extra: extra\r\n        });\r\n\r\n        // Detect provider-reported truncation before attempting to parse\r\n        const finishReason = aiFull?.choices?.[0]?.finish_reason || aiFull?.finish_reason || aiFull?.stop_reason;\r\n        const fr = typeof finishReason === 'string' ? finishReason.toLowerCase() : '';\r\n        if (fr.includes('length') || fr.includes('max')) {\r\n            const err = makeAIError('PROVIDER_TRUNCATION', 'Model response appears truncated (provider finish_reason). Please increase Max Response Length.', false);\r\n            try { err.rawResponse = aiResponseText || ''; } catch {}\r\n            try { err.providerResponse = aiFull || null; } catch {}\r\n            throw err;\r\n        }\r\n        if (aiFull?.truncated === true) {\r\n            const err = makeAIError('PROVIDER_TRUNCATION_FLAG', 'Model response appears truncated (provider flag). Please increase Max Response Length.', false);\r\n            try { err.rawResponse = aiResponseText || ''; } catch {}\r\n            try { err.providerResponse = aiFull || null; } catch {}\r\n            throw err;\r\n        }\r\n\r\n        const jsonResult = parseAIJsonResponse(aiResponseText);\r\n\r\n        return {\r\n            content: jsonResult.content || jsonResult.summary || jsonResult.memory_content || '',\r\n            title: jsonResult.title || 'Memory',\r\n            keywords: jsonResult.keywords || [],\r\n            profile: profile\r\n        };\r\n    } catch (error) {\r\n        if (error instanceof AIResponseError) throw error;\r\n        const e = new AIResponseError(`Memory generation failed: ${error.message || error}`);\r\n        try {\r\n            if (typeof error?.providerBody === 'string') {\r\n                e.providerBody = error.providerBody;\r\n            }\r\n            if (typeof error?.rawResponse === 'string') {\r\n                e.rawResponse = error.rawResponse;\r\n            }\r\n        } catch {}\r\n        throw e;\r\n    }\r\n}\r\n\r\n/**\r\n * Creates a memory from a compiled scene using AI with structured JSON output.\r\n * This is the main entry point for this module.\r\n *\r\n * @param {Object} compiledScene - Scene data from chatcompile.js\r\n * @param {Object} profile - The user-selected memory generation profile from settings\r\n * @param {Object} options - Additional generation options\r\n * @param {number} options.tokenWarningThreshold - Token threshold for warnings (default: 30000)\r\n * @returns {Promise<Object>} The generated memory result, ready for lorebook insertion\r\n * @throws {TokenWarningError} If the estimated token count exceeds the warning threshold\r\n * @throws {InvalidProfileError} If the provided profile is incomplete\r\n * @throws {AIResponseError} If the AI fails to generate a valid response\r\n * @throws {Error} For other general failures\r\n */\r\nexport async function createMemory(compiledScene, profile, options = {}) {\r\n    \r\n    try {\r\n        validateInputs(compiledScene, profile);\r\n        const promptString = await buildPrompt(compiledScene, profile);\r\n        const tokenEstimate = await estimateTokenUsage(promptString);        \r\n        const tokenWarningThreshold = options.tokenWarningThreshold ?? 30000;\r\n        if (tokenEstimate.total > tokenWarningThreshold) {\r\n            throw new TokenWarningError(\r\n                'Token warning threshold exceeded.',\r\n                tokenEstimate.total\r\n            );\r\n        }\r\n        \r\n        const response = await generateMemoryWithAI(promptString, profile);\r\n        const processedMemory = processJsonResult(response, compiledScene);\r\n\r\n        const memoryResult = {\r\n            content: processedMemory.content,\r\n            extractedTitle: processedMemory.extractedTitle,\r\n            metadata: {\r\n                sceneRange: `${compiledScene.metadata.sceneStart}-${compiledScene.metadata.sceneEnd}`,\r\n                messageCount: compiledScene.metadata.messageCount,\r\n                characterName: compiledScene.metadata.characterName,\r\n                userName: compiledScene.metadata.userName,\r\n                chatId: compiledScene.metadata.chatId,\r\n                createdAt: new Date().toISOString(),\r\n                profileUsed: profile.name,\r\n                presetUsed: profile.preset || 'custom',\r\n                tokenUsage: tokenEstimate,\r\n                generationMethod: 'json-structured-output',\r\n                version: '2.0'\r\n            },\r\n            suggestedKeys: processedMemory.suggestedKeys,\r\n            titleFormat: (profile.useDynamicSTSettings || (profile?.connection?.api === 'current_st')) ?\r\n                (extension_settings.STMemoryBooks?.titleFormat || '[000] - {{title}}') :\r\n                (profile.titleFormat || '[000] - {{title}}'),\r\n            lorebookSettings: {\n                constVectMode: profile.constVectMode,\n                position: profile.position,\n                orderMode: profile.orderMode,\n                orderValue: profile.orderValue,\n                reverseStart: Number.isFinite(profile.reverseStart) ? profile.reverseStart : 9999,\n                preventRecursion: profile.preventRecursion,\n                delayUntilRecursion: profile.delayUntilRecursion,\n                outletName: (Number(profile.position) === 7 ? (profile.outletName || '') : undefined),\n            },\n            lorebook: {\r\n                content: processedMemory.content,\r\n                comment: `Auto-generated memory from messages ${compiledScene.metadata.sceneStart}-${compiledScene.metadata.sceneEnd}. Profile: ${profile.name}.`,\r\n                key: processedMemory.suggestedKeys || [],\r\n                keysecondary: [],\r\n                selective: true,\r\n                constant: false,\r\n                order: 100,\r\n                position: 'before_char',\r\n                disable: false,\r\n                addMemo: true,\r\n                excludeRecursion: false,\r\n                delayUntilRecursion: true,\r\n                probability: 100,\r\n                useProbability: false\r\n            }\r\n        };\r\n        \r\n        return memoryResult;\r\n        \r\n    } catch (error) {\r\n        if (error instanceof TokenWarningError || error instanceof AIResponseError || error instanceof InvalidProfileError) {\r\n            throw error;\r\n        }\r\n        throw new Error(`Memory creation failed: ${error.message}`);\r\n    }\r\n}\r\n\r\n/**\r\n * Validates the essential inputs for the memory creation process.\r\n * @private\r\n * @param {Object} compiledScene - The compiled scene data.\r\n * @param {Object} profile - The user-selected profile.\r\n * @throws {Error} If the scene is invalid.\r\n * @throws {InvalidProfileError} If the profile is invalid.\r\n */\r\nfunction validateInputs(compiledScene, profile) {\r\n    // Clear and readable check for empty scene\r\n    if (!compiledScene || !Array.isArray(compiledScene.messages) || compiledScene.messages.length === 0) {\r\n        throw new Error('Invalid or empty compiled scene data provided.');\r\n    }\r\n\r\n    // profile must have a non-empty prompt OR a preset key\r\n    const hasPrompt = typeof profile?.prompt === 'string' && profile.prompt.trim().length > 0;\r\n    const hasPreset = typeof profile?.preset === 'string' && profile.preset.trim().length > 0;\r\n\r\n    if (!hasPrompt && !hasPreset) {\r\n        throw new InvalidProfileError('Invalid profile configuration. You must set either a custom prompt or a valid preset.');\r\n    }\r\n}\r\n\r\n/**\r\n * Formats the array of scene messages into a single text block for the AI.\r\n * @private\r\n * @param {Array<Object>} messages - The messages from the compiled scene.\r\n * @param {Object} metadata - The metadata from the compiled scene.\r\n * @param {Array<Object>} previousSummariesContext - Previous summaries for context (optional).\r\n * @returns {string} A formatted string representing the chat scene.\r\n */\r\nfunction formatSceneForAI(messages, metadata, previousSummariesContext = []) {\r\n    const messageLines = messages.map(message => {\r\n        const speaker = message.name || 'Unknown';\r\n        const content = (message.mes || '').trim();\r\n        return content ? `${speaker}: ${content}` : null;\r\n    }).filter(Boolean); // Filter out any empty/null messages\r\n        \r\n    const sceneHeader = [\r\n        \"\"\r\n    ];\r\n    \r\n    // Add previous memories context if available\r\n    if (previousSummariesContext && previousSummariesContext.length > 0) {\r\n        sceneHeader.push(\"=== PREVIOUS SCENE CONTEXT (DO NOT SUMMARIZE) ===\");\r\n        sceneHeader.push(\"These are previous memories for context only. Do NOT include them in your new memory:\");\r\n        sceneHeader.push(\"\");\r\n        \r\n        previousSummariesContext.forEach((memory, index) => {\r\n            sceneHeader.push(`Context ${index + 1} - ${memory.title}:`);\r\n            sceneHeader.push(memory.content);\r\n            if (memory.keywords && memory.keywords.length > 0) {\r\n                sceneHeader.push(`Keywords: ${memory.keywords.join(', ')}`);\r\n            }\r\n            sceneHeader.push(\"\");\r\n        });\r\n        \r\n        sceneHeader.push(\"=== END PREVIOUS SCENE CONTEXT - SUMMARIZE ONLY THE SCENE BELOW ===\");\r\n        sceneHeader.push(\"\");\r\n    }\r\n    \r\n    sceneHeader.push(\"=== SCENE TRANSCRIPT ===\");\r\n    sceneHeader.push(...messageLines);\r\n    sceneHeader.push(\"\");\r\n    sceneHeader.push(\"=== END SCENE ===\");\r\n    \r\n    return sceneHeader.join('\\n');\r\n}\r\n\r\n/**\r\n * Estimates the token usage for the given prompt string.\r\n * @private\r\n * @param {string} promptString - The complete prompt to be sent to the AI.\r\n * @returns {Promise<{input: number, output: number, total: number}>} An object with token counts.\r\n */\r\nasync function estimateTokenUsage(promptString) {\r\n    return await estimateTokens(promptString, { estimatedOutput: 300 });\r\n}\r\n\r\n/**\r\n * Build the complete prompt string for JSON output\r\n * @private\r\n * @param {Object} compiledScene - The compiled scene data.\r\n * @param {Object} profile - The user-selected profile.\r\n * @returns {Promise<string>} The fully formatted prompt string.\r\n */\r\nasync function buildPrompt(compiledScene, profile) {\r\n    const { metadata, messages, previousSummariesContext } = compiledScene;\r\n    \r\n    // Use utils.js to get the effective prompt (now designed for JSON output)\r\n    const systemPrompt = await getEffectivePrompt(profile);\r\n    \r\n    // Use substituteParams to allow for standard macros like {{char}} and {{user}}\r\n    const processedSystemPrompt = substituteParams(systemPrompt, metadata.userName, metadata.characterName);\r\n    \r\n    // Build scene text for user prompt\r\n    const sceneText = formatSceneForAI(messages, metadata, previousSummariesContext);\r\n    \r\n    // Combine system prompt and scene\r\n    const finalPrompt = `${processedSystemPrompt}\\n\\n${sceneText}`;\r\n\r\n    // Apply user-selected outgoing regex scripts (bypass engine gating)\r\n    try {\r\n        const useRegex = !!(extension_settings?.STMemoryBooks?.moduleSettings?.useRegex);\r\n        const selectedKeys = extension_settings?.STMemoryBooks?.moduleSettings?.selectedRegexOutgoing;\r\n        if (useRegex && Array.isArray(selectedKeys) && selectedKeys.length > 0) {\r\n            return applySelectedRegex(finalPrompt, selectedKeys);\r\n        }\r\n    } catch (e) {\r\n        console.warn('STMemoryBooks: outgoing regex application failed', e);\r\n    }\r\n    return finalPrompt;\r\n}\r\n\r\n/**\r\n * Process the structured result from JSON parsing\r\n * @private\r\n * @param {Object} jsonResult - The structured result from JSON parsing\r\n * @param {Object} compiledScene - The original compiled scene for context\r\n * @returns {Object} Processed memory data\r\n */\r\nfunction processJsonResult(jsonResult, compiledScene) {\r\n    const { content, title, keywords } = jsonResult;\r\n    \r\n    // Clean and validate content\r\n    const cleanContent = (content || jsonResult.summary || jsonResult.memory_content || '').trim();\r\n    const cleanTitle = (title || 'Memory').trim();\r\n    const cleanKeywords = Array.isArray(keywords) ? \r\n        keywords.filter(k => k && typeof k === 'string' && k.trim() !== '').map(k => k.trim()) : [];\r\n    \r\n    return {\r\n        content: cleanContent,\r\n        extractedTitle: cleanTitle,\r\n        suggestedKeys: cleanKeywords\r\n    };\r\n}\r\n",
    "import { getContext } from '../../../extensions.js';\nimport {\n    METADATA_KEY,\n    loadWorldInfo,\n    createWorldInfoEntry,\n    saveWorldInfo,\n    reloadEditor\n} from '../../../world-info.js';\nimport { extension_settings } from '../../../extensions.js';\nimport { moment } from '../../../../lib.js';\nimport { executeSlashCommands } from '../../../slash-commands.js';\nimport { getSceneMarkers, saveMetadataForCurrentContext } from './sceneManager.js';\nimport { translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-AddLore';\n\n/**\n * Local i18n wrapper to maintain legacy i18n(key, fallback, params) calls.\n * Uses SillyTavern translate(fallback, key) and simple {{var}} interpolation.\n */\nfunction i18n(key, fallback, params) {\n    const localized = translate(fallback, key);\n    if (!params) return localized;\n    return localized.replace(/{{\\s*(\\w+)\\s*}}/g, (m, p1) => {\n        const v = params[p1];\n        return v !== undefined && v !== null ? String(v) : '';\n    });\n}\n\n/**\n * Parse scene range from metadata string format \"start-end\"\n * @private\n * @param {string} sceneRange - Scene range string like \"3-5\"\n * @returns {Object|null} - {start, end} or null if invalid\n */\nfunction parseSceneRange(sceneRange) {\n    if (!sceneRange) {\n        return null;\n    }\n    const parts = sceneRange.split('-');\n    if (parts.length !== 2) {\n        return null;\n    }\n    const start = parseInt(parts[0], 10);\n    const end = parseInt(parts[1], 10);\n    if (isNaN(start) || isNaN(end) || start < 0 || end < 0) {\n        return null;\n    }\n    return { start, end };\n}\n\n/**\n * Execute hide command with consistent logging\n * @private\n * @param {string} hideCommand - Hide command to execute\n * @param {string} context - Optional context description\n */\nasync function executeHideCommand(hideCommand, context = '') {\n    const contextStr = context ? ` (${context})` : '';\n    console.log(i18n('addlore.log.executingHideCommand', `${MODULE_NAME}: Executing hide command${contextStr}: {{hideCommand}}`, { hideCommand }));\n    await executeSlashCommands(hideCommand);\n}\n\n/**\n * Safely execute a hide command and log a warning on failure\n * @private\n * @param {string} hideCommand - Hide command to execute\n * @param {string} context - Optional context description\n */\nasync function safeExecuteHideCommand(hideCommand, context = '') {\n    try {\n        await executeHideCommand(hideCommand, context);\n    } catch (e) {\n        console.warn(i18n('addlore.warn.autohideFailed', `${MODULE_NAME}: Auto-hide failed:`), e);\n    }\n}\n\n/**\n * Helper function to convert old boolean auto-hide settings to new dropdown format\n */\nfunction getAutoHideMode(moduleSettings = {}) {\n    // Handle new format\n    if (moduleSettings.autoHideMode) {\n        return moduleSettings.autoHideMode;\n    }\n    \n    // Convert from old boolean format for backward compatibility\n    if (moduleSettings.autoHideAllMessages) {\n        return 'all';\n    } else if (moduleSettings.autoHideLastMemory) {\n        return 'last';\n    } else {\n        return 'none';\n    }\n}\n\n// Default title formats that users can select from\nconst DEFAULT_TITLE_FORMATS = [\n    '[000] - {{title}} ({{profile}})', // i18n('addlore.titleFormats.0', '[000] - {{title}} ({{profile}})')\n    '{{date}} [000] {{title}}, {{messages}} msgs', // i18n('addlore.titleFormats.1', '{{date}} [000] {{title}}, {{messages}} msgs')\n    '[000] {{date}} - {{char}} Memory', // i18n('addlore.titleFormats.2', '[000] {{date}} - {{char}} Memory')\n    '[00] - {{user}} & {{char}} {{scene}}', // i18n('addlore.titleFormats.3', '[00] - {{user}} & {{char}} {{scene}}')\n    ' [000] ({{messages}} msgs)', // i18n('addlore.titleFormats.4', ' [000] ({{messages}} msgs)')\n    ' Memory #[000] - {{profile}} {{date}} {{time}}', // i18n('addlore.titleFormats.5', ' Memory #[000] - {{profile}} {{date}} {{time}}')\n    '[000] - {{scene}}: {{title}}', // i18n('addlore.titleFormats.6', '[000] - {{scene}}: {{title}}')\n    '[000] - {{title}} ({{scene}})', // i18n('addlore.titleFormats.7', '[000] - {{title}} ({{scene}})')\n    '[000] - {{title}}' // i18n('addlore.titleFormats.8', '[000] - {{title}}')\n];\n\n/**\n * Adds a generated memory to the chat's bound lorebook.\n * This is the main entry point called from index.js after memory generation.\n *\n * @param {Object} memoryResult - The result from stmemory.js\n * @param {string} memoryResult.content - The main text of the memory\n * @param {string} memoryResult.extractedTitle - AI-generated title (if any)\n * @param {string[]} memoryResult.suggestedKeys - Array of keywords for the entry\n * @param {Object} memoryResult.metadata - Metadata about the memory creation\n * @param {Object} memoryResult.lorebook - Lorebook-specific configuration\n * @param {Object} lorebookValidation - Validation result from validateLorebook()\n * @param {boolean} lorebookValidation.valid - Whether lorebook is valid\n * @param {Object} lorebookValidation.data - Loaded lorebook data\n * @param {string} lorebookValidation.name - Lorebook name\n * @returns {Promise<Object>} Result object with success status and details\n */\nexport async function addMemoryToLorebook(memoryResult, lorebookValidation) {\n\n    try {\n        if (!memoryResult?.content) {\n            throw new Error(i18n('addlore.errors.invalidContent', 'Invalid memory result: missing content'));\n        }\n\n        if (!lorebookValidation?.valid || !lorebookValidation.data) {\n            throw new Error(i18n('addlore.errors.invalidLorebookValidation', 'Invalid lorebook validation data'));\n        }\n\n        const settings = extension_settings.STMemoryBooks || {};\n        let titleFormat = memoryResult.titleFormat;\n        if (!titleFormat) {\n            titleFormat = settings.titleFormat || i18n('addlore.titleFormats.8', '[000] - {{title}}');\n        }\n        const refreshEditor = settings.moduleSettings?.refreshEditor !== false;\n\n        const lorebookSettings = memoryResult.lorebookSettings || {\n            constVectMode: 'link',\n            position: 0,\n            orderMode: 'auto',\n            orderValue: 100,\n            reverseStart: 9999,\n            preventRecursion: false,\n            delayUntilRecursion: true\n        };\n\n        const newEntry = createWorldInfoEntry(lorebookValidation.name, lorebookValidation.data);\n\n        if (!newEntry) {\n            throw new Error(i18n('addlore.errors.createEntryFailed', 'Failed to create new lorebook entry'));\n        }\n\n        const entryTitle = generateEntryTitle(titleFormat, memoryResult, lorebookValidation.data);\n        populateLorebookEntry(newEntry, memoryResult, entryTitle, lorebookSettings);\n        await saveWorldInfo(lorebookValidation.name, lorebookValidation.data, true);\n\n        if (settings.moduleSettings?.showNotifications !== false) {\n            toastr.success(\n                i18n('addlore.toast.added', 'Memory \"{{entryTitle}}\" added to \"{{lorebookName}}\"', { entryTitle: entryTitle, lorebookName: lorebookValidation.name }),\n                i18n('addlore.toast.title', 'STMemoryBooks')\n            );\n        }\n        \n        if (refreshEditor) {\n            try {\n                await Promise.resolve(reloadEditor(lorebookValidation.name));\n            } catch (e) {\n                console.warn(i18n('addlore.warn.refreshEditorFailed', `${MODULE_NAME}: reloadEditor failed:`), e);\n            }\n        }\n        \n        // Execute auto-hide commands if enabled\n        const autoHideMode = getAutoHideMode(settings.moduleSettings);\n\n        if (autoHideMode !== 'none') {\n            const unhiddenCount = settings.moduleSettings.unhiddenEntriesCount ?? 2;\n\n            if (autoHideMode === 'all') {\n                const sceneData = parseSceneRange(memoryResult.metadata?.sceneRange);\n\n                if (!sceneData) {\n                    console.warn(i18n('addlore.warn.autohideSkippedInvalidRange', `${MODULE_NAME}: Auto-hide skipped - invalid scene range: \"{{range}}\"`, { range: memoryResult.metadata?.sceneRange }));\n                    toastr.warning(\n                        i18n('addlore.toast.autohideInvalidRange', 'Auto-hide skipped: invalid scene range metadata'),\n                        i18n('addlore.toast.title', 'STMemoryBooks')\n                    );\n                } else {\n                    const { start: sceneStart, end: sceneEnd } = sceneData;\n\n                    if (unhiddenCount === 0) {\n                        await safeExecuteHideCommand(`/hide 0-${sceneEnd}`, i18n('addlore.hideCommand.allComplete', 'all mode - complete'));\n                    } else {\n                        const hideEndIndex = sceneEnd - unhiddenCount;\n                        if (hideEndIndex >= 0) {\n                            await safeExecuteHideCommand(`/hide 0-${hideEndIndex}`, i18n('addlore.hideCommand.allPartial', 'all mode - partial'));\n                        }\n                        // Auto-hide silently skipped if not enough messages\n                    }\n                }\n            } else if (autoHideMode === 'last') {\n                const sceneData = parseSceneRange(memoryResult.metadata?.sceneRange);\n                if (!sceneData) {\n                    console.warn(i18n('addlore.warn.autohideSkippedInvalidRange', `${MODULE_NAME}: Auto-hide skipped - invalid scene range: \"{{range}}\"`, { range: memoryResult.metadata?.sceneRange }));\n                    toastr.warning(\n                        i18n('addlore.toast.autohideInvalidRange', 'Auto-hide skipped: invalid scene range metadata'),\n                        i18n('addlore.toast.title', 'STMemoryBooks')\n                    );\n                } else {\n                    const { start: sceneStart, end: sceneEnd } = sceneData;\n                    const sceneSize = sceneEnd - sceneStart + 1;\n\n                    if (unhiddenCount >= sceneSize) {\n                        // No hiding needed - want to keep more messages than scene contains\n                    } else if (unhiddenCount === 0) {\n                        await safeExecuteHideCommand(`/hide ${sceneStart}-${sceneEnd}`, i18n('addlore.hideCommand.lastHideAll', 'last mode - hide all'));\n                    } else {\n                        const hideEnd = sceneEnd - unhiddenCount;\n                        if (hideEnd >= sceneStart) {\n                            await safeExecuteHideCommand(`/hide ${sceneStart}-${hideEnd}`, i18n('addlore.hideCommand.lastPartial', 'last mode - partial'));\n                        }\n                        // Auto-hide silently skipped if not enough scene messages\n                    }\n                }\n            }\n        }\n        // Update highest memory processed tracking\n        updateHighestMemoryProcessed(memoryResult);\n\n        return {\n            success: true,\n            entryId: newEntry.uid,\n            entryTitle: entryTitle,\n            lorebookName: lorebookValidation.name,\n            keywordCount: memoryResult.suggestedKeys?.length || 0,\n            message: i18n('addlore.result.added', 'Memory successfully added to \"{{lorebookName}}\"', { lorebookName: lorebookValidation.name })\n        };\n        \n    } catch (error) {\n        console.error(i18n('addlore.log.addFailed', `${MODULE_NAME}: Failed to add memory to lorebook:`), error);\n        \n        if (extension_settings.STMemoryBooks?.moduleSettings?.showNotifications !== false) {\n            toastr.error(\n                i18n('addlore.toast.addFailed', 'Failed to add memory: {{message}}', { message: error.message }),\n                i18n('addlore.toast.title', 'STMemoryBooks')\n            );\n        }\n        \n        return {\n            success: false,\n            error: error.message,\n            message: i18n('addlore.result.addFailed', 'Failed to add memory to lorebook: {{message}}', { message: error.message })\n        };\n    }\n}\n\n/**\n * Populates a lorebook entry with memory data\n * @private\n * @param {Object} entry - The lorebook entry to populate\n * @param {Object} memoryResult - The memory generation result\n * @param {string} entryTitle - The generated title for this entry\n * @param {Object} lorebookSettings - The user-configured lorebook settings\n */\nfunction populateLorebookEntry(entry, memoryResult, entryTitle, lorebookSettings) {\n    // Core content and keywords\n    entry.content = memoryResult.content;\n    entry.key = memoryResult.suggestedKeys || [];\n    entry.comment = entryTitle;\n    \n    // Extract order number from title for auto-numbering\n    const orderNumber = extractNumberFromTitle(entryTitle) || 1;\n    \n    // 1. Constant / Vectorized Mode\n    switch (lorebookSettings.constVectMode) {\n        case 'blue': // Constant\n            entry.constant = true;\n            entry.vectorized = false;\n            break;\n        case 'green': // Normal\n            entry.constant = false;\n            entry.vectorized = false;\n            break;\n        case 'link': // Vectorized (Default)\n        default:\n            entry.constant = false;\n            entry.vectorized = true;\n            break;\n    }\n    \n    // 2. Insertion Position\n    entry.position = lorebookSettings.position;\n\n    // 2a. Outlet Name for Outlet position (7)\n    if (Number(lorebookSettings.position) === 7) {\n        const outName = String(lorebookSettings.outletName || '').trim();\n        if (outName) {\n            entry.outletName = outName;\n        }\n    }\n\n    // 3. Insertion Order\n    {\n        const ORDER_MIN = 0;\n        const ORDER_MAX = 9999;\n\n        const mode = lorebookSettings.orderMode;\n        const isManual = mode === 'manual';\n        const isReverse = mode === 'reverse';\n\n        const reverseStartRaw = lorebookSettings.reverseStart;\n        const reverseStartNum = Number(reverseStartRaw);\n        const reverseStart = Number.isFinite(reverseStartNum)\n            ? Math.min(9999, Math.max(100, Math.trunc(reverseStartNum)))\n            : 9999;\n\n        const rawOrder = isManual\n            ? lorebookSettings.orderValue\n            : (isReverse ? (reverseStart - (Number(orderNumber) - 1)) : orderNumber);\n\n        const rawOrderNum = Number(rawOrder);\n        const sourceLabel = isManual\n            ? 'manual order value'\n            : (isReverse ? `computed order (from memory #${orderNumber})` : 'memory number');\n\n        let finalOrder = rawOrder;\n        if (!Number.isFinite(rawOrderNum)) {\n            // Fallback for invalid values (NaN, undefined, etc.)\n            finalOrder = isManual ? 100 : orderNumber;\n        } else if (rawOrderNum < ORDER_MIN || rawOrderNum > ORDER_MAX) {\n            const clampedNum = Math.min(ORDER_MAX, Math.max(ORDER_MIN, Math.trunc(rawOrderNum)));\n            finalOrder = clampedNum;\n\n            if (extension_settings.STMemoryBooks?.moduleSettings?.showNotifications !== false) {\n                toastr.info(\n                    i18n(\n                        'addlore.toast.orderClamped',\n                        'Order range is limited to 09999. Current {{source}} is {{requested}}; clamped to {{clamped}}.',\n                        { source: sourceLabel, requested: rawOrderNum, clamped: clampedNum }\n                    ),\n                    i18n('addlore.toast.title', 'STMemoryBooks')\n                );\n            }\n        }\n\n        entry.order = finalOrder;\n    }\n\n    // 4. Recursion Settings\n    entry.preventRecursion = lorebookSettings.preventRecursion;\n    entry.delayUntilRecursion = lorebookSettings.delayUntilRecursion;\n\n    // Set other properties to match the tested lorebook structure\n    entry.keysecondary = [];\n    entry.selective = true;\n    entry.selectiveLogic = 0;\n    entry.addMemo = true;\n    entry.disable = false;\n    entry.excludeRecursion = false;\n    entry.probability = 100;\n    entry.useProbability = true;\n    entry.depth = 4;\n    entry.group = \"\";\n    entry.groupOverride = false;\n    entry.groupWeight = 100;\n    entry.scanDepth = null;\n    entry.caseSensitive = null;\n    entry.matchWholeWords = null;\n    entry.useGroupScoring = null;\n    entry.automationId = \"\";\n    entry.role = null;\n    entry.sticky = 0;\n    entry.cooldown = 0;\n    entry.delay = 0;\n    entry.displayIndex = orderNumber; // Use order number for display index\n    entry.stmemorybooks = true; // Explicitly mark as STMemoryBooks memory entry\n    if (memoryResult.metadata?.sceneRange) { // Set metadata for scene range if available\n        const rangeParts = memoryResult.metadata.sceneRange.split('-');\n        if (rangeParts.length === 2) {\n            entry.STMB_start = parseInt(rangeParts[0], 10);\n            entry.STMB_end = parseInt(rangeParts[1], 10);\n        }\n    }\n    \n}\n\n/**\n * Determines if an entry is a memory entry using the STMemoryBooks flag system.\n * NO FALLBACK - Only entries with the explicit flag are considered memories.\n * This forces users to convert their lorebooks for proper memory detection.\n * \n * @param {Object} entry - The lorebook entry to check\n * @returns {boolean} Whether this entry is a confirmed STMemoryBooks memory\n */\nexport function isMemoryEntry(entry) {\n    // ONLY check for the explicit STMemoryBooks flag\n    // This forces conversion and ensures maximum reliability and performance\n    return entry.stmemorybooks === true;\n}\n\n/**\n * Generates a title for the lorebook entry using the configured format\n * @private\n * @param {string} titleFormat - The title format template\n * @param {Object} memoryResult - The memory generation result\n * @param {Object} lorebookData - The lorebook data for auto-numbering\n * @returns {string} The generated title\n */\nfunction generateEntryTitle(titleFormat, memoryResult, lorebookData) {\n    let title = titleFormat;\n\n    // Auto-numbering: [0], [00], [000], ([0]), ({0}), #[0], etc.\n    const allNumberingPatterns = [\n        { pattern: /\\[\\[0+\\]\\]/g, prefix: '[', suffix: ']' }, // [[000]] -> [001]\n        { pattern: /\\[0+\\]/g, prefix: '', suffix: '' },       // [000] -> just number\n        { pattern: /\\(\\[0+\\]\\)/g, prefix: '(', suffix: ')' }, // ([000]) -> (001)\n        { pattern: /\\{\\[0+\\]\\}/g, prefix: '{', suffix: '}' }, // {[000]} -> {001}\n        { pattern: /#\\[0+\\]/g, prefix: '#', suffix: '' }      // #[000] -> #001\n    ];\n\n    for (const { pattern, prefix, suffix } of allNumberingPatterns) {\n        const matches = title.match(pattern);\n        if (matches) {\n            const nextNumber = getNextEntryNumber(lorebookData, titleFormat);\n\n            matches.forEach(match => {\n                let digits;\n                if (pattern.source.includes('\\\\[\\\\[')) {\n                    digits = match.length - 4; // [[000]] -> remove [[ and ]]\n                } else if (pattern.source.includes('\\\\(\\\\[') || pattern.source.includes('\\\\{\\\\[')) {\n                    digits = match.length - 4; // ([000]) or {[000]} -> remove outer delimiters and [ ]\n                } else if (pattern.source.includes('#\\\\[')) {\n                    digits = match.length - 3; // #[000] -> remove # and [ ]\n                } else if (pattern.source.includes('\\\\[')) {\n                    digits = match.length - 2; // [000] -> remove [ and ]\n                } else {\n                    digits = match.length - 2; // fallback\n                }\n                const paddedNumber = nextNumber.toString().padStart(digits, '0');\n                const replacement = prefix + paddedNumber + suffix;\n                title = title.replace(match, replacement);\n            });\n            break; // Only process the first pattern type found\n        }\n    }\n    \n    // Template substitutions\n    const metadata = memoryResult.metadata || {};\n    const substitutions = {\n        '{{title}}': memoryResult.extractedTitle || i18n('addlore.defaults.title', 'Memory'),\n        '{{scene}}': i18n('addlore.defaults.scene', 'Scene {{range}}', { range: metadata.sceneRange || i18n('common.unknown', 'Unknown') }),\n        '{{char}}': metadata.characterName || i18n('common.unknown', 'Unknown'),\n        '{{user}}': metadata.userName || i18n('addlore.defaults.user', 'User'),\n        '{{messages}}': metadata.messageCount || 0,\n        '{{profile}}': metadata.profileUsed || i18n('common.unknown', 'Unknown'),\n        '{{date}}': moment().format('YYYY-MM-DD'),\n        '{{time}}': moment().format('HH:mm:ss')\n    };\n    \n    // Apply substitutions\n    Object.entries(substitutions).forEach(([placeholder, value]) => {\n        title = title.replace(new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g'), value);\n    });\n\n    title = sanitizeTitle(title);\n\n    return title;\n}\n\n/**\n * Gets the next available entry number for auto-numbering\n * @private\n * @param {Object} lorebookData - The lorebook data\n * @param {string} [titleFormat] - The title format template for format-aware extraction\n * @returns {number} The next available number\n */\nfunction getNextEntryNumber(lorebookData, titleFormat = null) {\n    if (!lorebookData.entries) {\n        return 1;\n    }\n\n    const entries = Object.values(lorebookData.entries);\n    const existingNumbers = [];\n\n    entries.forEach(entry => {\n        // Only check memory entries for numbering conflicts\n        if (isMemoryEntry(entry) && entry.comment) {\n            // Use format-aware extraction if available, otherwise fall back to original method\n            const number = titleFormat\n                ? extractNumberUsingFormat(entry.comment, titleFormat)\n                : extractNumberFromTitle(entry.comment);\n            if (number !== null) {\n                existingNumbers.push(number);\n            }\n        }\n    });\n\n    // If no numbers were found in any existing memories, start at 1.\n    if (existingNumbers.length === 0) {\n        return 1;\n    }\n\n    // find the highest existing number and add 1 to it.\n    const maxNumber = Math.max(...existingNumbers);\n    return maxNumber + 1;\n}\n\n/**\n * Extracts number from title using the title format as a guide.\n * This prevents extracting dates or other numbers that aren't the intended sequence number.\n *\n * @private\n * @param {string} title - The title to extract number from\n * @param {string} titleFormat - The title format template\n * @returns {number|null} The extracted number or null if not found\n */\nfunction extractNumberUsingFormat(title, titleFormat) {\n    if (!title || typeof title !== 'string' || !titleFormat || typeof titleFormat !== 'string') {\n        return null;\n    }\n\n    // Find all numbering patterns in the format\n    const allNumberingPatterns = [\n        /\\[0+\\]/g,   // [000]\n        /\\(0+\\)/g,   // (000)\n        /\\{0+\\}/g,   // {000}\n        /#0+/g       // #000\n    ];\n\n    let formatMatches = [];\n    let patternType = null;\n\n    // Find which pattern type is used and where\n    for (const pattern of allNumberingPatterns) {\n        const matches = [...titleFormat.matchAll(pattern)];\n        if (matches.length > 0) {\n            formatMatches = matches;\n            patternType = pattern;\n            break;\n        }\n    }\n\n    // If no numbering pattern found in format, fall back to original method\n    if (formatMatches.length === 0) {\n        return extractNumberFromTitle(title);\n    }\n\n    // Create a regex from the format that captures the number position\n    let regexPattern = escapeRegex(titleFormat);\n\n    // Replace template variables with non-greedy wildcards\n    regexPattern = regexPattern.replace(/\\\\\\{\\\\\\{[^}]+\\\\\\}\\\\\\}/g, '.*?');\n\n    // Replace numbering patterns with capture groups\n    if (patternType.source.includes('\\\\[')) {\n        regexPattern = regexPattern.replace(/\\\\\\[0+\\\\\\]/g, '(\\\\d+)');\n    } else if (patternType.source.includes('\\\\(')) {\n        regexPattern = regexPattern.replace(/\\\\\\(0+\\\\\\)/g, '(\\\\d+)');\n    } else if (patternType.source.includes('\\\\{')) {\n        regexPattern = regexPattern.replace(/\\\\\\{0+\\\\\\}/g, '(\\\\d+)');\n    } else if (patternType.source.includes('#')) {\n        regexPattern = regexPattern.replace(/#0+/g, '(\\\\d+)');\n    }\n\n    try {\n        const match = title.match(new RegExp(regexPattern));\n        if (match && match[1]) {\n            const number = parseInt(match[1], 10);\n            return isNaN(number) ? null : number;\n        }\n    } catch (error) {\n    }\n\n    // Fallback to original extraction method\n    return extractNumberFromTitle(title);\n}\n\n/**\n * Helper function to escape special regex characters\n * @private\n * @param {string} string - String to escape\n * @returns {string} Escaped string\n */\nfunction escapeRegex(string) {\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n}\n\n/**\n * Safely extracts number from title using comprehensive pattern matching.\n * Supports ALL numbering formats the extension can generate:\n * - [001], [01], [1] (square brackets)\n * - (001), (01), (1) (parentheses) \n * - {001}, {01}, {1} (curly braces)\n * - #01, #5, #7-8 (hash prefix with ranges)\n * - 001 - Title, 1 - Title (start of string)\n * - Numbers anywhere in title as fallback\n * \n * @private\n * @param {string} title - The title to extract number from\n * @returns {number|null} The extracted number or null if not found\n */\nfunction extractNumberFromTitle(title) {\n    if (!title || typeof title !== 'string') {\n        return null;\n    }\n    \n    // Pattern 1: Square brackets [001], [01], [1]\n    const bracketMatch = title.match(/\\[(\\d+)\\]/);\n    if (bracketMatch) {\n        const number = parseInt(bracketMatch[1], 10);\n        return isNaN(number) ? null : number;\n    }\n    \n    // Pattern 2: Parentheses (001), (01), (1)\n    const parenMatch = title.match(/\\((\\d+)\\)/);\n    if (parenMatch) {\n        const number = parseInt(parenMatch[1], 10);\n        return isNaN(number) ? null : number;\n    }\n    \n    // Pattern 3: Curly braces {001}, {01}, {1}\n    const braceMatch = title.match(/\\{(\\d+)\\}/);\n    if (braceMatch) {\n        const number = parseInt(braceMatch[1], 10);\n        return isNaN(number) ? null : number;\n    }\n    \n    // Pattern 4: Hash prefix #01, #5, #7-8 (extract LAST number from ranges for proper sequencing)\n    const hashMatch = title.match(/#(\\d+)(?:-(\\d+))?/);\n    if (hashMatch) {\n        // If it's a range like #7-8, use the second number (8)\n        // If it's single like #5, use the first number (5)\n        const firstNumber = parseInt(hashMatch[1], 10);\n        const secondNumber = hashMatch[2] ? parseInt(hashMatch[2], 10) : null;\n        \n        const number = secondNumber !== null ? secondNumber : firstNumber;\n        return isNaN(number) ? null : number;\n    }\n    \n    // Pattern 5: Numbers at start of string: \"001 - Title\", \"1 - Title\"\n    const startMatch = title.match(/^(\\d+)(?:\\s*[-\\s])/);\n    if (startMatch) {\n        const number = parseInt(startMatch[1], 10);\n        return isNaN(number) ? null : number;\n    }\n    \n    // Pattern 6: Fallback - any sequence of digits (prefer earlier occurrence, but skip dates)\n    const allNumbers = [...title.matchAll(/(\\d+)/g)];\n    for (const match of allNumbers) {\n        const number = parseInt(match[1], 10);\n        if (isNaN(number)) continue;\n\n        // Skip if this number appears to be part of a YYYY-MM-DD date format\n        const fullMatch = match[0];\n        const index = match.index;\n        const before = title.substring(Math.max(0, index - 10), index);\n        const after = title.substring(index + fullMatch.length, index + fullMatch.length + 10);\n\n        // Check for YYYY-MM-DD pattern (year, month, or day component)\n        const isDateComponent = /\\d{4}-\\d{2}-\\d{2}/.test(before + fullMatch + after) ||\n                               /\\d{4}-\\d{1,2}/.test(before + fullMatch) ||\n                               /-\\d{1,2}-\\d{1,2}/.test(fullMatch + after);\n\n        if (!isDateComponent) {\n            return number;\n        }\n    }\n    \n    return null;\n}\n\n/**\n * Identifies memory entries from lorebook using the flag system\n * @param {Object} lorebookData - The lorebook data\n * @returns {Array} Array of memory entries with extracted metadata\n */\nexport function identifyMemoryEntries(lorebookData) {\n    if (!lorebookData.entries) {\n        return [];\n    }\n    \n    const entries = Object.values(lorebookData.entries);\n    const memoryEntries = [];\n    \n    entries.forEach(entry => {\n        if (isMemoryEntry(entry)) {\n            const number = extractNumberFromTitle(entry.comment) || 0;\n            \n            memoryEntries.push({\n                number: number,\n                title: entry.comment,\n                content: entry.content,\n                keywords: entry.key || [],\n                entry: entry\n            });\n        }\n    });\n    \n    // Sort by number\n    memoryEntries.sort((a, b) => a.number - b.number);\n    \n    return memoryEntries;\n}\n\n/**\n * Sanitizes the title to only include allowed characters\n * @private\n * @param {string} title - The title to sanitize\n * @returns {string} The sanitized title\n */\nfunction sanitizeTitle(title) {\n    // Follow SillyTavern: allow all printable Unicode; strip control characters only.\n    // Control chars include C0/C1 ranges: U+0000U+001F and U+007FU+009F\n    const cleaned = String(title ?? '').replace(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '').trim();\n    return cleaned || i18n('addlore.sanitize.fallback', 'Auto Memory');\n}\n\n/**\n * Gets available title format options for the settings UI\n * @returns {Array<string>} Array of title format options\n */\nexport function getDefaultTitleFormats() {\n    return DEFAULT_TITLE_FORMATS.map((fmt, idx) => i18n(`addlore.titleFormats.${idx}`, fmt));\n}\n\n/**\n * Validates a custom title format\n * @param {string} format - The title format to validate\n * @returns {Object} Validation result\n */\nexport function validateTitleFormat(format) {\n    const errors = [];\n    const warnings = [];\n    \n    if (!format || typeof format !== 'string') {\n        errors.push(i18n('addlore.titleFormat.errors.nonEmpty', 'Title format must be a non-empty string'));\n        return { valid: false, errors, warnings };\n    }\n    \n    // Check for control characters (excluding template placeholders)\n    // We follow SillyTavern: only control characters are removed during sanitization\n    const withoutPlaceholders = format.replace(/\\{\\{[^}]+\\}\\}/g, '');\n    const controlCharsPattern = /[\\u0000-\\u001F\\u007F-\\u009F]/g;\n    \n    if (controlCharsPattern.test(withoutPlaceholders)) {\n        warnings.push(i18n('addlore.titleFormat.warnings.sanitization', 'Title contains characters that will be removed during sanitization'));\n    }\n    \n    // Check for valid placeholder syntax\n    const invalidPlaceholders = format.match(/\\{\\{[^}]*\\}\\}/g)?.filter(placeholder => {\n        const validPlaceholders = ['{{title}}', '{{scene}}', '{{char}}', '{{user}}', '{{messages}}', '{{profile}}', '{{date}}', '{{time}}'];\n        return !validPlaceholders.includes(placeholder);\n    });\n    \n    if (invalidPlaceholders && invalidPlaceholders.length > 0) {\n        warnings.push(i18n('addlore.titleFormat.warnings.unknownPlaceholders', 'Unknown placeholders: {{placeholders}}', { placeholders: invalidPlaceholders.join(', ') }));\n    }\n\n    // Check for valid numbering patterns (accept multiple token shapes, including wrapped forms)\n    const numberingPatterns = format.match(/[\\[\\({#][^0\\]\\)}]*[\\]\\)}]?/g);\n    if (numberingPatterns) {\n        const allowed = [\n            /^\\[0+\\]$/,          // [000]\n            /^\\(0+\\)$/,          // (000)\n            /^\\{0+\\}$/,          // {000}\n            /^#0+$/,             // #000\n            /^#\\[0+\\]$/,         // #[000]\n            /^\\(\\[0+\\]\\)$/,      // ([000])\n            /^\\{\\[0+\\]\\}$/       // {[000]}\n        ];\n        const invalidNumbering = numberingPatterns.filter(pat => !allowed.some(rx => rx.test(pat)));\n\n        if (invalidNumbering.length > 0) {\n            warnings.push(i18n('addlore.titleFormat.warnings.invalidNumbering', 'Invalid numbering patterns: {{patterns}}. Use [0], [00], [000], (0), {0}, #0, #[0], ([0]), {[0]} etc.', { patterns: invalidNumbering.join(', ') }));\n        }\n    }\n\n    if (format.length > 100) {\n        warnings.push(i18n('addlore.titleFormat.warnings.tooLong', 'Title format is very long and may be truncated'));\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors,\n        warnings\n    };\n}\n\n/**\n * Preview what a title would look like with sample data\n * @param {string} titleFormat - The title format to preview\n * @param {Object} sampleData - Sample memory metadata for preview\n * @returns {string} Preview of the generated title\n */\nexport function previewTitle(titleFormat, sampleData = {}) {\n    const defaultSampleData = {\n        extractedTitle: i18n('addlore.preview.sampleTitle', 'Sample Memory Title'),\n        metadata: {\n            sceneRange: '15-23',\n            characterName: 'Alice',\n            userName: 'Bob',\n            messageCount: 9,\n            profileUsed: i18n('addlore.preview.sampleProfile', 'Summary')\n        }\n    };\n    \n    const mockLorebookData = {\n        entries: {\n            'existing1': { uid: 5, comment: '[001] - Previous Memory', stmemorybooks: true },\n            'existing2': { uid: 7, comment: '[002] - Another Memory', stmemorybooks: true }\n        }\n    };\n    \n    const mergedData = { ...defaultSampleData, ...sampleData };\n    \n    try {\n        return generateEntryTitle(titleFormat, mergedData, mockLorebookData);\n    } catch (error) {\n        return i18n('addlore.preview.error', 'Error: {{message}}', { message: error.message });\n    }\n}\n\nexport function getRangeFromMemoryEntry(entry) {\n    if (typeof entry.STMB_start === 'number' && typeof entry.STMB_end === 'number') {\n        return { start: entry.STMB_start, end: entry.STMB_end };\n    }\n    return null;\n}\n\n/**\n * Get statistics about lorebook entries for the current chat\n * @returns {Promise<Object>} Statistics about lorebook usage\n */\nexport async function getLorebookStats() {\n    try {\n        const context = await getContext();\n        const lorebookName = context.chatMetadata[METADATA_KEY];\n        \n        if (!lorebookName) {\n            return { valid: false, error: i18n('addlore.stats.errors.noBinding', 'No lorebook bound to chat') };\n        }\n        \n        const lorebookData = await loadWorldInfo(lorebookName);\n        if (!lorebookData) {\n            return { valid: false, error: i18n('addlore.stats.errors.loadFailed', 'Failed to load lorebook') };\n        }\n        \n        const entries = Object.values(lorebookData.entries || {});\n        \n        // Use flag-based detection to identify memory entries\n        const memoryEntries = identifyMemoryEntries(lorebookData);\n        const otherEntries = entries.filter(entry => \n            !memoryEntries.some(memEntry => memEntry.entry === entry)\n        );\n        \n        return {\n            valid: true,\n            lorebookName,\n            totalEntries: entries.length,\n            memoryEntries: memoryEntries.length,\n            otherEntries: otherEntries.length,\n            averageContentLength: entries.length > 0 ? \n                Math.round(entries.reduce((sum, entry) => sum + (entry.content?.length || 0), 0) / entries.length) : 0,\n            totalKeywords: entries.reduce((sum, entry) => sum + (entry.key?.length || 0), 0),\n            memoryKeywords: memoryEntries.reduce((sum, entry) => sum + (entry.keywords?.length || 0), 0)\n        };\n        \n    } catch (error) {\n        console.error(i18n('addlore.log.getStatsError', `${MODULE_NAME}: Error getting lorebook stats:`), error);\n        return { valid: false, error: error.message };\n    }\n}\n\n/**\n * Update the highest memory processed tracking for the current chat\n * @param {Object} memoryResult - The memory result containing metadata\n */\nfunction updateHighestMemoryProcessed(memoryResult) {\n    try {\n        console.log(i18n('addlore.log.updateHighestCalled', `${MODULE_NAME}: updateHighestMemoryProcessed called with:`), memoryResult);\n\n        // Extract the end message number from the scene range\n        const sceneRange = memoryResult.metadata?.sceneRange;\n        console.log(i18n('addlore.log.sceneRangeExtracted', `${MODULE_NAME}: sceneRange extracted:`), sceneRange);\n\n        if (!sceneRange) {\n            console.warn(i18n('addlore.warn.noSceneRange', `${MODULE_NAME}: No scene range found in memory result, cannot update highest processed`));\n            return;\n        }\n\n        const rangeParts = sceneRange.split('-');\n        if (rangeParts.length !== 2) {\n            console.warn(i18n('addlore.warn.invalidSceneRangeFormat', `${MODULE_NAME}: Invalid scene range format: {{range}}`, { range: sceneRange }));\n            return;\n        }\n\n        const endMessage = parseInt(rangeParts[1], 10);\n        if (isNaN(endMessage)) {\n            console.warn(i18n('addlore.warn.invalidEndMessage', `${MODULE_NAME}: Invalid end message number: {{end}}`, { end: rangeParts[1] }));\n            return;\n        }\n\n        // Get current scene markers (which handles both single and group chats)\n        const sceneMarkers = getSceneMarkers();\n        if (!sceneMarkers) {\n            console.warn(i18n('addlore.warn.noSceneMarkers', `${MODULE_NAME}: Could not get scene markers to update highest processed`));\n            return;\n        }\n\n        // Always update highestMemoryProcessed to the end of the memory we just created\n        sceneMarkers.highestMemoryProcessed = endMessage;\n        delete sceneMarkers.highestMemoryProcessedManuallySet;\n\n        // Save the metadata (works for both group chats and single-character chats)\n        saveMetadataForCurrentContext();\n\n        console.log(i18n('addlore.log.setHighest', `${MODULE_NAME}: Set highest memory processed to message {{endMessage}}`, { endMessage }));\n\n    } catch (error) {\n        console.error(i18n('addlore.log.updateHighestError', `${MODULE_NAME}: Error updating highest memory processed:`), error);\n    }\n}\n\n/**\n * Get a lorebook entry by its comment/title (exact match).\n * @param {Object} lorebookData\n * @param {string} title\n * @returns {Object|null}\n */\nexport function getEntryByTitle(lorebookData, title) {\n    if (!lorebookData || !lorebookData.entries || !title) return null;\n    const entries = Object.values(lorebookData.entries);\n    for (const entry of entries) {\n        if ((entry.comment || '') === title) {\n            return entry;\n        }\n    }\n    return null;\n}\n\n/**\n * Batch upsert lorebook entries with a single save (and optional single reload).\n * Each item is staged into the provided lorebookData in-memory object; then\n * saveWorldInfo is called exactly once for the whole batch.\n *\n * @param {string} lorebookName\n * @param {Object} lorebookData\n * @param {Array<{title: string, content: string, defaults?: Object, metadataUpdates?: Object, entryOverrides?: Object}>} items\n * @param {Object} [options]\n * @param {boolean} [options.refreshEditor=true]\n * @returns {Promise<Array<{title:string, uid:number, created:boolean}>>}\n */\nexport async function upsertLorebookEntriesBatch(lorebookName, lorebookData, items, options = {}) {\n    const {\n        refreshEditor = true,\n    } = options;\n\n    if (!lorebookName || !lorebookData || !Array.isArray(items)) {\n        throw new Error(i18n('addlore.upsert.errors.invalidArgs', 'Invalid arguments to upsertLorebookEntriesBatch'));\n    }\n\n    const results = [];\n\n    for (const it of items) {\n        if (!it || !it.title) continue;\n\n        const title = String(it.title);\n        const content = it.content != null ? String(it.content) : '';\n        const defaults = it.defaults || {};\n        const metadataUpdates = it.metadataUpdates || {};\n        const entryOverrides = it.entryOverrides || {};\n\n        let entry = getEntryByTitle(lorebookData, title);\n        let created = false;\n\n        if (!entry) {\n            entry = createWorldInfoEntry(lorebookName, lorebookData);\n            if (!entry) {\n                throw new Error(i18n('addlore.upsert.errors.createFailed', 'Failed to create lorebook entry'));\n            }\n\n            // Apply defaults for new entry\n            entry.vectorized = !!defaults.vectorized;\n            entry.selective = !!defaults.selective;\n            if (typeof defaults.order === 'number') entry.order = defaults.order;\n            if (typeof defaults.position === 'number') entry.position = defaults.position;\n            entry.disable = false;\n            created = true;\n        }\n\n        // Normalize expected fields for both new and existing entries\n        entry.key = Array.isArray(entry.key) ? entry.key : [];\n        entry.keysecondary = Array.isArray(entry.keysecondary) ? entry.keysecondary : [];\n        if (typeof entry.disable !== 'boolean') entry.disable = false;\n\n        // Update core fields\n        entry.comment = title;\n        entry.content = content;\n\n        // Apply metadata updates\n        for (const [k, v] of Object.entries(metadataUpdates)) {\n            entry[k] = v;\n        }\n\n        // Apply entry overrides (both on create and update)\n        for (const [k, v] of Object.entries(entryOverrides)) {\n            entry[k] = v;\n        }\n\n        results.push({ title, uid: entry.uid, created });\n    }\n\n    // Single save for the whole batch\n    await saveWorldInfo(lorebookName, lorebookData, true);\n\n    if (refreshEditor) {\n        reloadEditor(lorebookName);\n    }\n\n    return results;\n}\n\n/**\n * Upsert a lorebook entry by title. If exists, update content and optional metadata;\n * otherwise create a new entry using provided defaults.\n * This does NOT mark entries as STMemoryBooks memories.\n *\n * @param {string} lorebookName\n * @param {Object} lorebookData\n * @param {string} title\n * @param {string} content\n * @param {Object} options\n * @param {Object} [options.defaults]  Defaults for new entries (vectorized, selective, order, position, etc.)\n * @param {Object} [options.metadataUpdates]  Key/value pairs to set on entry (e.g., STMB_tracker_lastMsgId)\n * @param {Object} [options.entryOverrides]  Fields to set/update on the entry for both create and update (e.g., constant, vectorized, preventRecursion, delayUntilRecursion, order)\n * @param {boolean} [options.refreshEditor=true]\n * @returns {Promise<{uid:number, created:boolean}>}\n */\nexport async function upsertLorebookEntryByTitle(lorebookName, lorebookData, title, content, options = {}) {\n    const {\n        defaults = {\n            vectorized: true,\n            selective: true,\n            order: 100,\n            position: 0,\n        },\n        metadataUpdates = {},\n        refreshEditor = true,\n        entryOverrides = {},\n    } = options;\n\n    if (!lorebookName || !lorebookData || !title) {\n        throw new Error(i18n('addlore.upsert.errors.invalidArgs', 'Invalid arguments to upsertLorebookEntryByTitle'));\n    }\n\n    let entry = getEntryByTitle(lorebookData, title);\n    let created = false;\n\n    if (!entry) {\n        entry = createWorldInfoEntry(lorebookName, lorebookData);\n        if (!entry) {\n                throw new Error(i18n('addlore.upsert.errors.createFailed', 'Failed to create lorebook entry'));\n        }\n        // Apply defaults for new entry\n        entry.vectorized = !!defaults.vectorized;\n        entry.selective = !!defaults.selective;\n        if (typeof defaults.order === 'number') entry.order = defaults.order;\n        if (typeof defaults.position === 'number') entry.position = defaults.position;\n\n        entry.key = entry.key || [];\n        entry.keysecondary = entry.keysecondary || [];\n        entry.disable = false;\n\n        created = true;\n    }\n\n    // Update core fields\n    entry.comment = title;\n    entry.content = content != null ? String(content) : '';\n\n    // Apply metadata updates\n    for (const [k, v] of Object.entries(metadataUpdates || {})) {\n        entry[k] = v;\n    }\n\n    // Apply entry overrides (both on create and update)\n    for (const [k, v] of Object.entries(entryOverrides || {})) {\n        entry[k] = v;\n    }\n\n    await saveWorldInfo(lorebookName, lorebookData, true);\n    if (refreshEditor) {\n        reloadEditor(lorebookName);\n    }\n\n    return { uid: entry.uid, created };\n}\n",
    "import { getCurrentChatId, name1, name2, chat_metadata, saveMetadata } from '../../../../script.js';\nimport { createNewWorldInfo, METADATA_KEY, world_names } from '../../../world-info.js';\nimport { translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-AutoCreate';\n\n/**\n * i18n helper: translate with Mustache-style {{var}} interpolation\n * Mirrors the local 'tr' used in index.js to keep calls like i18n('key','fallback',{...})\n * compatible with SillyTavern's translate(fallback, key).\n */\nfunction i18n(key, fallback, params) {\n    const localized = translate(fallback, key);\n    if (!params) return localized;\n    return localized.replace(/{{\\s*(\\w+)\\s*}}/g, (m, p1) => {\n        const v = params[p1];\n        return v !== undefined && v !== null ? String(v) : '';\n    });\n}\n\n/**\n * Generate lorebook name from template with auto-numbering\n * @param {string} template - Template string with {{chat}}, {{char}}, {{user}} placeholders\n * @returns {string} Generated lorebook name with auto-numbering if needed\n */\nexport function generateLorebookName(template) {\n    // Validate template - fallback to default if empty\n    if (!template || template.trim() === '') {\n        template = i18n('STMemoryBooks_LorebookNameTemplatePlaceholder', 'LTM - {{char}} - {{chat}}');\n    }\n\n    // Template substitutions\n    const chatId = getCurrentChatId() || i18n('common.unknown', 'Unknown');\n    const charName = name2 || i18n('common.unknown', 'Unknown');\n    const userName = name1 || i18n('addlore.defaults.user', 'User');\n\n    let name = template\n        .replace(/\\{\\{chat\\}\\}/g, chatId)\n        .replace(/\\{\\{char\\}\\}/g, charName)\n        .replace(/\\{\\{user\\}\\}/g, userName);\n\n    // Sanitize for filesystem - only block reserved characters, allow Unicode\n    // Reserve 4 chars for potential \" 999\" suffix\n    name = name.replace(/[\\/\\\\:*?\"<>|]/g, '_').replace(/_{2,}/g, '_').substring(0, 60);\n\n    // Auto-numbering if name exists (with null safety)\n    if (!world_names || !world_names.includes(name)) return name;\n\n    for (let i = 2; i <= 999; i++) {\n        const numberedName = `${name} ${i}`;\n        if (!world_names.includes(numberedName)) return numberedName;\n    }\n\n    return `${name} ${Date.now()}`; // Fallback with timestamp\n}\n\n/**\n * Auto-create and bind a lorebook using the configured template\n * @param {string} template - Name template to use\n * @param {string} context - Context description for logging (e.g., 'chat', 'auto-summary')\n * @returns {Promise<{success: boolean, name?: string, error?: string}>}\n */\nexport async function autoCreateLorebook(template, context = 'chat') {\n    try {\n        const newLorebookName = generateLorebookName(template);\n\n        console.log(i18n('autocreate.log.creating', `${MODULE_NAME}: Auto-creating lorebook \"{{name}}\" for {{context}}`, { name: newLorebookName, context }));\n        const created = await createNewWorldInfo(newLorebookName);\n\n        if (created) {\n            // Bind the new lorebook to the chat\n            chat_metadata[METADATA_KEY] = newLorebookName;\n            await saveMetadata();\n\n            console.log(i18n('autocreate.log.created', `${MODULE_NAME}: Successfully created and bound lorebook \"{{name}}\"`, { name: newLorebookName }));\n            toastr.success(i18n('autocreate.toast.createdBound', 'Created and bound lorebook \"{{name}}\"', { name: newLorebookName }), i18n('autocreate.toast.title', 'STMemoryBooks'));\n\n            return { success: true, name: newLorebookName };\n        } else {\n            console.error(i18n('autocreate.log.createFailed', `${MODULE_NAME}: Failed to create lorebook`));\n            return { success: false, error: i18n('autocreate.errors.failedAutoCreate', 'Failed to auto-create lorebook.') };\n        }\n    } catch (error) {\n        console.error(i18n('autocreate.log.createError', `${MODULE_NAME}: Error creating lorebook:`), error);\n        return { success: false, error: i18n('autocreate.errors.failedAutoCreateWithMessage', 'Failed to auto-create lorebook: {{message}}', { message: error.message }) };\n    }\n}\n",
    "import { extension_settings } from '../../../extensions.js';\nimport { chat, chat_metadata } from '../../../../script.js';\nimport { METADATA_KEY, world_names } from '../../../world-info.js';\nimport { getSceneMarkers, saveMetadataForCurrentContext, clearScene } from './sceneManager.js';\nimport { getCurrentMemoryBooksContext, showLorebookSelectionPopup, clampInt } from './utils.js';\nimport { autoCreateLorebook } from './autocreate.js';\nimport { Popup, POPUP_TYPE, POPUP_RESULT } from '../../../popup.js';\nimport { isMemoryProcessing } from './index.js';\nimport { translate } from '../../../i18n.js';\n\n/**\n * i18n helper: translate with Mustache-style {{var}} interpolation\n * Use like i18n('KEY', 'Fallback {{var}}', { var: 'value' })\n * Internally calls SillyTavern's translate(fallback, key).\n */\nfunction i18n(key, fallback, params) {\n    const localized = translate(fallback, key);\n    if (!params) return localized;\n    return localized.replace(/{{\\s*(\\w+)\\s*}}/g, (m, p1) => {\n        const v = params[p1];\n        return v !== undefined && v !== null ? String(v) : '';\n    });\n}\n\n/**\n * Validates lorebook for auto-summary with user-friendly prompts\n */\nasync function validateLorebookForAutoSummary() {\n    // First, try to get a lorebook without showing popups\n    const settings = extension_settings.STMemoryBooks;\n    let lorebookName;\n\n    if (!settings.moduleSettings.manualModeEnabled) {\n        // Automatic mode - use chat-bound lorebook\n        lorebookName = chat_metadata?.[METADATA_KEY] || null;\n\n        // Check if auto-create is enabled and no lorebook exists\n        if (!lorebookName && settings?.moduleSettings?.autoCreateLorebook) {\n            // Auto-create lorebook using template\n            const template = settings.moduleSettings.lorebookNameTemplate || i18n('STMemoryBooks_LorebookNameTemplatePlaceholder', 'LTM - {{char}} - {{chat}}');\n            const result = await autoCreateLorebook(template, 'auto-summary');\n\n            if (result.success) {\n                lorebookName = result.name;\n            } else {\n                return { valid: false, error: result.error };\n            }\n        }\n    } else {\n        // Manual mode - check if a lorebook is already selected\n        const stmbData = getSceneMarkers() || {};\n        lorebookName = stmbData.manualLorebook ?? null;\n\n        // If no lorebook is selected, ask user what to do\n        if (!lorebookName) {\n            const popupContent = `\n                <h4 data-i18n=\"STMemoryBooks_AutoSummaryReadyTitle\">Auto-Summary Ready</h4>\n                <div class=\"world_entry_form_control\">\n                    <p data-i18n=\"STMemoryBooks_AutoSummaryNoAssignedLorebook\">Auto-summary is enabled but there is no assigned lorebook for this chat.</p>\n                    <p data-i18n=\"STMemoryBooks_AutoSummarySelectOrPostponeQuestion\">Would you like to select a lorebook for memory storage, or postpone this auto-summary?</p>\n                    <label for=\"stmb-postpone-messages\" data-i18n=\"STMemoryBooks_PostponeLabel\">Postpone for how many messages?</label>\n                    <select id=\"stmb-postpone-messages\" class=\"text_pole\">\n                        <option value=\"10\" data-i18n=\"STMemoryBooks_Postpone10\">10 messages</option>\n                        <option value=\"20\" data-i18n=\"STMemoryBooks_Postpone20\">20 messages</option>\n                        <option value=\"30\" data-i18n=\"STMemoryBooks_Postpone30\">30 messages</option>\n                        <option value=\"40\" data-i18n=\"STMemoryBooks_Postpone40\">40 messages</option>\n                        <option value=\"50\" data-i18n=\"STMemoryBooks_Postpone50\">50 messages</option>\n                    </select>\n                </div>\n            `;\n\n            const popup = new Popup(popupContent, POPUP_TYPE.TEXT, '', {\n                okButton: i18n('STMemoryBooks_Button_SelectLorebook', 'Select Lorebook'),\n                cancelButton: i18n('STMemoryBooks_Button_Postpone', 'Postpone')\n            });\n            const result = await popup.show();\n\n            if (result === POPUP_RESULT.AFFIRMATIVE) {\n                // User wants to select a lorebook\n                const selectedLorebook = await showLorebookSelectionPopup();\n                if (selectedLorebook) {\n                    stmbData.manualLorebook = selectedLorebook;\n                    saveMetadataForCurrentContext();\n                    lorebookName = selectedLorebook;\n                } else {\n                    return { valid: false, error: i18n('STMemoryBooks_Error_NoLorebookSelectedForAutoSummary', 'No lorebook selected for auto-summary.') };\n                }\n            } else {\n                // User wants to postpone\n                const postponeSelect = popup.dlg.querySelector('#stmb-postpone-messages');\n                const parsed = parseInt(postponeSelect.value, 10);\n                const postponeMessages = Number.isFinite(parsed) ? parsed : 10;\n\n                const currentMessageCount = chat.length;\n\n                // Set postpone flag\n                stmbData.autoSummaryNextPromptAt = currentMessageCount + postponeMessages;\n                saveMetadataForCurrentContext();\n\n                console.log(i18n('autosummary.log.postponed', 'STMemoryBooks: Auto-summary postponed for {{count}} messages (until message {{until}})', { count: postponeMessages, until: stmbData.autoSummaryNextPromptAt }));\n                return { valid: false, error: i18n('STMemoryBooks_Info_AutoSummaryPostponed', 'Auto-summary postponed for {{count}} messages.', { count: postponeMessages }) };\n            }\n        }\n    }\n\n    // At this point we should have a lorebook name - validate it\n    if (!lorebookName) {\n        return { valid: false, error: i18n('STMemoryBooks_Error_NoLorebookForAutoSummary', 'No lorebook available for auto-summary.') };\n    }\n\n    if (!world_names || !world_names.includes(lorebookName)) {\n        return { valid: false, error: i18n('STMemoryBooks_Error_SelectedLorebookNotFound', 'Selected lorebook \"{{name}}\" not found.', { name: lorebookName }) };\n    }\n\n    try {\n        const { loadWorldInfo } = await import('../../../world-info.js');\n        const lorebookData = await loadWorldInfo(lorebookName);\n        return { valid: !!lorebookData, data: lorebookData, name: lorebookName };\n    } catch (error) {\n        return { valid: false, error: i18n('STMemoryBooks_Error_FailedToLoadSelectedLorebook', 'Failed to load the selected lorebook.') };\n    }\n}\n\n/**\n * Check if auto-summary should trigger based on current message count and settings\n * @returns {Promise<void>}\n */\nasync function checkAutoSummaryTrigger() {\n    try {\n        const settings = extension_settings.STMemoryBooks;\n        if (!settings?.moduleSettings?.autoSummaryEnabled) {\n            return;\n        }\n\n        const stmbData = getSceneMarkers() || {};\n        const currentMessageCount = chat.length;\n        const currentLastMessage = currentMessageCount - 1;\n        const requiredInterval = settings.moduleSettings.autoSummaryInterval;\n        const rawBuf = settings?.moduleSettings?.autoSummaryBuffer;\n        const buffer = clampInt(parseInt(rawBuf) || 0, 0, 50);\n        const requiredTotal = requiredInterval + buffer;\n        const rawHighestProcessed = stmbData.highestMemoryProcessed;\n        const hasHighestProcessed =\n            typeof rawHighestProcessed === 'number' && Number.isFinite(rawHighestProcessed);\n        // Treat \"no baseline\" as -1 (none processed yet) so the next range starts at 0.\n        const highestProcessed = hasHighestProcessed ? rawHighestProcessed : -1;\n\n        // Check if memory creation is in progress\n        if (isMemoryProcessing()) {\n            console.log(i18n('autosummary.log.skippedInProgress', 'STMemoryBooks: Auto-summary skipped - memory creation in progress'));\n            return;\n        }\n\n        // Calculate messages since last memory\n        let messagesSinceLastMemory;\n        // Count messages since the last processed memory. With highestProcessed = -1, this becomes currentMessageCount.\n        messagesSinceLastMemory = currentLastMessage - highestProcessed;\n        if (!hasHighestProcessed) {\n            console.log(i18n('autosummary.log.noPrevious', 'STMemoryBooks: No previous memories found - counting from start'));\n        } else {\n            console.log(i18n('autosummary.log.sinceLast', 'STMemoryBooks: Messages since last memory ({{highestProcessed}}): {{count}}', { highestProcessed, count: messagesSinceLastMemory }));\n        }\n\n        console.log(i18n('autosummary.log.triggerCheck', 'STMemoryBooks: Auto-summary trigger check: {{count}} >= {{required}}?', { count: messagesSinceLastMemory, required: requiredTotal }));\n\n        if (messagesSinceLastMemory < requiredTotal) {\n            console.log(i18n('autosummary.log.notTriggered', 'STMemoryBooks: Auto-summary not triggered - need {{needed}} more messages', { needed: requiredTotal - messagesSinceLastMemory }));\n            return;\n        }\n\n        // Check if user has postponed auto-summary\n        if (stmbData.autoSummaryNextPromptAt && currentMessageCount < stmbData.autoSummaryNextPromptAt) {\n            console.log(i18n('autosummary.log.postponedUntil', 'STMemoryBooks: Auto-summary postponed until message {{until}}', { until: stmbData.autoSummaryNextPromptAt }));\n            return; // Still in postpone period\n        }\n\n        // Auto-summary will set new scene markers - no need to clear existing ones\n        const lorebookValidation = await validateLorebookForAutoSummary();\n        if (!lorebookValidation.valid) {\n            console.log(i18n('autosummary.log.blocked', 'STMemoryBooks: Auto-summary blocked - lorebook validation failed: {{error}}', { error: lorebookValidation.error }));\n            return; // No lorebook available or user cancelled\n        }\n\n        // Clear any postpone flag since we're proceeding with auto-summary\n        if (stmbData.autoSummaryNextPromptAt) {\n            delete stmbData.autoSummaryNextPromptAt;\n            saveMetadataForCurrentContext();\n            console.log(i18n('autosummary.log.clearedPostpone', 'STMemoryBooks: Cleared auto-summary postpone flag'));\n        }\n\n        // Calculate the scene range for auto-summary (apply buffer to end)\n        let sceneStart, sceneEnd;\n        const sceneEndCandidate = currentLastMessage - buffer;\n        const safeEnd = Math.max(0, sceneEndCandidate);\n        // Start from the message after the last processed memory (or 0 if none processed yet).\n        sceneStart = highestProcessed + 1;\n        sceneEnd = safeEnd;\n        // Defensive: ensure valid range\n        if (sceneStart > sceneEnd) {\n            return;\n        }\n\n        console.log(i18n('autosummary.log.triggered', 'STMemoryBooks: Auto-summary triggered - creating memory for range {{start}}-{{end}}', { start: sceneStart, end: sceneEnd }));\n\n        // Set scene markers for the range we want to process\n        stmbData.sceneStart = sceneStart;\n        stmbData.sceneEnd = sceneEnd;\n        saveMetadataForCurrentContext();\n\n        // Use the existing memory creation system via slash command\n        const { executeSlashCommands } = await import('../../../slash-commands.js');\n        await executeSlashCommands('/creatememory');\n    } catch (error) {\n        console.error(i18n('autosummary.log.triggerError', 'STMemoryBooks: Error in auto-summary trigger check:'), error);\n    }\n}\n\n/**\n * Handle auto-summary for single character chats on message received\n * @returns {Promise<void>}\n */\nexport async function handleAutoSummaryMessageReceived() {\n    try {\n        const context = getCurrentMemoryBooksContext();\n\n        // Only check auto-summary for single character chats on MESSAGE_RECEIVED\n        // Group chats will be handled by GROUP_WRAPPER_FINISHED event\n        if (!context.isGroupChat && extension_settings.STMemoryBooks.moduleSettings.autoSummaryEnabled) {\n            const currentMessageCount = chat.length;\n            console.log(i18n('autosummary.log.messageReceivedSingle', 'STMemoryBooks: Message received (single chat) - auto-summary enabled, current count: {{count}}', { count: currentMessageCount }));\n\n            await checkAutoSummaryTrigger();\n        } else if (context.isGroupChat) {\n            console.log(i18n('autosummary.log.messageReceivedGroup', 'STMemoryBooks: Message received in group chat - deferring to GROUP_WRAPPER_FINISHED'));\n        }\n    } catch (error) {\n        console.error(i18n('autosummary.log.messageHandlerError', 'STMemoryBooks: Error in auto-summary message received handler:'), error);\n    }\n}\n\n/**\n * Handle auto-summary for group chats when all members have finished speaking\n * @returns {Promise<void>}\n */\nexport async function handleAutoSummaryGroupFinished() {\n    try {\n        if (extension_settings.STMemoryBooks.moduleSettings.autoSummaryEnabled) {\n            const currentMessageCount = chat.length;\n            console.log(i18n('autosummary.log.groupFinished', 'STMemoryBooks: Group conversation finished - auto-summary enabled, current count: {{count}}', { count: currentMessageCount }));\n\n            // Check auto-summary trigger after all group members have finished speaking\n            await checkAutoSummaryTrigger();\n        }\n    } catch (error) {\n        console.error(i18n('autosummary.log.groupHandlerError', 'STMemoryBooks: Error in auto-summary group finished handler:'), error);\n    }\n}\n\n/**\n * Clear auto-summary state after successful memory creation\n * @returns {void}\n */\nexport function clearAutoSummaryState() {\n    if (extension_settings.STMemoryBooks?.moduleSettings?.autoSummaryEnabled) {\n        // Clear scene markers; baseline is updated upon successful memory creation\n        clearScene();\n    }\n}\n",
    "import { saveSettingsDebounced } from '../../../../script.js';\nimport { Popup, POPUP_TYPE, POPUP_RESULT } from '../../../popup.js';\nimport { moment, Handlebars, DOMPurify } from '../../../../lib.js';\nimport {\n    validateProfile,\n    generateSafeProfileName,\n    getCurrentApiInfo,\n    createProfileObject,\n    clampInt,\n    readIntInput\n} from './utils.js';\nimport { getDefaultTitleFormats } from './addlore.js';\nimport * as SummaryPromptManager from './summaryPromptManager.js';\nimport { t as __st_t_tag, translate } from '../../../i18n.js';\n\nconst MODULE_NAME = 'STMemoryBooks-ProfileManager';\nconst BUILTIN_CURRENT_ST_NAME = 'Current SillyTavern Settings';\nconst DEFAULT_REVERSE_START = 9999;\n\n/**\n * Profile edit template\n */\nconst profileEditTemplate = Handlebars.compile(`\n<div class=\"popup-content\">\n    <div class=\"world_entry_form_control marginTop5\">\n        <label for=\"stmb-profile-name\">\n            <h4 data-i18n=\"STMemoryBooks_ProfileName\">Profile Name:</h4>\n            <input type=\"text\" id=\"stmb-profile-name\" value=\"{{name}}\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_ProfileNamePlaceholder\" placeholder=\"Profile name\" {{#if isNameLocked}}disabled title=\"Name locked for this profile\"{{/if}}>\n        </label>\n    </div>\n\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <h4 data-i18n=\"STMemoryBooks_ModelAndTempSettings\">Model & Temperature Settings:</h4>\n        <div class=\"info-block hint marginBot10\" data-i18n=\"STMemoryBooks_ModelHint\">\n            For model, copy-paste the exact model ID, eg. <code>gemini-2.5-pro</code>, <code>deepseek/deepseek-r1-0528:free</code>, <code>gpt-4o-mini-2024-07-18</code>, etc.\n        </div>\n\n        <label for=\"stmb-profile-api\">\n            <h4 data-i18n=\"STMemoryBooks_APIProvider\">API/Provider:</h4>\n            <select id=\"stmb-profile-api\" class=\"text_pole\" {{#if isProviderLocked}}disabled title=\"Provider locked for this profile\"{{/if}}>\n                <option value=\"current_st\" {{#if (eq connection.api \"current_st\")}}selected{{/if}} data-i18n=\"STMemoryBooks_CurrentSTSettings\">Current SillyTavern Settings</option>\n\n                <option value=\"ai21\" {{#if (eq connection.api \"ai21\")}}selected{{/if}}>AI21</option>\n                <option value=\"aimlapi\" {{#if (eq connection.api \"aimlapi\")}}selected{{/if}}>AI/ML API</option>\n                <option value=\"claude\" {{#if (eq connection.api \"claude\")}}selected{{/if}}>Anthropic/Claude</option>\n                <option value=\"azure_openai\" {{#if (eq connection.api \"azure_openai\")}}selected{{/if}}>Azure OpenAI</option>\n                <option value=\"cohere\" {{#if (eq connection.api \"cohere\")}}selected{{/if}}>Cohere</option>\n                <option value=\"cometapi\" {{#if (eq connection.api \"cometapi\")}}selected{{/if}}>Comet API</option>\n                <option value=\"deepseek\" {{#if (eq connection.api \"deepseek\")}}selected{{/if}}>DeepSeek</option>\n                <option value=\"electronhub\" {{#if (eq connection.api \"electronhub\")}}selected{{/if}}>Electron Hub</option>\n                <option value=\"fireworks\" {{#if (eq connection.api \"fireworks\")}}selected{{/if}}>Fireworks</option>\n                <option value=\"makersuite\" {{#if (eq connection.api \"makersuite\")}}selected{{/if}}>Google AI Studio</option>\n                <option value=\"groq\" {{#if (eq connection.api \"groq\")}}selected{{/if}}>Groq</option>\n                <option value=\"mistralai\" {{#if (eq connection.api \"mistralai\")}}selected{{/if}}>MistralAI</option>\n                <option value=\"moonshot\" {{#if (eq connection.api \"moonshot\")}}selected{{/if}}>Moonshot</option>\n                <option value=\"nanogpt\" {{#if (eq connection.api \"nanogpt\")}}selected{{/if}}>NanoGPT</option>\n                <option value=\"openai\" {{#if (eq connection.api \"openai\")}}selected{{/if}}>OpenAI</option>\n                <option value=\"openrouter\" {{#if (eq connection.api \"openrouter\")}}selected{{/if}}>OpenRouter</option>\n                <option value=\"perplexity\" {{#if (eq connection.api \"perplexity\")}}selected{{/if}}>Perplexity</option>\n                <option value=\"pollinations\" {{#if (eq connection.api \"pollinations\")}}selected{{/if}}>Pollinations</option>\n                <option value=\"siliconflow\" {{#if (eq connection.api \"siliconflow\")}}selected{{/if}}>SiliconFlow</option>\n                <option value=\"vertexai\" {{#if (eq connection.api \"vertexai\")}}selected{{/if}}>Vertex AI</option>\n                <option value=\"xai\" {{#if (eq connection.api \"xai\")}}selected{{/if}}>xAI</option>\n                <option value=\"zai\" {{#if (eq connection.api \"zai\")}}selected{{/if}}>Z.AI</option>\n\n                <option value=\"custom\" {{#if (eq connection.api \"custom\")}}selected{{/if}} data-i18n=\"STMemoryBooks_CustomAPI\">Custom OpenAI-Compatible API</option>\n                <option value=\"full-manual\" {{#if (eq connection.api \"full-manual\")}}selected{{/if}}>Full Manual Configuration</option>\n            </select>\n        </label>\n\n        <div class=\"info-block hint marginBot10\">\n            <small data-i18n=\"STMemoryBooks_APIProfileConfigHint\"> Profile Setup Hint: STMB automatically reads API info and keys from your ST config. First, configure and test your connection in ST using Test Message. Then select it from the dropdown above to use those settings for memory generation. Only use Full Manual Configuration if you need two different Custom OpenAI-Compatible setups; otherwise, just create two connection profiles in STone for roleplay and one for Memory Books.</small>\n        </div>\n\n        <label for=\"stmb-profile-model\">\n            <h4 data-i18n=\"STMemoryBooks_Model\">Model:</h4>\n            <input type=\"text\" id=\"stmb-profile-model\" value=\"{{connection.model}}\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_ModelPlaceholder\" placeholder=\"Paste model ID here\" {{#if (eq connection.api \"current_st\")}}disabled title=\"Managed by SillyTavern UI\"{{/if}}>\n        </label>\n\n        <label for=\"stmb-profile-temperature\">\n            <h4 data-i18n=\"STMemoryBooks_TemperatureRange\">Temperature (0.0 - 2.0):</h4>\n            <input type=\"number\" id=\"stmb-profile-temperature\" value=\"{{connection.temperature}}\" class=\"text_pole\" min=\"0\" max=\"2\" step=\"0.1\" data-i18n=\"[placeholder]STMemoryBooks_TemperaturePlaceholder\" placeholder=\"DO NOT LEAVE BLANK! If unsure put 0.8.\" {{#if (eq connection.api \"current_st\")}}disabled title=\"Managed by SillyTavern UI\"{{/if}}>\n        </label>\n\n        <div id=\"stmb-full-manual-section\" class=\"{{#unless (eq connection.api 'full-manual')}}displayNone{{/unless}}\">\n            <label for=\"stmb-profile-endpoint\">\n                <h4 data-i18n=\"STMemoryBooks_APIEndpointURL\">API Endpoint URL:</h4>\n                <input type=\"text\" id=\"stmb-profile-endpoint\" value=\"{{connection.endpoint}}\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_APIEndpointPlaceholder\" placeholder=\"https://api.example.com/v1/chat/completions\">\n            </label>\n\n            <label for=\"stmb-profile-apikey\">\n                <h4 data-i18n=\"STMemoryBooks_APIKey\">API Key:</h4>\n                <input type=\"password\" id=\"stmb-profile-apikey\" value=\"{{connection.apiKey}}\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_APIKeyPlaceholder\" placeholder=\"Enter your API key\">\n            </label>\n\n            <div class=\"info-block hint warning marginBot10\" data-i18n=\"STMemoryBooks_FullManualConfig\">\n                 EXCEPTIONAL setup - Full Manual Configuration should ONLY be used when you need a separate API connection to a different endpoint. Most users should NOT need this option.\n            </div>\n        </div>\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <label for=\"stmb-profile-preset\">\n            <h4 data-i18n=\"STMemoryBooks_Profile_MemoryMethod\">Memory Creation Method:</h4>\n            <small data-i18n=\"STMemoryBooks_Profile_PresetSelectDesc\">Choose a summary prompt. Edit or create custom prompts in the Summary Prompt Manager to see them in this list.</small>\n            <select id=\"stmb-profile-preset\" class=\"text_pole\">\n                {{#each presetOptions}}\n                <option value=\"{{value}}\" {{#if selected}}selected{{/if}}>{{displayName}}</option>\n                {{/each}}\n            </select>\n        </label>\n        {{#if hasLegacyCustomPrompt}}\n        <div id=\"stmb-legacy-custom-prompt\" class=\"displayNone\">{{prompt}}</div>\n        {{/if}}\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <div class=\"buttons_block justifyCenter gap10px whitespacenowrap\">\n            <div id=\"stmb-open-prompt-manager\" class=\"menu_button interactable\" data-i18n=\"STMemoryBooks_OpenPromptManager\"> Open Summary Prompt Manager</div>\n            <div id=\"stmb-refresh-presets\" class=\"menu_button interactable\" data-i18n=\"STMemoryBooks_RefreshPresets\"> Refresh Presets</div>\n            {{#if hasLegacyCustomPrompt}}\n            <div id=\"stmb-move-to-preset\" class=\"menu_button interactable\" data-i18n=\"STMemoryBooks_MoveToPreset\"> Move Current Custom Prompt to Preset</div>\n            {{/if}}\n        </div>\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <h4 data-i18n=\"STMemoryBooks_TitleFormat\">Memory Title Format:</h4>\n        <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_TitleFormatDesc\">Use [0], [00], etc. for numbering. Available tags: \\{{title}}, \\{{scene}}, \\{{char}}, \\{{user}}, \\{{messages}}, \\{{profile}}, \\{{date}}, \\{{time}}</small>\n        <select id=\"stmb-profile-title-format-select\" class=\"text_pole\">\n            {{#each titleFormats}}\n            <option value=\"{{value}}\" {{#if isSelected}}selected{{/if}}>{{value}}</option>\n            {{/each}}\n            <option value=\"custom\" data-i18n=\"STMemoryBooks_CustomTitleFormat\">Custom Title Format...</option>\n        </select>\n        <input type=\"text\" id=\"stmb-profile-custom-title-format\" class=\"text_pole marginTop5 {{#unless showCustomTitleInput}}displayNone{{/unless}}\"\n            data-i18n=\"[placeholder]STMemoryBooks_EnterCustomFormat\" placeholder=\"Enter custom format\" value=\"{{titleFormat}}\">\n    </div>\n    <hr>\n    <h4 data-i18n=\"STMemoryBooks_LorebookEntrySettings\">Lorebook Entry Settings</h4>\n    <div class=\"info-block hint marginBot10\" data-i18n=\"STMemoryBooks_LorebookEntrySettingsDesc\">\n        These settings control how the generated memory is saved into the lorebook.\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <label for=\"stmb-profile-const-vect\">\n            <h4 data-i18n=\"STMemoryBooks_ActivationMode\">Activation Mode:</h4>\n            <small data-i18n=\"STMemoryBooks_ActivationModeDesc\"> Vectorized is recommended for memories.</small>\n            <select id=\"stmb-profile-const-vect\" class=\"text_pole\">\n                <option value=\"link\" {{#if (eq constVectMode \"link\")}}selected{{/if}} data-i18n=\"STMemoryBooks_Vectorized\"> Vectorized (Default)</option>\n                <option value=\"blue\" {{#if (eq constVectMode \"blue\")}}selected{{/if}} data-i18n=\"STMemoryBooks_Constant\"> Constant</option>\n                <option value=\"green\" {{#if (eq constVectMode \"green\")}}selected{{/if}} data-i18n=\"STMemoryBooks_Normal\"> Normal</option>\n            </select>\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <label for=\"stmb-profile-position\">\n            <h4 data-i18n=\"STMemoryBooks_InsertionPosition\">Insertion Position:</h4>\n            <small data-i18n=\"STMemoryBooks_InsertionPositionDesc\">Char is recommended. Aiko recommends memories never go lower than AN.</small>\n            <select id=\"stmb-profile-position\" class=\"text_pole\">\n                <option value=\"0\" {{#if (eq position 0)}}selected{{/if}} data-i18n=\"STMemoryBooks_CharUp\">Char</option>\n                <option value=\"1\" {{#if (eq position 1)}}selected{{/if}} data-i18n=\"STMemoryBooks_CharDown\">Char</option>\n                <option value=\"5\" {{#if (eq position 5)}}selected{{/if}} data-i18n=\"STMemoryBooks_EMUp\">EM</option>\n                <option value=\"6\" {{#if (eq position 6)}}selected{{/if}} data-i18n=\"STMemoryBooks_EMDown\">EM</option>\n                <option value=\"2\" {{#if (eq position 2)}}selected{{/if}} data-i18n=\"STMemoryBooks_ANUp\">AN</option>\n                <option value=\"3\" {{#if (eq position 3)}}selected{{/if}} data-i18n=\"STMemoryBooks_ANDown\">AN</option>\n                <option value=\"7\" {{#if (eq position 7)}}selected{{/if}} data-i18n=\"STMemoryBooks_Outlet\">Outlet</option>\n            </select>\n        </label>\n    </div>\n\n    <div id=\"stmb-profile-outlet-name-container\" class=\"world_entry_form_control marginTop5 {{#unless (eq position 7)}}displayNone{{/unless}}\">\n        <label for=\"stmb-profile-outlet-name\">\n            <h4 data-i18n=\"STMemoryBooks_OutletName\">Outlet Name:</h4>\n            <input type=\"text\" id=\"stmb-profile-outlet-name\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_OutletNamePlaceholder\" placeholder=\"Outlet name\" value=\"{{outletName}}\">\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <h4 data-i18n=\"STMemoryBooks_InsertionOrder\">Insertion Order:</h4>\n        <div class=\"buttons_block justifyCenter gap10px\">\n            <label class=\"checkbox_label\"><input type=\"radio\" name=\"order-mode\" value=\"auto\" {{#if (eq orderMode 'auto')}}checked{{/if}}> <span data-i18n=\"STMemoryBooks_AutoOrder\">Auto (uses memory #)</span></label>\n            <label class=\"checkbox_label\"><input type=\"radio\" name=\"order-mode\" value=\"reverse\" {{#if (eq orderMode 'reverse')}}checked{{/if}}> <span data-i18n=\"STMemoryBooks_ReverseOrder\">Reverse (only use with Outlets)</span> \n                <input type=\"number\" id=\"stmb-profile-reverse-start\" value=\"{{reverseStart}}\" class=\"text_pole {{#unless (eq orderMode 'reverse')}}displayNone{{/unless}} width100px\" min=\"100\" max=\"9999\" step=\"1\" style=\"margin-left: auto;\"></label>\n            <label class=\"checkbox_label\"><input type=\"radio\" name=\"order-mode\" value=\"manual\" {{#if (eq orderMode 'manual')}}checked{{/if}}> <span data-i18n=\"STMemoryBooks_ManualOrder\">Manual</span> \n                <input type=\"number\" id=\"stmb-profile-order-value\" value=\"{{orderValue}}\" class=\"text_pole {{#unless (eq orderMode 'manual')}}displayNone{{/unless}} width100px\" min=\"1\" max=\"9999\" step=\"1\" style=\"margin-left: auto;\"></label>\n        </div>\n    </div>\n\n    <div class=\"world_entry_form_control marginTop5\">\n        <h4 data-i18n=\"STMemoryBooks_RecursionSettings\">Recursion Settings:</h4>\n        <div class=\"buttons_block justifyCenter\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-profile-prevent-recursion\" {{#if preventRecursion}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_PreventRecursion\">Prevent Recursion</span>\n            </label>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-profile-delay-recursion\" {{#if delayUntilRecursion}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_DelayUntilRecursion\">Delay Until Recursion</span>\n            </label>\n        </div>\n    </div>\n</div>\n`);\n\n/**\n * Edit an existing profile\n */\nexport async function editProfile(settings, profileIndex, refreshCallback) {\n    const profile = settings.profiles[profileIndex];\n\n    if (!profile) {\n        console.error(`${MODULE_NAME}: No profile found at index ${profileIndex}`);\n        return;\n    }\n\n    try {\n        const apiInfo = getCurrentApiInfo();\n        await SummaryPromptManager.firstRunInitIfMissing(settings);\n        const presetList = await SummaryPromptManager.listPresets();\n        const presetOptions = presetList.map(p => ({\n            value: p.key,\n            displayName: p.displayName,\n            selected: p.key === (profile.preset || '')\n        }));\n        const connection = profile.connection || { temperature: 0.7 };\n        const profileTitleFormat = profile.titleFormat || settings.titleFormat || '[000] - {{title}}';\n        const allTitleFormats = getDefaultTitleFormats();\n        const isBuiltinCurrentST = !!profile.isBuiltinCurrentST;\n        const templateData = {\n            name: isBuiltinCurrentST\n                ? translate(BUILTIN_CURRENT_ST_NAME, 'STMemoryBooks_Profile_CurrentST')\n                : profile.name,\n            connection: connection,\n            api: 'openai',\n            prompt: profile.prompt || '',\n            preset: profile.preset || '',\n            currentApi: apiInfo.api || 'Unknown',\n            presetOptions: presetOptions,\n            isNameLocked: isBuiltinCurrentST,\n            isProviderLocked: isBuiltinCurrentST,\n            // Pass title format data to the template\n            titleFormat: profileTitleFormat,\n            titleFormats: allTitleFormats.map(format => ({\n                value: format,\n                isSelected: format === profileTitleFormat\n            })),\n            showCustomTitleInput: !allTitleFormats.includes(profileTitleFormat),\n            constVectMode: profile.constVectMode,\n            position: profile.position,\n            orderMode: profile.orderMode,\n            orderValue: profile.orderValue,\n            reverseStart: Number.isFinite(profile.reverseStart) ? profile.reverseStart : DEFAULT_REVERSE_START,\n            preventRecursion: profile.preventRecursion,\n            delayUntilRecursion: profile.delayUntilRecursion,\n            outletName: profile.outletName || '',\n            hasLegacyCustomPrompt: (profile.prompt && profile.prompt.trim()) ? true : false\n        };\n\n        const content = DOMPurify.sanitize(profileEditTemplate(templateData));\n\n        const popupInstance = new Popup(`<h3>${translate('Edit Profile', 'STMemoryBooks_ProfileEditTitle')}</h3>${content}`, POPUP_TYPE.TEXT, '', {\n            okButton: translate('Save', 'STMemoryBooks_Save'),\n            cancelButton: translate('Cancel/Close', 'STMemoryBooks_CancelClose'),\n            wide: true,\n            large: true,\n            allowVerticalScrolling: true,\n        });\n\n        setupProfileEditEventHandlers(popupInstance, settings);\n\n        const result = await popupInstance.show();\n\n        if (result === POPUP_RESULT.AFFIRMATIVE) {\n            const updatedProfile = buildProfileFromForm(popupInstance.dlg, profile.name);\n\n            // Enforce builtin profile invariants even if UI is bypassed.\n            if (profile?.isBuiltinCurrentST) {\n                updatedProfile.isBuiltinCurrentST = true;\n                updatedProfile.name = BUILTIN_CURRENT_ST_NAME;\n                updatedProfile.connection = updatedProfile.connection || {};\n                updatedProfile.connection.api = 'current_st';\n            }\n\n            if (!validateProfile(updatedProfile)) {\n                toastr.error(translate('Invalid profile data', 'STMemoryBooks_InvalidProfileData'), 'STMemoryBooks');\n                return;\n            }\n\n            settings.profiles[profileIndex] = updatedProfile;\n            saveSettingsDebounced();\n\n            if (refreshCallback) refreshCallback();\n\n            toastr.success(translate('Profile updated successfully', 'STMemoryBooks_ProfileUpdatedSuccess'), 'STMemoryBooks');\n        }\n    } catch (error) {\n        console.error(`${MODULE_NAME}: Error editing profile:`, error);\n        toastr.error(translate('Failed to edit profile', 'STMemoryBooks_FailedToEditProfile'), 'STMemoryBooks');\n    }\n}\n\n/**\n * Create a new profile\n */\nexport async function newProfile(settings, refreshCallback) {\n    try {\n        const existingNames = settings.profiles.map(p => p.name);\n        const defaultName = generateSafeProfileName('New Profile', existingNames);\n\n        const apiInfo = getCurrentApiInfo();\n\n        // Logic to handle title format for the template\n        const currentTitleFormat = settings.titleFormat || '[000] - {{title}}';\n        const allTitleFormats = getDefaultTitleFormats();\n        await SummaryPromptManager.firstRunInitIfMissing(settings);\n        const presetList = await SummaryPromptManager.listPresets();\n        const presetOptions = presetList.map(p => ({\n            value: p.key,\n            displayName: p.displayName,\n            selected: false\n        }));\n\n        const templateData = {\n            name: defaultName,\n            connection: { temperature: 0.7 },\n            api: '',\n            prompt: '',\n            preset: '',\n            currentApi: apiInfo.api || 'Unknown',\n            presetOptions: presetOptions,\n            isNameLocked: false,\n            isProviderLocked: false,\n            // Pass title format data to the template\n            titleFormat: currentTitleFormat,\n            titleFormats: allTitleFormats.map(format => ({\n                value: format,\n                isSelected: format === currentTitleFormat\n            })),\n            showCustomTitleInput: !allTitleFormats.includes(currentTitleFormat),\n            constVectMode: 'link',\n            position: 0,\n            orderMode: 'auto',\n            orderValue: 100,\n            reverseStart: DEFAULT_REVERSE_START,\n            preventRecursion: false,\n            delayUntilRecursion: true,\n            outletName: ''\n        };\n\n        const content = DOMPurify.sanitize(profileEditTemplate(templateData));\n\n        const popupInstance = new Popup(`<h3>${translate('New Profile', 'STMemoryBooks_NewProfileTitle')}</h3>${content}`, POPUP_TYPE.TEXT, '', {\n            okButton: translate('Create', 'STMemoryBooks_Create'),\n            cancelButton: translate('Cancel/Close', 'STMemoryBooks_CancelClose'),\n            wide: true,\n            large: true,\n            allowVerticalScrolling: true,\n        });\n\n        setupProfileEditEventHandlers(popupInstance, settings);\n\n        const result = await popupInstance.show();\n\n        if (result === POPUP_RESULT.AFFIRMATIVE) {\n            const newProfileData = buildProfileFromForm(popupInstance.dlg, defaultName);\n\n            const finalName = generateSafeProfileName(newProfileData.name, existingNames);\n            newProfileData.name = finalName;\n\n            if (!validateProfile(newProfileData)) {\n                toastr.error(translate('Invalid profile data', 'STMemoryBooks_InvalidProfileData'), 'STMemoryBooks');\n                return;\n            }\n\n            settings.profiles.push(newProfileData);\n            saveSettingsDebounced();\n\n            if (refreshCallback) refreshCallback();\n\n            toastr.success(translate('Profile created successfully', 'STMemoryBooks_ProfileCreatedSuccess'), 'STMemoryBooks');\n        }\n    } catch (error) {\n        console.error(`${MODULE_NAME}: Error creating profile:`, error);\n        toastr.error(translate('Failed to create profile', 'STMemoryBooks_FailedToCreateProfile'), 'STMemoryBooks');\n    }\n}\n\n/**\n * Delete an existing profile\n * @param {Object} settings - Extension settings\n * @param {number} profileIndex - The index of the profile to delete\n * @param {Function} refreshCallback - Function to refresh UI after changes\n */\nexport async function deleteProfile(settings, profileIndex, refreshCallback) {\n    if (settings.profiles.length <= 1) {\n        toastr.error(translate('Cannot delete the last profile', 'STMemoryBooks_CannotDeleteLastProfile'), 'STMemoryBooks');\n        return;\n    }\n\n    const profile = settings.profiles[profileIndex];\n\n    // Prevent deletion of the required default profile\n    if (profile?.isBuiltinCurrentST) {\n        toastr.error(translate('Cannot delete the \"Current SillyTavern Settings\" profile - it is required for the extension to work', 'STMemoryBooks_CannotDeleteDefaultProfile'), 'STMemoryBooks');\n        return;\n    }\n\n    try {\n        const confirmText = translate('Delete profile \"{{name}}\"?', 'STMemoryBooks_DeleteProfileConfirm').replace('{{name}}', profile.name);\n        const result = await new Popup(confirmText, POPUP_TYPE.CONFIRM, '').show();\n\n        if (result === POPUP_RESULT.AFFIRMATIVE) {\n            const deletedName = profile.name;\n            settings.profiles.splice(profileIndex, 1);\n\n            // If we deleted the profile that was the default, reset default to the first profile.\n            if (settings.defaultProfile === profileIndex) {\n                settings.defaultProfile = 0;\n            }\n            // If we deleted a profile that came *before* the default one, its index has shifted.\n            else if (settings.defaultProfile > profileIndex) {\n                settings.defaultProfile--;\n            }\n\n            saveSettingsDebounced();\n\n            if (refreshCallback) refreshCallback();\n\n            toastr.success(translate('Profile deleted successfully', 'STMemoryBooks_ProfileDeletedSuccess'), 'STMemoryBooks');\n        }\n    } catch (error) {\n        console.error(`${MODULE_NAME}: Error deleting profile:`, error);\n        toastr.error(translate('Failed to delete profile', 'STMemoryBooks_FailedToDeleteProfile'), 'STMemoryBooks');\n    }\n}\n\n/**\n * Export profiles to JSON file\n * @param {Object} settings - Extension settings\n */\nexport function exportProfiles(settings) {\n    try {\n        const exportData = {\n            profiles: settings.profiles,\n            exportDate: moment().toISOString(),\n            version: 1,\n            moduleVersion: settings.migrationVersion || 1\n        };\n\n        const dataStr = JSON.stringify(exportData, null, 2);\n        const dataBlob = new Blob([dataStr], { type: 'application/json' });\n\n        const link = document.createElement('a');\n        link.href = URL.createObjectURL(dataBlob);\n        link.download = `stmemorybooks-profiles-${moment().format('YYYY-MM-DD')}.json`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n\n        // Clean up the object URL\n        setTimeout(() => URL.revokeObjectURL(link.href), 1000);\n\n        toastr.success(translate('Profiles exported successfully', 'STMemoryBooks_ProfilesExportedSuccess'), 'STMemoryBooks');\n    } catch (error) {\n        console.error(`${MODULE_NAME}: Error exporting profiles:`, error);\n        toastr.error(translate('Failed to export profiles', 'STMemoryBooks_FailedToExportProfiles'), 'STMemoryBooks');\n    }\n}\n\nfunction cleanProfile(profile) {\n    return createProfileObject(profile);\n}\n\n/**\n * Import profiles from JSON file\n * @param {Event} event - File input change event\n * @param {Object} settings - Extension settings\n * @param {Function} refreshCallback - Function to refresh UI after changes\n */\nexport function importProfiles(event, settings, refreshCallback) {\n    const file = event.target.files[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = function(e) {\n        try {\n            const importData = JSON.parse(e.target.result);\n\n            if (!importData.profiles || !Array.isArray(importData.profiles)) {\n                throw new Error(translate('Invalid profile data format - missing profiles array', 'STMemoryBooks_ImportErrorInvalidFormat'));\n            }\n\n            // Validate and clean profile structure\n            const validProfiles = importData.profiles\n                .filter(profile => validateProfile(profile))\n                .map(profile => cleanProfile(profile));\n\n            if (validProfiles.length === 0) {\n                throw new Error(translate('No valid profiles found in import file', 'STMemoryBooks_ImportErrorNoValidProfiles'));\n            }\n\n            let importedCount = 0;\n            let skippedCount = 0;\n            const existingNames = settings.profiles.map(p => p.name);\n\n            // Merge profiles (avoid duplicates by name)\n            validProfiles.forEach(importProfile => {\n                const exists = existingNames.includes(importProfile.name);\n                if (!exists) {\n                    // Ensure unique name and clean structure\n                    const finalName = generateSafeProfileName(importProfile.name, existingNames);\n                    importProfile.name = finalName;\n                    existingNames.push(finalName);\n\n                    settings.profiles.push(importProfile);\n                    importedCount++;\n                } else {\n                    skippedCount++;\n                }\n            });\n\n            if (importedCount > 0) {\n                saveSettingsDebounced();\n                if (refreshCallback) refreshCallback();\n\n                let message = __st_t_tag`Imported ${importedCount} profile${importedCount === 1 ? '' : 's'}`;\n                if (skippedCount > 0) {\n                    message += __st_t_tag` (${skippedCount} duplicate${skippedCount === 1 ? '' : 's'} skipped)`;\n                }\n\n                toastr.success(message, translate('STMemoryBooks profile import completed', 'STMemoryBooks_ImportComplete'));\n            } else {\n                toastr.warning(translate('No new profiles imported - all profiles already exist', 'STMemoryBooks_ImportNoNewProfiles'), 'STMemoryBooks');\n            }\n\n        } catch (error) {\n            console.error(`${MODULE_NAME}: Error importing profiles:`, error);\n            toastr.error(__st_t_tag`Failed to import profiles: ${error.message}`, 'STMemoryBooks');\n        }\n    };\n\n    reader.onerror = function() {\n        console.error(`${MODULE_NAME}: Error reading import file`);\n        toastr.error(translate('Failed to read import file', 'STMemoryBooks_ImportReadError'), 'STMemoryBooks');\n    };\n\n    reader.readAsText(file);\n\n    // Clear the file input\n    event.target.value = '';\n}\n\n/**\n * Setup event handlers for profile edit popup\n */\nfunction setupProfileEditEventHandlers(popupInstance, settings) {\n    const popupElement = popupInstance.dlg;\n\n    // Open Summary Prompt Manager from profile editor\n    popupElement.querySelector('#stmb-open-prompt-manager')?.addEventListener('click', () => {\n        try {\n            const btn = document.querySelector('#stmb-prompt-manager');\n            if (btn) {\n                btn.click();\n            } else {\n                toastr.error(translate('Prompt Manager button not found. Open main settings and try again.', 'STMemoryBooks_PromptManagerNotFound'), 'STMemoryBooks');\n            }\n        } catch (err) {\n            console.error(`${MODULE_NAME}: Error opening prompt manager from profile editor:`, err);\n            toastr.error(translate('Failed to open Summary Prompt Manager', 'STMemoryBooks_FailedToOpenSummaryPromptManager'), 'STMemoryBooks');\n        }\n    });\n\n    // Refresh presets list in the dropdown (useful after creating a new preset)\n    popupElement.querySelector('#stmb-refresh-presets')?.addEventListener('click', async () => {\n        try {\n            const selectEl = popupElement.querySelector('#stmb-profile-preset');\n            if (!selectEl) return;\n            const prev = selectEl.value;\n\n            const presetList = await SummaryPromptManager.listPresets();\n            // Rebuild options\n            selectEl.innerHTML = '';\n            presetList.forEach(p => {\n                const opt = document.createElement('option');\n                opt.value = p.key;\n                opt.textContent = p.displayName;\n                if (p.key === prev) opt.selected = true;\n                selectEl.appendChild(opt);\n            });\n\n            // If previous value no longer exists, default to first option\n            if (![...selectEl.options].some(o => o.value === prev) && selectEl.options.length > 0) {\n                selectEl.selectedIndex = 0;\n            }\n\n            toastr.success(translate('Preset list refreshed', 'STMemoryBooks_PresetListRefreshed'), 'STMemoryBooks');\n        } catch (err) {\n            console.error(`${MODULE_NAME}: Error refreshing presets:`, err);\n            toastr.error(translate('Failed to refresh presets', 'STMemoryBooks_FailedToRefreshPresets'), 'STMemoryBooks');\n        }\n    });\n\n    // Auto-refresh presets when Prompt Manager updates presets\n    const stmbOnPresetsUpdated = async () => {\n        try {\n            const selectEl2 = popupElement.querySelector('#stmb-profile-preset');\n            if (!selectEl2) return;\n            const prev2 = selectEl2.value;\n\n            const presetList2 = await SummaryPromptManager.listPresets();\n            selectEl2.innerHTML = '';\n            presetList2.forEach(p => {\n                const opt = document.createElement('option');\n                opt.value = p.key;\n                opt.textContent = p.displayName;\n                if (p.key === prev2) opt.selected = true;\n                selectEl2.appendChild(opt);\n            });\n\n            if (![...selectEl2.options].some(o => o.value === prev2) && selectEl2.options.length > 0) {\n                selectEl2.selectedIndex = 0;\n            }\n        } catch (e) {\n            console.error(`${MODULE_NAME}: Error auto-refreshing presets on update:`, e);\n        }\n    };\n    window.addEventListener('stmb-presets-updated', stmbOnPresetsUpdated);\n    popupInstance?.dlg?.addEventListener('close', () => {\n        window.removeEventListener('stmb-presets-updated', stmbOnPresetsUpdated);\n    });\n\n    // Move legacy custom prompt to a new preset and select it\n    popupElement.querySelector('#stmb-move-to-preset')?.addEventListener('click', async () => {\n        try {\n            const legacyPromptEl = popupElement.querySelector('#stmb-legacy-custom-prompt');\n            const legacyPrompt = legacyPromptEl ? legacyPromptEl.textContent : '';\n            if (!legacyPrompt || !legacyPrompt.trim()) {\n                toastr.error(t('STMemoryBooks_NoCustomPromptToMigrate', 'No custom prompt to migrate'), 'STMemoryBooks');\n                return;\n            }\n            const profileNameInput = popupElement.querySelector('#stmb-profile-name');\n            const profileName = profileNameInput?.value?.trim() || 'Profile';\n            const displayName = `Custom: ${profileName}`;\n\n            const newKey = await SummaryPromptManager.upsertPreset(null, legacyPrompt, displayName);\n\n            const confirmPopup = new Popup(\n                '<h3 data-i18n=\"STMemoryBooks_MoveToPresetConfirmTitle\">Move to Preset</h3><p data-i18n=\"STMemoryBooks_MoveToPresetConfirmDesc\">Create a preset from this profile\\'s custom prompt, set the preset on this profile, and clear the custom prompt?</p>',\n                POPUP_TYPE.CONFIRM,\n                '',\n                { okButton: translate('Apply', 'STMemoryBooks_Apply'), cancelButton: translate('Cancel', 'STMemoryBooks_Cancel') }\n            );\n            const res = await confirmPopup.show();\n            if (res === POPUP_RESULT.AFFIRMATIVE) {\n                const presetSelect = popupElement.querySelector('#stmb-profile-preset');\n                if (presetSelect) {\n                    if (![...presetSelect.options].some(o => o.value === newKey)) {\n                        const opt = document.createElement('option');\n                        opt.value = newKey;\n                        opt.textContent = displayName;\n                        presetSelect.appendChild(opt);\n                    }\n                    presetSelect.value = newKey;\n                }\n                legacyPromptEl?.remove();\n                popupElement.querySelector('#stmb-move-to-preset')?.remove();\n                toastr.success(translate('Preset created and selected. Remember to Save.', 'STMemoryBooks_CustomPromptMigrated'), 'STMemoryBooks');\n            }\n        } catch (error) {\n            console.error(`${MODULE_NAME}: Error moving custom prompt to preset:`, error);\n            toastr.error(translate('Failed to move custom prompt to preset', 'STMemoryBooks_FailedToMigrateCustomPrompt'), 'STMemoryBooks');\n        }\n    });\n\n    // Handler for the new title format dropdown\n    popupElement.querySelector('#stmb-profile-title-format-select')?.addEventListener('change', (e) => {\n        const customInput = popupElement.querySelector('#stmb-profile-custom-title-format');\n        if (e.target.value === 'custom') {\n            customInput.classList.remove('displayNone');\n            customInput.focus();\n        } else {\n            customInput.classList.add('displayNone');\n        }\n    });\n\n    popupElement.querySelector('#stmb-profile-temperature')?.addEventListener('input', (e) => {\n        const value = parseFloat(e.target.value);\n        if (!isNaN(value)) {\n            if (value < 0) e.target.value = 0;\n            if (value > 2) e.target.value = 2;\n        }\n    });\n\n    popupElement.querySelector('#stmb-profile-model')?.addEventListener('input', (e) => {\n        e.target.value = e.target.value.replace(/[<>]/g, '');\n    });\n\n    popupElement.querySelector('#stmb-profile-api')?.addEventListener('change', (e) => {\n        const fullManualSection = popupElement.querySelector('#stmb-full-manual-section');\n        const modelInput = popupElement.querySelector('#stmb-profile-model');\n        const tempInput = popupElement.querySelector('#stmb-profile-temperature');\n        if (e.target.value === 'full-manual') {\n            fullManualSection.classList.remove('displayNone');\n        } else {\n            fullManualSection.classList.add('displayNone');\n        }\n        // Disable model/temp when using Current SillyTavern Settings provider\n        const isCurrentST = e.target.value === 'current_st';\n        if (modelInput) {\n            modelInput.disabled = isCurrentST;\n            modelInput.title = isCurrentST ? 'Managed by SillyTavern UI' : '';\n        }\n        if (tempInput) {\n            tempInput.disabled = isCurrentST;\n            tempInput.title = isCurrentST ? 'Managed by SillyTavern UI' : '';\n        }\n    });\n\n    function syncOrderModeInputs(mode) {\n        const orderValueInput = popupElement.querySelector('#stmb-profile-order-value');\n        const reverseStartInput = popupElement.querySelector('#stmb-profile-reverse-start');\n\n        if (orderValueInput) orderValueInput.classList.toggle('displayNone', mode !== 'manual');\n        if (reverseStartInput) reverseStartInput.classList.toggle('displayNone', mode !== 'reverse');\n    }\n\n    popupElement.querySelectorAll('input[name=\"order-mode\"]').forEach(radio => {\n        radio.addEventListener('change', (e) => {\n            syncOrderModeInputs(e.target.value);\n        });\n    });\n\n    // Initial sync on open\n    syncOrderModeInputs(popupElement.querySelector('input[name=\"order-mode\"]:checked')?.value);\n\n    // Sanitize reverse start input: integer clamp 100-9999\n    const reverseStartInput = popupElement.querySelector('#stmb-profile-reverse-start');\n    if (reverseStartInput) {\n        reverseStartInput.addEventListener('input', () => {\n            reverseStartInput.value = String(reverseStartInput.value ?? '').replace(/[^\\d]/g, '');\n        });\n        reverseStartInput.addEventListener('blur', () => {\n            const n = readIntInput(reverseStartInput, DEFAULT_REVERSE_START);\n            reverseStartInput.value = String(clampInt(Math.trunc(n), 100, 9999));\n        });\n    }\n\n    // Toggle outlet name visibility based on position\n    const positionSelect = popupElement.querySelector('#stmb-profile-position');\n    positionSelect?.addEventListener('change', () => {\n        const cont = popupElement.querySelector('#stmb-profile-outlet-name-container');\n        if (cont) cont.classList.toggle('displayNone', positionSelect.value !== '7');\n    });\n\n    // Initial sync for outlet name visibility on open\n    (function() {\n        const cont = popupElement.querySelector('#stmb-profile-outlet-name-container');\n        if (positionSelect && cont) {\n            cont.classList.toggle('displayNone', positionSelect.value !== '7');\n        }\n    })();\n\n    // Inject global \"Also convert recursion settings on existing entries\" checkbox into Recursion Settings block\n    try {\n        const recursionHeader = popupElement.querySelector('h4[data-i18n=\"STMemoryBooks_RecursionSettings\"]');\n        const recursionBlock = recursionHeader ? recursionHeader.parentElement?.querySelector('.buttons_block') : null;\n        if (recursionBlock && !popupElement.querySelector('#stmb-convert-existing-recursion')) {\n            const lbl = document.createElement('label');\n            lbl.className = 'checkbox_label';\n\n            const input = document.createElement('input');\n            input.type = 'checkbox';\n            input.id = 'stmb-convert-existing-recursion';\n            input.checked = !!(settings && settings.moduleSettings && settings.moduleSettings.convertExistingRecursion);\n\n            const span = document.createElement('span');\n            span.textContent = 'Also convert recursion settings on existing entries';\n            try { span.setAttribute('data-i18n', 'STMemoryBooks_ConvertExistingRecursion'); } catch (e) { /* noop */ }\n\n            lbl.appendChild(input);\n            lbl.appendChild(span);\n            recursionBlock.appendChild(lbl);\n\n            input.addEventListener('change', () => {\n                try {\n                    settings.moduleSettings = settings.moduleSettings || {};\n                    settings.moduleSettings.convertExistingRecursion = !!input.checked;\n                    saveSettingsDebounced();\n                } catch (e) {\n                    console.error(`${MODULE_NAME}: Failed to save convertExistingRecursion flag`, e);\n                }\n            });\n        }\n    } catch (e) {\n        console.warn(`${MODULE_NAME}: Failed to inject convertExistingRecursion checkbox`, e);\n    }\n}\n\n/**\n * Build profile object from form data\n */\nfunction buildProfileFromForm(popupElement, fallbackName) {\n    // Step 1: Gather all the raw data from the form into a single object.\n    const data = {\n        name: popupElement.querySelector('#stmb-profile-name')?.value.trim() || fallbackName,\n        api: popupElement.querySelector('#stmb-profile-api')?.value,\n        model: popupElement.querySelector('#stmb-profile-model')?.value,\n        temperature: popupElement.querySelector('#stmb-profile-temperature')?.value,\n        endpoint: popupElement.querySelector('#stmb-profile-endpoint')?.value,\n        apiKey: popupElement.querySelector('#stmb-profile-apikey')?.value,\n        constVectMode: popupElement.querySelector('#stmb-profile-const-vect')?.value,\n        position: popupElement.querySelector('#stmb-profile-position')?.value,\n        orderMode: popupElement.querySelector('input[name=\"order-mode\"]:checked')?.value,\n        orderValue: popupElement.querySelector('#stmb-profile-order-value')?.value,\n        reverseStart: popupElement.querySelector('#stmb-profile-reverse-start')?.value,\n        preventRecursion: popupElement.querySelector('#stmb-profile-prevent-recursion')?.checked,\n        delayUntilRecursion: popupElement.querySelector('#stmb-profile-delay-recursion')?.checked,\n    };\n\n    // Step 2: Intelligently determine whether to use the selected preset or the custom prompt.\n    const presetSelect = popupElement.querySelector('#stmb-profile-preset');\n    data.prompt = '';\n    data.preset = presetSelect?.value || '';\n\n    // Handle the title format dropdown logic\n    const titleFormatSelect = popupElement.querySelector('#stmb-profile-title-format-select');\n    if (titleFormatSelect?.value === 'custom') {\n        data.titleFormat = popupElement.querySelector('#stmb-profile-custom-title-format')?.value;\n    } else if (titleFormatSelect) {\n        data.titleFormat = titleFormatSelect.value;\n    }\n\n    // Step 3: Call the centralized creator function with the gathered and cleaned data.\n    if (data.position === '7' || data.position === 7) {\n        data.outletName = popupElement.querySelector('#stmb-profile-outlet-name')?.value?.trim() || '';\n    }\n    return createProfileObject(data);\n}\n\n/**\n * Validate all profiles in settings and fix issues\n */\nexport function validateAndFixProfiles(settings) {\n    const issues = [];\n    const fixes = [];\n\n    if (!settings.profiles || !Array.isArray(settings.profiles)) {\n        settings.profiles = [];\n        fixes.push('Created empty profiles array');\n    }\n\n    if (settings.profiles.length === 0) {\n        // Create default profile using provider-based \"Current SillyTavern Settings\"\n        const dynamicProfile = createProfileObject({\n            name: BUILTIN_CURRENT_ST_NAME,\n            api: 'current_st',\n            preset: 'summary',\n            isBuiltinCurrentST: true,\n        });\n\n        settings.profiles.push(dynamicProfile);\n        fixes.push('Added default profile using provider \"Current SillyTavern Settings\".');\n    }\n\n    // Migrate legacy dynamic profiles to provider-based current_st\n    settings.profiles = settings.profiles.map(p => {\n        if (p && p.useDynamicSTSettings) {\n            p.connection = p.connection || {};\n            p.connection.api = 'current_st';\n            p.isBuiltinCurrentST = true;\n            delete p.useDynamicSTSettings;\n            fixes.push(`Migrated legacy dynamic profile \"${p.name}\" to provider-based current_st`);\n        }\n        return p;\n    });\n\n    // Ensure exactly one builtin \"Current SillyTavern Settings\" profile exists.\n    try {\n        const builtinIndices = [];\n        for (let i = 0; i < settings.profiles.length; i++) {\n            if (settings.profiles[i]?.isBuiltinCurrentST) builtinIndices.push(i);\n        }\n\n        if (builtinIndices.length === 0) {\n            // Prefer the legacy default (name + provider) if it exists, otherwise pick a reasonable current_st candidate.\n            let candidateIndex = settings.profiles.findIndex(\n                (p) => p?.connection?.api === 'current_st' && p?.name === BUILTIN_CURRENT_ST_NAME,\n            );\n            if (candidateIndex < 0) {\n                candidateIndex = settings.profiles.findIndex(\n                    (p) => p?.connection?.api === 'current_st' && (p?.preset === 'summary'),\n                );\n            }\n            if (candidateIndex < 0) {\n                candidateIndex = settings.profiles.findIndex((p) => p?.connection?.api === 'current_st');\n            }\n\n            if (candidateIndex >= 0) {\n                settings.profiles[candidateIndex].isBuiltinCurrentST = true;\n                fixes.push(`Marked existing profile \"${settings.profiles[candidateIndex].name}\" as builtin Current ST profile`);\n            } else {\n                // No current_st profiles exist; add the required builtin profile.\n                const dynamicProfile = createProfileObject({\n                    name: BUILTIN_CURRENT_ST_NAME,\n                    api: 'current_st',\n                    preset: 'summary',\n                    isBuiltinCurrentST: true,\n                });\n                settings.profiles.unshift(dynamicProfile);\n                if (typeof settings.defaultProfile === 'number') {\n                    settings.defaultProfile += 1;\n                }\n                fixes.push('Added missing builtin Current ST profile.');\n            }\n        } else if (builtinIndices.length > 1) {\n            // Keep the first builtin profile and clear the rest to avoid locking multiple profiles.\n            for (let j = 1; j < builtinIndices.length; j++) {\n                delete settings.profiles[builtinIndices[j]].isBuiltinCurrentST;\n            }\n            fixes.push('Fixed multiple builtin Current ST profiles (kept first, cleared others).');\n        }\n    } catch (e) {\n        console.warn(`${MODULE_NAME}: Failed to enforce builtin Current ST profile invariants`, e);\n    }\n\n    settings.profiles.forEach((profile, index) => {\n        if (!validateProfile(profile)) {\n            issues.push(`Profile ${index} is invalid`);\n            if (!profile.name) {\n                profile.name = `Profile ${index + 1}`;\n                fixes.push(`Fixed missing name for profile ${index}`);\n            }\n            if (!profile.connection) {\n                profile.connection = {};\n                fixes.push(`Fixed missing connection for profile ${index}`);\n            }\n        }\n\n        // Enforce builtin profile invariants.\n        if (profile?.isBuiltinCurrentST) {\n            profile.name = BUILTIN_CURRENT_ST_NAME;\n            profile.connection = profile.connection || {};\n            profile.connection.api = 'current_st';\n        }\n\n        // For each profile, we check if the new settings exist. If not, we add the defaults.\n        if (profile.constVectMode === undefined) {\n            profile.constVectMode = 'link';\n            fixes.push(`Added default 'constVectMode' to profile \"${profile.name}\"`);\n        }\n        if (profile.position === undefined) {\n            profile.position = 0;\n            fixes.push(`Added default 'position' to profile \"${profile.name}\"`);\n        }\n        if (profile.orderMode === undefined) {\n            profile.orderMode = 'auto';\n            profile.orderValue = 100;\n            fixes.push(`Added default 'order' settings to profile \"${profile.name}\"`);\n        }\n        if (profile.preventRecursion === undefined) {\n            profile.preventRecursion = false;\n            fixes.push(`Added default 'preventRecursion' to profile \"${profile.name}\"`);\n        }\n        if (profile.delayUntilRecursion === undefined) {\n            profile.delayUntilRecursion = true;\n            fixes.push(`Added default 'delayUntilRecursion' to profile \"${profile.name}\"`);\n        }\n        // Ensure all existing profiles have a title format\n        if (!profile.titleFormat) {\n            profile.titleFormat = settings.titleFormat || '[000] - {{title}}';\n            fixes.push(`Added missing title format to profile \"${profile.name}\"`);\n        }\n    });\n\n    if (settings.defaultProfile >= settings.profiles.length) {\n        settings.defaultProfile = 0;\n        fixes.push('Fixed invalid default profile index');\n    }\n\n    return {\n        valid: issues.length === 0,\n        issues: issues,\n        fixes: fixes,\n        profileCount: settings.profiles.length\n    };\n}\n",
    "import { Handlebars } from '../../../../lib.js';\n\n/**\n * Main settings template\n */\nexport const settingsTemplate = Handlebars.compile(`\n    <h3 data-i18n=\"STMemoryBooks_Settings\"> Memory Books Settings</h3>\n        {{#if hasScene}}\n        <div id=\"stmb-scene\" class=\"padding10 marginBot10\">\n            <div class=\"marginBot5\" data-i18n=\"STMemoryBooks_CurrentScene\">Current Scene:</div>\n            <div class=\"padding10 marginTop5 stmb-box\">\n                <pre><code id=\"stmb-scene-block\"><span data-i18n=\"STMemoryBooks_Start\">Start</span>: <span data-i18n=\"STMemoryBooks_Message\">Message</span> #{{sceneData.sceneStart}} ({{sceneData.startSpeaker}})\n{{sceneData.startExcerpt}}\n\n<span data-i18n=\"STMemoryBooks_End\">End</span>: <span data-i18n=\"STMemoryBooks_Message\">Message</span> #{{sceneData.sceneEnd}} ({{sceneData.endSpeaker}})\n{{sceneData.endExcerpt}}\n\n<span data-i18n=\"STMemoryBooks_Messages\">Messages</span>: {{sceneData.messageCount}} | <span data-i18n=\"STMemoryBooks_EstimatedTokens\">Estimated tokens</span>: {{sceneData.estimatedTokens}}</code></pre>\n            </div>\n        </div>\n        {{else}}\n        <div class=\"info-block warning\">\n            <span data-i18n=\"STMemoryBooks_NoSceneMarkers\">No scene markers set. Use the chevron buttons in chat messages to mark start () and end () points.</span>\n        </div>\n        {{/if}}\n\n        {{#if hasHighestMemoryProcessed}}\n        <div id=\"stmb-memory-status\" class=\"info-block\">\n            <span> <span data-i18n=\"STMemoryBooks_MemoryStatus\">Memory Status</span>: \n                {{#if highestMemoryProcessedManuallySet}}<span data-i18n=\"STMemoryBooks_LastProcessedManuallySet\">last processed message manually set to</span> #{{highestMemoryProcessed}}.\n                {{else}}<span data-i18n=\"STMemoryBooks_ProcessedUpTo\">Processed up to message</span> #{{highestMemoryProcessed}}.\n            {{/if}}</span>\n        </div>\n        {{else}}\n        <div id=\"stmb-memory-status\" class=\"info-block\">\n            <span> <span data-i18n=\"STMemoryBooks_MemoryStatus\">Memory Status</span>: <span data-i18n=\"STMemoryBooks_NoMemoriesProcessed\">No memories have been processed for this chat yet</span> <small data-i18n=\"STMemoryBooks_SinceVersion\">(since updating to version 3.6.2 or higher.)</small></span>\n            <br />\n            <small data-i18n=\"STMemoryBooks_AutoSummaryNote\">Please note that Auto-Summary requires you to \"prime\" every chat with at least one manual memory. After that, summaries will be made automatically.</small>\n        </div>\n        {{/if}}\n\n        <h4 data-i18n=\"STMemoryBooks_Preferences\">Preferences:</h4>\n\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-always-use-default\" {{#if alwaysUseDefault}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_AlwaysUseDefault\">Always use default profile (no confirmation prompt)</span>\n            </label>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-show-memory-previews\" {{#if showMemoryPreviews}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_ShowMemoryPreviews\">Show memory previews</span>\n            </label>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-show-notifications\" {{#if showNotifications}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_ShowNotifications\">Show notifications</span>\n            </label>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-unhide-before-memory\" {{#if unhideBeforeMemory}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_UnhideBeforeMemory\">Unhide hidden messages for memory generation (runs /unhide X-Y)</span>\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-manual-mode-enabled\" {{#if manualModeEnabled}}checked{{/if}} {{#if autoCreateLorebook}}disabled{{/if}}>\n                <span data-i18n=\"STMemoryBooks_EnableManualMode\">Enable Manual Lorebook Mode</span>\n            </label>\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_ManualModeDesc\">When enabled, you must specify a lorebook for memories instead of using the one bound to the chat.</small>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-auto-create-lorebook\" {{#if autoCreateLorebook}}checked{{/if}} {{#if manualModeEnabled}}disabled{{/if}}>\n                <span data-i18n=\"STMemoryBooks_AutoCreateLorebook\">Auto-create lorebook if none exists</span>\n            </label>\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_AutoCreateLorebookDesc\">When enabled, automatically creates and binds a lorebook to the chat if none exists.</small>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-lorebook-name-template\">\n                <h4 data-i18n=\"STMemoryBooks_LorebookNameTemplate\">Lorebook Name Template:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_LorebookNameTemplateDesc\">Template for auto-created lorebook names. Supports {{char}}, {{user}}, {{chat}} placeholders.</small>\n                <input type=\"text\" id=\"stmb-lorebook-name-template\" class=\"text_pole\"\n                    value=\"{{lorebookNameTemplate}}\" data-i18n=\"[placeholder]STMemoryBooks_LorebookNameTemplatePlaceholder\"\n                    placeholder=\"LTM - {{char}} - {{chat}}\"\n                    {{#unless autoCreateLorebook}}disabled{{/unless}}>\n            </label>\n        </div>\n\n        <h4 data-i18n=\"STMemoryBooks_CurrentLorebookConfig\">Current Lorebook Configuration</h4>\n\n        <div class=\"info-block\">\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_Mode\">Mode:</small>\n            <h5 id=\"stmb-mode-badge\">{{lorebookMode}}</h5>\n\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_ActiveLorebook\">Active Lorebook:</small>\n            <h5 id=\"stmb-active-lorebook\" class=\"{{#unless currentLorebookName}}opacity50p{{/unless}}\">\n                {{#if currentLorebookName}}\n                    {{currentLorebookName}}\n                {{else}}\n                    <span data-i18n=\"STMemoryBooks_NoneSelected\">None selected</span>\n                {{/if}}\n            </h5>\n\n            <div id=\"stmb-manual-controls\" style=\"display: {{#if manualModeEnabled}}block{{else}}none{{/if}};\">\n                <div class=\"buttons_block marginTop5 justifyCenter gap10px whitespacenowrap\" id=\"stmb-manual-lorebook-buttons\">\n                    <!-- Manual lorebook buttons will be dynamically inserted here -->\n                </div>\n            </div>\n\n            <div id=\"stmb-automatic-info\" class=\"marginTop5\" style=\"display: {{#if manualModeEnabled}}none{{else}}block{{/if}};\">\n                <small class=\"opacity50p\">\n                    {{#if chatBoundLorebookName}}\n                        <span data-i18n=\"STMemoryBooks_UsingChatBound\">Using chat-bound lorebook</span> \"{{chatBoundLorebookName}}\"\n                    {{else}}\n                        <span data-i18n=\"STMemoryBooks_NoChatBound\">No chat-bound lorebook. Memories will require lorebook selection.</span>\n                    {{/if}}\n                </small>\n            </div>\n        </div>\n\n        <hr class=\"marginTop10 marginBot10\">\n\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-allow-scene-overlap\" {{#if allowSceneOverlap}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_AllowSceneOverlap\">Allow scene overlap</span>\n            </label>\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_AllowSceneOverlapDesc\">Check this box to skip checking for overlapping memories/scenes.</small>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-refresh-editor\" {{#if refreshEditor}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_RefreshEditor\">Refresh lorebook editor after adding memories</span>\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-max-tokens\">\n                <h4 data-i18n=\"STMemoryBooks_MaxTokens\">Max Tokens:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_MaxTokensDesc\">Maximum number of tokens to use for memory summaries.</small>\n                <input type=\"number\" id=\"stmb-max-tokens\" class=\"text_pole\"\n                    value=\"{{maxTokens}}\" min=\"0\" step=\"1\"\n                    placeholder=\"4000\">\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-auto-summary-enabled\" {{#if autoSummaryEnabled}}checked{{/if}}>\n                <span data-i18n=\"STMemoryBooks_AutoSummaryEnabled\">Auto-create memory summaries</span>\n            </label>\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_AutoSummaryDesc;[title]STMemoryBooks_AutoSummaryWarnTooltip\" title=\"Warning: enabling Auto-Summary may create one large memory from the existing backlog. Use /stmb-set-highest &lt;N|none&gt; to control the baseline.\">Automatically run /nextmemory after a specified number of messages.</small>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-auto-summary-interval\">\n                <h4 data-i18n=\"STMemoryBooks_AutoSummaryInterval\">Auto-Summary Interval:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_AutoSummaryIntervalDesc\">Number of messages after which to automatically create a memory summary.</small>\n                <input type=\"number\" id=\"stmb-auto-summary-interval\" class=\"text_pole\"\n                    value=\"{{autoSummaryInterval}}\" min=\"10\" max=\"200\" step=\"1\"\n                    placeholder=\"50\">\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-auto-summary-buffer\">\n                <h4 data-i18n=\"STMemoryBooks_AutoSummaryBuffer\">Auto-Summary Buffer:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_AutoSummaryBufferDesc\">Delay auto-summary by X messages (belated generation). Default 2, max 50.</small>\n                <input type=\"number\" id=\"stmb-auto-summary-buffer\" class=\"text_pole\"\n                    value=\"{{autoSummaryBuffer}}\" min=\"0\" max=\"50\" step=\"1\" placeholder=\"0\">\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-default-memory-count\">\n                <h4 data-i18n=\"STMemoryBooks_DefaultMemoryCount\">Default Previous Memories Count:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_DefaultMemoryCountDesc\">Default number of previous memories to include as context when creating new memories.</small>\n                <select id=\"stmb-default-memory-count\" class=\"text_pole\">\n                    <option value=\"0\" {{#if (eq defaultMemoryCount 0)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount0\">None (0 memories)</option>\n                    <option value=\"1\" {{#if (eq defaultMemoryCount 1)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount1\">Last 1 memory</option>\n                    <option value=\"2\" {{#if (eq defaultMemoryCount 2)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount2\">Last 2 memories</option>\n                    <option value=\"3\" {{#if (eq defaultMemoryCount 3)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount3\">Last 3 memories</option>\n                    <option value=\"4\" {{#if (eq defaultMemoryCount 4)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount4\">Last 4 memories</option>\n                    <option value=\"5\" {{#if (eq defaultMemoryCount 5)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount5\">Last 5 memories</option>\n                    <option value=\"6\" {{#if (eq defaultMemoryCount 6)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount6\">Last 6 memories</option>\n                    <option value=\"7\" {{#if (eq defaultMemoryCount 7)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount7\">Last 7 memories</option>\n                </select>\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-auto-hide-mode\">\n                <h4 data-i18n=\"STMemoryBooks_AutoHideMode\">Auto-hide messages after adding memory:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_AutoHideModeDesc\">Choose what messages to automatically hide after creating a memory.</small>\n                <select id=\"stmb-auto-hide-mode\" class=\"text_pole\">\n                    <option value=\"none\" {{#if (eq autoHideMode \"none\")}}selected{{/if}} data-i18n=\"STMemoryBooks_AutoHideNone\">Do not auto-hide</option>\n                    <option value=\"all\" {{#if (eq autoHideMode \"all\")}}selected{{/if}} data-i18n=\"STMemoryBooks_AutoHideAll\">Auto-hide all messages up to the last memory</option>\n                    <option value=\"last\" {{#if (eq autoHideMode \"last\")}}selected{{/if}} data-i18n=\"STMemoryBooks_AutoHideLast\">Auto-hide only messages in the last memory</option>\n                </select>\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-unhidden-entries-count\">\n                <h4 data-i18n=\"STMemoryBooks_UnhiddenCount\">Messages to leave unhidden:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_UnhiddenCountDesc\">Number of recent messages to leave visible when auto-hiding (0 = hide all up to scene end)</small>\n                <input type=\"number\" id=\"stmb-unhidden-entries-count\" class=\"text_pole\"\n                    value=\"{{unhiddenEntriesCount}}\" min=\"0\" max=\"50\" step=\"1\"\n                    placeholder=\"2\">\n            </label>\n        </div>\n        \n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-token-warning-threshold\">\n                <h4 data-i18n=\"STMemoryBooks_TokenWarning\">Token Warning Threshold:</h4>\n                <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_TokenWarningDesc\">Show confirmation dialog when estimated input tokens exceed this threshold. Default: 30,000</small>\n                <input type=\"number\" id=\"stmb-token-warning-threshold\" class=\"text_pole\"\n                    value=\"{{tokenWarningThreshold}}\" min=\"1000\" max=\"200000\" step=\"1000\"\n                    placeholder=\"30000\">\n            </label>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <h4 data-i18n=\"STMemoryBooks_TitleFormat\">Memory Title Format:</h4>\n            <select id=\"stmb-title-format-select\" class=\"text_pole\">\n                {{#each titleFormats}}\n                <option value=\"{{value}}\" {{#if isSelected}}selected{{/if}}>{{value}}</option>\n                {{/each}}\n                <option value=\"custom\" data-i18n=\"STMemoryBooks_CustomTitleFormat\">Custom Title Format...</option>\n            </select>\n            <input type=\"text\" id=\"stmb-custom-title-format\" class=\"text_pole marginTop5 {{#unless showCustomInput}}displayNone{{/unless}}\"\n                data-i18n=\"[placeholder]STMemoryBooks_EnterCustomFormat\" placeholder=\"Enter custom format\" value=\"{{titleFormat}}\">\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_TitleFormatDesc\">Use [0], [00], [000] for auto-numbering. Available: \\{{title}}, \\{{scene}}, &#123;&#123;char}}, &#123;&#123;user}}, \\{{messages}}, \\{{profile}}, &#123;&#123;date}}, &#123;&#123;time}}</small>\n        </div>\n\n        <div class=\"world_entry_form_control\" class=\"flex-container\">\n            <div class=\"flex flexFlowRow alignItemsBaseline\">\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-use-regex\" {{#if useRegex}}checked{{/if}}>\n                    <span data-i18n=\"STMemoryBooks_UseRegexAdvanced\">Use regex (advanced)</span>\n                </label>\n            </div>\n            <div class=\"flex flexFlowRow buttons_block marginTop5 justifyCenter gap10px whitespacenowrap\">\n                <button id=\"stmb-configure-regex\" class=\"menu_button whitespacenowrap\" style=\"{{#unless useRegex}}display:none;{{/unless}}\" data-i18n=\"STMemoryBooks_ConfigureRegex\">\n                     Configure regex\n                </button>\n            </div>\n            <small class=\"opacity70p\" data-i18n=\"STMemoryBooks_RegexSelection_Desc\">Selecting a regex here will run it REGARDLESS of whether it is enabled or disabled.</small>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <h4 data-i18n=\"STMemoryBooks_Profiles\">Memory Profiles:</h4>\n            <select id=\"stmb-profile-select\" class=\"text_pole\">\n                {{#each profiles}}\n                <option value=\"{{@index}}\" {{#if isDefault}}selected{{/if}}>{{name}}{{#if isDefault}} (Default){{/if}}</option>\n                {{/each}}\n            </select>\n        </div>\n\n        <div id=\"stmb-profile-summary\" class=\"padding10 marginBot10\">\n            <div class=\"marginBot5\" data-i18n=\"STMemoryBooks_ProfileSettings\">Profile Settings:</div>\n            <div><span data-i18n=\"STMemoryBooks_Provider\">Provider</span>: <span id=\"stmb-summary-api\">{{selectedProfile.connection.api}}</span></div>\n            <div><span data-i18n=\"STMemoryBooks_Model\">Model</span>: <span id=\"stmb-summary-model\">{{selectedProfile.connection.model}}</span></div>\n            <div><span data-i18n=\"STMemoryBooks_Temperature\">Temperature</span>: <span id=\"stmb-summary-temp\">{{selectedProfile.connection.temperature}}</span></div>\n            <div><span data-i18n=\"STMemoryBooks_TitleFormat\">Title Format</span>: <span id=\"stmb-summary-title\">{{selectedProfile.titleFormat}}</span></div>\n            <details class=\"marginTop10\">\n                <summary data-i18n=\"STMemoryBooks_ViewPrompt\">View Prompt</summary>\n                <div class=\"padding10 marginTop5 stmb-box\">\n                    <pre><code id=\"stmb-summary-prompt\">{{selectedProfile.effectivePrompt}}</code></pre>\n                </div>\n            </details>\n        </div>\n\n        <h4 data-i18n=\"STMemoryBooks_ProfileActions\">Profile Actions:</h4>\n        <div class=\"buttons_block marginTop5 justifyCenter gap10px whitespacenowrap\" id=\"stmb-profile-buttons\">\n            <!-- Profile buttons will be dynamically inserted here -->\n        </div>\n\n        <h4 data-i18n=\"STMemoryBooks_extraFunctionButtons\">Extra Function Buttons:</h4>\n        <input type=\"file\" id=\"stmb-import-file\" accept=\".json\" class=\"displayNone\">\n        <div class=\"buttons_block marginTop5 justifyCenter gap10px whitespacenowrap\" id=\"stmb-extra-function-buttons\">\n            <!-- extra function buttons will be dynamically inserted here -->\n        </div>\n\n        <div class=\"info-block\">\n            <h4 data-i18n=\"STMemoryBooks_promptManagerButtons\">Prompt Managers</h4>\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_PromptManagerButtonsHint\">Want to tweak things? Use the buttons below to customize each prompt type.</small>\n            <div class=\"buttons_block marginTop5 justifyCenter gap10px whitespacenowrap\" id=\"stmb-prompt-manager-buttons\">\n                <!-- prompt manager buttons will be dynamically inserted here -->\n            </div>\n        </div>\n\n`);\n\n/**\n * Simplified confirmation popup template\n */\nexport const simpleConfirmationTemplate = Handlebars.compile(`\n    <h3 data-i18n=\"STMemoryBooks_CreateMemory\">Create Memory</h3>\n    <div id=\"stmb-scene\" class=\"padding10 marginBot10\">\n        <div class=\"marginBot5\" data-i18n=\"STMemoryBooks_ScenePreview\">Scene Preview:</div>\n        <div class=\"padding10 marginTop5 stmb-box\">\n            <pre><code id=\"stmb-scene-block\"><span data-i18n=\"STMemoryBooks_Start\">Start</span>: <span data-i18n=\"STMemoryBooks_Message\">Message</span> #{{sceneStart}} ({{startSpeaker}})\n{{startExcerpt}}\n\n<span data-i18n=\"STMemoryBooks_End\">End</span>: <span data-i18n=\"STMemoryBooks_Message\">Message</span> #{{sceneEnd}} ({{endSpeaker}})\n{{endExcerpt}}\n\n<span data-i18n=\"STMemoryBooks_Messages\">Messages</span>: {{messageCount}} | <span data-i18n=\"STMemoryBooks_EstimatedTokens\">Estimated tokens</span>: {{estimatedTokens}}</code></pre>\n        </div>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <h5><span data-i18n=\"STMemoryBooks_UsingProfile\">Using Profile</span>: <span class=\"success\">{{profileName}}</span></h5>\n\n        <div id=\"stmb-profile-summary\" class=\"padding10 marginBot10\">\n            <div class=\"marginBot5\" data-i18n=\"STMemoryBooks_ProfileSettings\">Profile Settings:</div>\n            <div><span data-i18n=\"STMemoryBooks_Model\">Model</span>: <span id=\"stmb-summary-model\">{{profileModel}}</span></div>\n            <div><span data-i18n=\"STMemoryBooks_Temperature\">Temperature</span>: <span id=\"stmb-summary-temp\">{{profileTemperature}}</span></div>\n            <details class=\"marginTop10\">\n                <summary data-i18n=\"STMemoryBooks_ViewPrompt\">View Prompt</summary>\n                <div class=\"padding10 marginTop5 stmb-box\">\n                    <pre><code id=\"stmb-summary-prompt\">{{effectivePrompt}}</code></pre>\n                </div>\n            </details>\n        </div>\n    </div>\n\n    {{#if showWarning}}\n    <div class=\"info-block warning marginTop10\">\n         <span data-i18n=\"STMemoryBooks_LargeSceneWarning\">Large scene</span> ({{estimatedTokens}} tokens) <span data-i18n=\"STMemoryBooks_MayTakeTime\">may take some time to process.</span>\n    </div>\n    {{/if}}\n\n    <div class=\"marginTop10 opacity50p fontsize90p\" data-i18n=\"STMemoryBooks_AdvancedOptionsHint\">\n        Click \"Advanced Options\" to customize prompt, context memories, or API settings.\n    </div>\n`);\n\n/**\n * Advanced options popup template\n */\nexport const advancedOptionsTemplate = Handlebars.compile(`\n    <h3 data-i18n=\"STMemoryBooks_AdvancedOptions\">Advanced Memory Options</h3>\n    <div class=\"world_entry_form_control\">\n        <h4 data-i18n=\"STMemoryBooks_SceneInformation\">Scene Information:</h4>\n        <div class=\"padding10 marginBot15\" style=\"background-color: var(--SmartThemeBlurTintColor); border-radius: 5px;\">\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Messages\">Messages</span> {{sceneStart}}-{{sceneEnd}} ({{messageCount}} <span data-i18n=\"STMemoryBooks_Total\">total</span>)</div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_BaseTokens\">Base tokens</span>: {{estimatedTokens}}</div>\n            <div class=\"fontsize90p\" id=\"stmb-total-tokens-display\"><span data-i18n=\"STMemoryBooks_TotalTokens\">Total tokens</span>: {{estimatedTokens}}</div>\n        </div>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <label for=\"stmb-profile-select-advanced\">\n            <h4 data-i18n=\"STMemoryBooks_Profile\">Profile:</h4>\n            <small data-i18n=\"STMemoryBooks_ChangeProfileDesc\">Change the profile to use different base settings.</small>\n            <select id=\"stmb-profile-select-advanced\" class=\"text_pole\">\n                {{#each profiles}}\n                <option value=\"{{@index}}\" {{#if isDefault}}selected{{/if}}>{{name}}{{#if isDefault}} (Default){{/if}}</option>\n                {{/each}}\n            </select>\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <label for=\"stmb-effective-prompt-advanced\">\n            <h4 data-i18n=\"STMemoryBooks_MemoryCreationPrompt\">Memory Creation Prompt:</h4>\n            <small data-i18n=\"STMemoryBooks_CustomizePromptDesc\">Customize the prompt used to generate this memory.</small>\n            <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-effective-prompt-advanced\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\n            <textarea id=\"stmb-effective-prompt-advanced\" class=\"text_pole textarea_compact\" rows=\"6\" data-i18n=\"[placeholder]STMemoryBooks_MemoryPromptPlaceholder\" placeholder=\"Memory creation prompt\">{{effectivePrompt}}</textarea>\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <label for=\"stmb-context-memories-advanced\">\n            <h4 data-i18n=\"STMemoryBooks_IncludePreviousMemories\">Include Previous Memories as Context:</h4>\n            <small>\n                <span data-i18n=\"STMemoryBooks_PreviousMemoriesDesc\">Previous memories provide context for better continuity.</span>\n                {{#if availableMemories}}\n                <br><span data-i18n=\"STMemoryBooks_Found\">Found</span> {{availableMemories}} {{#if (eq availableMemories 1)}}<span data-i18n=\"STMemoryBooks_ExistingMemorySingular\">existing memory in lorebook.</span>{{else}}<span data-i18n=\"STMemoryBooks_ExistingMemoriesPlural\">existing memories in lorebook.</span>{{/if}}\n                {{else}}\n                <br><span data-i18n=\"STMemoryBooks_NoMemoriesFound\">No existing memories found in lorebook.</span>\n                {{/if}}\n            </small>\n            <select id=\"stmb-context-memories-advanced\" class=\"text_pole\">\n                <option value=\"0\" {{#if (eq defaultMemoryCount 0)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount0\">None (0 memories)</option>\n                <option value=\"1\" {{#if (eq defaultMemoryCount 1)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount1\">Last 1 memory</option>\n                <option value=\"2\" {{#if (eq defaultMemoryCount 2)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount2\">Last 2 memories</option>\n                <option value=\"3\" {{#if (eq defaultMemoryCount 3)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount3\">Last 3 memories</option>\n                <option value=\"4\" {{#if (eq defaultMemoryCount 4)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount4\">Last 4 memories</option>\n                <option value=\"5\" {{#if (eq defaultMemoryCount 5)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount5\">Last 5 memories</option>\n                <option value=\"6\" {{#if (eq defaultMemoryCount 6)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount6\">Last 6 memories</option>\n                <option value=\"7\" {{#if (eq defaultMemoryCount 7)}}selected{{/if}} data-i18n=\"STMemoryBooks_MemoryCount7\">Last 7 memories</option>\n            </select>\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <h4 data-i18n=\"STMemoryBooks_APIOverride\">API Override Settings:</h4>\n\n        <div class=\"padding10 marginBot10\" style=\"background-color: var(--SmartThemeBlurTintColor); border-radius: 5px; filter: brightness(1.2);\">\n            <div class=\"marginBot5\" data-i18n=\"STMemoryBooks_ProfileSettings\">Profile Settings:</div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Model\">Model</span>: <span class=\"success\" id=\"stmb-profile-model-display\">{{profileModel}}</span></div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Temperature\">Temperature</span>: <span class=\"success\" id=\"stmb-profile-temp-display\">{{profileTemperature}}</span></div>\n        </div>\n\n        <div class=\"padding10 marginBot10\" style=\"background-color: var(--SmartThemeBlurTintColor); border-radius: 5px;\">\n            <div class=\"marginBot5\" data-i18n=\"STMemoryBooks_CurrentSTSettings\">Current SillyTavern Settings:</div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Model\">Model</span>: <span style=\"color: var(--SmartThemeQuoteColor);\">{{currentModel}}</span></div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Temperature\">Temperature</span>: <span style=\"color: var(--SmartThemeQuoteColor);\">{{currentTemperature}}</span></div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_API\">API</span>: <span style=\"color: var(--SmartThemeQuoteColor);\">{{currentApi}}</span></div>\n        </div>\n\n        <label class=\"checkbox_label\">\n            <input type=\"checkbox\" id=\"stmb-override-settings-advanced\">\n            <span data-i18n=\"STMemoryBooks_UseCurrentSettings\">Use current SillyTavern settings instead of profile settings</span>\n        </label>\n        <small class=\"opacity50p marginTop5\" data-i18n=\"STMemoryBooks_OverrideDesc\">\n            Override the profile's model and temperature with your current SillyTavern settings.\n        </small>\n    </div>\n\n    <div class=\"world_entry_form_control displayNone\" id=\"stmb-save-profile-section-advanced\">\n        <h4 data-i18n=\"STMemoryBooks_SaveAsNewProfile\">Save as New Profile:</h4>\n        <label for=\"stmb-new-profile-name-advanced\">\n            <h4 data-i18n=\"STMemoryBooks_ProfileName\">Profile Name:</h4>\n            <small data-i18n=\"STMemoryBooks_SaveProfileDesc\">Your current settings differ from the selected profile. Save them as a new profile.</small>\n            <input type=\"text\" id=\"stmb-new-profile-name-advanced\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_EnterProfileName\" placeholder=\"Enter new profile name\" value=\"{{suggestedProfileName}}\">\n        </label>\n    </div>\n\n    {{#if showWarning}}\n    <div class=\"info-block warning marginTop10\" id=\"stmb-token-warning-advanced\">\n        <span data-i18n=\"STMemoryBooks_LargeSceneWarningShort\"> Large scene may take some time to process.</span>\n    </div>\n    {{/if}}\n`);\n\n/**\n * Memory preview dialog template\n */\nexport const memoryPreviewTemplate = Handlebars.compile(`\n    <h3 data-i18n=\"STMemoryBooks_MemoryPreview\"> Memory Preview</h3>\n    <div class=\"world_entry_form_control\">\n        <small class=\"marginBot10\" data-i18n=\"STMemoryBooks_MemoryPreviewDesc\">Review the generated memory below. You can edit the content while preserving the structure.</small>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <label for=\"stmb-preview-title\">\n            <h4 data-i18n=\"STMemoryBooks_MemoryTitle\">Memory Title:</h4>\n            <input type=\"text\" id=\"stmb-preview-title\" class=\"text_pole\" value=\"{{#if title}}{{title}}{{else}}Memory{{/if}}\" data-i18n=\"[placeholder]STMemoryBooks_MemoryTitlePlaceholder\" placeholder=\"Memory title\" {{#if titleReadonly}}readonly disabled{{/if}}>\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <label for=\"stmb-preview-content\">\n            <h4 data-i18n=\"STMemoryBooks_MemoryContent\">Memory Content:</h4>\n            <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-preview-content\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\n            <textarea id=\"stmb-preview-content\" class=\"text_pole textarea_compact\" rows=\"8\" data-i18n=\"[placeholder]STMemoryBooks_MemoryContentPlaceholder\" placeholder=\"Memory content\">{{#if content}}{{content}}{{else}}{{/if}}</textarea>\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <label for=\"stmb-preview-keywords\">\n            <h4 data-i18n=\"STMemoryBooks_Keywords\">Keywords:</h4>\n            <small class=\"opacity50p\" data-i18n=\"STMemoryBooks_KeywordsDesc\">Separate keywords with commas</small>\n            <input type=\"text\" id=\"stmb-preview-keywords\" class=\"text_pole\" value=\"{{#if keywordsText}}{{keywordsText}}{{else}}{{/if}}\" data-i18n=\"[placeholder]STMemoryBooks_KeywordsPlaceholder\" placeholder=\"keyword1, keyword2, keyword3\">\n        </label>\n    </div>\n\n    <div class=\"world_entry_form_control\">\n        <h4 data-i18n=\"STMemoryBooks_SceneInformation\">Scene Information:</h4>\n        <div class=\"padding10 marginBot10 stmb-box\">\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Messages\">Messages</span>: {{#if sceneStart}}{{sceneStart}}{{else}}?{{/if}}-{{#if sceneEnd}}{{sceneEnd}}{{else}}?{{/if}} ({{#if messageCount}}{{messageCount}}{{else}}?{{/if}} <span data-i18n=\"STMemoryBooks_Total\">total</span>)</div>\n            <div class=\"fontsize90p\"><span data-i18n=\"STMemoryBooks_Profile\">Profile</span>: {{#if profileName}}{{profileName}}{{else}}<span data-i18n=\"STMemoryBooks_UnknownProfile\">Unknown Profile</span>{{/if}}</div>\n        </div>\n    </div>\n`);\n",
    "import { saveSettingsDebounced } from '../../../../script.js';\r\nimport { Popup, POPUP_TYPE, POPUP_RESULT } from '../../../popup.js';\r\nimport { DOMPurify } from '../../../../lib.js';\r\nimport { simpleConfirmationTemplate, advancedOptionsTemplate, memoryPreviewTemplate } from './templates.js';\r\nimport { translate } from '../../../i18n.js';\r\nimport { loadWorldInfo } from '../../../world-info.js';\r\nimport { identifyMemoryEntries } from './addlore.js';\r\nimport { createProfileObject, getUIModelSettings, getCurrentApiInfo, getEffectivePrompt, generateSafeProfileName, getEffectiveLorebookName } from './utils.js';\r\nimport { playMessageSound } from '../../../power-user.js';\r\n\r\nconst MODULE_NAME = 'STMemoryBooks-ConfirmationPopup';\r\n\r\n// Helper: keyed translation with Mustache-style interpolation using ST translate()\r\nfunction tr(key, fallback, params) {\r\n  const localized = translate(fallback, key);\r\n  if (!params) return localized;\r\n  return localized.replace(/{{\\s*(\\w+)\\s*}}/g, (m, p1) => {\r\n    const v = params[p1];\r\n    return v !== undefined && v !== null ? String(v) : '';\r\n  });\r\n}\r\n\r\n// Define semantic mappings for custom popup results using SillyTavern's provided constants\r\nconst STMB_POPUP_RESULTS = {\r\n  ADVANCED: POPUP_RESULT.CUSTOM1,\r\n  SAVE_PROFILE: POPUP_RESULT.CUSTOM2,\r\n  EDIT: POPUP_RESULT.CUSTOM3,\r\n  RETRY: POPUP_RESULT.CUSTOM4\r\n};\r\n\r\n/**\r\n * Plays the messagePopupSound in a safe manner, not blocking anything else if the playback fails\r\n */\r\nfunction safePlayMessageSound() {\r\n  try {\r\n    // Play notification sound when popup appears\r\n    playMessageSound();\r\n  } catch (error) {\r\n    console.error(\"playMessageSound failed\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Show simplified confirmation popup for memory creation\r\n */\r\nexport async function showConfirmationPopup(sceneData, settings, currentModelSettings, currentApiInfo, chat_metadata, selectedProfileIndex = null) {\r\n  const profileIndex = selectedProfileIndex !== null ? selectedProfileIndex : settings.defaultProfile;\r\n  const selectedProfile = settings.profiles[profileIndex];\r\n  const effectivePrompt = await getEffectivePrompt(selectedProfile);\r\n  const templateData = {\n    ...sceneData,\n    profileName: (selectedProfile?.isBuiltinCurrentST) ? translate('Current SillyTavern Settings', 'STMemoryBooks_Profile_CurrentST') : selectedProfile.name,\n    effectivePrompt: effectivePrompt,\n    profileModel: (selectedProfile.useDynamicSTSettings || (selectedProfile?.connection?.api === 'current_st')) ?\n      translate('Current SillyTavern model', 'STMemoryBooks_Label_CurrentSTModel') : (selectedProfile.connection?.model || translate('Current SillyTavern model', 'STMemoryBooks_Label_CurrentSTModel')),\n    profileTemperature: (selectedProfile.useDynamicSTSettings || (selectedProfile?.connection?.api === 'current_st')) ?\n      translate('Current SillyTavern temperature', 'STMemoryBooks_Label_CurrentSTTemperature') : (selectedProfile.connection?.temperature !== undefined ?\n        selectedProfile.connection.temperature : translate('Current SillyTavern temperature', 'STMemoryBooks_Label_CurrentSTTemperature')),\n    currentModel: currentModelSettings?.model || translate('Unknown', 'common.unknown'),\r\n    currentTemperature: currentModelSettings?.temperature ?? 0.7,\r\n    currentApi: currentApiInfo?.api || translate('Unknown', 'common.unknown'),\r\n    tokenThreshold: settings.moduleSettings.tokenWarningThreshold ?? 30000,\r\n    showWarning: sceneData.estimatedTokens > (settings.moduleSettings.tokenWarningThreshold ?? 30000),\r\n    profiles: settings.profiles.map((profile, index) => ({\n      ...profile,\n      name: (profile?.isBuiltinCurrentST) ? translate('Current SillyTavern Settings', 'STMemoryBooks_Profile_CurrentST') : profile.name,\n      isDefault: index === settings.defaultProfile,\n      isSelected: index === profileIndex\n    }))\n  };\n\r\n  const content = DOMPurify.sanitize(simpleConfirmationTemplate(templateData));\r\n\r\n  safePlayMessageSound();\r\n\r\n  try {\r\n    const popup = new Popup(content, POPUP_TYPE.TEXT, '', {\r\n      okButton: translate('Create Memory', 'STMemoryBooks_CreateMemory'),\r\n      cancelButton: translate('Cancel', 'STMemoryBooks_Cancel'),\r\n      allowVerticalScrolling: true,\r\n      wide: false,\r\n      customButtons: [\r\n        {\r\n          text: translate('Advanced Options...', 'STMemoryBooks_Button_AdvancedOptions'),\r\n          result: STMB_POPUP_RESULTS.ADVANCED,\r\n          classes: ['menu_button', 'whitespacenowrap'],\r\n          action: null\r\n        }\r\n      ]\r\n    });\r\n\r\n    const result = await popup.show();\r\n\r\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n      return {\r\n        confirmed: true,\r\n        profileSettings: {\r\n          ...selectedProfile,\r\n          effectivePrompt: effectivePrompt\r\n        },\r\n        advancedOptions: {\r\n          memoryCount: settings.moduleSettings.defaultMemoryCount ?? 0,\r\n          overrideSettings: false\r\n        }\r\n      };\r\n    } else if (result === STMB_POPUP_RESULTS.ADVANCED) {\r\n      const advancedResult = await showAdvancedOptionsPopup(\r\n        sceneData,\r\n        settings,\r\n        selectedProfile,\r\n        currentModelSettings,\r\n        currentApiInfo,\r\n        chat_metadata\r\n      );\r\n      return advancedResult;\r\n    }\r\n\r\n    return { confirmed: false };\r\n  } catch (error) {\r\n    return { confirmed: false };\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Show advanced options popup for memory creation\r\n */\r\nexport async function showAdvancedOptionsPopup(sceneData, settings, selectedProfile, currentModelSettings, currentApiInfo, chat_metadata) {\r\n  // Get available memories count\r\n  const availableMemories = await getAvailableMemoriesCount(settings, chat_metadata);\r\n\r\n  const effectivePrompt = await getEffectivePrompt(selectedProfile);\r\n  const profileModel = selectedProfile.connection?.model || translate('Current SillyTavern model', 'STMemoryBooks_Label_CurrentSTModel');\r\n  const profileTemperature = selectedProfile.connection?.temperature !== undefined ?\r\n    selectedProfile.connection.temperature : translate('Current SillyTavern temperature', 'STMemoryBooks_Label_CurrentSTTemperature');\r\n\r\n  const templateData = {\r\n    ...sceneData,\r\n    availableMemories: availableMemories,\r\n    profiles: settings.profiles.map((profile, index) => ({\n      ...profile,\n      name: (profile?.isBuiltinCurrentST) ? translate('Current SillyTavern Settings', 'STMemoryBooks_Profile_CurrentST') : profile.name,\n      isDefault: index === settings.defaultProfile\n    })),\n    effectivePrompt: effectivePrompt,\r\n    defaultMemoryCount: settings.moduleSettings.defaultMemoryCount ?? 0,\r\n    profileModel: profileModel,\r\n    profileTemperature: profileTemperature,\r\n    currentModel: currentModelSettings?.model || translate('Unknown', 'common.unknown'),\r\n    currentTemperature: currentModelSettings?.temperature ?? 0.7,\r\n    currentApi: currentApiInfo?.api || translate('Unknown', 'common.unknown'),\r\n    suggestedProfileName: tr('STMemoryBooks_ModifiedProfileName', '{{name}} - Modified', { name: selectedProfile.name }),\r\n    tokenThreshold: settings.moduleSettings.tokenWarningThreshold ?? 30000,\r\n    showWarning: sceneData.estimatedTokens > (settings.moduleSettings.tokenWarningThreshold ?? 30000)\r\n  };\r\n\r\n  const content = DOMPurify.sanitize(advancedOptionsTemplate(templateData));\r\n\r\n  // Play notification sound when popup appears\r\n  safePlayMessageSound();\r\n\r\n  try {\r\n    const popup = new Popup(content, POPUP_TYPE.TEXT, '', {\r\n      okButton: translate('Create Memory', 'STMemoryBooks_Button_CreateMemory'),\r\n      cancelButton: translate('Cancel', 'STMemoryBooks_Cancel'),\r\n      wide: true,\r\n      large: true,\r\n      allowVerticalScrolling: true,\r\n      customButtons: [\r\n        {\r\n          text: translate('Save as New Profile', 'STMemoryBooks_Button_SaveAsNewProfile'),\r\n          result: STMB_POPUP_RESULTS.SAVE_PROFILE,\r\n          classes: ['menu_button', 'whitespacenowrap'],\r\n          action: null\r\n        }\r\n      ]\r\n    });\r\n\r\n    // Set up event listeners BEFORE popup is shown\r\n    setupAdvancedOptionsListeners(popup, sceneData, settings, selectedProfile, chat_metadata);\r\n\r\n    const result = await popup.show();\r\n\r\n    // Handle different results\r\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\r\n      return await handleAdvancedConfirmation(popup, settings);\r\n    } else if (result === STMB_POPUP_RESULTS.SAVE_PROFILE) {\r\n      return await handleSaveNewProfile(popup, settings);\r\n    }\r\n\r\n    return { confirmed: false };\r\n  } catch (error) {\r\n    return { confirmed: false };\r\n  }\r\n}\r\n\r\n/**\r\n * Handle advanced options confirmation - Enhanced to handle dynamic button behavior\r\n */\r\nasync function handleAdvancedConfirmation(popup, settings) {\r\n  const popupElement = popup.dlg;\r\n  const selectedProfileIndex = Number(popupElement.querySelector('#stmb-profile-select-advanced').value);\r\n  const customPrompt = popupElement.querySelector('#stmb-effective-prompt-advanced')?.value;\r\n  const memoryCount = Number(popupElement.querySelector('#stmb-context-memories-advanced').value);\r\n  const overrideSettings = popupElement.querySelector('#stmb-override-settings-advanced')?.checked || false;\r\n\r\n  // Check if settings should be saved as new profile (when button text indicates it)\r\n  const createButton = popup.dlg.querySelector('.popup_button_ok');\r\n  const shouldSaveProfile = createButton?.dataset.shouldSave === 'true';\r\n\r\n  if (shouldSaveProfile) {\r\n    const newProfileName = popupElement.querySelector('#stmb-new-profile-name-advanced').value.trim();\r\n    if (newProfileName) {\r\n      try {\r\n        await saveNewProfileFromAdvancedSettings(popupElement, settings, newProfileName);\r\n        toastr.success(tr('STMemoryBooks_Toast_ProfileSaved', 'Profile \"{{name}}\" saved successfully', { name: newProfileName }), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n      } catch (error) {\r\n        console.error(translate(`${MODULE_NAME}: Failed to save profile:`, 'confirmationPopup.log.saveFailed'), error);\r\n        toastr.error(tr('STMemoryBooks_Toast_ProfileSaveFailed', 'Failed to save profile: {{message}}', { message: error.message }), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n        // Continues with memory creation even if profile save fails\r\n      }\r\n    } else {\r\n      // No profile name provided, show error and don't proceed\r\n      console.error(translate(`${MODULE_NAME}: Profile creation cancelled - no name provided`, 'confirmationPopup.log.saveCancelledNoName'));\r\n      toastr.error(translate('Please enter a profile name or use \"Create Memory\" to proceed without saving', 'STMemoryBooks_Toast_ProfileNameOrProceed'), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n      return { confirmed: false };\r\n    }\r\n  }\r\n\r\n  // Build effective profile settings\r\n  const baseProfile = settings.profiles[selectedProfileIndex];\r\n  const profileSettings = {\r\n    ...baseProfile,\r\n    prompt: customPrompt || baseProfile.prompt,\r\n    effectiveConnection: { ...baseProfile.connection } // Start with a copy of base connection\r\n  };\r\n\r\n  // Determine effective connection settings\r\n  if (overrideSettings) {\r\n    const currentSettings = getUIModelSettings();\r\n    const currentApiInfo = getCurrentApiInfo();\r\n\r\n    if (currentApiInfo.api) {\r\n      profileSettings.effectiveConnection.api = currentApiInfo.api; // Override API\r\n    }\r\n    if (currentSettings.model) {\r\n      profileSettings.effectiveConnection.model = currentSettings.model; // Override Model\r\n    }\r\n    if (typeof currentSettings.temperature === 'number') {\r\n      profileSettings.effectiveConnection.temperature = currentSettings.temperature; // Override Temp\r\n    }\r\n  }\r\n\r\n  return {\r\n    confirmed: true,\r\n    profileSettings: profileSettings,\r\n    advancedOptions: {\r\n      memoryCount: memoryCount,\r\n      overrideSettings: overrideSettings\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Handle saving new profile from advanced options\r\n */\r\nasync function handleSaveNewProfile(popup, settings) {\r\n  const newProfileName = popup.dlg.querySelector('#stmb-new-profile-name-advanced').value.trim();\r\n  if (!newProfileName) {\r\n    console.error(translate(`${MODULE_NAME}: Profile name validation failed - empty name`, 'confirmationPopup.log.validationFailedEmptyName'));\r\n    toastr.error(translate('Please enter a profile name', 'STMemoryBooks_Toast_ProfileNameRequired'), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n    return { confirmed: false };\r\n  }\r\n\r\n  await saveNewProfileFromAdvancedSettings(popup.dlg, settings, newProfileName);\r\n  toastr.success(tr('STMemoryBooks_Toast_ProfileSaved', 'Profile \"{{name}}\" saved successfully', { name: newProfileName }), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n  return { confirmed: false }; // Don't create memory, just save profile\r\n}\r\n\r\n/**\r\n * Setup event listeners for advanced options popup - Enhanced with dynamic button text\r\n */\r\nfunction setupAdvancedOptionsListeners(popup, sceneData, settings, selectedProfile, chat_metadata) {\r\n  const popupElement = popup.dlg;\r\n\r\n  // Track original settings for comparison\r\n  const originalSettings = {\r\n    prompt: popupElement.querySelector('#stmb-effective-prompt-advanced').value,\r\n    memoryCount: parseInt(popupElement.querySelector('#stmb-context-memories-advanced').value),\r\n    overrideSettings: popupElement.querySelector('#stmb-override-settings-advanced').checked,\r\n    profileIndex: parseInt(popupElement.querySelector('#stmb-profile-select-advanced').value)\r\n  };\r\n\r\n  // Function to check if settings have changed and update button text\r\n  const checkForChanges = () => {\r\n    const currentPrompt = popupElement.querySelector('#stmb-effective-prompt-advanced').value;\r\n    const currentMemoryCount = parseInt(popupElement.querySelector('#stmb-context-memories-advanced').value);\r\n    const currentOverride = popupElement.querySelector('#stmb-override-settings-advanced').checked;\r\n    const currentProfileIndex = parseInt(popupElement.querySelector('#stmb-profile-select-advanced').value);\r\n\r\n    const hasChanges = currentPrompt !== originalSettings.prompt ||\r\n      currentMemoryCount !== originalSettings.memoryCount ||\r\n      currentOverride !== originalSettings.overrideSettings ||\r\n      currentProfileIndex !== originalSettings.profileIndex;\r\n\r\n    const saveSection = popupElement.querySelector('#stmb-save-profile-section-advanced');\r\n\r\n    // Update button text based on whether settings have changed\r\n    const createButton = popup.dlg.querySelector('.popup_button_ok');\r\n    if (createButton) {\r\n      if (hasChanges) {\r\n        createButton.textContent = translate('Save Profile & Create Memory', 'STMemoryBooks_SaveProfileAndCreateMemory');\r\n        createButton.title = translate('Save the modified settings as a new profile and create the memory', 'STMemoryBooks_Tooltip_SaveProfileAndCreateMemory');\r\n        createButton.dataset.shouldSave = 'true';\r\n      } else {\r\n        createButton.textContent = translate('Create Memory', 'STMemoryBooks_CreateMemory');\r\n        createButton.title = translate('Create memory using the selected profile settings', 'STMemoryBooks_Tooltip_CreateMemory');\r\n        createButton.dataset.shouldSave = 'false';\r\n      }\r\n    }\r\n\r\n    if (hasChanges) {\r\n      saveSection.style.display = 'block';\r\n    } else {\r\n      saveSection.style.display = 'none';\r\n    }\r\n  };\r\n\r\n  // Add change listeners with immediate button text update\r\n  popupElement.querySelector('#stmb-effective-prompt-advanced')?.addEventListener('input', checkForChanges);\r\n  popupElement.querySelector('#stmb-context-memories-advanced')?.addEventListener('change', checkForChanges);\r\n  popupElement.querySelector('#stmb-override-settings-advanced')?.addEventListener('change', checkForChanges);\r\n  popupElement.querySelector('#stmb-profile-select-advanced')?.addEventListener('change', async (e) => {\r\n    const newProfileIndex = parseInt(e.target.value);\r\n    const newProfile = settings.profiles[newProfileIndex];\r\n\r\n    // Update effective prompt\r\n    const newEffectivePrompt = await getEffectivePrompt(newProfile);\r\n    popupElement.querySelector('#stmb-effective-prompt-advanced').value = newEffectivePrompt;\r\n\r\n    // Update profile settings display\r\n    const profileModelDisplay = popupElement.querySelector('#stmb-profile-model-display');\r\n    const profileTempDisplay = popupElement.querySelector('#stmb-profile-temp-display');\r\n\r\n    if (profileModelDisplay) {\r\n      profileModelDisplay.textContent = newProfile.connection?.model || translate('Current SillyTavern model', 'STMemoryBooks_Label_CurrentSTModel');\r\n    }\r\n    if (profileTempDisplay) {\r\n      profileTempDisplay.textContent = newProfile.connection?.temperature !== undefined ?\r\n        newProfile.connection.temperature : translate('Current SillyTavern temperature', 'STMemoryBooks_Label_CurrentSTTemperature');\r\n    }\r\n\r\n    // Update original settings for comparison\r\n    originalSettings.prompt = newEffectivePrompt;\r\n    originalSettings.profileIndex = newProfileIndex;\r\n    checkForChanges();\r\n  });\r\n\r\n  // Enhanced token estimation with context memories\r\n  setupTokenEstimation(popupElement, sceneData, settings, chat_metadata, checkForChanges);\r\n\r\n  // Initial button text check\r\n  checkForChanges();\r\n}\r\n\r\n/**\r\n * Setup token estimation functionality\r\n */\r\nfunction setupTokenEstimation(popupElement, sceneData, settings, chat_metadata, checkForChanges) {\r\n  const summaryCountSelect = popupElement.querySelector('#stmb-context-memories-advanced');\r\n  const totalTokensDisplay = popupElement.querySelector('#stmb-total-tokens-display');\r\n  const tokenWarning = popupElement.querySelector('#stmb-token-warning-advanced');\r\n  const tokenThreshold = settings.moduleSettings.tokenWarningThreshold ?? 50000;\r\n\r\n  if (summaryCountSelect && totalTokensDisplay) {\r\n    let cachedMemories = {}; // Cache fetched memories\r\n\r\n    const updateTokenEstimate = async () => {\r\n      const memoryCount = Number(summaryCountSelect.value);\r\n\r\n      if (memoryCount === 0) {\r\n        totalTokensDisplay.textContent = tr('STMemoryBooks_Label_TotalTokens', 'Total tokens: {{count}}', { count: sceneData.estimatedTokens });\r\n        if (tokenWarning) {\r\n          tokenWarning.style.display = sceneData.estimatedTokens > tokenThreshold ? 'block' : 'none';\r\n        }\r\n        return;\r\n      }\r\n\r\n      // Fetch actual memories for accurate token calculation\r\n      if (!cachedMemories[memoryCount]) {\r\n        totalTokensDisplay.textContent = translate('Total tokens: Calculating...', 'STMemoryBooks_Label_TotalTokensCalculating');\r\n\r\n        const memoryFetchResult = await fetchPreviousSummaries(memoryCount, settings, chat_metadata);\r\n        cachedMemories[memoryCount] = memoryFetchResult.summaries;\r\n      }\r\n\r\n      const memories = cachedMemories[memoryCount];\r\n      const totalTokens = await calculateTokensWithContext(sceneData, memories);\r\n      totalTokensDisplay.textContent = tr('STMemoryBooks_Label_TotalTokens', 'Total tokens: {{count}}', { count: totalTokens });\r\n\r\n      // Update warning visibility\r\n      if (tokenWarning) {\r\n        if (totalTokens > tokenThreshold) {\r\n          tokenWarning.style.display = 'block';\r\n          tokenWarning.querySelector('span').textContent =\r\n            tr('STMemoryBooks_Warn_LargeSceneTokens', ' Large scene ({{tokens}} tokens) may take some time to process.', { tokens: totalTokens });\r\n        } else {\r\n          tokenWarning.style.display = 'none';\r\n        }\r\n      }\r\n    };\r\n\r\n    // Update on change\r\n    summaryCountSelect.addEventListener('change', () => {\r\n      updateTokenEstimate();\r\n      checkForChanges();\r\n    });\r\n\r\n    // Initial update\r\n    updateTokenEstimate();\r\n  }\r\n}\r\n\r\n/**\r\n * Save new profile from advanced settings popup\r\n */\r\nasync function saveNewProfileFromAdvancedSettings(popupElement, settings, profileName) {\r\n  const selectedProfileIndex = parseInt(popupElement.querySelector('#stmb-profile-select-advanced')?.value || settings.defaultProfile);\r\n  const baseProfile = settings.profiles[selectedProfileIndex];\r\n\r\n  // Step 1: Gather base data from the form and the selected profile.\r\n  const data = {\r\n    name: profileName,\r\n    prompt: popupElement.querySelector('#stmb-effective-prompt-advanced')?.value,\r\n    api: baseProfile.connection?.api,\r\n    model: baseProfile.connection?.model,\r\n    temperature: baseProfile.connection?.temperature,\r\n    preset: baseProfile.preset,\r\n    titleFormat: baseProfile.titleFormat || settings.titleFormat,\r\n  };\r\n\r\n  // Step 2: If overriding, update the data with current SillyTavern settings.\r\n  const overrideSettings = popupElement.querySelector('#stmb-override-settings-advanced')?.checked || false;\r\n  if (overrideSettings) {\r\n    const currentSettings = getUIModelSettings();\r\n    const currentApiInfo = getCurrentApiInfo();\r\n\r\n    data.api = currentApiInfo.api;\r\n    data.model = currentSettings.model;\r\n    data.temperature = currentSettings.temperature;\r\n  }\r\n\r\n  // Step 3: Call the centralized function to create the final profile object.\r\n  const newProfile = createProfileObject(data);\r\n\r\n  // Ensure the final profile name is unique before saving.\r\n  const existingNames = settings.profiles.map(p => p.name);\r\n  newProfile.name = generateSafeProfileName(newProfile.name, existingNames);\r\n\r\n  settings.profiles.push(newProfile);\r\n  saveSettingsDebounced();\r\n}\r\n\r\n/**\r\n * Fetch previous summaries using the flag-based identification\r\n * @param {number} count - Number of summaries to fetch\r\n * @param {Object} settings - Extension settings (titleFormat no longer needed)\r\n * @param {Object} chat_metadata - Chat metadata for lorebook access\r\n * @returns {Promise<Object>} Summaries result\r\n */\r\nexport async function fetchPreviousSummaries(count, settings, chat_metadata) {\r\n  if (count <= 0) {\r\n    return { summaries: [], actualCount: 0, requestedCount: 0 };\r\n  }\r\n\r\n  try {\r\n    const lorebookName = await getEffectiveLorebookName();\r\n    if (!lorebookName) {\r\n      return { summaries: [], actualCount: 0, requestedCount: count };\r\n    }\r\n\r\n    const lorebookData = await loadWorldInfo(lorebookName);\r\n    if (!lorebookData) {\r\n      return { summaries: [], actualCount: 0, requestedCount: count };\r\n    }\r\n\r\n    // Use flag-based identification - no titleFormat needed\r\n    const memoryEntries = identifyMemoryEntries(lorebookData);\r\n\r\n    // Return the last N summaries (most recent ones)\r\n    const recentSummaries = memoryEntries.slice(-count);\r\n    const actualCount = recentSummaries.length;\r\n\r\n    return {\r\n      summaries: recentSummaries.map(entry => ({\r\n        number: entry.number,\r\n        title: entry.title,\r\n        content: entry.content,\r\n        keywords: entry.keywords\r\n      })),\r\n      actualCount: actualCount,\r\n      requestedCount: count\r\n    };\r\n\r\n  } catch (error) {\r\n    return { summaries: [], actualCount: 0, requestedCount: count };\r\n  }\r\n}\r\n\r\n/**\r\n * Calculate actual token count including real context memories\r\n */\r\nexport async function calculateTokensWithContext(sceneData, memories) {\r\n  let baseTokens = sceneData.estimatedTokens;\r\n\r\n  if (memories && memories.length > 0) {\r\n    // Calculate actual tokens from memory content\r\n    let contextTokens = 200; // Headers and formatting overhead\r\n\r\n    for (const memory of memories) {\r\n      const memoryContent = memory.content || '';\r\n      const memoryTokens = Math.ceil(memoryContent.length / 4); // Rough estimation\r\n      contextTokens += memoryTokens;\r\n    }\r\n\r\n    return baseTokens + contextTokens;\r\n  }\r\n\r\n  return baseTokens;\r\n}\r\n\r\n/**\r\n * Get available memories count from lorebook using flag-based identification\r\n * @param {Object} settings - Extension settings (titleFormat no longer needed)\r\n * @param {Object} chat_metadata - Chat metadata for lorebook access\r\n * @returns {Promise<number>} Number of available memories\r\n */\r\nasync function getAvailableMemoriesCount(settings, chat_metadata) {\r\n  try {\r\n    const lorebookName = await getEffectiveLorebookName();\r\n    if (!lorebookName) {\r\n      return 0;\r\n    }\r\n\r\n    const lorebookData = await loadWorldInfo(lorebookName);\r\n    if (!lorebookData) {\r\n      return 0;\r\n    }\r\n\r\n    // Use flag-based identification - no titleFormat needed\r\n    const memoryEntries = identifyMemoryEntries(lorebookData);\r\n\r\n    return memoryEntries.length;\r\n  } catch (error) {\r\n    return 0;\r\n  }\r\n}\r\n\r\n/**\r\n * Confirm saving new profile\r\n * @param {string} profileName - Name of the profile to save\r\n * @returns {Promise<boolean>} Whether the user confirmed\r\n */\r\nexport async function confirmSaveNewProfile(profileName) {\r\n  try {\r\n    const result = await new Popup(\r\n      tr('STMemoryBooks_Prompt_SaveAsNewProfileConfirm', 'Save current settings as new profile \"{{name}}\"?', { name: profileName }),\r\n      POPUP_TYPE.CONFIRM,\r\n      ''\r\n    ).show();\r\n    return result === POPUP_RESULT.AFFIRMATIVE;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Show memory preview popup that allows user to review and edit memory before saving\r\n * @param {Object} memoryResult - The generated memory result containing content, title, and keywords\r\n * @param {Object} sceneData - Scene information for context\r\n * @param {Object} profileSettings - Profile settings used for generation\r\n * @returns {Promise<Object>} Result object with action and optional edited memory data\r\n */\r\nexport async function showMemoryPreviewPopup(memoryResult, sceneData, profileSettings, options = {}) {\r\n  try {\r\n    // Input validation\r\n    if (!memoryResult || typeof memoryResult !== 'object') {\r\n      console.error(translate(`${MODULE_NAME}: Invalid memoryResult passed to showMemoryPreviewPopup`, 'confirmationPopup.log.invalidMemoryResult'));\r\n      return { action: 'cancel' };\r\n    }\r\n\r\n    if (!sceneData || typeof sceneData !== 'object') {\r\n      console.error(translate(`${MODULE_NAME}: Invalid sceneData passed to showMemoryPreviewPopup`, 'confirmationPopup.log.invalidSceneData'));\r\n      return { action: 'cancel' };\r\n    }\r\n\r\n    if (!profileSettings || typeof profileSettings !== 'object') {\r\n      console.error(translate(`${MODULE_NAME}: Invalid profileSettings passed to showMemoryPreviewPopup`, 'confirmationPopup.log.invalidProfileSettings'));\r\n      return { action: 'cancel' };\r\n    }\r\n\r\n    // Validate required sceneData properties\r\n    if (typeof sceneData.sceneStart !== 'number' ||\r\n      typeof sceneData.sceneEnd !== 'number' ||\r\n      typeof sceneData.messageCount !== 'number') {\r\n      console.error(translate(`${MODULE_NAME}: sceneData missing required numeric properties`, 'confirmationPopup.log.sceneDataMissingProps'));\r\n      return { action: 'cancel' };\r\n    }\r\n\r\n    // Helper function to safely convert keywords to string\r\n    const keywordsToString = (keywords) => {\r\n      if (Array.isArray(keywords)) {\r\n        return keywords.filter(k => k && typeof k === 'string').join(', ');\r\n      } else if (typeof keywords === 'string') {\r\n        return keywords.trim();\r\n      } else {\r\n        return '';\r\n      }\r\n    };\r\n\r\n    // Prepare template data\r\n    const templateData = {\r\n      title: memoryResult.extractedTitle || translate('Memory', 'addlore.defaults.title'),\r\n      content: memoryResult.content || '',\r\n      keywordsText: keywordsToString(memoryResult.suggestedKeys),\r\n      sceneStart: sceneData.sceneStart,\r\n      sceneEnd: sceneData.sceneEnd,\r\n      messageCount: sceneData.messageCount,\r\n      titleReadonly: !!options.lockTitle,\n      profileName: (profileSettings?.isBuiltinCurrentST)\n        ? translate('Current SillyTavern Settings', 'STMemoryBooks_Profile_CurrentST')\n        : (profileSettings.name || translate('Unknown Profile', 'STMemoryBooks_UnknownProfile'))\n    };\n\r\n    const content = DOMPurify.sanitize(memoryPreviewTemplate(templateData));\r\n\r\n    // Play notification sound when popup appears\r\n    safePlayMessageSound();\r\n\r\n    const popup = new Popup(content, POPUP_TYPE.TEXT, '', {\r\n      okButton: translate('Edit & Save', 'STMemoryBooks_EditAndSave'),\r\n      cancelButton: translate('Cancel', 'STMemoryBooks_Cancel'),\r\n      allowVerticalScrolling: true,\r\n      wide: true,\r\n      customButtons: [\r\n        {\r\n          text: translate('Retry Generation', 'STMemoryBooks_RetryGeneration'),\r\n          result: STMB_POPUP_RESULTS.RETRY,\r\n          classes: ['menu_button', 'whitespacenowrap'],\r\n          action: null\r\n        }\r\n      ]\r\n    });\r\n\r\n    const result = await popup.show();\r\n\r\n    switch (result) {\r\n      case POPUP_RESULT.AFFIRMATIVE:\r\n      case STMB_POPUP_RESULTS.EDIT:\r\n        // User wants to edit and save\r\n        const popupElement = popup.dlg;\r\n\r\n        // Check if popup element is still available\r\n        if (!popupElement) {\r\n          console.error(translate(`${MODULE_NAME}: Popup element not available for reading edited values`, 'confirmationPopup.log.popupNotAvailable'));\r\n          toastr.error(translate('Unable to read edited values', 'STMemoryBooks_Toast_UnableToReadEditedValues'), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n          return { action: 'cancel' };\r\n        }\r\n\r\n        // Safely extract values with null checks\r\n        const titleElement = popupElement.querySelector('#stmb-preview-title');\r\n        const contentElement = popupElement.querySelector('#stmb-preview-content');\r\n        const keywordsElement = popupElement.querySelector('#stmb-preview-keywords');\r\n\r\n        if (!titleElement || !contentElement || !keywordsElement) {\r\n          console.error(translate(`${MODULE_NAME}: Required input elements not found in popup`, 'confirmationPopup.log.inputsNotFound'));\r\n          toastr.error(translate('Unable to find input fields', 'STMemoryBooks_Toast_UnableToFindInputFields'), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n          return { action: 'cancel' };\r\n        }\r\n\r\n        let editedTitle = titleElement.value?.trim() || '';\r\n        const editedContent = contentElement.value?.trim() || '';\r\n        const editedKeywordsText = keywordsElement.value?.trim() || '';\r\n\r\n        // If title is locked for side prompts, ignore any user edits and keep the original\r\n        if (options?.lockTitle) {\r\n          editedTitle = memoryResult.extractedTitle || editedTitle;\r\n        }\r\n\r\n        // Validate required fields\r\n        if (!editedTitle || editedTitle.length === 0) {\r\n          console.error(translate(`${MODULE_NAME}: Memory title validation failed - empty title`, 'confirmationPopup.log.titleValidationFailed'));\r\n          toastr.error(translate('Memory title cannot be empty', 'STMemoryBooks_Toast_TitleCannotBeEmpty'), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n          return { action: 'cancel' };\r\n        }\r\n\r\n        if (!editedContent || editedContent.length === 0) {\r\n          console.error(translate(`${MODULE_NAME}: Memory content validation failed - empty content`, 'confirmationPopup.log.contentValidationFailed'));\r\n          toastr.error(translate('Memory content cannot be empty', 'STMemoryBooks_Toast_ContentCannotBeEmpty'), translate('STMemoryBooks', 'confirmationPopup.toast.title'));\r\n          return { action: 'cancel' };\r\n        }\r\n\r\n        // Parse keywords back to array with robust handling\r\n        const parseKeywordsToArray = (keywordText) => {\r\n          if (!keywordText || typeof keywordText !== 'string') {\r\n            return [];\r\n          }\r\n          return keywordText\r\n            .split(',')\r\n            .map(k => k.trim())\r\n            .filter(k => k.length > 0 && typeof k === 'string');\r\n        };\r\n\r\n        const editedKeywords = parseKeywordsToArray(editedKeywordsText);\r\n\r\n        // Preserve all original memoryResult fields and only override the user-edited ones\r\n        const editedMemoryResult = {\r\n          ...memoryResult,  // This preserves metadata, titleFormat, lorebookSettings, etc.\r\n          extractedTitle: editedTitle,\r\n          content: editedContent,\r\n          suggestedKeys: editedKeywords\r\n        };\r\n\r\n        return {\r\n          action: 'edit',\r\n          memoryData: editedMemoryResult\r\n        };\r\n      case STMB_POPUP_RESULTS.RETRY:\r\n        return {\r\n          action: 'retry'\r\n        };\r\n      default:\r\n        return {\r\n          action: 'cancel'\r\n        };\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error(translate(`${MODULE_NAME}: Error showing memory preview popup:`, 'confirmationPopup.log.previewError'), error);\r\n    return {\r\n      action: 'cancel'\r\n    };\r\n  }\r\n}\r\n",
    "import { chat, chat_metadata } from '../../../../script.js';\nimport { extension_settings } from '../../../extensions.js';\nimport { getRegexedString, regex_placement } from '../../../extensions/regex/engine.js';\nimport { METADATA_KEY, world_names, loadWorldInfo } from '../../../world-info.js';\nimport { getSceneMarkers } from './sceneManager.js';\nimport { createSceneRequest, compileScene, toReadableText } from './chatcompile.js';\nimport { getCurrentApiInfo, getUIModelSettings, normalizeCompletionSource, resolveEffectiveConnectionFromProfile, clampInt } from './utils.js';\nimport { requestCompletion } from './stmemory.js';\nimport { listByTrigger, findTemplateByName } from './sidePromptsManager.js';\nimport { upsertLorebookEntryByTitle, upsertLorebookEntriesBatch, getEntryByTitle } from './addlore.js';\nimport { fetchPreviousSummaries, showMemoryPreviewPopup } from './confirmationPopup.js';\nimport { t as __st_t_tag, translate } from '../../../i18n.js';\nimport { oai_settings } from '../../../openai.js';\n\n\nconst MODULE_NAME = 'STMemoryBooks-SidePrompts';\nlet hasShownSidePromptRangeTip = false;\n\n// Serialize preview popups to avoid overlap; enqueue in order of receipt\nlet previewQueue = Promise.resolve();\nfunction enqueuePreview(task) {\n    previewQueue = previewQueue.then(task).catch(err => {\n        console.warn(`${MODULE_NAME}: preview task failed`, err);\n    });\n    return previewQueue;\n}\n\n/**\n * Strict lorebook requirement: no auto-create, no selection popup.\n * Throws with a user-facing toast if unavailable.\n * @returns {Promise<{ name: string, data: any }>}\n */\nasync function requireLorebookStrict() {\n    const settings = extension_settings.STMemoryBooks;\n    let lorebookName = null;\n\n    // Manual mode uses per-chat manual selection in scene markers\n    if (settings?.moduleSettings?.manualModeEnabled) {\n        const stmbData = getSceneMarkers() || {};\n        lorebookName = stmbData.manualLorebook ?? null;\n    } else {\n        // Chat-bound lorebook\n        lorebookName = chat_metadata?.[METADATA_KEY] || null;\n    }\n\n    if (!lorebookName || !world_names || !world_names.includes(lorebookName)) {\n        toastr.error(translate('No memory lorebook is assigned. Open Memory Books settings and select or bind a lorebook.', 'STMemoryBooks_Toast_NoMemoryLorebookAssigned'), 'STMemoryBooks');\n        throw new Error(translate('No memory lorebook assigned', 'STMemoryBooks_Error_NoMemoryLorebookAssigned'));\n    }\n\n    try {\n        const lorebookData = await loadWorldInfo(lorebookName);\n        if (!lorebookData) throw new Error(translate('Failed to load lorebook', 'STMemoryBooks_Error_FailedToLoadLorebook'));\n        return { name: lorebookName, data: lorebookData };\n    } catch (err) {\n        toastr.error(translate('Failed to load the selected lorebook.', 'STMemoryBooks_Toast_FailedToLoadLorebook'), 'STMemoryBooks');\n        throw err;\n    }\n}\n\n/**\n * Count non-system (visible) messages between exclusiveStart and inclusiveEnd indices\n */\nfunction countVisibleMessagesSince(exclusiveStart, inclusiveEnd) {\n    let count = 0;\n    const start = Math.max(-1, Number.isFinite(exclusiveStart) ? exclusiveStart : -1);\n    const end = Math.max(-1, inclusiveEnd);\n    for (let i = start + 1; i <= end && i < chat.length; i++) {\n        const m = chat[i];\n        if (m && !m.is_system) count++;\n    }\n    return count;\n}\n\n/**\n * Compile a scene safely for [start, end], skipping system messages (handled by compileScene)\n */\nfunction compileRange(start, end) {\n    const req = createSceneRequest(start, end);\n    return compileScene(req);\n}\n\n/**\n * Build a plain prompt by combining template prompt + prior content + compiled scene text\n */\nfunction buildPrompt(templatePrompt, priorContent, compiledScene, responseFormat, previousSummaries = []) {\n    const parts = [];\n    parts.push(String(templatePrompt || ''));\n    if (priorContent && String(priorContent).trim()) {\n        parts.push('\\n=== PRIOR ENTRY ===\\n');\n        parts.push(String(priorContent));\n    }\n    if (Array.isArray(previousSummaries) && previousSummaries.length > 0) {\n        parts.push('\\n=== PREVIOUS SCENE CONTEXT (DO NOT SUMMARIZE) ===\\n');\n        parts.push('These are previous memories for context only. Do NOT include them in your new output.\\n\\n');\n        previousSummaries.forEach((m, i) => {\n            parts.push(`Context ${i + 1} - ${m.title || 'Memory'}:\\n`);\n            parts.push(`${m.content || ''}\\n`);\n            if (Array.isArray(m.keywords) && m.keywords.length) {\n                parts.push(`Keywords: ${m.keywords.join(', ')}\\n`);\n            }\n            parts.push('\\n');\n        });\n        parts.push('=== END PREVIOUS SCENE CONTEXT ===\\n');\n    }\n    // Derive scene text from the compiled scene here to keep a single source of truth\n    const sceneText = compiledScene ? toReadableText(compiledScene) : '';\n    parts.push('\\n=== SCENE TEXT ===\\n');\n    parts.push(sceneText);\n    if (responseFormat && String(responseFormat).trim()) {\n        parts.push('\\n=== RESPONSE FORMAT ===\\n');\n        parts.push(String(responseFormat).trim());\n    }\n    const finalPrompt = parts.join('');\n\n    // Apply regex transformations (honor global Use Regex toggle)\n    const useRegex = !!(extension_settings?.STMemoryBooks?.moduleSettings?.useRegex);\n    return useRegex ? getRegexedString(finalPrompt, regex_placement.USER_INPUT, { isPrompt: true }) : finalPrompt;\n}\n\n/**\n * Perform LLM call\n * - By default uses current ST UI settings\n * - If overrides are provided, uses the given api/model/temperature\n */\nasync function runLLM(prompt, overrides = null) {\n    // Determine connection\n    let api, model, temperature, endpoint, apiKey;\n\n    if (overrides && (overrides.api || overrides.model)) {\n        api = normalizeCompletionSource(overrides.api || 'openai');\n        model = overrides.model || '';\n        temperature = typeof overrides.temperature === 'number' ? overrides.temperature : 0.7;\n        endpoint = overrides.endpoint || null;\n        apiKey = overrides.apiKey || null;\n        console.debug(`${MODULE_NAME}: runLLM using overrides api=${api} model=${model} temp=${temperature}`);\n    } else {\n        const apiInfo = getCurrentApiInfo();\n        const modelInfo = getUIModelSettings();\n        api = normalizeCompletionSource(apiInfo.completionSource || apiInfo.api || 'openai');\n        model = modelInfo.model || '';\n        temperature = modelInfo.temperature ?? 0.7;\n        console.debug(`${MODULE_NAME}: runLLM using UI settings api=${api} model=${model} temp=${temperature}`);\n    }\n\n    const extra = (overrides && typeof overrides.extra === 'object' && overrides.extra)\n        ? { ...overrides.extra }\n        : {};\n    const stmbMaxTokensRaw = extension_settings?.STMemoryBooks?.moduleSettings?.maxTokens;\n    const stmbMaxTokens = Number.parseInt(stmbMaxTokensRaw, 10);\n    if (extra.max_tokens == null && extra.max_completion_tokens == null) {\n        if (Number.isFinite(stmbMaxTokens) && stmbMaxTokens > 0) {\n            extra.max_tokens = stmbMaxTokens;\n        } else if (oai_settings?.openai_max_tokens) {\n            extra.max_tokens = oai_settings.openai_max_tokens;\n        }\n    }\n\n    const { text } = await requestCompletion({\n        api,\n        model,\n        prompt,\n        temperature,\n        endpoint,\n        apiKey,\n        extra,\n    });\n    \n    // Apply regex transformations to the raw response (honor global Use Regex toggle)\n    const useRegex = !!(extension_settings?.STMemoryBooks?.moduleSettings?.useRegex);\n    return useRegex ? getRegexedString(text || '', regex_placement.AI_OUTPUT) : (text || '');\n}\n\n/**\n * Resolve which connection to use for side prompts, honoring user defaults.\n * - If a profile is provided with effectiveConnection/connection, use it.\n * - Otherwise, use the default memory profile from settings:\n *   - If default is dynamic \"Current SillyTavern Settings\", mirror current UI settings.\n *   - Else use the stored connection of that profile.\n * Fallback to UI settings only if settings are missing/invalid.\n * @returns {{api: string, model: string, temperature: number, endpoint?: string|null, apiKey?: string|null, extra?: Record<string,any>|undefined}} The resolved connection object.\n */\nfunction resolveSidePromptConnection(profile = null, options = {}) {\n    try {\n        // Highest priority: explicit profile object (e.g., memory generation profile)\n        if (profile && (profile.effectiveConnection || profile.connection)) {\n            const rawConn = profile.effectiveConnection || profile.connection || {};\n            const conn = resolveEffectiveConnectionFromProfile(profile);\n            const { api, model, temperature, endpoint, apiKey } = conn;\n            const extra = rawConn && typeof rawConn.extra === 'object' && rawConn.extra ? rawConn.extra : undefined;\n            console.debug(`${MODULE_NAME}: resolveSidePromptConnection using provided profile api=${api} model=${model} temp=${temperature}`);\n            return { api, model, temperature, endpoint, apiKey, extra };\n        }\n\n        const settings = extension_settings?.STMemoryBooks;\n        const profiles = settings?.profiles || [];\n        let idxOverride = options && Number.isFinite(options.overrideProfileIndex) ? Number(options.overrideProfileIndex) : null;\n\n        // If a template-specified override index is provided, use it\n        if (idxOverride !== null && profiles.length > 0) {\n            if (idxOverride < 0 || idxOverride >= profiles.length) idxOverride = 0;\n            const over = profiles[idxOverride];\n            if (over?.useDynamicSTSettings || (over?.connection?.api === 'current_st')) {\n                // Dynamic profile: mirror current UI\n                const apiInfo = getCurrentApiInfo();\n                const modelInfo = getUIModelSettings();\n                const api = normalizeCompletionSource(apiInfo.completionSource || apiInfo.api || 'openai');\n                const model = modelInfo.model || '';\n                const temperature = modelInfo.temperature ?? 0.7;\n                console.debug(`${MODULE_NAME}: resolveSidePromptConnection using UI via template override profile index=${idxOverride} api=${api} model=${model} temp=${temperature}`);\n                return { api, model, temperature };\n            } else {\n                const conn = over?.connection || {};\n                const api = normalizeCompletionSource(conn.api || 'openai');\n                const model = conn.model || '';\n                const temperature = typeof conn.temperature === 'number' ? conn.temperature : 0.7;\n                const endpoint = conn.endpoint || null;\n                const apiKey = conn.apiKey || null;\n                const extra = conn && typeof conn.extra === 'object' && conn.extra ? conn.extra : undefined;\n                console.debug(`${MODULE_NAME}: resolveSidePromptConnection using template override profile index=${idxOverride} api=${api} model=${model} temp=${temperature}`);\n                return { api, model, temperature, endpoint, apiKey, extra };\n            }\n        }\n\n        // Otherwise: use STMB default profile (may be dynamic)\n        let idx = Number(settings?.defaultProfile ?? 0);\n        if (!Array.isArray(profiles) || profiles.length === 0) {\n            // No profiles available: mirror UI\n            const apiInfo = getCurrentApiInfo();\n            const modelInfo = getUIModelSettings();\n            const api = normalizeCompletionSource(apiInfo.completionSource || apiInfo.api || 'openai');\n            const model = modelInfo.model || '';\n            const temperature = modelInfo.temperature ?? 0.7;\n            console.debug(`${MODULE_NAME}: resolveSidePromptConnection fallback to UI (no profiles) api=${api} model=${model} temp=${temperature}`);\n            return { api, model, temperature };\n        }\n        if (!Number.isFinite(idx) || idx < 0 || idx >= profiles.length) idx = 0;\n\n        const def = profiles[idx];\n        if (def?.useDynamicSTSettings || (def?.connection?.api === 'current_st')) {\n            // Default memory profile is \"Current SillyTavern Settings\" => use UI\n            const apiInfo = getCurrentApiInfo();\n            const modelInfo = getUIModelSettings();\n            const api = normalizeCompletionSource(apiInfo.completionSource || apiInfo.api || 'openai');\n            const model = modelInfo.model || '';\n            const temperature = modelInfo.temperature ?? 0.7;\n            console.debug(`${MODULE_NAME}: resolveSidePromptConnection using UI via dynamic default profile api=${api} model=${model} temp=${temperature}`);\n            return { api, model, temperature };\n        } else {\n            const conn = def?.connection || {};\n            const api = normalizeCompletionSource(conn.api || 'openai');\n            const model = conn.model || '';\n            const temperature = typeof conn.temperature === 'number' ? conn.temperature : 0.7;\n            const endpoint = conn.endpoint || null;\n            const apiKey = conn.apiKey || null;\n            const extra = conn && typeof conn.extra === 'object' && conn.extra ? conn.extra : undefined;\n            console.debug(`${MODULE_NAME}: resolveSidePromptConnection using default profile api=${api} model=${model} temp=${temperature}`);\n            return { api, model, temperature, endpoint, apiKey, extra };\n        }\n    } catch (err) {\n        // Ultimate fallback: UI\n        const apiInfo = getCurrentApiInfo();\n        const modelInfo = getUIModelSettings();\n        const api = normalizeCompletionSource(apiInfo.completionSource || apiInfo.api || 'openai');\n        const model = modelInfo.model || '';\n        const temperature = modelInfo.temperature ?? 0.7;\n        console.warn(`${MODULE_NAME}: resolveSidePromptConnection error; falling back to UI`, err);\n        return { api, model, temperature };\n    }\n}\n\n/**\n * Lorebook settings helpers for side prompts\n */\nfunction toNumberOr(value, fallback) {\n    const n = Number(value);\n    return Number.isFinite(n) ? n : fallback;\n}\n\n/**\n * Read effective lorebook settings from a template, with safe defaults.\n * constVectMode: 'link' (vectorized, default) | 'green' (normal) | 'blue' (constant)\n * orderMode: 'auto' | 'manual' (if manual, orderValue is used)\n */\nfunction getEffectiveLorebookSettingsForTemplate(tpl) {\n    const lb = (tpl && tpl.settings && tpl.settings.lorebook) || {};\n    return {\n        constVectMode: lb.constVectMode || 'link',\n        position: toNumberOr(lb.position, 0),\n        orderMode: lb.orderMode === 'manual' ? 'manual' : 'auto',\n        orderValue: toNumberOr(lb.orderValue, 100),\n        preventRecursion: lb.preventRecursion !== false,\n        delayUntilRecursion: !!lb.delayUntilRecursion,\n        outletName: String(lb.outletName || ''),\n    };\n}\n\n/**\n * Build defaults (for create-time) and entryOverrides (for create+update) for upsert calls\n */\nfunction makeUpsertParamsFromLorebook(lbs) {\n    const defaults = {\n        vectorized: lbs.constVectMode === 'link',\n        selective: true,\n        order: lbs.orderMode === 'manual' ? toNumberOr(lbs.orderValue, 100) : 100,\n        position: toNumberOr(lbs.position, 0),\n    };\n    const entryOverrides = {\n        constant: lbs.constVectMode === 'blue',\n        vectorized: lbs.constVectMode === 'link',\n        preventRecursion: !!lbs.preventRecursion,\n        delayUntilRecursion: !!lbs.delayUntilRecursion,\n    };\n    if (lbs.orderMode === 'manual') {\n        entryOverrides.order = toNumberOr(lbs.orderValue, 100);\n    }\n    if (Number(lbs.position) === 7 && lbs.outletName) {\n        entryOverrides.outletName = String(lbs.outletName);\n    }\n    return { defaults, entryOverrides };\n}\n\n/**\n * Evaluate tracker prompts and fire if thresholds are met\n */\nexport async function evaluateTrackers() {\n    try {\n        const enabledInterval = await listByTrigger('onInterval');\n        if (!enabledInterval || enabledInterval.length === 0) return;\n\n        // Ensure lorebook exists up-front\n        const lore = await requireLorebookStrict();\n\n        const currentLast = chat.length - 1;\n        if (currentLast < 0) return;\n\n        for (const tpl of enabledInterval) {\n            const unifiedTitle = `${tpl.name} (STMB SidePrompt)`;\n            const legacyTitle = `${tpl.name} (STMB Tracker)`;\n\n            // Read existing entry to get last checkpoint (generic first, then legacy)\n            const existing = getEntryByTitle(lore.data, unifiedTitle) || getEntryByTitle(lore.data, legacyTitle);\n            const lastMsgId = Number(\n                (existing && existing[`STMB_sp_${tpl.key}_lastMsgId`]) ??\n                (existing && existing.STMB_tracker_lastMsgId) ??\n                -1\n            );\n            const lastRunAt = existing?.[`STMB_sp_${tpl.key}_lastRunAt`]\n                ? Date.parse(existing[`STMB_sp_${tpl.key}_lastRunAt`])\n                : (existing?.STMB_tracker_lastRunAt ? Date.parse(existing.STMB_tracker_lastRunAt) : null);\n            const now = Date.now();\n\n            // Internal debounce to prevent disk thrash (not user-configurable)\n            const debounceMs = 10_000; // 10 seconds\n            if (lastRunAt && now - lastRunAt < debounceMs) {\n                continue;\n            }\n\n            // Count visible messages since last checkpoint\n            const visibleSince = countVisibleMessagesSince(lastMsgId, currentLast);\n            const threshold = Math.max(1, Number(tpl?.triggers?.onInterval?.visibleMessages ?? 50));\n            if (visibleSince < threshold) {\n                continue;\n            }\n\n            // Build compiled scene for (lastMsgId+1 .. currentLast) with cap\n            const start = Math.max(0, lastMsgId + 1);\n            const cap = 200;\n            const boundedStart = Math.max(start, currentLast - cap + 1);\n\n            let compiled = null;\n            try {\n                compiled = compileRange(boundedStart, currentLast);\n            } catch (err) {\n                console.warn(`${MODULE_NAME}: Interval compile failed:`, err);\n                continue;\n            }\n\n            // Build prompt with prior content and optional previous memories\n            const prior = existing?.content || '';\n            let prevSummaries = [];\n            const pmCountRaw = Number(tpl?.settings?.previousMemoriesCount ?? 0);\n            const pmCount = Math.max(0, Math.min(7, pmCountRaw));\n            if (pmCount > 0) {\n                try {\n                    const res = await fetchPreviousSummaries(pmCount, extension_settings, chat_metadata);\n                    prevSummaries = res?.summaries || [];\n                } catch {}\n            }\n            const finalPrompt = buildPrompt(tpl.prompt, prior, compiled, tpl.responseFormat, prevSummaries);\n\n            // Call LLM\n            let resultText = '';\n            try {\n            const idx = Number(tpl?.settings?.overrideProfileIndex);\n            const useOverride = !!tpl?.settings?.overrideProfileEnabled && Number.isFinite(idx);\n            const overrides = useOverride ? resolveSidePromptConnection(null, { overrideProfileIndex: idx }) : resolveSidePromptConnection(null);\n            console.log(`${MODULE_NAME}: SidePrompt attempt`, {\n                trigger: 'onInterval',\n                name: tpl.name,\n                key: tpl.key,\n                range: `${boundedStart}-${currentLast}`,\n                visibleSince,\n                threshold,\n                api: overrides.api,\n                model: overrides.model,\n            });\n            resultText = await runLLM(finalPrompt, overrides);\n            } catch (err) {\n                console.error(`${MODULE_NAME}: Interval sideprompt LLM failed:`, err);\n                toastr.error(__st_t_tag`SidePrompt \"${tpl.name}\" failed: ${err.message}`, 'STMemoryBooks');\n                continue;\n            }\n\n            // Preview gating if enabled\n            try {\n                const settings = extension_settings?.STMemoryBooks;\n                if (settings?.moduleSettings?.showMemoryPreviews) {\n                    const memoryResult = {\n                        extractedTitle: unifiedTitle,\n                        content: resultText,\n                        suggestedKeys: [],\n                    };\n                    const sceneDataForPreview = {\n                        sceneStart: compiled?.metadata?.sceneStart ?? boundedStart,\n                        sceneEnd: compiled?.metadata?.sceneEnd ?? currentLast,\n                        messageCount: compiled?.metadata?.messageCount ?? (compiled?.messages?.length ?? 0),\n                    };\n                    const profileSettingsForPreview = { name: 'SidePrompt' };\n                    let previewResult;\n                    await enqueuePreview(async () => {\n                        previewResult = await showMemoryPreviewPopup(memoryResult, sceneDataForPreview, profileSettingsForPreview, { lockTitle: true });\n                    });\n                    if (previewResult?.action === 'cancel' || previewResult?.action === 'retry') {\n                        console.log(`${MODULE_NAME}: SidePrompt \"${tpl.name}\" canceled or retry requested in preview; skipping save`);\n                        continue;\n                    } else if (previewResult?.action === 'edit' && previewResult.memoryData) {\n                        resultText = previewResult.memoryData.content ?? resultText;\n                    }\n                }\n            } catch (previewErr) {\n                console.warn(`${MODULE_NAME}: Preview step failed; proceeding without preview`, previewErr);\n            }\n\n            // Upsert entry and update metadata checkpoint (generic + legacy for one-way compat)\n            try {\n                const lbs = getEffectiveLorebookSettingsForTemplate(tpl);\n            const { defaults, entryOverrides } = makeUpsertParamsFromLorebook(lbs);\n            const endId = compiled?.metadata?.sceneEnd ?? currentLast;\n            await upsertLorebookEntryByTitle(lore.name, lore.data, unifiedTitle, resultText, {\n                    defaults,\n                    entryOverrides,\n                    metadataUpdates: {\n                        [`STMB_sp_${tpl.key}_lastMsgId`]: currentLast,\n                        [`STMB_sp_${tpl.key}_lastRunAt`]: new Date().toISOString(),\n                        STMB_tracker_lastMsgId: currentLast,\n                        STMB_tracker_lastRunAt: new Date().toISOString(),\n                    },\n                    refreshEditor: extension_settings?.STMemoryBooks?.moduleSettings?.refreshEditor !== false,\n                });\n                console.log(`${MODULE_NAME}: SidePrompt success`, {\n                    trigger: 'onInterval',\n                    name: tpl.name,\n                    key: tpl.key,\n                    saved: true,\n                    contentChars: resultText.length,\n                });\n            } catch (err) {\n                console.error(`${MODULE_NAME}: Interval sideprompt upsert failed:`, err);\n                toastr.error(__st_t_tag`Failed to update sideprompt entry \"${tpl.name}\"`, 'STMemoryBooks');\n                continue;\n            }\n        }\n    } catch (outer) {\n        // No lorebook or other fatal issues\n    }\n}\n\n/**\n * Run plotpoints and auto scoreboards after a memory run using the same compiled scene\n * @param {Object} compiledScene\n */\nexport async function runAfterMemory(compiledScene, profile = null) {\n    try {\n        const lore = await requireLorebookStrict();\n        const enabledAfter = await listByTrigger('onAfterMemory');\n\n        if (!enabledAfter || enabledAfter.length === 0) return;\n\n\n        // Determine default connection to use for side prompts\n        const defaultOverrides = resolveSidePromptConnection(profile);\n        console.debug(`${MODULE_NAME}: runAfterMemory default overrides api=${defaultOverrides.api} model=${defaultOverrides.model} temp=${defaultOverrides.temperature}`);\n        const settings = extension_settings?.STMemoryBooks;\n        const refreshEditor = settings?.moduleSettings?.refreshEditor !== false;\n        const showNotifications = settings?.moduleSettings?.showNotifications !== false;\n        const results = [];\n\n        const maxConcurrent = clampInt(Number(settings?.moduleSettings?.sidePromptsMaxConcurrent ?? 2),1,5);\n\n        // Partition into waves of size maxConcurrent\n        const waves = [];\n        for (let i = 0; i < enabledAfter.length; i += maxConcurrent) {\n            waves.push(enabledAfter.slice(i, i + maxConcurrent));\n        }\n\n        for (const wave of waves) {\n            // Run LLMs concurrently for this wave (scene-only prompts)\n            const llmPromises = wave.map(async (tpl) => {\n                try {\n                    const unifiedTitle = `${tpl.name} (STMB SidePrompt)`;\n                    const existing = getEntryByTitle(lore.data, unifiedTitle)\n                        || getEntryByTitle(lore.data, `${tpl.name} (STMB Plotpoints)`)\n                        || getEntryByTitle(lore.data, `${tpl.name} (STMB Scoreboard)`);\n                    const prior = existing?.content || '';\n\n                    let prevSummaries = [];\n                    const pmCountRaw = Number(tpl?.settings?.previousMemoriesCount ?? 0);\n                    const pmCount = Math.max(0, Math.min(7, pmCountRaw));\n                    if (pmCount > 0) {\n                        try {\n                            const res = await fetchPreviousSummaries(pmCount, extension_settings, chat_metadata);\n                            prevSummaries = res?.summaries || [];\n                        } catch {}\n                    }\n                    const finalPrompt = buildPrompt(tpl.prompt, prior, compiledScene, tpl.responseFormat, prevSummaries);\n                    const idx = Number(tpl?.settings?.overrideProfileIndex);\n                    const useOverride = !!tpl?.settings?.overrideProfileEnabled && Number.isFinite(idx);\n                    const conn = useOverride ? resolveSidePromptConnection(null, { overrideProfileIndex: idx }) : defaultOverrides;\n                    console.log(`${MODULE_NAME}: SidePrompt attempt`, {\n                        trigger: 'onAfterMemory',\n                        name: tpl.name,\n                        key: tpl.key,\n                        api: conn.api,\n                        model: conn.model,\n                    });\n                    const text = await runLLM(finalPrompt, conn);\n                    return { ok: true, tpl, text };\n                } catch (e) {\n                    console.error(`${MODULE_NAME}: Wave LLM failed for \"${tpl.name}\":`, e);\n                    return { ok: false, tpl, error: e };\n                }\n            });\n\n            const llmResults = await Promise.all(llmPromises.map(p => p.then(r => ({ ...r, _completedAt: performance.now() }))));\n\n            // Present previews in order of receipt\n            llmResults.sort((a, b) => a._completedAt - b._completedAt);\n\n            // Build batch items from successes (preview-gated, receipt order)\n            const items = [];\n            const succeededNames = [];\n            for (const r of llmResults) {\n                if (!r.ok) {\n                    results.push({ name: r.tpl?.name || 'unknown', ok: false, error: r.error });\n                    continue;\n                }\n\n                let textToSave = r.text;\n                let approved = true;\n\n                try {\n                    const settings = extension_settings?.STMemoryBooks;\n                    if (settings?.moduleSettings?.showMemoryPreviews) {\n                        const memoryResult = {\n                            extractedTitle: `${r.tpl.name} (STMB SidePrompt)`,\n                            content: textToSave,\n                            suggestedKeys: [],\n                        };\n                        const sceneDataForPreview = {\n                            sceneStart: compiledScene?.metadata?.sceneStart ?? 0,\n                            sceneEnd: compiledScene?.metadata?.sceneEnd ?? 0,\n                            messageCount: compiledScene?.metadata?.messageCount ?? (compiledScene?.messages?.length ?? 0),\n                        };\n                        const profileSettingsForPreview = { name: 'SidePrompt' };\n                        let previewResult;\n                        await enqueuePreview(async () => {\n                            previewResult = await showMemoryPreviewPopup(memoryResult, sceneDataForPreview, profileSettingsForPreview, { lockTitle: true });\n                        });\n                        if (previewResult?.action === 'cancel' || previewResult?.action === 'retry') {\n                            approved = false;\n                        } else if (previewResult?.action === 'edit' && previewResult.memoryData) {\n                            textToSave = previewResult.memoryData.content ?? textToSave;\n                        }\n                    }\n                } catch (previewErr) {\n                    console.warn(`${MODULE_NAME}: Preview step failed; proceeding without preview`, previewErr);\n                }\n\n                if (approved) {\n                    const tpl = r.tpl;\n                    const unifiedTitle = `${tpl.name} (STMB SidePrompt)`;\n                    const lbs = getEffectiveLorebookSettingsForTemplate(tpl);\n                    const { defaults, entryOverrides } = makeUpsertParamsFromLorebook(lbs);\n                    items.push({\n                        title: unifiedTitle,\n                        content: textToSave,\n                        defaults,\n                        entryOverrides,\n                        metadataUpdates: {\n                            [`STMB_sp_${tpl.key}_lastRunAt`]: new Date().toISOString(),\n                        },\n                    });\n                    succeededNames.push(tpl.name);\n                } else {\n                    results.push({ name: r.tpl.name, ok: false, error: new Error('User canceled or retry in preview') });\n                }\n            }\n\n            if (items.length > 0) {\n                try {\n                    // Re-load latest lore to include any user edits during LLM phase\n                    const fresh = await loadWorldInfo(lore.name);\n                    // Batch save this wave; refresh editor per directive if enabled globally\n                    await upsertLorebookEntriesBatch(lore.name, fresh, items, { refreshEditor });\n                    // Update reference for subsequent lookups\n                    lore.data = fresh;\n\n                    // Only now count successes and toast per-template successes\n                    for (const name of succeededNames) {\n                        results.push({ name, ok: true });\n                        if (showNotifications) {\n                            toastr.success(__st_t_tag`SidePrompt \"${name}\" updated.`, 'STMemoryBooks');\n                        }\n                        console.log(`${MODULE_NAME}: SidePrompt success`, {\n                            trigger: 'onAfterMemory',\n                            name,\n                            saved: true,\n                        });\n                    }\n                } catch (saveErr) {\n                    console.error(`${MODULE_NAME}: Wave save failed:`, saveErr);\n                    toastr.error(translate('Failed to save SidePrompt updates for this wave', 'STMemoryBooks_Toast_FailedToSaveWave'), 'STMemoryBooks');\n                    // Mark these as failed since they were not persisted\n                    for (const name of succeededNames) {\n                        results.push({ name, ok: false, error: saveErr });\n                    }\n                }\n            }\n        }\n        // Aggregated notifications for AfterMemory side prompts\n        if (showNotifications && results.length > 0) {\n            const succeeded = results.filter(r => r.ok).map(r => r.name);\n            const failed = results.filter(r => !r.ok).map(r => r.name);\n            const okCount = succeeded.length;\n            const failCount = failed.length;\n            const summarize = (arr) => {\n                const maxNames = 5;\n                if (arr.length === 0) return '';\n                const names = arr.slice(0, maxNames).join(', ');\n                const more = arr.length > maxNames ? `, +${arr.length - maxNames} more` : '';\n                return `${names}${more}`;\n            };\n            if (failCount === 0) {\n                toastr.info(__st_t_tag`Side Prompts after memory: ${okCount} succeeded. ${summarize(succeeded)}`, 'STMemoryBooks');\n            } else {\n                toastr.warning(__st_t_tag`Side Prompts after memory: ${okCount} succeeded, ${failCount} failed. ${failCount ? 'Failed: ' + summarize(failed) : ''}`, 'STMemoryBooks');\n            }\n        }\n    } catch (outer) {\n        // No lorebook => do nothing\n    }\n}\n\n\n\n/**\n * Unified manual side prompt runner\n * Usage: /sideprompt \"Name\" [X-Y]\n */\nexport async function runSidePrompt(args) {\n    try {\n        const lore = await requireLorebookStrict();\n\n        const { name, range } = parseNameAndRange(args);\n        if (!name) {\n            toastr.error(translate('SidePrompt name not provided. Usage: /sideprompt \"Name\" [X-Y]', 'STMemoryBooks_Toast_SidePromptNameNotProvided'), 'STMemoryBooks');\n            return '';\n        }\n\n        const tpl = await findTemplateByName(name);\n        if (!tpl) {\n            toastr.error(translate('SidePrompt template not found. Check name.', 'STMemoryBooks_Toast_SidePromptNotFound'), 'STMemoryBooks');\n            return '';\n        }\n        // Enforce manual gating: only allow /sideprompt if template has the sideprompt command enabled\n        const manualEnabled = Array.isArray(tpl?.triggers?.commands) && tpl.triggers.commands.some(c => String(c).toLowerCase() === 'sideprompt');\n        if (!manualEnabled) {\n            toastr.error(translate('Manual run is disabled for this template. Enable \"Allow manual run via /sideprompt\" in the template settings.', 'STMemoryBooks_Toast_ManualRunDisabled'), 'STMemoryBooks');\n            return '';\n        }\n\n        const currentLast = chat.length - 1;\n        if (currentLast < 0) {\n            toastr.error(translate('No messages available.', 'STMemoryBooks_Toast_NoMessagesAvailable'), 'STMemoryBooks');\n            return '';\n        }\n\n        // Compile window\n        let compiled = null;\n        if (range) {\n            const m = String(range).trim().match(/^(\\d+)\\s*[-]\\s*(\\d+)$/);\n            if (!m) {\n                toastr.error(translate('Invalid range format. Use X-Y', 'STMemoryBooks_Toast_InvalidRangeFormat'), 'STMemoryBooks');\n                return '';\n            }\n            const start = parseInt(m[1], 10);\n            const end = parseInt(m[2], 10);\n            if (!(start >= 0 && end >= start && end < chat.length)) {\n                toastr.error(translate('Invalid message range for /sideprompt', 'STMemoryBooks_Toast_InvalidMessageRange'), 'STMemoryBooks');\n                return '';\n            }\n            try {\n                compiled = compileRange(start, end);\n            } catch (err) {\n                toastr.error(translate('Failed to compile the specified range', 'STMemoryBooks_Toast_FailedToCompileRange'), 'STMemoryBooks');\n                return '';\n            }\n        } else {\n            // Since-last behavior with cap\n            if (!hasShownSidePromptRangeTip) {\n                toastr.info(translate('Tip: You can run a specific range with /sideprompt \"Name\" X-Y (e.g., /sideprompt \"Scoreboard\" 100-120). Running without a range uses messages since the last checkpoint.', 'STMemoryBooks_Toast_SidePromptRangeTip'), 'STMemoryBooks');\n                hasShownSidePromptRangeTip = true;\n            }\n            const unifiedTitle = `${tpl.name} (STMB SidePrompt)`;\n            const existingForLast = getEntryByTitle(lore.data, unifiedTitle)\n                || getEntryByTitle(lore.data, `${tpl.name} (STMB Scoreboard)`)\n                || getEntryByTitle(lore.data, `${tpl.name} (STMB Plotpoints)`)\n                || getEntryByTitle(lore.data, `${tpl.name} (STMB Tracker)`);\n            const lastMsgId = Number(\n                (existingForLast && existingForLast[`STMB_sp_${tpl.key}_lastMsgId`]) ??\n                (existingForLast && existingForLast.STMB_score_lastMsgId) ??\n                (existingForLast && existingForLast.STMB_tracker_lastMsgId) ??\n                -1\n            );\n\n            const start = Math.max(0, lastMsgId + 1);\n            const cap = 200;\n            const boundedStart = Math.max(start, currentLast - cap + 1);\n\n            try {\n                compiled = compileRange(boundedStart, currentLast);\n            } catch (err) {\n                toastr.error(translate('Failed to compile messages for /sideprompt', 'STMemoryBooks_Toast_FailedToCompileMessages'), 'STMemoryBooks');\n                return '';\n            }\n        }\n        const unifiedTitle = `${tpl.name} (STMB SidePrompt)`;\n        const existing = getEntryByTitle(lore.data, unifiedTitle)\n            || getEntryByTitle(lore.data, `${tpl.name} (STMB Scoreboard)`)\n            || getEntryByTitle(lore.data, `${tpl.name} (STMB Plotpoints)`)\n            || getEntryByTitle(lore.data, `${tpl.name} (STMB Tracker)`);\n        const prior = existing?.content || '';\n        let prevSummaries = [];\n        const pmCountRaw = Number(tpl?.settings?.previousMemoriesCount ?? 0);\n        const pmCount = Math.max(0, Math.min(7, pmCountRaw));\n        if (pmCount > 0) {\n            try {\n                const res = await fetchPreviousSummaries(pmCount, extension_settings, chat_metadata);\n                prevSummaries = res?.summaries || [];\n            } catch {}\n        }\n        const finalPrompt = buildPrompt(tpl.prompt, prior, compiled, tpl.responseFormat, prevSummaries);\n\n        // Call LLM\n        let resultText = '';\n        try {\n            const idx = Number(tpl?.settings?.overrideProfileIndex);\n            const useOverride = !!tpl?.settings?.overrideProfileEnabled && Number.isFinite(idx);\n            const overrides = useOverride ? resolveSidePromptConnection(null, { overrideProfileIndex: idx }) : resolveSidePromptConnection(null);\n            console.log(`${MODULE_NAME}: SidePrompt attempt`, {\n                trigger: 'manual',\n                name: tpl.name,\n                key: tpl.key,\n                rangeProvided: !!range,\n                api: overrides.api,\n                model: overrides.model,\n            });\n            resultText = await runLLM(finalPrompt, overrides);\n\n            // Preview gating if enabled\n            try {\n                const settings = extension_settings?.STMemoryBooks;\n                if (settings?.moduleSettings?.showMemoryPreviews) {\n                    const memoryResult = {\n                        extractedTitle: unifiedTitle,\n                        content: resultText,\n                        suggestedKeys: [],\n                    };\n                    const sceneDataForPreview = {\n                        sceneStart: compiled?.metadata?.sceneStart ?? 0,\n                        sceneEnd: compiled?.metadata?.sceneEnd ?? 0,\n                        messageCount: compiled?.metadata?.messageCount ?? (compiled?.messages?.length ?? 0),\n                    };\n                    const profileSettingsForPreview = { name: 'SidePrompt' };\n                    const previewResult = await showMemoryPreviewPopup(\n                        memoryResult,\n                        sceneDataForPreview,\n                        profileSettingsForPreview,\n                        { lockTitle: true }\n                    );\n\n                    if (previewResult?.action === 'cancel' || previewResult?.action === 'retry') {\n                        toastr.info(__st_t_tag`SidePrompt \"${tpl.name}\" canceled.`, 'STMemoryBooks');\n                        return '';\n                    } else if (previewResult?.action === 'edit' && previewResult.memoryData) {\n                        resultText = previewResult.memoryData.content ?? resultText;\n                    }\n                }\n            } catch (previewErr) {\n                console.warn(`${MODULE_NAME}: Preview step failed; proceeding without preview`, previewErr);\n            }\n            const lbs = getEffectiveLorebookSettingsForTemplate(tpl);\n            const { defaults, entryOverrides } = makeUpsertParamsFromLorebook(lbs);\n            const endId = compiled?.metadata?.sceneEnd ?? currentLast;\n            await upsertLorebookEntryByTitle(lore.name, lore.data, unifiedTitle, resultText, {\n                defaults,\n                entryOverrides,\n                metadataUpdates: {\n                    [`STMB_sp_${tpl.key}_lastMsgId`]: endId,\n                    [`STMB_sp_${tpl.key}_lastRunAt`]: new Date().toISOString(),\n                    STMB_tracker_lastMsgId: endId,\n                    STMB_tracker_lastRunAt: new Date().toISOString(),\n                },\n                refreshEditor: extension_settings?.STMemoryBooks?.moduleSettings?.refreshEditor !== false,\n            });\n            console.log(`${MODULE_NAME}: SidePrompt success`, {\n                trigger: 'manual',\n                name: tpl.name,\n                key: tpl.key,\n                saved: true,\n                contentChars: resultText.length,\n            });\n            } catch (err) {\n                console.error(`${MODULE_NAME}: /sideprompt failed:`, err);\n                toastr.error(__st_t_tag`SidePrompt \"${tpl.name}\" failed: ${err.message}`, 'STMemoryBooks');\n                return '';\n            }\n\n        toastr.success(__st_t_tag`SidePrompt \"${tpl.name}\" updated.`, 'STMemoryBooks');\n        return '';\n    } catch (outer) {\n        return '';\n    }\n}\n\n/**\n * Parse sideprompt args: \"Name\" [X-Y] or Name [X-Y]\n */\nfunction parseNameAndRange(input) {\n    const s = String(input || '').trim();\n    if (!s) return { name: '', range: null };\n\n    let name = '';\n    let rest = '';\n\n    const mQuoteD = s.match(/^\"([^\"]+)\"\\s*(.*)$/);\n    const mQuoteS = !mQuoteD && s.match(/^'([^']+)'\\s*(.*)$/);\n    if (mQuoteD) {\n        name = mQuoteD[1];\n        rest = mQuoteD[2] || '';\n    } else if (mQuoteS) {\n        name = mQuoteS[1];\n        rest = mQuoteS[2] || '';\n    } else {\n        // If a range appears at the end, strip it from name\n        const mRange = s.match(/(\\d+)\\s*[-]\\s*(\\d+)\\s*$/);\n        if (mRange) {\n            name = s.slice(0, mRange.index).trim();\n            rest = s.slice(mRange.index);\n        } else {\n            name = s;\n            rest = '';\n        }\n    }\n\n    let range = null;\n    if (rest) {\n        const r = rest.match(/(\\d+)\\s*[-]\\s*(\\d+)/);\n        if (r) range = `${r[1]}-${r[2]}`;\n    }\n\n    return { name, range };\n}\n",
    "import { Popup, POPUP_TYPE, POPUP_RESULT } from '../../../popup.js';\nimport { DOMPurify } from '../../../../lib.js';\nimport { escapeHtml } from '../../../utils.js';\nimport { extension_settings } from '../../../extensions.js';\nimport { saveSettingsDebounced } from '../../../../script.js';\nimport {\n    listTemplates,\n    getTemplate,\n    upsertTemplate,\n    duplicateTemplate,\n    removeTemplate,\n    exportToJSON as exportSidePromptsJSON,\n    importFromJSON as importSidePromptsJSON,\n    recreateBuiltInSidePrompts,\n} from './sidePromptsManager.js';\nimport { sidePromptsTableTemplate } from './templatesSidePrompts.js';\nimport { translate, applyLocale } from '../../../i18n.js';\n\n/** Helper: keyed translation with Mustache-style interpolation using ST translate() */\nfunction tr(key, fallback, params) {\n    const localized = translate(fallback, key);\n    if (!params) return localized;\n    return localized.replace(/{{\\s*(\\w+)\\s*}}/g, (m, p1) => {\n        const v = params[p1];\n        return v !== undefined && v !== null ? String(v) : '';\n    });\n}\n\n/**\n * Build a human-readable triggers summary array for display/search\n * @param {any} tpl\n * @returns {string[]}\n */\nfunction getTriggersSummary(tpl) {\n    const badges = [];\n    const trig = tpl?.triggers || {};\n    if (trig.onInterval && Number(trig.onInterval.visibleMessages) >= 1) {\n        badges.push(`${translate('Interval', 'STMemoryBooks_Interval')}:${Number(trig.onInterval.visibleMessages)}`);\n    }\n    if (trig.onAfterMemory && !!trig.onAfterMemory.enabled) {\n        badges.push(translate('AfterMemory', 'STMemoryBooks_AfterMemory'));\n    }\n    if (Array.isArray(trig.commands) && trig.commands.some(c => String(c).toLowerCase() === 'sideprompt')) {\n        badges.push(translate('Manual', 'STMemoryBooks_Manual'));\n    }\n    return badges;\n}\n\n/**\n * Render the templates table HTML using Handlebars\n * @param {Array} templates\n * @returns {string}\n */\nfunction renderTemplatesTable(templates) {\n    const items = (templates || []).map(t => ({\n        key: String(t.key || ''),\n        name: String(t.name || ''),\n        badges: getTriggersSummary(t),\n    }));\n    return sidePromptsTableTemplate({ items });\n}\n\n/**\n * Refresh the list in the open popup\n * @param {Popup} popup\n * @param {string|null} preserveKey\n */\nasync function refreshList(popup, preserveKey = null) {\n    const listContainer = popup?.dlg?.querySelector('#stmb-sp-list');\n    if (!listContainer) return;\n\n    const searchTerm = (popup?.dlg?.querySelector('#stmb-sp-search')?.value || '').toLowerCase();\n\n    const templates = await listTemplates();\n    const filtered = searchTerm\n        ? templates.filter(t => {\n            const nameMatch = t.name.toLowerCase().includes(searchTerm);\n            const trigStr = getTriggersSummary(t).join(' ').toLowerCase();\n            return nameMatch || trigStr.includes(searchTerm);\n        })\n        : templates;\n\n    listContainer.innerHTML = DOMPurify.sanitize(renderTemplatesTable(filtered));\n    try { applyLocale(listContainer); } catch (e) { /* no-op */ }\n\n    // Restore selection\n    if (preserveKey) {\n        const row = listContainer.querySelector(`tr[data-tpl-key=\"${CSS.escape(preserveKey)}\"]`);\n        if (row) {\n            row.style.backgroundColor = 'var(--cobalt30a)';\n            row.style.border = '';\n        }\n    }\n}\n\n/**\n * Open editor for an existing template (triggers-based)\n * @param {Popup} parentPopup\n * @param {string} key\n */\nasync function openEditTemplate(parentPopup, key) {\n    try {\n        const tpl = await getTemplate(key);\n        if (!tpl) {\n            toastr.error(tr('STMemoryBooks_TemplateNotFound', 'Template \"{{key}}\" not found', { key }), translate('STMemoryBooks', 'index.toast.title'));\n            return;\n        }\n\n        const currentEnabled = !!tpl.enabled;\n        const s = tpl.settings || {};\n        const trig = tpl.triggers || {};\n\n        const intervalEnabled = !!(trig.onInterval && Number(trig.onInterval.visibleMessages) >= 1);\n        const intervalVal = intervalEnabled ? Math.max(1, Number(trig.onInterval.visibleMessages)) : 50;\n        const afterEnabled = !!(trig.onAfterMemory && trig.onAfterMemory.enabled);\n            const manualEnabled = Array.isArray(trig.commands)\n            ? trig.commands.some(c => String(c).toLowerCase() === 'sideprompt')\n            : false; // default to false for manual when not specified\n\n        // Per-template override controls\n        const profiles = extension_settings?.STMemoryBooks?.profiles || [];\n        let idx = Number.isFinite(s.overrideProfileIndex) ? Number(s.overrideProfileIndex) : (extension_settings?.STMemoryBooks?.defaultProfile ?? 0);\n        if (!(idx >= 0 && idx < profiles.length)) idx = 0;\n        const overrideEnabled = !!s.overrideProfileEnabled;\n        const options = profiles.map((p, i) =>\n            `<option value=\"${i}\" ${i === idx ? 'selected' : ''}>${escapeHtml(p?.name || ('Profile ' + (i + 1)))}</option>`\n        ).join('');\n\n        const overrideHtml = `\n            <div class=\"world_entry_form_control\">\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-edit-override-enabled\" ${overrideEnabled ? 'checked' : ''}>\n                    <span>${escapeHtml(translate('Override default memory profile', 'STMemoryBooks_OverrideDefaultMemoryProfile'))}</span>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\" id=\"stmb-sp-edit-override-container\" style=\"display: ${overrideEnabled ? 'block' : 'none'};\">\n                <label for=\"stmb-sp-edit-override-index\">\n                    <h4>${escapeHtml(translate('Connection Profile:', 'STMemoryBooks_ConnectionProfile'))}</h4>\n                    <select id=\"stmb-sp-edit-override-index\" class=\"text_pole\">\n                        ${options}\n                    </select>\n                </label>\n            </div>\n        `;\n\n        // Lorebook entry settings (defaults with safe fallbacks)\n        const prevMemCount = Number.isFinite(s.previousMemoriesCount) ? Number(s.previousMemoriesCount) : 0;\n        const lb = (s && s.lorebook) || {};\n        const lbMode = lb.constVectMode || 'link';\n        const lbPosition = Number.isFinite(lb.position) ? Number(lb.position) : 0;\n        const lbOrderManual = lb.orderMode === 'manual';\n        const lbOrderValue = Number.isFinite(lb.orderValue) ? Number(lb.orderValue) : 100;\n        const lbPrevent = lb.preventRecursion !== false;\n        const lbDelay = !!lb.delayUntilRecursion;\n\n        const content = `\n            <h3>${escapeHtml(translate('Edit Side Prompt', 'STMemoryBooks_EditSidePrompt'))}</h3>\n            <div class=\"world_entry_form_control\">\n                <small>${escapeHtml(translate('Key:', 'STMemoryBooks_Key'))} <code>${escapeHtml(tpl.key)}</code></small>\n            </div>\n            <div class=\"world_entry_form_control\">\n                <label for=\"stmb-sp-edit-name\">\n                    <h4>${escapeHtml(translate('Name:', 'STMemoryBooks_Name'))}</h4>\n                    <input type=\"text\" id=\"stmb-sp-edit-name\" class=\"text_pole\" value=\"${escapeHtml(tpl.name)}\" />\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\">\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-edit-enabled\" ${currentEnabled ? 'checked' : ''}>\n                    <span>${escapeHtml(translate('Enabled', 'STMemoryBooks_Enabled'))}</span>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\">\n                <h4>${escapeHtml(translate('Triggers:', 'STMemoryBooks_Triggers'))}</h4>\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-edit-trg-interval\" ${intervalEnabled ? 'checked' : ''}>\n                    <span>${escapeHtml(translate('Run on visible message interval', 'STMemoryBooks_RunOnVisibleMessageInterval'))}</span>\n                </label>\n                <div id=\"stmb-sp-edit-interval-container\" style=\"display:${intervalEnabled ? 'block' : 'none'}; margin-left:28px;\">\n                    <label for=\"stmb-sp-edit-interval\">\n                        <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Interval (visible messages):', 'STMemoryBooks_IntervalVisibleMessages'))}</h4>\n                        <input type=\"number\" id=\"stmb-sp-edit-interval\" class=\"text_pole\" min=\"1\" step=\"1\" value=\"${intervalVal}\">\n                    </label>\n                </div>\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-edit-trg-aftermem\" ${afterEnabled ? 'checked' : ''}>\n                    <span>${escapeHtml(translate('Run automatically after memory', 'STMemoryBooks_RunAutomaticallyAfterMemory'))}</span>\n                </label>\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-edit-trg-manual\" ${manualEnabled ? 'checked' : ''}>\n                    <span>${escapeHtml(translate('Allow manual run via /sideprompt', 'STMemoryBooks_AllowManualRunViaSideprompt'))}</span>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\">\n                <label for=\"stmb-sp-edit-prompt\">\n                    <h4>${escapeHtml(translate('Prompt:', 'STMemoryBooks_PromptTitle'))}</h4>\n                    <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-sp-edit-prompt\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\n                    <textarea id=\"stmb-sp-edit-prompt\" class=\"text_pole textarea_compact\" rows=\"10\">${escapeHtml(tpl.prompt || '')}</textarea>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\">\n                <label for=\"stmb-sp-edit-response-format\">\n                    <h4>${escapeHtml(translate('Response Format (optional):', 'STMemoryBooks_ResponseFormatOptional'))}</h4>\n                    <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-sp-edit-response-format\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\n                    <textarea id=\"stmb-sp-edit-response-format\" class=\"text_pole textarea_compact\" rows=\"6\">${escapeHtml(tpl.responseFormat || '')}</textarea>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\">\n                <h4>${escapeHtml(translate('Lorebook Entry Settings', 'STMemoryBooks_LorebookEntrySettings'))}:</h4>\n                <div class=\"flex-container\" style=\"gap:12px; flex-wrap: wrap;\">\n                    <label>\n                        <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Activation Mode', 'STMemoryBooks_ActivationMode'))}:</h4>\n                        <select id=\"stmb-sp-edit-lb-mode\" class=\"text_pole\">\n                            <option value=\"link\" ${lbMode === 'link' ? 'selected' : ''}>${escapeHtml(translate(' Vectorized (Default)', 'STMemoryBooks_Vectorized'))}</option>\n                            <option value=\"green\" ${lbMode === 'green' ? 'selected' : ''}>${escapeHtml(translate(' Normal', 'STMemoryBooks_Normal'))}</option>\n                            <option value=\"blue\" ${lbMode === 'blue' ? 'selected' : ''}>${escapeHtml(translate(' Constant', 'STMemoryBooks_Constant'))}</option>\n                        </select>\n                    </label>\n                    <label>\n                        <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Insertion Position:', 'STMemoryBooks_InsertionPosition'))}</h4>\n                        <select id=\"stmb-sp-edit-lb-position\" class=\"text_pole\">\n                            <option value=\"0\" ${lbPosition === 0 ? 'selected' : ''}>${escapeHtml(translate('Char', 'STMemoryBooks_CharUp'))}</option>\n                            <option value=\"1\" ${lbPosition === 1 ? 'selected' : ''}>${escapeHtml(translate('Char', 'STMemoryBooks_CharDown'))}</option>\n                            <option value=\"5\" ${lbPosition === 5 ? 'selected' : ''}>${escapeHtml(translate('EM', 'STMemoryBooks_EMUp'))}</option>\n                            <option value=\"6\" ${lbPosition === 6 ? 'selected' : ''}>${escapeHtml(translate('EM', 'STMemoryBooks_EMDown'))}</option>\n                            <option value=\"2\" ${lbPosition === 2 ? 'selected' : ''}>${escapeHtml(translate('AN', 'STMemoryBooks_ANUp'))}</option>\n                            <option value=\"3\" ${lbPosition === 3 ? 'selected' : ''}>${escapeHtml(translate('AN', 'STMemoryBooks_ANDown'))}</option>\n                            <option value=\"7\" ${lbPosition === 7 ? 'selected' : ''}>${escapeHtml(translate('Outlet', 'STMemoryBooks_Outlet'))}</option>\n                        </select>\n                        <div id=\"stmb-sp-edit-lb-outlet-name-container\" style=\"display:${lbPosition === 7 ? 'block' : 'none'}; margin-top: 8px;\">\n                            <label>\n                                <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Outlet Name:', 'STMemoryBooks_OutletName'))}</h4>\n                                <input type=\"text\" id=\"stmb-sp-edit-lb-outlet-name\" class=\"text_pole\" placeholder=\"${escapeHtml(translate('Outlet name', 'STMemoryBooks_OutletNamePlaceholder'))}\" value=\"${escapeHtml(lb.outletName || '')}\">\n                            </label>\n                        </div>\n                    </label>\n                </div>\n                <div class=\"world_entry_form_control\" style=\"margin-top: 8px;\">\n                    <h4>${escapeHtml(translate('Insertion Order:', 'STMemoryBooks_InsertionOrder'))}</h4>\n                    <label class=\"radio_label\">\n                        <input type=\"radio\" name=\"stmb-sp-edit-lb-order-mode\" id=\"stmb-sp-edit-lb-order-auto\" value=\"auto\" ${lbOrderManual ? '' : 'checked'}>\n                        <span>${escapeHtml(translate('Auto (uses memory #)', 'STMemoryBooks_AutoOrder'))}</span>\n                    </label>\n                    <label class=\"radio_label\" style=\"margin-left: 12px;\">\n                        <input type=\"radio\" name=\"stmb-sp-edit-lb-order-mode\" id=\"stmb-sp-edit-lb-order-manual\" value=\"manual\" ${lbOrderManual ? 'checked' : ''}>\n                        <span>${escapeHtml(translate('Manual', 'STMemoryBooks_ManualOrder'))}</span>\n                    </label>\n                    <div id=\"stmb-sp-edit-lb-order-value-container\" style=\"display:${lbOrderManual ? 'block' : 'none'}; margin-left:28px;\">\n                        <label>\n                            <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Order Value:', 'STMemoryBooks_OrderValue'))}</h4>\n                            <input type=\"number\" id=\"stmb-sp-edit-lb-order-value\" class=\"text_pole\" step=\"1\" value=\"${lbOrderValue}\">\n                        </label>\n                    </div>\n                </div>\n                <div class=\"world_entry_form_control\" style=\"margin-top: 8px;\">\n                    <label class=\"checkbox_label\">\n                        <input type=\"checkbox\" id=\"stmb-sp-edit-lb-prevent\" ${lbPrevent ? 'checked' : ''}>\n                        <span>${escapeHtml(translate('Prevent Recursion', 'STMemoryBooks_PreventRecursion'))}</span>\n                    </label>\n                    <label class=\"checkbox_label\" style=\"margin-left: 12px;\">\n                        <input type=\"checkbox\" id=\"stmb-sp-edit-lb-delay\" ${lbDelay ? 'checked' : ''}>\n                        <span>${escapeHtml(translate('Delay Until Recursion', 'STMemoryBooks_DelayUntilRecursion'))}</span>\n                    </label>\n                </div>\n            </div>\n\n            <div class=\"world_entry_form_control\">\n                <label for=\"stmb-sp-edit-prev-mem-count\">\n                    <h4>${escapeHtml(translate('Previous memories for context:', 'STMemoryBooks_PreviousMemoriesForContext'))}</h4>\n<input type=\"number\" id=\"stmb-sp-edit-prev-mem-count\" class=\"text_pole\" min=\"0\" max=\"7\" step=\"1\" value=\"${prevMemCount}\">\n                </label>\n                <small class=\"opacity70p\">${escapeHtml(translate('Number of previous memory entries to include before scene text (0 = none).', 'STMemoryBooks_PreviousMemoriesHelp'))}</small>\n            </div>\n\n            <div class=\"world_entry_form_control\">\n                <h4>${escapeHtml(translate('Overrides:', 'STMemoryBooks_Overrides'))}</h4>\n                ${overrideHtml}\n            </div>\n        `;\n\n        const editPopup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, '', {\n            wide: true,\n            large: true,\n            allowVerticalScrolling: true,\n            okButton: translate('Save', 'STMemoryBooks_Save'),\n            cancelButton: translate('Cancel', 'STMemoryBooks_Cancel')\n        });\n\n        // Attach dynamic handlers before show\n        const attachHandlers = () => {\n            const dlg = editPopup.dlg;\n            if (!dlg) return;\n\n            const cbInterval = dlg.querySelector('#stmb-sp-edit-trg-interval');\n            const intervalCont = dlg.querySelector('#stmb-sp-edit-interval-container');\n            cbInterval?.addEventListener('change', () => {\n                if (intervalCont) intervalCont.style.display = cbInterval.checked ? 'block' : 'none';\n                if (cbInterval.checked) dlg.querySelector('#stmb-sp-edit-interval')?.focus();\n            });\n\n            const cbOverride = dlg.querySelector('#stmb-sp-edit-override-enabled');\n            const overrideCont = dlg.querySelector('#stmb-sp-edit-override-container');\n            cbOverride?.addEventListener('change', () => {\n                if (overrideCont) overrideCont.style.display = cbOverride.checked ? 'block' : 'none';\n            });\n\n            // Lorebook order mode visibility\n            const orderAuto = dlg.querySelector('#stmb-sp-edit-lb-order-auto');\n            const orderManual = dlg.querySelector('#stmb-sp-edit-lb-order-manual');\n            const orderValCont = dlg.querySelector('#stmb-sp-edit-lb-order-value-container');\n            const syncOrderVisibility = () => {\n                if (orderValCont) orderValCont.style.display = orderManual?.checked ? 'block' : 'none';\n            };\n            orderAuto?.addEventListener('change', syncOrderVisibility);\n            orderManual?.addEventListener('change', syncOrderVisibility);\n\n            // Toggle Outlet Name based on position\n            const posSel = dlg.querySelector('#stmb-sp-edit-lb-position');\n            const outletCont = dlg.querySelector('#stmb-sp-edit-lb-outlet-name-container');\n            posSel?.addEventListener('change', () => {\n                if (outletCont) outletCont.style.display = posSel.value === '7' ? 'block' : 'none';\n            });\n        };\n\n        const showPromise = editPopup.show();\n        attachHandlers();\n        const result = await showPromise;\n        if (result === POPUP_RESULT.AFFIRMATIVE) {\n            const dlg = editPopup.dlg;\n            const newName = dlg.querySelector('#stmb-sp-edit-name')?.value.trim() || '';\n            const newPrompt = dlg.querySelector('#stmb-sp-edit-prompt')?.value.trim() || '';\n            const newResponseFormat = dlg.querySelector('#stmb-sp-edit-response-format')?.value.trim() || '';\n            const newEnabled = !!dlg.querySelector('#stmb-sp-edit-enabled')?.checked;\n\n            if (!newPrompt) {\n                toastr.error(translate('Prompt cannot be empty', 'STMemoryBooks_PromptCannotBeEmpty'), translate('STMemoryBooks', 'index.toast.title'));\n                return;\n            }\n            if (!newName) {\n                toastr.info(translate('Name was empty. Keeping previous name.', 'STMemoryBooks_NameEmptyKeepPrevious'), translate('STMemoryBooks', 'index.toast.title'));\n            }\n\n            // Triggers\n            const triggers = {};\n            const intervalOn = !!dlg.querySelector('#stmb-sp-edit-trg-interval')?.checked;\n            const afterOn = !!dlg.querySelector('#stmb-sp-edit-trg-aftermem')?.checked;\n            const manualOn = !!dlg.querySelector('#stmb-sp-edit-trg-manual')?.checked;\n\n            if (intervalOn) {\n                const intervalRaw = parseInt(dlg.querySelector('#stmb-sp-edit-interval')?.value ?? '50', 10);\n                const vis = Math.max(1, isNaN(intervalRaw) ? 50 : intervalRaw);\n                triggers.onInterval = { visibleMessages: vis };\n            }\n            if (afterOn) {\n                triggers.onAfterMemory = { enabled: true };\n            }\n            if (manualOn) {\n                triggers.commands = ['sideprompt'];\n            }\n\n            // Overrides in settings\n            const settings = { ...(tpl.settings || {}) };\n            const overrideEnabled2 = !!dlg.querySelector('#stmb-sp-edit-override-enabled')?.checked;\n            settings.overrideProfileEnabled = overrideEnabled2;\n            if (overrideEnabled2) {\n                const oidx = parseInt(dlg.querySelector('#stmb-sp-edit-override-index')?.value ?? '', 10);\n                if (!isNaN(oidx)) settings.overrideProfileIndex = oidx;\n            } else {\n                delete settings.overrideProfileIndex;\n            }\n\n            // Lorebook settings\n            const lbModeSel = dlg.querySelector('#stmb-sp-edit-lb-mode')?.value || 'link';\n            const lbPosRaw = parseInt(dlg.querySelector('#stmb-sp-edit-lb-position')?.value ?? '0', 10);\n            const lbOrderManual2 = !!dlg.querySelector('#stmb-sp-edit-lb-order-manual')?.checked;\n            const lbOrderValRaw = parseInt(dlg.querySelector('#stmb-sp-edit-lb-order-value')?.value ?? '100', 10);\n            const lbPrevent2 = !!dlg.querySelector('#stmb-sp-edit-lb-prevent')?.checked;\n            const lbDelay2 = !!dlg.querySelector('#stmb-sp-edit-lb-delay')?.checked;\n            const outletNameVal = lbPosRaw === 7 ? (dlg.querySelector('#stmb-sp-edit-lb-outlet-name')?.value?.trim() || '') : '';\n\n            const prevCountRaw = parseInt(dlg.querySelector('#stmb-sp-edit-prev-mem-count')?.value ?? '0', 10);\nsettings.previousMemoriesCount = Number.isFinite(prevCountRaw) && prevCountRaw > 0 ? Math.min(prevCountRaw, 7) : 0;\n\n            settings.lorebook = {\n                constVectMode: ['link', 'green', 'blue'].includes(lbModeSel) ? lbModeSel : 'link',\n                position: Number.isFinite(lbPosRaw) ? lbPosRaw : 0,\n                orderMode: lbOrderManual2 ? 'manual' : 'auto',\n                orderValue: Number.isFinite(lbOrderValRaw) ? lbOrderValRaw : 100,\n                preventRecursion: lbPrevent2,\n                delayUntilRecursion: lbDelay2,\n                ...(lbPosRaw === 7 && outletNameVal ? { outletName: outletNameVal } : {}),\n            };\n\n            await upsertTemplate({\n                key: tpl.key,\n                name: newName,\n                enabled: newEnabled,\n                prompt: newPrompt,\n                responseFormat: newResponseFormat,\n                settings,\n                triggers,\n            });\n            toastr.success(tr('STMemoryBooks_Toast_SidePromptUpdated', 'SidePrompt \"{{name}}\" updated.', { name: newName || tpl.name }), translate('STMemoryBooks', 'index.toast.title'));\n            window.dispatchEvent(new CustomEvent('stmb-sideprompts-updated'));\n            await refreshList(parentPopup, tpl.key);\n        }\n    } catch (err) {\n        console.error('STMemoryBooks: Error editing side prompt:', err);\n        toastr.error(translate('Failed to edit SidePrompt', 'STMemoryBooks_FailedToEditSidePrompt'), translate('STMemoryBooks', 'index.toast.title'));\n    }\n}\n\n/**\n * Open create-new template dialog (triggers-based)\n * @param {Popup} parentPopup\n */\nasync function openNewTemplate(parentPopup) {\n    // Default triggers: manual enabled; others off\n    const profiles = extension_settings?.STMemoryBooks?.profiles || [];\n    let idx = Number(extension_settings?.STMemoryBooks?.defaultProfile ?? 0);\n    if (!(idx >= 0 && idx < profiles.length)) idx = 0;\n\n    const options = profiles.map((p, i) =>\n        `<option value=\"${i}\" ${i === idx ? 'selected' : ''}>${escapeHtml(p?.name || ('Profile ' + (i + 1)))}</option>`\n    ).join('');\n\n    const content = `\n        <h3>${escapeHtml(translate('New Side Prompt', 'STMemoryBooks_NewSidePrompt'))}</h3>\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-sp-new-name\">\n                <h4>${escapeHtml(translate('Name:', 'STMemoryBooks_Name'))}</h4>\n                <input type=\"text\" id=\"stmb-sp-new-name\" class=\"text_pole\" placeholder=\"${escapeHtml(translate('My Side Prompt', 'STMemoryBooks_MySidePromptPlaceholder'))}\" />\n            </label>\n        </div>\n        <div class=\"world_entry_form_control\">\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-sp-new-enabled\">\n                <span>${escapeHtml(translate('Enabled', 'STMemoryBooks_Enabled'))}</span>\n            </label>\n        </div>\n        <div class=\"world_entry_form_control\">\n            <h4>${escapeHtml(translate('Triggers:', 'STMemoryBooks_Triggers'))}</h4>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-sp-new-trg-interval\">\n                <span>${escapeHtml(translate('Run on visible message interval', 'STMemoryBooks_RunOnVisibleMessageInterval'))}</span>\n            </label>\n            <div id=\"stmb-sp-new-interval-container\" class=\"displayNone\" style=\"margin-left:28px;\">\n                <label for=\"stmb-sp-new-interval\">\n                    <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Interval (visible messages):', 'STMemoryBooks_IntervalVisibleMessages'))}</h4>\n                    <input type=\"number\" id=\"stmb-sp-new-interval\" class=\"text_pole\" min=\"1\" step=\"1\" value=\"50\">\n                </label>\n            </div>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-sp-new-trg-aftermem\">\n                <span>${escapeHtml(translate('Run automatically after memory', 'STMemoryBooks_RunAutomaticallyAfterMemory'))}</span>\n            </label>\n            <label class=\"checkbox_label\">\n                <input type=\"checkbox\" id=\"stmb-sp-new-trg-manual\" checked>\n                <span>${escapeHtml(translate('Allow manual run via /sideprompt', 'STMemoryBooks_AllowManualRunViaSideprompt'))}</span>\n            </label>\n        </div>\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-sp-new-prompt\">\n                <h4>${escapeHtml(translate('Prompt:', 'STMemoryBooks_PromptTitle'))}</h4>\n                <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-sp-new-prompt\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\n                <textarea id=\"stmb-sp-new-prompt\" class=\"text_pole textarea_compact\" rows=\"8\" placeholder=\"${escapeHtml(translate('Enter your prompt here...', 'STMemoryBooks_EnterPromptPlaceholder'))}\"></textarea>\n            </label>\n        </div>\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-sp-new-response-format\">\n                <h4>${escapeHtml(translate('Response Format (optional):', 'STMemoryBooks_ResponseFormatOptional'))}</h4>\n                <i class=\"editor_maximize fa-solid fa-maximize right_menu_button\" data-for=\"stmb-sp-new-response-format\" title=\"Expand the editor\" data-i18n=\"[title]STMemoryBooks_ExpandEditor\"></i>\n                <textarea id=\"stmb-sp-new-response-format\" class=\"text_pole textarea_compact\" rows=\"6\" placeholder=\"${escapeHtml(translate('Optional response format', 'STMemoryBooks_ResponseFormatPlaceholder'))}\"></textarea>\n            </label>\n        </div>\n        <div class=\"world_entry_form_control\">\n            <h4>${escapeHtml(translate('Lorebook Entry Settings', 'STMemoryBooks_LorebookEntrySettings'))}:</h4>\n            <div class=\"flex-container\" style=\"gap:12px; flex-wrap: wrap;\">\n                <label>\n                    <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Activation Mode', 'STMemoryBooks_ActivationMode'))}:</h4>\n                    <select id=\"stmb-sp-new-lb-mode\" class=\"text_pole\">\n                        <option value=\"link\" selected>${escapeHtml(translate(' Vectorized (Default)', 'STMemoryBooks_Vectorized'))}</option>\n                        <option value=\"green\">${escapeHtml(translate(' Normal', 'STMemoryBooks_Normal'))}</option>\n                        <option value=\"blue\">${escapeHtml(translate(' Constant', 'STMemoryBooks_Constant'))}</option>\n                    </select>\n                </label>\n                <label>\n                    <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Insertion Position:', 'STMemoryBooks_InsertionPosition'))}</h4>\n                    <select id=\"stmb-sp-new-lb-position\" class=\"text_pole\">\n                        <option value=\"0\" selected>${escapeHtml(translate('Char', 'STMemoryBooks_CharUp'))}</option>\n                        <option value=\"1\">${escapeHtml(translate('Char', 'STMemoryBooks_CharDown'))}</option>\n                        <option value=\"2\">${escapeHtml(translate('AN', 'STMemoryBooks_ANUp'))}</option>\n                        <option value=\"3\">${escapeHtml(translate('AN', 'STMemoryBooks_ANDown'))}</option>\n                        <option value=\"4\">${escapeHtml(translate('EM', 'STMemoryBooks_EMUp'))}</option>\n                        <option value=\"5\">${escapeHtml(translate('EM', 'STMemoryBooks_EMDown'))}</option>\n                        <option value=\"7\">${escapeHtml(translate('Outlet', 'STMemoryBooks_Outlet'))}</option>\n                    </select>\n                    <div id=\"stmb-sp-new-lb-outlet-name-container\" class=\"displayNone\" style=\"margin-top: 8px;\">\n                        <label>\n                            <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Outlet Name:', 'STMemoryBooks_OutletName'))}</h4>\n                            <input type=\"text\" id=\"stmb-sp-new-lb-outlet-name\" class=\"text_pole\" placeholder=\"${escapeHtml(translate('Outlet name (e.g., ENDING)', 'STMemoryBooks_OutletNamePlaceholder'))}\">\n                        </label>\n                    </div>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\" style=\"margin-top: 8px;\">\n                <h4>${escapeHtml(translate('Insertion Order:', 'STMemoryBooks_InsertionOrder'))}</h4>\n                <label class=\"radio_label\">\n                    <input type=\"radio\" name=\"stmb-sp-new-lb-order-mode\" id=\"stmb-sp-new-lb-order-auto\" value=\"auto\" checked>\n                    <span>${escapeHtml(translate('Auto (uses memory #)', 'STMemoryBooks_AutoOrder'))}</span>\n                </label>\n                <label class=\"radio_label\" style=\"margin-left: 12px;\">\n                    <input type=\"radio\" name=\"stmb-sp-new-lb-order-mode\" id=\"stmb-sp-new-lb-order-manual\" value=\"manual\">\n                    <span>${escapeHtml(translate('Manual', 'STMemoryBooks_ManualOrder'))}</span>\n                </label>\n                <div id=\"stmb-sp-new-lb-order-value-container\" style=\"display:none; margin-left:28px;\">\n                    <label>\n                        <h4 style=\"margin: 0 0 4px 0;\">${escapeHtml(translate('Order Value:', 'STMemoryBooks_OrderValue'))}</h4>\n                        <input type=\"number\" id=\"stmb-sp-new-lb-order-value\" class=\"text_pole\" step=\"1\" value=\"100\">\n                    </label>\n                </div>\n            </div>\n            <div class=\"world_entry_form_control\" style=\"margin-top: 8px;\">\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-new-lb-prevent\" checked>\n                    <span>${escapeHtml(translate('Prevent Recursion', 'STMemoryBooks_PreventRecursion'))}</span>\n                </label>\n                <label class=\"checkbox_label\" style=\"margin-left: 12px;\">\n                    <input type=\"checkbox\" id=\"stmb-sp-new-lb-delay\">\n                    <span>${escapeHtml(translate('Delay Until Recursion', 'STMemoryBooks_DelayUntilRecursion'))}</span>\n                </label>\n            </div>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <label for=\"stmb-sp-new-prev-mem-count\">\n                <h4>${escapeHtml(translate('Previous memories for context:', 'STMemoryBooks_PreviousMemoriesForContext'))}</h4>\n<input type=\"number\" id=\"stmb-sp-new-prev-mem-count\" class=\"text_pole\" min=\"0\" max=\"7\" step=\"1\" value=\"0\">\n            </label>\n            <small class=\"opacity70p\">${escapeHtml(translate('Number of previous memory entries to include before scene text (0 = none).', 'STMemoryBooks_PreviousMemoriesHelp'))}</small>\n        </div>\n\n        <div class=\"world_entry_form_control\">\n            <h4>${escapeHtml(translate('Overrides:', 'STMemoryBooks_Overrides'))}</h4>\n            <div class=\"world_entry_form_control\">\n                <label class=\"checkbox_label\">\n                    <input type=\"checkbox\" id=\"stmb-sp-new-override-enabled\">\n                    <span>${escapeHtml(translate('Override default memory profile', 'STMemoryBooks_OverrideDefaultMemoryProfile'))}</span>\n                </label>\n            </div>\n            <div class=\"world_entry_form_control\" id=\"stmb-sp-new-override-container\" style=\"display: none;\">\n                <label for=\"stmb-sp-new-override-index\">\n                    <h4>${escapeHtml(translate('Connection Profile:', 'STMemoryBooks_ConnectionProfile'))}</h4>\n                    <select id=\"stmb-sp-new-override-index\" class=\"text_pole\">\n                        ${options}\n                    </select>\n                </label>\n            </div>\n        </div>\n    `;\n\n    const newPopup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, '', {\n        wide: true,\n        large: true,\n        allowVerticalScrolling: true,\n        okButton: translate('Create', 'STMemoryBooks_Create'),\n        cancelButton: translate('Cancel', 'STMemoryBooks_Cancel')\n    });\n\n    const attachHandlers = () => {\n        const dlg = newPopup.dlg;\n\n        const cbInterval = dlg.querySelector('#stmb-sp-new-trg-interval');\n        const intervalCont = dlg.querySelector('#stmb-sp-new-interval-container');\n        cbInterval?.addEventListener('change', () => {\n            if (intervalCont) intervalCont.style.display = cbInterval.checked ? 'block' : 'none';\n            if (cbInterval.checked) dlg.querySelector('#stmb-sp-new-interval')?.focus();\n        });\n\n        const cbOverride = dlg.querySelector('#stmb-sp-new-override-enabled');\n        const overrideCont = dlg.querySelector('#stmb-sp-new-override-container');\n        cbOverride?.addEventListener('change', () => {\n            if (overrideCont) overrideCont.style.display = cbOverride.checked ? 'block' : 'none';\n        });\n\n        // Lorebook order mode visibility\n        const orderAuto = dlg.querySelector('#stmb-sp-new-lb-order-auto');\n        const orderManual = dlg.querySelector('#stmb-sp-new-lb-order-manual');\n        const orderValCont = dlg.querySelector('#stmb-sp-new-lb-order-value-container');\n        const syncOrderVisibility = () => {\n            if (orderValCont) orderValCont.style.display = orderManual?.checked ? 'block' : 'none';\n        };\n        orderAuto?.addEventListener('change', syncOrderVisibility);\n        orderManual?.addEventListener('change', syncOrderVisibility);\n\n        // Toggle Outlet Name based on position\n        const posSelNew = dlg.querySelector('#stmb-sp-new-lb-position');\n        const outletContNew = dlg.querySelector('#stmb-sp-new-lb-outlet-name-container');\n        posSelNew?.addEventListener('change', () => {\n            if (outletContNew) outletContNew.classList.toggle('displayNone', posSelNew.value !== '7');\n        });\n    };\n\n    const showPromise = newPopup.show();\n    attachHandlers();\n    const result = await showPromise;\n    if (result === POPUP_RESULT.AFFIRMATIVE) {\n        const dlg = newPopup.dlg;\n        const name = dlg.querySelector('#stmb-sp-new-name')?.value.trim() || '';\n        const enabled = !!dlg.querySelector('#stmb-sp-new-enabled')?.checked;\n        const prompt = dlg.querySelector('#stmb-sp-new-prompt')?.value.trim() || '';\n        const responseFormat = dlg.querySelector('#stmb-sp-new-response-format')?.value.trim() || '';\n\n        if (!prompt) {\n            toastr.error(translate('Prompt cannot be empty', 'STMemoryBooks_PromptCannotBeEmpty'), translate('STMemoryBooks', 'index.toast.title'));\n            return;\n        }\n        if (!name) {\n            toastr.info(tr('STMemoryBooks_SidePrompts_NoNameProvidedUsingUntitled', 'No name provided. Using \"{{name}}\".', { name: translate('Untitled Side Prompt', 'STMemoryBooks_UntitledSidePrompt') }), translate('STMemoryBooks', 'index.toast.title'));\n        }\n\n        // Build triggers\n        const triggers = {};\n        const intervalOn = !!dlg.querySelector('#stmb-sp-new-trg-interval')?.checked;\n        const afterOn = !!dlg.querySelector('#stmb-sp-new-trg-aftermem')?.checked;\n        const manualOn = !!dlg.querySelector('#stmb-sp-new-trg-manual')?.checked;\n\n        if (intervalOn) {\n            const intervalRaw = parseInt(dlg.querySelector('#stmb-sp-new-interval')?.value ?? '50', 10);\n            const vis = Math.max(1, isNaN(intervalRaw) ? 50 : intervalRaw);\n            triggers.onInterval = { visibleMessages: vis };\n        }\n        if (afterOn) {\n            triggers.onAfterMemory = { enabled: true };\n        }\n        if (manualOn) {\n            triggers.commands = ['sideprompt'];\n        }\n\n        // Settings - overrides\n        const settings = {};\n        const overrideEnabled = !!dlg.querySelector('#stmb-sp-new-override-enabled')?.checked;\n        settings.overrideProfileEnabled = overrideEnabled;\n        if (overrideEnabled) {\n            const oidx = parseInt(dlg.querySelector('#stmb-sp-new-override-index')?.value ?? '', 10);\n            if (!isNaN(oidx)) settings.overrideProfileIndex = oidx;\n        }\n\n        // Settings - lorebook\n        const lbModeSel = dlg.querySelector('#stmb-sp-new-lb-mode')?.value || 'link';\n        const lbPosRaw = parseInt(dlg.querySelector('#stmb-sp-new-lb-position')?.value ?? '0', 10);\n        const lbOrderManual2 = !!dlg.querySelector('#stmb-sp-new-lb-order-manual')?.checked;\n        const lbOrderValRaw = parseInt(dlg.querySelector('#stmb-sp-new-lb-order-value')?.value ?? '100', 10);\n        const lbPrevent2 = !!dlg.querySelector('#stmb-sp-new-lb-prevent')?.checked;\n        const lbDelay2 = !!dlg.querySelector('#stmb-sp-new-lb-delay')?.checked;\n        const outletNameVal = lbPosRaw === 7 ? (dlg.querySelector('#stmb-sp-new-lb-outlet-name')?.value?.trim() || '') : '';\n\n        const prevCountRaw = parseInt(dlg.querySelector('#stmb-sp-new-prev-mem-count')?.value ?? '0', 10);\nsettings.previousMemoriesCount = Number.isFinite(prevCountRaw) && prevCountRaw > 0 ? Math.min(prevCountRaw, 7) : 0;\n\n        settings.lorebook = {\n            constVectMode: ['link', 'green', 'blue'].includes(lbModeSel) ? lbModeSel : 'link',\n            position: Number.isFinite(lbPosRaw) ? lbPosRaw : 0,\n            orderMode: lbOrderManual2 ? 'manual' : 'auto',\n            orderValue: Number.isFinite(lbOrderValRaw) ? lbOrderValRaw : 100,\n            preventRecursion: lbPrevent2,\n            delayUntilRecursion: lbDelay2,\n            ...(lbPosRaw === 7 && outletNameVal ? { outletName: outletNameVal } : {}),\n        };\n\n        try {\n            await upsertTemplate({ name, enabled, prompt, responseFormat, settings, triggers });\n            toastr.success(translate('SidePrompt created', 'STMemoryBooks_SidePromptCreated'), translate('STMemoryBooks', 'index.toast.title'));\n            await refreshList(parentPopup);\n        } catch (err) {\n            console.error('STMemoryBooks: Error creating side prompt:', err);\n            toastr.error(translate('Failed to create SidePrompt', 'STMemoryBooks_FailedToCreateSidePrompt'), translate('STMemoryBooks', 'index.toast.title'));\n        }\n    }\n}\n\n/**\n * Export templates to JSON and download\n */\nasync function exportTemplates() {\n    try {\n        const json = await exportSidePromptsJSON();\n        const blob = new Blob([json], { type: 'application/json' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = 'stmb-side-prompts.json';\n        a.click();\n        URL.revokeObjectURL(url);\n        toastr.success(translate('Side prompts exported successfully', 'STMemoryBooks_SidePromptsExported'), translate('STMemoryBooks', 'index.toast.title'));\n    } catch (err) {\n        console.error('STMemoryBooks: Error exporting side prompts:', err);\n        toastr.error(translate('Failed to export side prompts', 'STMemoryBooks_FailedToExportSidePrompts'), translate('STMemoryBooks', 'index.toast.title'));\n    }\n}\n\n/**\n * Import templates from JSON text\n * @param {Event} event\n * @param {Popup} parentPopup\n */\nasync function importTemplates(event, parentPopup) {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    try {\n        const text = await file.text();\n        const res = await importSidePromptsJSON(text);\n        if (res && typeof res === 'object') {\n            const { added = 0, renamed = 0 } = res;\n            const detail = renamed > 0 ? tr('STMemoryBooks_ImportedSidePromptsRenamedDetail', ' ({{count}} renamed due to key conflicts)', { count: renamed }) : '';\n            toastr.success(tr('STMemoryBooks_ImportedSidePromptsDetail', 'Imported side prompts: {{added}} added{{detail}}', { added, detail }), translate('STMemoryBooks', 'index.toast.title'));\n        } else {\n            toastr.success(translate('Imported side prompts', 'STMemoryBooks_ImportedSidePrompts'), translate('STMemoryBooks', 'index.toast.title'));\n        }\n        await refreshList(parentPopup);\n    } catch (err) {\n        console.error('STMemoryBooks: Error importing side prompts:', err);\n        toastr.error(tr('STMemoryBooks_FailedToImportSidePrompts', 'Failed to import: {{message}}', { message: err?.message || 'Unknown error' }), translate('STMemoryBooks', 'index.toast.title'));\n    }\n}\n\n/**\n * Show the Side Prompts popup (list view with Edit/Copy/Trash and New/Export/Import)\n */\nexport async function showSidePromptsPopup() {\n    try {\n        let content = '<h3 data-i18n=\"STMemoryBooks_SidePrompts_Title\"> Trackers & Side Prompts</h3>';\n        content += '<div class=\"world_entry_form_control\">';\n        content += '<p class=\"opacity70p\" data-i18n=\"STMemoryBooks_SidePrompts_Desc\">Create and manage side prompts for trackers and other behind-the-scenes functions.</p>';\n        content += '</div>';\n\n        // Search/filter box\n        content += '<div class=\"world_entry_form_control\">';\n        content += '<input type=\"text\" id=\"stmb-sp-search\" class=\"text_pole\" data-i18n=\"[placeholder]STMemoryBooks_SearchSidePrompts;[aria-label]STMemoryBooks_SearchSidePrompts\" placeholder=\"Search side prompts...\" aria-label=\"Search side prompts\" />';\n        content += '</div>';\n\n        // Global setting: max concurrent side prompts\n        content += '<div class=\"world_entry_form_control\">';\n        content += `<label for=\"stmb-sp-max-concurrent\"><h4>${escapeHtml(translate('How many concurrent prompts to run at once', 'STMemoryBooks_SidePrompts_MaxConcurrentLabel'))}</h4></label>`;\n        content += '<input type=\"number\" id=\"stmb-sp-max-concurrent\" class=\"text_pole\" min=\"1\" max=\"5\" step=\"1\" value=\"2\">';\n        content += `<small class=\"opacity70p\">${escapeHtml(translate('Range 15. Defaults to 2.', 'STMemoryBooks_SidePrompts_MaxConcurrentHelp'))}</small>`;\n        content += '</div>';\n\n        // List container\n        content += '<div id=\"stmb-sp-list\" class=\"padding10 marginBot10\" style=\"max-height: 400px; overflow-y: auto;\"></div>';\n\n        // Action buttons\n        content += '<div class=\"buttons_block justifyCenter gap10px whitespacenowrap\">';\n        content += `<button id=\"stmb-sp-new\" class=\"menu_button whitespacenowrap\">${escapeHtml(translate('New', 'STMemoryBooks_SidePrompts_New'))}</button>`;\n        content += `<button id=\"stmb-sp-export\" class=\"menu_button whitespacenowrap\">${escapeHtml(translate('Export JSON', 'STMemoryBooks_SidePrompts_ExportJSON'))}</button>`;\n        content += `<button id=\"stmb-sp-import\" class=\"menu_button whitespacenowrap\">${escapeHtml(translate('Import JSON', 'STMemoryBooks_SidePrompts_ImportJSON'))}</button>`;\n        content += `<button id=\"stmb-sp-recreate-builtins\" class=\"menu_button whitespacenowrap\">${escapeHtml(translate(' Recreate Built-in Side Prompts', 'STMemoryBooks_SidePrompts_RecreateBuiltIns'))}</button>`;\n        content += '</div>';\n\n        // Hidden file input for import\n        content += '<input type=\"file\" id=\"stmb-sp-import-file\" accept=\".json\" style=\"display: none;\" />';\n\n        const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, '', {\n            wide: true,\n            large: true,\n            allowVerticalScrolling: true,\n            okButton: false,\n            cancelButton: translate('Close', 'STMemoryBooks_Close')\n        });\n\n        // Attach handlers before show\n        const attachHandlers = () => {\n            const dlg = popup.dlg;\n            if (!dlg) return;\n\n            // Max concurrent control\n            const spMaxInput = dlg.querySelector('#stmb-sp-max-concurrent');\n            if (spMaxInput) {\n                const clamp = (n, min, max) => Math.max(min, Math.min(max, n));\n                const current = clamp(Number(extension_settings?.STMemoryBooks?.moduleSettings?.sidePromptsMaxConcurrent ?? 2), 1, 5);\n                spMaxInput.value = String(current);\n                const persist = () => {\n                    const raw = parseInt(spMaxInput.value, 10);\n                    const val = clamp(isNaN(raw) ? 2 : raw, 1, 5);\n                    spMaxInput.value = String(val);\n                    // Ensure settings objects exist\n                    if (!extension_settings.STMemoryBooks) extension_settings.STMemoryBooks = { moduleSettings: {} };\n                    if (!extension_settings.STMemoryBooks.moduleSettings) extension_settings.STMemoryBooks.moduleSettings = {};\n                    extension_settings.STMemoryBooks.moduleSettings.sidePromptsMaxConcurrent = val;\n                    saveSettingsDebounced();\n                };\n                spMaxInput.addEventListener('change', persist);\n            }\n\n            // Search\n            dlg.querySelector('#stmb-sp-search')?.addEventListener('input', () => refreshList(popup));\n\n            // Buttons\n            dlg.querySelector('#stmb-sp-new')?.addEventListener('click', async () => {\n                await openNewTemplate(popup);\n            });\n            dlg.querySelector('#stmb-sp-export')?.addEventListener('click', async () => {\n                await exportTemplates();\n            });\n            dlg.querySelector('#stmb-sp-import')?.addEventListener('click', () => {\n                dlg.querySelector('#stmb-sp-import-file')?.click();\n            });\n            dlg.querySelector('#stmb-sp-import-file')?.addEventListener('change', async (e) => {\n                await importTemplates(e, popup);\n            });\n\n            // Recreate built-in side prompts (localized to current locale)\n            dlg.querySelector('#stmb-sp-recreate-builtins')?.addEventListener('click', async () => {\n                const warning = `<div class=\"info_block\">${escapeHtml(translate('This will overwrite the built-in Side Prompts (Plotpoints, Status, Cast of Characters, Assess) with the current locale versions. Custom/user-created prompts are not touched. This action cannot be undone.', 'STMemoryBooks_SidePrompts_RecreateWarning'))}</div>`;\n                const confirmPopup = new Popup(\n                    `<h3>${escapeHtml(translate('Recreate Built-in Side Prompts', 'STMemoryBooks_SidePrompts_RecreateTitle'))}</h3>${warning}`,\n                    POPUP_TYPE.CONFIRM,\n                    '',\n                    { okButton: translate('Recreate', 'STMemoryBooks_SidePrompts_RecreateOk'), cancelButton: translate('Cancel', 'STMemoryBooks_Cancel') }\n                );\n                const res = await confirmPopup.show();\n                if (res === POPUP_RESULT.AFFIRMATIVE) {\n                    try {\n                        const r = await recreateBuiltInSidePrompts('overwrite');\n                        const count = Number(r?.replaced || 0);\n                        toastr.success(tr('STMemoryBooks_SidePrompts_RecreateSuccess', 'Recreated {{count}} built-in side prompts from current locale', { count }), translate('STMemoryBooks', 'index.toast.title'));\n                        window.dispatchEvent(new CustomEvent('stmb-sideprompts-updated'));\n                        await refreshList(popup);\n                    } catch (err) {\n                        console.error('STMemoryBooks: Error recreating built-in side prompts:', err);\n                        toastr.error(translate('Failed to recreate built-in side prompts', 'STMemoryBooks_SidePrompts_RecreateFailed'), translate('STMemoryBooks', 'index.toast.title'));\n                    }\n                }\n            });\n\n            // Row selection and inline actions\n            dlg.addEventListener('click', async (e) => {\n                const actionBtn = e.target.closest('.stmb-sp-action');\n                const row = e.target.closest('tr[data-tpl-key]');\n                if (!row) return;\n                const tplKey = row.dataset.tplKey;\n\n                // Highlight selected row\n                dlg.querySelectorAll('tr[data-tpl-key]').forEach(r => {\n                    r.classList.remove('ui-state-active');\n                    r.style.backgroundColor = '';\n                    r.style.border = '';\n                });\n                row.style.backgroundColor = 'var(--cobalt30a)';\n                row.style.border = '';\n\n                if (actionBtn) {\n                    e.preventDefault();\n                    e.stopPropagation();\n\n                    if (actionBtn.classList.contains('stmb-sp-action-edit')) {\n                        await openEditTemplate(popup, tplKey);\n                    } else if (actionBtn.classList.contains('stmb-sp-action-duplicate')) {\n                        try {\n                            const newKey = await duplicateTemplate(tplKey);\n                            toastr.success(translate('SidePrompt duplicated', 'STMemoryBooks_SidePromptDuplicated'), translate('STMemoryBooks', 'index.toast.title'));\n                            await refreshList(popup, newKey);\n                        } catch (err) {\n                            console.error('STMemoryBooks: Error duplicating side prompt:', err);\n                            toastr.error(translate('Failed to duplicate SidePrompt', 'STMemoryBooks_FailedToDuplicateSidePrompt'), translate('STMemoryBooks', 'index.toast.title'));\n                        }\n                    } else if (actionBtn.classList.contains('stmb-sp-action-delete')) {\n                        const confirmPopup = new Popup(\n                            `<h3>${escapeHtml(tr('STMemoryBooks_DeleteSidePromptTitle', 'Delete Side Prompt', { name: tplKey }))}</h3><p>${escapeHtml(tr('STMemoryBooks_DeleteSidePromptConfirm', 'Are you sure you want to delete this template?', { name: tplKey }))}</p>`,\n                            POPUP_TYPE.CONFIRM,\n                            '',\n                            { okButton: translate('Delete', 'STMemoryBooks_Delete'), cancelButton: translate('Cancel', 'STMemoryBooks_Cancel') }\n                        );\n                        const res = await confirmPopup.show();\n                        if (res === POPUP_RESULT.AFFIRMATIVE) {\n                            try {\n                                await removeTemplate(tplKey);\n                                toastr.success(translate('SidePrompt deleted', 'STMemoryBooks_SidePromptDeleted'), translate('STMemoryBooks', 'index.toast.title'));\n                                await refreshList(popup);\n                            } catch (err) {\n                                console.error('STMemoryBooks: Error deleting side prompt:', err);\n                                toastr.error(translate('Failed to delete SidePrompt', 'STMemoryBooks_FailedToDeleteSidePrompt'), translate('STMemoryBooks', 'index.toast.title'));\n                            }\n                        }\n                    }\n                    return;\n                }\n            });\n        };\n\n        // Prepare and show popup\n        attachHandlers();\n        // Initial render BEFORE show so the table appears immediately\n        await refreshList(popup);\n        await popup.show();\n        try { applyLocale(popup); } catch (e) { /* no-op */ }\n    } catch (error) {\n        console.error('STMemoryBooks: Error showing Side Prompts:', error);\n        toastr.error(translate('Failed to open Side Prompts', 'STMemoryBooks_FailedToOpenSidePrompts'), translate('STMemoryBooks', 'index.toast.title'));\n    }\n}\n",
    "import { Handlebars } from '../../../../lib.js';\n\nexport const sidePromptsTableTemplate = Handlebars.compile(`\n<table style=\"width: 100%; border-collapse: collapse;\">\n  <thead>\n    <tr>\n      <th style=\"text-align:left;\" data-i18n=\"STMemoryBooks_Name\">Name</th>\n      <th style=\"width: 240px; text-align:left;\" data-i18n=\"STMemoryBooks_Triggers\">Triggers</th>\n      <th style=\"width: 120px; text-align:right;\" data-i18n=\"STMemoryBooks_Actions\">Actions</th>\n    </tr>\n  </thead>\n  <tbody>\n    {{#if items}}\n      {{#each items}}\n        <tr data-tpl-key=\"{{key}}\" style=\"cursor: pointer; border-bottom: 1px solid var(--SmartThemeBorderColor);\">\n          <td style=\"padding: 8px;\">{{name}}</td>\n          <td style=\"padding: 8px;\">\n              {{#if badges}}\n                {{#each badges}}\n                  <span class=\"badge\" style=\"margin-right:6px;\">{{this}}</span>\n                {{/each}}\n              {{else}}\n                <span class=\"opacity50p\" data-i18n=\"STMemoryBooks_None\">None</span>\n              {{/if}}\n          </td>\n          <td style=\"padding: 8px; text-align:right;\">\n            <span class=\"stmb-sp-inline-actions\" style=\"display: inline-flex; gap: 10px;\">\n              <button class=\"stmb-sp-action stmb-sp-action-edit\" title=\"Edit\" aria-label=\"Edit\" data-i18n=\"[title]STMemoryBooks_Edit;[aria-label]STMemoryBooks_Edit\" style=\"background:none;border:none;cursor:pointer;\">\n                <i class=\"fa-solid fa-pen\"></i>\n              </button>\n              <button class=\"stmb-sp-action stmb-sp-action-duplicate\" title=\"Duplicate\" aria-label=\"Duplicate\" data-i18n=\"[title]STMemoryBooks_Duplicate;[aria-label]STMemoryBooks_Duplicate\" style=\"background:none;border:none;cursor:pointer;\">\n                <i class=\"fa-solid fa-copy\"></i>\n              </button>\n              <button class=\"stmb-sp-action stmb-sp-action-delete\" title=\"Delete\" aria-label=\"Delete\" data-i18n=\"[title]STMemoryBooks_Delete;[aria-label]STMemoryBooks_Delete\" style=\"background:none;border:none;cursor:pointer;color:var(--redColor);\">\n                <i class=\"fa-solid fa-trash\"></i>\n              </button>\n            </span>\n          </td>\n        </tr>\n      {{/each}}\n    {{else}}\n      <tr>\n        <td colspan=\"3\">\n          <div class=\"opacity50p\" data-i18n=\"STMemoryBooks_NoSidePromptsAvailable\">No side prompts available</div>\n        </td>\n      </tr>\n    {{/if}}\n  </tbody>\n</table>\n`);\n",
    "import {\r\n  estimateTokens,\r\n  getCurrentApiInfo,\r\n  getUIModelSettings,\r\n  normalizeCompletionSource,\r\n} from \"./utils.js\";\r\nimport { sendRawCompletionRequest } from \"./stmemory.js\";\r\nimport { getDefaultArcPrompt } from \"./templatesArcPrompts.js\";\r\nimport * as ArcPrompts from \"./arcAnalysisPromptManager.js\";\r\nimport { upsertLorebookEntriesBatch } from \"./addlore.js\";\r\nimport { extension_settings } from \"../../../extensions.js\";\r\nimport { translate } from '../../../i18n.js';\r\n\r\n/**\r\n * Arc Analysis pipeline (stateless wrt model; stateful in controller).\r\n * Exports:\r\n *  - buildBriefsFromEntries(entries)\r\n *  - buildArcAnalysisPrompt({ briefs, previousArcSummary, promptText })\r\n *  - parseArcJsonResponse(text)\r\n *  - runArcAnalysisSequential(selectedEntries, options, profileOrConnection)\r\n *  - commitArcs({ lorebookName, lorebookData, arcCandidates, disableOriginals })\r\n */\r\n\r\nconst MODULE_NAME = \"STMemoryBooks-ArcAnalysis\";\r\n\r\nconst KEYWORD_PROMPT = `Based on this narrative arc summary, generate 1530 standalone topical keywords that function as retrieval tags, not micro-summaries.\r\nKeywords must be:\r\n- Concrete and scene-specific (locations, objects, proper nouns, unique actions, repeated motifs).\r\n- One concept per keyword  do NOT combine multiple ideas into one keyword.\r\n- Useful for retrieval if the user later mentions that noun or action alone, not only in a specific context.\r\n- Not {{char}}'s or {{user}}'s names.\r\n- Not thematic, emotional, or abstract. Stop-list: intimacy, vulnerability, trust, dominance, submission, power dynamics, boundaries, jealousy, aftercare, longing, consent, emotional connection.\r\n\r\nAvoid:\r\n- Overly specific compound keywords (David Tokyo marriage).\r\n- Narrative or plot-summary style keywords (art dealer date fail).\r\n- Keywords that contain multiple facts or descriptors.\r\n- Keywords that only make sense when the whole scene is remembered.\r\n\r\nPrefer:\r\n- Proper nouns (e.g., \"Chinatown\", \"Ritz-Carlton bar\").\r\n- Specific physical objects (\"CPAP machine\", \"chocolate chip cookies\").\r\n- Distinctive actions (\"cookie baking\", \"piano apology\").\r\n- Unique phrases or identifiers from the scene used by characters (\"pack for forever\", \"dick-measuring contest\").\r\n\r\nYour goal: keywords should fire when the noun/action is mentioned alone, not only when paired with a specific person or backstory.\r\n\r\nReturn ONLY a JSON array of 15-30 strings. No commentary, no explanations.`;\r\n\r\n// Utility: normalize text\r\nfunction normalizeText(s) {\r\n  return String(s || \"\")\r\n    .replace(/\\r\\n/g, \"\\n\")\r\n    .replace(/^\\uFEFF/, \"\")\r\n    .replace(/[\\u200B-\\u200D\\u2060]/g, \"\");\r\n}\r\n\r\nfunction extractFencedBlocks(s) {\r\n  const re = /```([\\w+-]*)\\s*([\\s\\S]*?)```/g;\r\n  const out = [];\r\n  let m;\r\n  while ((m = re.exec(s)) !== null) {\r\n    out.push((m[2] || \"\").trim());\r\n  }\r\n  return out;\r\n}\r\n\r\nfunction unwrapJsConcatenatedStringDump(raw) {\r\n  let s = String(raw || \"\").trim();\r\n\r\n  // Quick detection: looks like \"'...\\n' +\\n '...'\"\r\n  if (!/'\\s*\\+\\s*'/.test(s) && !/\\\\n'\\s*\\+/.test(s)) return null;\r\n\r\n  // Drop \"content:\" prefix if present\r\n  s = s.replace(/^\\s*content\\s*:\\s*/, \"\");\r\n\r\n  // Collect all single-quoted chunks: '...'\r\n  const re = /'((?:\\\\.|[^'\\\\])*)'/g;\r\n  const chunks = [];\r\n  let m;\r\n  while ((m = re.exec(s)) !== null) chunks.push(m[1]);\r\n\r\n  if (!chunks.length) return null;\r\n\r\n  // Re-join and unescape common sequences\r\n  let joined = chunks.join(\"\");\r\n  joined = joined\r\n    .replace(/\\\\r\\\\n/g, \"\\n\")\r\n    .replace(/\\\\n/g, \"\\n\")\r\n    .replace(/\\\\t/g, \"\\t\")\r\n    .replace(/\\\\\"/g, '\"')\r\n    .replace(/\\\\\\\\/g, \"\\\\\");\r\n\r\n  return joined.trim() || null;\r\n}\r\n\r\nfunction extractBalancedJson(s) {\r\n  const start = s.search(/[\\{\\[]/);\r\n  if (start === -1) return null;\r\n  const open = s[start];\r\n  const close = open === \"{\" ? \"}\" : \"]\";\r\n  let depth = 0,\r\n    inStr = false,\r\n    esc = false;\r\n  for (let i = start; i < s.length; i++) {\r\n    const ch = s[i];\r\n    if (inStr) {\r\n      if (esc) {\r\n        esc = false;\r\n      } else if (ch === \"\\\\\") {\r\n        esc = true;\r\n      } else if (ch === '\"') {\r\n        inStr = false;\r\n      }\r\n      continue;\r\n    }\r\n    if (ch === '\"') {\r\n      inStr = true;\r\n      continue;\r\n    }\r\n    if (ch === open) depth++;\r\n    else if (ch === close) {\r\n      depth--;\r\n      if (depth === 0) return s.slice(start, i + 1).trim();\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction stripJsonComments(s) {\r\n  let out = \"\";\r\n  let inStr = false,\r\n    esc = false,\r\n    inLine = false,\r\n    inBlock = false;\r\n  for (let i = 0; i < s.length; i++) {\r\n    const ch = s[i],\r\n      next = s[i + 1];\r\n    if (inStr) {\r\n      out += ch;\r\n      if (esc) esc = false;\r\n      else if (ch === \"\\\\\") esc = true;\r\n      else if (ch === '\"') inStr = false;\r\n      continue;\r\n    }\r\n    if (inLine) {\r\n      if (ch === \"\\n\") {\r\n        inLine = false;\r\n        out += ch;\r\n      }\r\n      continue;\r\n    }\r\n    if (inBlock) {\r\n      if (ch === \"*\" && next === \"/\") {\r\n        inBlock = false;\r\n        i++;\r\n      }\r\n      continue;\r\n    }\r\n    if (ch === '\"') {\r\n      inStr = true;\r\n      out += ch;\r\n      continue;\r\n    }\r\n    if (ch === \"/\" && next === \"/\") {\r\n      inLine = true;\r\n      i++;\r\n      continue;\r\n    }\r\n    if (ch === \"/\" && next === \"*\") {\r\n      inBlock = true;\r\n      i++;\r\n      continue;\r\n    }\r\n    out += ch;\r\n  }\r\n  return out;\r\n}\r\n\r\nfunction stripTrailingCommas(s) {\r\n  let out = \"\";\r\n  let inStr = false,\r\n    esc = false;\r\n  for (let i = 0; i < s.length; i++) {\r\n    const ch = s[i];\r\n    if (inStr) {\r\n      out += ch;\r\n      if (esc) esc = false;\r\n      else if (ch === \"\\\\\") esc = true;\r\n      else if (ch === '\"') inStr = false;\r\n      continue;\r\n    }\r\n    if (ch === '\"') {\r\n      inStr = true;\r\n      out += ch;\r\n      continue;\r\n    }\r\n    if (ch === \",\") {\r\n      let j = i + 1;\r\n      while (j < s.length && /\\s/.test(s[j])) j++;\r\n      if (s[j] === \"}\" || s[j] === \"]\") {\r\n        // skip trailing comma\r\n        continue;\r\n      }\r\n    }\r\n    out += ch;\r\n  }\r\n  return out;\r\n}\r\n\r\n/**\r\n * Keyword generation helpers\r\n */\r\nfunction sanitizeKeywordArray(items) {\r\n  const out = [];\r\n  const seen = new Set();\r\n  for (const it of items || []) {\r\n    let k = String(it || \"\").trim();\r\n    k = k.replace(/^[\"']|[\"']$/g, \"\");\r\n    k = k.replace(/^\\d+\\.\\s*/, \"\");\r\n    k = k.replace(/^[\\-\\*\\u2022]\\s*/, \"\");\r\n    k = k.trim();\r\n    if (!k) continue;\r\n    const key = k.toLowerCase();\r\n    if (seen.has(key)) continue;\r\n    seen.add(key);\r\n    out.push(k);\r\n    if (out.length >= 30) break;\r\n  }\r\n  return out;\r\n}\r\n\r\nfunction parseKeywordsResponse(text) {\r\n  const normalized = normalizeText(String(text || \"\").trim());\r\n  const candidates = [];\r\n  const fenced = extractFencedBlocks(normalized);\r\n  if (fenced.length) candidates.push(...fenced);\r\n  const balanced = extractBalancedJson(normalized);\r\n  if (balanced) candidates.push(balanced);\r\n  candidates.push(normalized);\r\n\r\n  const uniq = Array.from(new Set(candidates));\r\n  for (const cand of uniq) {\r\n    try {\r\n      const s = stripTrailingCommas(stripJsonComments(cand));\r\n      const parsed = JSON.parse(s);\r\n      const arr = Array.isArray(parsed)\r\n        ? parsed\r\n        : parsed && Array.isArray(parsed.keywords)\r\n          ? parsed.keywords\r\n          : null;\r\n      if (arr) return sanitizeKeywordArray(arr);\r\n    } catch {\r\n      // try next candidate\r\n    }\r\n  }\r\n\r\n  // Fallback parsing: bullets or comma-separated\r\n  const lines = normalized\r\n    .split(/\\r?\\n/)\r\n    .map((x) => x.trim())\r\n    .filter(Boolean);\r\n  let items = [];\r\n  if (lines.length > 1) {\r\n    items = lines.map((x) =>\r\n      x.replace(/^[\\-\\*\\u2022]?\\s*\\d*\\.?\\s*/, \"\").trim(),\r\n    );\r\n  } else {\r\n    items = normalized.split(/[,;]+/).map((x) => x.trim());\r\n  }\r\n  return sanitizeKeywordArray(items);\r\n}\r\n\r\nasync function generateKeywordsForArc(summary, conn) {\r\n  const base = String(summary || \"\").trim();\r\n  const prompt = `${KEYWORD_PROMPT}\\n\\n=== ARC SUMMARY ===\\n${base}\\n=== END SUMMARY ===`;\r\n  const { text } = await sendRawCompletionRequest({\r\n    model: conn.model,\r\n    prompt,\r\n    temperature: typeof conn.temperature === \"number\" ? conn.temperature : 0.2,\r\n    api: conn.api,\r\n    endpoint: conn.endpoint,\r\n    apiKey: conn.apiKey,\r\n    extra,\r\n  });\r\n  try {\r\n    console.debug(\r\n      \"STMB ArcAnalysis: keyword gen response length=%d\",\r\n      (text || \"\").length,\r\n    );\r\n  } catch {}\r\n\r\n  let kw = [];\r\n  try {\r\n    kw = parseKeywordsResponse(text);\r\n  } catch {}\r\n  if (!Array.isArray(kw) || kw.length === 0) {\r\n    // Retry with explicit JSON-only constraint\r\n    const repairPrompt = `${prompt}\\n\\nReturn ONLY a JSON array of 15-30 strings.`;\r\n    const retry = await sendRawCompletionRequest({\r\n      model: conn.model,\r\n      prompt: repairPrompt,\r\n      temperature:\r\n        typeof conn.temperature === \"number\" ? conn.temperature : 0.2,\r\n      api: conn.api,\r\n      endpoint: conn.endpoint,\r\n      apiKey: conn.apiKey,\r\n      extra,\r\n    });\r\n    kw = parseKeywordsResponse(retry.text);\r\n  }\r\n  if (kw.length > 30) kw = kw.slice(0, 30);\r\n  return kw;\r\n}\r\n\r\n/**\r\n * Build briefs from lorebook memory entries (or pre-filtered selection).\r\n * Entry is expected to be a lorebook entry object with fields:\r\n * - uid, content, key (keywords), comment (title), STMB_start/STMB_end optional\r\n */\r\nexport function buildBriefsFromEntries(entries) {\r\n  const briefs = [];\r\n  for (const e of entries) {\r\n    if (!e || typeof e !== \"object\") continue;\r\n    const id = String(e.uid ?? \"\");\r\n    const order = extractNumberFromTitle(e.comment ?? \"\") ?? 0;\r\n    const content = String(e.content ?? \"\").trim();\r\n    const title = (e.comment || \"Untitled\").toString().trim(); // preserve the memory title\r\n    briefs.push({\r\n      id,\r\n      order,\r\n      content,\r\n      title,\r\n    });\r\n  }\r\n  briefs.sort((a, b) => a.order - b.order);\r\n  return briefs;\r\n}\r\n\r\n// Extract numeric order from typical \"[000] ...\" titles\r\nfunction extractNumberFromTitle(title) {\r\n  if (!title) return null;\r\n  const m1 = title.match(/\\[(\\d+)\\]/);\r\n  if (m1) return parseInt(m1[1], 10);\r\n  const m2 = title.match(/^(\\d+)[\\s-]/);\r\n  if (m2) return parseInt(m2[1], 10);\r\n  return null;\r\n}\r\n\r\n/**\r\n * Build a single-string prompt for the model.\r\n * Includes previous arc summary if provided, then lists briefs.\r\n */\r\nexport function buildArcAnalysisPrompt({\r\n  briefs,\r\n  previousArcSummary = null,\r\n  previousArcOrder = null,\r\n  promptText = null,\r\n}) {\r\n  const header = promptText || getDefaultArcPrompt();\r\n  const lines = [];\r\n  if (previousArcSummary) {\r\n    lines.push(\r\n      \"=== PREVIOUS ARC (CANON  DO NOT REWRITE, DO NOT INCLUDE IN YOUR NEW SUMMARY) ===\",\r\n    );\r\n    if (typeof previousArcOrder !== \"undefined\" && previousArcOrder !== null) {\r\n      lines.push(`Arc ${previousArcOrder}`);\r\n    }\r\n    lines.push(previousArcSummary.trim());\r\n    lines.push(\"=== END PREVIOUS ARC ===\");\r\n    lines.push(\"\");\r\n  }\r\n\r\n  // New: memory-by-memory blocks with titles\r\n  lines.push(\"=== MEMORIES ===\");\r\n  briefs.forEach((b, idx) => {\r\n    const memNo = String(idx + 1).padStart(3, \"0\"); // 001, 002, ...\r\n    const title = (b.title || \"\").toString().trim();\r\n    const content = (b.content || \"\").toString().trim();\r\n\r\n    lines.push(`=== Memory ${memNo} ===`);\r\n    lines.push(`Title: ${title}`);\r\n    lines.push(`Contents: ${content}`);\r\n    lines.push(`=== end Memory ${memNo} ===`);\r\n    lines.push(\"\");\r\n  });\r\n  lines.push(\"=== END MEMORIES ===\");\r\n  lines.push(\"\");\r\n\r\n  // The header already states JSON-only requirements and schema.\r\n  return `${header}\\n\\n${lines.join(\"\\n\")}`;\r\n}\r\n\r\n/**\r\n * Parse arc JSON response with repair attempts.\r\n * Expected shape:\r\n * {\r\n *   \"arcs\": [ { \"title\": string, \"summary\": string, \"keywords\": string[] } ],\r\n *   \"unassigned_memories\": [ { \"id\": string, \"reason\": string } ]\r\n * }\r\n */\r\nexport function parseArcJsonResponse(text) {\r\n  if (!text || typeof text !== \"string\") {\r\n    throw new Error(translate(\"Empty AI response\", \"STMemoryBooks_ArcAnalysis_EmptyResponse\"));\r\n  }\r\n  const normalized = normalizeText(\r\n    text.trim().replace(/<think>[\\s\\S]*?<\\/think>/gi, \"\"),\r\n  );\r\n  const candidates = [];\r\n  const unwrapped = unwrapJsConcatenatedStringDump(normalized);\r\n  if (unwrapped) candidates.push(unwrapped);\r\n  const fenced = extractFencedBlocks(normalized);\r\n  if (fenced.length) candidates.push(...fenced);\r\n  candidates.push(normalized);\r\n  const balanced = extractBalancedJson(normalized);\r\n  if (balanced) candidates.push(balanced);\r\n\r\n  const uniq = Array.from(new Set(candidates));\r\n  for (const cand of uniq) {\r\n    try {\r\n      let s = cand;\r\n      s = stripJsonComments(s);\r\n      s = stripTrailingCommas(s);\r\n      const obj = JSON.parse(s);\r\n      // Validate shape\r\n      if (!obj || typeof obj !== \"object\") continue;\r\n      if (!(\"arcs\" in obj) || !(\"unassigned_memories\" in obj)) continue;\r\n\r\n      const arcs = Array.isArray(obj.arcs) ? obj.arcs : [];\r\n      const unassigned = Array.isArray(obj.unassigned_memories)\r\n        ? obj.unassigned_memories\r\n        : [];\r\n\r\n      // Relaxed: accept arcs with missing/non-array keywords. We only require title + summary here.\r\n      const validArcs = arcs.filter(\r\n        (a) =>\r\n          a &&\r\n          typeof a.title === \"string\" &&\r\n          a.title.trim() &&\r\n          typeof a.summary === \"string\" &&\r\n          a.summary.trim(),\r\n      );\r\n\r\n      const validUnassigned = unassigned.filter(\r\n        (u) =>\r\n          u &&\r\n          typeof u.id === \"string\" &&\r\n          u.id.trim() &&\r\n          typeof u.reason === \"string\",\r\n      );\r\n\r\n      return {\r\n        arcs: validArcs,\r\n        unassigned_memories: validUnassigned,\r\n      };\r\n    } catch {\r\n      // try next candidate\r\n    }\r\n  }\r\n  throw new Error(translate(\"Model did not return valid arc JSON\", \"STMemoryBooks_ArcAnalysis_InvalidJSON\"));\r\n}\r\n\r\n/**\r\n * Run sequential arc analysis passes.\r\n * selectedEntries: array of lorebook entries (objects) or objects { entry }\r\n * options: {\r\n *   presetKey?: string,\r\n *   maxItemsPerPass?: number (default 12),\r\n *   maxPasses?: number (default 10),\r\n *   minAssigned?: number (default 2),\r\n *   tokenTarget?: number (estimated input tokens; default ~2000)\r\n * }\r\n * profileOrConnection: profile object with effectiveConnection, or a direct connection object { api, model, temperature, endpoint?, apiKey? }\r\n */\r\nexport async function runArcAnalysisSequential(\r\n  selectedEntries,\r\n  options = {},\r\n  profileOrConnection = null,\r\n) {\r\n  const {\r\n    presetKey = \"arc_default\",\r\n    maxItemsPerPass = 12,\r\n    maxPasses = 10,\r\n    minAssigned = 2,\r\n    tokenTarget,\r\n  } = options;\r\n  const extra = options?.extra ?? {};\r\n\r\n  // Determine local max passes (single-arc preset defaults to one pass unless explicitly overridden)\r\n  const singleArcPreset = presetKey === \"arc_alternate\";\r\n  const maxPassesLocal = Object.prototype.hasOwnProperty.call(\r\n    options,\r\n    \"maxPasses\",\r\n  )\r\n    ? maxPasses\r\n    : singleArcPreset\r\n      ? 1\r\n      : maxPasses;\r\n\r\n  // Resolve base token budget from shared settings (tokenWarningThreshold), with optional override\r\n  const sharedThreshold =\r\n    extension_settings?.STMemoryBooks?.moduleSettings?.tokenWarningThreshold;\r\n  const baseTokenTarget =\r\n    typeof tokenTarget === \"number\"\r\n      ? tokenTarget\r\n      : typeof sharedThreshold === \"number\"\r\n        ? sharedThreshold\r\n        : 30000;\r\n  // Dynamic token budget that can be raised to accommodate single large items\r\n  let effectiveTokenTarget = baseTokenTarget;\r\n\r\n  // Normalize entries to raw entry objects\r\n  const rawEntries = selectedEntries\r\n    .map((x) => (x && x.entry ? x.entry : x))\r\n    .filter(Boolean);\r\n  const allBriefs = buildBriefsFromEntries(rawEntries);\r\n  const remainingMap = new Map(allBriefs.map((b) => [b.id, b]));\r\n  const acceptedArcs = [];\r\n  // Keep the latest raw model output for UX/debug (used when no usable arcs are produced).\r\n  let lastRawText = \"\";\r\n  let lastRetryRawText = \"\";\r\n\r\n  // Resolve prompt text\r\n  let promptText = null;\r\n  try {\r\n    if (presetKey && (await ArcPrompts.isValid(presetKey))) {\r\n      promptText = await ArcPrompts.getPrompt(presetKey);\r\n    }\r\n  } catch {}\r\n  if (!promptText) promptText = getDefaultArcPrompt();\r\n\r\n  // Resolve connection\r\n  const conn = resolveConnection(profileOrConnection);\r\n\r\n  let previousArcSummary = null;\r\n  let previousArcOrderValue = null;\r\n  let pass = 0;\r\n  let carryBriefs = [];\r\n\r\n  while (remainingMap.size > 0 && pass < maxPassesLocal) {\r\n    pass++;\r\n    // Reset the effective budget each pass; we'll only raise it for a single-item batch in this pass if needed\r\n    effectiveTokenTarget = baseTokenTarget;\r\n\r\n    // Build batch: carry-over a few, then take up to maxItemsPerPass chronologically\r\n    const remainingBriefs = Array.from(remainingMap.values()).sort(\r\n      (a, b) => a.order - b.order,\r\n    );\r\n    const batch = [];\r\n    // include carry-over first\r\n    for (const cb of carryBriefs) {\r\n      if (remainingMap.has(cb.id) && batch.length < maxItemsPerPass) {\r\n        batch.push(cb);\r\n      }\r\n    }\r\n    // fill with fresh items\r\n    for (const rb of remainingBriefs) {\r\n      if (batch.length >= maxItemsPerPass) break;\r\n      if (!batch.find((x) => x.id === rb.id)) {\r\n        batch.push(rb);\r\n      }\r\n    }\r\n\r\n    if (batch.length === 0) break;\r\n\r\n    // Pass/batch debug\r\n    try {\r\n      console.debug(\r\n        \"STMB ArcAnalysis: pass %d batch=%o\",\r\n        pass,\r\n        batch.map((b) => b.id),\r\n      );\r\n    } catch {}\r\n\r\n    // Token budgeting (simple heuristic): shrink batch if needed; raise budget for single large items\r\n    let prompt = buildArcAnalysisPrompt({\r\n      briefs: batch, // use the current batch\r\n      previousArcSummary, // existing summary string\r\n      previousArcOrder: previousArcOrderValue, // numeric order of the previous arc, or null\r\n      promptText: promptText,\r\n    });\r\n    let tokenEst = await estimateTokens(prompt, { estimatedOutput: 500 });\r\n    const origLen = batch.length;\r\n    let trimmed = false;\r\n    while (tokenEst.total > effectiveTokenTarget && batch.length > 1) {\r\n      batch.pop();\r\n      trimmed = true;\r\n      prompt = buildArcAnalysisPrompt({\r\n        briefs: batch,\r\n        previousArcSummary,\r\n        previousArcOrder: previousArcOrderValue,\r\n        promptText: promptText,\r\n      });      \r\n    tokenEst = await estimateTokens(prompt, { estimatedOutput: 500 });\r\n    }\r\n    if (trimmed) {\r\n      try {\r\n        console.debug(\r\n          \"STMB ArcAnalysis: trimmed batch from %d to %d (est=%d, budget=%d)\",\r\n          origLen,\r\n          batch.length,\r\n          tokenEst.total,\r\n          effectiveTokenTarget,\r\n        );\r\n      } catch {}\r\n    }\r\n    if (tokenEst.total > effectiveTokenTarget && batch.length === 1) {\r\n      // Dynamically raise the budget to fit this single large memory\r\n      const prevBudget = effectiveTokenTarget;\r\n      effectiveTokenTarget = tokenEst.total;\r\n      try {\r\n        console.debug(\r\n          \"STMB ArcAnalysis: raised budget for single item from %d to %d (est=%d)\",\r\n          prevBudget,\r\n          effectiveTokenTarget,\r\n          tokenEst.total,\r\n        );\r\n      } catch {}\r\n    }\r\n\r\n    // Send request\r\n    const { text } = await sendRawCompletionRequest({\r\n      model: conn.model,\r\n      prompt,\r\n      temperature: conn.temperature ?? 0.2,\r\n      api: conn.api,\r\n      endpoint: conn.endpoint,\r\n      apiKey: conn.apiKey,\r\n      extra,\r\n    });\r\n    lastRawText = String(text ?? \"\");\r\n    lastRetryRawText = \"\";\r\n\r\n    // Parse response\r\n    let parsed;\r\n    try {\r\n      parsed = parseArcJsonResponse(text);\r\n    } catch (e) {\r\n      // Single retry with a minimal \"return JSON only\" reminder\r\n      const repairPrompt = `${prompt}\\n\\nReturn ONLY the JSON object, nothing else. Ensure arrays and commas are valid.`;\r\n      const retry = await sendRawCompletionRequest({\r\n        model: conn.model,\r\n        prompt: repairPrompt,\r\n        temperature: conn.temperature ?? 0.2,\r\n        api: conn.api,\r\n        endpoint: conn.endpoint,\r\n        apiKey: conn.apiKey,\r\n        extra,\r\n      });\r\n      lastRetryRawText = String(retry?.text ?? \"\");\r\n      try {\r\n        parsed = parseArcJsonResponse(retry.text);\r\n      } catch (e2) {\r\n        const err = new Error(\r\n          String(e2?.message || e?.message || \"Model did not return valid arc JSON\"),\r\n        );\r\n        err.name = \"ArcAIResponseError\";\r\n        err.code = \"ARC_INVALID_JSON\";\r\n        err.rawText = String(text ?? \"\");\r\n        err.retryRawText = String(retry?.text ?? \"\");\r\n        err.prompt = prompt;\r\n        err.repairPrompt = repairPrompt;\r\n        throw err;\r\n      }\r\n    }\r\n\r\n    // Build ID resolver to handle both UIDs and sequential indices (e.g. \"001\", \"1\")\r\n    const idResolver = new Map();\r\n    batch.forEach((b, idx) => {\r\n      const uid = String(b.id);\r\n      idResolver.set(uid, uid);\r\n      const seq = String(idx + 1).padStart(3, \"0\");\r\n      idResolver.set(seq, uid);\r\n      idResolver.set(String(idx + 1), uid);\r\n    });\r\n\r\n    const resolveId = (raw) => idResolver.get(String(raw).trim());\r\n\r\n    // Compute assigned set = batch - unassigned ids\r\n    const unassignedIds = new Set();\r\n    if (Array.isArray(parsed.unassigned_memories)) {\r\n      parsed.unassigned_memories.forEach((u) => {\r\n        const rid = resolveId(u.id);\r\n        if (rid) unassignedIds.add(rid);\r\n      });\r\n    }\r\n\r\n    const assigned = batch.filter((b) => !unassignedIds.has(b.id));\r\n\r\n    // Parse/assignment debug\r\n    try {\r\n      console.debug(\r\n        \"STMB ArcAnalysis: pass %d arcs=%d unassigned=%d assigned=%d\",\r\n        pass,\r\n        Array.isArray(parsed.arcs) ? parsed.arcs.length : 0,\r\n        unassignedIds.size,\r\n        assigned.length,\r\n      );\r\n    } catch {}\r\n\r\n    if (assigned.length < minAssigned && pass > 1) {\r\n      // low-progress stop to prevent grind\r\n      break;\r\n    }\r\n\r\n    // Accept multiple arcs per pass (if model returns more than one).\r\n    // If arcs[].member_ids is present, use it to map memories to arcs.\r\n    // Otherwise, fall back to assigning the whole 'assigned' set to each arc.\r\n    const arcs = Array.isArray(parsed.arcs) ? parsed.arcs : [];\r\n    const consumedIdSet = new Set();\r\n    let acceptedInPass = 0;\r\n    for (let i = 0; i < arcs.length; i++) {\r\n      const aobj = arcs[i];\r\n      if (\r\n        !aobj ||\r\n        typeof aobj.title !== \"string\" ||\r\n        typeof aobj.summary !== \"string\"\r\n      )\r\n        continue;\r\n\r\n      // Optional per-arc membership: member_ids\r\n      let memberIds = null;\r\n      if (Array.isArray(aobj.member_ids)) {\r\n        memberIds = aobj.member_ids\r\n          .map(resolveId)\r\n          .filter((id) => id !== undefined);\r\n      }\r\n      \r\n      if (memberIds && memberIds.length > 0) {\r\n        // IDs were resolved successfully\r\n      } else {\r\n        // Fallback: all assigned items in this pass\r\n        memberIds = assigned.map((x) => x.id);\r\n      }\r\n      if (memberIds.length === 0) continue;\r\n\r\n      acceptedArcs.push({\r\n        order: pass * 10 + i, // stable ordering when multiple arcs in a pass\r\n        title: aobj.title,\r\n        summary: aobj.summary,\r\n        keywords: Array.isArray(aobj.keywords) ? aobj.keywords : [],\r\n        memberIds,\r\n      });\r\n\r\n      memberIds.forEach((id) => consumedIdSet.add(String(id)));\r\n      acceptedInPass++;\r\n      // Carry forward the last accepted summary as the \"previous arc\" canon\r\n      previousArcSummary = aobj.summary;\r\n    }\r\n\r\n    // Update previousArcOrderValue for next pass (only if we accepted any arcs this pass)\r\n    if (acceptedArcs.length > 0) {\r\n      previousArcOrderValue = acceptedArcs[acceptedArcs.length - 1].order;\r\n    } else {\r\n      previousArcOrderValue = null;\r\n    }\r\n\r\n    // Remove consumed from remaining\r\n    if (consumedIdSet.size > 0) {\r\n      for (const id of consumedIdSet) remainingMap.delete(String(id));\r\n      // If everything is consumed into a single arc, note and stop naturally\r\n      if (remainingMap.size === 0 && acceptedArcs.length === 1) {\r\n        try {\r\n          console.info(\r\n            \"STMB ArcAnalysis: all memories were consumed into a single arc.\",\r\n          );\r\n        } catch {}\r\n      }\r\n    } else {\r\n      // No progress this pass  stop to prevent repeated sends\r\n      try {\r\n        console.debug(\r\n          \"STMB ArcAnalysis: no new IDs consumed on pass %d; stopping.\",\r\n          pass,\r\n        );\r\n      } catch {}\r\n      break;\r\n    }\r\n\r\n    // Prepare carry-over for next pass (carry all unassigned memories)\r\n    const batchUnassigned = batch.filter((b) => unassignedIds.has(b.id));\r\n    carryBriefs = batchUnassigned;\r\n\r\n    // End-of-pass debug\r\n    try {\r\n      console.debug(\r\n        \"STMB ArcAnalysis: pass %d consumed=%d remaining=%d\",\r\n        pass,\r\n        consumedIdSet.size,\r\n        remainingMap.size,\r\n      );\r\n    } catch {}\r\n  }\r\n\r\n  const leftovers = Array.from(remainingMap.values()).map((b) => b.id);\r\n  return {\r\n    arcCandidates: acceptedArcs,\r\n    leftovers,\r\n    rawText: String(lastRawText ?? \"\"),\r\n    retryRawText: String(lastRetryRawText ?? \"\"),\r\n  };\r\n}\r\n\r\nfunction resolveConnection(profileOrConnection) {\n  // If no profile/connection provided, fall back to extension settings default profile.\n  // (Arc analysis is typically invoked without an explicit profile from the UI flow.)\n  if (!profileOrConnection) {\n    try {\n      const settings = extension_settings?.STMemoryBooks;\n      const profiles = settings?.profiles;\n      if (Array.isArray(profiles) && profiles.length > 0) {\n        const rawIndex = settings?.defaultProfile;\n        const idx =\n          Number.isInteger(rawIndex) && rawIndex >= 0 && rawIndex < profiles.length\n            ? rawIndex\n            : 0;\n        profileOrConnection = profiles[idx] || null;\n      }\n    } catch {}\n  }\n\n  // If a direct connection-like object provided\n  if (\n    profileOrConnection &&\n    profileOrConnection.api &&\n    profileOrConnection.model\n  ) {\r\n    return profileOrConnection;\r\n  }\r\n  // If a profile with effectiveConnection or connection\r\n  if (\r\n    profileOrConnection &&\r\n    (profileOrConnection.effectiveConnection || profileOrConnection.connection)\r\n  ) {\n    const c =\n      profileOrConnection.effectiveConnection || profileOrConnection.connection;\n    const apiIsCurrentST = String(c?.api || \"\").toLowerCase() === \"current_st\";\n    const apiInfo = apiIsCurrentST ? getCurrentApiInfo() : null;\n    const ui = apiIsCurrentST ? getUIModelSettings() : null;\n    return {\n      api: normalizeCompletionSource(\n        apiIsCurrentST\n          ? apiInfo?.completionSource || \"openai\"\n          : c.api || getCurrentApiInfo().completionSource || \"openai\",\n      ),\n      model: apiIsCurrentST ? ui?.model || \"\" : c.model || getUIModelSettings().model || \"\",\n      temperature:\n        apiIsCurrentST\n          ? (ui?.temperature ?? 0.2)\n          : typeof c.temperature === \"number\"\n            ? c.temperature\n            : getUIModelSettings().temperature ?? 0.2,\n      endpoint: c.endpoint,\n      apiKey: c.apiKey,\n    };\n  }\n  // Fallback: current UI\r\n  const apiInfo = getCurrentApiInfo();\r\n  const ui = getUIModelSettings();\r\n  return {\r\n    api: normalizeCompletionSource(apiInfo.completionSource || \"openai\"),\r\n    model: ui.model || \"\",\r\n    temperature: ui.temperature ?? 0.2,\r\n  };\r\n}\r\n\r\n/**\r\n * Extract ARC sequence number from an ARC entry title.\r\n * Supports \"[ARC 001] ...\" and \"[ARC [001]] ...\" formats.\r\n */\r\nfunction extractArcSequenceFromTitle(title) {\r\n  if (!title || typeof title !== \"string\") return null;\r\n  // Match [ARC 001] (single bracket)\r\n  let m = title.match(/\\[ARC\\s+(\\d+)\\]/i);\r\n  if (m) return parseInt(m[1], 10);\r\n  // Match [ARC [001]] (nested bracket)\r\n  m = title.match(/\\[ARC\\s+\\[(\\d+)\\]\\]/i);\r\n  if (m) return parseInt(m[1], 10);\r\n  return null;\r\n}\r\n\r\n/**\r\n * Compute next ARC number by scanning existing ARC entries (stmbArc === true)\r\n */\r\nfunction getNextArcNumber(lorebookData) {\r\n  const entries = Object.values(lorebookData?.entries || {});\r\n  let maxNum = 0;\r\n  for (const e of entries) {\r\n    if (e && e.stmbArc === true && typeof e.comment === \"string\") {\r\n      const n = extractArcSequenceFromTitle(e.comment);\r\n      if (typeof n === \"number\" && n > maxNum) maxNum = n;\r\n    }\r\n  }\r\n  return maxNum + 1;\r\n}\r\n\r\n/**\r\n * Format ARC title using a customizable format.\r\n * - Replaces the first bracketed zero-run like \"[ARC 000]\" by padding the sequence number to the same digit length.\r\n * - Replaces \"{{title}}\" with the base title.\r\n * Fallback: \"[ARC XXX] Base Title\" with 3 digits if no zero-run bracket found.\r\n */\r\nfunction formatArcTitle(format, baseTitle, seq) {\r\n  const safeTitle = String(baseTitle || \"\").trim();\r\n  let t = String(format || \"\").trim() || \"[ARC 000] - {{title}}\";\r\n\r\n  // Replace title placeholder\r\n  t = t.replace(/\\{\\{\\s*title\\s*\\}\\}/g, safeTitle);\r\n\r\n  // Replace first bracket with zero-run inside, preserving any surrounding text within the bracket\r\n  const m = t.match(/\\[([^\\]]*?)(0{2,})([^\\]]*?)\\]/);\r\n  if (m) {\r\n    const digits = m[2].length;\r\n    const padded = String(seq).padStart(digits, \"0\");\r\n    const replaced = `[${m[1]}${padded}${m[3]}]`;\r\n    return t.replace(m[0], replaced);\r\n  }\r\n\r\n  // Fallback to classic \"[ARC 001] Title\"\r\n  const fallback = `[ARC ${String(seq).padStart(3, \"0\")}] ${safeTitle}`;\r\n  return fallback;\r\n}\r\n\r\n/**\r\n * Commit accepted arcs into the lorebook.\r\n * arcCandidates: array of { title, summary, keywords, memberIds }\r\n * If disableOriginals=true, mark original entries disable=true and set disabledByArcId.\r\n */\r\nfunction computeArcEntryOrder({\n  orderMode,\n  orderValue,\n  reverseStart,\n  orderNumber,\n}) {\n  const ORDER_MIN = 0;\n  const ORDER_MAX = 9999;\n\n  const modeRaw = String(orderMode || \"auto\").toLowerCase();\n  const mode = modeRaw === \"manual\" || modeRaw === \"reverse\" ? modeRaw : \"auto\";\n\n  const orderNumberNum = Number(orderNumber);\n  const safeOrderNumber = Number.isFinite(orderNumberNum)\n    ? Math.trunc(orderNumberNum)\n    : 1;\n\n  const reverseStartNum = Number(reverseStart);\n  const reverseStartClamped = Number.isFinite(reverseStartNum)\n    ? Math.min(9999, Math.max(100, Math.trunc(reverseStartNum)))\n    : 9999;\n\n  const rawOrder =\n    mode === \"manual\"\n      ? orderValue\n      : mode === \"reverse\"\n        ? reverseStartClamped - (safeOrderNumber - 1)\n        : safeOrderNumber;\n\n  const rawOrderNum = Number(rawOrder);\n  if (!Number.isFinite(rawOrderNum)) {\n    return mode === \"manual\" ? 100 : safeOrderNumber;\n  }\n\n  return Math.min(ORDER_MAX, Math.max(ORDER_MIN, Math.trunc(rawOrderNum)));\n}\n\nexport async function commitArcs({\n  lorebookName,\n  lorebookData,\n  arcCandidates,\n  disableOriginals = false,\n  orderMode = \"auto\",\n  orderValue = 100,\n  reverseStart = 9999,\n}) {\n  if (!lorebookName || !lorebookData) {\n    throw new Error(translate(\"Missing lorebookName or lorebookData\", \"STMemoryBooks_ArcAnalysis_MissingLorebookData\"));\n  }\n  const results = [];\n\r\n  // Arc title format: allow user customization similar to memory titles, minimal wiring.\r\n  // Users can set extension_settings.STMemoryBooks.arcTitleFormat (e.g., \"[ARC 000] - {{title}}\").\r\n  const arcTitleFormat =\r\n    extension_settings?.STMemoryBooks?.arcTitleFormat ||\r\n    \"[ARC 000] - {{title}}\";\r\n  let nextArcNumber = getNextArcNumber(lorebookData);\r\n\r\n  try {\r\n    console.info(\r\n      \"STMB ArcAnalysis: committing %d arc(s): %o\",\r\n      arcCandidates.length,\r\n      arcCandidates.map((a) => a.title),\r\n    );\r\n  } catch {}\r\n  for (const arc of arcCandidates) {\n    const arcNumber = nextArcNumber++;\n    const title = formatArcTitle(arcTitleFormat, arc.title, arcNumber);\n    const content = arc.summary;\n\r\n    // Auto-generate keywords if missing using the arc summary\r\n    let keywords = Array.isArray(arc.keywords) ? arc.keywords : [];\r\n    if (keywords.length === 0) {\r\n      try {\r\n        const conn = resolveConnection(null);\r\n        keywords = await generateKeywordsForArc(content, conn);\r\n      } catch (e) {\r\n        try {\r\n          console.warn(\r\n            'STMB ArcAnalysis: keyword generation failed for \"%s\": %s',\r\n            title,\r\n            String(e?.message || e),\r\n          );\r\n        } catch {}\r\n      }\r\n    }\r\n\r\n    const order = computeArcEntryOrder({\n      orderMode,\n      orderValue,\n      reverseStart,\n      orderNumber: arcNumber,\n    });\n    const defaults = {\n      vectorized: true,\n      selective: true,\n      order,\n      position: 0,\n    };\n    const entryOverrides = {\r\n      stmemorybooks: true,\r\n      stmbArc: true,\r\n      type: \"arc\",\r\n      key: Array.isArray(keywords) ? keywords : [],\r\n      // Keep consistent fields present in lorebook entries:\r\n      disable: false,\r\n    };\r\n    const res = await upsertLorebookEntriesBatch(\r\n      lorebookName,\r\n      lorebookData,\r\n      [\r\n        {\r\n          title,\r\n          content,\r\n          defaults,\r\n          entryOverrides,\r\n        },\r\n      ],\r\n      { refreshEditor: false },\r\n    );\r\n    const created = res && res[0];\r\n    const arcEntryId = created ? created.uid : null;\r\n    if (!arcEntryId) {\r\n      throw new Error(translate(\"Arc upsert returned no entry (commitArcs failed)\", \"STMemoryBooks_ArcAnalysis_UpsertFailed\"));\r\n    }\r\n\r\n    // If requested, disable originals by ID match (memberIds refer to entry.uid string)\r\n    if (disableOriginals && arcEntryId) {\r\n      const idSet = new Set(arc.memberIds.map(String));\r\n      const entries = Object.values(lorebookData.entries || {});\r\n      for (const e of entries) {\r\n        if (idSet.has(String(e.uid))) {\r\n          e.disable = true;\r\n          e.disabledByArcId = arcEntryId;\r\n        }\r\n      }\r\n    }\r\n    results.push({ arcEntryId, title });\r\n  }\r\n\r\n  // Single save + refresh\r\n  await upsertLorebookEntriesBatch(lorebookName, lorebookData, [], {\r\n    refreshEditor: true,\r\n  });\r\n  try {\r\n    console.info(\r\n      \"STMB ArcAnalysis: committed arc IDs: %o\",\r\n      results.map((r) => r.arcEntryId),\r\n    );\r\n  } catch {}\r\n  return { results };\r\n}\r\n",
    "import { translate } from '../../../i18n.js';\n\n/**\n * Built-in Arc Analysis prompts (default + alternates).\n * These mirror the Summary Prompt Manager pattern but are specific to Arc Analysis.\n * * Exports:\n * - getBuiltInArcPrompts(): { [key: string]: string }\n * - getDefaultArcPrompt(): string\n */\n\n/**\n * Helper to generate defined prompts with translation support.\n * Returns an object where keys are stable IDs and values are translated strings.\n */\nfunction getDefinitions() {\n    return {\n        arc_default: translate(`You are an expert narrative analyst and memory-engine assistant.\nYour task is to take multiple scene summaries (of varying detail and formatting), normalize them, reconstruct the full chronology, identify self-contained story arcs, and output each arc as a single memory entry in JSON.\n\nEach arc must be token-efficient, plot-accurate, and compatible with long-running RP memory systems such as STMB.\n\nYou will receive input in this exact format:\n- An optional PREVIOUS ARC block, which is canon and must not be rewritten.\n- A MEMORIES block containing entries formatted as:\n  [ID] | ORDER\n  Full text of the memory (may span multiple paragraphs)\n\nStrict output format (JSON only; no markdown, no prose outside JSON):\n{\n  \"arcs\": [\n    {\n      \"title\": \"Short descriptive arc title (36 words)\",\n      \"summary\": \"Structured arc summary as a single string (see Summary Content Structure below).\",\n      \"keywords\": [\"keyword1\", \"keyword2\", \"...\"],\n      \"member_ids\": [\"<ID from MEMORIES>\", \"...\"]  // optional: IDs of memories that belong to this arc\n    }\n  ],\n  \"unassigned_memories\": [\n    { \"id\": \"memory-id\", \"reason\": \"Brief explanation of why this memory does not fit the produced arcs.\" }\n  ]\n}\n\nArc count rule:\n- Do not force a number of arcs. Produce the smallest coherent number of arcs based on content (often 13, possibly 1 if all memories form one arc).\n- Respect chronology using ORDER (ascending).\n- If some memories do not fit the produced arcs, place them in unassigned_memories with a short reason.\n\nDo not repeat text from PREVIOUS ARC. Treat it as canon; continue consequences only if relevant in the new memories.\n\nPROCESS\n\nSTEP 1  UNIFIED STORY (internal only)\n- Combine ALL memories into a single chronological retelling.\n- Ignore OOC/meta content.\n- Preserve plot-relevant events, character choices, emotional shifts, decisions, consequences, conflicts, promises, boundary negotiations.\n- Exclude flavor-only content unless it affects future behavior.\n- Normalize to past-tense, third-person.\n- Focus on cause  intention  reaction  consequence chains.\n- Do NOT output this unified story.\n\nSTEP 2  IDENTIFY STORY ARCS\n- From the unified story, extract arcs that begin when a meaningful shift occurs in:\n  relationship dynamics; emotional vulnerability; intimacy or distance; conflict/reconciliation; routine/ritual changes; boundaries/negotiations; logistical shifts (travel, location, communication); any event with lasting consequences.\n- Ensure each arc is self-contained and represents a significant movement.\n\nSTEP 3  ARC OBJECTS (fill arcs[] in JSON)\nFor each arc, fill fields as follows:\n\ntitle:\n- 36 words, descriptive of the arcs core.\n\nsummary:\n- The entire Summary Content Structure below must appear inside this single string (use headings and bullets as plain text).\n- Keep total length 515% of the combined text for the arcs memories.\n- Do not include OOC/meta or filler.\n\nSummary Content Structure (must be followed inside summary string):\n\n# [Arc Title]\nTime period: What timeframe the arc covers (e.g. \"March 310, 2024\", \"Week of July 15, 2023\")\n\nArc Premise: One sentence describing what this arc is about.\n\n## Major Beats\n- 37 bullets capturing the major plot movements of this arc\n- Focus on cause  effect logic\n- Include only plot-affecting events\n\n## Character Dynamics\n- 12 paragraphs describing how the characters emotions, motives, boundaries, or relationship changed\n- Include subtext, tension shifts, power exchange changes, new trust/vulnerabilities, or new conflicts\n- Include silent implications if relevant\n\n## Key Exchanges\n- Up to 8 short, exact quotes\n- Only include dialogue that materially shifted tone, emotion, or relationship dynamics\n\n## Outcome & Continuity\n- 48 bullets capturing:\n  - decisions\n  - promises\n  - new emotional states\n  - new routines/rituals\n  - injuries or physical changes\n  - foreshadowed future events\n  - unresolved threads\n  - permanent consequences\n\nSTEP 4  KEYWORDS\n- Provide 1530 standalone retrieval keywords in keywords[] per arc.\n\nMUST:\n- Concrete nouns, physical objects, places, proper nouns, distinctive actions, or memorable scene elements\n- Each keyword = ONE concept only\n- Each keyword must be retrievable if mentioned ALONE\n- Use ONLY nouns or noun-phrases\n\nMUST NOT:\n- No narrative/summary keywords (start of affair, argument resolved)\n- No emotional/abstract words (intimacy, vulnerability, trust, jealousy, dominance, submission, aftercare, connection, longing, etc.)\n- No multi-fact keywords (Denver airport Lyft ride and call)\n- No themes or vibes\n\nExamples of valid keywords:\n- Four Seasons bar\n- Macallan 25\n- private elevator\n- Aston Martin\n- CPAP machine\n- Gramercy Tavern\n- yuzu soda\n- satellite map\n- Life360 app\n- marble desk\n- pack for forever\n- dick-measuring contest\n\nClassification of non-fitting memories:\n- If a memory obviously belongs to a later arc, is unrelated, flavor-only with no continuity impact, duplicates, or conflicts with PREVIOUS ARC chronology, put it in unassigned_memories with a short reason.\n\nJSON-only:\n- Return only the JSON object described above.\n- No markdown fences, no commentary, no system prompts, no extra text.`, 'STMemoryBooks_ArcPrompt_Default'),\n\n        arc_alternate: translate(`You are an expert narrative analyst and memory-engine assistant.\nYour task is to take multiple scene summaries (of varying detail and formatting), normalize them, reconstruct the full chronology, and output a single memory arc entry in JSON. The arc must be token-efficient and plot-accurate.\n\nYou will receive input in this exact format:\n- An optional PREVIOUS ARC block, which is canon and must not be rewritten.\n- A MEMORIES block containing entries formatted as:\n  [ID] | ORDER\n  Full text of the memory (may span multiple paragraphs)\n\nStrict output format (JSON only; no markdown, no prose outside JSON):\n{\n  \"arcs\": [\n    {\n      \"title\": \"Short descriptive arc title (36 words)\",\n      \"summary\": \"Structured arc summary as a single string (see Summary Content Structure below).\",\n      \"keywords\": [\"keyword1\", \"keyword2\", \"...\"],\n      \"member_ids\": [\"<ID from MEMORIES>\", \"...\"]  // optional: IDs of memories that belong to this arc\n    }\n  ],\n  \"unassigned_memories\": [\n    { \"id\": \"memory-id\", \"reason\": \"Brief explanation of why this memory does not fit the produced arcs.\" }\n  ]\n}\n\nNotes:\n- Respect chronology using ORDER (ascending).\n- If some memories do not fit the arc, place them in unassigned_memories with a short reason.\n\nDo not repeat text from PREVIOUS ARC. Treat it as canon; continue consequences only if relevant in the new memories.\n\nPROCESS\n\nSTEP 1  UNIFIED STORY (internal only)\n- Combine ALL memories into a single chronological retelling.\n- Ignore OOC/meta content.\n- Preserve plot-relevant events, character choices, emotional shifts, decisions, consequences, conflicts, promises, boundary negotiations.\n- Exclude flavor-only content unless it affects future behavior.\n- Normalize to past-tense, third-person.\n- Focus on cause  intention  reaction  consequence chains.\n- Do NOT output this unified story.\n\nSTEP 2  IDENTIFY STORY ARCS\n- From the unified story, identify a self-contained arc that represents a significant narrative movement.\n\nSTEP 3  ARC OBJECTS (fill arcs[] in JSON)\nFor the story arc, fill fields as follows:\n\ntitle:\n- 36 words, descriptive of the arcs core.\n\nsummary:\n- The entire Summary Content Structure below must appear inside this single string (use headings and bullets as plain text).\n- Keep total length 515% of the combined text for the arcs memories.\n- Do not include OOC/meta or filler.\n\nSummary Content Structure (must be followed inside summary string):\n\n# [Arc Title]\nTime period: What timeframe the arc covers (e.g. \"March 310, 2024\", \"Week of July 15, 2023\")\n\nArc Premise: One sentence describing what this arc is about.\n\n## Major Beats\n- 37 bullets capturing the major plot movements of this arc\n- Focus on cause  effect logic\n- Include only plot-affecting events\n\n## Character Dynamics\n- 12 paragraphs describing how the characters emotions, motives, boundaries, or relationship changed\n- Include subtext, tension shifts, power exchange changes, new trust/vulnerabilities, or new conflicts\n- Include silent implications if relevant\n\n## Key Exchanges\n- Up to 8 short, exact quotes\n- Only include dialogue that materially shifted tone, emotion, or relationship dynamics\n\n## Outcome & Continuity\n- 48 bullets capturing:\n  - decisions\n  - promises\n  - new emotional states\n  - new routines/rituals\n  - injuries or physical changes\n  - foreshadowed future events\n  - unresolved threads\n  - permanent consequences\n\nSTEP 4  KEYWORDS\n- Provide 1530 standalone retrieval keywords in keywords[] per arc.\n\nMUST:\n- Concrete nouns, physical objects, places, proper nouns, distinctive actions, or memorable scene elements\n- Each keyword = ONE concept only\n- Each keyword must be retrievable if mentioned ALONE\n- Use ONLY nouns or noun-phrases\n\nMUST NOT:\n- No narrative/summary keywords (start of affair, argument resolved)\n- No emotional/abstract words (intimacy, vulnerability, trust, jealousy, dominance, submission, aftercare, connection, longing, etc.)\n- No multi-fact keywords (Denver airport Lyft ride and call)\n- No themes or vibes\n\nExamples of valid keywords:\n- Four Seasons bar\n- Macallan 25\n- private elevator\n- Aston Martin\n- CPAP machine\n- Gramercy Tavern\n- yuzu soda\n- satellite map\n- Life360 app\n- marble desk\n- pack for forever\n- dick-measuring contest\n\nClassification of non-fitting memories:\n- If a memory obviously belongs to a later arc, is unrelated, flavor-only with no continuity impact, duplicates, or conflicts with PREVIOUS ARC chronology, put it in unassigned_memories with a short reason.\n\nJSON-only:\n- Return only the JSON object described above.\n- No markdown fences, no commentary, no system prompts, no extra text.`, 'STMemoryBooks_ArcPrompt_Alternate'),\n\n        arc_tiny: translate(`You specialize in compressing many small memories into compact, coherent story arcs. Combine the memories below  and the previous arc if provided  into a single arc that captures the main narrative through-lines.\n\nReturn JSON only:\n{ \"arcs\": [ { \"title\": \"...\", \"summary\": \"...\", \"keywords\": [\"...\"], \"member_ids\": [\"<ID>\", \"...\"] } ], \"unassigned_memories\": [ { \"id\": \"...\", \"reason\": \"...\" } ] }\n\nRules:\n- 515% length compression\n- Focus on plot, emotional progression, decisions, conflicts, continuity\n- Identify non-fitting items in unassigned_memories with a brief reason\n- No quotes, no OOC, no commentary outside JSON`, 'STMemoryBooks_ArcPrompt_Tiny')\n    };\n}\n\n/**\n * Get built-in Arc Analysis prompts\n */\nexport function getBuiltInArcPrompts() {\n  return getDefinitions();\n}\n\n/**\n * Get default Arc Analysis prompt text\n */\nexport function getDefaultArcPrompt() {\n  return getDefinitions().arc_default;\n}",
    "import { getRequestHeaders } from '../../../../script.js';\nimport { FILE_NAMES, SCHEMA } from './constants.js';\nimport { translate } from '../../../i18n.js';\nimport { getBuiltInArcPrompts, getDefaultArcPrompt } from './templatesArcPrompts.js';\n\nconst MODULE_NAME = 'STMemoryBooks-ArcAnalysisPromptManager';\nconst PROMPTS_FILE = FILE_NAMES.ARC_PROMPTS_FILE;\n\n // Preferred translation keys for built-in arc presets\n const BUILTIN_DISPLAY_NAMES = {\n   arc_default: 'Multi-Arc Analysis',\n   arc_alternate: 'Single Arc',\n };\n\n/**\n * In-memory cache of loaded overrides\n * @type {Object|null}\n */\nlet cachedOverrides = null;\n\n/**\n * Generates a safe slug from a string\n * @param {string} str\n * @returns {string}\n */\nfunction safeSlug(str) {\n  return String(str || '')\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-+|-+$/g, '')\n    .substring(0, 50);\n}\n\n/**\n * Title-case helper\n * @param {string} str\n * @returns {string}\n */\nfunction toTitleCase(str) {\n  return String(str || '').replace(/\\w\\S*/g, (txt) => {\n    return txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase();\n  });\n}\n\n/**\n * Generates a display name from prompt content (fallback)\n * @param {string} prompt\n * @returns {string}\n */\nfunction generateDisplayNameFromContent(prompt) {\n  const lines = String(prompt || '').split('\\n').filter((l) => l.trim());\n  if (lines.length > 0) {\n    const first = lines[0].trim();\n    const cleaned = first\n      .replace(/^(You are|Analyze|Create|Generate|Write)\\s+/i, '')\n      .replace(/[:.]/g, '')\n      .trim();\n    return toTitleCase(cleaned.substring(0, 50));\n  }\n  return 'Arc Prompt';\n}\n\n/**\n * Generates a unique key for a preset\n * @param {string} baseName\n * @param {Object} existingOverrides\n * @returns {string}\n */\nfunction generateUniqueKey(baseName, existingOverrides) {\n  const builtIns = getBuiltInArcPrompts() || {};\n  const existing = existingOverrides || {};\n  const baseSlug = safeSlug(baseName || 'arc-prompt');\n  let key = baseSlug;\n  let counter = 2;\n  while (key in existing || key in builtIns) {\n    key = `${baseSlug}-${counter++}`;\n  }\n  return key;\n}\n\n/**\n * Validate prompts file structure (lightweight)\n * @param {Object} data\n * @returns {boolean}\n */\nfunction validatePromptsFile(data) {\n  if (!data || typeof data !== 'object') return false;\n  if (typeof data.version !== 'number') return false;\n  if (!data.overrides || typeof data.overrides !== 'object') return false;\n  for (const [key, ov] of Object.entries(data.overrides)) {\n    if (!ov || typeof ov !== 'object') return false;\n    if (typeof ov.prompt !== 'string' || !ov.prompt.trim()) return false;\n    if (ov.displayName !== undefined && typeof ov.displayName !== 'string') return false;\n  }\n  return true;\n}\n\n/**\n * Loads overrides from server or creates defaults with built-ins\n * @param {Object|null} settings\n * @returns {Promise<Object>}\n */\nasync function loadOverrides(settings = null) {\n  if (cachedOverrides) return cachedOverrides;\n\n  let mustWrite = false;\n  let data = null;\n\n  try {\n    const response = await fetch(`/user/files/${PROMPTS_FILE}`, {\n      method: 'GET',\n      credentials: 'include',\n      headers: getRequestHeaders(),\n    });\n    if (!response.ok) {\n      mustWrite = true;\n    } else {\n      const text = await response.text();\n      data = JSON.parse(text);\n      if (!validatePromptsFile(data)) {\n        mustWrite = true;\n      }\n    }\n  } catch {\n    mustWrite = true;\n  }\n\n  if (mustWrite) {\n    const overrides = {};\n    const now = new Date().toISOString();\n    const builtIns = getBuiltInArcPrompts() || {};\n    // Seed all built-ins as overridable entries for consistent UX\n    for (const [key, prompt] of Object.entries(builtIns)) {\n      let displayName;\n      if (BUILTIN_DISPLAY_NAMES[key]) {\n        const translated = translate(BUILTIN_DISPLAY_NAMES[key]);\n        displayName = translated || toTitleCase(key.replace(/^arc[_-]?/, '').replace(/[_-]/g, ' ')) || generateDisplayNameFromContent(prompt);\n      } else {\n        displayName = toTitleCase(key.replace(/^arc[_-]?/, '').replace(/[_-]/g, ' ')) || generateDisplayNameFromContent(prompt);\n      }\n      overrides[key] = {\n        displayName,\n        prompt,\n        createdAt: now,\n      };\n    }\n\n    data = {\n      version: SCHEMA.CURRENT_VERSION,\n      overrides,\n    };\n    await saveOverrides(data);\n  }\n\n  cachedOverrides = data;\n  return cachedOverrides;\n}\n\n/**\n * Saves overrides\n * @param {Object} doc\n * @returns {Promise<void>}\n */\nasync function saveOverrides(doc) {\n  const json = JSON.stringify(doc, null, 2);\n  const base64 = btoa(unescape(encodeURIComponent(json)));\n  const response = await fetch('/api/files/upload', {\n    method: 'POST',\n    credentials: 'include',\n    headers: getRequestHeaders(),\n    body: JSON.stringify({\n      name: PROMPTS_FILE,\n      data: base64,\n    }),\n  });\n  if (!response.ok) {\n    const msg = translate(\"Failed to save arc prompts\", \"STMemoryBooks_ArcPromptManager_SaveFailed\");\n    throw new Error(`${msg}: ${response.statusText}`);\n  }\n  cachedOverrides = doc;\n  console.log(`${MODULE_NAME}: Arc prompts saved`);\n}\n\n/**\n * Public API\n */\n\n/**\n * First-run init to ensure file exists with built-ins\n * @param {Object} settings\n * @returns {Promise<boolean>}\n */\nexport async function firstRunInitIfMissing(settings) {\n  await loadOverrides(settings);\n  return true;\n}\n\n/**\n * List presets\n * @returns {Promise<Array<{key:string, displayName:string, createdAt:string|null}>>}\n */\nexport async function listPresets(settings = null) {\n  const data = await loadOverrides(settings);\n  const presets = [];\n\n  // Overrides\n  for (const [key, preset] of Object.entries(data.overrides)) {\n    presets.push({\n      key,\n      displayName: preset.displayName || toTitleCase(key),\n      createdAt: preset.createdAt || null,\n    });\n  }\n\n  // Include any built-ins not overridden\n  const builtIns = getBuiltInArcPrompts() || {};\n  for (const key of Object.keys(builtIns)) {\n    if (!(key in data.overrides)) {\n      presets.push({\n        key,\n        displayName: (BUILTIN_DISPLAY_NAMES[key] || toTitleCase(key.replace(/^arc[_-]?/, '').replace(/[_-]/g, ' '))),\n        createdAt: null,\n      });\n    }\n  }\n\n  // Newest first\n  presets.sort((a, b) => {\n    if (!a.createdAt) return 1;\n    if (!b.createdAt) return -1;\n    return new Date(b.createdAt) - new Date(a.createdAt);\n  });\n\n  return presets;\n}\n\n/**\n * Get prompt text for a preset key\n * @param {string} key\n * @returns {Promise<string>}\n */\nexport async function getPrompt(key, settings = null) {\n  const data = await loadOverrides(settings);\n  if (data.overrides[key] && typeof data.overrides[key].prompt === 'string' && data.overrides[key].prompt.trim()) {\n    return data.overrides[key].prompt;\n  }\n  const builtIns = getBuiltInArcPrompts();\n  return builtIns[key] || getDefaultArcPrompt();\n}\n\n/**\n * Get display name for a preset key\n * @param {string} key\n * @returns {Promise<string>}\n */\nexport async function getDisplayName(key, settings = null) {\n  const data = await loadOverrides(settings);\n  if (data.overrides[key] && data.overrides[key].displayName) {\n    return data.overrides[key].displayName;\n  }\n  return BUILTIN_DISPLAY_NAMES[key] || toTitleCase(String(key || '').replace(/^arc[_-]?/, '').replace(/[_-]/g, ' ')) || 'Arc Prompt';\n}\n\n/**\n * Check if preset exists\n * @param {string} key\n * @returns {Promise<boolean>}\n */\nexport async function isValid(key, settings = null) {\n  const data = await loadOverrides(settings);\n  const builtIns = getBuiltInArcPrompts() || {};\n  return !!(data.overrides[key] || builtIns[key]);\n}\n\n/**\n * Create or update a preset\n * @param {string|null} key\n * @param {string} prompt\n * @param {string} displayName\n * @returns {Promise<string>} key used\n */\nexport async function upsertPreset(key, prompt, displayName) {\n  const data = await loadOverrides();\n  const now = new Date().toISOString();\n\n  let actualKey = key;\n  if (!actualKey) {\n    actualKey = generateUniqueKey(displayName || generateDisplayNameFromContent(prompt), data.overrides);\n  }\n\n  if (data.overrides[actualKey]) {\n    data.overrides[actualKey].prompt = prompt;\n    data.overrides[actualKey].displayName = displayName || data.overrides[actualKey].displayName;\n    data.overrides[actualKey].updatedAt = now;\n  } else {\n    data.overrides[actualKey] = {\n      displayName: displayName || generateDisplayNameFromContent(prompt),\n      prompt,\n      createdAt: now,\n    };\n  }\n\n  await saveOverrides(data);\n  return actualKey;\n}\n\n/**\n * Duplicate a preset\n * @param {string} sourceKey\n * @returns {Promise<string>}\n */\nexport async function duplicatePreset(sourceKey) {\n  const data = await loadOverrides();\n  const src = data.overrides[sourceKey];\n  if (!src) throw new Error(`Arc preset \"${sourceKey}\" not found`);\n  const newDisplayName = `${src.displayName || toTitleCase(sourceKey)} (Copy)`;\n  const newKey = generateUniqueKey(newDisplayName, data.overrides);\n  const now = new Date().toISOString();\n  data.overrides[newKey] = {\n    displayName: newDisplayName,\n    prompt: src.prompt,\n    createdAt: now,\n  };\n  await saveOverrides(data);\n  return newKey;\n}\n\n/**\n * Remove a preset\n * @param {string} key\n * @returns {Promise<void>}\n */\nexport async function removePreset(key) {\n  const data = await loadOverrides();\n  if (!data.overrides[key]) throw new Error(`Arc preset \"${key}\" not found`);\n  delete data.overrides[key];\n  await saveOverrides(data);\n}\n\n/**\n * Export prompts JSON\n * @returns {Promise<string>}\n */\nexport async function exportToJSON() {\n  const data = await loadOverrides();\n  return JSON.stringify(data, null, 2);\n}\n\n/**\n * Import prompts JSON\n * @param {string} jsonString\n * @returns {Promise<void>}\n */\nexport async function importFromJSON(jsonString) {\n  const obj = JSON.parse(jsonString);\n  if (!validatePromptsFile(obj)) {\n    throw new Error('Invalid arc prompts file structure.');\n  }\n  await saveOverrides(obj);\n}\n\n/**\n * Clear in-memory cache (for testing)\n */\nexport function clearCache() {\n  cachedOverrides = null;\n}\n\n/**\n * Recreate built-in prompts by removing overrides with the same keys\n * @param {'overwrite'} mode\n * @returns {Promise<{ removed: number }>}\n */\nexport async function recreateBuiltInPrompts(mode = 'overwrite') {\n  if (mode !== 'overwrite') {\n    console.warn(`${MODULE_NAME}: Unsupported mode \"${mode}\", defaulting to overwrite`);\n  }\n  const data = await loadOverrides();\n  const builtIns = getBuiltInArcPrompts() || {};\n  const keys = Object.keys(builtIns);\n  let removed = 0;\n  if (data && data.overrides && typeof data.overrides === 'object') {\n    for (const k of keys) {\n      if (k in data.overrides) {\n        delete data.overrides[k];\n        removed++;\n      }\n    }\n  }\n  await saveOverrides(data);\n  cachedOverrides = data;\n  console.log(`${MODULE_NAME}: Recreated arc built-ins (removed ${removed} overrides)`);\n  return { removed };\n}\n\n/**\n * Rebuild prompts file to exactly match current built-ins.\n * Creates optional timestamped backup of existing overrides file.\n * @param {{backup?: boolean}} options\n * @returns {Promise<{count:number, backupName?:string}>}\n */\nexport async function rebuildFromBuiltIns(options = {}) {\n  const backup = options.backup !== false;\n  const builtIns = getBuiltInArcPrompts() || {};\n  const now = new Date().toISOString();\n  const overrides = {};\n  for (const [key, prompt] of Object.entries(builtIns)) {\n    overrides[key] = {\n      displayName:\n        (BUILTIN_DISPLAY_NAMES[key] || toTitleCase(key.replace(/^arc[_-]?/, '').replace(/[_-]/g, ' ')) || generateDisplayNameFromContent(prompt)),\n      prompt,\n      createdAt: now,\n    };\n  }\n\n  // Optional backup of existing file (using current persisted doc)\n  let backupName;\n  try {\n    const existing = await loadOverrides();\n    if (backup && existing) {\n      const base = String(PROMPTS_FILE || 'stmb-arc-prompts.json').replace(/\\.json$/i, '');\n      const ts = now.replace(/[:.]/g, '-');\n      backupName = `${base}.backup-${ts}.json`;\n\n      const backupJson = JSON.stringify(existing, null, 2);\n      const backupB64 = btoa(unescape(encodeURIComponent(backupJson)));\n      const resp = await fetch('/api/files/upload', {\n        method: 'POST',\n        credentials: 'include',\n        headers: getRequestHeaders(),\n        body: JSON.stringify({ name: backupName, data: backupB64 }),\n      });\n      if (!resp.ok) {\n        console.warn(`${MODULE_NAME}: Failed to write backup \"${backupName}\": ${resp.statusText}`);\n      }\n    }\n  } catch (e) {\n    console.warn(`${MODULE_NAME}: Backup step failed:`, e);\n  }\n\n  const doc = { version: SCHEMA.CURRENT_VERSION, overrides };\n  await saveOverrides(doc);\n  cachedOverrides = doc;\n\n  // Notify listeners that arc presets changed\n  try {\n    window.dispatchEvent(new CustomEvent('stmb-arc-presets-updated'));\n  } catch {\n    /* noop */\n  }\n\n  return { count: Object.keys(overrides).length, backupName };\n}\n",
    "import { Handlebars } from '../../../../lib.js';\n\nexport const summaryPromptsTableTemplate = Handlebars.compile(`\n<table style=\"width: 100%; border-collapse: collapse;\">\n  <thead>\n    <tr>\n      <th data-i18n=\"STMemoryBooks_PromptManager_DisplayName\">Display Name</th>\n    </tr>\n  </thead>\n  <tbody>\n    {{#if items}}\n      {{#each items}}\n        <tr data-preset-key=\"{{key}}\" style=\"cursor: pointer; border-bottom: 1px solid var(--SmartThemeBorderColor);\">\n          <td style=\"padding: 8px;\">\n            <span class=\"stmb-preset-name\">{{displayName}}</span>\n            <span class=\"stmb-inline-actions\" style=\"float: right; display: inline-flex; gap: 10px;\">\n              <button class=\"stmb-action stmb-action-edit\" title=\"Edit\" aria-label=\"Edit\" data-i18n=\"[title]STMemoryBooks_Edit;[aria-label]STMemoryBooks_Edit\" style=\"background:none;border:none;cursor:pointer;\">\n                <i class=\"fa-solid fa-pen\"></i>\n              </button>\n              <button class=\"stmb-action stmb-action-duplicate\" title=\"Duplicate\" aria-label=\"Duplicate\" data-i18n=\"[title]STMemoryBooks_Duplicate;[aria-label]STMemoryBooks_Duplicate\" style=\"background:none;border:none;cursor:pointer;\">\n                <i class=\"fa-solid fa-copy\"></i>\n              </button>\n              <button class=\"stmb-action stmb-action-delete\" title=\"Delete\" aria-label=\"Delete\" data-i18n=\"[title]STMemoryBooks_Delete;[aria-label]STMemoryBooks_Delete\" style=\"background:none;border:none;cursor:pointer;\">\n                <i class=\"fa-solid fa-trash\"></i>\n              </button>\n            </span>\n          </td>\n        </tr>\n      {{/each}}\n    {{else}}\n      <tr>\n        <td>\n          <div class=\"opacity50p\" data-i18n=\"STMemoryBooks_PromptManager_NoPresets\">No presets available</div>\n        </td>\n      </tr>\n    {{/if}}\n  </tbody>\n</table>\n`);",
    "/**\r\n * Localization data for Memory Books extension\r\n * This file contains translation strings for the UI\r\n *\r\n * Usage: Import this and call addLocaleData() during extension initialization\r\n */\r\n\r\n/**\r\n * Runtime JSON loader for locales that don't support JSON import assertions\r\n */\r\nexport async function loadLocaleJson(lang) {\r\n    const alias = {\r\n        // Chinese (both already match ST base)\r\n        'zh': 'zh-cn',\r\n        'zh_cn': 'zh-cn',\r\n        'zh_tw': 'zh-tw',\r\n        'zh.tw': 'zh-tw',\r\n        'zh-cn': 'zh-cn',\r\n        'zh-tw': 'zh-tw',\r\n        'zh-CN': 'zh-cn',\r\n        'zh-TW': 'zh-tw',\r\n\r\n        // Japanese -> ja-jp\r\n        'ja': 'ja-jp',\r\n        'ja_jp': 'ja-jp',\r\n        'ja-JP': 'ja-jp',\r\n        'ja-jp': 'ja-jp',\r\n\r\n        // Russian -> ru-ru\r\n        'ru': 'ru-ru',\r\n        'ru_ru': 'ru-ru',\r\n        'ru-RU': 'ru-ru',\r\n        'ru-ru': 'ru-ru',\r\n\r\n        // Spanish -> es-es\r\n        'es': 'es-es',\r\n        'es-es': 'es-es',\r\n\r\n        // German -> de-de\r\n        'de': 'de-de',\r\n        'de_de': 'de-de',\r\n        'de-DE': 'de-de',\r\n        'de-de': 'de-de',\r\n\r\n        // French -> fr-fr\r\n        'fr': 'fr-fr',\r\n        'fr_fr': 'fr-fr',\r\n        'fr-FR': 'fr-fr',\r\n        'fr-fr': 'fr-fr',\r\n\r\n        // Korean -> ko-kr\r\n        'ko': 'ko-kr',\r\n        'ko_kr': 'ko-kr',\r\n        'ko-KR': 'ko-kr',\r\n        'ko-kr': 'ko-kr',\r\n\r\n        // Malay -> ms-my\r\n        'ms': 'ms-my',\r\n        'ms_my': 'ms-my',\r\n        'ms-MY': 'ms-my',\r\n        'ms-my': 'ms-my',\r\n\r\n        // Indonesian -> id-id\r\n        'id': 'id-id',\r\n        'id_id': 'id-id',\r\n        'id-ID': 'id-id',\r\n        'id-id': 'id-id',\r\n\r\n        // English -> en (use built-in locales.js, no JSON file)\r\n        'en': 'en',\r\n        'en_us': 'en',\r\n        'en-US': 'en',\r\n        'en-us': 'en',\r\n        'en_gb': 'en',\r\n        'en-GB': 'en',\r\n        'en-gb': 'en',\r\n    };\r\n    const normalized = alias[lang] || lang;\r\n\r\n    const paths = {\r\n        'zh-cn': './locales/zh-cn.json',\r\n        'zh-tw': './locales/zh-tw.json',\r\n        'ja-jp': './locales/ja-jp.json',\r\n        'ru-ru': './locales/ru-ru.json',\r\n        'es-es': './locales/es-es.json',\r\n        'de-de': './locales/de-de.json',\r\n        'fr-fr': './locales/fr-fr.json',\r\n        'ko-kr': './locales/ko-kr.json',\r\n        'ms-my': './locales/ms-my.json',\r\n        'id-id': './locales/id-id.json',\r\n    };\r\n\r\n    const rel = paths[normalized];\r\n    if (!rel) return null;\r\n\r\n    try {\r\n        const res = await fetch(new URL(rel, import.meta.url));\r\n        if (!res.ok) return null;\r\n        return await res.json();\r\n    } catch (e) {\r\n        console.warn('STMemoryBooks: Failed to load locale JSON for', normalized, e);\r\n        return null;\r\n    }\r\n}\r\n// import { localeData_fr } from './locales/fr-fr.js';\r\n// import { localeData_es } from './locales/es-es.js';\r\n\r\n/**\r\n * English (default) locale data\r\n */\r\nexport const localeData_en = {\r\n    // Main Settings Header\r\n    'STMemoryBooks_Settings': ' Memory Books Settings',\r\n\r\n    // Scene Display\r\n    'STMemoryBooks_CurrentScene': 'Current Scene:',\r\n    'STMemoryBooks_Start': 'Start',\r\n    'STMemoryBooks_End': 'End',\r\n    'STMemoryBooks_Message': 'Message',\r\n    'STMemoryBooks_Messages': 'Messages',\r\n    'STMemoryBooks_EstimatedTokens': 'Estimated tokens',\r\n    'STMemoryBooks_NoSceneMarkers': 'No scene markers set. Use the chevron buttons in chat messages to mark start () and end () points.',\r\n\r\n    // Memory Status\r\n    'STMemoryBooks_MemoryStatus': 'Memory Status',\r\n    'STMemoryBooks_ProcessedUpTo': 'Processed up to message',\r\n    'STMemoryBooks_LastProcessedManuallySet': 'last processed message manually set to',\r\n    'STMemoryBooks_NoMemoriesProcessed': 'No memories have been processed for this chat yet',\r\n    'STMemoryBooks_SinceVersion': '(since updating to version 3.6.2 or higher.)',\r\n    'STMemoryBooks_AutoSummaryNote': 'Please note that Auto-Summary requires you to \"prime\" every chat with at least one manual memory. After that, summaries will be made automatically.',\r\n    \r\n    // /stmb-set-highest command\r\n    'STMemoryBooks_Slash_SetHighest_Help': 'Manually set the highest processed message index for this chat. Usage: /stmb-set-highest <N|none>',\r\n    'STMemoryBooks_Slash_SetHighest_ArgDesc': 'Message index (0-based) or \"none\" to reset',\r\n    'STMemoryBooks_SetHighest_MissingArg': 'Missing argument. Use: /stmb-set-highest <N|none>',\r\n    'STMemoryBooks_SetHighest_InvalidArg': 'Invalid argument. Use: /stmb-set-highest <N|none>',\r\n    'STMemoryBooks_SetHighest_NoMessages': 'There are no messages in this chat yet.',\r\n    'STMemoryBooks_SetHighest_Cleared': 'Last processed message cleared (no memories processed).',\r\n    'STMemoryBooks_SetHighest_OutOfRange': 'Message IDs out of range. Valid range: 0-{{max}}',\r\n    'STMemoryBooks_SetHighest_Clamped': 'Highest message is {{max}}, so last message processed has been set to {{max}}.',\r\n    'STMemoryBooks_SetHighest_SetTo': 'Last processed message manually set to #{{value}}.',\r\n\r\n    // Preferences Section\r\n    'STMemoryBooks_Preferences': 'Preferences:',\r\n    'STMemoryBooks_AlwaysUseDefault': 'Always use default profile (no confirmation prompt)',\r\n    'STMemoryBooks_ShowMemoryPreviews': 'Show memory previews',\r\n    'STMemoryBooks_ShowNotifications': 'Show notifications',\r\n    'STMemoryBooks_UnhideBeforeMemory': 'Unhide hidden messages for memory generation (runs /unhide X-Y)',\r\n\r\n    // Manual Mode\r\n    'STMemoryBooks_EnableManualMode': 'Enable Manual Lorebook Mode',\r\n    'STMemoryBooks_ManualModeDesc': 'When enabled, you must specify a lorebook for memories instead of using the one bound to the chat.',\r\n\r\n    // Auto-Create Lorebook\r\n    'STMemoryBooks_AutoCreateLorebook': 'Auto-create lorebook if none exists',\r\n    'STMemoryBooks_AutoCreateLorebookDesc': 'When enabled, automatically creates and binds a lorebook to the chat if none exists.',\r\n    'STMemoryBooks_LorebookNameTemplate': 'Lorebook Name Template:',\r\n    'STMemoryBooks_LorebookNameTemplateDesc': 'Template for auto-created lorebook names. Supports {{char}}, {{user}}, {{chat}} placeholders.',\r\n    'STMemoryBooks_LorebookNameTemplatePlaceholder': 'LTM - {{char}} - {{chat}}',\r\n\r\n    // Lorebook Configuration\r\n    'STMemoryBooks_CurrentLorebookConfig': 'Current Lorebook Configuration',\r\n    'STMemoryBooks_Mode': 'Mode:',\r\n    'STMemoryBooks_ActiveLorebook': 'Active Lorebook:',\r\n    'STMemoryBooks_NoneSelected': 'None selected',\r\n    'STMemoryBooks_UsingChatBound': 'Using chat-bound lorebook',\r\n    'STMemoryBooks_NoChatBound': 'No chat-bound lorebook. Memories will require lorebook selection.',\r\n\r\n    // Scene Options\r\n    'STMemoryBooks_AllowSceneOverlap': 'Allow scene overlap',\r\n    'STMemoryBooks_AllowSceneOverlapDesc': 'Check this box to skip checking for overlapping memories/scenes.',\r\n    'STMemoryBooks_RefreshEditor': 'Refresh lorebook editor after adding memories',\r\n    'STMemoryBooks_MaxTokens': 'Max Tokens:',\r\n    'STMemoryBooks_MaxTokensDesc': 'Maximum number of tokens to use for memory summaries.',\r\n\r\n    // Auto-Summary\r\n    'STMemoryBooks_AutoSummaryEnabled': 'Auto-create memory summaries',\r\n    'STMemoryBooks_AutoSummaryDesc': 'Automatically run /nextmemory after a specified number of messages.',\r\n    'STMemoryBooks_AutoSummaryWarnTooltip': 'Warning: enabling Auto-Summary may create one large memory from the existing backlog. Use /stmb-set-highest <N|none> to control the baseline.',\r\n    'STMemoryBooks_AutoSummaryInterval': 'Auto-Summary Interval:',\r\n    'STMemoryBooks_AutoSummaryIntervalDesc': 'Number of messages after which to automatically create a memory summary.',\r\n    'STMemoryBooks_AutoSummaryBuffer': 'Auto-Summary Buffer:',\r\n    'STMemoryBooks_AutoSummaryBufferDesc': 'Delay auto-summary by X messages (belated generation). Default 2, max 50.',\r\n\r\n    // Auto-Summary Popup and Messages\r\n    'STMemoryBooks_AutoSummaryReadyTitle': 'Auto-Summary Ready',\r\n    'STMemoryBooks_AutoSummaryNoAssignedLorebook': 'Auto-summary is enabled but there is no assigned lorebook for this chat.',\r\n    'STMemoryBooks_AutoSummarySelectOrPostponeQuestion': 'Would you like to select a lorebook for memory storage, or postpone this auto-summary?',\r\n    'STMemoryBooks_PostponeLabel': 'Postpone for how many messages?',\r\n    'STMemoryBooks_Postpone10': '10 messages',\r\n    'STMemoryBooks_Postpone20': '20 messages',\r\n    'STMemoryBooks_Postpone30': '30 messages',\r\n    'STMemoryBooks_Postpone40': '40 messages',\r\n    'STMemoryBooks_Postpone50': '50 messages',\r\n    'STMemoryBooks_Button_SelectLorebook': 'Select Lorebook',\r\n    'STMemoryBooks_Button_Postpone': 'Postpone',\r\n    'STMemoryBooks_Error_NoLorebookSelectedForAutoSummary': 'No lorebook selected for auto-summary.',\r\n    'STMemoryBooks_Info_AutoSummaryPostponed': 'Auto-summary postponed for {{count}} messages.',\r\n    'STMemoryBooks_Error_NoLorebookForAutoSummary': 'No lorebook available for auto-summary.',\r\n    'STMemoryBooks_Error_SelectedLorebookNotFound': 'Selected lorebook \"{{name}}\" not found.',\r\n    'STMemoryBooks_Error_FailedToLoadSelectedLorebook': 'Failed to load the selected lorebook.',\r\n\r\n    // Memory Count Options\r\n    'STMemoryBooks_DefaultMemoryCount': 'Default Previous Memories Count:',\r\n    'STMemoryBooks_DefaultMemoryCountDesc': 'Default number of previous memories to include as context when creating new memories.',\r\n    'STMemoryBooks_MemoryCount0': 'None (0 memories)',\r\n    'STMemoryBooks_MemoryCount1': 'Last 1 memory',\r\n    'STMemoryBooks_MemoryCount2': 'Last 2 memories',\r\n    'STMemoryBooks_MemoryCount3': 'Last 3 memories',\r\n    'STMemoryBooks_MemoryCount4': 'Last 4 memories',\r\n    'STMemoryBooks_MemoryCount5': 'Last 5 memories',\r\n    'STMemoryBooks_MemoryCount6': 'Last 6 memories',\r\n    'STMemoryBooks_MemoryCount7': 'Last 7 memories',\r\n\r\n    // Auto-Hide Options\r\n    'STMemoryBooks_AutoHideMode': 'Auto-hide messages after adding memory:',\r\n    'STMemoryBooks_AutoHideModeDesc': 'Choose what messages to automatically hide after creating a memory.',\r\n    'STMemoryBooks_AutoHideNone': 'Do not auto-hide',\r\n    'STMemoryBooks_AutoHideAll': 'Auto-hide all messages up to the last memory',\r\n    'STMemoryBooks_AutoHideLast': 'Auto-hide only messages in the last memory',\r\n\r\n    // Unhidden Count\r\n    'STMemoryBooks_UnhiddenCount': 'Messages to leave unhidden:',\r\n    'STMemoryBooks_UnhiddenCountDesc': 'Number of recent messages to leave visible when auto-hiding (0 = hide all up to scene end)',\r\n\r\n    // Token Warning\r\n    'STMemoryBooks_TokenWarning': 'Token Warning Threshold:',\r\n    'STMemoryBooks_TokenWarningDesc': 'Show confirmation dialog when estimated input tokens exceed this threshold. Default: 30,000',\r\n\r\n    // Title Format\r\n    'STMemoryBooks_TitleFormat': 'Memory Title Format:',\r\n    'STMemoryBooks_CustomTitleFormat': 'Custom Title Format...',\r\n    'STMemoryBooks_EnterCustomFormat': 'Enter custom format',\r\n    'STMemoryBooks_TitleFormatDesc': 'Use [0], [00], [000] for auto-numbering. Available: {{title}}, {{scene}}, {{char}}, {{user}}, {{messages}}, {{profile}}, {{date}}, {{time}}',\r\n\r\n    // Profiles\r\n    'STMemoryBooks_Profiles': 'Memory Profiles:',\r\n    'STMemoryBooks_Profile_CurrentST': 'Current SillyTavern Settings',\r\n    'STMemoryBooks_Default': '(Default)',\r\n    'STMemoryBooks_ProfileSettings': 'Profile Settings:',\r\n    'STMemoryBooks_Provider': 'Provider',\r\n    'STMemoryBooks_Model': 'Model',\r\n    'STMemoryBooks_Temperature': 'Temperature',\r\n    'STMemoryBooks_ViewPrompt': 'View Prompt',\r\n    'STMemoryBooks_ProfileActions': 'Profile Actions:',\r\n    'STMemoryBooks_extraFunctionButtons': 'Import/Export Profiles:',\r\n    'STMemoryBooks_promptManagerButtons': 'Prompt Managers',\r\n    'STMemoryBooks_PromptManagerButtonsHint': 'Want to tweak things? Use the buttons below to customize each prompt type.',\r\n\r\n    // Confirmation Popup\r\n    'STMemoryBooks_CreateMemory': 'Create Memory',\r\n    'STMemoryBooks_ScenePreview': 'Scene Preview:',\r\n    'STMemoryBooks_UsingProfile': 'Using Profile',\r\n    'STMemoryBooks_LargeSceneWarning': 'Large scene',\r\n    'STMemoryBooks_MayTakeTime': 'may take some time to process.',\r\n    'STMemoryBooks_AdvancedOptionsHint': 'Click \"Advanced Options\" to customize prompt, context memories, or API settings.',\r\n\r\n    // Advanced Options Popup\r\n    'STMemoryBooks_AdvancedOptions': 'Advanced Memory Options',\r\n    'STMemoryBooks_SceneInformation': 'Scene Information:',\r\n    'STMemoryBooks_Total': 'total',\r\n    'STMemoryBooks_BaseTokens': 'Base tokens',\r\n    'STMemoryBooks_TotalTokens': 'Total tokens',\r\n    'STMemoryBooks_Profile': 'Profile',\r\n    'STMemoryBooks_ChangeProfileDesc': 'Change the profile to use different base settings.',\r\n    'STMemoryBooks_MemoryCreationPrompt': 'Memory Creation Prompt:',\r\n    'STMemoryBooks_CustomizePromptDesc': 'Customize the prompt used to generate this memory.',\r\n    'STMemoryBooks_MemoryPromptPlaceholder': 'Memory creation prompt',\r\n    'STMemoryBooks_IncludePreviousMemories': 'Include Previous Memories as Context:',\r\n    'STMemoryBooks_PreviousMemoriesDesc': 'Previous memories provide context for better continuity.',\r\n    'STMemoryBooks_Found': 'Found',\r\n    'STMemoryBooks_ExistingMemorySingular': 'existing memory in lorebook.',\r\n    'STMemoryBooks_ExistingMemoriesPlural': 'existing memories in lorebook.',\r\n    'STMemoryBooks_NoMemoriesFound': 'No existing memories found in lorebook.',\r\n\r\n    // API Override\r\n    'STMemoryBooks_APIOverride': 'API Override Settings:',\r\n    'STMemoryBooks_CurrentSTSettings': 'Current SillyTavern Settings:',\r\n    'STMemoryBooks_API': 'API',\r\n    'STMemoryBooks_UseCurrentSettings': 'Use current SillyTavern settings instead of profile settings',\r\n    'STMemoryBooks_OverrideDesc': 'Override the profile\\'s model and temperature with your current SillyTavern settings.',\r\n    'STMemoryBooks_SaveAsNewProfile': 'Save as New Profile:',\r\n    'STMemoryBooks_ProfileName': 'Profile Name:',\r\n    'STMemoryBooks_SaveProfileDesc': 'Your current settings differ from the selected profile. Save them as a new profile.',\r\n    'STMemoryBooks_EnterProfileName': 'Enter new profile name',\r\n    'STMemoryBooks_LargeSceneWarningShort': ' Large scene may take some time to process.',\r\n\r\n    // Memory Preview\r\n    'STMemoryBooks_MemoryPreview': ' Memory Preview',\r\n    'STMemoryBooks_MemoryPreviewDesc': 'Review the generated memory below. You can edit the content while preserving the structure.',\r\n    'STMemoryBooks_MemoryTitle': 'Memory Title:',\r\n    'STMemoryBooks_MemoryTitlePlaceholder': 'Memory title',\r\n    'STMemoryBooks_MemoryContent': 'Memory Content:',\r\n    'STMemoryBooks_MemoryContentPlaceholder': 'Memory content',\r\n    'STMemoryBooks_Keywords': 'Keywords:',\r\n    'STMemoryBooks_KeywordsDesc': 'Separate keywords with commas',\r\n    'STMemoryBooks_KeywordsPlaceholder': 'keyword1, keyword2, keyword3',\r\n    'STMemoryBooks_UnknownProfile': 'Unknown Profile',\r\n\r\n    // Prompt Manager\r\n    'STMemoryBooks_PromptManager_Title': ' Summary Prompt Manager',\r\n    'STMemoryBooks_PromptManager_Desc': 'Manage your summary generation prompts. All presets are editable.',\r\n    'STMemoryBooks_PromptManager_Search': 'Search presets...',\r\n    'STMemoryBooks_PromptManager_DisplayName': 'Display Name',\r\n    'STMemoryBooks_PromptManager_DateCreated': 'Date Created',\r\n    'STMemoryBooks_PromptManager_New': ' New Preset',\r\n    'STMemoryBooks_PromptManager_Edit': ' Edit',\r\n    'STMemoryBooks_PromptManager_Duplicate': ' Duplicate',\r\n    'STMemoryBooks_PromptManager_Delete': ' Delete',\r\n    'STMemoryBooks_PromptManager_Export': ' Export JSON',\r\n    'STMemoryBooks_PromptManager_Import': ' Import JSON',\r\n    'STMemoryBooks_PromptManager_ApplyToProfile': ' Apply to Selected Profile',\r\n    'STMemoryBooks_PromptManager_NoPresets': 'No presets available',\r\n\r\n    // Profile Editor - Preset management\r\n    'STMemoryBooks_Profile_MemoryMethod': 'Memory Creation Method:',\r\n    'STMemoryBooks_Profile_PresetSelectDesc': 'Choose a preset. Create and edit presets in the Summary Prompt Manager.',\r\n    'STMemoryBooks_CustomPromptManaged': 'Custom prompts are now controlled by the Summary Prompt Manager.',\r\n    'STMemoryBooks_OpenPromptManager': ' Open Summary Prompt Manager',\r\n    'STMemoryBooks_MoveToPreset': ' Move Current Custom Prompt to Preset',\r\n    'STMemoryBooks_MoveToPresetConfirmTitle': 'Move to Preset',\r\n    'STMemoryBooks_MoveToPresetConfirmDesc': 'Create a preset from this profile\\'s custom prompt, set the preset on this profile, and clear the custom prompt?',\r\n\r\n    // Side Prompts\r\n    'STMemoryBooks_SidePrompts_Title': ' Trackers & Side Prompts',\r\n    'STMemoryBooks_SidePrompts_Desc': 'Create and manage side prompts for trackers and other behind-the-scenes functions.',\r\n    'STMemoryBooks_EditSidePrompt': 'Edit Side Prompt',\r\n    'STMemoryBooks_ResponseFormatPlaceholder': 'Optional response format',\r\n    'STMemoryBooks_PreviousMemoriesHelp': 'Number of previous memory entries to include before scene text (0 = none).',\r\n    'STMemoryBooks_Name': 'Name',\r\n    'STMemoryBooks_Key': 'Key',\r\n    'STMemoryBooks_Enabled': 'Enabled',\r\n    'STMemoryBooks_RunOnVisibleMessageInterval': 'Run on visible message interval',\r\n    'STMemoryBooks_IntervalVisibleMessages': 'Interval (visible messages):',\r\n    'STMemoryBooks_RunAutomaticallyAfterMemory': 'Run automatically after memory',\r\n    'STMemoryBooks_AllowManualRunViaSideprompt': 'Allow manual run via /sideprompt',\r\n    'STMemoryBooks_Triggers': 'Triggers',\r\n    'STMemoryBooks_ResponseFormatOptional': 'Response Format (optional)',\r\n    'STMemoryBooks_OrderValue': 'Order Value',\r\n    'STMemoryBooks_PreviousMemoriesForContext': 'Previous memories for context',\r\n    'STMemoryBooks_Overrides': 'Overrides',\r\n    'STMemoryBooks_OverrideDefaultMemoryProfile': 'Override default memory profile',\r\n    'STMemoryBooks_ConnectionProfile': 'Connection Profile',\r\n    'STMemoryBooks_NewSidePrompt': 'New Side Prompt',\r\n    'STMemoryBooks_MySidePromptPlaceholder': 'My Side Prompt',\r\n    'STMemoryBooks_Actions': 'Actions',\r\n    'STMemoryBooks_None': 'None',\r\n    'STMemoryBooks_Edit': 'Edit',\r\n    'STMemoryBooks_Duplicate': 'Duplicate',\r\n    'STMemoryBooks_NoSidePromptsAvailable': 'No side prompts available.',\r\n    'STMemoryBooks_SidePrompts_New': ' New',\r\n    'STMemoryBooks_SidePrompts_ExportJSON': ' Export JSON',\r\n    'STMemoryBooks_SidePrompts_ImportJSON': ' Import JSON',\r\n    'STMemoryBooks_SidePrompts_RecreateBuiltIns': ' Recreate Built-in Side Prompts',\r\n    'STMemoryBooks_SidePrompts_RecreateTitle': 'Recreate Built-in Side Prompts',\r\n    'STMemoryBooks_SidePrompts_RecreateWarning': 'This will overwrite the built-in Side Prompts (Plotpoints, Status, Cast of Characters, Assess) with the current locale versions. Custom/user-created prompts are not touched. This action cannot be undone.',\r\n    'STMemoryBooks_SidePrompts_RecreateOk': 'Recreate',\r\n    'STMemoryBooks_SidePrompts_RecreateSuccess': 'Recreated {{count}} built-in side prompts from current locale',\r\n    'STMemoryBooks_SidePrompts_RecreateFailed': 'Failed to recreate built-in side prompts',\r\n    'STMemoryBooks_SidePrompts_MaxConcurrentLabel': 'Max concurrent side prompts',\r\n    'STMemoryBooks_SidePrompts_MaxConcurrentHelp': 'This controls how many side prompts can be running at one time. Lower this value if you have a slow connection or are running into rate limits. Default: 3',\r\n    'STMemoryBooks_SidePromptCreated': 'SidePrompt \"{{name}}\" created.',\r\n    'STMemoryBooks_FailedToCreateSidePrompt': 'Failed to create SidePrompt.',\r\n    'STMemoryBooks_SidePromptDuplicated': 'SidePrompt \"{{name}}\" duplicated.',\r\n    'STMemoryBooks_FailedToDuplicateSidePrompt': 'Failed to duplicate SidePrompt.',\r\n    'STMemoryBooks_SidePromptDeleted': 'SidePrompt \"{{name}}\" deleted.',\r\n    'STMemoryBooks_FailedToDeleteSidePrompt': 'Failed to delete SidePrompt.',\r\n    'STMemoryBooks_SidePromptsExported': 'Side prompts exported.',\r\n    'STMemoryBooks_FailedToExportSidePrompts': 'Failed to export side prompts.',\r\n    'STMemoryBooks_ImportedSidePrompts': 'Imported {{count}} side prompts.',\r\n    'STMemoryBooks_ImportedSidePromptsDetail': 'Imported side prompts: {{added}} added{{detail}}',\r\n    'STMemoryBooks_ImportedSidePromptsRenamedDetail': ' ({{count}} renamed due to key conflicts)',\r\n    'STMemoryBooks_FailedToImportSidePrompts': 'Failed to import side prompts.',\r\n    'STMemoryBooks_DeleteSidePromptTitle': 'Delete Side Prompt',\r\n    'STMemoryBooks_DeleteSidePromptConfirm': 'Are you sure you want to delete \"{{name}}\"?',\r\n    'STMemoryBooks_NameEmptyKeepPrevious': 'Name was empty. Keeping previous name.',\r\n    'STMemoryBooks_SidePrompts_NoNameProvidedUsingUntitled': 'No name provided. Using \"Untitled Side Prompt\".',\r\n\r\n    // General / Menu\r\n    'STMemoryBooks_MenuItem': 'Memory Books',\r\n    'STMemoryBooks_Close': 'Close',\r\n    'STMemoryBooks_NoMatches': 'No matches',\r\n\r\n    // Side Prompt Picker\r\n    'STMemoryBooks_RunSidePrompt': 'Run Side Prompt',\r\n    'STMemoryBooks_SearchSidePrompts': 'Search side prompts...',\r\n\r\n    // Badges\r\n    'STMemoryBooks_Interval': 'Interval',\r\n    'STMemoryBooks_AfterMemory': 'AfterMemory',\r\n    'STMemoryBooks_Manual': 'Manual',\r\n    'STMemoryBooks_AutomaticChatBound': 'Automatic (Chat-bound)',\r\n\r\n    // Lorebook\r\n    'STMemoryBooks_UsingChatBoundLorebook': 'Using chat-bound lorebook \"<strong>{{lorebookName}}</strong>\"',\r\n    'STMemoryBooks_NoChatBoundLorebook': 'No chat-bound lorebook. Memories will require lorebook selection.',\r\n    'STMemoryBooks_ManualLorebookSetupTitle': 'Manual Lorebook Setup',\r\n    'STMemoryBooks_ManualLorebookSetupDesc1': 'You have a chat-bound lorebook \"<strong>{{name}}</strong>\".',\r\n    'STMemoryBooks_ManualLorebookSetupDesc2': 'Would you like to use it for manual mode or select a different one?',\r\n    'STMemoryBooks_UseChatBound': 'Use Chat-bound',\r\n    'STMemoryBooks_SelectDifferent': 'Select Different',\r\n\r\n    // Slash Commands\r\n    'STMemoryBooks_SidePromptGuide': 'SidePrompt guide: Type a template name after the space to see suggestions. Usage: /sideprompt \"Name\" [X-Y]. Quote names with spaces.',\r\n    'STMemoryBooks_MultipleMatches': 'Multiple matches: {{top}}{{more}}. Refine the name or use quotes. Usage: /sideprompt \"Name\" [X-Y]',\r\n\r\n    // Prompt Manager\r\n    'STMemoryBooks_ClearCustomPromptTitle': 'Clear Custom Prompt?',\r\n    'STMemoryBooks_ClearCustomPromptDesc': 'This profile has a custom prompt. Clear it so the selected preset is used?',\r\n    'STMemoryBooks_CreateNewPresetTitle': 'Create New Preset',\r\n    'STMemoryBooks_DisplayNameTitle': 'Display Name:',\r\n    'STMemoryBooks_MyCustomPreset': 'My Custom Preset',\r\n    'STMemoryBooks_PromptTitle': 'Prompt:',\r\n    'STMemoryBooks_EnterPromptPlaceholder': 'Enter your prompt here...',\r\n    'STMemoryBooks_EditPresetTitle': 'Edit Preset',\r\n    'STMemoryBooks_DeletePresetTitle': 'Delete Preset',\r\n    'STMemoryBooks_DeletePresetConfirm': 'Are you sure you want to delete \"{{name}}\"?',\r\n    'STMemoryBooks_NotSet': 'Not Set',\r\n    'STMemoryBooks_ProfileNamePlaceholder': 'Profile name',\r\n    'STMemoryBooks_ModelAndTempSettings': 'Model & Temperature Settings:',\r\n    'STMemoryBooks_ModelHint': 'For model, copy-paste the exact model ID, eg. `gemini-2.5-pro`, `deepseek/deepseek-r1-0528:free`, `gpt-4o-mini-2024-07-18`, etc.',\r\n    'STMemoryBooks_ModelPlaceholder': 'Paste model ID here',\r\n    'STMemoryBooks_APIProvider': 'API/Provider:',\r\n    'STMemoryBooks_CustomAPI': 'Custom API',\r\n    'STMemoryBooks_APIProfileConfigHint': ' Profile Setup Hint: STMB automatically reads API info and keys from your ST config. First, configure and test your connection in ST using Test Message. Then select it from the dropdown above to use those settings for memory generation. Only use Full Manual Configuration if you need two different Custom OpenAI-Compatible setups; otherwise, just create two connection profiles in STone for roleplay and one for Memory Books.',\r\n    'STMemoryBooks_FullManualConfig': 'Full Manual Configuration',\r\n    'STMemoryBooks_TemperatureRange': 'Temperature (0.0 - 2.0):',\r\n    'STMemoryBooks_TemperaturePlaceholder': 'DO NOT LEAVE BLANK! If unsure put 0.8.',\r\n    'STMemoryBooks_APIEndpointURL': 'API Endpoint URL:',\r\n    'STMemoryBooks_APIEndpointPlaceholder': 'https://api.example.com/v1/chat/completions',\r\n    'STMemoryBooks_APIKey': 'API Key:',\r\n    'STMemoryBooks_APIKeyPlaceholder': 'Enter your API key',\r\n    'STMemoryBooks_LorebookEntrySettings': 'Lorebook Entry Settings',\r\n    'STMemoryBooks_LorebookEntrySettingsDesc': 'These settings control how the generated memory is saved into the lorebook.',\r\n    'STMemoryBooks_OutletName': 'Outlet Name',\r\n    'STMemoryBooks_OutletNamePlaceholder': 'e.g., ENDING',\r\n    'STMemoryBooks_ActivationMode': 'Activation Mode:',\r\n    'STMemoryBooks_ActivationModeDesc': ' Vectorized is recommended for memories.',\r\n    'STMemoryBooks_Vectorized': ' Vectorized (Default)',\r\n    'STMemoryBooks_Constant': ' Constant',\r\n    'STMemoryBooks_Normal': ' Normal',\r\n    'STMemoryBooks_InsertionPosition': 'Insertion Position:',\r\n    'STMemoryBooks_InsertionPositionDesc': 'Char is recommended. Aiko recommends memories never go lower than AN.',\r\n    'STMemoryBooks_CharUp': 'Char',\r\n    'STMemoryBooks_CharDown': 'Char',\r\n    'STMemoryBooks_ANUp': 'AN',\r\n    'STMemoryBooks_ANDown': 'AN',\r\n    'STMemoryBooks_EMUp': 'EM',\r\n    'STMemoryBooks_EMDown': 'EM',\r\n    'STMemoryBooks_Outlet': 'Outlet',\r\n    'STMemoryBooks_InsertionOrder': 'Insertion Order:',\r\n    'STMemoryBooks_AutoOrder': 'Auto (uses memory #)',\r\n    'STMemoryBooks_ReverseOrder': 'Reverse (only use with Outlets)',\r\n    'STMemoryBooks_ManualOrder': 'Manual',\r\n    'STMemoryBooks_RecursionSettings': 'Recursion Settings:',\r\n    'STMemoryBooks_PreventRecursion': 'Prevent Recursion',\r\n    'STMemoryBooks_DelayUntilRecursion': 'Delay Until Recursion',\r\n    'STMemoryBooks_RefreshPresets': ' Refresh Presets',\r\n    'STMemoryBooks_Button_CreateMemory': 'Create Memory',\r\n    'STMemoryBooks_Button_AdvancedOptions': 'Advanced Options...',\r\n    'STMemoryBooks_Button_SaveAsNewProfile': 'Save as New Profile',\r\n    'STMemoryBooks_SaveProfileAndCreateMemory': 'Save Profile & Create Memory',\r\n    'STMemoryBooks_Tooltip_SaveProfileAndCreateMemory': 'Save the modified settings as a new profile and create the memory',\r\n    'STMemoryBooks_Tooltip_CreateMemory': 'Create memory using the selected profile settings',\r\n    'STMemoryBooks_EditAndSave': 'Edit & Save',\r\n    'STMemoryBooks_RetryGeneration': 'Retry Generation',\r\n    'STMemoryBooks_PromptManager_Hint': ' When creating a new prompt, copy one of the other built-in prompts and then amend it. Don\\'t change the \"respond with JSON\" instructions, Memory Books uses that to process the returned result from the AI.',\r\n    'STMemoryBooks_ExpandEditor': 'Expand the editor',\r\n    'STMemoryBooks_ClearAndApply': 'Clear and Apply',\r\n    'STMemoryBooks_Cancel': 'Cancel',\r\n    'STMemoryBooks_Create': 'Create',\r\n    'STMemoryBooks_Save': 'Save',\r\n    'STMemoryBooks_Delete': 'Delete',\r\n\r\n    // Toasts\r\n    'STMemoryBooks_Toast_ProfileSaved': 'Profile \"{{name}}\" saved successfully',\r\n    'STMemoryBooks_Toast_ProfileSaveFailed': 'Failed to save profile: {{message}}',\r\n    'STMemoryBooks_Toast_ProfileNameOrProceed': 'Please enter a profile name or use \"Create Memory\" to proceed without saving',\r\n    'STMemoryBooks_Toast_ProfileNameRequired': 'Please enter a profile name',\r\n    'STMemoryBooks_Toast_UnableToReadEditedValues': 'Unable to read edited values',\r\n    'STMemoryBooks_Toast_UnableToFindInputFields': 'Unable to find input fields',\r\n    'STMemoryBooks_Toast_TitleCannotBeEmpty': 'Memory title cannot be empty',\r\n    'STMemoryBooks_Toast_ContentCannotBeEmpty': 'Memory content cannot be empty',\r\n\r\n    // Side Prompts\r\n    'STMemoryBooks_Toast_NoMemoryLorebookAssigned': 'No memory lorebook is assigned. Open Memory Books settings and select or bind a lorebook.',\r\n    'STMemoryBooks_Error_NoMemoryLorebookAssigned': 'No memory lorebook assigned',\r\n    'STMemoryBooks_Error_FailedToLoadLorebook': 'Failed to load lorebook',\r\n    'STMemoryBooks_Toast_FailedToLoadLorebook': 'Failed to load the selected lorebook.',\r\n    'STMemoryBooks_Toast_SidePromptFailed': 'SidePrompt \"{{name}}\" failed: {{message}}',\r\n    'STMemoryBooks_Toast_FailedToUpdateSidePrompt': 'Failed to update sideprompt entry \"{{name}}\"',\r\n    'STMemoryBooks_Toast_FailedToSaveWave': 'Failed to save SidePrompt updates for this wave',\r\n    'STMemoryBooks_Toast_SidePromptsSucceeded': 'Side Prompts after memory: {{okCount}} succeeded. {{succeeded}}',\r\n    'STMemoryBooks_Toast_SidePromptsPartiallyFailed': 'Side Prompts after memory: {{okCount}} succeeded, {{failCount}} failed. {{failed}}',\r\n    'STMemoryBooks_Toast_SidePromptNameNotProvided': 'SidePrompt name not provided. Usage: /sideprompt \"Name\" [X-Y]',\r\n\r\n    // Scene Manager\r\n    'STMemoryBooks_Toast_SceneClearedStart': 'Scene cleared due to start marker deletion',\r\n    'STMemoryBooks_Toast_SceneEndPointCleared': 'Scene end point cleared due to message deletion',\r\n    'STMemoryBooks_Toast_SceneMarkersAdjusted': 'Scene markers adjusted due to message deletion.',\r\n    'STMemoryBooks_MarkSceneStart': 'Mark Scene Start',\r\n    'STMemoryBooks_MarkSceneEnd': 'Mark Scene End',\r\n\r\n    // Settings Popup Buttons / Toasts\r\n    'STMemoryBooks_CreateMemoryBtn': 'Create Memory',\r\n    'STMemoryBooks_ClearSceneBtn': 'Clear Scene',\r\n    'STMemoryBooks_NoSceneSelected': 'No scene selected. Make sure both start and end points are set.',\r\n\r\n    // Runtime and Toasts (added)\r\n    'STMemoryBooks_NoSceneMarkersToastr': 'No scene markers set. Use chevron buttons to mark start and end points first.',\r\n    'STMemoryBooks_MissingRangeArgument': 'Missing range argument. Use: /scenememory X-Y (e.g., /scenememory 10-15)',\r\n    'STMemoryBooks_InvalidFormat': 'Invalid format. Use: /scenememory X-Y (e.g., /scenememory 10-15)',\r\n    'STMemoryBooks_InvalidMessageIDs': 'Invalid message IDs parsed. Use: /scenememory X-Y (e.g., /scenememory 10-15)',\r\n    'STMemoryBooks_StartGreaterThanEnd': 'Start message cannot be greater than end message',\r\n    'STMemoryBooks_MessageIDsOutOfRange': 'Message IDs out of range.',\r\n    'STMemoryBooks_MessagesDoNotExist': 'One or more specified messages do not exist',\r\n    'STMemoryBooks_SceneSet': 'Scene set.',\r\n    'STMemoryBooks_MemoryAlreadyInProgress': 'Memory creation is already in progress',\r\n    'STMemoryBooks_NoLorebookAvailable': 'No lorebook available.',\r\n    'STMemoryBooks_NoMessagesToSummarize': 'There are no messages to summarize yet.',\r\n    'STMemoryBooks_NoNewMessagesSinceLastMemory': 'No new messages since the last memory.',\r\n    'STMemoryBooks_NextMemoryFailed': 'Failed to run /nextmemory.',\r\n    'STMemoryBooks_OnlyNOfRequestedMemoriesAvailable': 'Only some of the requested memories are available',\r\n    'STMemoryBooks_NoPreviousMemoriesFound': 'No previous memories found in lorebook',\r\n    'STMemoryBooks_WorkingToast': 'Creating memory...',\r\n    'STMemoryBooks_MaximumRetryAttemptsReached': 'Maximum retry attempts reached',\r\n    'STMemoryBooks_RetryingMemoryGeneration': 'Retrying memory generation...',\r\n    'STMemoryBooks_UnableToRetrieveEditedMemoryData': 'Unable to retrieve edited memory data',\r\n    'STMemoryBooks_EditedMemoryDataIncomplete': 'Edited memory data is incomplete',\r\n    'STMemoryBooks_MemoryCreatedSuccessfully': 'Memory created successfully!',\r\n    'STMemoryBooks_MemoryCreationFailedWillRetry': 'Memory creation failed. Retrying...',\r\n    'STMemoryBooks_SceneTooLarge': 'Scene is too large. Try selecting a smaller range.',\r\n    'STMemoryBooks_AIFailedToGenerateValidMemory': 'AI failed to generate valid memory.',\r\n    'STMemoryBooks_ProfileConfigurationError': 'Profile configuration error.',\r\n    'STMemoryBooks_FailedToCreateMemory': 'Failed to create memory.',\r\n    'STMemoryBooks_LoadingCharacterData': 'SillyTavern is still loading character data, please wait a few seconds and try again.',\r\n    'STMemoryBooks_GroupChatDataUnavailable': 'Group chat data not available, please wait a few seconds and try again.',\r\n    'STMemoryBooks_LorebookValidationError': 'Lorebook validation error',\r\n    'STMemoryBooks_SceneOverlap': 'Scene overlaps with existing memory.',\r\n    'STMemoryBooks_UnexpectedError': 'An unexpected error occurred.',\r\n\r\n    // Manual lorebook and Profiles UI (added)\r\n    'STMemoryBooks_ChangeManualLorebook': 'Change',\r\n    'STMemoryBooks_SelectManualLorebook': 'Select',\r\n    'STMemoryBooks_ManualLorebook': 'Manual Lorebook',\r\n    'STMemoryBooks_FailedToSelectManualLorebook': 'Failed to select manual lorebook',\r\n    'STMemoryBooks_ClearManualLorebook': 'Clear Manual Lorebook',\r\n    'STMemoryBooks_ManualLorebookCleared': 'Manual lorebook cleared',\r\n    'STMemoryBooks_FailedToClearManualLorebook': 'Failed to clear manual lorebook',\r\n    'STMemoryBooks_SetAsDefault': 'Set as Default',\r\n    'STMemoryBooks_SetAsDefaultProfileSuccess': '\"{{name}}\" is now the default profile.',\r\n    'STMemoryBooks_EditProfile': 'Edit Profile',\r\n    'STMemoryBooks_FailedToEditProfile': 'Failed to edit profile',\r\n    'STMemoryBooks_NewProfile': 'New Profile',\r\n    'STMemoryBooks_FailedToCreateProfile': 'Failed to create profile',\r\n    'STMemoryBooks_DeleteProfile': 'Delete Profile',\r\n    'STMemoryBooks_FailedToDeleteProfile': 'Failed to delete profile',\r\n    'STMemoryBooks_ExportProfiles': 'Export Profiles',\r\n    'STMemoryBooks_FailedToExportProfiles': 'Failed to export profiles',\r\n    'STMemoryBooks_ImportProfiles': 'Import Profiles',\r\n    'STMemoryBooks_SummaryPromptManager': 'Summary Prompt Manager',\r\n    'STMemoryBooks_FailedToOpenSummaryPromptManager': 'Failed to open Summary Prompt Manager',\r\n    'STMemoryBooks_SidePrompts': 'Side Prompts',\r\n    'STMemoryBooks_FailedToOpenSidePrompts': 'Failed to open Side Prompts',\r\n    'STMemoryBooks_SelectPresetFirst': 'Select a preset first',\r\n    'STMemoryBooks_NoProfilesAvailable': 'No profiles available',\r\n    'STMemoryBooks_SelectedProfileNotFound': 'Selected profile not found',\r\n    'STMemoryBooks_PresetAppliedToProfile': 'Preset applied to profile',\r\n    'STMemoryBooks_PromptCannotBeEmpty': 'Prompt cannot be empty',\r\n    'STMemoryBooks_PresetCreatedSuccessfully': 'Preset created successfully',\r\n    'STMemoryBooks_FailedToCreatePreset': 'Failed to create preset',\r\n    'STMemoryBooks_PresetUpdatedSuccessfully': 'Preset updated successfully',\r\n    'STMemoryBooks_FailedToEditPreset': 'Failed to edit preset',\r\n    'STMemoryBooks_PresetDuplicatedSuccessfully': 'Preset duplicated successfully',\r\n    'STMemoryBooks_FailedToDuplicatePreset': 'Failed to duplicate preset',\r\n    'STMemoryBooks_PresetDeletedSuccessfully': 'Preset deleted successfully',\r\n    'STMemoryBooks_PromptsExportedSuccessfully': 'Prompts exported successfully',\r\n    'STMemoryBooks_PromptsImportedSuccessfully': 'Prompts imported successfully',\r\n    'STMemoryBooks_FailedToImportPrompts': 'Failed to import prompts.',\r\n    'STMemoryBooks_CreateMemoryButton': 'Create Memory',\r\n    'STMemoryBooks_ConsolidateArcsButton': 'Consolidate Memories into Arcs',\r\n    'STMemoryBooks_NoSceneSelectedMakeSure': 'No scene selected. Make sure both start and end points are set.',\r\n    'STMemoryBooks_ClearSceneButton': 'Clear Scene',\r\n    'STMemoryBooks_FailedToImportProfiles': 'Failed to import profiles',\r\n    'STMemoryBooks_ManualLorebookSet': 'Manual lorebook set to \"{{name}}\"',\r\n    'STMemoryBooks_PleaseSelectLorebookForManualMode': 'Please select a lorebook for manual mode',\r\n    'STMemoryBooks_FailedToSaveSettings': 'Failed to save settings. Please try again.',\r\n    'STMemoryBooks_FailedToInitializeChatMonitoring': 'STMemoryBooks: Failed to initialize chat monitoring. Please refresh the page.',\r\n    'STMemoryBooks_Label_CurrentSTModel': 'Current SillyTavern model',\r\n    'STMemoryBooks_Label_CurrentSTTemperature': 'Current SillyTavern temperature',\r\n    'STMemoryBooks_Label_TotalTokens': 'Total tokens: {{count}}',\r\n    'STMemoryBooks_Label_TotalTokensCalculating': 'Total tokens: Calculating...',\r\n    'STMemoryBooks_Warn_LargeSceneTokens': ' Large scene ({{tokens}} tokens) may take some time to process.',\r\n    'STMemoryBooks_ModifiedProfileName': '{{name}} - Modified',\r\n\t'STMemoryBooks_ProfileEditTitle': 'Edit Profile',\r\n    'STMemoryBooks_CancelClose': 'Cancel/Close',\r\n    'STMemoryBooks_InvalidProfileData': 'Invalid profile data',\r\n    'STMemoryBooks_ProfileUpdatedSuccess': 'Profile updated successfully',\r\n    'STMemoryBooks_NewProfileTitle': 'New Profile',\r\n    'STMemoryBooks_ProfileCreatedSuccess': 'Profile created successfully',\r\n    'STMemoryBooks_DeleteProfileConfirm': 'Delete profile \"{{name}}\"?',\r\n    'STMemoryBooks_CannotDeleteLastProfile': 'Cannot delete the last profile',\r\n    'STMemoryBooks_CannotDeleteDefaultProfile': 'Cannot delete the \"Current SillyTavern Settings\" profile - it is required for the extension to work',\r\n    'STMemoryBooks_ProfileDeletedSuccess': 'Profile deleted successfully',\r\n    'STMemoryBooks_ProfilesExportedSuccess': 'Profiles exported successfully',\r\n    'STMemoryBooks_ImportErrorInvalidFormat': 'Invalid profile data format - missing profiles array',\r\n    'STMemoryBooks_ImportErrorNoValidProfiles': 'No valid profiles found in import file',\r\n    'STMemoryBooks_ImportSuccess': 'Imported {{importedCount}} profile{{plural}}',\r\n    'STMemoryBooks_ImportSkipped': ' ({{skippedCount}} duplicate{{plural}} skipped)',\r\n    'STMemoryBooks_ImportComplete': 'STMemoryBooks profile import completed',\r\n    'STMemoryBooks_ImportNoNewProfiles': 'No new profiles imported - all profiles already exist',\r\n    'STMemoryBooks_ImportFailed': 'Failed to import profiles: {{message}}',\r\n    'STMemoryBooks_ImportReadError': 'Failed to read import file',\r\n    'STMemoryBooks_PromptManagerNotFound': 'Prompt Manager button not found. Open main settings and try again.',\r\n    'STMemoryBooks_PresetListRefreshed': 'Preset list refreshed',\r\n    'STMemoryBooks_FailedToRefreshPresets': 'Failed to refresh presets',\r\n    'STMemoryBooks_NoCustomPromptToMigrate': 'No custom prompt to migrate',\r\n    'STMemoryBooks_CustomPromptMigrated': 'Preset created and selected. Remember to Save.',\r\n    'STMemoryBooks_FailedToMigrateCustomPrompt': 'Failed to move custom prompt to preset',\r\n\t'STMemoryBooks_Toast_SidePromptUpdated': 'SidePrompt \"{{name}}\" updated.',\r\n    'STMemoryBooks_Toast_SidePromptNotFound': 'SidePrompt template not found. Check name.',\r\n    'STMemoryBooks_Toast_ManualRunDisabled': 'Manual run is disabled for this template. Enable \"Allow manual run via /sideprompt\" in the template settings.',\r\n    'STMemoryBooks_Toast_NoMessagesAvailable': 'No messages available.',\r\n    'STMemoryBooks_Toast_InvalidRangeFormat': 'Invalid range format. Use X-Y',\r\n    'STMemoryBooks_Toast_InvalidMessageRange': 'Invalid message range for /sideprompt',\r\n    'STMemoryBooks_Toast_FailedToCompileRange': 'Failed to compile the specified range',\r\n    'STMemoryBooks_Toast_SidePromptRangeTip': 'Tip: You can run a specific range with /sideprompt \"Name\" X-Y (e.g., /sideprompt \"Scoreboard\" 100-120). Running without a range uses messages since the last checkpoint.',\r\n    'STMemoryBooks_Toast_FailedToCompileMessages': 'Failed to compile messages for /sideprompt',\r\n\t'STMemoryBooks_Plotpoints': 'Plotpoints',\r\n    'STMemoryBooks_PlotpointsPrompt': \"Analyze the accompanying scene for plot threads, story arcs, and other narrative movements. The previous scenes are there to provide context. Generate a story thread report. If a report already exists in context, update it instead of recreating.\",\r\n    'STMemoryBooks_Status': 'Status',\r\n    'STMemoryBooks_StatusPrompt': \"Analyze all context (previous scenes, memories, lore, history, interactions) to generate a detailed analysis of {{user}} and {{char}} (including abbreviated !lovefactor and !lustfactor commands). Note: If there is a pre-existing !status report, update it, do not regurgitate it.\",\r\n    'STMemoryBooks_CastOfCharacters': 'Cast of Characters',\r\n    'STMemoryBooks_CastOfCharactersPrompt': \"You are a skilled reporter with a clear eye for judging the importance of NPCs to the plot. \\nStep 1: Review the scene and either add or update plot-related NPCs to the NPC WHO'S WHO report. Please note that {{char}} and {{user}} are major characters and do NOT need to be included in this report.\\nStep 2: This list should be kept in order of importance to the plot, so it may need to be reordered.\\nStep 3: If your response would be more than 2000 tokens long, remove NPCs with the least impact to the plot.\",\r\n    'STMemoryBooks_Assess': 'Assess',\r\n    'STMemoryBooks_AssessPrompt': \"Assess the interaction between {{char}} and {{user}} to date. List all the information {{char}} has learned about {{user}} in a code block through observation, questioning, or drawing conclusions from interaction (similar to a mental \\\"note to self\\\"). If there is already a list, update it. Try to keep it token-efficient and compact, focused on the important things.\",\r\n    'STMemoryBooks_PlotpointsResponseFormat': \"=== Plot Points ===\\n(as of [point in the story when this analysis was done])\\n\\n[Overarching Plot Arc]\\n(2-3 sentence summary of the superobjective or major plot)\\n\\n[Thread #1 Title]\\n- Summary: (1 sentence)\\n- Status: (active / on hold)\\n- At Stake: (how resolution will affect the ongoing story)\\n- Last Known: (location or time)\\n- Key Characters: ...\\n\\n\\n[Thread #2 Title]\\n- Summary: (1 sentence)\\n- Status: (active / on hold)\\n- At Stake: (how resolution will affect the ongoing story)\\n- Last Known: (location or time)\\n- Key Characters: ...\\n\\n...\\n\\n-- Plot Hooks --\\n- (new or potential plot hooks)\\n\\n-- Character Dynamics --\\n- current status of {{user}}'s/{{char}}'s relationships with NPCs\\n\\n===End Plot Points===\\n\",\r\n    'STMemoryBooks_StatusResponseFormat': \"Follow this general format:\\n\\n## Witty Headline or Summary\\n\\n### AFFINITY (0-100, have some relationship with !lovefactor and !lustfactor)\\n- Score with evidence\\n- Recent changes \\n- Supporting quotes\\n- Anything else that might be illustrative of the current affinity\\n\\n### LOVEFACTOR and LUSTFACTOR\\n(!lovefactor and !lustfactor reports go here)\\n\\n### RELATIONSHIP STATUS (negative = enemies, 0 = strangers, 100 = life partners)\\n- Trust/boundaries/communication\\n- Key events\\n- Issues\\n- Any other pertinent points\\n\\n### GOALS\\n- Short/long-term objectives\\n- Progress/obstacles\\n- Growth areas\\n- Any other pertinent points\\n\\n### ANALYSIS\\n- Psychology/POV\\n- Development/triggers\\n- Story suggestions\\n- Any other pertinent points\\n\\n### WRAP-UP\\n- OOC Summary (1 paragraph)\",\r\n    'STMemoryBooks_CastOfCharactersResponseFormat': \"===NPC WHO'S WHO===\\n(In order of importance to the plot)\\n\\nPerson 1: 1-2 sentence desription\\nPerson 2: 1-2 sentence desription\\n===END NPC WHO'S WHO===\",\r\n    'STMemoryBooks_AssessResponseFormat': \"Use this format: \\n=== Things {{char}} has learned about {{user}} ===\\n(detailed list, in {{char}}'s POV/tone of voice)\\n===\",\r\n    'STMemoryBooks_FailedToSaveSidePrompts': 'Failed to save side prompts: {{status}} {{statusText}}',\r\n    'STMemoryBooks_SidePromptsSaved': 'Side prompts saved successfully',\r\n    'STMemoryBooks_MigratingSidePrompts': 'Migrating side prompts file from V1(type) to V2(triggers)',\r\n    'STMemoryBooks_InvalidSidePromptsFile': 'Invalid side prompts file structure; recreating with built-ins',\r\n    'STMemoryBooks_ErrorLoadingSidePrompts': 'Error loading side prompts; creating base doc',\r\n    'STMemoryBooks_UntitledSidePrompt': 'Untitled Side Prompt',\r\n    'STMemoryBooks_TemplateNotFound': 'Template \"{{key}}\" not found',\r\n    'STMemoryBooks_CopyOfTemplate': '{{name}} (Copy)',\r\n    'STMemoryBooks_InvalidSidePromptsJSON': 'Invalid side prompts file structure',\r\n\t'STMemoryBooks_ConverterTitle': 'STMemoryBooks Lorebook Converter (v3)',\r\n    'STMemoryBooks_ConverterHeader': 'Lorebook Converter',\r\n    'STMemoryBooks_ConverterDescription': 'This tool flags entries by adding `stmemorybooks: true`. An entry is converted only if it matches the title format, is <strong>not</strong> set to `\"vectorized\": false`, and has its `\"position\"` set to `0`.',\r\n    'STMemoryBooks_ConverterSampleTitleLabel': 'Sample Title Format (Optional)',\r\n    'STMemoryBooks_ConverterSampleTitlePlaceholder': 'e.g., 01 - My First Memory',\r\n    'STMemoryBooks_ConverterSampleTitleDescription': 'The tool will find the first number and use it to create a pattern. If blank, it defaults to matching titles like \"01 - title\".',\r\n    'STMemoryBooks_ConverterFileUploadLabel': 'Click or Drag to Upload Lorebook File',\r\n    'STMemoryBooks_ConverterIncludeVectorizedLabel': 'Include  entries',\r\n    'STMemoryBooks_ConverterIncludeVectorizedDescription': 'If enabled, entries with `vectorized: false` will also be included as memories.',\r\n    'STMemoryBooks_ConverterConvertButton': 'Convert File',\r\n    'STMemoryBooks_ConverterConversionComplete': 'Conversion complete!',\r\n    'STMemoryBooks_ConverterDownloadLink': 'Download {{filename}}',\r\n    'STMemoryBooks_ConverterErrorProcessingFile': 'Error processing file. Please ensure it is a valid JSON lorebook. Error: {{message}}',\r\n    'STMemoryBooks_ConverterInvalidLorebookStructure': \"Invalid lorebook structure: 'entries' object not found.\",\r\n    'STMemoryBooks_ConverterUsingDefaultRegex': 'Using default: {{regex}}',\r\n    'STMemoryBooks_ConverterConversionStats': 'Conversion complete. Checked {{totalEntries}} entries and flagged {{memoriesConverted}} as memories.',\r\n\r\n    // AddLore (addlore.js)\r\n    'addlore.errors.invalidContent': 'Invalid memory result: missing content',\r\n    'addlore.errors.invalidLorebookValidation': 'Invalid lorebook validation data',\r\n    'addlore.errors.createEntryFailed': 'Failed to create new lorebook entry',\r\n    'addlore.toast.added': 'Memory \"{{entryTitle}}\" added to \"{{lorebookName}}\"',\r\n    'addlore.toast.addFailed': 'Failed to add memory: {{message}}',\r\n    'addlore.toast.autohideInvalidRange': 'Auto-hide skipped: invalid scene range metadata',\r\n    'addlore.toast.orderClamped': 'Order range is limited to 09999. Current {{source}} is {{requested}}; clamped to {{clamped}}.',\r\n    'addlore.toast.title': 'STMemoryBooks',\r\n    'addlore.result.added': 'Memory successfully added to \"{{lorebookName}}\"',\r\n    'addlore.result.addFailed': 'Failed to add memory to lorebook: {{message}}',\r\n    'addlore.defaults.title': 'Memory',\r\n    'addlore.defaults.scene': 'Scene {{range}}',\r\n    'addlore.defaults.user': 'User',\r\n    'addlore.sanitize.fallback': 'Auto Memory',\r\n    'addlore.preview.error': 'Error: {{message}}',\r\n    'addlore.preview.sampleTitle': 'Sample Memory Title',\r\n    'addlore.preview.sampleProfile': 'Summary',\r\n    'addlore.stats.errors.noBinding': 'No lorebook bound to chat',\r\n    'addlore.stats.errors.loadFailed': 'Failed to load lorebook',\r\n    'addlore.titleFormat.errors.nonEmpty': 'Title format must be a non-empty string',\r\n    'addlore.titleFormat.warnings.sanitization': 'Title contains characters that will be removed during sanitization',\r\n    'addlore.titleFormat.warnings.unknownPlaceholders': 'Unknown placeholders: {{placeholders}}',\r\n    'addlore.titleFormat.warnings.invalidNumbering': 'Invalid numbering patterns: {{patterns}}. Use [0], [00], [000], (0), {0}, #0 etc.',\r\n    'addlore.titleFormat.warnings.tooLong': 'Title format is very long and may be truncated',\r\n    'addlore.upsert.errors.invalidArgs': 'Invalid arguments to upsertLorebookEntryByTitle',\r\n    'addlore.upsert.errors.createFailed': 'Failed to create lorebook entry',\r\n    'addlore.titleFormats.0': '[000] - {{title}} ({{profile}})',\r\n    'addlore.titleFormats.1': '{{date}} [000] {{title}}, {{messages}} msgs',\r\n    'addlore.titleFormats.2': '[000] {{date}} - {{char}} Memory',\r\n    'addlore.titleFormats.3': '[00] - {{user}} & {{char}} {{scene}}',\r\n    'addlore.titleFormats.4': ' [000] ({{messages}} msgs)',\r\n    'addlore.titleFormats.5': ' Memory #[000] - {{profile}} {{date}} {{time}}',\r\n    'addlore.titleFormats.6': '[000] - {{scene}}: {{title}}',\r\n    'addlore.titleFormats.7': '[000] - {{title}} ({{scene}})',\r\n    'addlore.titleFormats.8': '[000] - {{title}}',\r\n    'addlore.log.executingHideCommand': 'STMemoryBooks-AddLore: Executing hide command{{context}}: {{hideCommand}}',\r\n    'addlore.warn.autohideSkippedInvalidRange': 'STMemoryBooks-AddLore: Auto-hide skipped - invalid scene range: \"{{range}}\"',\r\n    'addlore.hideCommand.allComplete': 'all mode - complete',\r\n    'addlore.hideCommand.allPartial': 'all mode - partial',\r\n    'addlore.hideCommand.lastHideAll': 'last mode - hide all',\r\n    'addlore.hideCommand.lastPartial': 'last mode - partial',\r\n    'addlore.log.addFailed': 'STMemoryBooks-AddLore: Failed to add memory to lorebook:',\r\n    'addlore.log.getStatsError': 'STMemoryBooks-AddLore: Error getting lorebook stats:',\r\n    'addlore.log.updateHighestCalled': 'STMemoryBooks-AddLore: updateHighestMemoryProcessed called with:',\r\n    'addlore.log.sceneRangeExtracted': 'STMemoryBooks-AddLore: sceneRange extracted:',\r\n    'addlore.warn.noSceneRange': 'STMemoryBooks-AddLore: No scene range found in memory result, cannot update highest processed',\r\n    'addlore.warn.invalidSceneRangeFormat': 'STMemoryBooks-AddLore: Invalid scene range format: {{range}}',\r\n    'addlore.warn.invalidEndMessage': 'STMemoryBooks-AddLore: Invalid end message number: {{end}}',\r\n    'addlore.warn.noSceneMarkers': 'STMemoryBooks-AddLore: Could not get scene markers to update highest processed',\r\n    'addlore.log.setHighest': 'STMemoryBooks-AddLore: Set highest memory processed to message {{endMessage}}',\r\n    'addlore.log.updateHighestError': 'STMemoryBooks-AddLore: Error updating highest memory processed:',\r\n    'autocreate.log.creating': 'STMemoryBooks-AutoCreate: Auto-creating lorebook \"{{name}}\" for {{context}}',\r\n    'autocreate.log.created': 'STMemoryBooks-AutoCreate: Successfully created and bound lorebook \"{{name}}\"',\r\n    'autocreate.log.createFailed': 'STMemoryBooks-AutoCreate: Failed to create lorebook',\r\n    'autocreate.log.createError': 'STMemoryBooks-AutoCreate: Error creating lorebook:',\r\n    'autosummary.log.postponed': 'STMemoryBooks: Auto-summary postponed for {{count}} messages (until message {{until}})',\r\n    'autosummary.log.skippedInProgress': 'STMemoryBooks: Auto-summary skipped - memory creation in progress',\r\n    'autosummary.log.noPrevious': 'STMemoryBooks: No previous memories found - counting from start',\r\n    'autosummary.log.sinceLast': 'STMemoryBooks: Messages since last memory ({{highestProcessed}}): {{count}}',\r\n    'autosummary.log.triggerCheck': 'STMemoryBooks: Auto-summary trigger check: {{count}} >= {{required}}?',\r\n    'autosummary.log.notTriggered': 'STMemoryBooks: Auto-summary not triggered - need {{needed}} more messages',\r\n    'autosummary.log.postponedUntil': 'STMemoryBooks: Auto-summary postponed until message {{until}}',\r\n    'autosummary.log.blocked': 'STMemoryBooks: Auto-summary blocked - lorebook validation failed: {{error}}',\r\n    'autosummary.log.clearedPostpone': 'STMemoryBooks: Cleared auto-summary postpone flag',\r\n    'autosummary.log.triggered': 'STMemoryBooks: Auto-summary triggered - creating memory for range {{start}}-{{end}}',\r\n    'autosummary.log.triggerError': 'STMemoryBooks: Error in auto-summary trigger check:',\r\n    'autosummary.log.messageReceivedSingle': 'STMemoryBooks: Message received (single chat) - auto-summary enabled, current count: {{count}}',\r\n    'autosummary.log.messageReceivedGroup': 'STMemoryBooks: Message received in group chat - deferring to GROUP_WRAPPER_FINISHED',\r\n    'autosummary.log.messageHandlerError': 'STMemoryBooks: Error in auto-summary message received handler:',\r\n    'autosummary.log.groupFinished': 'STMemoryBooks: Group conversation finished - auto-summary enabled, current count: {{count}}',\r\n    'autosummary.log.groupHandlerError': 'STMemoryBooks: Error in auto-summary group finished handler:',\r\n    'autocreate.toast.title': 'STMemoryBooks',\r\n    'autocreate.toast.createdBound': 'Created and bound lorebook \"{{name}}\"',\r\n    'autocreate.errors.failedAutoCreate': 'Failed to auto-create lorebook.',\r\n    'autocreate.errors.failedAutoCreateWithMessage': 'Failed to auto-create lorebook: {{message}}',\r\n    'common.unknown': 'Unknown',\r\n    \r\n    // Arcs\r\n    'STMemoryBooks_ArcPromptManager': 'Arc Prompt Manager',\r\n    'STMemoryBooks_Arc_RebuildBuiltins': 'Rebuild from built-ins',\r\n    'STMemoryBooks_Arc_MaxPerPass': 'Maximum number of memories to process in each pass',\r\n    'STMemoryBooks_Arc_MaxPasses': 'Number of automatic arc attempts',\n    'STMemoryBooks_Arc_MinAssigned': 'Minimum number of memories in each arc',\n    'STMemoryBooks_Arc_TokenBudget': 'Token Budget',\n    'STMemoryBooks_Arc_Order_Label': 'Arc entry order',\n    'STMemoryBooks_Arc_Order_Help': \"Controls the lorebook 'order' for newly created arcs only.\",\n    'STMemoryBooks_Arc_AutoOrder': 'Auto (uses arc #)',\n    'STMemoryBooks_Arc_RebuildTitle': 'Rebuild Arc Prompts from Built-ins',\n    'STMemoryBooks_Arc_RebuildWarning': 'This will overwrite your saved Arc prompt presets with the built-ins. A timestamped backup will be created.',\n    'STMemoryBooks_Arc_RebuildNote': 'After rebuild, the preset list will refresh automatically.',\n    'STMemoryBooks_ConsolidateArcs_DisableOriginals': 'Disable originals after creating arcs',\r\n    'STMemoryBooks_ConsolidateArcs_Tip': 'Tip: uncheck memories that should not be included.',\r\n    'STMemoryBooks_ArcAnalysis_EmptyResponse': 'Empty AI response',\r\n    'STMemoryBooks_ArcAnalysis_InvalidJSON': 'Model did not return valid arc JSON',\r\n    'STMemoryBooks_ArcAnalysis_MissingLorebookData': 'Missing lorebookName or lorebookData',\r\n    'STMemoryBooks_ArcAnalysis_UpsertFailed': 'Arc upsert returned no entry (commitArcs failed)',\r\n    'STMemoryBooks_ArcPromptManager_SaveFailed': 'Failed to save arc prompts',\r\n\r\n    // Arc Prompts\r\n    // Default Arc Prompt\r\n    'STMemoryBooks_ArcPrompt_Default':`You are an expert narrative analyst and memory-engine assistant.\r\nYour task is to take multiple scene summaries (of varying detail and formatting), normalize them, reconstruct the full chronology, identify self-contained story arcs, and output each arc as a single memory entry in JSON.\r\n\r\nEach arc must be token-efficient, plot-accurate, and compatible with long-running RP memory systems such as STMB.\r\n\r\nYou will receive input in this exact format:\r\n- An optional PREVIOUS ARC block, which is canon and must not be rewritten.\r\n- A MEMORIES block containing entries formatted as:\r\n  [ID] | ORDER\r\n  Full text of the memory (may span multiple paragraphs)\r\n\r\nStrict output format (JSON only; no markdown, no prose outside JSON):\r\n{\r\n  \"arcs\": [\r\n    {\r\n      \"title\": \"Short descriptive arc title (36 words)\",\r\n      \"summary\": \"Structured arc summary as a single string (see Summary Content Structure below).\",\r\n      \"keywords\": [\"keyword1\", \"keyword2\", \"...\"],\r\n      \"member_ids\": [\"<ID from MEMORIES>\", \"...\"]  // optional: IDs of memories that belong to this arc\r\n    }\r\n  ],\r\n  \"unassigned_memories\": [\r\n    { \"id\": \"memory-id\", \"reason\": \"Brief explanation of why this memory does not fit the produced arcs.\" }\r\n  ]\r\n}\r\n\r\nArc count rule:\r\n- Do not force a number of arcs. Produce the smallest coherent number of arcs based on content (often 13, possibly 1 if all memories form one arc).\r\n- Respect chronology using ORDER (ascending).\r\n- If some memories do not fit the produced arcs, place them in unassigned_memories with a short reason.\r\n\r\nDo not repeat text from PREVIOUS ARC. Treat it as canon; continue consequences only if relevant in the new memories.\r\n\r\nPROCESS\r\n\r\nSTEP 1  UNIFIED STORY (internal only)\r\n- Combine ALL memories into a single chronological retelling.\r\n- Ignore OOC/meta content.\r\n- Preserve plot-relevant events, character choices, emotional shifts, decisions, consequences, conflicts, promises, boundary negotiations.\r\n- Exclude flavor-only content unless it affects future behavior.\r\n- Normalize to past-tense, third-person.\r\n- Focus on cause  intention  reaction  consequence chains.\r\n- Do NOT output this unified story.\r\n\r\nSTEP 2  IDENTIFY STORY ARCS\r\n- From the unified story, extract arcs that begin when a meaningful shift occurs in:\r\n  relationship dynamics; emotional vulnerability; intimacy or distance; conflict/reconciliation; routine/ritual changes; boundaries/negotiations; logistical shifts (travel, location, communication); any event with lasting consequences.\r\n- Ensure each arc is self-contained and represents a significant movement.\r\n\r\nSTEP 3  ARC OBJECTS (fill arcs[] in JSON)\r\nFor each arc, fill fields as follows:\r\n\r\ntitle:\r\n- 36 words, descriptive of the arcs core.\r\n\r\nsummary:\r\n- The entire Summary Content Structure below must appear inside this single string (use headings and bullets as plain text).\r\n- Keep total length 515% of the combined text for the arcs memories.\r\n- Do not include OOC/meta or filler.\r\n\r\nSummary Content Structure (must be followed inside summary string):\r\n\r\n# [Arc Title]\r\nTime period: What timeframe the arc covers (e.g. \"March 310, 2024\", \"Week of July 15, 2023\")\r\n\r\nArc Premise: One sentence describing what this arc is about.\r\n\r\n## Major Beats\r\n- 37 bullets capturing the major plot movements of this arc\r\n- Focus on cause  effect logic\r\n- Include only plot-affecting events\r\n\r\n## Character Dynamics\r\n- 12 paragraphs describing how the characters emotions, motives, boundaries, or relationship changed\r\n- Include subtext, tension shifts, power exchange changes, new trust/vulnerabilities, or new conflicts\r\n- Include silent implications if relevant\r\n\r\n## Key Exchanges\r\n- Up to 8 short, exact quotes\r\n- Only include dialogue that materially shifted tone, emotion, or relationship dynamics\r\n\r\n## Outcome & Continuity\r\n- 48 bullets capturing:\r\n  - decisions\r\n  - promises\r\n  - new emotional states\r\n  - new routines/rituals\r\n  - injuries or physical changes\r\n  - foreshadowed future events\r\n  - unresolved threads\r\n  - permanent consequences\r\n\r\nSTEP 4  KEYWORDS\r\n- Provide 1530 standalone retrieval keywords in keywords[] per arc.\r\n\r\nMUST:\r\n- Concrete nouns, physical objects, places, proper nouns, distinctive actions, or memorable scene elements\r\n- Each keyword = ONE concept only\r\n- Each keyword must be retrievable if mentioned ALONE\r\n- Use ONLY nouns or noun-phrases\r\n\r\nMUST NOT:\r\n- No narrative/summary keywords (start of affair, argument resolved)\r\n- No emotional/abstract words (intimacy, vulnerability, trust, jealousy, dominance, submission, aftercare, connection, longing, etc.)\r\n- No multi-fact keywords (Denver airport Lyft ride and call)\r\n- No themes or vibes\r\n\r\nExamples of valid keywords:\r\n- Four Seasons bar\r\n- Macallan 25\r\n- private elevator\r\n- Aston Martin\r\n- CPAP machine\r\n- Gramercy Tavern\r\n- yuzu soda\r\n- satellite map\r\n- Life360 app\r\n- marble desk\r\n- pack for forever\r\n- dick-measuring contest\r\n\r\nClassification of non-fitting memories:\r\n- If a memory obviously belongs to a later arc, is unrelated, flavor-only with no continuity impact, duplicates, or conflicts with PREVIOUS ARC chronology, put it in unassigned_memories with a short reason.\r\n\r\nJSON-only:\r\n- Return only the JSON object described above.\r\n- No markdown fences, no commentary, no system prompts, no extra text.`,\r\n\r\n    // Alternate Arc Prompt\r\n    'STMemoryBooks_ArcPrompt_Alternate':`You are an expert narrative analyst and memory-engine assistant.\r\nYour task is to take multiple scene summaries (of varying detail and formatting), normalize them, reconstruct the full chronology, and output a single memory arc entry in JSON. The arc must be token-efficient and plot-accurate.\r\n\r\nYou will receive input in this exact format:\r\n- An optional PREVIOUS ARC block, which is canon and must not be rewritten.\r\n- A MEMORIES block containing entries formatted as:\r\n  [ID] | ORDER\r\n  Full text of the memory (may span multiple paragraphs)\r\n\r\nStrict output format (JSON only; no markdown, no prose outside JSON):\r\n{\r\n  \"arcs\": [\r\n    {\r\n      \"title\": \"Short descriptive arc title (36 words)\",\r\n      \"summary\": \"Structured arc summary as a single string (see Summary Content Structure below).\",\r\n      \"keywords\": [\"keyword1\", \"keyword2\", \"...\"],\r\n      \"member_ids\": [\"<ID from MEMORIES>\", \"...\"]  // optional: IDs of memories that belong to this arc\r\n    }\r\n  ],\r\n  \"unassigned_memories\": [\r\n    { \"id\": \"memory-id\", \"reason\": \"Brief explanation of why this memory does not fit the produced arcs.\" }\r\n  ]\r\n}\r\n\r\nNotes:\r\n- Respect chronology using ORDER (ascending).\r\n- If some memories do not fit the arc, place them in unassigned_memories with a short reason.\r\n\r\nDo not repeat text from PREVIOUS ARC. Treat it as canon; continue consequences only if relevant in the new memories.\r\n\r\nPROCESS\r\n\r\nSTEP 1  UNIFIED STORY (internal only)\r\n- Combine ALL memories into a single chronological retelling.\r\n- Ignore OOC/meta content.\r\n- Preserve plot-relevant events, character choices, emotional shifts, decisions, consequences, conflicts, promises, boundary negotiations.\r\n- Exclude flavor-only content unless it affects future behavior.\r\n- Normalize to past-tense, third-person.\r\n- Focus on cause  intention  reaction  consequence chains.\r\n- Do NOT output this unified story.\r\n\r\nSTEP 2  IDENTIFY STORY ARCS\r\n- From the unified story, identify a self-contained arc that represents a significant narrative movement.\r\n\r\nSTEP 3  ARC OBJECTS (fill arcs[] in JSON)\r\nFor the story arc, fill fields as follows:\r\n\r\ntitle:\r\n- 36 words, descriptive of the arcs core.\r\n\r\nsummary:\r\n- The entire \"Summary Content Structure\" below must appear inside this single string (use headings and bullets as plain text).\r\n- Keep total length 515% of the combined text for the arcs memories.\r\n- Do not include OOC/meta or filler.\r\n\r\nSummary Content Structure (must be followed inside summary string):\r\n\r\n# [Arc Title]\r\nTime period: What timeframe the arc covers (e.g. \"March 310, 2024\", \"Week of July 15, 2023\")\r\n\r\nArc Premise: One sentence describing what this arc is about.\r\n\r\n## Major Beats\r\n- 37 bullets capturing the major plot movements of this arc\r\n- Focus on cause  effect logic\r\n- Include only plot-affecting events\r\n\r\n## Character Dynamics\r\n- 12 paragraphs describing how the characters emotions, motives, boundaries, or relationship changed\r\n- Include subtext, tension shifts, power exchange changes, new trust/vulnerabilities, or new conflicts\r\n- Include silent implications if relevant\r\n\r\n## Key Exchanges\r\n- Up to 8 short, exact quotes\r\n- Only include dialogue that materially shifted tone, emotion, or relationship dynamics\r\n\r\n## Outcome & Continuity\r\n- 48 bullets capturing:\r\n  - decisions\r\n  - promises\r\n  - new emotional states\r\n  - new routines/rituals\r\n  - injuries or physical changes\r\n  - foreshadowed future events\r\n  - unresolved threads\r\n  - permanent consequences\r\n\r\nSTEP 4  KEYWORDS\r\n- Provide 1530 standalone retrieval keywords in keywords[] per arc.\r\n\r\nMUST:\r\n- Concrete nouns, physical objects, places, proper nouns, distinctive actions, or memorable scene elements\r\n- Each keyword = ONE concept only\r\n- Each keyword must be retrievable if mentioned ALONE\r\n- Use ONLY nouns or noun-phrases\r\n\r\nMUST NOT:\r\n- No narrative/summary keywords (start of affair, argument resolved)\r\n- No emotional/abstract words (intimacy, vulnerability, trust, jealousy, dominance, submission, aftercare, connection, longing, etc.)\r\n- No multi-fact keywords (Denver airport Lyft ride and call)\r\n- No themes or vibes\r\n\r\nExamples of valid keywords:\r\n- Four Seasons bar\r\n- Macallan 25\r\n- private elevator\r\n- Aston Martin\r\n- CPAP machine\r\n- Gramercy Tavern\r\n- yuzu soda\r\n- satellite map\r\n- Life360 app\r\n- marble desk\r\n- pack for forever\r\n- dick-measuring contest\r\n\r\nClassification of non-fitting memories:\r\n- If a memory obviously belongs to a later arc, is unrelated, flavor-only with no continuity impact, duplicates, or conflicts with PREVIOUS ARC chronology, put it in unassigned_memories with a short reason.\r\n\r\nJSON-only:\r\n- Return only the JSON object described above.\r\n- No markdown fences, no commentary, no system prompts, no extra text.`,\r\n\r\n    // Tiny Arc Prompt\r\n    'STMemoryBooks_ArcPrompt_Tiny': `You specialize in compressing many small memories into compact, coherent story arcs. Combine the memories below  and the previous arc if provided  into a single arc that captures the main narrative through-lines.\r\n\r\nReturn JSON only:\r\n{ \"arcs\": [ { \"title\": \"...\", \"summary\": \"...\", \"keywords\": [\"...\"], \"member_ids\": [\"<ID>\", \"...\"] } ], \"unassigned_memories\": [ { \"id\": \"...\", \"reason\": \"...\" } ] }\r\n\r\nRules:\r\n- 515% length compression\r\n- Focus on plot, emotional progression, decisions, conflicts, continuity\r\n- Identify non-fitting items in unassigned_memories with a brief reason\r\n- No quotes, no OOC, no commentary outside JSON`,\r\n\r\n    // Chat Compile\r\n    'chatcompile.errors.sceneMarkersRequired': 'Scene markers are required for compilation',\r\n    'chatcompile.errors.startGreaterThanEnd': 'Start marker cannot be greater than end marker',\r\n    'chatcompile.errors.outOfBounds': 'Scene markers ({{start}}-{{end}}) are out of chat bounds (0-{{max}})',\r\n    'chatcompile.errors.noVisibleInRange': 'No visible messages found in range {{start}}-{{end}}. All messages may be hidden or missing.',\r\n\r\n    'chatcompile.validation.errors.missingMetadata': 'Missing metadata object',\r\n    'chatcompile.validation.errors.invalidMessagesArray': 'Missing or invalid messages array',\r\n    'chatcompile.validation.warnings.noMessages': 'No messages in compiled scene',\r\n    'chatcompile.validation.warnings.messageMissingId': 'Message at index {{index}} missing ID',\r\n    'chatcompile.validation.warnings.messageMissingName': 'Message at index {{index}} missing speaker name',\r\n    'chatcompile.validation.warnings.messageMissingContent': 'Message at index {{index}} missing content',\r\n    'chatcompile.validation.warnings.veryLargeScene': 'Very large scene (>100 messages) - consider breaking into smaller segments',\r\n\r\n    'chatcompile.readable.headerMetadata': '=== SCENE METADATA ===',\r\n    'chatcompile.readable.range': 'Range: Messages {{start}}-{{end}}',\r\n    'chatcompile.readable.chat': 'Chat: {{chatId}}',\r\n    'chatcompile.readable.character': 'Character: {{name}}',\r\n    'chatcompile.readable.compiled': 'Compiled: {{count}} messages',\r\n    'chatcompile.readable.compiledAt': 'Compiled at: {{date}}',\r\n    'chatcompile.readable.headerMessages': '=== SCENE MESSAGES ===',\r\n    'chatcompile.readable.line': '[{{id}}] {{name}}: {{text}}',\r\n\r\n    'chatcompile.defaults.user': 'User',\r\n\r\n    'confirmationPopup.toast.title': 'STMemoryBooks',\r\n    'confirmationPopup.log.saveFailed': 'STMemoryBooks-ConfirmationPopup: Failed to save profile:',\r\n    'confirmationPopup.log.saveCancelledNoName': 'STMemoryBooks-ConfirmationPopup: Profile creation cancelled - no name provided',\r\n    'confirmationPopup.log.validationFailedEmptyName': 'STMemoryBooks-ConfirmationPopup: Profile name validation failed - empty name',\r\n    'confirmationPopup.log.invalidMemoryResult': 'STMemoryBooks-ConfirmationPopup: Invalid memoryResult passed to showMemoryPreviewPopup',\r\n    'confirmationPopup.log.invalidSceneData': 'STMemoryBooks-ConfirmationPopup: Invalid sceneData passed to showMemoryPreviewPopup',\r\n    'confirmationPopup.log.invalidProfileSettings': 'STMemoryBooks-ConfirmationPopup: Invalid profileSettings passed to showMemoryPreviewPopup',\r\n    'confirmationPopup.log.sceneDataMissingProps': 'STMemoryBooks-ConfirmationPopup: sceneData missing required numeric properties',\r\n    'confirmationPopup.log.popupNotAvailable': 'STMemoryBooks-ConfirmationPopup: Popup element not available for reading edited values',\r\n    'confirmationPopup.log.inputsNotFound': 'STMemoryBooks-ConfirmationPopup: Required input elements not found in popup',\r\n    'confirmationPopup.log.titleValidationFailed': 'STMemoryBooks-ConfirmationPopup: Memory title validation failed - empty title',\r\n    'confirmationPopup.log.contentValidationFailed': 'STMemoryBooks-ConfirmationPopup: Memory content validation failed - empty content',\r\n    'confirmationPopup.log.previewError': 'STMemoryBooks-ConfirmationPopup: Error showing memory preview popup:',\r\n\r\n    'index.warn.getEffectivePromptAsync': 'STMemoryBooks: getEffectivePromptAsync fallback due to error:',\r\n    'index.error.chatContainerNotFound': 'STMemoryBooks: Chat container not found. SillyTavern DOM structure may have changed.',\r\n    'index.error.processingChatElements': 'STMemoryBooks: Error processing new chat elements:',\r\n    'index.error.updatingButtonStates': 'STMemoryBooks: Error updating button states:',\r\n    'index.log.chatObserverInitialized': 'STMemoryBooks: Chat observer initialized',\r\n    'index.log.chatObserverDisconnected': 'STMemoryBooks: Chat observer disconnected',\r\n    'index.log.chatChanged': 'STMemoryBooks: Chat changed - updating scene state',\r\n    'index.error.processingMessagesAfterChange': 'STMemoryBooks: Error processing messages after chat change:',\r\n    'index.log.foundOrphanedMarkers': 'STMemoryBooks: Found orphaned scene markers on chat load (start: {{start}}, end: {{end}})',\r\n    'index.error.handleMessageReceived': 'STMemoryBooks: Error in handleMessageReceived:',\r\n    'index.error.handleGroupWrapperFinished': 'STMemoryBooks: Error in handleGroupWrapperFinished:',\r\n    'index.error.noSceneMarkersForCreate': 'STMemoryBooks: No scene markers set for createMemory command',\r\n    'index.toast.title': 'STMemoryBooks',\r\n    'index.error.nextMemoryFailed': 'STMemoryBooks: /nextmemory failed:',\r\n    'index.warn.sidePromptCacheRefreshFailed': 'STMemoryBooks: side prompt cache refresh failed',\r\n    'index.log.addedDynamicProfile': 'STMemoryBooks: Added dynamic profile for existing installation (migration to v3)',\r\n    'index.log.removedStaticTitleFormat': 'STMemoryBooks: Removed static titleFormat from dynamic profile',\r\n    'index.log.createdDynamicProfile': 'STMemoryBooks: Created dynamic profile for fresh installation',\r\n    'index.log.appliedProfileFixes': 'STMemoryBooks: Applied profile fixes:',\r\n    'index.warn.mutualExclusion': 'STMemoryBooks: Both manualModeEnabled and autoCreateLorebook were true - setting autoCreateLorebook to false',\r\n    'index.log.migratingV2': 'STMemoryBooks: Migrating to JSON-based architecture (v2)',\r\n    'index.log.updatingProfileToJSON': 'STMemoryBooks: Updating profile \"{{name}}\" to use JSON output',\r\n\r\n    // Slash Commands\r\n    'STMemoryBooks_Slash_CreateMemory_Help': 'Create memory from marked scene',\r\n    'STMemoryBooks_Slash_SceneMemory_Help': 'Set scene range and create memory (e.g., /scenememory 10-15)',\r\n    'STMemoryBooks_Slash_SceneMemory_ArgRangeDesc': 'Message range (X-Y format)',\r\n    'STMemoryBooks_Slash_NextMemory_Help': 'Create memory from end of last memory to current message',\r\n    'STMemoryBooks_Slash_SidePrompt_Help': 'Run side prompt (no args opens picker). Usage: /sideprompt \"Name\" [X-Y]',\r\n    'STMemoryBooks_Slash_SidePrompt_ArgDesc': 'Template name (quote if contains spaces), optionally followed by X-Y range',\r\n    'STMemoryBooks_Slash_SidePromptOn_Help': 'Enable a Side Prompt by name or all. Usage: /sideprompt-on \"Name\" | all',\r\n    'STMemoryBooks_Slash_SidePromptOn_ArgDesc': 'Template name (quote if contains spaces) or \"all\"',\r\n    'STMemoryBooks_Slash_SidePromptOff_Help': 'Disable a Side Prompt by name or all. Usage: /sideprompt-off \"Name\" | all',\r\n    'STMemoryBooks_Slash_SidePromptOff_ArgDesc': 'Template name (quote if contains spaces) or \"all\"',\r\n    'STMemoryBooks_SidePromptToggle_MissingName': 'Missing name. Usage: /sideprompt-on \"Name\" | /sideprompt-off \"Name\" | all',\r\n\r\n    // Built-in prompt templates (English fallback; localize in locales/*.json)\r\n    'STMemoryBooks_Prompt_summary': `You are a talented summarist skilled at capturing scenes from stories comprehensively. Analyze the following roleplay scene and return a detailed memory as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short scene title (1-3 words)\",\r\n  \"content\": \"Detailed beat-by-beat summary in narrative prose...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, create a detailed beat-by-beat summary in narrative prose. First, note the dates/time. Then capture this scene accurately without losing ANY important information EXCEPT FOR [OOC] conversation/interaction. All [OOC] conversation/interaction is not useful for summaries.\r\nThis summary will go in a vectorized database, so include:\r\n- All important story beats/events that happened\r\n- Key interaction highlights and character developments\r\n- Notable details, memorable quotes, and revelations\r\n- Outcome and anything else important for future interactions between {{user}} and {{char}}\r\nCapture ALL nuance without repeating verbatim. Make it comprehensive yet digestible.\r\n\r\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords for vectorized database retrieval. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    'STMemoryBooks_Prompt_summarize': `Analyze the following roleplay scene and return a structured summary as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short scene title (1-3 words)\",\r\n  \"content\": \"Detailed summary with markdown headers...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, create a detailed bullet-point summary using markdown with these headers (but skip and ignore all OOC conversation/interaction):\r\n- **Timeline**: Day/time this scene covers.\r\n- **Story Beats**: List all important plot events and story developments that occurred.\r\n- **Key Interactions**: Describe the important character interactions, dialogue highlights, and relationship developments.\r\n- **Notable Details**: Mention any important objects, settings, revelations, or details that might be relevant for future interactions.\r\n- **Outcome**: Summarize the result, resolution, or state of affairs at the end of the scene.\r\n\r\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords that would help a vectorized database find this conversation again if something is mentioned. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nEnsure you capture ALL important information - comprehensive detail is more important than brevity.\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    'STMemoryBooks_Prompt_synopsis': `Analyze the following roleplay scene and return a comprehensive synopsis as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short scene title (1-3 words)\",\r\n  \"content\": \"Long detailed synopsis with markdown structure...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, create a long and detailed beat-by-beat summary using markdown structure. Capture the most recent scene accurately without losing ANY information. [OOC] conversation/interaction is not useful for summaries and should be ignored and excluded. Use this structure:\r\n# [Scene Title]\r\n**Timeline**: (day/time)\r\n## Story Beats\r\n- (List all important plot events and developments)\r\n## Key Interactions\r\n- (Detail all significant character interactions and dialogue)\r\n## Notable Details\r\n- (Include memorable quotes, revelations, objects, settings)\r\n## Outcome\r\n- (Describe results, resolutions, and final state)\r\n\r\nInclude EVERYTHING important for future interactions between {{user}} and {{char}}. Capture all nuance without regurgitating verbatim.\r\n\r\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords for vectorized database retrieval. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    'STMemoryBooks_Prompt_sumup': `Analyze the following roleplay scene and return a beat summary as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short scene title (1-3 words)\",\r\n  \"content\": \"Comprehensive beat summary...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, write a comprehensive beat summary that captures this scene completely. Format it as:\r\n# Scene Summary - Day X - [Title]\r\nFirst note the dates/time covered by the scene. Then narrate ALL important story beats/events that happened, key interaction highlights, notable details, memorable quotes, character developments, and outcome. Ensure no important information is lost. [OOC] conversation/interaction is not useful for summaries and should be ignored and excluded.\r\n\r\nFor the keywords field, provide 15-30 specific, descriptive, relevant keywords that would help a vectorized database find this summary again if mentioned. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    'STMemoryBooks_Prompt_minimal': `Analyze the following roleplay scene and return a minimal memory entry as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short scene title (1-3 words)\",\r\n  \"content\": \"Brief 2-5 sentence summary...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, provide a very brief 2-5 sentence summary of what happened in this scene. [OOC] conversation/interaction is not useful for summaries and should be ignored and excluded.\r\n\r\nFor the keywords field, generate 15-30 specific, descriptive, highly relevant keywords for database retrieval - focus on the most important terms that would help find this scene later. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    'STMemoryBooks_Prompt_northgate': `You are a memory archivist for a long-form narrative. Your function is to analyze the provided scene and extract all pertinent information into a structured JSON object.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n\"title\": \"Concise Scene Title (3-5 words)\",\r\n\"content\": \"A detailed, literary summary of the scene written in a third-person, past-tense narrative style. Capture all key actions, emotional shifts, character development, and significant dialogue. Focus on \"showing\" what happened through concrete details. Ensure the summary is comprehensive enough to serve as a standalone record of the scene's events and their impact on the characters.\",\r\n\"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the \"content\" field, write with literary quality. Do not simply list events; synthesize them into a coherent narrative block.\r\n\r\nFor the \"keywords\" field, provide 15-30 specific and descriptive keywords that capture the scene's core elements. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nReturn ONLY the JSON object, with no additional text or explanations.`,\r\n\r\n    'STMemoryBooks_Prompt_aelemar': `You are a meticulous archivist, skilled at accurately capturing all key plot points and memories from a story. Analyze the following story scene and extract a detailed summary as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Concise scene title (3-5 words)\",\r\n  \"content\": \"Detailed summary of key plot points and character memories, beat-by-beat in narrative prose...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, create a beat-by-beat summary in narrative prose. Capture all key plot points that advance the story and character memories that leave a lasting impression, ensuring nothing essential is omitted. This summary will go in a vectorized database, so include:\r\n\r\n- Story beats, events, actions and consequences, turning points, and outcomes\r\n- Key character interactions, character developments, significant dialogue, revelations, emotional impact, and relationships\r\n- Outcomes and anything else important for future interactions between the user and the world\r\nCapture ALL nuance without repeating verbatim. Do not simply list events; synthesize them into a coherent narrative block. This summary must be comprehensive enough to serve as a standalone record of the story so far, even if the original text is lost. Use at least 300 words. Avoid redundancy.\r\n\r\nFor the keywords field, provide 15-30 specific and descriptive keywords that capture the scene's core elements. Keywords must be concrete and scene-specific (locations, objects, proper nouns, unique actions). Do not use abstract themes (e.g., \"sadness\", \"love\") or character names.\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    'STMemoryBooks_Prompt_comprehensive': `Analyze the following roleplay scene in the context of previous summaries provided (if available) and return a comprehensive synopsis as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short, descriptive scene title (3-6 words)\",\r\n  \"content\": \"Long detailed synopsis with markdown structure...\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nFor the content field, create a beat-by-beat summary of the scene that *replaces reading the full scene* while preserving all plot-relevant nuance and reads like a clean, structured scene log  concise yet complete. This summary needs to be token-efficient: exercise judgment as to whether or not an interaction is flavor-only or truly affects the plot. Flavor scenes (interaction detail that does not advance plot) may be captured through key exchanges and should be skipped when recording story beats.\r\n\r\nWrite in **past tense**, **third-person**, and exclude all [OOC] or meta discussion.\r\nUse concrete nouns (e.g., rice cooker > appliance).\r\nOnly use adjectives/adverbs when they materially affect tone, emotion, or characterization.\r\nFocus on **cause  intention  reaction  consequence** chains for clarity and compression.\r\n\r\n# [Scene Title]\r\n**Timeline**: (day/time)\r\n\r\n## Story Beats\r\n- Present all major actions, revelations, and emotional or magical shifts in order.\r\n- Capture clear causeeffect logic: what triggered what, and why it mattered.\r\n- Only include plot-affecting interactions and do not capture flavor-only beats.\r\n\r\n## Character Dynamics\r\n- Summarize how each characters **motives, emotions, and relationships** evolved.\r\n- Include subtext, tension, or silent implications.\r\n- Highlight key beats of conflict, vulnerability, trust, or power shifts.\r\n\r\n## Key Exchanges\r\n- Include only pivotal dialogue that defines tone, emotion, or change.\r\n- Attribute speakers by name; keep quotes short but exact.\r\n- BE SELECTIVE. Maximum of 8 quotes.\r\n\r\n## Outcome & Continuity\r\n- Detail resulting **decisions, emotional states, physical/magical effects, or narrative consequences**.\r\n- Include all elements that influence future continuity (knowledge, relationships, injuries, promises, etc.).\r\n- Note any unresolved threads or foreshadowed elements.\r\n\r\nWrite compactly but completely  every line should add new information or insight.\r\nSynthesize redundant actions or dialogue into unified causeeffectemotion beats.\r\nFavor compression over coverage whenever the two conflict; omit anything that can be inferred from context or established characterization.\r\n\r\nFor the keywords field:\r\n\r\nGenerate **1530 standalone topical keywords** that function as retrieval tags, not micro-summaries.\r\nKeywords must be:\r\n- **Concrete and scene-specific** (locations, objects, proper nouns, unique actions, repeated motifs).\r\n- **One concept per keyword**  do NOT combine multiple ideas into one keyword.\r\n- **Useful for retrieval if the user later mentions that noun or action alone**, not only in a specific context.\r\n- Not {{char}}'s or {{user}}'s names.\r\n- **Not thematic, emotional, or abstract.** Stop-list: intimacy, vulnerability, trust, dominance, submission, power dynamics, boundaries, jealousy, aftercare, longing, consent, emotional connection.\r\n\r\nAvoid:\r\n- Overly specific compound keywords (David Tokyo marriage).\r\n- Narrative or plot-summary style keywords (art dealer date fail).\r\n- Keywords that contain multiple facts or descriptors.\r\n- Keywords that only make sense when the whole scene is remembered.\r\n\r\nPrefer:\r\n- Proper nouns (e.g., \"Chinatown\", \"Ritz-Carlton bar\").\r\n- Specific physical objects (\"CPAP machine\", \"chocolate chip cookies\").\r\n- Distinctive actions (\"cookie baking\", \"piano apology\").\r\n- Unique phrases or identifiers from the scene used by characters (\"pack for forever\", \"dick-measuring contest\").\r\n\r\nYour goal: **keywords should fire when the noun/action is mentioned alone**, not only when paired with a specific person or backstory.\r\n\r\nReturn ONLY the JSON  no additional text.`,\r\n\r\n    'STMemoryBooks_Prompt_default': `Analyze the following chat scene and return a memory as JSON.\r\n\r\nYou must respond with ONLY valid JSON in this exact format:\r\n{\r\n  \"title\": \"Short scene title (1-3 words)\",\r\n  \"content\": \"Concise memory focusing on key plot points, character development, and important interactions\",\r\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\"]\r\n}\r\n\r\nReturn ONLY the JSON, no other text.`,\r\n\r\n    // Built-in preset display names (English defaults; can be localized in locales/*.json)\r\n    'STMemoryBooks_DisplayName_summary': 'Summary - Detailed beat-by-beat summaries in narrative prose',\r\n    'STMemoryBooks_DisplayName_summarize': 'Summarize - Bullet-point format',\r\n    'STMemoryBooks_DisplayName_synopsis': 'Synopsis - Long and comprehensive (beats, interactions, details) with headings',\r\n    'STMemoryBooks_DisplayName_sumup': 'Sum Up - Concise story beats in narrative prose',\r\n    'STMemoryBooks_DisplayName_minimal': 'Minimal - Brief 1-2 sentence summary',\r\n    'STMemoryBooks_DisplayName_northgate': 'Northgate - Intended for creative writing. By Northgate on ST Discord',\r\n    'STMemoryBooks_DisplayName_aelemar': 'Aelemar - Focuses on plot points and character memories. By Aelemar on ST Discord',\r\n    'STMemoryBooks_DisplayName_comprehensive': 'Comprehensive - Synopsis plus improved keywords extraction',\r\n    // Summary Prompt Manager - Recreate Built-ins\r\n    'STMemoryBooks_PromptManager_RecreateBuiltins': ' Recreate Built-in Prompts',\r\n    'STMemoryBooks_RecreateBuiltinsTitle': 'Recreate Built-in Prompts',\r\n    'STMemoryBooks_RecreateBuiltinsWarning': 'This will remove overrides for all builtin presets (summary, summarize, synopsis, sumup, minimal, northgate, aelemar, comprehensive). Any customizations to these built-ins will be lost. After this, built-ins will follow the current app locale.',\r\n    'STMemoryBooks_RecreateArcBuiltinsWarning': 'This will remove overrides for all builtin presets (multi-arc, single, tiny). Any customizations to these built-ins will be lost. After this, built-ins will follow the current app locale.',\r\n    'STMemoryBooks_RecreateBuiltinsDoesNotAffectCustom': 'This does not affect your other custom presets.',\r\n    'STMemoryBooks_RecreateBuiltinsOverwrite': 'Overwrite',\r\n    'STMemoryBooks_RegexSelection_Title': ' Regex selection',\r\n    'STMemoryBooks_RegexSelection_Desc': 'Selecting a regex here will run it REGARDLESS of whether it is enabled or disabled.',\r\n    'STMemoryBooks_RegexSelection_Outgoing': 'Run regex before sending to AI',\r\n    'STMemoryBooks_RegexSelection_Incoming': 'Run regex before adding to lorebook (before previews)',\r\n    'STMemoryBooks_RegexSelect_PlaceholderOutgoing': 'Select outgoing regex',\r\n    'STMemoryBooks_RegexSelect_PlaceholderIncoming': 'Select incoming regex',\r\n    'STMemoryBooks_RegexSelectionsSaved': 'Regex selections saved',\r\n    'STMemoryBooks_FailedToSaveRegexSelections': 'Failed to save regex selections',\r\n    'STMemoryBooks_UseRegexAdvanced': 'Use regex (advanced)',\r\n    'STMemoryBooks_ConfigureRegex': ' Configure regex'\r\n};\r\n\r\n/**\r\n * All available locale data\r\n * Add more languages here as they become available\r\n */\r\nexport const localeData = {\r\n    'en': localeData_en,\r\n    // Add more locales here:\r\n    // 'fr-fr': localeData_fr,\r\n    // 'es-es': localeData_es,\r\n    // etc.\r\n};\r\n"
  ],
  "mappings": "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A;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAiSlD,EAKY,GAA6B,GAAW,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAwC5D,EAKY,GAA0B,GAAW,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA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",
  "debugId": "C5D23ED15268FC4C64756E2164756E21",
  "names": []
}